<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dashboard-bg: radial-gradient(120% 120% at 0% 0%, #1e1b4b 0%, #0f172a 38%, #020617 100%);
            --surface-glass: rgba(255, 255, 255, 0.92);
            --ink-900: #0f172a;
            --ink-600: #475569;
            --accent-iris: #6366f1;
            --accent-cobalt: #2563eb;
            --accent-lilac: #a855f7;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
        }

        .pricing-body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: var(--dashboard-bg);
            color: var(--ink-900);
            padding: 4rem 1.5rem 6rem;
        }

        @media (max-width: 768px) {
            .pricing-body {
                padding: 3rem 1rem 4rem;
            }
        }

        .dashboard-shell {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        .hero-panel {
            position: relative;
            overflow: hidden;
            border-radius: 2rem;
            padding: 2.75rem;
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.92) 0%, rgba(79, 70, 229, 0.92) 55%, rgba(59, 130, 246, 0.9) 100%);
            color: #f8fafc;
            box-shadow: 0 30px 60px -30px rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.18);
            isolation: isolate;
        }

        .hero-panel::before,
        .hero-panel::after {
            content: '';
            position: absolute;
            border-radius: 999px;
            filter: blur(60px);
            opacity: 0.55;
            z-index: -1;
        }

        .hero-panel::before {
            width: 360px;
            height: 360px;
            bottom: -120px;
            left: -60px;
            background: radial-gradient(circle at center, rgba(244, 114, 182, 0.7) 0%, rgba(125, 211, 252, 0) 70%);
        }

        .hero-panel::after {
            width: 320px;
            height: 320px;
            top: -140px;
            right: -60px;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.65) 0%, rgba(59, 130, 246, 0) 70%);
        }

        .hero-content {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        @media (min-width: 1024px) {
            .hero-content {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .hero-copy {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            max-width: 420px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.32em;
            padding: 0.55rem 1.4rem;
            border-radius: 9999px;
            background: rgba(15, 23, 42, 0.28);
            border: 1px solid rgba(255, 255, 255, 0.28);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            width: fit-content;
        }

        .hero-headline {
            font-size: 2.6rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        @media (max-width: 640px) {
            .hero-headline {
                font-size: 2.2rem;
            }
        }

        .hero-subcopy {
            color: rgba(226, 232, 240, 0.88);
            font-size: 1rem;
            line-height: 1.6;
        }

        .hero-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .hero-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.35rem 0.8rem;
            border-radius: 9999px;
            background: rgba(248, 250, 252, 0.14);
            color: rgba(248, 250, 252, 0.9);
        }

        .hero-controls {
            flex: 1;
        }

        .control-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .control-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .control-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                align-items: center;
            }
        }

        .control-card {
            position: relative;
            border-radius: 1.25rem;
            background: rgba(15, 23, 42, 0.38);
            border: 1px solid rgba(255, 255, 255, 0.22);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(14px);
        }

        .control-card input,
        .control-card select {
            background: transparent;
            color: #f8fafc;
            border: none;
            width: 100%;
            font-size: 0.95rem;
            padding: 0.85rem 1rem 0.85rem 2.75rem;
            font-weight: 500;
        }

        .control-card select option {
            color: var(--ink-900);
        }

        .control-card input::placeholder {
            color: rgba(226, 232, 240, 0.75);
        }

        .control-card input:focus,
        .control-card select:focus {
            outline: none;
        }

        .control-icon {
            position: absolute;
            left: 1.15rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(226, 232, 240, 0.8);
            font-size: 1rem;
        }

        .action-stack {
            display: flex;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.32);
            border-radius: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 0.6rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(14px);
        }

        .action-stack .btn {
            flex: 1;
        }

        @media (max-width: 767px) {
            .action-stack {
                flex-direction: column;
            }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.95rem;
            padding: 0.75rem 1.6rem;
            letter-spacing: 0.02em;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
            color: #ffffff;
            box-shadow: 0 18px 35px -20px rgba(79, 70, 229, 0.9);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 40px -18px rgba(79, 70, 229, 0.95);
        }

        .btn-secondary {
            background: rgba(226, 232, 240, 0.7);
            color: var(--ink-900);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: inset 0 -2px 0 rgba(148, 163, 184, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            background: rgba(226, 232, 240, 0.9);
        }

        .btn-ghost {
            background: rgba(248, 250, 252, 0.1);
            color: #f8fafc;
            border: 1px solid rgba(248, 250, 252, 0.38);
            box-shadow: inset 0 1px 0 rgba(248, 250, 252, 0.2);
        }

        .btn-ghost:hover {
            background: rgba(248, 250, 252, 0.2);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
            border-radius: 9999px;
            padding: 0.35rem 0.85rem;
        }

        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.25);
            transform: scale(1.05);
        }

        .overview-grid {
            display: grid;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .overview-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        .glow-card {
            position: relative;
            overflow: hidden;
            padding: 1.8rem;
            border-radius: 1.75rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 30px 60px -38px rgba(15, 23, 42, 0.5);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .glow-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(56, 189, 248, 0.08));
            opacity: 0.7;
            z-index: -1;
        }

        .glow-card-label {
            font-size: 0.75rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 700;
        }

        .glow-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ink-900);
            margin: 0;
        }

        .glow-card-caption {
            font-size: 0.85rem;
            color: var(--ink-600);
            line-height: 1.5;
        }

        .glow-card-footer {
            margin-top: auto;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .glow-card-footer-copy {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .glow-card-footer-copy span:first-child {
            font-weight: 600;
            color: #475569;
        }

        .event-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(129, 140, 248, 0.22));
            border: 1px solid rgba(99, 102, 241, 0.28);
            color: #0f172a;
        }

        .event-card::before {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.18), rgba(129, 140, 248, 0.18));
        }

        .event-chip {
            align-self: flex-start;
            font-size: 0.7rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            padding: 0.35rem 0.9rem;
            border-radius: 9999px;
            background: rgba(99, 102, 241, 0.15);
            color: #4338ca;
            font-weight: 700;
        }

        .ghost-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #1d4ed8;
            text-decoration: none;
        }

        .ghost-link:hover {
            text-decoration: underline;
        }

        .glass-board {
            background: var(--surface-glass);
            border-radius: 2rem;
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 35px 70px -55px rgba(15, 23, 42, 0.65);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
        }

        @media (max-width: 640px) {
            .glass-board {
                padding: 1.75rem;
            }
        }

        #statusMessage {
            border-radius: 1rem;
            font-weight: 600;
            backdrop-filter: blur(8px);
        }

        #loadingIndicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--ink-600);
            padding: 2.5rem 0;
        }

        #loadingIndicator i {
            font-size: 2.5rem;
        }

        .table-container {
            border-radius: 1.75rem;
            border: 1px solid rgba(15, 23, 42, 0.1);
            background: rgba(248, 250, 252, 0.92);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        .table-scroll {
            max-height: 68vh;
            overflow-y: auto;
        }

        .pricing-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
            color: var(--ink-900);
        }

        .pricing-table thead th {
            position: sticky;
            top: 0;
            background: rgba(226, 232, 240, 0.95);
            backdrop-filter: blur(12px);
            padding: 0.9rem 1rem;
            text-align: left;
            font-size: 0.7rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            font-weight: 700;
            color: #475569;
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        }

        .pricing-table tbody tr {
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .pricing-table tbody tr:nth-child(even) {
            background: rgba(241, 245, 249, 0.55);
        }

        .pricing-table tbody tr:hover {
            background: rgba(219, 234, 254, 0.6);
        }

        .pricing-table td {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            vertical-align: top;
        }

        .pricing-table td:first-child {
            font-weight: 600;
            width: 16rem;
        }

        .pricing-table td:nth-child(2),
        .pricing-table td:nth-child(3) {
            font-weight: 500;
            color: var(--ink-600);
        }

        .pricing-table input.price-input {
            width: 6rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 0.45rem 0.55rem;
            text-align: center;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .pricing-table input.price-input:focus {
            outline: none;
            border-color: var(--accent-iris);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }

        .storage-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.8rem;
        }

        @media (min-width: 1024px) {
            .storage-grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }

        .storage-row {
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 1.2rem;
            padding: 1.25rem;
            background: rgba(248, 250, 252, 0.96);
            box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.12);
        }

        .storage-remove {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            color: #dc2626;
            background: rgba(254, 226, 226, 0.75);
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .storage-remove:hover {
            background: rgba(254, 202, 202, 0.95);
            transform: scale(1.05);
        }

        .storage-remove.opacity-40 {
            opacity: 0.4;
        }

        .storage-remove.cursor-not-allowed {
            cursor: not-allowed;
        }

        .form-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .form-grid.md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .form-grid.lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .field-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--ink-600);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .field-input {
            width: 100%;
            border-radius: 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            background: rgba(255, 255, 255, 0.96);
        }

        .field-input:focus {
            outline: none;
            border-color: var(--accent-cobalt);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }

        .price-input {
            width: 6rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            padding: 0.45rem 0.55rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.96);
        }

        .price-input:focus {
            outline: none;
            border-color: var(--accent-iris);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
        }

        .status-message {
            border-radius: 0.9rem;
            font-weight: 600;
        }

        .table-footnote {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem 1.75rem;
            border-radius: 1.5rem;
            background: rgba(226, 232, 240, 0.35);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        @media (min-width: 768px) {
            .table-footnote {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .table-footnote h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            color: var(--ink-900);
        }

        .table-footnote p {
            margin: 0.35rem 0 0;
            color: var(--ink-600);
            font-size: 0.9rem;
        }

        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }

        .modal.is-visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            border-radius: 1.75rem;
            box-shadow: 0 35px 90px -45px rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(255, 255, 255, 0.98);
        }

        .modal h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--ink-900);
        }

        .modal p {
            color: var(--ink-600);
        }

        .modal .table-container {
            background: rgba(255, 255, 255, 0.96);
        }
    </style>
</head>
<body class="pricing-body">
    <div class="dashboard-shell">
        <header class="hero-panel">
            <div class="hero-content">
                <div class="hero-copy">
                    <span class="hero-badge"><i class="fa-solid fa-sparkles"></i> Live Pricing Suite</span>
                    <h1 class="hero-headline">Price Management Studio</h1>
                    <p class="hero-subcopy">Craft payouts, tune limited-time bonuses, and sync seasonal promos without leaving this dashboard.</p>
                    <div class="hero-tags">
                        <span class="hero-tag"><i class="fa-solid fa-bolt"></i> Realtime</span>
                        <span class="hero-tag"><i class="fa-solid fa-shield-check"></i> Audit Trail</span>
                        <span class="hero-tag"><i class="fa-solid fa-gift"></i> Seasonal Boost</span>
                    </div>
                </div>
                <div class="hero-controls">
                    <div class="control-grid">
                        <div class="control-card">
                            <i class="fas fa-search control-icon"></i>
                            <input type="search" id="searchInput" placeholder="Search for device...">
                        </div>
                        <div class="control-card">
                            <i class="fas fa-layer-group control-icon"></i>
                            <select id="brandFilter">
                                <option value="all">All Brands</option>
                                <option value="iphone">iPhone</option>
                                <option value="samsung">Samsung</option>
                                <option value="google_pixel">Google</option>
                                <option value="ipad">iPad</option>
                                <option value="macbook">MacBook</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="action-stack">
                            <button id="importBtn" class="btn btn-ghost"><i class="fas fa-file-excel"></i> Import Prices</button>
                            <button id="addDeviceBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Pricing</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="overview-grid">
            <article class="glow-card">
                <span class="glow-card-label">Visible Models</span>
                <p class="glow-card-value" id="summaryTotalDevices">0</p>
                <p class="glow-card-caption">Devices matching your filters</p>
                <div class="glow-card-footer">
                    <i class="fa-solid fa-bolt text-blue-500"></i>
                    <div class="glow-card-footer-copy">
                        <span id="summaryFilterLabel">All brands in view</span>
                        <span id="summaryLastRefresh">Waiting for sync…</span>
                    </div>
                </div>
            </article>
            <article class="glow-card">
                <span class="glow-card-label">Storage Tiers</span>
                <p class="glow-card-value" id="summaryStorageVariants">0</p>
                <p class="glow-card-caption" id="summaryTierLabel">Lock combinations ready for quoting</p>
                <div class="glow-card-footer">
                    <i class="fa-solid fa-layer-group text-indigo-500"></i>
                    <div class="glow-card-footer-copy">
                        <span>Tier Coverage</span>
                        <span id="summaryTierFooter">Awaiting data…</span>
                    </div>
                </div>
            </article>
            <article class="glow-card">
                <span class="glow-card-label">Top Offer</span>
                <p class="glow-card-value" id="summaryHighestOffer">$0</p>
                <p class="glow-card-caption">Highest payout inside the visible set</p>
                <div class="glow-card-footer">
                    <i class="fa-solid fa-fire text-orange-500"></i>
                    <div class="glow-card-footer-copy">
                        <span>Hot Device</span>
                        <span id="summaryHotDevice">Awaiting data…</span>
                    </div>
                </div>
            </article>
            <article class="glow-card event-card">
                <span class="event-chip">Halloween Blitz</span>
                <p class="glow-card-value" id="summaryEventCountdown">--</p>
                <p class="glow-card-caption" id="summaryEventCaption">Bonus payouts go live soon.</p>
                <a href="#deviceTableContainer" class="ghost-link" id="previewEventDetails"><i class="fa-solid fa-calendar-days"></i> View event playbook</a>
            </article>
        </section>

        <main class="glass-board">
            <div id="statusMessage" class="hidden status-message mb-4 p-3 text-sm text-center"></div>
            <div id="loadingIndicator" class="loading-container">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600"></i>
                <p class="text-slate-500">Loading device data...</p>
            </div>
            <div id="deviceTableContainer" class="table-container hidden">
                <div class="table-scroll">
                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Storage</th>
                                <th>Lock Status</th>
                                <th>Flawless</th>
                                <th>Good</th>
                                <th>Fair</th>
                                <th>Damaged</th>
                                <th>Broken</th>
                                <th>No Power</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="table-footnote">
                <div>
                    <h3>Seasonal Bonus Builder</h3>
                    <p>Queue limited-time multipliers and broadcast them across the quote funnel in seconds.</p>
                </div>
                <button type="button" id="launchBonusBuilderBtn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles"></i> Launch Bonus Builder</button>
            </div>
        </main>
    </div>

    <!-- Excel Import Modal -->
    <div id="importModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white modal-card p-6 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Import Prices from Excel</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2" for="excelFile">Choose Excel File (.xlsx, .xls)</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <div id="excelPreview" class="table-container border rounded-lg overflow-hidden hidden">
                <table class="min-w-full bg-white">
                    <thead class="sticky-header"></thead>
                    <tbody class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="importStatus" class="mt-4 hidden p-3 rounded-lg text-center"></div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
                <button id="processImportBtn" class="btn btn-primary hidden">Confirm & Update Prices</button>
            </div>
        </div>
    </div>

    <!-- Add Pricing Modal -->
    <div id="addModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4">
        <div class="bg-white modal-card p-6 w-full max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Add Device Pricing</h2>
                    <p class="text-sm text-slate-500 mt-1">Create a device entry with one or more storage tiers and instant price points.</p>
                </div>
                <button id="closeAddModalBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="addDeviceForm" class="space-y-6">
                <div class="form-grid md:grid-cols-2 lg:grid-cols-3">
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Brand</span>
                        <select id="addBrand" class="field-input" required>
                            <option value="" disabled selected>Select brand</option>
                            <option value="iphone">iPhone</option>
                            <option value="samsung">Samsung</option>
                            <option value="google_pixel">Google</option>
                            <option value="ipad">iPad</option>
                            <option value="macbook">MacBook</option>
                            <option value="other">Other</option>
                        </select>
                    </label>
                    <label class="flex flex-col gap-2 md:col-span-1 lg:col-span-1">
                        <span class="field-label">Device Name</span>
                        <input type="text" id="addDeviceName" class="field-input" placeholder="iPhone 15 Pro" required>
                    </label>
                    <label class="flex flex-col gap-2 md:col-span-1 lg:col-span-1">
                        <span class="field-label">Slug</span>
                        <input type="text" id="addSlug" class="field-input" placeholder="iphone-15-pro" required>
                        <span class="text-xs text-slate-400">Lowercase, no spaces. We’ll auto-generate it as you type the name.</span>
                    </label>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-800">Storage & Condition Pricing</h3>
                        <button type="button" id="addStorageRowBtn" class="btn btn-secondary"><i class="fas fa-layer-group"></i> Add Storage Tier</button>
                    </div>
                    <div id="storageRows" class="space-y-4"></div>
                    <p class="text-xs text-slate-400">Tip: Leave any condition blank if you don’t offer pricing for it—only filled values will be saved.</p>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelAddBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-floppy-disk"></i> Save Pricing</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (your provided credentials)
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let allDevices = [];
        let filteredDevices = [];
        const supportedBrands = ['iphone', 'samsung', 'google_pixel', 'ipad', 'macbook', 'other'];
        const conditions = ['flawless', 'good', 'fair', 'damaged', 'broken', 'noPower'];

        // DOM elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const deviceTableContainer = document.getElementById('deviceTableContainer');
        const deviceTableBody = document.getElementById('deviceTableBody');
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');
        const statusMessage = document.getElementById('statusMessage');
        const summaryTotalDevices = document.getElementById('summaryTotalDevices');
        const summaryFilterLabel = document.getElementById('summaryFilterLabel');
        const summaryLastRefresh = document.getElementById('summaryLastRefresh');
        const summaryStorageVariants = document.getElementById('summaryStorageVariants');
        const summaryTierLabel = document.getElementById('summaryTierLabel');
        const summaryTierFooter = document.getElementById('summaryTierFooter');
        const summaryHighestOffer = document.getElementById('summaryHighestOffer');
        const summaryHotDevice = document.getElementById('summaryHotDevice');
        const summaryEventCountdown = document.getElementById('summaryEventCountdown');
        const summaryEventCaption = document.getElementById('summaryEventCaption');
        const previewEventDetails = document.getElementById('previewEventDetails');
        const launchBonusBuilderBtn = document.getElementById('launchBonusBuilderBtn');
        const importModal = document.getElementById('importModal');
        const importBtn = document.getElementById('importBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const excelFile = document.getElementById('excelFile');
        const excelPreview = document.getElementById('excelPreview');
        const processImportBtn = document.getElementById('processImportBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const importStatus = document.getElementById('importStatus');
        const addModal = document.getElementById('addModal');
        const addDeviceBtn = document.getElementById('addDeviceBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const addDeviceForm = document.getElementById('addDeviceForm');
        const addBrand = document.getElementById('addBrand');
        const addDeviceName = document.getElementById('addDeviceName');
        const addSlug = document.getElementById('addSlug');
        const addStorageRowBtn = document.getElementById('addStorageRowBtn');
        const storageRowsContainer = document.getElementById('storageRows');
        let slugManuallyEdited = false;
        let lastRefreshedAt = null;

        const conditionConfig = [
            { key: 'flawless', label: 'Flawless' },
            { key: 'good', label: 'Good' },
            { key: 'fair', label: 'Fair' },
            { key: 'damaged', label: 'Damaged' },
            { key: 'broken', label: 'Broken' },
            { key: 'noPower', label: 'No Power' }
        ];

        const sanitizeSlug = (value) => value
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');

        const normalizeConnectivity = (value) => value
            .toLowerCase()
            .replace(/\s+/g, '')
            .trim();

        const toTitleCase = (value = '') => value
            .toString()
            .replace(/[_-]/g, ' ')
            .replace(/([a-z])([A-Z])/g, '$1 $2')
            .toLowerCase()
            .replace(/\b\w/g, (char) => char.toUpperCase())
            .trim();

        const computeUpcomingEventDate = () => {
            const now = new Date();
            let eventDate = new Date(`${now.getFullYear()}-10-31T23:59:59`);
            if (now > eventDate) {
                eventDate = new Date(`${now.getFullYear() + 1}-10-31T23:59:59`);
            }
            return eventDate;
        };

        const eventTargetDate = computeUpcomingEventDate();

        const updateEventCountdown = () => {
            if (!summaryEventCountdown || !summaryEventCaption) {
                return;
            }

            const now = new Date();
            const diff = eventTargetDate - now;

            if (diff <= 0) {
                summaryEventCountdown.textContent = 'Live Now';
                summaryEventCaption.textContent = 'The Halloween Blitz bonus is active—queue fresh promos!';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);

            summaryEventCountdown.textContent = `${days}d ${hours}h ${minutes}m`;
            summaryEventCaption.textContent = `Bonus drops ${eventTargetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        };

        updateEventCountdown();
        setInterval(updateEventCountdown, 60000);

        const toggleAddModal = (shouldShow) => {
            if (shouldShow) {
                addModal.classList.add('is-visible');
            } else {
                addModal.classList.remove('is-visible');
            }
        };

        const refreshStorageRemoveButtons = () => {
            const removeButtons = storageRowsContainer.querySelectorAll('.storage-remove');
            const disable = storageRowsContainer.children.length === 1;
            removeButtons.forEach(button => {
                button.disabled = disable;
                button.classList.toggle('opacity-40', disable);
                button.classList.toggle('cursor-not-allowed', disable);
            });
        };

        const createStorageRow = () => {
            const row = document.createElement('div');
            row.className = 'storage-row space-y-4';
            row.innerHTML = `
                <button type="button" class="storage-remove" title="Remove storage tier">
                    <i class="fas fa-times"></i>
                </button>
                <div class="form-grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Storage</span>
                        <input type="text" class="field-input storage-input" placeholder="128GB" required>
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Lock Status</span>
                        <input type="text" class="field-input connectivity-input" placeholder="unlocked" required>
                    </label>
                </div>
                <div class="storage-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    ${conditionConfig.map(condition => `
                        <label class="flex flex-col gap-2">
                            <span class="field-label text-xs uppercase tracking-wide text-slate-500">${condition.label}</span>
                            <input type="number" min="0" step="0.01" class="price-input condition-input" data-condition="${condition.key}" placeholder="0.00">
                        </label>
                    `).join('')}
                </div>
            `;
            const removeBtn = row.querySelector('.storage-remove');
            removeBtn.addEventListener('click', () => {
                if (storageRowsContainer.children.length > 1) {
                    row.remove();
                    refreshStorageRemoveButtons();
                }
            });
            return row;
        };

        const resetAddForm = () => {
            addDeviceForm.reset();
            slugManuallyEdited = false;
            storageRowsContainer.innerHTML = '';
            storageRowsContainer.appendChild(createStorageRow());
            refreshStorageRemoveButtons();
        };

        resetAddForm();

        addDeviceName.addEventListener('input', () => {
            if (!slugManuallyEdited) {
                addSlug.value = sanitizeSlug(addDeviceName.value);
            }
        });

        addSlug.addEventListener('input', () => {
            slugManuallyEdited = true;
        });

        addSlug.addEventListener('blur', () => {
            addSlug.value = sanitizeSlug(addSlug.value);
        });

        addDeviceBtn.addEventListener('click', () => {
            resetAddForm();
            toggleAddModal(true);
        });

        const closeAddModal = () => {
            toggleAddModal(false);
        };

        closeAddModalBtn.addEventListener('click', closeAddModal);
        cancelAddBtn.addEventListener('click', closeAddModal);
        addModal.addEventListener('click', (event) => {
            if (event.target === addModal) {
                closeAddModal();
            }
        });

        addStorageRowBtn.addEventListener('click', () => {
            storageRowsContainer.appendChild(createStorageRow());
            refreshStorageRemoveButtons();
        });

        if (previewEventDetails) {
            previewEventDetails.addEventListener('click', (event) => {
                event.preventDefault();
                showStatus('Halloween Blitz bonus: apply multipliers via the Seasonal Bonus Builder below.', 'info');
                document.getElementById('deviceTableContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        if (launchBonusBuilderBtn) {
            launchBonusBuilderBtn.addEventListener('click', () => {
                resetAddForm();
                toggleAddModal(true);
            });
        }

        addDeviceForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const brand = addBrand.value;
            const deviceNameValue = addDeviceName.value.trim();
            let slugValue = addSlug.value.trim() ? sanitizeSlug(addSlug.value) : sanitizeSlug(deviceNameValue);

            if (!brand || !deviceNameValue || !slugValue) {
                showStatus('Please complete brand, device name, and slug before saving.', 'error');
                return;
            }

            const storageRows = Array.from(storageRowsContainer.children);
            if (storageRows.length === 0) {
                showStatus('Add at least one storage tier before saving.', 'error');
                return;
            }

            const pricePayload = {};
            let hasPricing = false;

            for (const row of storageRows) {
                const storageInput = row.querySelector('.storage-input');
                const connectivityInput = row.querySelector('.connectivity-input');
                const storageValue = storageInput.value.trim();
                let connectivityValue = connectivityInput.value.trim();

                if (!storageValue || !connectivityValue) {
                    showStatus('Storage and lock status are required for each tier.', 'error');
                    return;
                }

                connectivityValue = normalizeConnectivity(connectivityValue);

                if (!pricePayload[storageValue]) {
                    pricePayload[storageValue] = {};
                }
                if (!pricePayload[storageValue][connectivityValue]) {
                    pricePayload[storageValue][connectivityValue] = {};
                }

                const conditionInputs = row.querySelectorAll('.condition-input');
                let tierHasPrice = false;
                for (const input of conditionInputs) {
                    const rawValue = input.value.trim();
                    if (rawValue !== '') {
                        const numericValue = parseFloat(rawValue);
                        if (isNaN(numericValue) || numericValue < 0) {
                            showStatus('Please enter valid prices (0 or greater).', 'error');
                            return;
                        }
                        pricePayload[storageValue][connectivityValue][input.dataset.condition] = numericValue;
                        tierHasPrice = true;
                        hasPricing = true;
                    }
                }

                if (!tierHasPrice) {
                    showStatus(`Enter at least one price for ${storageValue} (${connectivityInput.value}).`, 'error');
                    return;
                }
            }

            if (!hasPricing) {
                showStatus('Enter at least one price before saving.', 'error');
                return;
            }

            addSlug.value = slugValue;
            const docPath = `devices/${brand}/models`;
            const docRef = doc(db, docPath, slugValue);

            const payload = {
                name: deviceNameValue,
                slug: slugValue,
                brand: brand,
                prices: pricePayload
            };

            try {
                showStatus('Saving pricing…', 'info');
                await setDoc(docRef, payload, { merge: true });
                showStatus(`Pricing for ${deviceNameValue} saved successfully.`, 'success');
                closeAddModal();
                resetAddForm();
                fetchDevices();
            } catch (error) {
                console.error('Failed to save pricing:', error);
                showStatus('Failed to save pricing. Check console for details.', 'error');
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message mb-4 p-3 text-sm text-center';
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-emerald-100', 'text-emerald-700', 'border', 'border-emerald-200');
            } else {
                statusMessage.classList.add('bg-indigo-100', 'text-indigo-700', 'border', 'border-indigo-200');
            }
            statusMessage.classList.remove('hidden');
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                await fetchDevices();
            } else {
                console.log("No user is signed in. Signing in anonymously...");
                try {
                    await signInAnonymously(auth);
                    await fetchDevices();
                } catch (error) {
                    console.error("Anonymous auth failed:", error);
                    showStatus("Authentication failed. Please check Firebase Auth settings.", "error");
                }
            }
        });
        
        // --- FETCH & RENDER DEVICES ---
        const fetchDevices = async () => {
            loadingIndicator.classList.remove('hidden');
            deviceTableContainer.classList.add('hidden');
            allDevices = [];

            try {
                for (const brand of supportedBrands) {
                    const collectionPath = `devices/${brand}/models`;
                    const querySnapshot = await getDocs(collection(db, collectionPath));
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allDevices.push({ ...data, brand: brand, docId: doc.id, documentPath: collectionPath });
                    });
                }
                lastRefreshedAt = new Date();
            } catch (error) {
                console.error("Error fetching devices from Firestore:", error);
                showStatus("Failed to load device data. Check console for details.", "error");
            }
            applyFilters();
        };

        const renderTable = (devices) => {
            deviceTableBody.innerHTML = '';
            loadingIndicator.classList.add('hidden');
            if (devices.length > 0) {
                deviceTableContainer.classList.remove('hidden');
            } else {
                deviceTableContainer.classList.add('hidden');
                showStatus("No devices found.", "info");
                return;
            }

            devices.forEach(device => {
                const deviceData = device.prices;
                for (const storage in deviceData) {
                    const storageData = deviceData[storage];
                    for (const connectivity in storageData) {
                        const prices = storageData[connectivity];
                        const row = `
                            <tr class="hover:bg-blue-50/60 transition-colors">
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900 flex items-center">
                                    ${device.brand.includes('ipad') || device.brand.includes('macbook') ?
                                      `<i class="fas fa-tablet-alt text-xl mr-2"></i>` :
                                      `<i class="fas fa-mobile-alt text-xl mr-2"></i>`}
                                    ${device.name}
                                </td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${storage}</td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm font-semibold ${connectivity === 'unlocked' ? 'text-green-600' : 'text-red-600'}">${connectivity}</td>
                                ${conditions.map(condition => `
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                        <div class="flex items-center justify-center gap-1">
                                            <span class="text-slate-400 text-xs">$</span>
                                            <input type="number" value="${prices[condition] || ''}"
                                                   class="price-input"
                                                   data-doc-id="${device.docId}"
                                                   data-doc-path="${device.documentPath}"
                                                   data-storage="${storage}"
                                                   data-connectivity="${connectivity}"
                                                   data-condition="${condition}"
                                                   onblur="handlePriceUpdate(this)"
                                                   onkeypress="if(event.key === 'Enter') this.blur();">
                                        </div>
                                    </td>
                                `).join('')}
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                    <button class="btn-danger"
                                            title="Delete this configuration"
                                            data-doc-id="${device.docId}"
                                            data-doc-path="${device.documentPath}"
                                            data-storage="${storage}"
                                            data-connectivity="${connectivity}"
                                            onclick="handleDeleteRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        deviceTableBody.insertAdjacentHTML('beforeend', row);
                    }
                }
            });
        };

        const updateSummaryStats = () => {
            if (!summaryTotalDevices) {
                return;
            }

            const visibleCount = filteredDevices.length;
            summaryTotalDevices.textContent = visibleCount.toLocaleString();

            if (summaryFilterLabel) {
                const selectedOption = brandFilter?.options?.[brandFilter.selectedIndex] || null;
                summaryFilterLabel.textContent = (!brandFilter || brandFilter.value === 'all')
                    ? 'All brands in view'
                    : `Filtered by ${selectedOption?.textContent || toTitleCase(brandFilter.value)}`;
            }

            if (summaryLastRefresh) {
                summaryLastRefresh.textContent = lastRefreshedAt
                    ? `Updated ${lastRefreshedAt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`
                    : 'Waiting for sync…';
            }

            const uniqueStorage = new Set();
            let totalCombos = 0;
            let highestOffer = 0;
            let highestLabel = 'Awaiting data…';

            filteredDevices.forEach(device => {
                const priceMatrix = device.prices || {};
                Object.entries(priceMatrix).forEach(([storage, lockMap = {}]) => {
                    uniqueStorage.add(`${device.docId}:${storage}`);
                    Object.entries(lockMap).forEach(([connectivity, conditionMap = {}]) => {
                        let comboHasPricing = false;
                        Object.entries(conditionMap).forEach(([condition, price]) => {
                            if (typeof price === 'number') {
                                comboHasPricing = true;
                                if (price > highestOffer) {
                                    highestOffer = price;
                                    highestLabel = `${device.name} · ${storage} · ${toTitleCase(connectivity)} (${toTitleCase(condition)})`;
                                }
                            }
                        });

                        if (comboHasPricing) {
                            totalCombos += 1;
                        }
                    });
                });
            });

            if (summaryStorageVariants) {
                summaryStorageVariants.textContent = uniqueStorage.size.toLocaleString();
            }

            if (summaryTierLabel) {
                summaryTierLabel.textContent = uniqueStorage.size
                    ? 'Distinct storage tiers in play'
                    : 'No tiers available yet';
            }

            if (summaryTierFooter) {
                summaryTierFooter.textContent = totalCombos
                    ? `${totalCombos.toLocaleString()} lock variations ready`
                    : 'Add storage tiers to unlock offers';
            }

            if (summaryHighestOffer) {
                summaryHighestOffer.textContent = highestOffer
                    ? `$${highestOffer.toLocaleString(undefined, { maximumFractionDigits: 0 })}`
                    : '$0';
            }

            if (summaryHotDevice) {
                summaryHotDevice.textContent = highestLabel;
            }
        };

        const applyFilters = () => {
            const searchText = searchInput.value.toLowerCase();
            const brand = brandFilter.value;

            filteredDevices = allDevices.filter(device => {
                const matchesSearch = device.name.toLowerCase().includes(searchText) || (device.brand && device.brand.toLowerCase().includes(searchText));
                const matchesBrand = brand === 'all' || (device.brand && device.brand.toLowerCase() === brand);
                return matchesSearch && matchesBrand;
            });

            renderTable(filteredDevices);
            updateSummaryStats();
        };
        
        searchInput.addEventListener('input', applyFilters);
        brandFilter.addEventListener('change', applyFilters);

        updateSummaryStats();

        // --- UPDATE PRICE LOGIC ---
        window.handlePriceUpdate = async (element) => {
            const newPrice = parseFloat(element.value);
            if (isNaN(newPrice) || newPrice < 0) {
                showStatus("Invalid price entered.", "error");
                element.value = element.defaultValue; // Revert to old value
                return;
            }

            const docId = element.dataset.docId;
            const docPath = element.dataset.docPath;
            const storage = element.dataset.storage;
            const connectivity = element.dataset.connectivity;
            const condition = element.dataset.condition;
            const docRef = doc(db, docPath, docId);

            try {
                // Use a batched write to ensure atomicity and avoid race conditions
                await setDoc(docRef, {
                    prices: {
                        [storage]: {
                            [connectivity]: {
                                [condition]: newPrice
                            }
                        }
                    }
                }, { merge: true });

                element.defaultValue = newPrice;
                showStatus(`Price for ${docId} (${storage} - ${connectivity} - ${condition}) updated successfully!`, "success");
            } catch (e) {
                console.error("Failed to update price: ", e);
                showStatus("Failed to update price. Check console for details.", "error");
                element.value = element.defaultValue; // Revert on error
            }
        };

        window.handleDeleteRow = async (button) => {
            const docId = button.dataset.docId;
            const docPath = button.dataset.docPath;
            const storage = button.dataset.storage;
            const connectivity = button.dataset.connectivity;

            if (!docId || !docPath || !storage || !connectivity) {
                showStatus('Missing pricing metadata. Try refreshing the page.', 'error');
                return;
            }

            const confirmed = confirm(`Delete pricing for ${storage} (${connectivity})? This cannot be undone.`);
            if (!confirmed) {
                return;
            }

            const docRef = doc(db, docPath, docId);

            try {
                await runTransaction(db, async (transaction) => {
                    const snapshot = await transaction.get(docRef);
                    if (!snapshot.exists()) {
                        throw new Error('Device not found.');
                    }

                    const data = snapshot.data();
                    if (!data.prices || !data.prices[storage] || !data.prices[storage][connectivity]) {
                        throw new Error('Pricing tier already removed.');
                    }

                    delete data.prices[storage][connectivity];

                    if (Object.keys(data.prices[storage]).length === 0) {
                        delete data.prices[storage];
                    }

                    if (!data.prices || Object.keys(data.prices).length === 0) {
                        transaction.delete(docRef);
                    } else {
                        transaction.set(docRef, data);
                    }
                });

                showStatus(`Removed ${storage} (${connectivity}) pricing.`, 'success');
                fetchDevices();
            } catch (error) {
                console.error('Failed to delete pricing:', error);
                showStatus(error.message || 'Failed to delete pricing. Check console for details.', 'error');
            }
        };

        // --- EXCEL IMPORT LOGIC ---
        importBtn.addEventListener('click', () => importModal.classList.add('is-visible'));
        closeModalBtn.addEventListener('click', () => importModal.classList.remove('is-visible'));
        cancelImportBtn.addEventListener('click', () => {
            excelFile.value = null;
            excelPreview.classList.add('hidden');
            importStatus.classList.add('hidden');
            processImportBtn.classList.add('hidden');
            importModal.classList.remove('is-visible');
        });

        excelFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                if (json.length > 0) {
                    renderExcelPreview(json);
                    importStatus.classList.add('hidden');
                    processImportBtn.classList.remove('hidden');
                } else {
                    showImportStatus('No data found in the Excel file.', 'error');
                    processImportBtn.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        const renderExcelPreview = (data) => {
            const previewTable = excelPreview.querySelector('table');
            const previewHeader = previewTable.querySelector('thead');
            const previewBody = previewTable.querySelector('tbody');

            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';

            const headers = Object.keys(data[0]);
            const headerRow = `<tr>${headers.map(h => `<th class="py-2 px-4 text-left text-xs font-semibold text-gray-600 uppercase">${h}</th>`).join('')}</tr>`;
            previewHeader.insertAdjacentHTML('beforeend', headerRow);

            data.forEach(row => {
                const rowHTML = `<tr>${headers.map(h => `<td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">${row[h]}</td>`).join('')}</tr>`;
                previewBody.insertAdjacentHTML('beforeend', rowHTML);
            });
            excelPreview.classList.remove('hidden');
        };
        
        const showImportStatus = (message, type) => {
            importStatus.textContent = message;
            importStatus.className = 'mt-4 p-3 rounded-lg text-sm text-center';
            if (type === 'error') {
                importStatus.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                importStatus.classList.add('bg-emerald-100', 'text-emerald-700', 'border', 'border-emerald-200');
            } else {
                importStatus.classList.add('bg-indigo-100', 'text-indigo-700', 'border', 'border-indigo-200');
            }
            importStatus.classList.remove('hidden');
        };

        processImportBtn.addEventListener('click', async () => {
             showImportStatus('Processing import...', 'info');
             const file = excelFile.files[0];
             if (!file) {
                 showImportStatus('No file selected.', 'error');
                 return;
             }

             const reader = new FileReader();
             reader.onload = async (e) => {
                 const data = new Uint8Array(e.target.result);
                 const workbook = XLSX.read(data, { type: 'array' });
                 const firstSheetName = workbook.SheetNames[0];
                 const worksheet = workbook.Sheets[firstSheetName];
                 const json = XLSX.utils.sheet_to_json(worksheet);

                 let updatedCount = 0;
                 let errorCount = 0;

                 // Map of column headers from the Excel file to Firestore fields
                 const conditionMap = {
                     'Flawless': 'flawless',
                     'Good': 'good',
                     'Fair': 'fair',
                     'Damaged': 'damaged',
                     'Broken': 'broken',
                     'No Power': 'noPower'
                 };
                 const conditionHeaders = Object.keys(conditionMap);
                 
                 const deviceUpdates = {};

                 json.forEach((row, index) => {
                     // Normalize column values to match Firestore structure
                     const brand = row['Brand']?.toLowerCase() === 'iphones' ? 'iphone' : row['Brand']?.toLowerCase();
                     const slug = row['Slug'];
                     const storage = row['Storage'];
                     const connectivity = row['Lock Status']?.toLowerCase().replace(' ', ''); // Remove space

                     if (!brand || !slug || !storage || !connectivity) {
                         console.error(`Skipping row ${index + 2} due to missing primary identifiers (Brand, Slug, Storage, or Lock Status):`, row);
                         errorCount++;
                         return;
                     }
                     
                     // Initialize update object for the device if it doesn't exist
                     if (!deviceUpdates[brand]) {
                         deviceUpdates[brand] = {};
                     }
                     if (!deviceUpdates[brand][slug]) {
                         deviceUpdates[brand][slug] = {
                             name: row['Device'] || slug,
                             slug: slug,
                             brand: brand,
                             prices: {}
                         };
                     }
                     if (!deviceUpdates[brand][slug].prices[storage]) {
                         deviceUpdates[brand][slug].prices[storage] = {};
                     }
                     if (!deviceUpdates[brand][slug].prices[storage][connectivity]) {
                         deviceUpdates[brand][slug].prices[storage][connectivity] = {};
                     }
                     
                     // Map prices from the row to the update object
                     conditionHeaders.forEach(conditionHeader => {
                         const price = row[conditionHeader];
                         const condition = conditionMap[conditionHeader];
                         if (price !== undefined && price !== null && !isNaN(parseFloat(price))) {
                             deviceUpdates[brand][slug].prices[storage][connectivity][condition] = parseFloat(price);
                         }
                     });
                 });
                 
                 // Process updates for each device
                 const updatePromises = [];
                 for (const brand in deviceUpdates) {
                     for (const slug in deviceUpdates[brand]) {
                         const updateData = deviceUpdates[brand][slug];
                         const collectionPath = `devices/${brand}/models`;
                         const docRef = doc(db, collectionPath, slug);

                         updatePromises.push(setDoc(docRef, updateData, { merge: true })
                            .then(() => {
                                updatedCount++;
                            })
                            .catch(e => {
                                console.error(`Failed to update document for slug '${slug}':`, e);
                                errorCount++;
                            })
                         );
                     }
                 }

                 await Promise.all(updatePromises);

                 if (errorCount === 0) {
                     showImportStatus(`Successfully updated ${updatedCount} prices!`, 'success');
                 } else {
                     showImportStatus(`Updated ${updatedCount} prices with ${errorCount} errors. See console for details.`, 'error');
                 }
                 
                 importModal.classList.remove('is-visible');
                 fetchDevices(); // Refresh the main table
             };
             reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
