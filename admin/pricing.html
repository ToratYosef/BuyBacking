<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .table-container { max-height: 70vh; overflow-y: auto; }
        .sticky-header th { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; }
        .btn-primary { @apply bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300; }
        .btn-secondary { @apply bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-300; }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1; visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <!-- Header and Controls -->
    <header class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Price Management Dashboard</h1>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="search" id="searchInput" placeholder="Search for device..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <select id="brandFilter" class="py-2 px-4 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Brands</option>
                <option value="iphone">iPhone</option>
                <option value="samsung">Samsung</option>
                <option value="google_pixel">Google</option>
                <option value="ipad">iPad</option>
                <option value="macbook">MacBook</option>
                <option value="other">Other</option>
            </select>
            <button id="importBtn" class="btn-primary"><i class="fas fa-file-excel mr-2"></i>Import Prices</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="bg-white rounded-xl shadow-lg p-6">
        <div id="statusMessage" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>
        <div id="loadingIndicator" class="text-center py-12">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="text-gray-500 mt-2">Loading device data...</p>
        </div>
        <div id="deviceTableContainer" class="table-container hidden">
            <table class="min-w-full bg-white rounded-lg">
                <thead class="sticky-header">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Device</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Storage</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lock Status</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Flawless</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Good</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fair</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Damaged</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Broken</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">No Power</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody" class="divide-y divide-gray-200">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Excel Import Modal -->
    <div id="importModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Import Prices from Excel</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2" for="excelFile">Choose Excel File (.xlsx, .xls)</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <div id="excelPreview" class="table-container border rounded-lg overflow-hidden hidden">
                <table class="min-w-full bg-white">
                    <thead class="sticky-header"></thead>
                    <tbody class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="importStatus" class="mt-4 hidden p-3 rounded-lg text-center"></div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="processImportBtn" class="btn-primary hidden">Confirm & Update Prices</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (your provided credentials)
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let allDevices = [];
        let filteredDevices = [];
        const supportedBrands = ['iphone', 'samsung', 'google_pixel', 'ipad', 'macbook', 'other'];
        const conditions = ['flawless', 'good', 'fair', 'damaged', 'broken', 'noPower'];

        // DOM elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const deviceTableContainer = document.getElementById('deviceTableContainer');
        const deviceTableBody = document.getElementById('deviceTableBody');
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');
        const statusMessage = document.getElementById('statusMessage');
        const importModal = document.getElementById('importModal');
        const importBtn = document.getElementById('importBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const excelFile = document.getElementById('excelFile');
        const excelPreview = document.getElementById('excelPreview');
        const processImportBtn = document.getElementById('processImportBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const importStatus = document.getElementById('importStatus');

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            } else {
                 statusMessage.classList.add('bg-blue-100', 'text-blue-700');
            }
            statusMessage.classList.remove('hidden');
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                await fetchDevices();
            } else {
                console.log("No user is signed in. Signing in anonymously...");
                try {
                    await signInAnonymously(auth);
                    await fetchDevices();
                } catch (error) {
                    console.error("Anonymous auth failed:", error);
                    showStatus("Authentication failed. Please check Firebase Auth settings.", "error");
                }
            }
        });
        
        // --- FETCH & RENDER DEVICES ---
        const fetchDevices = async () => {
            loadingIndicator.classList.remove('hidden');
            deviceTableContainer.classList.add('hidden');
            allDevices = [];

            try {
                for (const brand of supportedBrands) {
                    const collectionPath = `devices/${brand}/models`;
                    const querySnapshot = await getDocs(collection(db, collectionPath));
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allDevices.push({ ...data, brand: brand, docId: doc.id, documentPath: collectionPath });
                    });
                }
            } catch (error) {
                console.error("Error fetching devices from Firestore:", error);
                showStatus("Failed to load device data. Check console for details.", "error");
            }
            applyFilters();
        };

        const renderTable = (devices) => {
            deviceTableBody.innerHTML = '';
            loadingIndicator.classList.add('hidden');
            if (devices.length > 0) {
                deviceTableContainer.classList.remove('hidden');
            } else {
                deviceTableContainer.classList.add('hidden');
                showStatus("No devices found.", "info");
                return;
            }

            devices.forEach(device => {
                const deviceData = device.prices;
                for (const storage in deviceData) {
                    const storageData = deviceData[storage];
                    for (const connectivity in storageData) {
                        const prices = storageData[connectivity];
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900 flex items-center">
                                    ${device.brand.includes('ipad') || device.brand.includes('macbook') ? 
                                      `<i class="fas fa-tablet-alt text-xl mr-2"></i>` : 
                                      `<i class="fas fa-mobile-alt text-xl mr-2"></i>`}
                                    ${device.name}
                                </td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${storage}</td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm font-semibold ${connectivity === 'unlocked' ? 'text-green-600' : 'text-red-600'}">${connectivity}</td>
                                ${conditions.map(condition => `
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                        <div class="flex items-center">
                                            <span>$</span>
                                            <input type="number" value="${prices[condition] || 0}"
                                                   class="w-24 border rounded-lg px-2 py-1 text-center"
                                                   data-doc-id="${device.docId}"
                                                   data-doc-path="${device.documentPath}"
                                                   data-storage="${storage}"
                                                   data-connectivity="${connectivity}"
                                                   data-condition="${condition}"
                                                   onblur="handlePriceUpdate(this)"
                                                   onkeypress="if(event.key === 'Enter') this.blur();">
                                        </div>
                                    </td>
                                `).join('')}
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                    <button class="text-red-500 hover:text-red-700" 
                                            onclick="showStatus('Deletion is not yet supported in this version.', 'error')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        deviceTableBody.insertAdjacentHTML('beforeend', row);
                    }
                }
            });
        };

        const applyFilters = () => {
            const searchText = searchInput.value.toLowerCase();
            const brand = brandFilter.value;

            filteredDevices = allDevices.filter(device => {
                const matchesSearch = device.name.toLowerCase().includes(searchText) || (device.brand && device.brand.toLowerCase().includes(searchText));
                const matchesBrand = brand === 'all' || (device.brand && device.brand.toLowerCase() === brand);
                return matchesSearch && matchesBrand;
            });

            renderTable(filteredDevices);
        };
        
        searchInput.addEventListener('input', applyFilters);
        brandFilter.addEventListener('change', applyFilters);

        // --- UPDATE PRICE LOGIC ---
        window.handlePriceUpdate = async (element) => {
            const newPrice = parseFloat(element.value);
            if (isNaN(newPrice) || newPrice < 0) {
                showStatus("Invalid price entered.", "error");
                element.value = element.defaultValue; // Revert to old value
                return;
            }

            const docId = element.dataset.docId;
            const docPath = element.dataset.docPath;
            const storage = element.dataset.storage;
            const connectivity = element.dataset.connectivity;
            const condition = element.dataset.condition;
            const docRef = doc(db, docPath, docId);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    if (!docSnapshot.exists()) {
                        throw "Document does not exist!";
                    }

                    const prices = docSnapshot.data().prices;
                    if (!prices[storage] || !prices[storage][connectivity] || prices[storage][connectivity][condition] === undefined) {
                        throw `Price path not found for ${docId} (${storage} - ${connectivity} - ${condition}).`;
                    }
                    prices[storage][connectivity][condition] = newPrice;
                    transaction.update(docRef, { prices: prices });
                });
                
                element.defaultValue = newPrice;
                showStatus(`Price for ${docId} (${storage} - ${connectivity} - ${condition}) updated successfully!`, "success");
            } catch (e) {
                console.error("Transaction failed: ", e);
                showStatus("Failed to update price. Check console for details.", "error");
                element.value = element.defaultValue; // Revert on error
            }
        };

        // --- EXCEL IMPORT LOGIC ---
        importBtn.addEventListener('click', () => importModal.classList.add('is-visible'));
        closeModalBtn.addEventListener('click', () => importModal.classList.remove('is-visible'));
        cancelImportBtn.addEventListener('click', () => {
            excelFile.value = null;
            excelPreview.classList.add('hidden');
            importStatus.classList.add('hidden');
            processImportBtn.classList.add('hidden');
            importModal.classList.remove('is-visible');
        });

        excelFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                if (json.length > 0) {
                    renderExcelPreview(json);
                    importStatus.classList.add('hidden');
                    processImportBtn.classList.remove('hidden');
                } else {
                    showImportStatus('No data found in the Excel file.', 'error');
                    processImportBtn.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        const renderExcelPreview = (data) => {
            const previewTable = excelPreview.querySelector('table');
            const previewHeader = previewTable.querySelector('thead');
            const previewBody = previewTable.querySelector('tbody');

            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';

            const headers = Object.keys(data[0]);
            const headerRow = `<tr>${headers.map(h => `<th class="py-2 px-4 text-left text-xs font-semibold text-gray-600 uppercase">${h}</th>`).join('')}</tr>`;
            previewHeader.insertAdjacentHTML('beforeend', headerRow);

            data.forEach(row => {
                const rowHTML = `<tr>${headers.map(h => `<td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">${row[h]}</td>`).join('')}</tr>`;
                previewBody.insertAdjacentHTML('beforeend', rowHTML);
            });
            excelPreview.classList.remove('hidden');
        };
        
        const showImportStatus = (message, type) => {
            importStatus.textContent = message;
            importStatus.className = `mt-4 p-3 rounded-lg text-sm text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            importStatus.classList.remove('hidden');
        };

        processImportBtn.addEventListener('click', async () => {
             showImportStatus('Processing import...', 'info');
             const file = excelFile.files[0];
             if (!file) {
                 showImportStatus('No file selected.', 'error');
                 return;
             }

             const reader = new FileReader();
             reader.onload = async (e) => {
                 const data = new Uint8Array(e.target.result);
                 const workbook = XLSX.read(data, { type: 'array' });
                 const firstSheetName = workbook.SheetNames[0];
                 const worksheet = workbook.Sheets[firstSheetName];
                 const json = XLSX.utils.sheet_to_json(worksheet);

                 let updatedCount = 0;
                 let errorCount = 0;

                 // Map of column headers from the Excel file to Firestore fields
                 const conditionMap = {
                     'Flawless': 'flawless',
                     'Good': 'good',
                     'Fair': 'fair',
                     'Damaged': 'damaged',
                     'Broken': 'broken',
                     'No Power': 'noPower'
                 };
                 const conditionHeaders = Object.keys(conditionMap);
                 
                 const deviceUpdates = {};

                 json.forEach((row, index) => {
                     // Normalize column values to match Firestore structure
                     const brand = row['Brand']?.toLowerCase() === 'iphones' ? 'iphone' : row['Brand']?.toLowerCase();
                     const slug = row['Slug'];
                     const storage = row['Storage'];
                     const connectivity = row['Lock Status']?.toLowerCase().replace(' ', ''); // Remove space

                     if (!brand || !slug || !storage || !connectivity) {
                         console.error(`Skipping row ${index + 2} due to missing primary identifiers (Brand, Slug, Storage, or Lock Status):`, row);
                         errorCount++;
                         return;
                     }
                     
                     // Initialize update object for the device if it doesn't exist
                     if (!deviceUpdates[brand]) {
                         deviceUpdates[brand] = {};
                     }
                     if (!deviceUpdates[brand][slug]) {
                         deviceUpdates[brand][slug] = {};
                     }
                     if (!deviceUpdates[brand][slug][storage]) {
                         deviceUpdates[brand][slug][storage] = {};
                     }
                     if (!deviceUpdates[brand][slug][storage][connectivity]) {
                         deviceUpdates[brand][slug][storage][connectivity] = {};
                     }
                     
                     // Map prices from the row to the update object
                     conditionHeaders.forEach(conditionHeader => {
                         const price = row[conditionHeader];
                         const condition = conditionMap[conditionHeader];
                         if (price !== undefined && price !== null && !isNaN(parseFloat(price))) {
                             deviceUpdates[brand][slug][storage][connectivity][condition] = parseFloat(price);
                         }
                     });
                 });
                 
                 // Process updates for each device
                 const updatePromises = [];
                 for (const brand in deviceUpdates) {
                     for (const slug in deviceUpdates[brand]) {
                         const updateData = deviceUpdates[brand][slug];
                         const collectionPath = `devices/${brand}/models`;
                         const docRef = doc(db, collectionPath, slug);

                         updatePromises.push(updateDoc(docRef, { prices: updateData })
                            .then(() => {
                                updatedCount++;
                            })
                            .catch(e => {
                                console.error(`Failed to update document for slug '${slug}':`, e);
                                errorCount++;
                            })
                         );
                     }
                 }

                 await Promise.all(updatePromises);

                 if (errorCount === 0) {
                     showImportStatus(`Successfully updated ${updatedCount} prices!`, 'success');
                 } else {
                     showImportStatus(`Updated ${updatedCount} prices with ${errorCount} errors. See console for details.`, 'error');
                 }
                 
                 importModal.classList.remove('is-visible');
                 fetchDevices(); // Refresh the main table
             };
             reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
