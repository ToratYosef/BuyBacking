<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pricing Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // This is a placeholder for your Firebase config. Do not store sensitive info here.
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let allDevices = [];

        document.addEventListener('DOMContentLoaded', () => {
            const pricingTableBody = document.getElementById('pricingTableBody');
            const addNewModelBtn = document.getElementById('addNewModelBtn');
            const addEditModal = document.getElementById('addEditModal');
            const addEditForm = document.getElementById('addEditForm');
            const bulkEditModal = document.getElementById('bulkEditModal');
            const bulkEditForm = document.getElementById('bulkEditForm');
            const importModal = document.getElementById('importModal');
            const importForm = document.getElementById('importForm');
            const importFileBtn = document.getElementById('importFileBtn');
            const overwriteWarningSection = document.getElementById('overwriteWarningSection');
            const confirmOverwriteBtn = document.getElementById('confirmOverwriteBtn');
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            const statusMessage = document.getElementById('statusMessage');
            const loginSection = document.getElementById('loginSection');
            const adminPanel = document.getElementById('adminPanel');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const exportXLSXBtn = document.getElementById('exportXLSXBtn');
            const bulkEditBtn = document.getElementById('bulkEditBtn');
            const importXLSXBtn = document.getElementById('importXLSXBtn');
            const searchInput = document.getElementById('searchInput');
            const brandFilter = document.getElementById('brandFilter');
            
            // Function to check if the user is an admin by querying Firestore
            const checkAdminStatus = async (user) => {
                if (!user) {
                    return false;
                }
                try {
                    const adminDocRef = doc(db, 'admins', user.uid);
                    const adminDoc = await getDoc(adminDocRef);
                    return adminDoc.exists();
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    return false;
                }
            };
            
            // The core fix: use onAuthStateChanged as the single source of truth
            onAuthStateChanged(auth, async (user) => {
                loadingIndicator.classList.remove('hidden');
                
                if (user) {
                    const isAdmin = await checkAdminStatus(user);
                    if (isAdmin) {
                        userEmailDisplay.textContent = user.email;
                        loginSection.classList.add('hidden');
                        adminPanel.classList.remove('hidden');
                        loadingIndicator.classList.add('hidden');
                        console.log("Admin user authenticated and authorized.");
                        await fetchAndRenderPricing();
                    } else {
                        // User is signed in but not an admin. Sign them out and show login.
                        console.log("User signed in but not an authorized admin. Signing out...");
                        await signOut(auth);
                        loadingIndicator.classList.add('hidden');
                        loginSection.classList.remove('hidden');
                        adminPanel.classList.add('hidden');
                        displayStatusMessage("You are not authorized to view this page. Please sign in with an admin account.", 'error');
                    }
                } else {
                    // User is not signed in.
                    loadingIndicator.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    adminPanel.classList.add('hidden');
                    console.log("User not authenticated.");
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                displayStatusMessage('Signing in...', 'info');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Email login error:", error);
                    displayStatusMessage(`Login failed: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('loginGoogleBtn').addEventListener('click', async () => {
                displayStatusMessage('Signing in with Google...', 'info');
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google login error:", error);
                    displayStatusMessage(`Google login failed: ${error.message}`, 'error');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });

            const fetchAndRenderPricing = async (filters = {}) => {
                pricingTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">Loading pricing data...</td></tr>';
                const iphoneCollection = collection(db, "devices/iphones/models");
                const samsungCollection = collection(db, "devices/samsung/models");

                try {
                    const [iphoneSnapshot, samsungSnapshot] = await Promise.all([getDocs(iphoneCollection), getDocs(samsungCollection)]);
                    
                    allDevices = [];
                    iphoneSnapshot.forEach(doc => allDevices.push({ id: doc.id, ...doc.data() }));
                    samsungSnapshot.forEach(doc => allDevices.push({ id: doc.id, ...doc.data() }));
                    
                    renderPricingTable(allDevices, filters);
                } catch (error) {
                    console.error("Error fetching pricing data: ", error);
                    pricingTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading data. Please check your permissions.</td></tr>';
                }
            };
            
            const sortAndFilterDevices = (devices, filters) => {
                const storageOrder = { '64gb': 1, '128gb': 2, '256gb': 3, '512gb': 4, '1tb': 5 };
                
                const filtered = devices.filter(device => {
                    const matchesSearch = filters.search ? device.name.toLowerCase().includes(filters.search.toLowerCase()) : true;
                    const matchesBrand = filters.brand ? device.brand.toLowerCase() === filters.brand.toLowerCase() : true;
                    return matchesSearch && matchesBrand;
                });
                
                return filtered.sort((a, b) => {
                    // Group by model series (e.g., iPhone 11)
                    const getModelSeries = (name) => {
                        const match = name.match(/(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    };
                    const seriesA = getModelSeries(a.name);
                    const seriesB = getModelSeries(b.name);
                    if (seriesA !== seriesB) {
                        return seriesA - seriesB;
                    }

                    // Then group by model name (e.g., iPhone 11 Pro Max)
                    if (a.name !== b.name) {
                        return a.name.localeCompare(b.name);
                    }

                    // Finally, sort by storage size
                    const storageA = parseInt(Object.keys(a.prices)[0]);
                    const storageB = parseInt(Object.keys(b.prices)[0]);
                    return storageOrder[storageA] - storageOrder[storageB] || storageA - storageB;
                });
            };

            const renderPricingTable = (devices, filters) => {
                pricingTableBody.innerHTML = '';
                
                const sortedDevices = sortAndFilterDevices(devices, filters);

                if (sortedDevices.length === 0) {
                    pricingTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No matching devices found.</td></tr>';
                    return;
                }
                
                sortedDevices.forEach(device => {
                    // Collect all storage options for this device
                    const storageOptions = Object.keys(device.prices).sort((a,b) => (a.match(/\d+/) || [0])[0] - (b.match(/\d+/) || [0])[0]);
                    
                    storageOptions.forEach(storage => {
                        const priceData = device.prices[storage];
                        const unlockedPrices = priceData.unlocked || {};
                        const lockedPrices = priceData.locked || {};

                        // Render Unlocked row
                        const unlockedRow = createPriceRow(device, storage, 'unlocked', unlockedPrices);
                        pricingTableBody.appendChild(unlockedRow);

                        // Render Locked row (if it exists)
                        if (Object.keys(lockedPrices).length > 0) {
                            const lockedRow = createPriceRow(device, storage, 'locked', lockedPrices);
                            pricingTableBody.appendChild(lockedRow);
                        }
                    });
                });

                // Add event listeners for inline editing and bulk actions
                document.querySelectorAll('.price-input').forEach(input => {
                    input.addEventListener('click', (e) => e.target.select());
                    input.addEventListener('blur', handleEditPrice);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.target.blur();
                        }
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const brand = e.target.dataset.brand;
                        const id = e.target.dataset.id;
                        const deviceName = e.target.dataset.name;
                        
                        // Use a custom modal or an elegant message instead of `confirm`
                        if (window.confirm(`Are you sure you want to delete ${deviceName}? This action is irreversible.`)) {
                           // Use a `try/catch` block for error handling
                           try {
                               await deleteDoc(doc(db, `devices/${brand}/models`, id));
                               displayStatusMessage(`${deviceName} deleted successfully!`, 'success');
                               fetchAndRenderPricing({ search: searchInput.value, brand: brandFilter.value });
                           } catch (error) {
                               console.error("Error deleting document:", error);
                               displayStatusMessage(`Error deleting ${deviceName}.`, 'error');
                           }
                        }
                    });
                });
            };

            const createPriceRow = (device, storage, status, prices) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                
                const deleteBtnHtml = `<button class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 delete-btn" data-id="${device.id}" data-brand="${device.brand}" data-name="${device.name}">Delete</button>`;
                
                row.innerHTML = `
                    <td class="py-3 px-4 flex items-center gap-2">
                        <img src="${device.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E5E7EB/4B5563?text=NO+IMG';" alt="${device.name}" class="w-10 h-10 object-contain rounded-md border">
                        <span>${device.name}</span>
                    </td>
                    <td class="py-3 px-4">${storage}</td>
                    <td class="py-3 px-4 font-semibold text-sm ${status === 'unlocked' ? 'text-blue-600' : 'text-orange-600'}">${status}</td>
                    ${renderEditablePriceCell(prices.flawless, device, storage, status, 'flawless')}
                    ${renderEditablePriceCell(prices.good, device, storage, status, 'good')}
                    ${renderEditablePriceCell(prices.fair, device, storage, status, 'fair')}
                    ${renderEditablePriceCell(prices.damaged, device, storage, status, 'damaged')}
                    ${renderEditablePriceCell(prices.broken, device, storage, status, 'broken')}
                    ${renderEditablePriceCell(prices.noPower, device, storage, status, 'noPower')}
                    <td class="py-3 px-4 text-center">${deleteBtnHtml}</td>
                `;
                return row;
            };

            const renderEditablePriceCell = (price, device, storage, status, condition) => {
                const value = price !== undefined && price !== null ? price.toFixed(2) : '';
                return `
                    <td class="py-3 px-2">
                        <div class="relative flex items-center bg-gray-100 rounded-lg p-2 border border-gray-200 hover:border-blue-500 transition-colors">
                            <span class="text-gray-500 text-xs mr-1">$</span>
                            <input 
                                type="number" 
                                step="0.01" 
                                value="${value}" 
                                placeholder="N/A"
                                class="price-input w-full bg-transparent text-gray-900 font-medium text-center focus:outline-none"
                                data-id="${device.id}"
                                data-brand="${device.brand}"
                                data-storage="${storage}"
                                data-status="${status}"
                                data-condition="${condition}"
                            />
                        </div>
                    </td>
                `;
            };

            const handleEditPrice = async (e) => {
                const input = e.target;
                const newValue = parseFloat(input.value);
                
                if (isNaN(newValue)) {
                    // Revert to old value or show error
                    input.value = input.dataset.originalValue;
                    return;
                }
                
                const docId = input.dataset.id;
                const brand = input.dataset.brand;
                const storage = input.dataset.storage;
                const status = input.dataset.status;
                const condition = input.dataset.condition;

                const docRef = doc(db, `devices/${brand}/models`, docId);
                const updatePath = `prices.${storage}.${status}.${condition}`;
                
                const updateObject = {
                    [updatePath]: newValue
                };

                try {
                    await setDoc(docRef, updateObject, { merge: true });
                    displayStatusMessage('Price updated successfully!', 'success');
                } catch (error) {
                    console.error("Error updating price:", error);
                    displayStatusMessage('Error updating price.', 'error');
                }
            };
            
            // Filters
            searchInput.addEventListener('input', () => renderPricingTable(allDevices, { search: searchInput.value, brand: brandFilter.value }));
            brandFilter.addEventListener('change', () => renderPricingTable(allDevices, { search: searchInput.value, brand: brandFilter.value }));
            
            // Export to XLSX
            exportXLSXBtn.addEventListener('click', () => {
                const table = document.getElementById('pricingTable');
                if (!table) {
                    displayStatusMessage('No data to export.', 'error');
                    return;
                }

                const wb = XLSX.utils.table_to_book(table);
                XLSX.writeFile(wb, "pricing_data.xlsx");
                displayStatusMessage('Export successful!', 'success');
            });
            
            // Import from XLSX logic
            importXLSXBtn.addEventListener('click', () => {
                importModal.classList.remove('hidden');
            });
            
            importForm.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    processImportData(json);
                };
                reader.readAsArrayBuffer(file);
            });
            
            let changesToCommit = [];
            
            const processImportData = (importedData) => {
                changesToCommit = [];
                overwriteWarningSection.innerHTML = '';
                
                const currentDataMap = allDevices.reduce((acc, device) => {
                    acc[device.id] = device;
                    return acc;
                }, {});
                
                importedData.forEach(row => {
                    // Assuming the imported spreadsheet has columns that match the schema
                    const deviceName = row['Device'];
                    const storage = row['Storage'];
                    const status = row['Lock Status'].toLowerCase();
                    const slug = row['Slug'];
                    const brand = row['Brand'].toLowerCase();

                    const existingDevice = currentDataMap[slug];

                    if (existingDevice) {
                        const existingPrice = existingDevice.prices?.[storage]?.[status];
                        const newPrices = {};
                        
                        // Map the quality columns to the correct keys
                        ['Flawless', 'Good', 'Fair', 'Damaged', 'Broken', 'No Power'].forEach(quality => {
                            const newPrice = row[quality];
                            const conditionKey = quality.replace(/\s/g, '').replace('no', 'noPower').toLowerCase();
                            
                            if (newPrice !== undefined && newPrice !== null) {
                                // Check if a price has changed
                                if (existingPrice && existingPrice[conditionKey] !== newPrice) {
                                    changesToCommit.push({
                                        id: slug,
                                        brand: brand,
                                        storage: storage,
                                        status: status,
                                        condition: conditionKey,
                                        oldPrice: existingPrice[conditionKey] || 'N/A',
                                        newPrice: newPrice
                                    });
                                }
                                
                                if (!newPrices[status]) newPrices[status] = {};
                                newPrices[status][conditionKey] = newPrice;
                            }
                        });
                    }
                });

                if (changesToCommit.length > 0) {
                    let tableHTML = `
                        <h4 class="text-lg font-semibold text-red-600 mb-4">Warning: The following prices will be overwritten.</h4>
                        <table class="w-full text-sm text-left text-gray-500 rounded-lg overflow-hidden">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Device</th>
                                    <th scope="col" class="py-3 px-6">Storage</th>
                                    <th scope="col" class="py-3 px-6">Status</th>
                                    <th scope="col" class="py-3 px-6">Condition</th>
                                    <th scope="col" class="py-3 px-6">Old Price</th>
                                    <th scope="col" class="py-3 px-6">New Price</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    changesToCommit.forEach(change => {
                        tableHTML += `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="py-4 px-6 font-medium text-gray-900">${change.id}</td>
                                <td class="py-4 px-6">${change.storage}</td>
                                <td class="py-4 px-6">${change.status}</td>
                                <td class="py-4 px-6">${change.condition}</td>
                                <td class="py-4 px-6 text-red-500">$${change.oldPrice}</td>
                                <td class="py-4 px-6 text-green-500">$${change.newPrice}</td>
                            </tr>
                        `;
                    });
                    tableHTML += `</tbody></table>`;
                    overwriteWarningSection.innerHTML = tableHTML;
                    document.getElementById('overwriteActions').classList.remove('hidden');
                } else {
                    displayStatusMessage('No changes detected. Data is up to date.', 'info');
                    document.getElementById('overwriteActions').classList.add('hidden');
                }
            };
            
            confirmOverwriteBtn.addEventListener('click', async () => {
                const batch = writeBatch(db);
                changesToCommit.forEach(change => {
                    const docRef = doc(db, `devices/${change.brand}/models`, change.id);
                    const updatePath = `prices.${change.storage}.${change.status}.${change.condition}`;
                    const updateObject = {
                        [updatePath]: change.newPrice
                    };
                    batch.set(docRef, updateObject, { merge: true });
                });
                
                try {
                    await batch.commit();
                    displayStatusMessage('All prices updated successfully!', 'success');
                    importModal.classList.add('hidden');
                    fetchAndRenderPricing({ search: searchInput.value, brand: brandFilter.value });
                } catch (error) {
                    console.error("Error committing batch:", error);
                    displayStatusMessage('Error updating prices. Please try again.', 'error');
                }
            });


            // Bulk Edit Modal
            bulkEditBtn.addEventListener('click', () => {
                bulkEditModal.classList.remove('hidden');
            });
            
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    addEditModal.classList.add('hidden');
                    bulkEditModal.classList.add('hidden');
                    importModal.classList.add('hidden');
                    importForm.reset();
                    overwriteWarningSection.innerHTML = '';
                    document.getElementById('overwriteActions').classList.add('hidden');
                });
            });

            bulkEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const bulkBrand = document.getElementById('bulkBrand').value;
                const bulkModel = document.getElementById('bulkModel').value;
                const bulkQuality = document.getElementById('bulkQuality').value;
                const bulkAction = document.getElementById('bulkAction').value;
                const bulkValue = parseFloat(document.getElementById('bulkValue').value);
                const bulkStatus = document.getElementById('bulkStatus').value;

                if (isNaN(bulkValue)) {
                    displayStatusMessage('Please enter a valid number for the bulk value.', 'error');
                    return;
                }

                const updates = {};
                const matchingDevices = allDevices.filter(device => {
                    let matches = true;
                    if (bulkBrand && device.brand !== bulkBrand) matches = false;
                    if (bulkModel && device.slug !== bulkModel) matches = false;
                    return matches;
                });
                
                const batch = writeBatch(db);

                matchingDevices.forEach(device => {
                    const docRef = doc(db, `devices/${device.brand}/models`, device.id);
                    let shouldUpdate = false;
                    
                    const newPrices = JSON.parse(JSON.stringify(device.prices));

                    for (const storage in newPrices) {
                        const priceData = newPrices[storage];
                        
                        // Check locked/unlocked status
                        const statusToUpdate = bulkStatus === 'all' ? ['unlocked', 'locked'] : [bulkStatus];

                        statusToUpdate.forEach(status => {
                            if (priceData[status]) {
                                for (const condition in priceData[status]) {
                                    if (bulkQuality === 'all' || condition === bulkQuality) {
                                        let currentPrice = priceData[status][condition];
                                        if (currentPrice !== null && currentPrice !== undefined) {
                                            if (bulkAction === 'percent') {
                                                currentPrice += currentPrice * (bulkValue / 100);
                                            } else if (bulkAction === 'add') {
                                                currentPrice += bulkValue;
                                            } else if (bulkAction === 'subtract') {
                                                currentPrice -= bulkValue;
                                            }
                                            priceData[status][condition] = parseFloat(currentPrice.toFixed(2));
                                            shouldUpdate = true;
                                        }
                                    }
                                }
                            }
                        });
                    }
                    if (shouldUpdate) {
                         batch.set(docRef, { prices: newPrices }, { merge: true });
                    }
                });
                
                try {
                    await batch.commit();
                    displayStatusMessage('Bulk edit successful!', 'success');
                    bulkEditModal.classList.add('hidden');
                    fetchAndRenderPricing({ search: searchInput.value, brand: brandFilter.value });
                } catch (error) {
                    console.error("Error with bulk update:", error);
                    displayStatusMessage('Bulk update failed. Please try again.', 'error');
                }
            });

            // Populate bulk edit models dropdown
            const bulkModelSelect = document.getElementById('bulkModel');
            allDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.slug;
                option.textContent = device.name;
                bulkModelSelect.appendChild(option);
            });


            addNewModelBtn.addEventListener('click', () => {
                addEditForm.reset();
                addEditModal.classList.remove('hidden');
            });
            
            addEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const deviceName = document.getElementById('deviceName').value;
                const deviceBrand = document.getElementById('deviceBrand').value;
                const deviceSlug = document.getElementById('deviceSlug').value;
                const imageUrl = document.getElementById('imageUrl').value;
                const storageOptions = document.querySelectorAll('.storage-option');

                const prices = {};
                storageOptions.forEach(option => {
                    const storage = option.querySelector('.storage-size').value;
                    if (!storage) return;
                    
                    const unlockedPrices = {
                        flawless: parseFloat(option.querySelector('.unlocked-flawless').value) || null,
                        good: parseFloat(option.querySelector('.unlocked-good').value) || null,
                        fair: parseFloat(option.querySelector('.unlocked-fair').value) || null,
                        damaged: parseFloat(option.querySelector('.unlocked-damaged').value) || null,
                        broken: parseFloat(option.querySelector('.unlocked-broken').value) || null,
                        noPower: parseFloat(option.querySelector('.unlocked-no-power').value) || null
                    };
                    
                    const lockedPrices = {
                        flawless: parseFloat(option.querySelector('.locked-flawless').value) || null,
                        good: parseFloat(option.querySelector('.locked-good').value) || null,
                        fair: parseFloat(option.querySelector('.locked-fair').value) || null,
                        damaged: parseFloat(option.querySelector('.locked-damaged').value) || null,
                        broken: parseFloat(option.querySelector('.locked-broken').value) || null,
                        noPower: parseFloat(option.querySelector('.locked-no-power').value) || null
                    };

                    prices[storage] = { unlocked: unlockedPrices, locked: lockedPrices };
                });

                const newDeviceData = {
                    name: deviceName,
                    brand: deviceBrand,
                    slug: deviceSlug,
                    imageUrl: imageUrl,
                    prices: prices
                };

                try {
                    await setDoc(doc(db, `devices/${deviceBrand}/models`, deviceSlug), newDeviceData);
                    addEditModal.classList.add('hidden');
                    addEditForm.reset();
                    fetchAndRenderPricing();
                    displayStatusMessage('Model added/updated successfully!', 'success');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    displayStatusMessage('Error adding/updating model.', 'error');
                }
            });

            document.getElementById('addStorageOptionBtn').addEventListener('click', () => {
                const container = document.getElementById('storageOptionsContainer');
                const newOption = document.createElement('div');
                newOption.className = 'storage-option grid grid-cols-10 gap-4 mb-4';
                newOption.innerHTML = `
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Storage</label>
                        <input type="text" class="storage-size mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Unlocked Prices (Flawless, Good, Fair)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" step="0.01" placeholder="Flawless" class="unlocked-flawless flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            <input type="number" step="0.01" placeholder="Good" class="unlocked-good flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            <input type="number" step="0.01" placeholder="Fair" class="unlocked-fair flex-1 rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Locked Prices (Flawless, Good, Fair)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" step="0.01" placeholder="Flawless" class="locked-flawless flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            <input type="number" step="0.01" placeholder="Good" class="locked-good flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            <input type="number" step="0.01" placeholder="Fair" class="locked-fair flex-1 rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Broken (Damaged, Broken, No Power)</label>
                        <div class="flex gap-2 mt-1">
                             <input type="number" step="0.01" placeholder="Damaged" class="unlocked-damaged flex-1 rounded-md border-gray-300 shadow-sm p-2">
                             <input type="number" step="0.01" placeholder="Broken" class="unlocked-broken flex-1 rounded-md border-gray-300 shadow-sm p-2">
                             <input type="number" step="0.01" placeholder="No Power" class="unlocked-no-power flex-1 rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                    </div>
                    <div class="col-span-1 flex items-end">
                        <button type="button" class="bg-red-500 text-white px-3 py-2 rounded-md delete-storage-option">Delete</button>
                    </div>
                `;
                container.appendChild(newOption);
                
                newOption.querySelector('.delete-storage-option').addEventListener('click', () => {
                    newOption.remove();
                });
            });

            function displayStatusMessage(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `p-3 rounded-md mt-4 text-center ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} ${type === 'info' ? 'bg-blue-100 text-blue-700' : ''}`;
            }
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="text"], input[type="number"], select {
            border-color: #d1d5db;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto p-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">Pricing Management</h1>
            <div id="adminPanelControls" class="flex items-center gap-4 hidden">
                <span id="userEmailDisplay" class="text-sm font-medium"></span>
                <button id="logoutBtn" class="text-red-500 font-semibold hover:text-red-700">Logout</button>
                <button id="addNewModelBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add New Model
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <div id="loadingIndicator" class="flex justify-center items-center py-20">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
        </div>
        
        <div id="loginSection" class="text-center py-20 hidden">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-sm mx-auto">
                <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
                <p class="text-gray-600 mb-6">Please sign in to manage device pricing.</p>
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full rounded-lg border-gray-300 p-3" autocomplete="email">
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full rounded-lg border-gray-300 p-3" autocomplete="current-password">
                    <button type="submit" id="loginEmailBtn" class="bg-gray-800 text-white w-full px-6 py-3 rounded-lg font-semibold hover:bg-gray-900 transition-colors">
                        Sign In with Email
                    </button>
                </form>
                <p class="my-4 text-gray-500">or</p>
                <button id="loginGoogleBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors w-full">
                    <i class="fab fa-google mr-2"></i>Sign In with Google
                </button>
            </div>
        </div>

        <div id="adminPanel" class="hidden">
            <!-- New controls section for filtering and bulk actions -->
            <div class="bg-white shadow-md p-6 mb-6 rounded-lg flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="relative flex items-center">
                        <i class="fas fa-search absolute left-3 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Search by model..." class="pl-10 p-2 border rounded-full w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <select id="brandFilter" class="p-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Brands</option>
                            <option value="iphones">iPhones</option>
                            <option value="samsung">Samsung</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="exportXLSXBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Export to XLSX
                    </button>
                    <button id="importXLSXBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        <i class="fas fa-file-import mr-2"></i>Import from XLSX
                    </button>
                    <button id="bulkEditBtn" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                        <i class="fas fa-edit mr-2"></i>Bulk Edit
                    </button>
                </div>
            </div>

            <!-- Main pricing table -->
            <div class="bg-white shadow-lg rounded-lg overflow-x-auto">
                <table id="pricingTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Storage</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lock Status</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Flawless</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Good</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fair</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Damaged</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Broken</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No Power</th>
                            <th scope="col" class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pricingTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Devices will be rendered here -->
                    </tbody>
                </table>
            </div>
            <div id="statusMessage" class="hidden"></div>
        </div>
    </main>

    <!-- Add/Edit Model Modal -->
    <div id="addEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full mx-4 my-8">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Add/Edit Pricing Model</h3>
            <form id="addEditForm" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="deviceName" class="block text-sm font-medium text-gray-700">Device Name</label>
                        <input type="text" id="deviceName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="deviceBrand" class="block text-sm font-medium text-gray-700">Brand</label>
                        <select id="deviceBrand" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="">Select Brand</option>
                            <option value="iphones">iPhones</option>
                            <option value="samsung">Samsung</option>
                        </select>
                    </div>
                    <div>
                        <label for="deviceSlug" class="block text-sm font-medium text-gray-700">Slug (e.g., galaxy-s24-ultra)</label>
                        <input type="text" id="deviceSlug" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="imageUrl" class="block text-sm font-medium text-gray-700">Image URL</label>
                        <input type="text" id="imageUrl" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
                
                <hr class="my-6">
                <h4 class="text-xl font-bold text-gray-900 mb-4">Pricing by Storage and Condition</h4>
                <div id="storageOptionsContainer" class="space-y-4">
                    <!-- Initial storage option row -->
                    <div class="storage-option grid grid-cols-10 gap-4 mb-4">
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Storage</label>
                            <input type="text" class="storage-size mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Unlocked Prices (Flawless, Good, Fair)</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" step="0.01" placeholder="Flawless" class="unlocked-flawless flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                <input type="number" step="0.01" placeholder="Good" class="unlocked-good flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                <input type="number" step="0.01" placeholder="Fair" class="unlocked-fair flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Locked Prices (Flawless, Good, Fair)</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" step="0.01" placeholder="Flawless" class="locked-flawless flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                <input type="number" step="0.01" placeholder="Good" class="locked-good flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                <input type="number" step="0.01" placeholder="Fair" class="locked-fair flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Broken (Damaged, Broken, No Power)</label>
                            <div class="flex gap-2 mt-1">
                                 <input type="number" step="0.01" placeholder="Damaged" class="unlocked-damaged flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                 <input type="number" step="0.01" placeholder="Broken" class="unlocked-broken flex-1 rounded-md border-gray-300 shadow-sm p-2">
                                 <input type="number" step="0.01" placeholder="No Power" class="unlocked-no-power flex-1 rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <div class="col-span-1 flex items-end">
                            <button type="button" class="bg-red-500 text-white px-3 py-2 rounded-md delete-storage-option">Delete</button>
                        </div>
                    </div>
                </div>

                <button type="button" id="addStorageOptionBtn" class="mt-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                    Add Storage Option
                </button>
                
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold close-modal-btn">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Save Pricing</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4 my-8">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Bulk Edit Prices</h3>
            <form id="bulkEditForm" class="space-y-6">
                <div>
                    <label for="bulkBrand" class="block text-sm font-medium text-gray-700">Brand</label>
                    <select id="bulkBrand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="">All Brands</option>
                        <option value="iphones">iPhones</option>
                        <option value="samsung">Samsung</option>
                    </select>
                </div>
                <div>
                    <label for="bulkModel" class="block text-sm font-medium text-gray-700">Model</label>
                    <select id="bulkModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="">All Models</option>
                    </select>
                </div>
                <div>
                    <label for="bulkStatus" class="block text-sm font-medium text-gray-700">Lock Status</label>
                    <select id="bulkStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="all">All</option>
                        <option value="unlocked">Unlocked</option>
                        <option value="locked">Locked</option>
                    </select>
                </div>
                <div>
                    <label for="bulkQuality" class="block text-sm font-medium text-gray-700">Quality/Condition</label>
                    <select id="bulkQuality" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="all">All</option>
                        <option value="flawless">Flawless</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="damaged">Damaged</option>
                        <option value="broken">Broken</option>
                        <option value="noPower">No Power</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="bulkAction" class="block text-sm font-medium text-gray-700">Action</label>
                        <select id="bulkAction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="add">Add ($)</option>
                            <option value="subtract">Subtract ($)</option>
                            <option value="percent">Add (%)</option>
                        </select>
                    </div>
                    <div>
                        <label for="bulkValue" class="block text-sm font-medium text-gray-700">Value</label>
                        <input type="number" step="0.01" id="bulkValue" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold close-modal-btn">Cancel</button>
                    <button type="submit" class="bg-orange-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-600">Apply Bulk Edit</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4 my-8">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Import Prices from XLSX</h3>
            <form id="importForm" class="space-y-6">
                <p class="text-gray-600">Select an XLSX file to import pricing data. The file must contain columns: "Device", "Storage", "Lock Status", "Flawless", "Good", "Fair", "Damaged", "Broken", "No Power", "Slug", "Brand".</p>
                <input type="file" id="importFile" accept=".xlsx" class="w-full text-gray-700">
            </form>
            <div id="overwriteWarningSection" class="mt-6 hidden"></div>
            <div id="overwriteActions" class="mt-8 flex justify-end gap-4 hidden">
                <button type="button" class="bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold close-modal-btn">Cancel</button>
                <button type="button" id="confirmOverwriteBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600">Confirm Overwrite</button>
            </div>
        </div>
    </div>
</body>
</html>
