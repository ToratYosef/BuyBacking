<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(160deg, #f8fafc 0%, #eef2ff 100%); }
        .table-container { max-height: 70vh; overflow-y: auto; border-radius: 1rem; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 20px 45px -30px rgba(15, 23, 42, 0.45); }
        .table-container table { border-collapse: separate; border-spacing: 0; }
        .table-container tbody tr:nth-child(even) { background-color: rgba(241, 245, 249, 0.65); }
        .table-container tbody tr:hover { background: rgba(59, 130, 246, 0.08); }
        .sticky-header th { position: sticky; top: 0; background-color: rgba(248, 250, 252, 0.95); z-index: 10; backdrop-filter: blur(8px); box-shadow: inset 0 -1px 0 rgba(15, 23, 42, 0.05); }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.65rem 1.5rem;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: #ffffff; box-shadow: 0 15px 30px -20px rgba(37, 99, 235, 0.8); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 18px 40px -25px rgba(37, 99, 235, 0.9); }
        .btn-secondary { background: #e2e8f0; color: #1e293b; box-shadow: inset 0 -2px 0 rgba(148, 163, 184, 0.45); }
        .btn-secondary:hover { transform: translateY(-1px); background: #cbd5f5; }
        .btn-danger { background: rgba(248, 113, 113, 0.16); color: #b91c1c; border-radius: 9999px; padding: 0.35rem 0.65rem; transition: background 0.2s ease, transform 0.2s ease; }
        .btn-danger:hover { background: rgba(248, 113, 113, 0.25); transform: scale(1.05); }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border-radius: 9999px;
            padding: 0.35rem 0.9rem;
            background: rgba(30, 64, 175, 0.08);
            color: #1d4ed8;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1; visibility: visible;
        }
        .modal-card { border-radius: 1rem; box-shadow: 0 30px 80px -40px rgba(15, 23, 42, 0.45); border: 1px solid rgba(15, 23, 42, 0.08); }
        .form-grid { display: grid; gap: 1rem; }
        .field-label { font-size: 0.85rem; font-weight: 600; color: #1f2937; }
        .field-input { width: 100%; border-radius: 0.75rem; border: 1px solid rgba(148, 163, 184, 0.5); padding: 0.65rem 0.9rem; font-size: 0.95rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .field-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
        .price-input { width: 6rem; border-radius: 0.65rem; border: 1px solid rgba(148, 163, 184, 0.5); padding: 0.35rem 0.45rem; text-align: center; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .price-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .storage-row { position: relative; border: 1px solid rgba(148, 163, 184, 0.35); border-radius: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.9); box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.15); }
        .storage-remove { position: absolute; top: 0.75rem; right: 0.75rem; color: #dc2626; background: rgba(254, 226, 226, 0.65); border-radius: 9999px; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background 0.2s ease; }
        .storage-remove:hover { background: rgba(254, 202, 202, 0.95); transform: scale(1.05); }
        .status-message { border-radius: 0.75rem; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <!-- Header and Controls -->
    <header class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center border border-slate-100">
        <div class="flex flex-col items-start gap-2">
            <span class="badge"><i class="fa-solid fa-sparkles"></i> Live Pricing Suite</span>
            <h1 class="text-3xl font-bold text-gray-800">Price Management Dashboard</h1>
        </div>
        <div class="flex flex-col lg:flex-row lg:items-center gap-4 w-full md:w-auto mt-4 md:mt-0">
            <div class="relative">
                <input type="search" id="searchInput" placeholder="Search for device..." class="field-input pl-10 pr-4">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <select id="brandFilter" class="field-input">
                <option value="all">All Brands</option>
                <option value="iphone">iPhone</option>
                <option value="samsung">Samsung</option>
                <option value="google_pixel">Google</option>
                <option value="ipad">iPad</option>
                <option value="macbook">MacBook</option>
                <option value="other">Other</option>
            </select>
            <div class="flex gap-3">
                <button id="importBtn" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Import Prices</button>
                <button id="addDeviceBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Pricing</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="bg-white rounded-xl shadow-lg p-6">
        <div id="statusMessage" class="hidden status-message mb-4 p-3 text-sm text-center"></div>
        <div id="loadingIndicator" class="text-center py-12">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="text-gray-500 mt-2">Loading device data...</p>
        </div>
        <div id="deviceTableContainer" class="table-container hidden">
            <table class="min-w-full bg-white rounded-lg">
                <thead class="sticky-header">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Device</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Storage</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lock Status</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Flawless</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Good</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fair</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Damaged</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Broken</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">No Power</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody" class="divide-y divide-gray-200">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Excel Import Modal -->
    <div id="importModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white modal-card p-6 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Import Prices from Excel</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2" for="excelFile">Choose Excel File (.xlsx, .xls)</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <div id="excelPreview" class="table-container border rounded-lg overflow-hidden hidden">
                <table class="min-w-full bg-white">
                    <thead class="sticky-header"></thead>
                    <tbody class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="importStatus" class="mt-4 hidden p-3 rounded-lg text-center"></div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
                <button id="processImportBtn" class="btn btn-primary hidden">Confirm & Update Prices</button>
            </div>
        </div>
    </div>

    <!-- Add Pricing Modal -->
    <div id="addModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4">
        <div class="bg-white modal-card p-6 w-full max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Add Device Pricing</h2>
                    <p class="text-sm text-slate-500 mt-1">Create a device entry with one or more storage tiers and instant price points.</p>
                </div>
                <button id="closeAddModalBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="addDeviceForm" class="space-y-6">
                <div class="form-grid md:grid-cols-2 lg:grid-cols-3">
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Brand</span>
                        <select id="addBrand" class="field-input" required>
                            <option value="" disabled selected>Select brand</option>
                            <option value="iphone">iPhone</option>
                            <option value="samsung">Samsung</option>
                            <option value="google_pixel">Google</option>
                            <option value="ipad">iPad</option>
                            <option value="macbook">MacBook</option>
                            <option value="other">Other</option>
                        </select>
                    </label>
                    <label class="flex flex-col gap-2 md:col-span-1 lg:col-span-1">
                        <span class="field-label">Device Name</span>
                        <input type="text" id="addDeviceName" class="field-input" placeholder="iPhone 15 Pro" required>
                    </label>
                    <label class="flex flex-col gap-2 md:col-span-1 lg:col-span-1">
                        <span class="field-label">Slug</span>
                        <input type="text" id="addSlug" class="field-input" placeholder="iphone-15-pro" required>
                        <span class="text-xs text-slate-400">Lowercase, no spaces. We’ll auto-generate it as you type the name.</span>
                    </label>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-800">Storage & Condition Pricing</h3>
                        <button type="button" id="addStorageRowBtn" class="btn btn-secondary"><i class="fas fa-layer-group"></i> Add Storage Tier</button>
                    </div>
                    <div id="storageRows" class="space-y-4"></div>
                    <p class="text-xs text-slate-400">Tip: Leave any condition blank if you don’t offer pricing for it—only filled values will be saved.</p>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelAddBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-floppy-disk"></i> Save Pricing</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (your provided credentials)
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let allDevices = [];
        let filteredDevices = [];
        const supportedBrands = ['iphone', 'samsung', 'google_pixel', 'ipad', 'macbook', 'other'];
        const conditions = ['flawless', 'good', 'fair', 'damaged', 'broken', 'noPower'];

        // DOM elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const deviceTableContainer = document.getElementById('deviceTableContainer');
        const deviceTableBody = document.getElementById('deviceTableBody');
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');
        const statusMessage = document.getElementById('statusMessage');
        const importModal = document.getElementById('importModal');
        const importBtn = document.getElementById('importBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const excelFile = document.getElementById('excelFile');
        const excelPreview = document.getElementById('excelPreview');
        const processImportBtn = document.getElementById('processImportBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const importStatus = document.getElementById('importStatus');
        const addModal = document.getElementById('addModal');
        const addDeviceBtn = document.getElementById('addDeviceBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const addDeviceForm = document.getElementById('addDeviceForm');
        const addBrand = document.getElementById('addBrand');
        const addDeviceName = document.getElementById('addDeviceName');
        const addSlug = document.getElementById('addSlug');
        const addStorageRowBtn = document.getElementById('addStorageRowBtn');
        const storageRowsContainer = document.getElementById('storageRows');
        let slugManuallyEdited = false;

        const conditionConfig = [
            { key: 'flawless', label: 'Flawless' },
            { key: 'good', label: 'Good' },
            { key: 'fair', label: 'Fair' },
            { key: 'damaged', label: 'Damaged' },
            { key: 'broken', label: 'Broken' },
            { key: 'noPower', label: 'No Power' }
        ];

        const sanitizeSlug = (value) => value
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');

        const normalizeConnectivity = (value) => value
            .toLowerCase()
            .replace(/\s+/g, '')
            .trim();

        const toggleAddModal = (shouldShow) => {
            if (shouldShow) {
                addModal.classList.add('is-visible');
            } else {
                addModal.classList.remove('is-visible');
            }
        };

        const refreshStorageRemoveButtons = () => {
            const removeButtons = storageRowsContainer.querySelectorAll('.storage-remove');
            const disable = storageRowsContainer.children.length === 1;
            removeButtons.forEach(button => {
                button.disabled = disable;
                button.classList.toggle('opacity-40', disable);
                button.classList.toggle('cursor-not-allowed', disable);
            });
        };

        const createStorageRow = () => {
            const row = document.createElement('div');
            row.className = 'storage-row space-y-4';
            row.innerHTML = `
                <button type="button" class="storage-remove" title="Remove storage tier">
                    <i class="fas fa-times"></i>
                </button>
                <div class="form-grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Storage</span>
                        <input type="text" class="field-input storage-input" placeholder="128GB" required>
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="field-label">Lock Status</span>
                        <input type="text" class="field-input connectivity-input" placeholder="unlocked" required>
                    </label>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    ${conditionConfig.map(condition => `
                        <label class="flex flex-col gap-2">
                            <span class="field-label text-xs uppercase tracking-wide text-slate-500">${condition.label}</span>
                            <input type="number" min="0" step="0.01" class="price-input condition-input" data-condition="${condition.key}" placeholder="0.00">
                        </label>
                    `).join('')}
                </div>
            `;
            const removeBtn = row.querySelector('.storage-remove');
            removeBtn.addEventListener('click', () => {
                if (storageRowsContainer.children.length > 1) {
                    row.remove();
                    refreshStorageRemoveButtons();
                }
            });
            return row;
        };

        const resetAddForm = () => {
            addDeviceForm.reset();
            slugManuallyEdited = false;
            storageRowsContainer.innerHTML = '';
            storageRowsContainer.appendChild(createStorageRow());
            refreshStorageRemoveButtons();
        };

        resetAddForm();

        addDeviceName.addEventListener('input', () => {
            if (!slugManuallyEdited) {
                addSlug.value = sanitizeSlug(addDeviceName.value);
            }
        });

        addSlug.addEventListener('input', () => {
            slugManuallyEdited = true;
        });

        addSlug.addEventListener('blur', () => {
            addSlug.value = sanitizeSlug(addSlug.value);
        });

        addDeviceBtn.addEventListener('click', () => {
            resetAddForm();
            toggleAddModal(true);
        });

        const closeAddModal = () => {
            toggleAddModal(false);
        };

        closeAddModalBtn.addEventListener('click', closeAddModal);
        cancelAddBtn.addEventListener('click', closeAddModal);
        addModal.addEventListener('click', (event) => {
            if (event.target === addModal) {
                closeAddModal();
            }
        });

        addStorageRowBtn.addEventListener('click', () => {
            storageRowsContainer.appendChild(createStorageRow());
            refreshStorageRemoveButtons();
        });

        addDeviceForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const brand = addBrand.value;
            const deviceNameValue = addDeviceName.value.trim();
            let slugValue = addSlug.value.trim() ? sanitizeSlug(addSlug.value) : sanitizeSlug(deviceNameValue);

            if (!brand || !deviceNameValue || !slugValue) {
                showStatus('Please complete brand, device name, and slug before saving.', 'error');
                return;
            }

            const storageRows = Array.from(storageRowsContainer.children);
            if (storageRows.length === 0) {
                showStatus('Add at least one storage tier before saving.', 'error');
                return;
            }

            const pricePayload = {};
            let hasPricing = false;

            for (const row of storageRows) {
                const storageInput = row.querySelector('.storage-input');
                const connectivityInput = row.querySelector('.connectivity-input');
                const storageValue = storageInput.value.trim();
                let connectivityValue = connectivityInput.value.trim();

                if (!storageValue || !connectivityValue) {
                    showStatus('Storage and lock status are required for each tier.', 'error');
                    return;
                }

                connectivityValue = normalizeConnectivity(connectivityValue);

                if (!pricePayload[storageValue]) {
                    pricePayload[storageValue] = {};
                }
                if (!pricePayload[storageValue][connectivityValue]) {
                    pricePayload[storageValue][connectivityValue] = {};
                }

                const conditionInputs = row.querySelectorAll('.condition-input');
                let tierHasPrice = false;
                for (const input of conditionInputs) {
                    const rawValue = input.value.trim();
                    if (rawValue !== '') {
                        const numericValue = parseFloat(rawValue);
                        if (isNaN(numericValue) || numericValue < 0) {
                            showStatus('Please enter valid prices (0 or greater).', 'error');
                            return;
                        }
                        pricePayload[storageValue][connectivityValue][input.dataset.condition] = numericValue;
                        tierHasPrice = true;
                        hasPricing = true;
                    }
                }

                if (!tierHasPrice) {
                    showStatus(`Enter at least one price for ${storageValue} (${connectivityInput.value}).`, 'error');
                    return;
                }
            }

            if (!hasPricing) {
                showStatus('Enter at least one price before saving.', 'error');
                return;
            }

            addSlug.value = slugValue;
            const docPath = `devices/${brand}/models`;
            const docRef = doc(db, docPath, slugValue);

            const payload = {
                name: deviceNameValue,
                slug: slugValue,
                brand: brand,
                prices: pricePayload
            };

            try {
                showStatus('Saving pricing…', 'info');
                await setDoc(docRef, payload, { merge: true });
                showStatus(`Pricing for ${deviceNameValue} saved successfully.`, 'success');
                closeAddModal();
                resetAddForm();
                fetchDevices();
            } catch (error) {
                console.error('Failed to save pricing:', error);
                showStatus('Failed to save pricing. Check console for details.', 'error');
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message mb-4 p-3 text-sm text-center';
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-emerald-100', 'text-emerald-700', 'border', 'border-emerald-200');
            } else {
                statusMessage.classList.add('bg-indigo-100', 'text-indigo-700', 'border', 'border-indigo-200');
            }
            statusMessage.classList.remove('hidden');
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                await fetchDevices();
            } else {
                console.log("No user is signed in. Signing in anonymously...");
                try {
                    await signInAnonymously(auth);
                    await fetchDevices();
                } catch (error) {
                    console.error("Anonymous auth failed:", error);
                    showStatus("Authentication failed. Please check Firebase Auth settings.", "error");
                }
            }
        });
        
        // --- FETCH & RENDER DEVICES ---
        const fetchDevices = async () => {
            loadingIndicator.classList.remove('hidden');
            deviceTableContainer.classList.add('hidden');
            allDevices = [];

            try {
                for (const brand of supportedBrands) {
                    const collectionPath = `devices/${brand}/models`;
                    const querySnapshot = await getDocs(collection(db, collectionPath));
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allDevices.push({ ...data, brand: brand, docId: doc.id, documentPath: collectionPath });
                    });
                }
            } catch (error) {
                console.error("Error fetching devices from Firestore:", error);
                showStatus("Failed to load device data. Check console for details.", "error");
            }
            applyFilters();
        };

        const renderTable = (devices) => {
            deviceTableBody.innerHTML = '';
            loadingIndicator.classList.add('hidden');
            if (devices.length > 0) {
                deviceTableContainer.classList.remove('hidden');
            } else {
                deviceTableContainer.classList.add('hidden');
                showStatus("No devices found.", "info");
                return;
            }

            devices.forEach(device => {
                const deviceData = device.prices;
                for (const storage in deviceData) {
                    const storageData = deviceData[storage];
                    for (const connectivity in storageData) {
                        const prices = storageData[connectivity];
                        const row = `
                            <tr class="hover:bg-blue-50/60 transition-colors">
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900 flex items-center">
                                    ${device.brand.includes('ipad') || device.brand.includes('macbook') ?
                                      `<i class="fas fa-tablet-alt text-xl mr-2"></i>` :
                                      `<i class="fas fa-mobile-alt text-xl mr-2"></i>`}
                                    ${device.name}
                                </td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${storage}</td>
                                <td class="py-3 px-4 whitespace-nowrap text-sm font-semibold ${connectivity === 'unlocked' ? 'text-green-600' : 'text-red-600'}">${connectivity}</td>
                                ${conditions.map(condition => `
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                        <div class="flex items-center justify-center gap-1">
                                            <span class="text-slate-400 text-xs">$</span>
                                            <input type="number" value="${prices[condition] || ''}"
                                                   class="price-input"
                                                   data-doc-id="${device.docId}"
                                                   data-doc-path="${device.documentPath}"
                                                   data-storage="${storage}"
                                                   data-connectivity="${connectivity}"
                                                   data-condition="${condition}"
                                                   onblur="handlePriceUpdate(this)"
                                                   onkeypress="if(event.key === 'Enter') this.blur();">
                                        </div>
                                    </td>
                                `).join('')}
                                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                    <button class="btn-danger"
                                            title="Delete this configuration"
                                            data-doc-id="${device.docId}"
                                            data-doc-path="${device.documentPath}"
                                            data-storage="${storage}"
                                            data-connectivity="${connectivity}"
                                            onclick="handleDeleteRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        deviceTableBody.insertAdjacentHTML('beforeend', row);
                    }
                }
            });
        };

        const applyFilters = () => {
            const searchText = searchInput.value.toLowerCase();
            const brand = brandFilter.value;

            filteredDevices = allDevices.filter(device => {
                const matchesSearch = device.name.toLowerCase().includes(searchText) || (device.brand && device.brand.toLowerCase().includes(searchText));
                const matchesBrand = brand === 'all' || (device.brand && device.brand.toLowerCase() === brand);
                return matchesSearch && matchesBrand;
            });

            renderTable(filteredDevices);
        };
        
        searchInput.addEventListener('input', applyFilters);
        brandFilter.addEventListener('change', applyFilters);

        // --- UPDATE PRICE LOGIC ---
        window.handlePriceUpdate = async (element) => {
            const newPrice = parseFloat(element.value);
            if (isNaN(newPrice) || newPrice < 0) {
                showStatus("Invalid price entered.", "error");
                element.value = element.defaultValue; // Revert to old value
                return;
            }

            const docId = element.dataset.docId;
            const docPath = element.dataset.docPath;
            const storage = element.dataset.storage;
            const connectivity = element.dataset.connectivity;
            const condition = element.dataset.condition;
            const docRef = doc(db, docPath, docId);

            try {
                // Use a batched write to ensure atomicity and avoid race conditions
                await setDoc(docRef, {
                    prices: {
                        [storage]: {
                            [connectivity]: {
                                [condition]: newPrice
                            }
                        }
                    }
                }, { merge: true });

                element.defaultValue = newPrice;
                showStatus(`Price for ${docId} (${storage} - ${connectivity} - ${condition}) updated successfully!`, "success");
            } catch (e) {
                console.error("Failed to update price: ", e);
                showStatus("Failed to update price. Check console for details.", "error");
                element.value = element.defaultValue; // Revert on error
            }
        };

        window.handleDeleteRow = async (button) => {
            const docId = button.dataset.docId;
            const docPath = button.dataset.docPath;
            const storage = button.dataset.storage;
            const connectivity = button.dataset.connectivity;

            if (!docId || !docPath || !storage || !connectivity) {
                showStatus('Missing pricing metadata. Try refreshing the page.', 'error');
                return;
            }

            const confirmed = confirm(`Delete pricing for ${storage} (${connectivity})? This cannot be undone.`);
            if (!confirmed) {
                return;
            }

            const docRef = doc(db, docPath, docId);

            try {
                await runTransaction(db, async (transaction) => {
                    const snapshot = await transaction.get(docRef);
                    if (!snapshot.exists()) {
                        throw new Error('Device not found.');
                    }

                    const data = snapshot.data();
                    if (!data.prices || !data.prices[storage] || !data.prices[storage][connectivity]) {
                        throw new Error('Pricing tier already removed.');
                    }

                    delete data.prices[storage][connectivity];

                    if (Object.keys(data.prices[storage]).length === 0) {
                        delete data.prices[storage];
                    }

                    if (!data.prices || Object.keys(data.prices).length === 0) {
                        transaction.delete(docRef);
                    } else {
                        transaction.set(docRef, data);
                    }
                });

                showStatus(`Removed ${storage} (${connectivity}) pricing.`, 'success');
                fetchDevices();
            } catch (error) {
                console.error('Failed to delete pricing:', error);
                showStatus(error.message || 'Failed to delete pricing. Check console for details.', 'error');
            }
        };

        // --- EXCEL IMPORT LOGIC ---
        importBtn.addEventListener('click', () => importModal.classList.add('is-visible'));
        closeModalBtn.addEventListener('click', () => importModal.classList.remove('is-visible'));
        cancelImportBtn.addEventListener('click', () => {
            excelFile.value = null;
            excelPreview.classList.add('hidden');
            importStatus.classList.add('hidden');
            processImportBtn.classList.add('hidden');
            importModal.classList.remove('is-visible');
        });

        excelFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                if (json.length > 0) {
                    renderExcelPreview(json);
                    importStatus.classList.add('hidden');
                    processImportBtn.classList.remove('hidden');
                } else {
                    showImportStatus('No data found in the Excel file.', 'error');
                    processImportBtn.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        const renderExcelPreview = (data) => {
            const previewTable = excelPreview.querySelector('table');
            const previewHeader = previewTable.querySelector('thead');
            const previewBody = previewTable.querySelector('tbody');

            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';

            const headers = Object.keys(data[0]);
            const headerRow = `<tr>${headers.map(h => `<th class="py-2 px-4 text-left text-xs font-semibold text-gray-600 uppercase">${h}</th>`).join('')}</tr>`;
            previewHeader.insertAdjacentHTML('beforeend', headerRow);

            data.forEach(row => {
                const rowHTML = `<tr>${headers.map(h => `<td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">${row[h]}</td>`).join('')}</tr>`;
                previewBody.insertAdjacentHTML('beforeend', rowHTML);
            });
            excelPreview.classList.remove('hidden');
        };
        
        const showImportStatus = (message, type) => {
            importStatus.textContent = message;
            importStatus.className = 'mt-4 p-3 rounded-lg text-sm text-center';
            if (type === 'error') {
                importStatus.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                importStatus.classList.add('bg-emerald-100', 'text-emerald-700', 'border', 'border-emerald-200');
            } else {
                importStatus.classList.add('bg-indigo-100', 'text-indigo-700', 'border', 'border-indigo-200');
            }
            importStatus.classList.remove('hidden');
        };

        processImportBtn.addEventListener('click', async () => {
             showImportStatus('Processing import...', 'info');
             const file = excelFile.files[0];
             if (!file) {
                 showImportStatus('No file selected.', 'error');
                 return;
             }

             const reader = new FileReader();
             reader.onload = async (e) => {
                 const data = new Uint8Array(e.target.result);
                 const workbook = XLSX.read(data, { type: 'array' });
                 const firstSheetName = workbook.SheetNames[0];
                 const worksheet = workbook.Sheets[firstSheetName];
                 const json = XLSX.utils.sheet_to_json(worksheet);

                 let updatedCount = 0;
                 let errorCount = 0;

                 // Map of column headers from the Excel file to Firestore fields
                 const conditionMap = {
                     'Flawless': 'flawless',
                     'Good': 'good',
                     'Fair': 'fair',
                     'Damaged': 'damaged',
                     'Broken': 'broken',
                     'No Power': 'noPower'
                 };
                 const conditionHeaders = Object.keys(conditionMap);
                 
                 const deviceUpdates = {};

                 json.forEach((row, index) => {
                     // Normalize column values to match Firestore structure
                     const brand = row['Brand']?.toLowerCase() === 'iphones' ? 'iphone' : row['Brand']?.toLowerCase();
                     const slug = row['Slug'];
                     const storage = row['Storage'];
                     const connectivity = row['Lock Status']?.toLowerCase().replace(' ', ''); // Remove space

                     if (!brand || !slug || !storage || !connectivity) {
                         console.error(`Skipping row ${index + 2} due to missing primary identifiers (Brand, Slug, Storage, or Lock Status):`, row);
                         errorCount++;
                         return;
                     }
                     
                     // Initialize update object for the device if it doesn't exist
                     if (!deviceUpdates[brand]) {
                         deviceUpdates[brand] = {};
                     }
                     if (!deviceUpdates[brand][slug]) {
                         deviceUpdates[brand][slug] = {
                             name: row['Device'] || slug,
                             slug: slug,
                             brand: brand,
                             prices: {}
                         };
                     }
                     if (!deviceUpdates[brand][slug].prices[storage]) {
                         deviceUpdates[brand][slug].prices[storage] = {};
                     }
                     if (!deviceUpdates[brand][slug].prices[storage][connectivity]) {
                         deviceUpdates[brand][slug].prices[storage][connectivity] = {};
                     }
                     
                     // Map prices from the row to the update object
                     conditionHeaders.forEach(conditionHeader => {
                         const price = row[conditionHeader];
                         const condition = conditionMap[conditionHeader];
                         if (price !== undefined && price !== null && !isNaN(parseFloat(price))) {
                             deviceUpdates[brand][slug].prices[storage][connectivity][condition] = parseFloat(price);
                         }
                     });
                 });
                 
                 // Process updates for each device
                 const updatePromises = [];
                 for (const brand in deviceUpdates) {
                     for (const slug in deviceUpdates[brand]) {
                         const updateData = deviceUpdates[brand][slug];
                         const collectionPath = `devices/${brand}/models`;
                         const docRef = doc(db, collectionPath, slug);

                         updatePromises.push(setDoc(docRef, updateData, { merge: true })
                            .then(() => {
                                updatedCount++;
                            })
                            .catch(e => {
                                console.error(`Failed to update document for slug '${slug}':`, e);
                                errorCount++;
                            })
                         );
                     }
                 }

                 await Promise.all(updatePromises);

                 if (errorCount === 0) {
                     showImportStatus(`Successfully updated ${updatedCount} prices!`, 'success');
                 } else {
                     showImportStatus(`Updated ${updatedCount} prices with ${errorCount} errors. See console for details.`, 'error');
                 }
                 
                 importModal.classList.remove('is-visible');
                 fetchDevices(); // Refresh the main table
             };
             reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
