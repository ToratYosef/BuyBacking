<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Page View Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light dark;
    }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 24px 5vw 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 {
      font-size: clamp(1.75rem, 4vw, 2.5rem);
      margin: 0 0 8px;
      font-weight: 600;
      color: #f8fafc;
    }
    header p {
      margin: 0;
      color: rgba(226, 232, 240, 0.8);
    }
    main {
      flex: 1;
      padding: 24px 5vw 64px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    .panel {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
    }
    .conversion-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }
    .conversion-summary h2 {
      margin: 0 0 6px;
      font-size: clamp(1.4rem, 3vw, 1.9rem);
      font-weight: 600;
      color: #f8fafc;
    }
    .conversion-summary p {
      margin: 0;
      color: rgba(226, 232, 240, 0.8);
      max-width: 520px;
    }
    .conversion-total-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 140px;
      gap: 4px;
    }
    .conversion-total {
      font-size: clamp(2rem, 5vw, 2.6rem);
      font-weight: 700;
      color: #38bdf8;
    }
    .conversion-total-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(148, 163, 184, 0.8);
    }
    .conversion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    .conversion-card {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 16px;
      border: 1px solid rgba(59, 130, 246, 0.15);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .conversion-card h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #bae6fd;
      font-weight: 600;
    }
    .conversion-card p {
      margin: 0;
      color: rgba(148, 163, 184, 0.75);
      font-size: 0.9rem;
    }
    .conversion-table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 0.9rem;
    }
    .conversion-table th,
    .conversion-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(59, 130, 246, 0.18);
    }
    .conversion-table th {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      color: rgba(148, 163, 184, 0.9);
    }
    .conversion-table tbody tr:hover {
      background: rgba(37, 99, 235, 0.12);
    }
    .conversion-empty {
      text-align: center;
      color: rgba(148, 163, 184, 0.7);
      padding: 12px 0;
    }
    .conversion-recent-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .conversion-recent-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(59, 130, 246, 0.18);
    }
    .conversion-recent-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }
    .conversion-recent-header strong {
      font-size: 1rem;
      color: #f8fafc;
    }
    .conversion-recent-header span {
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.8);
    }
    .conversion-recent-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.85);
      word-break: break-word;
    }
    .conversion-recent-meta span strong {
      color: #bae6fd;
      font-weight: 600;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .controls button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0f172a;
      box-shadow: 0 10px 24px rgba(14, 165, 233, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(14, 165, 233, 0.45);
    }
    .controls button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      font-size: 0.95rem;
      color: rgba(148, 163, 184, 0.9);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    thead {
      background: rgba(30, 41, 59, 0.85);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
    }
    th, td {
      padding: 14px 16px;
      vertical-align: top;
      border-bottom: 1px solid rgba(51, 65, 85, 0.6);
    }
    tbody tr:hover {
      background: rgba(30, 41, 59, 0.45);
    }
    .path {
      font-weight: 600;
      color: #f8fafc;
      word-break: break-word;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.1);
      color: rgba(226, 232, 240, 0.9);
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    .referrer-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .referrer-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-left: 2px solid rgba(148, 163, 184, 0.25);
      padding-left: 10px;
    }
    .referrer-item strong {
      font-size: 0.85rem;
      color: #f8fafc;
    }
    .referrer-item span {
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.8);
    }
    .ip-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    details {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: #bae6fd;
      list-style: none;
    }
    details summary::-webkit-details-marker {
      display: none;
    }
    .ip-entry {
      border-left: 2px solid rgba(148, 163, 184, 0.25);
      padding-left: 12px;
    }
    .ip-entry strong {
      font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      color: #f8fafc;
    }
    .ip-entry span {
      display: block;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.85);
    }
    @media (max-width: 900px) {
      header, main {
        padding-left: 16px;
        padding-right: 16px;
      }
      th, td {
        padding: 12px;
      }
      table {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Page View Analytics</h1>
    <p>Unique IP tracking per page with live view counters stored locally in your browser.</p>
  </header>
  <main>
    <section class="panel">
      <div class="controls">
        <div class="status" id="status">Loading page insights…</div>
        <button id="refresh">Refresh now</button>
      </div>
      <table aria-live="polite">
        <thead>
          <tr>
            <th scope="col">Path</th>
            <th scope="col">Views</th>
            <th scope="col">Unique IPs</th>
            <th scope="col">Last Viewed</th>
            <th scope="col">Top Referrers</th>
            <th scope="col">IP Details</th>
          </tr>
        </thead>
        <tbody id="pages-body">
          <tr>
            <td colspan="6" style="text-align:center; padding: 28px; color: rgba(148, 163, 184, 0.75);">Gathering analytics…</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section class="panel">
      <div class="conversion-summary">
        <div>
          <h2>Conversion insights</h2>
          <p>Order confirmations tracked on this device with their original traffic sources.</p>
        </div>
        <div class="conversion-total-wrapper">
          <span class="conversion-total" id="conversion-total">0</span>
          <span class="conversion-total-label">Total conversions</span>
        </div>
      </div>
      <div class="conversion-grid">
        <div class="conversion-card">
          <div>
            <h3>Top sources</h3>
            <p>Unique visitors credited for conversions</p>
          </div>
          <table class="conversion-table">
            <thead>
              <tr>
                <th scope="col">Source</th>
                <th scope="col">Conversions</th>
                <th scope="col">Unique IPs</th>
              </tr>
            </thead>
            <tbody id="conversion-source-body">
              <tr>
                <td colspan="3" class="conversion-empty">No conversions tracked yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="conversion-card">
          <div>
            <h3>Recent conversions</h3>
            <p>Last 10 submissions captured locally</p>
          </div>
          <div id="conversion-recent-list" class="conversion-recent-list">
            <div class="conversion-empty">Awaiting the first conversion.</div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    const STORAGE_KEY = 'PAGE_TRACKER_LOGS';
    const SOURCE_FALLBACK = 'Direct';
    const statusEl = document.getElementById('status');
    const bodyEl = document.getElementById('pages-body');
    const refreshBtn = document.getElementById('refresh');
    const conversionTotalEl = document.getElementById('conversion-total');
    const conversionSourceBody = document.getElementById('conversion-source-body');
    const conversionRecentList = document.getElementById('conversion-recent-list');

    const titleCase = (value) => {
      if (!value) return SOURCE_FALLBACK;
      return value
        .split(/\s+/)
        .filter(Boolean)
        .map((part) => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
        .join(' ');
    };

    const normaliseSource = (value) => {
      if (!value || typeof value !== 'string') {
        return SOURCE_FALLBACK;
      }
      const trimmed = value.trim();
      if (!trimmed) {
        return SOURCE_FALLBACK;
      }
      const lower = trimmed.toLowerCase();
      const preset = {
        direct: SOURCE_FALLBACK,
        internal: 'Internal',
        google: 'Google',
        sellcell: 'SellCell',
        'sellcell.com': 'SellCell',
        facebook: 'Facebook',
        instagram: 'Instagram',
        twitter: 'Twitter',
        linkedin: 'LinkedIn',
        bing: 'Bing',
        yahoo: 'Yahoo',
        duckduckgo: 'DuckDuckGo',
        x: 'X',
      };
      if (preset[lower]) {
        return preset[lower];
      }
      const cleaned = trimmed.replace(/^www\./i, '').replace(/[-_]/g, ' ');
      return titleCase(cleaned);
    };

    const inferSourceFromReferrer = (refUrl) => {
      if (!refUrl || typeof refUrl !== 'string') {
        return SOURCE_FALLBACK;
      }
      try {
        const parsed = new URL(refUrl);
        if (parsed.hostname && parsed.hostname === window.location.hostname) {
          return 'Internal';
        }
        const params = parsed.searchParams;
        const utm = params.get('utm_source') || params.get('source') || params.get('ref');
        if (utm && utm.trim()) {
          return normaliseSource(utm);
        }
        if (parsed.hostname) {
          const host = parsed.hostname.toLowerCase();
          if (host.includes('google')) return 'Google';
          if (host.includes('sellcell')) return 'SellCell';
          if (host.includes('facebook')) return 'Facebook';
          if (host.includes('instagram')) return 'Instagram';
          if (host.includes('twitter') || host === 'x.com') return 'Twitter';
          if (host.includes('linkedin')) return 'LinkedIn';
          if (host.includes('bing')) return 'Bing';
          if (host.includes('yahoo')) return 'Yahoo';
          if (host.includes('duckduckgo')) return 'DuckDuckGo';
          return normaliseSource(host);
        }
      } catch (error) {
        // ignore
      }
      return SOURCE_FALLBACK;
    };

    const safeParse = (raw, fallback) => {
      if (!raw) return fallback;
      try {
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : fallback;
      } catch (error) {
        return fallback;
      }
    };

    const readTrackerData = () => {
      try {
        const raw = window.localStorage.getItem(STORAGE_KEY);
        return safeParse(raw, {
          pages: {},
          visitors: {},
          conversions: [],
          conversionIndex: {},
          lastUpdated: null,
        });
      } catch (error) {
        return { pages: {}, conversions: [], visitors: {}, lastUpdated: null, error: true };
      }
    };

    function formatDate(iso) {
      if (!iso) return '—';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    function prepareRows(data) {
      const pages = data && typeof data === 'object' && data.pages ? data.pages : {};
      const entries = Object.entries(pages);
      return entries
        .map(([path, info]) => {
          const ipStats = info && typeof info === 'object' && info.ipStats ? info.ipStats : {};
          const ipArray = Object.values(ipStats).map((entry) => {
            const firstReferrer = typeof entry.firstReferrer === 'string' ? entry.firstReferrer : '';
            const lastReferrer = typeof entry.lastReferrer === 'string'
              ? entry.lastReferrer
              : (firstReferrer || '');
            const firstSource = normaliseSource(entry.firstSource || inferSourceFromReferrer(firstReferrer));
            const lastSource = normaliseSource(entry.lastSource || inferSourceFromReferrer(lastReferrer) || firstSource);
            return {
              ip: entry.ip || 'Unknown',
              firstSeen: entry.firstSeen || null,
              lastSeen: entry.lastSeen || null,
              lastUrl: entry.lastUrl || '',
              lastTitle: entry.lastTitle || '',
              firstReferrer,
              lastReferrer,
              firstSource,
              lastSource,
            };
          });
          ipArray.sort((a, b) => {
            const aTime = a.lastSeen ? new Date(a.lastSeen).getTime() : 0;
            const bTime = b.lastSeen ? new Date(b.lastSeen).getTime() : 0;
            return bTime - aTime;
          });
          const uniqueCount = info && typeof info.uniqueIpCount === 'number'
            ? info.uniqueIpCount
            : ipArray.length;
          const referrerStats = info && typeof info.referrerStats === 'object' ? info.referrerStats : {};
          const referrers = Object.entries(referrerStats)
            .map(([key, details]) => {
              const count = Number(details && details.count ? details.count : 0);
              const lastSeen = details && details.lastSeen ? details.lastSeen : null;
              const refUrl = details && details.lastReferrer ? details.lastReferrer : (details && details.sampleUrl ? details.sampleUrl : '');
              const source = normaliseSource((details && details.source) || key);
              return {
                source,
                count,
                lastSeen,
                lastReferrer: refUrl,
              };
            })
            .filter((ref) => ref.count > 0)
            .sort((a, b) => {
              if (b.count !== a.count) {
                return b.count - a.count;
              }
              return a.source.localeCompare(b.source);
            });
          return {
            path,
            totalViews: typeof info.totalViews === 'number' ? info.totalViews : ipArray.length,
            uniqueIpCount: uniqueCount,
            lastViewedAt: info.lastViewedAt || null,
            ipStats: ipArray,
            referrers,
          };
        })
        .sort((a, b) => {
          if (b.totalViews !== a.totalViews) {
            return b.totalViews - a.totalViews;
          }
          const aTime = a.lastViewedAt ? new Date(a.lastViewedAt).getTime() : 0;
          const bTime = b.lastViewedAt ? new Date(b.lastViewedAt).getTime() : 0;
          return bTime - aTime;
        });
    }

    function prepareConversionEntries(data) {
      const conversions = Array.isArray(data?.conversions) ? data.conversions : [];
      return conversions.map((entry) => {
        const occurredAtIso = entry && entry.occurredAt ? entry.occurredAt : null;
        const occurredAtMs = occurredAtIso ? Date.parse(occurredAtIso) : NaN;
        return {
          ip: entry && entry.ip ? entry.ip : 'unknown',
          path: entry && entry.path ? entry.path : '/',
          source: normaliseSource(entry && entry.source ? entry.source : SOURCE_FALLBACK),
          referrer: entry && entry.referrer ? entry.referrer : '',
          occurredAt: occurredAtIso,
          occurredAtMs: Number.isNaN(occurredAtMs) ? null : occurredAtMs,
          title: entry && entry.title ? entry.title : '',
          firstPage: entry && entry.firstPage ? entry.firstPage : '',
          landingPage: entry && entry.landingPage ? entry.landingPage : '',
        };
      });
    }

    function summariseConversions(entries) {
      const totalsBySource = new Map();
      entries.forEach((item) => {
        const sourceKey = item && item.source ? item.source : SOURCE_FALLBACK;
        if (!totalsBySource.has(sourceKey)) {
          totalsBySource.set(sourceKey, {
            source: sourceKey,
            conversions: 0,
            uniqueIps: new Set(),
            lastConversionMs: null,
          });
        }
        const record = totalsBySource.get(sourceKey);
        record.conversions += 1;
        if (item && item.ip) {
          record.uniqueIps.add(item.ip);
        }
        if (item && item.occurredAtMs !== null && item.occurredAtMs !== undefined) {
          if (record.lastConversionMs === null || item.occurredAtMs > record.lastConversionMs) {
            record.lastConversionMs = item.occurredAtMs;
          }
        }
      });

      const topSources = Array.from(totalsBySource.values())
        .map((record) => ({
          source: record.source,
          conversions: record.conversions,
          uniqueIps: record.uniqueIps.size,
          lastConversionMs: record.lastConversionMs,
        }))
        .sort((a, b) => {
          if (b.conversions !== a.conversions) {
            return b.conversions - a.conversions;
          }
          return a.source.localeCompare(b.source);
        });

      const recent = entries
        .slice()
        .sort((a, b) => {
          const aTime = a && a.occurredAtMs !== null && a.occurredAtMs !== undefined ? a.occurredAtMs : 0;
          const bTime = b && b.occurredAtMs !== null && b.occurredAtMs !== undefined ? b.occurredAtMs : 0;
          return bTime - aTime;
        })
        .slice(0, 10);

      return {
        total: entries.length,
        topSources,
        recent,
      };
    }

    function renderConversionSources(rows) {
      if (!conversionSourceBody) {
        return;
      }
      conversionSourceBody.innerHTML = '';
      if (!Array.isArray(rows) || !rows.length) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 3;
        emptyCell.className = 'conversion-empty';
        emptyCell.textContent = 'No conversions tracked yet.';
        emptyRow.appendChild(emptyCell);
        conversionSourceBody.appendChild(emptyRow);
        return;
      }
      rows.forEach((row) => {
        const tr = document.createElement('tr');
        const sourceCell = document.createElement('td');
        sourceCell.textContent = row && row.source ? row.source : SOURCE_FALLBACK;
        const conversionsCell = document.createElement('td');
        const conversionsValue = row && Number.isFinite(row.conversions) ? row.conversions : 0;
        conversionsCell.textContent = conversionsValue.toLocaleString();
        const uniquesCell = document.createElement('td');
        const uniqueValue = row && Number.isFinite(row.uniqueIps) ? row.uniqueIps : 0;
        uniquesCell.textContent = uniqueValue.toLocaleString();
        tr.appendChild(sourceCell);
        tr.appendChild(conversionsCell);
        tr.appendChild(uniquesCell);
        conversionSourceBody.appendChild(tr);
      });
    }

    function renderConversionRecent(list) {
      if (!conversionRecentList) {
        return;
      }
      conversionRecentList.innerHTML = '';
      if (!Array.isArray(list) || !list.length) {
        const empty = document.createElement('div');
        empty.className = 'conversion-empty';
        empty.textContent = 'No conversions tracked yet.';
        conversionRecentList.appendChild(empty);
        return;
      }
      list.forEach((item) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'conversion-recent-item';
        const header = document.createElement('div');
        header.className = 'conversion-recent-header';
        const sourceLabel = document.createElement('strong');
        sourceLabel.textContent = item && item.source ? item.source : SOURCE_FALLBACK;
        const timeLabel = document.createElement('span');
        timeLabel.textContent = formatDate(item && item.occurredAt ? item.occurredAt : null);
        header.appendChild(sourceLabel);
        header.appendChild(timeLabel);
        const meta = document.createElement('div');
        meta.className = 'conversion-recent-meta';
        const pathLine = document.createElement('span');
        pathLine.textContent = `Path: ${item && item.path ? item.path : '/'}`;
        meta.appendChild(pathLine);
        const ipLine = document.createElement('span');
        ipLine.textContent = `IP: ${item && item.ip ? item.ip : 'unknown'}`;
        meta.appendChild(ipLine);
        if (item && item.firstPage) {
          const landingLine = document.createElement('span');
          landingLine.textContent = `First page: ${item.firstPage}`;
          meta.appendChild(landingLine);
        }
        if (item && item.referrer) {
          const refLine = document.createElement('span');
          refLine.textContent = `Referrer: ${item.referrer}`;
          meta.appendChild(refLine);
        }
        wrapper.appendChild(header);
        wrapper.appendChild(meta);
        conversionRecentList.appendChild(wrapper);
      });
    }

    function renderConversions(summary) {
      if (conversionTotalEl) {
        const totalValue = summary && Number.isFinite(summary.total) ? summary.total : 0;
        conversionTotalEl.textContent = totalValue.toLocaleString();
      }
      renderConversionSources(summary ? summary.topSources : []);
      renderConversionRecent(summary ? summary.recent : []);
    }

    function renderRows(pages) {
      if (!Array.isArray(pages) || !pages.length) {
        bodyEl.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 28px; color: rgba(148, 163, 184, 0.75);">No page views recorded yet.</td></tr>';
        return;
      }
      bodyEl.innerHTML = '';
      for (const page of pages) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="path">${page.path}</td>
          <td><span class="tag">${page.totalViews ?? 0}</span></td>
          <td><span class="tag">${page.uniqueIpCount ?? 0}</span></td>
          <td>${formatDate(page.lastViewedAt)}</td>
          <td></td>
          <td></td>
        `;
        const refCell = row.children[4];
        if (Array.isArray(page.referrers) && page.referrers.length) {
          const refList = document.createElement('div');
          refList.className = 'referrer-list';
          page.referrers.slice(0, 3).forEach((referrer) => {
            const item = document.createElement('div');
            item.className = 'referrer-item';
            const label = document.createElement('strong');
            label.textContent = `${referrer.source || SOURCE_FALLBACK} · ${referrer.count ?? 0}`;
            item.appendChild(label);
            if (referrer.lastReferrer) {
              const urlLine = document.createElement('span');
              urlLine.textContent = referrer.lastReferrer;
              item.appendChild(urlLine);
            }
            if (referrer.lastSeen) {
              const lastSeen = document.createElement('span');
              lastSeen.textContent = `Last seen: ${formatDate(referrer.lastSeen)}`;
              item.appendChild(lastSeen);
            }
            refList.appendChild(item);
          });
          if (page.referrers.length > 3) {
            const more = document.createElement('span');
            more.style.fontSize = '0.8rem';
            more.style.color = 'rgba(148, 163, 184, 0.75)';
            more.textContent = `+${page.referrers.length - 3} more source${page.referrers.length - 3 === 1 ? '' : 's'}`;
            refList.appendChild(more);
          }
          refCell.appendChild(refList);
        } else {
          refCell.innerHTML = '<span style="color: rgba(148, 163, 184, 0.75);">—</span>';
        }

        const detailsCell = row.lastElementChild;
        if (Array.isArray(page.ipStats) && page.ipStats.length) {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = `Show ${page.ipStats.length} IP${page.ipStats.length === 1 ? '' : 's'}`;
          details.appendChild(summary);
          const list = document.createElement('div');
          list.className = 'ip-list';
          for (const entry of page.ipStats) {
            const item = document.createElement('div');
            item.className = 'ip-entry';
            const ip = document.createElement('strong');
            ip.textContent = entry.ip || 'Unknown';
            const first = document.createElement('span');
            first.textContent = `First seen: ${formatDate(entry.firstSeen)}`;
            const last = document.createElement('span');
            last.textContent = `Last seen: ${formatDate(entry.lastSeen)}`;
            const sourceFirst = document.createElement('span');
            sourceFirst.textContent = `First source: ${entry.firstSource || SOURCE_FALLBACK}`;
            const sourceLast = document.createElement('span');
            sourceLast.textContent = `Last source: ${entry.lastSource || entry.firstSource || SOURCE_FALLBACK}`;
            const nodes = [ip, first, last, sourceFirst, sourceLast];
            if (entry.firstReferrer) {
              const refFirst = document.createElement('span');
              refFirst.textContent = `First referrer: ${entry.firstReferrer}`;
              nodes.push(refFirst);
            } else if (entry.lastReferrer) {
              const refLast = document.createElement('span');
              refLast.textContent = `Last referrer: ${entry.lastReferrer}`;
              nodes.push(refLast);
            }
            if (entry.lastTitle) {
              const lastTitle = document.createElement('span');
              lastTitle.textContent = `Last title: ${entry.lastTitle}`;
              nodes.push(lastTitle);
            }
            const lastUrl = document.createElement('span');
            lastUrl.textContent = entry.lastUrl ? `Last URL: ${entry.lastUrl}` : 'Last URL: —';
            nodes.push(lastUrl);
            item.append(...nodes);
            list.appendChild(item);
          }
          details.appendChild(list);
          detailsCell.appendChild(details);
        } else {
          detailsCell.innerHTML = '<span style="color: rgba(148, 163, 184, 0.75);">—</span>';
        }
        bodyEl.appendChild(row);
      }
    }

    function updateStatus(data) {
      if (!data) {
        statusEl.textContent = 'Analytics unavailable';
        return;
      }
      if (data.error) {
        statusEl.textContent = 'Unable to access local storage analytics.';
        return;
      }
      if (!data.lastUpdated) {
        statusEl.textContent = 'Waiting for first page view…';
        return;
      }
      statusEl.textContent = `Updated ${formatDate(data.lastUpdated)}`;
    }

    function loadAnalytics() {
      refreshBtn.disabled = true;
      try {
        const data = readTrackerData();
        updateStatus(data);
        const rows = prepareRows(data);
        renderRows(rows);
        const conversions = prepareConversionEntries(data);
        const summary = summariseConversions(conversions);
        renderConversions(summary);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener('click', loadAnalytics);
    document.addEventListener('DOMContentLoaded', loadAnalytics, { once: true });
    window.addEventListener('page-tracker:updated', (event) => {
      const data = event && event.detail && event.detail.data ? event.detail.data : readTrackerData();
      updateStatus(data);
      const rows = prepareRows(data);
      renderRows(rows);
      const conversions = prepareConversionEntries(data);
      const summary = summariseConversions(conversions);
      renderConversions(summary);
    });
    window.addEventListener('storage', (event) => {
      if (event.key !== STORAGE_KEY) {
        return;
      }
      loadAnalytics();
    });
  </script>
</body>
</html>
