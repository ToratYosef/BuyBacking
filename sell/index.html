<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecondHandCell - Sell Your Device</title>
    <link rel="icon" href="/favicon/favicon.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9evSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google tag (gtag.js) -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <!-- End Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
    <script>
        const runLegacySellFlow = false;
        if (runLegacySellFlow) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-17534255111');
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            doc,
            getDoc,
            setDoc,
            getDocs,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.appspot.com",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateProfile = updateProfile;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.firebaseDb = db;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebase = {
            firestore: {
                doc,
                getDoc,
                collection,
                getDocs,
                setDoc,
                query,
                orderBy,
                limit
            }
        };
    </script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for hidden radio buttons and clickable images */
        .carrier-option input[type="radio"],
        .shipping-option input[type="radio"],
        .payment-option input[type="radio"] {
            display: none;
        }
        .carrier-option label,
        .shipping-option label,
        .payment-option label {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .carrier-option input[type="radio"]:checked + label,
        .shipping-option input[type="radio"]:checked + label,
        .payment-option input[type="radio"]:checked + label {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
            transform: scale(1.02);
            background-color: #e0e7ff;
        }
        .carrier-option label:hover,
        .shipping-option label:hover,
        .payment-option label:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        #quoteModal {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s ease-out;
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
        }
        #quoteModal.is-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        .custom-checkbox input[type="checkbox"] {
            display: none;
        }
        .custom-checkbox .checkmark {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #94a3b8;
            border-radius: 0.25rem;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0.5rem;
            height: 1rem;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: translate(-50%, -60%) rotate(45deg);
        }
        .btn-primary-blue {
            background-color: #2563eb;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-blue:hover {
            background-color: #1d4ed8;
            transform: scale(1.05);
        }
        .btn-primary-blue:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.5);
        }
        .btn-secondary-green {
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-secondary-green:hover {
            background-color: #16a34a;
            transform: scale(1.05);
        }
        .btn-secondary-green:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.5);
        }
        
        .btn-primary-indigo {
            background-color: #4f46e5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-indigo:hover {
            background-color: #4338ca;
            transform: scale(1.05);
        }
        .btn-primary-indigo:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #94a3b8 !important;
            box-shadow: none;
            transform: none;
        }
        /* Mobile-first adjustments for layout and typography */
        @media (max-width: 1023px) {
            .main-content-layout {
                flex-direction: column;
            }
            .quote-display-mobile-first {
                order: -1;
                margin-bottom: 2rem;
            }
            .main-content-layout > div:nth-child(1) {
                margin-top: 2rem;
            }
            .text-4xl {
                font-size: 2.25rem;
            }
            .text-3xl {
                font-size: 1.875rem;
            }
            .text-lg {
                font-size: 1rem;
            }
            .question-group {
                padding: 0.75rem;
            }
            .carrier-option label,
            .shipping-option label,
            .payment-option label {
                padding: 0.75rem;
            }
            .h-10.w-10 {
                height: 2rem;
                width: 2rem;
            }
            .text-4xl {
                font-size: 2rem;
            }
            .text-3xl {
                font-size: 1.75rem;
            }
            .btn-primary-blue,
            .btn-secondary-green,
            .btn-primary-indigo {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .modal-content .text-5xl {
                font-size: 3rem;
            }
            /* Specific mobile adjustments for scrollable content modals */
            #fullyFunctionalModal .modal-content-scroll,
            #privacyPolicyModal .modal-content-scroll,
            #termsAndConditionsModal .modal-content-scroll {
                max-width: 95%; /* Make it wide on small screens */
                width: 95%;
                padding: 1.5rem;
            }
            #fullyFunctionalModal .prose p, 
            #fullyFunctionalModal .prose ul,
            #fullyFunctionalModal .prose li {
                font-size: 0.8rem; /* Smaller font on mobile */
            }
            #fullyFunctionalModal .prose h2 {
                font-size: 1.25rem;
            }
            #fullyFunctionalModal .prose h3 {
                font-size: 1rem;
            }
        }
        /* Desktop-specific layout rules */
        @media (min-width: 1024px) {
            .lg\:text-left .question-group .flex {
                justify-content: flex-start;
            }
            .quote-display-mobile-first {
                order: unset;
            }
        }
        .highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .carrier-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .shipping-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .payment-option input[type="radio"]:not(:checked) + label.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .custom-checkbox input[type="checkbox"]:not(:checked) + .checkmark.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        /* Style for required select dropdown */
        #state:required:invalid:not(:focus) {
            color: #64748b; /* slate-500 for unselected placeholder text */
        }
        #state.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }

        /* --- STYLES FROM SECONDHANDCELL --- */
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; /* blue-100, blue-700 */
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        /* NEW: General modal structure for scrollable content */
        .modal-content-scroll {
            max-height: 90vh; /* Set a max height for the modal box itself */
            display: flex;
            flex-direction: column;
        }
        /* NEW: Style for the scrollable body of the content */
        .modal-content-body {
            overflow-y: auto;
            padding-right: 0.5rem; /* Space for the scrollbar */
        }

        .payment-panel {
            max-width: 48rem;
        }

        .payment-panel:focus {
            outline: 3px solid #c7d2fe;
            outline-offset: 4px;
        }

        @media (max-width: 640px) {
            .payment-panel {
                padding: 1.25rem;
                border-radius: 1.25rem;
            }
        }

        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }
        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }
        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }
        .prose {
            max-width: 65ch;
            color: #334155; /* slate-700 */
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
                margin-bottom: 0.5em;
        }
        /* Specific styling for the Fully Functional Modal content (smaller font, scrolling) */
        #fullyFunctionalModal .prose p, 
        #fullyFunctionalModal .prose ul,
        #fullyFunctionalModal .prose li {
            font-size: 0.9rem; /* Slightly smaller text for info density */
        }
        #fullyFunctionalModal .prose h3 {
            font-size: 1.1rem;
        }
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            height: 200px;
        }

        :root {
            --brand-primary: #15803d;
            --brand-secondary: #eab308;
            --brand-gradient: linear-gradient(135deg, #15803d 0%, #eab308 100%);
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-gray: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        .sell-app-wrapper { font-family: 'Inter', -apple-system, sans-serif; color: var(--text-main); line-height: 1.5; padding: 40px 0; }
        .hidden { display: none !important; }

        .app-container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .step-title { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 30px; }

        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .select-card {
            background: var(--white); border: 2px solid var(--border); border-radius: 12px;
            padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-card:hover { border-color: var(--brand-secondary); transform: translateY(-2px); }
        .select-card.active { border-color: var(--brand-primary); background: #f0fdf4; color: var(--brand-primary); box-shadow: 0 0 0 1px var(--brand-primary); }

        .breadcrumbs { display: flex; gap: 8px; margin-bottom: 30px; font-size: 13px; justify-content: center; flex-wrap: wrap; }
        .crumb {
            padding: 8px 16px; background: #e5e7eb; border-radius: 20px;
            transition: all 0.2s; position: relative; font-weight: 600; color: var(--text-muted);
            cursor: default;
        }

        .crumb.can-jump { cursor: pointer; }
        .crumb.can-jump:hover::after {
            content: "Take me to this step";
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 2px 8px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; z-index: 10;
        }

        .crumb.active { background: var(--brand-primary); color: white; cursor: default; }
        .crumb.filled { background: #dcfce7; color: var(--brand-primary); border: 1px solid var(--brand-primary); }

        .offer-card { background: var(--white); border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .price-val { font-size: 64px; font-weight: 900; margin: 5px 0; color: var(--text-main); }

        .req-box { text-align: left; max-width: 500px; margin: 20px auto; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

        .form-control { width: 100%; max-width: 400px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 16px; outline: none; }
        .btn-primary {
            width: 100%; max-width: 400px; padding: 18px; background: var(--brand-gradient);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }

        @media (max-width: 600px) {
            .selection-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
    <link rel="stylesheet" href="/assets/css/site-chrome.css">
</head>
<body class="bg-slate-50">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- Site Header -->
<header class="site-header" data-site-header>
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link" aria-label="SecondHandCell home">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320" height="320" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav" aria-label="Account navigation">
            <div id="authStatusContainer" class="site-header__auth-wrapper">
                <a href="#" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden"></div>
                <div id="authDropdown" class="auth-dropdown hidden">
                    <a href="/my-account.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Account</a>
                    <a href="/track-order.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Track an Order</a>
                    <button id="logoutBtn" class="btn-red-logout">Logout</button>
                </div>
            </div>
        </nav>
    </div>
</header>
<section class="ship48-banner" data-ship48-banner hidden>
    <div class="ship48-banner__inner">
        <p class="ship48-banner__message" title="Email label orders sent within 48 hours get +$10 with SHIP48 when you send within 48h.">
            <strong>SHIP48</strong> Email label orders sent within 48h earn +$10 with code <span class="ship48-banner__code">SHIP48</span>. Email label only. <span class="ship48-banner__counter" data-ship48-counter></span>
            <span class="ship48-banner__status" data-ship48-status></span>
        </p>
        <div class="ship48-banner__actions">
            <button type="button" class="ship48-banner__apply" data-ship48-apply>Apply SHIP48</button>
            <button type="button" class="ship48-banner__start" data-ship48-start>Start my quote now</button>
        </div>
    </div>
    <button type="button" class="ship48-banner__dismiss" aria-label="Dismiss Ship48 promo" data-ship48-dismiss>&times;</button>
</section>

    <main class="sell-app-wrapper">
        <div class="app-container" id="selection-flow">
            <div class="breadcrumbs" id="crumbs"></div>

            <h2 class="step-title" id="step-name">Select Brand</h2>
            <div class="selection-grid" id="grid-content"></div>
        </div>

        <div class="app-container hidden" id="offer-view">
            <div class="breadcrumbs" id="final-crumbs"></div>

            <div class="offer-card">
                <h2 id="final-device-name" style="margin-bottom:5px;">--</h2>
                <div id="summary-tags" style="font-size: 12px; color: var(--brand-primary); font-weight: 700; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.5px;">
                </div>

                <div class="selection-grid" id="final-condition-grid" style="margin-bottom: 25px;">
                </div>

                <div style="font-size: 14px; font-weight: 600; color: var(--text-muted);">Instant Payout:</div>
                <div class="price-val" id="final-price">$0</div>

                <div class="req-box">
                    <div style="font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span id="condition-title-display">--</span> Requirements:
                    </div>
                    <ul id="condition-details" style="padding-left: 20px; font-size: 14px; color: var(--text-muted);">
                    </ul>
                </div>

                <input type="email" id="user-email" class="form-control" placeholder="Enter your email address">
                <button class="btn-primary" onclick="handleCheckout()">GET PAID INSTANTLY</button>
                <p style="margin-top: 20px;"><a href="#" onclick="resetFlow()" style="color: var(--brand-primary); font-size: 13px; font-weight: 700; text-decoration: none;">‚Üê Start New Trade-in</a></p>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="qty-modal">
        <div class="modal-card">
            <h3>Quantity</h3>
            <p>How many devices are you selling?</p>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin:20px;">
                <button onclick="changeQty(-1)" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--brand-primary); background:none; font-size: 20px; color: var(--brand-primary); cursor:pointer;">-</button>
                <span id="qty-val" style="font-size:32px; font-weight:800;">1</span>
                <button onclick="changeQty(1)" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--brand-primary); background:none; font-size: 20px; color: var(--brand-primary); cursor:pointer;">+</button>
            </div>
            <button class="btn-primary" onclick="finalSubmit()">CONTINUE TO CHECKOUT</button>
        </div>
    </div>
    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="index.html" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated </h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <!-- Red Banner Box -->
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
                <p class="text-lg font-bold">IMPORTANT NOTICE</p>
                <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
            </div>
                        <!-- Trust & accreditation badges -->
            <div class="mt-8">
                <div class="flex flex-wrap items-center justify-center gap-6 sm:flex-row sm:justify-center sm:gap-8 lg:justify-start">
                    <a href="https://www.sellcell.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" width="150" height="107" alt="SellCell Accredited Buyer" loading="lazy" class="h-20 w-auto object-contain">
                    </a>
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://cdn.trustpilot.net/brand-assets/4.1.0/stars/stars-5.png" alt="Trustpilot 5 star rating" loading="lazy" class="h-12 w-auto object-contain">
                    </a>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <script>
        /*
        // --- STATE DATA AND VALIDATION ---
        const US_STATES = [
            { name: "Alabama", code: "AL" }, { name: "Alaska", code: "AK" }, { name: "Arizona", code: "AZ" }, { name: "Arkansas", code: "AR" },
            { name: "California", code: "CA" }, { name: "Colorado", code: "CO" }, { name: "Connecticut", code: "CT" }, { name: "Delaware", code: "DE" },
            { name: "Florida", code: "FL" }, { name: "Georgia", code: "GA" }, { name: "Hawaii", code: "HI" }, { name: "Idaho", code: "ID" },
            { name: "Illinois", code: "IL" }, { name: "Indiana", code: "IN" }, { name: "Iowa", code: "IA" }, { name: "Kansas", code: "KS" },
            { name: "Kentucky", code: "KY" }, { name: "Louisiana", code: "LA" }, { name: "Maine", code: "ME" }, { name: "Maryland", code: "MD" },
            { name: "Massachusetts", code: "MA" }, { name: "Michigan", code: "MI" }, { name: "Minnesota", code: "MN" }, { name: "Mississippi", code: "MS" },
            { name: "Missouri", code: "MO" }, { name: "Montana", code: "MT" }, { name: "Nebraska", code: "NE" }, { name: "Nevada", code: "NV" },
            { name: "New Hampshire", code: "NH" }, { name: "New Jersey", code: "NJ" }, { name: "New Mexico", code: "NM" }, { name: "New York", code: "NY" },
            { name: "North Carolina", code: "NC" }, { name: "North Dakota", code: "ND" }, { name: "Ohio", code: "OH" }, { name: "Oklahoma", code: "OK" },
            { name: "Oregon", code: "OR" }, { name: "Pennsylvania", code: "PA" }, { name: "Rhode Island", code: "RI" }, { name: "South Carolina", code: "SC" },
            { name: "South Dakota", code: "SD" }, { name: "Tennessee", code: "TN" }, { name: "Texas", code: "TX" }, { name: "Utah", code: "UT" },
            { name: "Vermont", code: "VT" }, { name: "Virginia", code: "VA" }, { name: "Washington", code: "WA" }, { name: "West Virginia", code: "WV" },
            { name: "Wisconsin", code: "WI" }, { name: "Wyoming", code: "WY" }
        ];
        
        const AUTH_ERROR_MESSAGES = {
            'invalid-credential': 'The email or password you entered is incorrect.',
            'wrong-password': 'The email or password you entered is incorrect.',
            'user-not-found': "We couldn't find an account with that email address.",
            'invalid-email': 'Please enter a valid email address.',
            'missing-email': 'Please enter your email address.',
            'email-already-in-use': 'An account with this email already exists. Try logging in instead.',
            'weak-password': 'Your password must be at least 6 characters.',
            'popup-closed-by-user': 'The sign-in popup was closed before you finished. Please try again.',
            'popup-blocked': 'Your browser blocked the sign-in popup. Please allow popups and try again.',
            'network-request-failed': "We couldn't reach the server. Check your internet connection and try again.",
            'too-many-requests': 'Too many attempts have been made. Please wait a moment and try again.',
            'user-disabled': 'This account has been disabled. Contact our support team for assistance.'
        };

        function extractAuthCode(error) {
            if (!error) return null;
            if (typeof error.code === 'string') {
                return error.code.startsWith('auth/') ? error.code.slice(5) : error.code;
            }
            if (typeof error.message === 'string') {
                const match = error.message.match(/auth\/([^)]+)/);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        function formatAuthCodeToSentence(code) {
            if (!code) return '';
            const cleaned = code.replace(/-/g, ' ');
            return cleaned.charAt(0).toUpperCase() + cleaned.slice(1) + '.';
        }

        function getAuthErrorMessage(actionDescription, error) {
            const fallback = `We couldn't ${actionDescription}. Please try again.`;
            const code = extractAuthCode(error);
            if (!code) {
                return fallback;
            }
            const normalizedCode = code.toLowerCase();
            const friendly = AUTH_ERROR_MESSAGES[normalizedCode];
            if (friendly) {
                return `We couldn't ${actionDescription}. ${friendly}`;
            }
            return `We couldn't ${actionDescription}. ${formatAuthCodeToSentence(normalizedCode)}`;
        }

        // NEW: Function to populate the <select> element
        function populateStateSelect() {
            const selectElement = document.getElementById('state');
            if (!selectElement) return;
            
            const fragment = document.createDocumentFragment();

            US_STATES.forEach(state => {
                const option = document.createElement('option');
                // Value is the short code for easy order processing
                option.value = state.code;
                // Text includes both name and code for user convenience
                option.textContent = `${state.name} (${state.code})`;
                fragment.appendChild(option);
            });
            selectElement.appendChild(fragment);
        }

        // NEW: Function to extract brand and slug from a single URL parameter
        function getBrandAndSlug(param) {
            if (!param || typeof param !== 'string') return null;
            const parts = param.split('-');
            // Define supported brands for Firestore subcollection lookup
            const brands = ['iphone', 'samsung', 'google', 'ipad'];
            const brand = parts[0];
            
            if (brands.includes(brand) && parts.length > 1) {
                return {
                    brand: brand,
                    slug: parts.slice(1).join('-') // Rejoin the rest of the parts as the slug
                };
            }
            // If the brand is missing or unrecognized, or if there's no slug part, return null
            return null;
        }

        // Global variable to hold the autocomplete instance
        let autocomplete;

        // This function is called by the Google Maps script when it has loaded.
        function initAutocomplete() {
            // Get the input element
            const streetAddressInput = document.getElementById('street-address');
            
            // Create the autocomplete object, restricting the search to geographical location types.
            autocomplete = new google.maps.places.Autocomplete(streetAddressInput, {
                types: ['address'],
                componentRestrictions: { country: 'us' } // Restrict to US addresses
            });

            // When the user selects an address from the dropdown, populate the address fields in the form.
            autocomplete.addListener('place_changed', fillInAddress);
        }

        function fillInAddress() {
            // Get the place details from the autocomplete object.
            const place = autocomplete.getPlace();

            if (!place || !place.address_components) {
                console.warn("Autocomplete's returned place contains no address components");
                return;
            }

            // Get each component of the address from the place details,
            // and then fill-in the corresponding field on the form.
            const streetAddressInput = document.getElementById('street-address');
            const addressUnitInput = document.getElementById('address-unit');
            const buildingNameInput = document.getElementById('building-name');
            const floorNumberInput = document.getElementById('floor-number');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipCodeInput = document.getElementById('zip-code');

            // Clear out the fields first
            streetAddressInput.value = '';
            if (addressUnitInput) addressUnitInput.value = '';
            if (buildingNameInput) buildingNameInput.value = '';
            if (floorNumberInput) floorNumberInput.value = '';
            cityInput.value = '';
            stateInput.value = '';
            zipCodeInput.value = '';

            let streetNumber = '';
            let route = '';

            for (const component of place.address_components) {
                const componentType = component.types[0];

                switch (componentType) {
                    case 'street_number':
                        streetNumber = component.long_name;
                        break;
                    case 'route':
                        route = component.short_name;
                        break;
                    case 'locality':
                        cityInput.value = component.long_name;
                        break;
                    case 'administrative_area_level_1':
                        // Use the short name (two-letter code) for the state input
                        stateInput.value = component.short_name;
                        break;
                    case 'postal_code':
                        zipCodeInput.value = component.long_name;
                        break;
                }
            }
            
            streetAddressInput.value = `${streetNumber} ${route}`.trim();

            // Manually trigger an input event on each field to let other scripts know they've changed
            const event = new Event('input', { bubbles: true });
            streetAddressInput.dispatchEvent(event);
            cityInput.dispatchEvent(event);
            stateInput.dispatchEvent(event);
            zipCodeInput.dispatchEvent(event);
        }
        
        let device = null;
        let deviceInfo = null; // Declare globally to hold parsed info

        document.addEventListener('DOMContentLoaded', async function() {
            // --- UPDATED: Populate the state select on load ---
            populateStateSelect();
            
            // --- NEW: Add event listener for real-time phone formatting ---
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', () => formatPhoneNumber(phoneInput));
                // Set the max length to 14 characters: "(555) 555-5555"
                phoneInput.maxLength = 14;
            }
            // --- END NEW PHONE FORMATTING LISTENER ---


            const auth = window.firebaseAuth;
            const GoogleAuthProvider = window.GoogleAuthProvider;
            const signInWithPopup = window.signInWithPopup;
            const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
            const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
            const signOut = window.signOut;
            const onAuthStateChanged = window.onAuthStateChanged;
            const updateProfile = window.updateProfile;
            const sendPasswordResetEmail = window.sendPasswordResetEmail;
            const db = window.firebaseDb;
            const { doc, getDoc, collection, getDocs, setDoc, query, orderBy, limit } = window.firebase.firestore;
            const serverTimestamp = window.firebaseServerTimestamp;

            // --- DYNAMIC CONTENT SETUP ---
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionContainer = document.getElementById('questionContainer');
            const errorDisplay = document.getElementById('errorDisplay');
            
            // --- NEW ELEMENTS ---
            const functionalDetailsLink = document.getElementById('functionalDetailsLink');
            const fullyFunctionalModal = document.getElementById('fullyFunctionalModal');


            // Get device parameter from the URL query string
            const urlParams = new URLSearchParams(window.location.search);
            // This is the combined parameter (e.g., 'iphone-15-pro')
            const deviceParam = urlParams.get('device'); 
            
            // The following parameters are kept for compatibility with the old link format
            // which might still pass them, but they are generally ignored if deviceParam is used
            const storageParam = urlParams.get('storage');
            const carrierParam = urlParams.get('carrier');
            const powerParam = urlParams.get('power');
            const functionalityParam = urlParams.get('functionality');
            const qualityParam = urlParams.get('quality');
            const priceParam = urlParams.get('price');
            
            // Use the new robust parsing logic
            deviceInfo = getBrandAndSlug(deviceParam);

            // Log the URL parameters for debugging
            console.log('URL Parameters:', {
                deviceParam: deviceParam,
                parsedInfo: deviceInfo,
                storage: storageParam,
                carrier: carrierParam,
                //... rest of params
            });

            // Validate required parameters: We only need a successfully parsed brand and slug
            if (!deviceInfo || !deviceInfo.brand || !deviceInfo.slug) {
                loadingIndicator.classList.add('hidden');
                errorDisplay.classList.remove('hidden');
                console.error("Missing required parameters (device=brand-slug) or invalid URL format.");
                return;
            }

            // Populate remaining properties for initial form state loading if provided in URL (old behavior)
            deviceInfo.storage = storageParam;
            deviceInfo.carrier = carrierParam;
            deviceInfo.power = powerParam;
            deviceInfo.functionality = functionalityParam;
            deviceInfo.quality = qualityParam;
            deviceInfo.estimatedPrice = priceParam;

            async function fetchDevicePricing(brand, slug) {
                try {
                    // Use the parsed brand and slug for the Firestore path
                    const docRef = doc(db, `devices/${brand}/models`, slug);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        console.error(`Device data for slug "${slug}" not found in brand "${brand}".`);
                        return null;
                    }
                } catch (error) {
                    console.error("Error fetching document:", error);
                    return null;
                }
            }
            
            device = await fetchDevicePricing(deviceInfo.brand, deviceInfo.slug);
            
            if (!device) {
                loadingIndicator.classList.add('hidden');
                errorDisplay.classList.remove('hidden');
                // Update error message for clarity based on new structure
                document.querySelector('#errorDisplay p:nth-child(2)').textContent = 'Error: Device data not found.';
                return;
            }

            loadingIndicator.classList.add('hidden');
            questionContainer.classList.remove('hidden');

            document.title = `SecondHandCell - Sell ${device.name}`;
            
            // --- IMAGE LOADING LOGIC ---
            function loadImageWithFallback(imgElement) {
                const baseSrc = device.imageUrl; // Use the image URL retrieved from Firestore
                if (!baseSrc) {
                     imgElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
                     return;
                }
                // Use data-base-src to test extensions, but for single-file systems, direct set is cleaner
                // However, since the function uses new Image() and load/error, we keep it this way
                imgElement.dataset.baseSrc = baseSrc; 
                
                const extensions = ['.webp', '.avif', '.png', '.jpeg', '.jpg'];
                let current = 0;
                function tryLoad() {
                    if (current >= extensions.length) {
                        imgElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
                        return;
                    }
                    const testSrc = baseSrc + extensions[current];
                    const img = new Image();
                    img.onload = () => { imgElement.src = testSrc; };
                    img.onerror = () => { current++; tryLoad(); };
                    img.src = testSrc;
                }
                // Call the loading function only if a base URL is provided by Firestore
                tryLoad();
            }

            // Find the device image element
            const deviceImageElement = document.getElementById('deviceImage');
            if (deviceImageElement && device.imageUrl) {
                loadImageWithFallback(deviceImageElement);
            } else {
                deviceImageElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
            }
            
            document.getElementById('deviceImage').alt = device.name;
            document.getElementById('deviceDisplayName').textContent = device.name;
            document.getElementById('deviceDisplayNameText').textContent = device.name;
            document.getElementById('overviewDevice').textContent = device.name;

            const storageSelect = document.getElementById('storage');
            const fragment = document.createDocumentFragment();
            // Use the fetched device data to populate the storage options
            for (const storage in device.prices) {
                const option = document.createElement('option');
                option.value = storage;
                option.textContent = storage;
                fragment.appendChild(option);
            }
            storageSelect.innerHTML = '<option value="">Select Storage</option>';
            storageSelect.appendChild(fragment);
            
            const hasUrlPrefill = Boolean(deviceInfo.storage || deviceInfo.carrier || deviceInfo.power || deviceInfo.functionality || deviceInfo.quality);

            if (hasUrlPrefill) {
                console.log('Applying URL parameter prefill...', deviceInfo);

                setTimeout(() => {
                    const carrierSection = document.getElementById('carrierSection');
                    const powerOnSection = document.getElementById('powerOnSection');
                    const functionalSection = document.getElementById('functionalSection');
                    const cracksSection = document.getElementById('cracksSection');
                    const cosmeticSection = document.getElementById('cosmeticSection');
                    const getQuoteBtn = document.getElementById('getQuoteBtn');

                    const carrierMapping = {
                        unlocked: 'unlocked',
                        verizon: 'verizon',
                        att: 'att',
                        tmobile: 'tmobile'
                    };

                    const carrierParam = typeof deviceInfo.carrier === 'string' ? deviceInfo.carrier.toLowerCase() : '';
                    const qualityValue = typeof deviceInfo.quality === 'string' ? deviceInfo.quality.toLowerCase() : '';

                    const storageOptionExists = deviceInfo.storage
                        ? Array.from(storageSelect.options).some(option => option.value === deviceInfo.storage)
                        : false;

                    if (deviceInfo.storage && storageOptionExists) {
                        storageSelect.value = deviceInfo.storage;
                        if (carrierSection) carrierSection.classList.remove('hidden');
                    } else if (carrierSection && (deviceInfo.carrier || deviceInfo.power || deviceInfo.functionality || deviceInfo.quality)) {
                        carrierSection.classList.remove('hidden');
                    }

                    let carrierSelected = false;
                    if (carrierParam) {
                        const normalizedCarrier = carrierMapping[carrierParam] || carrierParam;
                        const carrierRadio = document.querySelector(`input[name="carrier"][value="${carrierParam}"]`) ||
                            document.querySelector(`input[name="carrier"][value="${normalizedCarrier}"]`) ||
                            document.getElementById(normalizedCarrier);

                        if (carrierRadio) {
                            carrierRadio.checked = true;
                            carrierSelected = true;
                        }

                        if (carrierSection) {
                            carrierSection.classList.remove('hidden');
                        }
                    }

                    if (powerOnSection && (carrierSelected || deviceInfo.power || storageOptionExists)) {
                        powerOnSection.classList.remove('hidden');
                    }

                    let powerSelected = '';
                    if (deviceInfo.power) {
                        const powerValue = deviceInfo.power.toLowerCase();
                        const powerRadio = document.querySelector(`input[name="q1_power_on"][value="${powerValue}"]`);
                        if (powerRadio) {
                            powerRadio.checked = true;
                            powerSelected = powerValue;
                        }
                    }

                    if (!powerSelected) {
                        powerSelected = document.querySelector('input[name="q1_power_on"]:checked')?.value || '';
                    }

                    if (powerSelected === 'yes') {
                        if (functionalSection) {
                            functionalSection.classList.remove('hidden');
                        }

                        let functionalSelected = '';
                        if (deviceInfo.functionality) {
                            const functionalValue = deviceInfo.functionality === 'working' ? 'yes' : 'no';
                            const functionalRadio = document.querySelector(`input[name="q2_fully_functional"][value="${functionalValue}"]`);
                            if (functionalRadio) {
                                functionalRadio.checked = true;
                                functionalSelected = functionalValue;
                            }
                        }

                        if (!functionalSelected) {
                            functionalSelected = document.querySelector('input[name="q2_fully_functional"]:checked')?.value || '';
                        }

                        if (functionalSelected === 'yes') {
                            if (cracksSection) {
                                cracksSection.classList.remove('hidden');
                            }

                            if (qualityValue) {
                                const cracksValue = ['damaged', 'broken', 'cracked'].includes(qualityValue) ? 'no' : 'yes'; // "cracked" kept for legacy URLs
                                const cracksRadio = document.querySelector(`input[name="q3_no_cracks"][value="${cracksValue}"]`);
                                if (cracksRadio) {
                                    cracksRadio.checked = true;
                                }

                                if (cracksValue === 'yes') {
                                    if (cosmeticSection) {
                                        cosmeticSection.classList.remove('hidden');
                                    }

                                    const cosmeticMapping = {
                                        flawless: 'flawless',
                                        mint: 'flawless',
                                        new: 'flawless',
                                        pristine: 'flawless',
                                        good: 'good',
                                        great: 'good',
                                        excellent: 'good',
                                        gentlyused: 'good',
                                        scratched: 'good',
                                        fair: 'fair',
                                        average: 'fair',
                                        used: 'fair',
                                        worn: 'fair',
                                        damaged: 'damaged',
                                        cracked: 'damaged' // legacy quality option maps to damaged
                                    };

                                    const cosmeticValue = cosmeticMapping[qualityValue] || 'fair';
                                    const cosmeticRadio = document.querySelector(`input[name="q4_cosmetic_condition"][value="${cosmeticValue}"]`);
                                    if (cosmeticRadio) {
                                        cosmeticRadio.checked = true;
                                    }
                                } else if (cosmeticSection) {
                                    cosmeticSection.classList.add('hidden');
                                }
                            }
                        } else if (functionalSelected === 'no') {
                            if (cracksSection) {
                                cracksSection.classList.add('hidden');
                            }
                            if (cosmeticSection) {
                                cosmeticSection.classList.add('hidden');
                            }
                        }
                    } else if (powerSelected === 'no') {
                        if (functionalSection) {
                            functionalSection.classList.add('hidden');
                        }
                        if (cracksSection) {
                            cracksSection.classList.add('hidden');
                        }
                        if (cosmeticSection) {
                            cosmeticSection.classList.add('hidden');
                        }
                    }

                    const selectedStorage = document.getElementById('storage').value;
                    const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                    const selectedPower = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                    const selectedFunctional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                    const selectedCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                    const selectedCosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                    let hasAllAnswers = false;
                    if (selectedStorage && selectedCarrier && selectedPower) {
                        if (selectedPower === 'no') {
                            hasAllAnswers = true;
                        } else if (selectedFunctional) {
                            if (selectedFunctional === 'no') {
                                hasAllAnswers = true;
                            } else if (selectedCracks) {
                                if (selectedCracks === 'no') {
                                    hasAllAnswers = true;
                                } else if (selectedCosmetic) {
                                    hasAllAnswers = true;
                                }
                            }
                        }
                    }

                    if (hasAllAnswers && getQuoteBtn) {
                        getQuoteBtn.classList.remove('hidden');
                        setTimeout(() => {
                            getQuoteBtn.click();
                        }, 100);
                    }
                }, 100);
            }
            
            // --- REST OF THE CODE ---
            const getQuoteBtn = document.getElementById('getQuoteBtn');
            const quoteMessage = document.getElementById('quoteMessage');
            const nextSteps = document.getElementById('nextSteps');
            const finalQuoteAmountMainDisplay = document.getElementById('mainQuoteDisplay');
            const finalQuoteAmountMainText = document.getElementById('finalQuoteAmountMain');
            const finalQuoteAmountPopup = document.getElementById('finalQuoteAmountPopup');
            const quoteModalOfferContent = document.getElementById('quoteModalOfferContent');
            const quoteModalNoOfferContent = document.getElementById('quoteModalNoOfferContent');
            const shippingOptions = document.getElementById('shippingOptions');
            const overviewShippingPreference = document.getElementById('overviewShippingPreference');
            const overviewCarrier = document.getElementById('overviewCarrier');
            const overviewQuote = document.getElementById('overviewQuote');
            const overviewAddress = document.getElementById('overviewAddress');
            // NEW: Reference to Phone overview element
            const overviewPhone = document.getElementById('overviewPhone'); 
            const sendPhoneBtn = document.getElementById('sendPhoneBtn');
            const loginModal = document.getElementById('loginModal');
            // Using a more specific selector for the close button to avoid conflicts
            const closeLoginModalBtn = loginModal.querySelector('.close-modal-btn');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const signupTabBtn = document.getElementById('signupTabBtn');
            const guestCheckoutBtn = document.getElementById('guestCheckoutBtn');
            const loginNavBtn = document.getElementById('loginNavBtn');
            const quoteModal = document.getElementById('quoteModal');
            const quoteModalContinueBtn = document.getElementById('quoteModalContinueBtn');
            const authStatusContainer = document.getElementById('authStatusContainer');
            const userMonogram = document.getElementById('userMonogram');
            const authDropdown = document.getElementById('authDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const cosmeticConditionDescription = document.getElementById('cosmeticConditionDescription');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const emailSignupBtn = document.getElementById('emailSignupBtn');
            const signupNameInput = document.getElementById('signupName');
            const signupEmailInput = document.getElementById('signupEmail');
            const signupPasswordInput = document.getElementById('signupPassword');
            // Assuming signupPhone is not in the new modal, this will be null and should be handled.
            const signupPhoneInput = document.getElementById('signupPhone');
            const authMessage = document.getElementById('authMessage');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const switchToLogin = document.getElementById('switchToLogin');
            
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const forgotEmailInput = document.getElementById('forgotEmail');
            const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
            const returnToLoginLink = document.getElementById('returnToLogin');
            
            const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
            const footerPromoEmailInput = document.getElementById('footerPromoEmail');
            const footerSignupMessage = document.getElementById('footerSignupMessage');

            const fullNameInput = document.getElementById('fullName');
            const shippingInfoEmailInput = document.getElementById('email');
            // const phoneInput = document.getElementById('phone'); // Already defined above

            const streetAddressInput = document.getElementById('street-address');
            const addressUnitInput = document.getElementById('address-unit');
            const buildingNameInput = document.getElementById('building-name');
            const floorNumberInput = document.getElementById('floor-number');
            const deliveryNotesInput = document.getElementById('delivery-notes');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipCodeInput = document.getElementById('zip-code');
            const SHIPPING_INFO_STORAGE_KEY = 'shc-shipping-info';
            const shippingFormFields = document.getElementById('shippingFormFields');
            const savedAddressesWrapper = document.getElementById('savedAddressesWrapper');
            const savedAddressSelect = document.getElementById('savedAddressSelect');
            const savedAddressPreview = document.getElementById('savedAddressPreview');
            const useDifferentAddressBtn = document.getElementById('useDifferentAddressBtn');
            let savedAddresses = [];
            let manualAddressMode = true;
            let manualModeExplicit = false;

            // New modal links
            const aboutUsLink = document.getElementById('aboutUsLink');
            const privacyPolicyLink = document.getElementById('privacyPolicyLink');
            const termsAndConditionsLink = document.getElementById('termsAndConditionsLink');
            
            // New payment modal elements
            const paymentModal = document.getElementById('paymentModal');
            const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
            const cashappFields = document.getElementById('cashappFields');
            const zelleFields = document.getElementById('zelleFields');
            const paypalFields = document.getElementById('paypalFields');
            const checkFields = document.getElementById('checkFields');
            const submitOrderBtn = document.getElementById('submitOrderBtn');
            const paymentMessage = document.getElementById('paymentMessage');
            const closePaymentPanelBtn = document.getElementById('closePaymentPanel');

            let isUserLoggedIn = false;
            let isGuestCheckout = false;
            let currentUserId = null;
            let finalQuote = 0;

            const SHIPPING_KIT_FEE = 10;

            function formatPhoneNumber(input) {
                if (!input) return;

                let cleaned = ('' + input.value).replace(/\D/g, '');

                if (cleaned.length === 11 && cleaned.startsWith('1')) {
                    cleaned = cleaned.substring(1);
                }

                cleaned = cleaned.substring(0, 10);

                let formatted = '';
                if (cleaned.length > 0) {
                    formatted += '(' + cleaned.substring(0, 3);
                }
                if (cleaned.length >= 4) {
                    formatted += ') ' + cleaned.substring(3, 6);
                }
                if (cleaned.length >= 7) {
                    formatted += '-' + cleaned.substring(6, 10);
                }

                input.value = formatted;

                if (typeof updateOverview === 'function') {
                    updateOverview();
                }
            }
            
            // Basic modal controls for the new modals
            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (!modal) return;

                // Reset visibility so the animation can restart on every open
                modal.classList.remove('is-visible');
                modal.style.display = 'flex';

                // Force a reflow before re-adding the class to trigger the transition
                void modal.offsetWidth;
                modal.classList.add('is-visible');
            };

            const closeModal = (modal) => {
                if (!modal) return;
                modal.classList.remove('is-visible');

                const hideModal = () => {
                    modal.style.display = 'none';
                };

                modal.addEventListener('transitionend', hideModal, { once: true });

                // Fallback in case the transitionend event does not fire
                setTimeout(hideModal, 400);
            };
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
                modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
            });

            const showPaymentPanel = () => {
                if (!paymentModal) return;
                paymentModal.classList.remove('hidden');
                paymentModal.focus({ preventScroll: true });
                paymentModal.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            const hidePaymentPanel = () => {
                if (!paymentModal) return;
                paymentModal.classList.add('hidden');
            };

            if (closePaymentPanelBtn) {
                closePaymentPanelBtn.addEventListener('click', () => {
                    hidePaymentPanel();
                    sendPhoneBtn?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    sendPhoneBtn?.focus({ preventScroll: true });
                });
            }

            if(aboutUsLink) aboutUsLink.addEventListener('click', (e) => { e.preventDefault(); openModal('aboutUsModal'); });
            if(privacyPolicyLink) privacyPolicyLink.addEventListener('click', (e) => { e.preventDefault(); openModal('privacyPolicyModal'); });
            if(termsAndConditionsLink) termsAndConditionsLink.addEventListener('click', (e) => { e.preventDefault(); openModal('termsAndConditionsModal'); });
            
            // Listener for the Functional Details Link
            if (functionalDetailsLink) {
                functionalDetailsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal('fullyFunctionalModal');
                });
            }


            function getRandomLightColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = Math.floor(Math.random() * 30) + 70;
                const lightness = Math.floor(Math.random() * 20) + 70;
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            onAuthStateChanged(auth, (user) => {
                const isRealUser = user && !user.isAnonymous;
                
                if (isRealUser) {
                    isUserLoggedIn = true;
                    isGuestCheckout = false;
                    currentUserId = user.uid;
                    console.log("User is logged in:", user.uid);
                    loginNavBtn.classList.add('hidden');
                    userMonogram.classList.remove('hidden');

                    const displayName = user.displayName;
                    const email = user.email;
                    let initials = '';

                    if (displayName) {
                        initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    } else if (email) {
                        const username = email.split('@')[0];
                        const nameParts = username.split('.');
                        initials = nameParts.map(part => part.charAt(0)).join('').toUpperCase().substring(0, 2);
                    }

                    userMonogram.textContent = initials;
                    
                    hideLoginModal();

                    if (shippingInfoEmailInput && user.email) {
                        shippingInfoEmailInput.value = user.email;
                    }

                    if (fullNameInput && !fullNameInput.value && displayName) {
                        fullNameInput.value = displayName;
                    }

                    saveShippingInfo();
                    updateOverview();

                    loadUserShippingDetails(user);

                    if (finalQuote > 0 && nextSteps.classList.contains('hidden')) {
                        nextSteps.classList.remove('hidden');
                        updateOverview();
                        nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    isUserLoggedIn = false;
                    isGuestCheckout = false;
                    currentUserId = null;
                    console.log("User is logged out.");
                    loginNavBtn.classList.remove('hidden');
                    userMonogram.classList.add('hidden');
                    userMonogram.textContent = '';
                    authDropdown.classList.add('hidden');

                    if (shippingInfoEmailInput) {
                        shippingInfoEmailInput.value = '';
                    }
                    loadSavedShippingInfo();
                    clearSavedAddressesUI();
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });

            const BACKEND_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';
            const PROMO_STORAGE_KEY = 'shcSelectedPromoCode';
            const SHIP48_PROMO_CODE = 'SHIP48';
            const SHIP48_START_FLOW_KEY = 'shcShip48StartFlow';
            const PROMO_API_ENDPOINT = `${BACKEND_URL}/promo-codes`;
            const promoCodeInput = document.getElementById('promoCodeInput');
            const applyPromoBtn = document.getElementById('applyPromoBtn');
            const clearPromoBtn = document.getElementById('clearPromoBtn');
            const promoStatusMessage = document.getElementById('promoStatusMessage');
            const promoBreakdownRow = document.getElementById('promoBreakdownRow');
            const promoBreakdownAmount = document.getElementById('promoBreakdownAmount');
            const promoBreakdownLabel = document.getElementById('promoBreakdownLabel');
            let appliedPromo = null;
            let promoLookupInFlight = false;
            let ship48FlowRequested = false;

            function safeStorageSet(key, value) {
                try {
                    if (value === null || typeof value === 'undefined') {
                        localStorage.removeItem(key);
                    } else {
                        localStorage.setItem(key, value);
                    }
                } catch (error) {
                    console.warn('Unable to access localStorage:', error);
                }
            }

            function safeStorageGet(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('Unable to read localStorage:', error);
                    return null;
                }
            }

            function clearShip48StartFlag() {
                safeStorageSet(SHIP48_START_FLOW_KEY, null);
            }

            function ensureShip48EmailPreference() {
                const emailRadio = document.querySelector('input[name="shipping_preference"][value="email_label"]');
                if (emailRadio) {
                    if (!emailRadio.checked) {
                        emailRadio.checked = true;
                        emailRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    emailRadio.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            function beginShip48Flow(source = 'event') {
                if (ship48FlowRequested) return;
                ship48FlowRequested = true;
                ensureShip48EmailPreference();
                applyPromoCodeFromInput({ code: SHIP48_PROMO_CODE }).catch((error) => {
                    console.warn('Unable to prefill Ship48 promo:', error);
                });
                openModal('quoteModal');
                clearShip48StartFlag();
                setTimeout(() => {
                    ship48FlowRequested = false;
                }, 1500);
            }

            function setPromoStatus(type, message) {
                if (!promoStatusMessage) return;
                promoStatusMessage.textContent = message || '';
                promoStatusMessage.classList.remove('text-emerald-600', 'text-rose-600', 'text-slate-500');
                if (!message) {
                    promoStatusMessage.classList.add('text-slate-500');
                    return;
                }
                if (type === 'success') {
                    promoStatusMessage.classList.add('text-emerald-600');
                } else if (type === 'error') {
                    promoStatusMessage.classList.add('text-rose-600');
                } else {
                    promoStatusMessage.classList.add('text-slate-500');
                }
            }

            function announceActivePromoStatus() {
                if (!appliedPromo) return;
                const amountText = Number(appliedPromo.amount || 0).toFixed(2);
                setPromoStatus('success', `${appliedPromo.code || 'PROMO'} applied! +$${amountText} bonus`);
            }

            function isPromoEligibleForSelection(shippingPreferenceValue) {
                if (!appliedPromo) return true;
                if (!appliedPromo.requiresEmailLabel) return true;
                const normalized = (shippingPreferenceValue || '').toLowerCase();
                return normalized === 'email_label';
            }

            function getActivePromoAmount(shippingPreferenceValue) {
                if (!appliedPromo) return 0;
                if (!isPromoEligibleForSelection(shippingPreferenceValue)) return 0;
                return Number(appliedPromo.amount) || 0;
            }

            async function fetchPromoDetailsByCode(code) {
                const response = await fetch(`${PROMO_API_ENDPOINT}/${encodeURIComponent(code)}`);
                if (!response.ok) {
                    let errorMessage = 'Unable to validate promo code.';
                    try {
                        const payload = await response.json();
                        errorMessage = payload.error || errorMessage;
                    } catch (parseError) {
                        // ignore
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            }

            async function applyPromoCodeFromInput(options = {}) {
                if (!promoCodeInput || !applyPromoBtn) return;
                const providedCode = options.code || promoCodeInput.value;
                const normalizedCode = (providedCode || '').trim().toUpperCase();
                if (!normalizedCode) {
                    setPromoStatus('error', 'Enter a promo code to apply it.');
                    return;
                }
                if (promoLookupInFlight) return;
                promoLookupInFlight = true;
                applyPromoBtn.disabled = true;
                setPromoStatus('info', 'Validating promo code...');
                try {
                    const promoData = await fetchPromoDetailsByCode(normalizedCode);
                    appliedPromo = {
                        code: promoData.code || normalizedCode,
                        amount: Number(promoData.bonusAmount) || 0,
                        usesLeft: typeof promoData.usesLeft === 'number' ? promoData.usesLeft : null,
                        maxUses: typeof promoData.maxUses === 'number' ? promoData.maxUses : null,
                        requiresEmailLabel: Boolean(promoData.requiresEmailLabel),
                    };
                    safeStorageSet(PROMO_STORAGE_KEY, appliedPromo.code);
                    if (clearPromoBtn) {
                        clearPromoBtn.classList.remove('hidden');
                    }
                    if (!options.silent) {
                        announceActivePromoStatus();
                    }
                    updateOverview();
                } catch (error) {
                    appliedPromo = null;
                    safeStorageSet(PROMO_STORAGE_KEY, null);
                    if (clearPromoBtn) {
                        clearPromoBtn.classList.add('hidden');
                    }
                    setPromoStatus('error', error.message || 'Unable to apply promo code.');
                } finally {
                    promoLookupInFlight = false;
                    applyPromoBtn.disabled = false;
                }
            }

            function clearPromoCode() {
                appliedPromo = null;
                if (promoCodeInput) {
                    promoCodeInput.value = '';
                }
                if (clearPromoBtn) {
                    clearPromoBtn.classList.add('hidden');
                }
                safeStorageSet(PROMO_STORAGE_KEY, null);
                setPromoStatus('info', 'Promo code removed. Enter a code above to add a bonus.');
                updateOverview();
            }

            function hydratePromoFromStorage() {
                const storedCode = safeStorageGet(PROMO_STORAGE_KEY);
                if (storedCode) {
                    applyPromoCodeFromInput({ code: storedCode, silent: true });
                } else if (promoStatusMessage) {
                    setPromoStatus('info', 'Have a promo code? Enter it above to apply your bonus.');
                }
            }

            if (applyPromoBtn) {
                applyPromoBtn.addEventListener('click', () => applyPromoCodeFromInput());
            }

            if (clearPromoBtn) {
                clearPromoBtn.addEventListener('click', clearPromoCode);
            }

            if (promoCodeInput) {
                promoCodeInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        applyPromoCodeFromInput();
                    }
                });
            }

            window.addEventListener('shc:promo-code-selected', (event) => {
                if (!promoCodeInput) return;
                const selectedCode = (event.detail?.code || '').toUpperCase();
                if (!selectedCode) return;
                applyPromoCodeFromInput({ code: selectedCode });
            });

            window.addEventListener('shc:ship48-start-order', () => {
                beginShip48Flow('event');
            });

            (function hydrateShip48StartFlowFromContext() {
                const params = new URLSearchParams(window.location.search);
                const shouldStartFromQuery = params.get('ship48Start') === '1';
                const storedFlag = safeStorageGet(SHIP48_START_FLOW_KEY);
                const shouldStartFromStorage = storedFlag === '1';
                if (shouldStartFromQuery) {
                    params.delete('ship48Start');
                    const queryString = params.toString();
                    const newUrl = `${window.location.pathname}${queryString ? `?${queryString}` : ''}${window.location.hash || ''}`;
                    window.history.replaceState({}, '', newUrl);
                }
                if (shouldStartFromQuery || shouldStartFromStorage) {
                    clearShip48StartFlag();
                    setTimeout(() => beginShip48Flow(shouldStartFromQuery ? 'query' : 'storage'), 300);
                }
            })();

            hydratePromoFromStorage();

            function showAuthMessage(msg, type) {
                authMessage.textContent = msg;
                authMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    authMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    authMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    authMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                authMessage.classList.remove('hidden');
            }

            function clearAuthMessage() {
                authMessage.classList.add('hidden');
                authMessage.textContent = '';
            }

            function showLoginModal(initialTab = 'signup') {
                openModal('loginModal');
                clearAuthMessage();
                showTab(initialTab);
            }

            function hideLoginModal() {
                closeModal(document.getElementById('loginModal'));
            }

            function showTab(tabName) {
                clearAuthMessage();
                loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                loginTabBtn.classList.add('border-transparent', 'text-slate-500');
                signupTabBtn.classList.add('border-transparent', 'text-slate-500');

                if (tabName === 'login') {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    loginTabBtn.classList.add('border-blue-600', 'text-blue-600');
                    signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                } else if (tabName === 'signup') {
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    signupTabBtn.classList.add('border-blue-600', 'text-blue-600');
                    loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                } else if (tabName === 'forgotPassword') {
                    forgotPasswordForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    signupForm.classList.add('hidden');
                    loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                    signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                }
            }


            function showQuotePopup() {
                const hasOffer = finalQuote > 0;
                if (quoteModalOfferContent && quoteModalNoOfferContent && quoteModalContinueBtn) {
                    quoteModalOfferContent.classList.toggle('hidden', !hasOffer);
                    quoteModalNoOfferContent.classList.toggle('hidden', hasOffer);
                    quoteModalContinueBtn.textContent = hasOffer ? 'Continue' : 'Choose Other Options';
                }
                openModal('quoteModal');
            }

            function hideQuotePopup() {
                closeModal(quoteModal);
            }

            if(closeLoginModalBtn) closeLoginModalBtn.addEventListener('click', hideLoginModal);
            
            loginTabBtn.addEventListener('click', () => {
                showTab('login');
            });
            signupTabBtn.addEventListener('click', () => {
                showTab('signup');
            });
            loginNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showLoginModal('login');
            });
            if (guestCheckoutBtn) {
                guestCheckoutBtn.addEventListener('click', () => {
                    isGuestCheckout = true;
                    hideLoginModal();
                    if (finalQuote > 0) {
                        nextSteps.classList.remove('hidden');
                        updateOverview();
                        nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }

            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            returnToLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('forgotPassword');
            });

            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotEmailInput.value;
                if (!email) {
                    showAuthMessage('Please enter your email address.', 'error');
                    return;
                }
                
                try {
                    clearAuthMessage();
                    showAuthMessage('Sending password reset email...', 'info');
                    await sendPasswordResetEmail(auth, email);
                    showAuthMessage('A password reset link has been sent to your email. Check your inbox and spam folder.', 'success');
                    forgotEmailInput.value = '';
                } catch (error) {
                    console.error("Password reset error:", error);
                    showAuthMessage(getAuthErrorMessage('send the password reset email', error), 'error');
                }
            });

            quoteModalContinueBtn.addEventListener('click', () => {
                hideQuotePopup();
                if (finalQuote <= 0) {
                    showQuoteMessage('Sorry, we do not have an offer for this device. Please choose other options.', 'error');
                    return;
                }
                finalQuoteAmountMainDisplay.classList.remove('hidden');
                if (isUserLoggedIn || isGuestCheckout) {
                    nextSteps.classList.remove('hidden');
                    updateOverview();
                    nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    showLoginModal();
                }
            });

            const googleProvider = new GoogleAuthProvider();

            googleLoginBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing in with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google login error:", error);
                    showAuthMessage(getAuthErrorMessage('complete Google sign-in', error), 'error');
                }
            });

            googleSignupBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing up with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google signup error:", error);
                    showAuthMessage(getAuthErrorMessage('complete Google sign-up', error), 'error');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                if (!email || !password) {
                    showAuthMessage('Please enter both email and password.', 'error');
                    return;
                }
                try {
                    clearAuthMessage();
                    showAuthMessage('Logging in...', 'info');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Email login error:", error);
                    showAuthMessage(getAuthErrorMessage('log you in', error), 'error');
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = signupNameInput.value;
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;

                if (!name || !email || !password) {
                    showAuthMessage('Please enter your name, email, and password.', 'error');
                    return;
                }
                if (password.length < 6) {
                    showAuthMessage('Password should be at least 6 characters.', 'error');
                    return;
                }

                try {
                    clearAuthMessage();
                    showAuthMessage('Creating account...', 'info');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, {
                        displayName: name
                    });
                    showAuthMessage('Account created successfully! You are now logged in.', 'success');
                } catch (error) {
                    console.error("Email signup error:", error);
                    showAuthMessage(getAuthErrorMessage('create your account', error), 'error');
                }
            });


            function showQuoteMessage(msg, type) {
                quoteMessage.textContent = msg;
                quoteMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    quoteMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    quoteMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    quoteMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                quoteMessage.classList.remove('hidden');
            }

            function clearQuoteMessage() {
                quoteMessage.classList.add('hidden');
                quoteMessage.textContent = '';
            }
            
            function showPaymentMessage(msg, type) {
                paymentMessage.textContent = msg;
                paymentMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    paymentMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    paymentMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    paymentMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                paymentMessage.classList.remove('hidden');
            }
            
            function clearPaymentMessage() {
                paymentMessage.classList.add('hidden');
                paymentMessage.textContent = '';
            }


            function clearHighlights() {
                document.querySelectorAll('.highlight-missing').forEach(el => {
                    el.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.carrier-option label, .shipping-option label, .payment-option label').forEach(label => {
                    label.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.custom-checkbox .checkmark').forEach(checkmark => {
                    checkmark.classList.remove('highlight-missing');
                });
                document.getElementById('state').classList.remove('highlight-missing'); // Clear state input separately
            }

            const cosmeticDescriptions = {
                'flawless': 'Looks new with no signs of use. This is the best condition a used device can be in. There are no scratches, scuffs, or any other cosmetic imperfections visible to the naked eye. The device appears as if it just came out of its original packaging, offering a pristine aesthetic and feel.',
                'good': 'There may be a few light scuffs or scratches that are smaller than the size of a pencil eraser. These minor imperfections are typically on the casing or screen, but do not affect the device\'s functionality or overall aesthetic significantly. They are generally only noticeable upon close inspection and do not detract from the device\'s premium feel.',
                'fair': 'There are noticeable scratches or scuffs on the front and back. These could include multiple visible scratches, minor dents, or paint chips on the frame. While these cosmetic issues are more prominent, they do not impede the device\'s core functions, and the screen remains fully usable despite the marks.',
                'damaged': 'Major cosmetic damage includes cracked glass or back panels, bent frames, chips, dents, or sunbleaching. This category also covers devices with significant wear and tear, deep scratches, or other substantial visual defects that clearly impact the device\'s appearance. These issues are immediately apparent and go beyond normal wear, affecting the overall integrity and look of the device.'
            };

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedCondition = event.target.value;
                    const description = cosmeticDescriptions[selectedCondition];
                    if (description) {
                        cosmeticConditionDescription.textContent = description;
                        cosmeticConditionDescription.classList.remove('hidden');
                    } else {
                        cosmeticConditionDescription.classList.add('hidden');
                        cosmeticConditionDescription.textContent = '';
                    }
                });
            });

            const carrierSection = document.getElementById('carrierSection');
            const powerOnSection = document.getElementById('powerOnSection');
            const functionalSection = document.getElementById('functionalSection');
            const cracksSection = document.getElementById('cracksSection');
            const cosmeticSection = document.getElementById('cosmeticSection');
            
            // Helper function to uncheck all radios in a container
            function uncheckRadiosInContainer(container) {
                container.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
            }

            function hideAndClearQuestions(...sections) {
                sections.forEach(section => {
                    section.classList.add('hidden');
                    uncheckRadiosInContainer(section);
                });
            }

            function showAndClearQuestions(section) {
                section.classList.remove('hidden');
                uncheckRadiosInContainer(section);
            }
            
            function hideAllQuestions() {
                [carrierSection, powerOnSection, functionalSection, cracksSection, cosmeticSection, getQuoteBtn].forEach(el => {
                    el.classList.add('hidden');
                });
                uncheckRadiosInContainer(carrierSection);
                uncheckRadiosInContainer(powerOnSection);
                uncheckRadiosInContainer(functionalSection);
                uncheckRadiosInContainer(cracksSection);
                uncheckRadiosInContainer(cosmeticSection);
                clearQuoteMessage();
                finalQuoteAmountMainDisplay.classList.add('hidden');
                nextSteps.classList.add('hidden');
            }

            function isQuestionnaireComplete() {
                const selectedStorage = document.getElementById('storage').value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                const q1PowerOn = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                const q2Functional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                const q3NoCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                const q4Cosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                if (!selectedStorage || !selectedCarrier || !q1PowerOn) return false;

                if (q1PowerOn === 'no') return true;
                if (!q2Functional) return false;
                if (q2Functional === 'no') return true;
                if (!q3NoCracks) return false;
                if (q3NoCracks === 'no') return true;
                return Boolean(q4Cosmetic);
            }

            document.getElementById('storage').addEventListener('change', function() {
                if (this.value) {
                    carrierSection.classList.remove('hidden');
                    getQuoteBtn.classList.toggle('hidden', !isQuestionnaireComplete());

                    clearQuoteMessage();
                    this.classList.remove('highlight-missing');
                    saveFormState();
                } else {
                    hideAllQuestions();
                }
            });
            
            document.querySelectorAll('input[name="carrier"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    powerOnSection.classList.remove('hidden');
                    getQuoteBtn.classList.toggle('hidden', !isQuestionnaireComplete());

                    clearQuoteMessage();
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q1_power_on"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        functionalSection.classList.remove('hidden');
                        // Reset all dependent questions when power on changes
                        hideAndClearQuestions(cracksSection, cosmeticSection);
                        getQuoteBtn.classList.add('hidden');

                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(functionalSection, cracksSection, cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });
            
            document.querySelectorAll('input[name="q2_fully_functional"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cracksSection.classList.remove('hidden');
                        // Reset all dependent questions when functional changes
                        hideAndClearQuestions(cosmeticSection);
                        getQuoteBtn.classList.add('hidden');

                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(cracksSection, cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });
            
            document.querySelectorAll('input[name="q3_no_cracks"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cosmeticSection.classList.remove('hidden');
                        getQuoteBtn.classList.add('hidden');
                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    getQuoteBtn.classList.remove('hidden');
                    clearQuoteMessage();
                    saveFormState();
                    calculateQuoteAndDisplay({ showModal: false, autoContinue: true });
                });
            });

            const carrierLabelMap = {
                att: 'AT&T',
                verizon: 'Verizon',
                tmobile: 'T-Mobile',
                unlocked: 'Unlocked'
            };

            const carrierAliasMap = {
                att: 'att',
                atandt: 'att',
                at_t: 'att',
                verizon: 'verizon',
                vzw: 'verizon',
                vz: 'verizon',
                tmobile: 'tmobile',
                t_mobile: 'tmobile',
                magenta: 'tmobile',
                unlocked: 'unlocked',
                simfree: 'unlocked',
                other: 'other',
                carrierlocked: 'locked',
                locked: 'locked'
            };

            function normalizeCarrierKey(value = '') {
                const normalized = value.toLowerCase().replace(/[^a-z0-9]/g, '');
                return carrierAliasMap[normalized] || normalized;
            }

            // Resolve the pricing object for the selected carrier with sensible fallbacks
            function resolveCarrierPricing(storagePricing = {}, carrierValue = '') {
                const normalizedCarrier = normalizeCarrierKey(carrierValue);

                // Direct match first
                if (normalizedCarrier && storagePricing[normalizedCarrier]) {
                    return storagePricing[normalizedCarrier];
                }

                // If a specific carrier was selected but only "locked" pricing exists, use it
                if (['att', 'tmobile', 'verizon'].includes(normalizedCarrier) && storagePricing.locked) {
                    return storagePricing.locked;
                }

                // Fallback order preference
                const fallbackOrder = ['unlocked', 'att', 'verizon', 'tmobile', 'locked'];
                for (const key of fallbackOrder) {
                    if (storagePricing[key]) {
                        return storagePricing[key];
                    }
                }

                // Final fallback: first available pricing object, or null
                const firstAvailableKey = Object.keys(storagePricing)[0];
                return firstAvailableKey ? storagePricing[firstAvailableKey] : null;
            }

            function formatCarrierLabel(value) {
                const normalized = (value || '').toLowerCase();
                return carrierLabelMap[normalized] || 'Not Selected';
            }

            function proceedAfterQuote(options = {}) {
                const { closeModal = true } = options;
                if (closeModal) {
                    hideQuotePopup();
                }
                if (finalQuote <= 0) {
                    showQuoteMessage('Sorry, we do not have an offer for this device. Please choose other options.', 'error');
                    return;
                }
                finalQuoteAmountMainDisplay.classList.remove('hidden');
                if (isUserLoggedIn || isGuestCheckout) {
                    nextSteps.classList.remove('hidden');
                    updateOverview();
                    nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    isGuestCheckout = true;
                    console.log('checking out as guest');
                    nextSteps.classList.remove('hidden');
                    updateOverview();
                    nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            function calculateQuoteAndDisplay(options = {}) {
                const { showModal = true, autoContinue = false } = options;
                clearQuoteMessage();
                clearHighlights();
                
                const selectedStorage = document.getElementById('storage').value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                const q1PowerOn = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                const q2Functional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                const q3NoCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                const q4Cosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                let hasError = false;

                if (!selectedStorage) {
                    document.getElementById('storage').classList.add('highlight-missing');
                    hasError = true;
                }
                if (!selectedCarrier) {
                    document.getElementById('carrierOptions').classList.add('highlight-missing');
                    hasError = true;
                }
                if (!q1PowerOn) {
                    document.getElementById('powerOnSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && !q2Functional) {
                    document.getElementById('functionalSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && !q3NoCracks) {
                    document.getElementById('cracksSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'yes' && !q4Cosmetic) {
                    document.getElementById('cosmeticSection').classList.add('highlight-missing');
                    hasError = true;
                }

                if (hasError) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                // Get the base prices for the selected storage and carrier from the fetched device data.
                const basePrices = resolveCarrierPricing(device.prices[selectedStorage] || {}, selectedCarrier);
                
                if (!basePrices) {
                    showQuoteMessage('Pricing data for this combination is not available.', 'error');
                    return;
                }
                
                let finalPrice = 0;
                
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'yes') {
                    // Fully functional, no cracks
                    const cosmeticKey = q4Cosmetic === 'damaged' ? 'broken' : q4Cosmetic;
                    finalPrice = basePrices[cosmeticKey];
                } else if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'no') {
                    // Fully functional, but has cracks
                    finalPrice = basePrices.broken;
                } else if (q1PowerOn === 'yes' && q2Functional === 'no') {
                    // Powers on, but not functional
                    finalPrice = basePrices.broken;
                } else if (q1PowerOn === 'no') {
                    // Doesn't power on
                    finalPrice = basePrices.noPower;
                }
                
                finalQuote = finalPrice ? parseFloat(finalPrice.toFixed(2)) : 0;

                finalQuoteAmountMainText.textContent = `$${finalQuote.toFixed(2)}`;
                finalQuoteAmountPopup.textContent = `$${finalQuote.toFixed(2)}`;

                updateOverview();

                if (showModal) {
                    showQuotePopup();
                } else if (autoContinue) {
                    proceedAfterQuote({ closeModal: false });
                }
            }

            getQuoteBtn.addEventListener('click', calculateQuoteAndDisplay);

            // Logic to handle the new payment modal and order submission
            function validatePaymentFields() {
                const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
                let isComplete = false;
                
                if (selectedPaymentMethod) {
                    if (selectedPaymentMethod === 'cashapp') {
                        const cashtag = document.getElementById('cashappTag').value;
                        const cashtagConfirm = document.getElementById('cashappTagConfirm').value;
                        isComplete = cashtag && cashtag === cashtagConfirm;
                    } else if (selectedPaymentMethod === 'zelle') {
                        const identifier = document.getElementById('zelleIdentifier').value;
                        const identifierConfirm = document.getElementById('zelleIdentifierConfirm').value;
                        isComplete = identifier && identifier === identifierConfirm;
                    } else if (selectedPaymentMethod === 'paypal') {
                        const email = document.getElementById('paypalEmail').value;
                        const emailConfirm = document.getElementById('paypalEmailConfirm').value;
                        isComplete = email && email === emailConfirm;
                    } else if (selectedPaymentMethod === 'check') {
                        const payableTo = document.getElementById('checkPayableTo').value;
                        const address1 = document.getElementById('checkAddress1').value;
                        const city = document.getElementById('checkCity').value;
                        const state = document.getElementById('checkState').value;
                        const zipCode = document.getElementById('checkZipCode').value;
                        isComplete = payableTo && address1 && city && state && zipCode;
                    }
                }
                return isComplete;
            }

            function updateSubmitButtonState() {
                if (validatePaymentFields()) {
                    submitOrderBtn.classList.remove('btn-disabled');
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.disabled = false;
                } else {
                    submitOrderBtn.classList.add('btn-disabled');
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.disabled = true;
                }
            }

            paymentOptions.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    cashappFields.classList.add('hidden');
                    zelleFields.classList.add('hidden');
                    paypalFields.classList.add('hidden');
                    checkFields.classList.add('hidden');
                    
                    const selectedMethod = e.target.value;
                    if (selectedMethod === 'cashapp') {
                        cashappFields.classList.remove('hidden');
                    } else if (selectedMethod === 'zelle') {
                        zelleFields.classList.remove('hidden');
                    } else if (selectedMethod === 'paypal') {
                        paypalFields.classList.remove('hidden');
                    } else if (selectedMethod === 'check') {
                        checkFields.classList.remove('hidden');
                    }
                    updateSubmitButtonState();
                });
            });
            
            // Populate check state dropdown with same states as main form
            const checkStateSelect = document.getElementById('checkState');
            const mainStateSelect = document.getElementById('state');
            if (checkStateSelect && mainStateSelect) {
                // Copy all state options from main form to check form
                Array.from(mainStateSelect.options).forEach(option => {
                    const newOption = option.cloneNode(true);
                    checkStateSelect.appendChild(newOption);
                });
            }
            
            // Copy from shipping button handler
            const copyFromShippingBtn = document.getElementById('copyFromShippingBtn');
            if (copyFromShippingBtn) {
                copyFromShippingBtn.addEventListener('click', () => {
                    const fullName = document.getElementById('fullName')?.value || '';
                    const streetAddress = document.getElementById('street-address')?.value || '';
                    const addressUnit = document.getElementById('address-unit')?.value || '';
                    const city = document.getElementById('city')?.value || '';
                    const state = document.getElementById('state')?.value || '';
                    const zipCode = document.getElementById('zip-code')?.value || '';
                    const phone = document.getElementById('phone')?.value || '';
                    
                    // Populate check fields
                    const checkPayableTo = document.getElementById('checkPayableTo');
                    const checkAddress1 = document.getElementById('checkAddress1');
                    const checkAddress2 = document.getElementById('checkAddress2');
                    const checkCity = document.getElementById('checkCity');
                    const checkState = document.getElementById('checkState');
                    const checkZipCode = document.getElementById('checkZipCode');
                    const checkPhone = document.getElementById('checkPhone');
                    
                    if (checkPayableTo) checkPayableTo.value = fullName;
                    if (checkAddress1) checkAddress1.value = streetAddress;
                    if (checkAddress2) checkAddress2.value = addressUnit;
                    if (checkCity) checkCity.value = city;
                    if (checkState) checkState.value = state;
                    if (checkZipCode) checkZipCode.value = zipCode;
                    if (checkPhone) checkPhone.value = phone;
                    
                    // Show a brief success message
                    const btn = copyFromShippingBtn;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copied!';
                    btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    btn.classList.add('bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }, 2000);
                });
            }
            
            document.querySelectorAll('#paymentModal input').forEach(input => {
                input.addEventListener('input', () => {
                    clearPaymentMessage();
                    updateSubmitButtonState();
                });
            });
            
            document.querySelectorAll('#paymentModal select').forEach(select => {
                select.addEventListener('change', () => {
                    clearPaymentMessage();
                    updateSubmitButtonState();
                });
            });
            
            // New logic for the "Send Phone In Now" button
            sendPhoneBtn.addEventListener('click', async () => {
                clearQuoteMessage();
                clearHighlights();

                saveShippingInfo();

                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked');
                const termsAccepted = document.getElementById('termsAccepted');
                const fullName = document.getElementById('fullName');
                const email = document.getElementById('email');
                const streetAddress = document.getElementById('street-address');
                const city = document.getElementById('city');
                const state = document.getElementById('state');
                const zipCode = document.getElementById('zip-code');
                
                let firstMissingElement = null;
                
                // --- UPDATED STATE VALIDATION (relies on select.value being non-empty) ---
                if (!state.value) { 
                    state.classList.add('highlight-missing'); 
                    if (!firstMissingElement) firstMissingElement = state; 
                } 
                // --- END UPDATED STATE VALIDATION ---

                if (!selectedShippingPreference) {
                    const shippingOptionsContainer = document.getElementById('shippingOptions');
                    if (shippingOptionsContainer) {
                        shippingOptionsContainer.classList.add('highlight-missing');
                        if (!firstMissingElement) firstMissingElement = shippingOptionsContainer;
                    }
                }
                
                // --- MODIFIED VALIDATION: Check phone length (14 chars = (###) ###-####) ---
                const cleanedPhone = phoneInput.value.replace(/\D/g, '');
                if (cleanedPhone.length !== 10) { 
                    phoneInput.classList.add('highlight-missing'); 
                    if (!firstMissingElement) firstMissingElement = phoneInput; 
                    showQuoteMessage('Please enter a complete 10-digit phone number.', 'error');
                    phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                // --- END MODIFIED VALIDATION ---

                if (!fullName.value) { fullName.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = fullName; }
                if (!email.value) { email.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = email; }
                if (!streetAddress.value) { streetAddress.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = streetAddress; }
                if (!city.value) { city.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = city; }
                if (!zipCode.value) { zipCode.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zipCode; }
                if (!termsAccepted.checked) {
                    document.querySelector('#orderOverview .checkmark').classList.add('highlight-missing');
                    if (!firstMissingElement) firstMissingElement = termsAccepted;
                }
                
                if (firstMissingElement) {
                    showQuoteMessage('Please fill out all required fields to proceed.', 'error');
                    firstMissingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // All fields are valid, reveal the payment step inline
                showPaymentPanel();
            });


            document.querySelectorAll('input[name="shipping_preference"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.shipping-option label').forEach(label => label.classList.remove('highlight-missing'));
                    updateOverview();
                    saveShippingInfo();
                });
            });

            const shippingInputs = Array.from(document.querySelectorAll('#shippingSection input, #shippingSection select, #shippingSection textarea'));
            const requiredShippingInputs = shippingInputs.filter(input => input.hasAttribute('required'));
            requiredShippingInputs.forEach(input => {
                input.dataset.wasRequired = 'true';
            });

            function updateShippingFieldRequirements(enabled) {
                requiredShippingInputs.forEach(input => {
                    if (!input.dataset.wasRequired) return;
                    if (enabled) {
                        input.setAttribute('required', '');
                    } else {
                        input.removeAttribute('required');
                    }
                });
            }

            function saveShippingInfo() {
                if (!fullNameInput || !streetAddressInput) return;
                try {
                    const selectedPreference = document.querySelector('input[name="shipping_preference"]:checked')?.value || '';
                    const payload = {
                        fullName: fullNameInput.value || '',
                        phone: phoneInput?.value || '',
                        email: shippingInfoEmailInput?.value || '',
                        streetAddress: streetAddressInput.value || '',
                        addressUnit: addressUnitInput?.value || '',
                        buildingName: buildingNameInput?.value || '',
                        floorNumber: floorNumberInput?.value || '',
                        deliveryNotes: deliveryNotesInput?.value || '',
                        city: cityInput.value || '',
                        state: stateInput.value || '',
                        zipCode: zipCodeInput.value || '',
                        shippingPreference: selectedPreference
                    };
                    localStorage.setItem(SHIPPING_INFO_STORAGE_KEY, JSON.stringify(payload));
                } catch (error) {
                    console.warn('Unable to save shipping info', error);
                }
            }

            function loadSavedShippingInfo(force = false) {
                if (!fullNameInput) return;
                try {
                    const saved = localStorage.getItem(SHIPPING_INFO_STORAGE_KEY);
                    if (!saved) return;
                    const data = JSON.parse(saved);
                    if (data.fullName && (force || !fullNameInput.value)) {
                        fullNameInput.value = data.fullName;
                    }
                    if (phoneInput && data.phone && (force || !phoneInput.value)) {
                        phoneInput.value = data.phone;
                        formatPhoneNumber(phoneInput);
                    }
                    if (shippingInfoEmailInput && data.email && (force || !shippingInfoEmailInput.value)) {
                        shippingInfoEmailInput.value = data.email;
                    }
                    if (streetAddressInput && data.streetAddress && (force || !streetAddressInput.value)) {
                        streetAddressInput.value = data.streetAddress;
                    }
                    if (addressUnitInput && data.addressUnit && (force || !addressUnitInput.value)) {
                        addressUnitInput.value = data.addressUnit;
                    }
                    if (buildingNameInput && data.buildingName && (force || !buildingNameInput.value)) {
                        buildingNameInput.value = data.buildingName;
                    }
                    if (floorNumberInput && data.floorNumber && (force || !floorNumberInput.value)) {
                        floorNumberInput.value = data.floorNumber;
                    }
                    if (deliveryNotesInput && data.deliveryNotes && (force || !deliveryNotesInput.value)) {
                        deliveryNotesInput.value = data.deliveryNotes;
                    }
                    if (cityInput && data.city && (force || !cityInput.value)) {
                        cityInput.value = data.city;
                    }
                    if (stateInput && data.state && (force || !stateInput.value)) {
                        stateInput.value = data.state;
                    }
                    if (zipCodeInput && data.zipCode && (force || !zipCodeInput.value)) {
                        zipCodeInput.value = data.zipCode;
                    }
                    if (data.shippingPreference) {
                        const preferenceRadio = document.querySelector(`input[name=\"shipping_preference\"][value=\"${data.shippingPreference}\"]`);
                        if (preferenceRadio) {
                            preferenceRadio.checked = true;
                            preferenceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                    updateOverview();
                } catch (error) {
                    console.warn('Unable to load saved shipping info', error);
                }
            }

            function normalizeShippingInfoForStorage(info = {}) {
                const base = {
                    fullName: '',
                    email: '',
                    phone: '',
                    streetAddress: '',
                    addressUnit: '',
                    buildingName: '',
                    floorNumber: '',
                    deliveryNotes: '',
                    city: '',
                    state: '',
                    zipCode: '',
                    shippingPreference: ''
                };

                if (!info || typeof info !== 'object') {
                    return { ...base };
                }

                const rawPreference = (info.shippingPreference || info.shipping_preference || info.preferredShipping || '')
                    .toString()
                    .trim()
                    .toLowerCase();

                let normalizedPreference = '';
                if (rawPreference === 'ship_kit' || rawPreference === 'shipping kit requested') {
                    normalizedPreference = 'ship_kit';
                } else if (rawPreference === 'email_label' || rawPreference === 'email label requested') {
                    normalizedPreference = 'email_label';
                }

                const extractString = (...values) => {
                    for (const value of values) {
                        if (typeof value === 'number') {
                            return value.toString();
                        }
                        if (value && typeof value === 'string') {
                            const trimmed = value.trim();
                            if (trimmed) {
                                return trimmed;
                            }
                        }
                    }
                    return '';
                };

                return {
                    ...base,
                    fullName: extractString(info.fullName),
                    email: extractString(info.email),
                    phone: extractString(info.phone).replace(/\D/g, ''),
                    streetAddress: extractString(info.streetAddress, info.addressLine1, info.address1),
                    addressUnit: extractString(info.addressUnit, info.unit, info.apartment, info.suite, info.addressLine2, info.address2),
                    buildingName: extractString(info.buildingName, info.building, info.complex, info.residenceName),
                    floorNumber: extractString(info.floorNumber, info.floor, info.level),
                    deliveryNotes: extractString(info.deliveryNotes, info.deliveryInstructions, info.instructions, info.notes),
                    city: extractString(info.city, info.locality),
                    state: extractString(info.state, info.region).toUpperCase(),
                    zipCode: extractString(info.zipCode, info.postalCode, info.zip),
                    shippingPreference: normalizedPreference
                };
            }

            function formatPhoneFromDigits(phone) {
                const digits = (phone || '').toString().replace(/\D/g, '');
                if (digits.length !== 10) {
                    return digits;
                }
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }

            function buildAddressDocIdFromInfo(info = {}) {
                const normalized = normalizeShippingInfoForStorage(info);
                const sanitize = (value) => (value || '')
                    .toString()
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');

                const parts = [
                    normalized.streetAddress,
                    normalized.addressUnit,
                    normalized.buildingName,
                    normalized.floorNumber,
                    normalized.city,
                    normalized.state,
                    normalized.zipCode,
                    normalized.phone
                ].map(sanitize).filter(Boolean);

                let key = parts.join('-');
                if (!key) {
                    const fallback = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36);
                    key = `addr-${fallback}`;
                }
                if (key.length > 120) {
                    key = key.slice(0, 120).replace(/-+$/g, '');
                }
                return key || `addr-${Date.now().toString(36)}`;
            }

            function updateSavedAddressPreview(address) {
                if (!savedAddressPreview) return;
                if (!address) {
                    savedAddressPreview.classList.add('hidden');
                    savedAddressPreview.textContent = '';
                    return;
                }

                const normalized = normalizeShippingInfoForStorage(address);
                const segments = [];

                if (normalized.fullName) segments.push(normalized.fullName);

                const streetLine = [normalized.streetAddress, normalized.addressUnit]
                    .filter(Boolean)
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (streetLine) segments.push(streetLine);

                const buildingParts = [];
                if (normalized.buildingName) buildingParts.push(normalized.buildingName);
                if (normalized.floorNumber) {
                    const trimmedFloor = normalized.floorNumber.trim();
                    if (trimmedFloor) {
                        const floorDisplay = /floor|level|fl/i.test(trimmedFloor) ? trimmedFloor : `Floor ${trimmedFloor}`;
                        buildingParts.push(floorDisplay);
                    }
                }
                const buildingLine = buildingParts.join(' ‚Ä¢ ');
                if (buildingLine) segments.push(buildingLine);

                const cityState = [normalized.city, normalized.state].filter(Boolean).join(', ');
                const locationLine = [cityState, normalized.zipCode].filter(Boolean).join(' ');
                if (locationLine.trim()) segments.push(locationLine.trim());

                if (normalized.deliveryNotes) {
                    const cleanedNotes = normalized.deliveryNotes.replace(/\s+/g, ' ').trim();
                    if (cleanedNotes) segments.push(`Notes: ${cleanedNotes}`);
                }

                if (normalized.phone) segments.push(formatPhoneFromDigits(normalized.phone));
                if (normalized.email) segments.push(normalized.email);

                if (!segments.length) {
                    savedAddressPreview.classList.add('hidden');
                    savedAddressPreview.textContent = '';
                    return;
                }

                savedAddressPreview.textContent = segments.join(' ‚Ä¢ ');
                savedAddressPreview.classList.remove('hidden');
            }

            function setManualAddressMode(enabled, options = {}) {
                manualAddressMode = !!enabled;
                if (options.userInitiated === true) {
                    manualModeExplicit = manualAddressMode;
                } else if (!savedAddresses.length) {
                    manualModeExplicit = false;
                }

                if (shippingFormFields) {
                    shippingFormFields.classList.toggle('hidden', !manualAddressMode);
                }

                if (useDifferentAddressBtn) {
                    if (savedAddresses.length) {
                        useDifferentAddressBtn.classList.remove('hidden');
                        useDifferentAddressBtn.textContent = manualAddressMode ? 'Use saved address' : 'Use a different address';
                        useDifferentAddressBtn.setAttribute('aria-pressed', manualAddressMode ? 'true' : 'false');
                    } else {
                        useDifferentAddressBtn.classList.add('hidden');
                    }
                }

                updateShippingFieldRequirements(manualAddressMode);

                if (!manualAddressMode) {
                    const activeId = savedAddressSelect?.value;
                    const activeAddress = savedAddresses.find(address => address.id === activeId) || savedAddresses[0] || null;
                    if (activeAddress) {
                        applyShippingInfoToForm(activeAddress, { force: true });
                        updateSavedAddressPreview(activeAddress);
                    }
                }

                if (manualAddressMode && options.prefill) {
                    applyShippingInfoToForm(options.prefill, { force: true });
                }
            }

            function clearSavedAddressesUI() {
                savedAddresses = [];
                if (savedAddressSelect) {
                    savedAddressSelect.innerHTML = '<option value="" selected>Choose a saved address</option>';
                    savedAddressSelect.disabled = true;
                }
                if (savedAddressesWrapper) {
                    savedAddressesWrapper.classList.add('hidden');
                }
                if (useDifferentAddressBtn) {
                    useDifferentAddressBtn.classList.add('hidden');
                }
                updateSavedAddressPreview(null);
                manualModeExplicit = false;
                setManualAddressMode(true);
            }

            function buildAddressOptionLabel(address) {
                const normalized = normalizeShippingInfoForStorage(address);
                const parts = [];
                if (normalized.fullName) parts.push(normalized.fullName);
                const streetLine = [normalized.streetAddress, normalized.addressUnit]
                    .filter(Boolean)
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (streetLine) parts.push(streetLine);
                const buildingParts = [];
                if (normalized.buildingName) buildingParts.push(normalized.buildingName);
                if (normalized.floorNumber) {
                    const trimmedFloor = normalized.floorNumber.trim();
                    if (trimmedFloor) {
                        const floorDisplay = /floor|level|fl/i.test(trimmedFloor) ? trimmedFloor : `Floor ${trimmedFloor}`;
                        buildingParts.push(floorDisplay);
                    }
                }
                const buildingLine = buildingParts.join(' ‚Ä¢ ');
                if (buildingLine) parts.push(buildingLine);
                const cityState = [normalized.city, normalized.state].filter(Boolean).join(', ');
                const cityLine = [cityState, normalized.zipCode].filter(Boolean).join(' ');
                if (cityLine.trim()) parts.push(cityLine.trim());
                let label = parts.join(' ‚Ä¢ ') || 'Saved address';
                if (label.length > 80) {
                    label = `${label.slice(0, 77)}‚Ä¶`;
                }
                return label;
            }

            function populateSavedAddresses(addresses = [], options = {}) {
                if (!savedAddressSelect || !savedAddressesWrapper) return;
                const { selectedId = '' } = options;
                savedAddresses = Array.isArray(addresses) ? addresses.map(address => ({ ...address })) : [];

                savedAddressSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = savedAddresses.length ? 'Choose a saved address' : 'No saved addresses yet';
                placeholder.selected = !selectedId;
                placeholder.disabled = !!savedAddresses.length;
                savedAddressSelect.appendChild(placeholder);

                savedAddresses.forEach(address => {
                    const option = document.createElement('option');
                    const addressId = address.id || buildAddressDocIdFromInfo(address);
                    if (!address.id) {
                        address.id = addressId;
                    }
                    option.value = addressId;
                    option.textContent = buildAddressOptionLabel(address);
                    if (addressId === selectedId) {
                        option.selected = true;
                    }
                    savedAddressSelect.appendChild(option);
                });

                if (savedAddresses.length) {
                    savedAddressesWrapper.classList.remove('hidden');
                    savedAddressSelect.disabled = false;
                    if (useDifferentAddressBtn) {
                        useDifferentAddressBtn.classList.remove('hidden');
                    }
                    setManualAddressMode(manualModeExplicit);
                    if (selectedId) {
                        const selected = savedAddresses.find(address => address.id === selectedId);
                        if (selected) {
                            updateSavedAddressPreview(selected);
                        }
                    } else {
                        updateSavedAddressPreview(null);
                    }
                } else {
                    savedAddressesWrapper.classList.add('hidden');
                    savedAddressSelect.disabled = true;
                    if (useDifferentAddressBtn) {
                        useDifferentAddressBtn.classList.add('hidden');
                    }
                    updateSavedAddressPreview(null);
                    setManualAddressMode(true);
                }
            }

            function applyShippingInfoToForm(info, options = {}) {
                const { force = false } = options || {};
                const normalized = normalizeShippingInfoForStorage(info);

                const setFieldValue = (input, value) => {
                    if (!input) return;
                    if (!force && input.value) return;
                    if (typeof value === 'undefined' || value === null) return;
                    input.value = value;
                };

                setFieldValue(fullNameInput, normalized.fullName);
                setFieldValue(shippingInfoEmailInput, normalized.email);

                if (phoneInput) {
                    if (normalized.phone) {
                        phoneInput.value = normalized.phone;
                        formatPhoneNumber(phoneInput);
                    } else if (force) {
                        phoneInput.value = '';
                    }
                }

                setFieldValue(streetAddressInput, normalized.streetAddress);
                setFieldValue(addressUnitInput, normalized.addressUnit);
                setFieldValue(buildingNameInput, normalized.buildingName);
                setFieldValue(floorNumberInput, normalized.floorNumber);
                if (deliveryNotesInput && (force || !deliveryNotesInput.value) && normalized.deliveryNotes) {
                    deliveryNotesInput.value = normalized.deliveryNotes;
                } else if (deliveryNotesInput && force && !normalized.deliveryNotes) {
                    deliveryNotesInput.value = '';
                }
                setFieldValue(cityInput, normalized.city);

                if (stateInput) {
                    if ((force || !stateInput.value) && normalized.state) {
                        stateInput.value = normalized.state;
                    } else if (force && !normalized.state) {
                        stateInput.value = '';
                    }
                }

                setFieldValue(zipCodeInput, normalized.zipCode);

                const preferenceSelected = document.querySelector('input[name="shipping_preference"]:checked');
                if (normalized.shippingPreference && (force || !preferenceSelected)) {
                    const preferenceRadio = document.querySelector(`input[name="shipping_preference"][value="${normalized.shippingPreference}"]`);
                    if (preferenceRadio) {
                        preferenceRadio.checked = true;
                        preferenceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }

                updateOverview();
                saveShippingInfo();
            }

            function selectSavedAddress(addressId, options = {}) {
                const { force = true } = options || {};
                if (!savedAddressSelect) return;
                savedAddressSelect.value = addressId || '';
                if (!addressId) {
                    updateSavedAddressPreview(null);
                    return;
                }
                const selected = savedAddresses.find(address => String(address.id) === String(addressId));
                if (selected) {
                    applyShippingInfoToForm(selected, { force });
                    updateSavedAddressPreview(selected);
                    if (!manualModeExplicit) {
                        setManualAddressMode(false);
                    }
                }
            }

            async function fetchSavedAddressesForUser(userId) {
                if (!userId) return [];
                try {
                    const addressesRef = collection(db, `users/${userId}/savedAddresses`);
                    const addressQuery = query(addressesRef, orderBy('updatedAt', 'desc'), limit(5));
                    const snapshot = await getDocs(addressQuery);
                    const results = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data() || {};
                        results.push({ id: docSnap.id, ...normalizeShippingInfoForStorage(data) });
                    });
                    return results;
                } catch (error) {
                    console.warn('Unable to load saved addresses', error);
                    return [];
                }
            }

            async function persistShippingInfoForUser(userId, shippingInfo) {
                if (!userId) return null;
                const normalized = normalizeShippingInfoForStorage(shippingInfo);
                if (!normalized.fullName || !normalized.streetAddress || !normalized.city || !normalized.state || !normalized.zipCode) {
                    return null;
                }

                try {
                    const userDocRef = doc(db, `users/${userId}`);
                    await setDoc(userDocRef, {
                        lastShippingInfo: normalized,
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    const addressDocId = buildAddressDocIdFromInfo(normalized);
                    const addressDocRef = doc(db, `users/${userId}/savedAddresses/${addressDocId}`);
                    const existingSnapshot = await getDoc(addressDocRef);
                    const timestampPayload = existingSnapshot.exists()
                        ? { updatedAt: serverTimestamp() }
                        : { createdAt: serverTimestamp(), updatedAt: serverTimestamp() };

                    await setDoc(addressDocRef, { ...normalized, ...timestampPayload }, { merge: true });

                    return { id: addressDocId, ...normalized };
                } catch (error) {
                    console.warn('Unable to persist shipping info', error);
                    return null;
                }
            }

            async function loadUserShippingDetails(user) {
                if (!user || !user.uid) return;
                clearSavedAddressesUI();

                try {
                    const userId = user.uid;
                    const shippingFieldsEmpty = !fullNameInput?.value && !streetAddressInput?.value && !cityInput?.value && !stateInput?.value && !zipCodeInput?.value && !phoneInput?.value;

                    const [addresses, userDocSnapshot] = await Promise.all([
                        fetchSavedAddressesForUser(userId),
                        (async () => {
                            try {
                                const userDocRef = doc(db, `users/${userId}`);
                                const snapshot = await getDoc(userDocRef);
                                return snapshot.exists() ? snapshot.data() : null;
                            } catch (error) {
                                console.warn('Unable to fetch user profile details', error);
                                return null;
                            }
                        })()
                    ]);

                    populateSavedAddresses(addresses);

                    let lastShippingInfo = null;
                    if (userDocSnapshot && userDocSnapshot.lastShippingInfo) {
                        lastShippingInfo = normalizeShippingInfoForStorage(userDocSnapshot.lastShippingInfo);
                    }

                    if (shippingFieldsEmpty && addresses.length) {
                        selectSavedAddress(addresses[0].id, { force: true });
                    } else if (shippingFieldsEmpty && lastShippingInfo) {
                        applyShippingInfoToForm(lastShippingInfo, { force: true });
                        updateSavedAddressPreview(lastShippingInfo);
                    } else if (lastShippingInfo) {
                        updateSavedAddressPreview(lastShippingInfo);
                    }
                } catch (error) {
                    console.warn('Unable to load saved shipping details', error);
                    clearSavedAddressesUI();
                }
            }

            if (savedAddressSelect) {
                savedAddressSelect.addEventListener('change', () => {
                    const selectedId = savedAddressSelect.value;
                    if (!selectedId) {
                        updateSavedAddressPreview(null);
                        manualModeExplicit = true;
                        setManualAddressMode(true, { userInitiated: true });
                        return;
                    }
                    selectSavedAddress(selectedId, { force: true });
                    if (!manualModeExplicit) {
                        setManualAddressMode(false);
                    }
                });
            }

            if (useDifferentAddressBtn) {
                useDifferentAddressBtn.addEventListener('click', () => {
                    if (!savedAddresses.length) {
                        setManualAddressMode(true, { userInitiated: true });
                        return;
                    }

                    if (manualAddressMode) {
                        const fallback = savedAddressSelect?.value || (savedAddresses[0] && savedAddresses[0].id);
                        if (fallback) {
                            if (savedAddressSelect) {
                                savedAddressSelect.value = fallback;
                            }
                            selectSavedAddress(fallback, { force: true });
                        }
                        setManualAddressMode(false, { userInitiated: true });
                    } else {
                        const selected = savedAddresses.find(address => address.id === savedAddressSelect?.value) || savedAddresses[0] || null;
                        if (savedAddressSelect) {
                            savedAddressSelect.value = '';
                        }
                        updateSavedAddressPreview(null);
                        setManualAddressMode(true, { userInitiated: true, prefill: selected });
                        if (fullNameInput) {
                            fullNameInput.focus();
                        }
                    }
                });
            }

            const handleShippingInput = () => {
                updateOverview();
                saveShippingInfo();
            };

            shippingInputs.forEach(input => {
                input.addEventListener('input', handleShippingInput);
                input.addEventListener('change', handleShippingInput);
            });

            loadSavedShippingInfo();

            function updateOverview() {
                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked')?.value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;

                let displayShippingPreferenceText = 'Not Selected';
                if (selectedShippingPreference === 'ship_kit') {
                    displayShippingPreferenceText = 'Shipping Kit Requested';
                } else if (selectedShippingPreference === 'email_label') {
                    displayShippingPreferenceText = 'Email Label Requested';
                }

                let displayCarrierText = 'Not Selected';
                if (selectedCarrier) {
                    displayCarrierText = formatCarrierLabel(selectedCarrier);
                }

                const baseQuote = Number(finalQuote) || 0;
                const shippingKitFee = selectedShippingPreference === 'ship_kit' ? SHIPPING_KIT_FEE : 0;
                const promoEligible = isPromoEligibleForSelection(selectedShippingPreference);
                const promoAmount = promoEligible ? getActivePromoAmount(selectedShippingPreference) : 0;
                const totalBeforePromo = Math.max(baseQuote - shippingKitFee, 0);
                const totalPayout = totalBeforePromo + promoAmount;

                const fullName = fullNameInput?.value || '';
                const phone = phoneInput?.value || '';
                const streetAddress = streetAddressInput?.value || '';
                const addressUnit = addressUnitInput?.value || '';
                const buildingName = buildingNameInput?.value || '';
                const floorNumber = floorNumberInput?.value || '';
                const deliveryNotes = deliveryNotesInput?.value || '';
                const city = cityInput?.value || '';
                const state = stateInput?.value || '';
                const zipCode = zipCodeInput?.value || '';

                overviewQuote.textContent = `$${totalPayout.toFixed(2)}`;
                overviewShippingPreference.textContent = displayShippingPreferenceText;
                overviewCarrier.textContent = displayCarrierText;

                const breakdownQuoteAmount = document.getElementById('breakdownQuoteAmount');
                if (breakdownQuoteAmount) {
                    breakdownQuoteAmount.textContent = `$${baseQuote.toFixed(2)}`;
                }

                const breakdownShippingLabel = document.getElementById('breakdownShippingLabel');
                const breakdownShippingAmount = document.getElementById('breakdownShippingAmount');
                if (breakdownShippingLabel && breakdownShippingAmount) {
                    breakdownShippingAmount.classList.remove('text-emerald-600', 'text-rose-600', 'text-slate-500');

                    if (selectedShippingPreference === 'ship_kit') {
                        breakdownShippingLabel.textContent = 'Shipping Kit Fee';
                        breakdownShippingAmount.textContent = 'Applied';
                        breakdownShippingAmount.classList.add('text-rose-600');
                    } else if (selectedShippingPreference === 'email_label') {
                        breakdownShippingLabel.textContent = 'Email Label';
                        breakdownShippingAmount.textContent = 'Free';
                        breakdownShippingAmount.classList.add('text-emerald-600');
                    } else {
                        breakdownShippingLabel.textContent = 'Shipping Option';
                        breakdownShippingAmount.textContent = 'Select an option';
                        breakdownShippingAmount.classList.add('text-slate-500');
                    }
                }

                if (promoBreakdownRow && promoBreakdownAmount) {
                    if (promoAmount > 0) {
                        promoBreakdownRow.classList.remove('hidden');
                        if (promoBreakdownLabel) {
                            promoBreakdownLabel.textContent = appliedPromo?.code ? `${appliedPromo.code} Bonus` : 'Promo Bonus';
                        }
                        promoBreakdownAmount.textContent = `+$${promoAmount.toFixed(2)}`;
                    } else {
                        promoBreakdownRow.classList.add('hidden');
                    }
                }

                if (appliedPromo) {
                    if (!promoEligible) {
                        setPromoStatus('error', 'Select the Email Label option to keep your Ship48 bonus.');
                    } else if (!promoLookupInFlight) {
                        announceActivePromoStatus();
                    }
                }

                const breakdownFinalPayout = document.getElementById('breakdownFinalPayout');
                if (breakdownFinalPayout) {
                    breakdownFinalPayout.textContent = `$${totalPayout.toFixed(2)}`;
                }

                // NEW: Update phone overview display
                overviewPhone.textContent = phone || 'Not Entered';

                const streetLine = [streetAddress, addressUnit].filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
                const buildingParts = [];
                if (buildingName) buildingParts.push(buildingName);
                if (floorNumber) {
                    const trimmedFloor = floorNumber.trim();
                    if (trimmedFloor) {
                        const floorDisplay = /floor|level|fl/i.test(trimmedFloor) ? trimmedFloor : `Floor ${trimmedFloor}`;
                        buildingParts.push(floorDisplay);
                    }
                }
                const cityState = [city, state].filter(Boolean).join(', ');
                const locationLine = [cityState, zipCode].filter(Boolean).join(' ').trim();
                const notesLine = deliveryNotes
                    ? `Notes: ${deliveryNotes.replace(/\s+/g, ' ').trim()}`
                    : '';
                const fullAddress = [fullName, streetLine, buildingParts.join(' ‚Ä¢ '), locationLine, notesLine]
                    .map(part => part && part.trim())
                    .filter(Boolean)
                    .join(', ');
                overviewAddress.textContent = fullAddress || 'Not Entered';
            }

            submitOrderBtn.addEventListener('click', async () => {
                clearPaymentMessage();
                clearHighlights();

                const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                let firstMissingElement = null;

                if (!selectedPayment) {
                    const paymentOptionsContainer = document.getElementById('paymentOptions');
                    paymentOptionsContainer.classList.add('highlight-missing');
                    firstMissingElement = paymentOptionsContainer;
                } else {
                    if (selectedPayment.value === 'cashapp') {
                        const cashappTag = document.getElementById('cashappTag');
                        const cashappTagConfirm = document.getElementById('cashappTagConfirm');
                        if (!cashappTag.value) { cashappTag.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = cashappTag; }
                        if (!cashappTagConfirm.value || cashappTag.value !== cashappTagConfirm.value) { cashappTagConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = cashappTagConfirm; }
                    } else if (selectedPayment.value === 'zelle') {
                        const zelleIdentifier = document.getElementById('zelleIdentifier');
                        const zelleIdentifierConfirm = document.getElementById('zelleIdentifierConfirm');
                        if (!zelleIdentifier.value) { zelleIdentifier.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zelleIdentifier; }
                        if (!zelleIdentifierConfirm.value || zelleIdentifier.value !== zelleIdentifierConfirm.value) { zelleIdentifierConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zelleIdentifierConfirm; }
                    } else if (selectedPayment.value === 'paypal') {
                        const paypalEmail = document.getElementById('paypalEmail');
                        const paypalEmailConfirm = document.getElementById('paypalEmailConfirm');
                        if (!paypalEmail.value) { paypalEmail.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = paypalEmail; }
                        if (!paypalEmailConfirm.value || paypalEmail.value !== paypalEmailConfirm.value) { paypalEmailConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = paypalEmailConfirm; }
                    } else if (selectedPayment.value === 'check') {
                        const checkPayableTo = document.getElementById('checkPayableTo');
                        const checkAddress1 = document.getElementById('checkAddress1');
                        const checkCity = document.getElementById('checkCity');
                        const checkState = document.getElementById('checkState');
                        const checkZipCode = document.getElementById('checkZipCode');
                        if (!checkPayableTo.value) { checkPayableTo.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = checkPayableTo; }
                        if (!checkAddress1.value) { checkAddress1.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = checkAddress1; }
                        if (!checkCity.value) { checkCity.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = checkCity; }
                        if (!checkState.value) { checkState.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = checkState; }
                        if (!checkZipCode.value) { checkZipCode.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = checkZipCode; }
                    }
                }
                
                if (firstMissingElement) {
                    showPaymentMessage('Please fill out all required fields to proceed.', 'error');
                    firstMissingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                submitOrderBtn.disabled = true;
                submitOrderBtn.textContent = 'Order Submitting...';
                submitOrderBtn.classList.remove('btn-primary-indigo');
                submitOrderBtn.classList.add('btn-disabled');
                
                const rawShippingPreference = document.querySelector('input[name="shipping_preference"]:checked').value;
                const shippingKitFee = rawShippingPreference === 'ship_kit' ? SHIPPING_KIT_FEE : 0;
                const promoEligibleForSubmission = isPromoEligibleForSelection(rawShippingPreference);
                if (appliedPromo && !promoEligibleForSubmission) {
                    showPaymentMessage('Ship48 can only be used with the Email Label option. Please switch your shipping preference or clear the promo code.', 'error');
                    submitOrderBtn.disabled = false;
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.classList.remove('btn-disabled');
                    submitOrderBtn.classList.add('btn-primary-indigo');
                    return;
                }
                const promoAmountForSubmission = promoEligibleForSubmission ? (Number(appliedPromo?.amount) || 0) : 0;
                const totalPayout = Math.max(finalQuote - shippingKitFee, 0) + promoAmountForSubmission;

                    const orderData = {
                    device: device.name,
                    brand: deviceInfo.brand, // FIXED: Use parsed brand from deviceInfo
                    modelSlug: deviceInfo.slug,
                    carrier: document.querySelector('input[name="carrier"]:checked').value,
                    storage: document.getElementById('storage').value,
                    condition_power_on: document.querySelector('input[name="q1_power_on"]:checked').value,
                    condition_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value || 'N/A',
                    condition_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value || 'N/A',
                    condition_cosmetic: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value || 'N/A',
                    estimatedQuote: totalPayout,
                    originalQuote: finalQuote,
                    shippingKitFee,
                        totalPayout,
                        shippingPreference: rawShippingPreference === 'ship_kit' ? 'Shipping Kit Requested' : 'Email Label Requested',
                    paymentMethod: selectedPayment.value,
                    paymentDetails: {},
                    shippingInfo: {
                        fullName: document.getElementById('fullName').value,
                        email: document.getElementById('email').value,
                        // MODIFIED: Store the cleaned, unformatted 10-digit number in Firebase
                        phone: phoneInput.value.replace(/\D/g, ''),
                        streetAddress: streetAddressInput.value,
                        addressUnit: addressUnitInput?.value || '',
                        buildingName: buildingNameInput?.value || '',
                        floorNumber: floorNumberInput?.value || '',
                        deliveryNotes: deliveryNotesInput?.value || '',
                        city: cityInput.value,
                        state: stateInput.value, // Now guaranteed to be a 2-letter code
                        zipCode: zipCodeInput.value,
                        shippingPreference: rawShippingPreference
                    },
                    termsAccepted: document.getElementById('termsAccepted').checked,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                    };

                if (promoEligibleForSubmission && appliedPromo) {
                    orderData.promoCode = appliedPromo.code;
                    orderData.promoBonusAmount = Number(appliedPromo.amount) || 0;
                }
                
                // Add payment details to the order data
                if (selectedPayment.value === 'cashapp') {
                    orderData.paymentDetails.cashappTag = document.getElementById('cashappTag').value;
                } else if (selectedPayment.value === 'zelle') {
                    orderData.paymentDetails.zelleIdentifier = document.getElementById('zelleIdentifier').value;
                } else if (selectedPayment.value === 'paypal') {
                    orderData.paymentDetails.paypalEmail = document.getElementById('paypalEmail').value;
                } else if (selectedPayment.value === 'check') {
                    orderData.paymentDetails.checkPayableTo = document.getElementById('checkPayableTo').value;
                    orderData.paymentDetails.checkAddress1 = document.getElementById('checkAddress1').value;
                    orderData.paymentDetails.checkAddress2 = document.getElementById('checkAddress2')?.value || '';
                    orderData.paymentDetails.checkCity = document.getElementById('checkCity').value;
                    orderData.paymentDetails.checkState = document.getElementById('checkState').value;
                    orderData.paymentDetails.checkZipCode = document.getElementById('checkZipCode').value;
                    orderData.paymentDetails.checkPhone = document.getElementById('checkPhone')?.value || '';
                    orderData.paymentDetails.checkCountry = 'United States';
                }
                
                try {
                    showPaymentMessage('Submitting your order...', 'info');
                    const response = await fetch(`${BACKEND_URL}/submit-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to submit order.');
                    }

                    if (isUserLoggedIn && currentUserId) {
                        try {
                            const persistedAddress = await persistShippingInfoForUser(currentUserId, orderData.shippingInfo);
                            if (persistedAddress) {
                                savedAddresses = savedAddresses.filter(address => address.id !== persistedAddress.id);
                                savedAddresses.unshift(persistedAddress);
                                populateSavedAddresses(savedAddresses, { selectedId: persistedAddress.id });
                            }
                        } catch (persistError) {
                            console.warn('Unable to cache shipping details for reuse', persistError);
                        }
                    }

                    // Get order ID from response and estimated price from deviceInfo or orderData
                    const orderId = result.orderId || result.id || Date.now().toString();
                    const totalPrice = Number(orderData.totalPayout ?? orderData.estimatedQuote ?? finalQuote ?? deviceInfo.estimatedPrice ?? 0);
                    const autoLabelUrl = result.autoLabelDownloadUrl || result.labelDownloadUrl || '';
                    const autoLabelTracking = result.autoLabelTrackingNumber || result.trackingNumber || '';
                    const promoFromServer = result.promo;

                    try {
                        const normalizedTotal = Number(totalPrice) || 0;
                        const normalizedOriginal = Number(orderData.originalQuote ?? finalQuote ?? 0) || 0;
                        const normalizedShippingFee = Number(orderData.shippingKitFee ?? (rawShippingPreference === 'ship_kit' ? SHIPPING_KIT_FEE : 0)) || 0;

                        const summaryPayload = {
                            orderId,
                            name: orderData.shippingInfo.fullName,
                            device: orderData.device,
                            storage: orderData.storage,
                            carrier: orderData.carrier,
                            price: normalizedTotal,
                            finalPayout: normalizedTotal,
                            originalQuote: normalizedOriginal,
                            shippingPreference: rawShippingPreference,
                            shippingKitFee: normalizedShippingFee,
                            paymentMethod: orderData.paymentMethod,
                            labelUrl: autoLabelUrl,
                            trackingNumber: autoLabelTracking
                        };
                        if (promoFromServer && promoFromServer.code) {
                            summaryPayload.promoCode = promoFromServer.code;
                            summaryPayload.promoBonusAmount = Number(promoFromServer.amount) || 0;
                        } else if (promoEligibleForSubmission && appliedPromo) {
                            summaryPayload.promoCode = appliedPromo.code;
                            summaryPayload.promoBonusAmount = Number(appliedPromo.amount) || 0;
                        }
                        sessionStorage.setItem('shcOrderSummary', JSON.stringify(summaryPayload));
                    } catch (storageError) {
                        console.warn('Unable to persist order summary to session storage:', storageError);
                    }

                    const queryParams = new URLSearchParams({
                        shipping: orderData.shippingPreference === 'Shipping Kit Requested' ? 'ship_kit' : 'email_label',
                        orderId,
                        price: totalPrice,
                        finalPayout: totalPrice,
                        originalQuote: orderData.originalQuote ?? finalQuote ?? '',
                        shippingKitFee: orderData.shippingKitFee ?? (rawShippingPreference === 'ship_kit' ? SHIPPING_KIT_FEE : ''),
                        shippingPreference: rawShippingPreference,
                        name: orderData.shippingInfo.fullName,
                        device: orderData.device,
                        storage: orderData.storage,
                        carrier: orderData.carrier,
                        paymentMethod: orderData.paymentMethod || ''
                    });
                    if (autoLabelUrl) {
                        queryParams.set('labelUrl', autoLabelUrl);
                    }
                    if (autoLabelTracking) {
                        queryParams.set('trackingNumber', autoLabelTracking);
                    }
                    if (promoFromServer && promoFromServer.code) {
                        queryParams.set('promoCode', promoFromServer.code);
                        queryParams.set('promoBonusAmount', promoFromServer.amount);
                    } else if (promoEligibleForSubmission && appliedPromo) {
                        queryParams.set('promoCode', appliedPromo.code);
                        queryParams.set('promoBonusAmount', appliedPromo.amount);
                    }

                    setTimeout(() => {
                        window.location.href = `https://secondhandcell.com/order-submitted.html?${queryParams.toString()}`;
                    }, 2000);
                    
                } catch (e) {
                    console.error("Error submitting order: ", e);
                    showPaymentMessage('There was an error submitting your order. Please try again.', 'error');
                    
                    submitOrderBtn.disabled = false;
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.classList.remove('btn-disabled');
                    submitOrderBtn.classList.add('btn-primary-indigo');
                }
            });

            function saveFormState() {
                const formState = {
                    storage: document.getElementById('storage').value,
                    carrier: document.querySelector('input[name="carrier"]:checked')?.value,
                    q1_power_on: document.querySelector('input[name="q1_power_on"]:checked')?.value,
                    q2_fully_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value,
                    q3_no_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value,
                    q4_cosmetic_condition: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value,
                };
                // We're using localStorage for state persistence during page navigation or refresh.
                // Use the device brand and slug for the key since device info is now reliable
                localStorage.setItem(`${deviceInfo.brand}-${deviceInfo.slug}-FormState`, JSON.stringify(formState));
            }

            function loadFormState() {
                const savedState = localStorage.getItem(`${deviceInfo.brand}-${deviceInfo.slug}-FormState`);
                if (savedState) {
                    const formState = JSON.parse(savedState);
                    
                    const storageSelect = document.getElementById('storage');
                    storageSelect.value = formState.storage || '';
                    if (storageSelect.value) {
                           // unhide sections based on loaded state
                           carrierSection.classList.remove('hidden');
                           if (formState.carrier) {
                               powerOnSection.classList.remove('hidden');
                               if (formState.q1_power_on) {
                                   if (formState.q1_power_on === 'yes') {
                                       functionalSection.classList.remove('hidden');
                                       if (formState.q2_fully_functional === 'yes') {
                                           cracksSection.classList.remove('hidden');
                                           if (formState.q3_no_cracks === 'yes') {
                                               cosmeticSection.classList.remove('hidden');
                                               if (formState.q4_cosmetic_condition) {
                                                   getQuoteBtn.classList.remove('hidden');
                                               }
                                           } else { // cracks present (treated as damaged)
                                               cosmeticSection.classList.add('hidden');
                                               getQuoteBtn.classList.remove('hidden');
                                           }
                                       } else { // not functional
                                           cracksSection.classList.add('hidden');
                                           cosmeticSection.classList.add('hidden');
                                           getQuoteBtn.classList.remove('hidden');
                                       }
                                   } else { // no power
                                       functionalSection.classList.add('hidden');
                                       cracksSection.classList.add('hidden');
                                       cosmeticSection.classList.add('hidden');
                                       getQuoteBtn.classList.remove('hidden');
                                   }
                               }
                           }
                    }

                    // Re-check radio buttons
                    if (formState.carrier) {
                        const carrierRadio = document.querySelector(`input[name="carrier"][value="${formState.carrier}"]`);
                        if (carrierRadio) carrierRadio.checked = true;
                    }
                    if (formState.q1_power_on) {
                        const powerOnRadio = document.querySelector(`input[name="q1_power_on"][value="${formState.q1_power_on}"]`);
                        if (powerOnRadio) powerOnRadio.checked = true;
                    }
                    if (formState.q2_fully_functional) {
                        const functionalRadio = document.querySelector(`input[name="q2_fully_functional"][value="${formState.q2_fully_functional}"]`);
                        if (functionalRadio) functionalRadio.checked = true;
                    }
                    if (formState.q3_no_cracks) {
                        const cracksRadio = document.querySelector(`input[name="q3_no_cracks"][value="${formState.q3_no_cracks}"]`);
                        if (cracksRadio) cracksRadio.checked = true;
                    }
                    if (formState.q4_cosmetic_condition) {
                        const cosmeticRadio = document.querySelector(`input[name="q4_cosmetic_condition"][value="${formState.q4_cosmetic_condition}"]`);
                        if (cosmeticRadio) {
                            cosmeticRadio.checked = true;
                            cosmeticConditionDescription.textContent = cosmeticDescriptions[formState.q4_cosmetic_condition];
                            cosmeticConditionDescription.classList.remove('hidden');
                        }
                    }
                }
            }
            // Add event listener to footer email signup form
            if (footerEmailSignupForm) {
                footerEmailSignupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = footerPromoEmailInput.value;
                    const messageContainer = footerSignupMessage;
                    if (!email) {
                        messageContainer.textContent = 'Please enter a valid email address.';
                        messageContainer.className = 'mt-3 text-sm text-center text-red-500';
                        return;
                    }
                    try {
                        const response = await fetch(`${BACKEND_URL}/subscribe-to-newsletter`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            messageContainer.textContent = 'Thank you for subscribing!';
                            messageContainer.className = 'mt-3 text-sm text-center text-green-500';
                            footerPromoEmailInput.value = '';
                        } else {
                            throw new Error(result.error || 'Failed to subscribe.');
                        }
                    } catch (error) {
                        messageContainer.textContent = `Error: ${error.message}`;
                        messageContainer.className = 'mt-3 text-sm text-center text-red-500';
                    }
                });
            }

            // Only attempt to load form state if device data loaded successfully
            if (device) {
                 loadFormState();
            }
        });
        }
        */
    </script>
    <script>
        const db = window.firebaseDb;
        const firestoreApi = window.firebase?.firestore || {};
        const { collection, getDocs } = firestoreApi;
        const appId = db?.app?.options?.appId || 'default-app-id';

        const data = {
            brands: ['iPhone', 'Samsung', 'iPad'],
            models: {},
            storage: [],
            locks: [],
            conditions: []
        };

        const selections = { brand: '', model: '', storage: '', lock: '', condition: '', qty: 1 };
        let currentStep = 'brand';
        let isFinalView = false;
        const stepOrder = ['brand', 'model', 'storage', 'lock', 'condition'];

        const buildSortedArray = (values) => Array.from(values).filter(Boolean).sort((a, b) => a.localeCompare(b));

        const normalizeBrandName = (value = '') => {
            const normalized = value.toLowerCase();
            if (normalized.includes('iphone')) return 'iPhone';
            if (normalized.includes('ipad')) return 'iPad';
            if (normalized.includes('samsung')) return 'Samsung';
            return value.trim() || '';
        };

        const extractStorageOptions = (device) => {
            if (Array.isArray(device.storageOptions)) return device.storageOptions;
            if (Array.isArray(device.storage)) return device.storage;
            if (Array.isArray(device.capacity)) return device.capacity;
            if (device.prices && typeof device.prices === 'object') {
                return Object.keys(device.prices);
            }
            if (typeof device.storage === 'string') return [device.storage];
            if (typeof device.capacity === 'string') return [device.capacity];
            return [];
        };

        const extractLockOptions = (device) => {
            if (Array.isArray(device.locks)) return device.locks;
            if (Array.isArray(device.networks)) return device.networks;
            if (Array.isArray(device.carriers)) return device.carriers;
            if (typeof device.lock === 'string') return [device.lock];
            if (typeof device.network === 'string') return [device.network];
            if (typeof device.carrier === 'string') return [device.carrier];
            return [];
        };

        const loadDeviceData = async () => {
            if (!db || !collection || !getDocs) return;
            const devicesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/devices`));
            const modelMap = {};
            const storageSet = new Set();
            const lockSet = new Set();

            devicesSnapshot.forEach((docSnap) => {
                const device = docSnap.data() || {};
                const brand = normalizeBrandName(device.brand || device.make || device.manufacturer || device.category);
                const model = device.model || device.name || device.title;

                if (brand && data.brands.includes(brand) && model) {
                    if (!modelMap[brand]) {
                        modelMap[brand] = new Set();
                    }
                    modelMap[brand].add(model);
                }

                extractStorageOptions(device).forEach((option) => {
                    if (option) storageSet.add(option);
                });
                extractLockOptions(device).forEach((option) => {
                    if (option) lockSet.add(option);
                });
            });

            data.models = data.brands.reduce((acc, brand) => {
                acc[brand] = buildSortedArray(modelMap[brand] || []);
                return acc;
            }, {});
            data.storage = buildSortedArray(storageSet);
            data.locks = buildSortedArray(lockSet);
        };

        const loadPricingData = async () => {
            if (!db || !collection || !getDocs) return;
            const pricingSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/pricing`));
            data.conditions = pricingSnapshot.docs.map((docSnap) => {
                const pricing = docSnap.data() || {};
                const desc = Array.isArray(pricing.desc) ? pricing.desc : pricing.description || [];
                return {
                    name: pricing.name || pricing.condition || docSnap.id,
                    price: pricing.price ?? pricing.amount ?? 0,
                    desc: Array.isArray(desc) ? desc : [desc]
                };
            }).sort((a, b) => a.name.localeCompare(b.name));
        };

        const fetchSellData = async () => {
            await Promise.all([loadDeviceData(), loadPricingData()]);
        };

        function init() {
            const params = new URLSearchParams(window.location.search);
            stepOrder.forEach(step => {
                if (params.has(step)) selections[step] = params.get(step);
            });

            fetchSellData()
                .then(() => renderStep())
                .catch((error) => {
                    console.error('Failed to load sell flow data.', error);
                    renderStep();
                });
        }

        function jumpTo(step) {
            const targetIdx = stepOrder.indexOf(step);
            const currentIdx = isFinalView ? stepOrder.length : stepOrder.indexOf(currentStep);

            if (targetIdx < currentIdx) {
                isFinalView = false;
                document.getElementById('offer-view').classList.add('hidden');
                document.getElementById('selection-flow').classList.remove('hidden');
                currentStep = step;
                renderStep();
                updateURL();
            }
        }

        function renderStep() {
            const grid = document.getElementById('grid-content');
            const title = document.getElementById('step-name');
            if (!grid || !title) return;
            grid.innerHTML = '';

            let items = [];
            if (currentStep === 'brand') {
                title.innerText = "Select Brand";
                items = data.brands;
            } else if (currentStep === 'model') {
                title.innerText = `Which ${selections.brand} Model?`;
                items = data.models[selections.brand] || [];
            } else if (currentStep === 'storage') {
                title.innerText = "Select Capacity";
                items = data.storage;
            } else if (currentStep === 'lock') {
                title.innerText = "Select Network";
                items = data.locks;
            } else if (currentStep === 'condition') {
                title.innerText = "Overall Condition";
                items = data.conditions.map(c => c.name);
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'select-card';
                if (selections[currentStep] === item) card.classList.add('active');
                card.innerText = item;
                card.onclick = () => handleSelect(item);
                grid.appendChild(card);
            });

            updateCrumbs();
        }

        function handleSelect(val) {
            selections[currentStep] = val;
            updateURL();

            const currentIdx = stepOrder.indexOf(currentStep);
            if (currentIdx < stepOrder.length - 1) {
                currentStep = stepOrder[currentIdx + 1];
                renderStep();
            } else {
                showOffer();
            }
        }

        function updateCrumbs() {
            const crumbsContainer = isFinalView ? document.getElementById('final-crumbs') : document.getElementById('crumbs');
            if (!crumbsContainer) return;
            crumbsContainer.innerHTML = '';
            const currentIdx = isFinalView ? stepOrder.length : stepOrder.indexOf(currentStep);

            stepOrder.forEach((stepKey, i) => {
                const c = document.createElement('span');
                c.className = 'crumb';
                c.onclick = () => jumpTo(stepKey);

                if (i === currentIdx) {
                    c.classList.add('active');
                    c.innerText = stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                } else if (i < currentIdx) {
                    c.classList.add('filled', 'can-jump');
                    c.innerText = selections[stepKey] || stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                } else {
                    c.innerText = stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                }
                crumbsContainer.appendChild(c);
            });
        }

        function showOffer() {
            isFinalView = true;
            document.getElementById('selection-flow').classList.add('hidden');
            document.getElementById('offer-view').classList.remove('hidden');

            document.getElementById('final-device-name').innerText = selections.model || selections.brand || '--';
            document.getElementById('summary-tags').innerText = [selections.storage, selections.lock].filter(Boolean).join('  ‚Ä¢  ');

            if (!selections.condition) selections.condition = data.conditions[0]?.name || 'Flawless';

            renderFinalConditionGrid();
            updatePriceDisplay();
            updateCrumbs();
        }

        function renderFinalConditionGrid() {
            const grid = document.getElementById('final-condition-grid');
            if (!grid) return;
            grid.innerHTML = '';
            data.conditions.forEach(c => {
                const card = document.createElement('div');
                card.className = 'select-card';
                if (selections.condition === c.name) card.classList.add('active');
                card.innerHTML = `<div>${c.name}</div>`;

                card.onclick = () => {
                    selections.condition = c.name;
                    renderFinalConditionGrid();
                    updatePriceDisplay();
                };
                grid.appendChild(card);
            });
        }

        function updatePriceDisplay() {
            const cond = data.conditions.find(c => c.name === selections.condition);
            if (!cond) return;

            document.getElementById('final-price').innerText = `$${cond.price}`;
            document.getElementById('condition-title-display').innerText = cond.name;

            const details = document.getElementById('condition-details');
            details.innerHTML = cond.desc.map(d => `<li>${d}</li>`).join('');
        }

        function updateURL() {
            const url = new URL(window.location);
            Object.keys(selections).forEach(key => {
                if (selections[key] && key !== 'qty') url.searchParams.set(key, selections[key]);
            });
            window.history.replaceState({}, '', url);
        }

        function handleCheckout() {
            const email = document.getElementById('user-email').value;
            if (!email.includes('@')) return alert("Enter valid email.");
            document.getElementById('qty-modal').style.display = 'flex';
        }

        function changeQty(v) {
            selections.qty = Math.max(1, selections.qty + v);
            document.getElementById('qty-val').innerText = selections.qty;
        }

        function finalSubmit() {
            console.log("Submit to DB:", selections);
        }

        function resetFlow() {
            window.location.search = '';
        }

        window.addEventListener('load', init);
        window.handleCheckout = handleCheckout;
        window.resetFlow = resetFlow;
        window.changeQty = changeQty;
        window.finalSubmit = finalSubmit;
    </script>
  <script src="/assets/js/ship48-banner.js" defer></script>
<script type="module" src="/assets/js/global-auth.js" defer></script>
</body>
</html>
