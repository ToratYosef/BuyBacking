<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecondHandCell - Sell Your Device</title>
    <link rel="icon" href="/favicon/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9evSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google tag (gtag.js) -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <!-- End Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-17534255111');
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            doc,
            getDoc,
            setDoc,
            getDocs,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.appspot.com",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateProfile = updateProfile;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.firebaseDb = db;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebase = {
            firestore: {
                doc,
                getDoc,
                collection,
                getDocs,
                setDoc,
                query,
                orderBy,
                limit
            }
        };
    </script>
    <style>
        body {
            font-family: sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for hidden radio buttons and clickable images */
        .carrier-option input[type="radio"],
        .shipping-option input[type="radio"],
        .payment-option input[type="radio"] {
            display: none;
        }
        .carrier-option label,
        .shipping-option label,
        .payment-option label {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .carrier-option input[type="radio"]:checked + label,
        .shipping-option input[type="radio"]:checked + label,
        .payment-option input[type="radio"]:checked + label {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
            transform: scale(1.02);
            background-color: #e0e7ff;
        }
        .carrier-option label:hover,
        .shipping-option label:hover,
        .payment-option label:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        #quoteModal {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s ease-out;
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
        }
        #quoteModal.is-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        .custom-checkbox input[type="checkbox"] {
            display: none;
        }
        .custom-checkbox .checkmark {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #94a3b8;
            border-radius: 0.25rem;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0.5rem;
            height: 1rem;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: translate(-50%, -60%) rotate(45deg);
        }
        .btn-primary-blue {
            background-color: #2563eb;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-blue:hover {
            background-color: #1d4ed8;
            transform: scale(1.05);
        }
        .btn-primary-blue:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.5);
        }
        .btn-secondary-green {
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-secondary-green:hover {
            background-color: #16a34a;
            transform: scale(1.05);
        }
        .btn-secondary-green:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.5);
        }
        
        .btn-primary-indigo {
            background-color: #4f46e5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-indigo:hover {
            background-color: #4338ca;
            transform: scale(1.05);
        }
        .btn-primary-indigo:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #94a3b8 !important;
            box-shadow: none;
            transform: none;
        }
        /* Mobile-first adjustments for layout and typography */
        @media (max-width: 1023px) {
            .main-content-layout {
                flex-direction: column-reverse;
            }
            .quote-display-mobile-first {
                order: -1;
                margin-bottom: 2rem;
            }
            .main-content-layout > div:nth-child(1) {
                margin-top: 2rem;
            }
            .text-4xl {
                font-size: 2.25rem;
            }
            .text-3xl {
                font-size: 1.875rem;
            }
            .text-lg {
                font-size: 1rem;
            }
            .question-group {
                padding: 0.75rem;
            }
            .carrier-option label,
            .shipping-option label,
            .payment-option label {
                padding: 0.75rem;
            }
            .h-10.w-10 {
                height: 2rem;
                width: 2rem;
            }
            .text-4xl {
                font-size: 2rem;
            }
            .text-3xl {
                font-size: 1.75rem;
            }
            .btn-primary-blue,
            .btn-secondary-green,
            .btn-primary-indigo {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .modal-content .text-5xl {
                font-size: 3rem;
            }
            /* Specific mobile adjustments for scrollable content modals */
            #fullyFunctionalModal .modal-content-scroll,
            #privacyPolicyModal .modal-content-scroll,
            #termsAndConditionsModal .modal-content-scroll {
                max-width: 95%; /* Make it wide on small screens */
                width: 95%;
                padding: 1.5rem;
            }
            #fullyFunctionalModal .prose p, 
            #fullyFunctionalModal .prose ul,
            #fullyFunctionalModal .prose li {
                font-size: 0.8rem; /* Smaller font on mobile */
            }
            #fullyFunctionalModal .prose h2 {
                font-size: 1.25rem;
            }
            #fullyFunctionalModal .prose h3 {
                font-size: 1rem;
            }
        }
        /* Desktop-specific layout rules */
        @media (min-width: 1024px) {
            .lg\:text-left .question-group .flex {
                justify-content: flex-start;
            }
            .quote-display-mobile-first {
                order: unset;
            }
        }
        .highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .carrier-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .shipping-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .payment-option input[type="radio"]:not(:checked) + label.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .custom-checkbox input[type="checkbox"]:not(:checked) + .checkmark.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        /* Style for required select dropdown */
        #state:required:invalid:not(:focus) {
            color: #64748b; /* slate-500 for unselected placeholder text */
        }
        #state.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }

        /* --- STYLES FROM SECONDHANDCELL --- */
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; /* blue-100, blue-700 */
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        /* NEW: General modal structure for scrollable content */
        .modal-content-scroll {
            max-height: 90vh; /* Set a max height for the modal box itself */
            display: flex;
            flex-direction: column;
        }
        /* NEW: Style for the scrollable body of the content */
        .modal-content-body {
            overflow-y: auto;
            padding-right: 0.5rem; /* Space for the scrollbar */
        }

        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }
        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }
        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }
        .prose {
            max-width: 65ch;
            color: #334155; /* slate-700 */
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
                margin-bottom: 0.5em;
        }
        /* Specific styling for the Fully Functional Modal content (smaller font, scrolling) */
        #fullyFunctionalModal .prose p, 
        #fullyFunctionalModal .prose ul,
        #fullyFunctionalModal .prose li {
            font-size: 0.9rem; /* Slightly smaller text for info density */
        }
        #fullyFunctionalModal .prose h3 {
            font-size: 1.1rem;
        }
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            height: 200px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex-1">
                <a href="https://secondhandcell.com" class="h-16 inline-block">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png" alt="SecondHandCell Logo" class="h-full w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <!-- Updated header with the requested coloring -->
            <div class="hidden md:flex flex-col items-center flex-1">
                <div class="text-2xl font-extrabold">
                    <span class="text-black">Second</span><span style="color: #54a929;">HandCell</span>
                </div>
                <p class="text-sm -mt-1" style="color: #54a929;">Turn Your Old<span class="text-black"> Phone Into Cash!</span></p>
            </div>
            <nav class="flex items-center space-x-4 flex-1 justify-end">
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden">
                        <a href="https://secondhandcell.com/my-account.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-3xl shadow-xl flex flex-col lg:flex-row items-center justify-center gap-12 main-content-layout">
            <div class="w-full lg:w-2/5 text-center quote-display-mobile-first">
                <div class="relative w-full max-w-sm mx-auto mb-6 rounded-3xl shadow-lg overflow-hidden transform transition-transform duration-500 hover:scale-105">
                    <img id="deviceImage" data-base-src="" alt="" class="w-full h-full object-cover">
                </div>
                <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg hidden" id="mainQuoteDisplay">
                    <h2 class="text-3xl font-extrabold mb-2">Your Instant Quote</h2>
                    <p class="text-5xl font-extrabold" id="finalQuoteAmountMain">$0</p>
                    <p class="text-sm mt-2 opacity-80">Final offer subject to certified inspection.</p>
                </div>
            </div>

            <div class="w-full lg:w-3/5 text-center lg:text-left">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-4 sm:text-3xl">Sell Your <span id="deviceDisplayName"></span></h1>
                <p class="text-lg text-slate-600 mb-8 max-w-xl mx-auto lg:mx-0 sm:text-base">
                    Ready to sell your <span id="deviceDisplayNameText"></span>? Get an instant, competitive quote for your device today.
                    We offer a quick, transparent, and hassle-free process with free shipping and certified inspection.
                </p>
                
                <div id="loadingIndicator" class="loading-container">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                    <p class="text-slate-500">Loading device data...</p>
                </div>

                <div id="errorDisplay" class="loading-container hidden">
                    <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
                    <p class="text-lg text-red-500 font-semibold mb-4">Error: Device not found or invalid URL.</p>
                    <p class="text-slate-600 text-center">Please ensure you have navigated to this page from our device selection list, or the URL format is correct (e.g., `?device=iphone-15-pro`).</p>
                    <a href="https://secondhandcell.com/index.html" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">Go to Home Page</a>
                </div>

                <div id="questionContainer" class="space-y-6 hidden">

                    <div class="mb-8" id="storageSection">
                        <label class="block text-xl font-bold text-slate-800 mb-4 sm:text-lg">1. Select Storage Amount</label>
                        <div class="flex justify-center lg:justify-start">
                            <select id="storage" class="mt-1 block w-full md:w-1/2 px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select Storage</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-8 hidden" id="carrierSection">
                        <label class="block text-xl font-bold text-slate-800 mb-4 sm:text-lg">2. Select Your Carrier</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="carrierOptions">
                            <div class="carrier-option">
                                <input type="radio" id="att" name="carrier" value="att">
                                <label for="att" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-signal text-3xl text-indigo-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">AT&T</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="tmobile" name="carrier" value="tmobile">
                                <label for="tmobile" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-mobile-screen-button text-3xl text-pink-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">T-Mobile</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="verizon" name="carrier" value="verizon">
                                <label for="verizon" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-wifi text-3xl text-red-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Verizon</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="unlocked" name="carrier" value="unlocked">
                                <label for="unlocked" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-lock-open text-3xl text-teal-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Unlocked</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="other-carrier" name="carrier" value="other">
                                <label for="other-carrier" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-globe text-3xl text-yellow-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Other</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="powerOnSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">3. Does the device power on?</p>
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q1Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q1_power_on" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q1_power_on" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="functionalSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left flex items-center justify-center lg:justify-start sm:text-base">
                            4. Is the screen fully functional and free of defects?
                            <!-- MODIFIED: Replaced "(What's this?)" hyperlink text with Font Awesome info icon -->
                            <a href="#" id="functionalDetailsLink" class="ml-2 text-indigo-600 hover:text-indigo-800 transition-colors duration-200" aria-label="What does Fully Functional mean?">
                                <i class="fa-solid fa-circle-info text-xl"></i>
                            </a>
                        </p>
                        <!-- REMOVED: original functionalDetails div -->
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q2Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q2_fully_functional" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q2_fully_functional" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="cracksSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">5. Are the front and back free of cracks?</p>
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q3Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q3_no_cracks" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q3_no_cracks" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="cosmeticSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">6. Whatâ€™s the overall cosmetic condition?</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="q4Options">
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="flawless" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Flawless</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="good" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Good</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="fair" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Fair</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="damaged" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Damaged</span>
                            </label>
                        </div>
                        <div id="cosmeticConditionDescription" class="mt-4 p-3 bg-slate-100 rounded-md text-sm text-slate-700 text-left hidden sm:text-xs">
                        </div>
                    </div>
                </div>

                <div id="cta-section" class="flex flex-col items-center">
                    <button id="getQuoteBtn" class="btn-primary-blue w-full max-w-sm hidden">
                        Get My Instant Quote!
                    </button>
                    <div id="quoteMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full max-w-sm"></div>
                </div>

                <div id="nextSteps" class="mt-12 hidden flex flex-col items-center gap-8">
                    <div id="shippingSection" class="w-full">
                        <hr class="my-10 border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">7. How would you like to ship your device?</h2>
                        <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4" id="shippingOptions">
                            <div class="shipping-option">
                                <input type="radio" id="ship_kit" name="shipping_preference" value="ship_kit">
                                <label for="ship_kit" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <i class="fa-solid fa-box text-4xl text-indigo-600 mb-2 sm:text-2xl"></i>
                                    <span class="font-semibold block sm:text-sm">Ship Me a Box (Shipping Kit)</span>
                                    <p class="text-xs text-slate-500 mt-1">Receive a grey bag with a prepaid label and another grey bag inside to send your device to us.</p>
                                </label>
                            </div>
                            <div class="shipping-option">
                                <input type="radio" id="email_label" name="shipping_preference" value="email_label">
                                <label for="email_label" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <i class="fa-solid fa-envelope text-4xl text-green-600 mb-2 sm:text-2xl"></i>
                                    <span class="font-semibold block sm:text-sm">Email Me a Label (I have a box)</span>
                                    <p class="text-xs text-slate-500 mt-1">Receive a prepaid shipping label via email to print and use with your own packaging.</p>
                                </label>
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">8. Shipping Information</h2>
                        <div id="savedAddressesWrapper" class="mb-6 hidden">
                            <label for="savedAddressSelect" class="block text-sm font-medium text-slate-700 mb-2">Use a saved address</label>
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
                                <select id="savedAddressSelect" class="flex-1 border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="" selected>Choose a saved address</option>
                                </select>
                                <button type="button" id="useDifferentAddressBtn" class="btn-secondary-green px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap hidden w-full sm:w-auto">Use a different address</button>
                            </div>
                            <p id="savedAddressPreview" class="mt-2 text-sm text-slate-600 hidden"></p>
                        </div>
                        <div id="shippingFormFields" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- MODIFIED: Full Name now spans 2 columns for better focus on desktop -->
                            <div class="md:col-span-2">
                                <label for="fullName" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" id="fullName" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm" autocomplete="name">
                            </div>
                            <!-- NEW: Phone Number added as the third contact detail -->
                            <div>
                                <label for="phone" class="block text-sm font-medium text-slate-700">Phone Number (Required)</label>
                                <input type="tel" id="phone" required autocomplete="tel" placeholder="(555) 555-5555" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <!-- Email Address moved to the fourth slot (second column on desktop) -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" id="email" required autocomplete="email" placeholder="Email Address" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <!-- Street Address moved to the next row, spanning 2 columns -->
                            <div class="md:col-span-2">
                                <label for="street-address" class="block text-sm font-medium text-slate-700">Street Address</label>
                                <input type="text" id="street-address" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm" placeholder="Start typing your address..." autocomplete="street-address">
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium text-slate-700">City</label>
                                <input type="text" id="city" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm" autocomplete="address-level2">
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-slate-700">State (Required)</label>
                                <!-- MODIFIED: Uses required select dropdown -->
                                <select id="state" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="address-level1">
                                    <option value="" disabled selected>Select State</option>
                                </select>
                            </div>
                            <div>
                                <label for="zip-code" class="block text-sm font-medium text-slate-700">ZIP Code</label>
                                <input type="text" id="zip-code" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm" autocomplete="postal-code">
                            </div>
                        </div>

                        <div id="orderOverview" class="mt-8 p-6 bg-indigo-50 rounded-xl shadow-inner sm:p-4">
                            <h3 class="text-2xl font-bold text-indigo-800 mb-4 sm:text-xl">Order Overview</h3>
                            <div class="space-y-2 text-lg text-slate-700 sm:text-base">
                                <p><span class="font-semibold">Device:</span> <span id="overviewDevice"></span></p>
                                <p><span class="font-semibold">Carrier:</span> <span id="overviewCarrier">Not Selected</span></p>
                                <p><span class="font-semibold">Estimated Payout:</span> <span id="overviewQuote" class="text-indigo-600 font-bold">$0</span></p>
                                <p><span class="font-semibold">Shipping Preference:</span> <span id="overviewShippingPreference">Not Selected</span></p>
                                <!-- NEW: Overview item for Phone Number -->
                                <p><span class="font-semibold">Contact Phone:</span> <span id="overviewPhone">Not Entered</span></p>
                                <p><span class="font-semibold">Shipping Address:</span> <span id="overviewAddress">Not Entered</span></p>
                            </div>

                            <div class="mt-6 p-4 rounded-lg bg-white shadow-sm sm:p-3">
                                <label class="custom-checkbox flex items-start cursor-pointer">
                                    <input type="checkbox" id="termsAccepted">
                                    <span class="checkmark mt-1"></span>
                                    <span class="ml-4 text-sm text-slate-700 sm:text-xs">I accept the terms and conditions and certify that this device is not lost or stolen.</span>
                                </label>
                            </div>

                            <button id="sendPhoneBtn" class="btn-primary-indigo w-full mt-6">
                                Send Phone In Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="paymentModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative modal-content text-left">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">6. How would you like to get paid? </h2>
            
            <div class="mb-8 grid grid-cols-3 gap-4" id="paymentOptions">
                <div class="payment-option">
                    <input type="radio" id="venmo" name="payment_method" value="venmo">
                    <label for="venmo" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 512 512" class="h-10 w-10 mb-2 mx-auto sm:h-8 sm:w-8" aria-label="Venmo" role="img">
                            <rect width="512" height="512" rx="15%" fill="#3396cd"/>
                            <path d="m381.4 105.3c11 18.1 15.9 36.7 15.9 60.3 0 75.1-64.1 172.7-116.2 241.2h-118.8l-47.6-285 104.1-9.9 25.3 202.8c23.5-38.4 52.6-98.7 52.6-139.7 0-22.5-3.9-37.8-9.9-50.4z" fill="#fff"/>
                        </svg>
                        <span class="font-semibold block sm:text-sm">Venmo</span>
                    </label>
                </div>
                <div class="payment-option">
                    <input type="radio" id="zelle" name="payment_method" value="zelle">
                    <label for="zelle" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 48 48" class="h-10 w-10 mb-2 mx-auto sm:h-8 sm:w-8">
                            <path fill="#a0f" d="M35,42H13c-3.866,0-7-3.134-7-7V13c0-3.866,3.134-7,7-7h22c3.866,0,7,3.134,7,7v22 C42,38.866,38.866,42,35,42z"></path><path fill="#fff" d="M17.5,18.5h14c0.552,0,1-0.448,1-1V15c0-0.552-0.448-1-1-1h-14c-0.552,0-1,0.448-1,1v2.5 C16.5,18.052,16.948,18.5,17.5,18.5z"></path><path fill="#fff" d="M17,34.5h14.5c0.552,0,1-0.448,1-1V31c0-0.552-0.448-1-1-1H17c-0.552,0-1,0.448-1,1v2.5 C16,34.052,16.448,34.5,17,34.5z"></path><path fill="#fff" d="M22.25,11v6c0,0.276,0.5,0.5,0.5,0.5h3.5c0.276,0,0.5-0.224,0.5-0.5v-6c0-0.276-0.224-0.5-0.5-0.5 h-3.5C22.474,10.5,22.25,10.724,22.25,11z"></path><path fill="#fff" d="M22.25,32v6c0,0.276,0.224,0.5,0.5,0.5h3.5c0.276,0,0.5-0.224,0.5-0.5v-6c0-0.276-0.224-0.5-0.5-0.5 h-3.5C22.474,31.5,22.25,31.724,22.25,32z"></path><path fill="#fff" d="M16.578,30.938H22l10.294-12.839c0.178-0.222,0.019-0.552-0.266-0.552H26.5L16.275,30.298 C16.065,30.553,16.247,30.938,16.578,30.938z"></path>
                        </svg>
                        <span class="font-semibold block sm:text-sm">Zelle</span>
                    </label>
                </div>
                <div class="payment-option">
                    <input type="radio" id="paypal" name="payment_method" value="paypal">
                    <label for="paypal" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                        <i class="fa-brands fa-paypal text-4xl text-blue-600 mb-2 sm:text-2xl"></i>
                        <span class="font-semibold block sm:text-sm">PayPal</span>
                    </label>
                </div>
            </div>

            <div id="venmoFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">Venmo Details</h3>
                <div class="space-y-4">
                    <div>
                        <label for="venmoUsername" class="block text-sm font-medium text-slate-700">Venmo Username</label>
                        <input type="text" id="venmoUsername" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="venmoUsernameConfirm" class="block text-sm font-medium text-slate-700">Verify Venmo Username</label>
                        <input type="text" id="venmoUsernameConfirm" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <div id="zelleFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">Zelle Details</h3>
                <div class="space-y-4">
                    <div>
                        <label for="zelleIdentifier" class="block text-sm font-medium text-slate-700">Zelle Email or Phone Number</label>
                        <input type="text" id="zelleIdentifier" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="zelleIdentifierConfirm" class="block text-sm font-medium text-slate-700">Verify Zelle Email or Phone Number</label>
                        <input type="text" id="zelleIdentifierConfirm" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <div id="paypalFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">PayPal Details</h3>
                <div class="space-y-4">
                    <div>
                        <label for="paypalEmail" class="block text-sm font-medium text-slate-700">PayPal Email Address</label>
                        <input type="email" id="paypalEmail" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="paypalEmailConfirm" class="block text-sm font-medium text-slate-700">Verify PayPal Email Address</label>
                        <input type="email" id="paypalEmailConfirm" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>
            
            <button id="submitOrderBtn" class="btn-primary-indigo w-full mt-6 btn-disabled">
                Submit Order
            </button>
            <div id="paymentMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div>
        </div>
    </div>


    <div id="quoteModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content text-center">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="bg-red-100 text-red-800 p-3 rounded-lg mb-4 text-sm font-medium">
                Important: Devices cannot be lost, reported stolen, have an outstanding balance, or a blacklisted IMEI.
            </div>
            <h2 class="text-3xl font-extrabold text-indigo-800 mb-4 sm:text-2xl">Your Instant Quote!</h2>
            <p class="text-5xl font-extrabold text-indigo-600 mb-4 sm:text-4xl" id="finalQuoteAmountPopup">$0</p>
            <p class="text-md text-slate-600 mb-6 sm:text-sm">This is an estimate. Final offer subject to certified inspection.</p>
            <button id="quoteModalContinueBtn" class="btn-secondary-green w-full max-w-xs mx-auto">
                Continue
            </button>
        </div>
    </div>

    <!-- UPDATED: Fully Functional Definition Modal -->
    <div id="fullyFunctionalModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-xl p-6 relative modal-content modal-content-scroll">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex-shrink-0">What does "Fully Functional" mean?</h2>
            <div class="modal-content-body">
                <div class="prose max-w-none text-left">
                    <p class="font-semibold text-lg text-indigo-700 mb-3">For a device to qualify as **"Fully Functional"**, all of the following criteria must be met and pass our certified inspection:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2 text-slate-700">
                        <li>**Screen & Display:** The screen must work and fully light up (no dead pixels, discoloration, persistent image burn, or black dots/LCD damage).</li>
                        <li>**Original Parts:** The device must contain **all original manufacturer parts**. Devices with third-party, non-original, or aftermarket replacement parts will be considered "Not Functional" or "Damaged."</li>
                        <li>**Key Features:** All exterior buttons (power, volume, mute), front/back camera and flashes, speakers, and microphones must function correctly.</li>
                        <li>**Connectivity & Ports:** Headphone jack, charging port, Cellular, Wi-Fi, Bluetooth, and GPS must all work.</li>
                        <li>**Biometrics & Touch:** The touchscreen, voice commands, facial recognition (Face ID), and fingerprint sensor (Touch ID) must be fully operational.</li>
                        <li>**Battery Health:** The battery must hold a sufficient charge for normal operation.</li>
                    </ul>
                    <p class="mt-4 text-sm text-red-600 font-medium">If your device fails any of these checks, please select "No" to the functionality question for an accurate revised offer.</p>
                </div>
            </div>
        </div>
    </div>


    <div id="loginModal" class="modal fixed inset-0 z-50 flex justify-center items-start sm:items-center p-4 sm:p-6 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content my-8 sm:my-0 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Your SecondHandCell Account</h2>
            <div class="flex border-b border-slate-200 mb-6">
                <button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Login</button>
                <button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Sign Up</button>
            </div>
            <form id="loginForm" class="space-y-4">
                <p class="text-slate-600 text-center">Log in to continue with your order.</p>
                <button type="button" id="googleLoginBtn" class="btn-google-style">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">
                    Login with Google
                </button>
                <div class="text-center text-slate-500 relative my-4">
                    <span class="bg-white px-2 z-10 relative">or</span>
                    <hr class="absolute inset-0 top-1/2 border-t border-slate-200">
                </div>
                <div>
                    <label for="loginEmail" class="sr-only">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                </div>
                <div>
                    <label for="loginPassword" class="sr-only">Password</label>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password">
                </div>
                <button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button>
                <p class="text-center text-sm text-slate-600">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-blue-600 font-semibold hover:underline">Reset it here</a></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Create an account to complete your order.</p>
                <button type="button" id="googleSignupBtn" class="btn-google-style">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">
                    Sign Up with Google
                </button>
                <div class="text-center text-slate-500 relative my-4">
                    <span class="bg-white px-2 z-10 relative">or</span>
                    <hr class="absolute inset-0 top-1/2 border-t border-slate-200">
                </div>
                <div>
                    <label for="signupName" class="sr-only">Full Name</label>
                    <input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="name">
                </div>
                <div>
                    <label for="signupEmail" class="sr-only">Email Address</label>
                    <input type="email" id="signupEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                </div>
                <div>
                    <label for="signupPassword" class="sr-only">Password</label>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password">
                </div>
                <button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button>
                <p class="text-center text-sm text-slate-600">Already have an account? <a href="#" id="switchToLogin" class="text-blue-600 font-semibold hover:underline">Log in here</a></p>
            </form>
            <form id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Enter your email to receive a password reset link.</p>
                <div>
                    <label for="forgotEmail" class="sr-only">Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                </div>
                <button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button>
                <p class="text-center text-sm text-slate-600">Remember your password? <a href="#" id="returnToLogin" class="text-blue-600 font-semibold hover:underline">Return to Login</a></p>
            </form>
            <div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div>
            <button type="button" id="guestCheckoutBtn" class="btn-secondary-green w-full mt-4">Continue as Guest</button>
        </div>
    </div>

    <div id="aboutUsModal" class="modal fixed inset-0 z-50 flex justify-center items-start sm:items-center p-4 sm:p-6 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative modal-content my-8 sm:my-0 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">About Us</h2>
            <p class="text-slate-600">Welcome to SecondHandCell, where we believe in giving old tech a new life. Our mission is to make selling your used devices as simple, safe, and rewarding as possible. We offer competitive prices, a hassle-free process, and a commitment to sustainability.</p>
        </div>
    </div>


    <div id="privacyPolicyModal" class="modal fixed inset-0 z-50 flex justify-center items-start sm:items-center p-4 sm:p-6 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl p-8 relative modal-content modal-content-scroll my-8 sm:my-0 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex-shrink-0">Privacy Policy</h2>
            <div class="modal-content-body">
                <div class="prose max-w-none text-left">
                    <p><strong>Last Updated: September 30, 2025</strong></p>
                    <p>SecondHandCell ("we," "us," or "our") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website.</p>
                    <h3>Information We Collect</h3>
                    <p>We may collect personal information from you such as your name, email address, postal address, phone number, and payment information (e.g., Venmo, Zelle, or PayPal details). We also collect information about the device you are selling, including its model, serial number, and condition.</p>
                    <h3>How We Use Your Information</h3>
                    <p>We use the information we collect to: process your transactions; send you shipping kits and communicate about your order status; process payments; respond to customer service requests; send you marketing and promotional communications, with your consent.</p>
                    <h3>Data Security and Wiping</h3>
                    <p>We implement a variety of security measures to maintain the safety of your personal information. All devices sold to us undergo a certified, multi-pass data-wiping process to ensure your personal information is professionally and permanently erased.</p>
                    <h3>Disclosure of Your Information</h3>
                    <p>We do not sell, trade, or otherwise transfer to outside parties your Personally Identifiable Information except to trusted third parties who assist us in operating our website, conducting our business, or servicing you (such as shipping carriers), so long as those parties agree to keep this information confidential.</p>
                    <h3>Your Consent </h3>
                    <p>By using our site, you consent to our website's privacy policy.</p>
                </div>
            </div>
        </div>
    </div>


    <div id="termsAndConditionsModal" class="modal fixed inset-0 z-50 flex justify-center items-start sm:items-center p-4 sm:p-6 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl p-8 relative modal-content modal-content-scroll my-8 sm:my-0 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex-shrink-0">Terms &amp; Conditions</h2>
            <div class="modal-content-body">
                <div class="prose max-w-none text-left">
                    <p><strong>Last Updated: August 27, 2025</strong></p>
                    <p>Please read these Terms and Conditions ("Terms") carefully before using the SecondHandCell website ("Service") operated by us.</p>
                    <h3>1. User Obligations</h3>
                    <ul>
                        <li>You are the legal owner of the device you are selling.</li>
                        <li>The device is not reported as lost or stolen, and its IMEI is not blacklisted.</li>
                        <li>The device has no outstanding balance and is not subject to any financing or lease agreement.</li>
                        <li>All information you provide about the device is accurate and truthful.</li>
                    </ul>
                    <h3>2. The Offer Process</h3>
                    <ul>
                        <li>The initial quote provided on our website is an estimate based on the information you provide.</li>
                        <li>Upon receiving your device, we will conduct a thorough inspection. If the device's condition differs from what was described, we will issue a revised offer via email.</li>
                        <li><strong>The device must contain all original manufacturer parts to qualify for "Fully Functional." If non-original parts are detected during inspection, the device will be automatically reclassified as "Not Functional" or "Damaged," and a revised offer will be issued.</strong></li>
                        <li><strong>You have seven (7) days to accept or decline the revised offer. If you do not respond within this 7-day period, the revised offer will be automatically accepted on your behalf, and we will proceed with payment.</strong></li>
                        <li><strong>If we do not receive a response to our email communication, we may finalize your order at a payout reduced by seventy-five percent (75%) from the most recent quoted amount. The order will be marked completed and payment for the adjusted amount will be issued without additional approval.</strong></li>
                        <li>Once an offer (initial or revised) is accepted, it is locked in and final. There is no option for a re-offer or to have the device returned.</li>
                    </ul>
                    <h3>3. Shipping and Risk of Loss</h3>
                    <p>We provide a prepaid shipping label and materials. SecondHandCell is not responsible for any damage or loss that occurs before the device is received and scanned by our designated shipping carrier.</p>
                    <h3>4. Limitation of Liability</h3>
                    <p>In no event shall SecondHandCell, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
                    <hr class="my-6 border-t border-slate-300">
                    <h3>5. Policy on Lost/Stolen Devices &amp; Legal Compliance (New York State &amp; NYC)</h3>
                    <p>SecondHandCell is committed to operating in full compliance with all applicable laws and regulations regarding the purchase and sale of secondhand goods, particularly those concerning lost or stolen property. This section outlines our strict policy and the legal framework governing such transactions in New York State and New York City.</p>
                    <h4>Laws That May Apply (NY State + NYC)</h4>
                    <ul>
                        <li><strong>New York Penal Law Â§ 155.05(2)(b) â€“ Larceny by acquiring lost property:</strong> If someone acquires lost property and does not take reasonable measures to return it, it counts as larceny.</li>
                        <li><strong>New York Penal Law Â§ 165.40 â€“ Criminal possession of stolen property in the 5th degree:</strong> Knowingly possessing stolen property (or should reasonably know itâ€™s stolen) is a misdemeanor.</li>
                        <li><strong>New York City Administrative Code Â§ 20-272 et seq. (Secondhand Dealer Law):</strong> Dealers in secondhand goods must:
                            <ul>
                                <li>Keep records of all items received (including seller ID).</li>
                                <li>Provide daily reports to the NYPD of transactions (often through electronic reporting).</li>
                                <li>If police suspect an item is lost/stolen, you must hold and exhibit it to them.</li>
                            </ul>
                        </li>
                        <li><strong>New York City Administrative Code Â§ 20-273:</strong> It is unlawful to conceal, withhold, or refuse inspection of such goods.</li>
                        <li><strong>General Business Law (NY) GBL Â§ 89-g and following â€“ Regulation of pawnbrokers and secondhand dealers:</strong> Requires keeping detailed records and prohibits resale of items flagged as stolen/lost until cleared.</li>
                        <li><strong>Federal Considerations (18 U.S.C. Â§ 2315 â€“ Possession or sale of stolen property):</strong> If stolen goods (like phones) cross state lines or involve interstate commerce, federal law applies.</li>
                    </ul>
                    <h4>Process to Handle Lost/Stolen Phones in Your Buyback</h4>
                    <p>Hereâ€™s our step-by-step written policy to handle devices suspected of being lost or stolen:</p>
                    <h5>Intake &amp; Verification</h5>
                    <ul>
                        <li>Every device received must be checked against:
                            <ul>
                                <li>IMEI/serial number databases (e.g., GSMA, carrier blacklists).</li>
                                <li>Customerâ€™s government-issued ID at time of transaction.</li>
                            </ul>
                        </li>
                        <li>Record the transaction in compliance with NYC Secondhand Dealer laws.</li>
                    </ul>
                    <h5>If a Device is Flagged as Lost or Stolen</h5>
                    <ul>
                        <li>Immediately set the device aside and do not refurbish, resell, or dispose of it.</li>
                        <li>Clearly label it as â€œOn Hold â€“ Suspected Lost/Stolen.â€</li>
                    </ul>
                    <h5>Customer Communication</h5>
                    <ul>
                        <li>If the customer requests the item back:
                            <ul>
                                <li>Explain: â€œUnder New York law, we cannot return or release devices suspected to be lost or stolen. These items must be reported and may only be released by law enforcement.â€</li>
                            </ul>
                        </li>
                    </ul>
                    <h5>Law Enforcement Notification</h5>
                    <ul>
                        <li>Report the device to the NYPD Property Clerkâ€™s Office (or local precinct if outside NYC).</li>
                        <li>Provide transaction records, customer ID, and the device itself if requested.</li>
                    </ul>
                    <h5>Outcome</h5>
                    <ul>
                        <li>If police confirm the device is stolen:
                            <ul>
                                <li>It will be seized and returned to the rightful owner or carrier.</li>
                            </ul>
                        </li>
                        <li>If cleared:
                            <ul>
                                <li>You may proceed with processing the device as normal.</li>
                            </ul>
                        </li>
                    </ul>
                    <h5>Recordkeeping</h5>
                    <ul>
                        <li>Keep all paperwork of the transaction, report, and police correspondence for at least 5 years (per NYC dealer rules).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">SecondHandCell</h3>
                        <p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-slate-400 hover:text-white transition duration-300">Home</a></li>
                            <li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li>
                            <li><a href="#" id="privacyPolicyLink" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li>
                            <li><a href="#" id="termsAndConditionsLink" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Contact Us</h3>
                        <p class="text-slate-400">Email: support@secondhandcell.com</p>

                    </div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
                        <!-- Trust & accreditation badges -->
            <div class="mt-8">
                <div class="flex flex-wrap items-center justify-center gap-6 sm:flex-row sm:justify-center sm:gap-8 lg:justify-start">
                    <a href="https://www.sellcell.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" width="150" height="107" alt="SellCell Accredited Buyer" loading="lazy" class="h-20 w-auto object-contain">
                    </a>
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://cdn.trustpilot.net/brand-assets/4.1.0/stars/stars-5.png" alt="Trustpilot 5 star rating" loading="lazy" class="h-12 w-auto object-contain">
                    </a>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <script>
        // --- STATE DATA AND VALIDATION ---
        const US_STATES = [
            { name: "Alabama", code: "AL" }, { name: "Alaska", code: "AK" }, { name: "Arizona", code: "AZ" }, { name: "Arkansas", code: "AR" },
            { name: "California", code: "CA" }, { name: "Colorado", code: "CO" }, { name: "Connecticut", code: "CT" }, { name: "Delaware", code: "DE" },
            { name: "Florida", code: "FL" }, { name: "Georgia", code: "GA" }, { name: "Hawaii", code: "HI" }, { name: "Idaho", code: "ID" },
            { name: "Illinois", code: "IL" }, { name: "Indiana", code: "IN" }, { name: "Iowa", code: "IA" }, { name: "Kansas", code: "KS" },
            { name: "Kentucky", code: "KY" }, { name: "Louisiana", code: "LA" }, { name: "Maine", code: "ME" }, { name: "Maryland", code: "MD" },
            { name: "Massachusetts", code: "MA" }, { name: "Michigan", code: "MI" }, { name: "Minnesota", code: "MN" }, { name: "Mississippi", code: "MS" },
            { name: "Missouri", code: "MO" }, { name: "Montana", code: "MT" }, { name: "Nebraska", code: "NE" }, { name: "Nevada", code: "NV" },
            { name: "New Hampshire", code: "NH" }, { name: "New Jersey", code: "NJ" }, { name: "New Mexico", code: "NM" }, { name: "New York", code: "NY" },
            { name: "North Carolina", code: "NC" }, { name: "North Dakota", code: "ND" }, { name: "Ohio", code: "OH" }, { name: "Oklahoma", code: "OK" },
            { name: "Oregon", code: "OR" }, { name: "Pennsylvania", code: "PA" }, { name: "Rhode Island", code: "RI" }, { name: "South Carolina", code: "SC" },
            { name: "South Dakota", code: "SD" }, { name: "Tennessee", code: "TN" }, { name: "Texas", code: "TX" }, { name: "Utah", code: "UT" },
            { name: "Vermont", code: "VT" }, { name: "Virginia", code: "VA" }, { name: "Washington", code: "WA" }, { name: "West Virginia", code: "WV" },
            { name: "Wisconsin", code: "WI" }, { name: "Wyoming", code: "WY" }
        ];
        
        const AUTH_ERROR_MESSAGES = {
            'invalid-credential': 'The email or password you entered is incorrect.',
            'wrong-password': 'The email or password you entered is incorrect.',
            'user-not-found': "We couldn't find an account with that email address.",
            'invalid-email': 'Please enter a valid email address.',
            'missing-email': 'Please enter your email address.',
            'email-already-in-use': 'An account with this email already exists. Try logging in instead.',
            'weak-password': 'Your password must be at least 6 characters.',
            'popup-closed-by-user': 'The sign-in popup was closed before you finished. Please try again.',
            'popup-blocked': 'Your browser blocked the sign-in popup. Please allow popups and try again.',
            'network-request-failed': "We couldn't reach the server. Check your internet connection and try again.",
            'too-many-requests': 'Too many attempts have been made. Please wait a moment and try again.',
            'user-disabled': 'This account has been disabled. Contact our support team for assistance.'
        };

        function extractAuthCode(error) {
            if (!error) return null;
            if (typeof error.code === 'string') {
                return error.code.startsWith('auth/') ? error.code.slice(5) : error.code;
            }
            if (typeof error.message === 'string') {
                const match = error.message.match(/auth\/([^)]+)/);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        function formatAuthCodeToSentence(code) {
            if (!code) return '';
            const cleaned = code.replace(/-/g, ' ');
            return cleaned.charAt(0).toUpperCase() + cleaned.slice(1) + '.';
        }

        function getAuthErrorMessage(actionDescription, error) {
            const fallback = `We couldn't ${actionDescription}. Please try again.`;
            const code = extractAuthCode(error);
            if (!code) {
                return fallback;
            }
            const normalizedCode = code.toLowerCase();
            const friendly = AUTH_ERROR_MESSAGES[normalizedCode];
            if (friendly) {
                return `We couldn't ${actionDescription}. ${friendly}`;
            }
            return `We couldn't ${actionDescription}. ${formatAuthCodeToSentence(normalizedCode)}`;
        }

        // NEW: Function to populate the <select> element
        function populateStateSelect() {
            const selectElement = document.getElementById('state');
            if (!selectElement) return;
            
            const fragment = document.createDocumentFragment();

            US_STATES.forEach(state => {
                const option = document.createElement('option');
                // Value is the short code for easy order processing
                option.value = state.code;
                // Text includes both name and code for user convenience
                option.textContent = `${state.name} (${state.code})`;
                fragment.appendChild(option);
            });
            selectElement.appendChild(fragment);
        }

        // NEW: Function to extract brand and slug from a single URL parameter
        function getBrandAndSlug(param) {
            if (!param || typeof param !== 'string') return null;
            const parts = param.split('-');
            // Define supported brands for Firestore subcollection lookup
            const brands = ['iphone', 'samsung', 'google', 'ipad'];
            const brand = parts[0];
            
            if (brands.includes(brand) && parts.length > 1) {
                return {
                    brand: brand,
                    slug: parts.slice(1).join('-') // Rejoin the rest of the parts as the slug
                };
            }
            // If the brand is missing or unrecognized, or if there's no slug part, return null
            return null;
        }

        // Global variable to hold the autocomplete instance
        let autocomplete;

        // This function is called by the Google Maps script when it has loaded.
        function initAutocomplete() {
            // Get the input element
            const streetAddressInput = document.getElementById('street-address');
            
            // Create the autocomplete object, restricting the search to geographical location types.
            autocomplete = new google.maps.places.Autocomplete(streetAddressInput, {
                types: ['address'],
                componentRestrictions: { country: 'us' } // Restrict to US addresses
            });

            // When the user selects an address from the dropdown, populate the address fields in the form.
            autocomplete.addListener('place_changed', fillInAddress);
        }

        function fillInAddress() {
            // Get the place details from the autocomplete object.
            const place = autocomplete.getPlace();

            if (!place || !place.address_components) {
                console.warn("Autocomplete's returned place contains no address components");
                return;
            }

            // Get each component of the address from the place details,
            // and then fill-in the corresponding field on the form.
            const streetAddressInput = document.getElementById('street-address');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipCodeInput = document.getElementById('zip-code');

            // Clear out the fields first
            streetAddressInput.value = '';
            cityInput.value = '';
            stateInput.value = '';
            zipCodeInput.value = '';

            let streetNumber = '';
            let route = '';

            for (const component of place.address_components) {
                const componentType = component.types[0];

                switch (componentType) {
                    case 'street_number':
                        streetNumber = component.long_name;
                        break;
                    case 'route':
                        route = component.short_name;
                        break;
                    case 'locality':
                        cityInput.value = component.long_name;
                        break;
                    case 'administrative_area_level_1':
                        // Use the short name (two-letter code) for the state input
                        stateInput.value = component.short_name;
                        break;
                    case 'postal_code':
                        zipCodeInput.value = component.long_name;
                        break;
                }
            }
            
            streetAddressInput.value = `${streetNumber} ${route}`.trim();

            // Manually trigger an input event on each field to let other scripts know they've changed
            const event = new Event('input', { bubbles: true });
            streetAddressInput.dispatchEvent(event);
            cityInput.dispatchEvent(event);
            stateInput.dispatchEvent(event);
            zipCodeInput.dispatchEvent(event);
        }
        
        let device = null;
        let deviceInfo = null; // Declare globally to hold parsed info

        /**
         * Formats the phone number as the user types: (###) ###-####.
         * It restricts input to digits and automatically adds parentheses and dashes.
         * It handles optional leading '1' (country code).
         * @param {HTMLInputElement} input 
         */
        function formatPhoneNumber(input) {
            // 1. Get current value and strip all non-digits
            let cleaned = ('' + input.value).replace(/\D/g, '');
            
            // 2. Adjust for optional country code '1'
            if (cleaned.length === 11 && cleaned.startsWith('1')) {
                // If it's 11 digits and starts with '1', treat it as a US number with country code.
                cleaned = cleaned.substring(1);
            }
            
            // Limit to a maximum of 10 digits for formatting
            cleaned = cleaned.substring(0, 10);

            let formatted = '';

            // 3. Format based on the cleaned 10-digit number
            if (cleaned.length > 0) {
                // (XXX)
                formatted += '(' + cleaned.substring(0, 3);
            }
            if (cleaned.length >= 4) {
                // (XXX) XXX
                formatted += ') ' + cleaned.substring(3, 6);
            }
            if (cleaned.length >= 7) {
                // (XXX) XXX-XXXX
                formatted += '-' + cleaned.substring(6, 10);
            }

            // 4. Update the input value and limit length
            input.value = formatted;
            
            // Call updateOverview to update the display in real-time
            updateOverview();
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // --- UPDATED: Populate the state select on load ---
            populateStateSelect();
            
            // --- NEW: Add event listener for real-time phone formatting ---
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', () => formatPhoneNumber(phoneInput));
                // Set the max length to 14 characters: "(555) 555-5555"
                phoneInput.maxLength = 14;
            }
            // --- END NEW PHONE FORMATTING LISTENER ---


            const auth = window.firebaseAuth;
            const GoogleAuthProvider = window.GoogleAuthProvider;
            const signInWithPopup = window.signInWithPopup;
            const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
            const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
            const signOut = window.signOut;
            const onAuthStateChanged = window.onAuthStateChanged;
            const updateProfile = window.updateProfile;
            const sendPasswordResetEmail = window.sendPasswordResetEmail;
            const db = window.firebaseDb;
            const { doc, getDoc, collection, getDocs, setDoc, query, orderBy, limit } = window.firebase.firestore;
            const serverTimestamp = window.firebaseServerTimestamp;

            // --- DYNAMIC CONTENT SETUP ---
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionContainer = document.getElementById('questionContainer');
            const errorDisplay = document.getElementById('errorDisplay');
            
            // --- NEW ELEMENTS ---
            const functionalDetailsLink = document.getElementById('functionalDetailsLink');
            const fullyFunctionalModal = document.getElementById('fullyFunctionalModal');


            // Get device parameter from the URL query string
            const urlParams = new URLSearchParams(window.location.search);
            // This is the combined parameter (e.g., 'iphone-15-pro')
            const deviceParam = urlParams.get('device'); 
            
            // The following parameters are kept for compatibility with the old link format
            // which might still pass them, but they are generally ignored if deviceParam is used
            const storageParam = urlParams.get('storage');
            const carrierParam = urlParams.get('carrier');
            const powerParam = urlParams.get('power');
            const functionalityParam = urlParams.get('functionality');
            const qualityParam = urlParams.get('quality');
            const priceParam = urlParams.get('price');
            
            // Use the new robust parsing logic
            deviceInfo = getBrandAndSlug(deviceParam);

            // Log the URL parameters for debugging
            console.log('URL Parameters:', {
                deviceParam: deviceParam,
                parsedInfo: deviceInfo,
                storage: storageParam,
                carrier: carrierParam,
                //... rest of params
            });

            // Validate required parameters: We only need a successfully parsed brand and slug
            if (!deviceInfo || !deviceInfo.brand || !deviceInfo.slug) {
                loadingIndicator.classList.add('hidden');
                errorDisplay.classList.remove('hidden');
                console.error("Missing required parameters (device=brand-slug) or invalid URL format.");
                return;
            }

            // Populate remaining properties for initial form state loading if provided in URL (old behavior)
            deviceInfo.storage = storageParam;
            deviceInfo.carrier = carrierParam;
            deviceInfo.power = powerParam;
            deviceInfo.functionality = functionalityParam;
            deviceInfo.quality = qualityParam;
            deviceInfo.estimatedPrice = priceParam;

            async function fetchDevicePricing(brand, slug) {
                try {
                    // Use the parsed brand and slug for the Firestore path
                    const docRef = doc(db, `devices/${brand}/models`, slug);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        console.error(`Device data for slug "${slug}" not found in brand "${brand}".`);
                        return null;
                    }
                } catch (error) {
                    console.error("Error fetching document:", error);
                    return null;
                }
            }
            
            device = await fetchDevicePricing(deviceInfo.brand, deviceInfo.slug);
            
            if (!device) {
                loadingIndicator.classList.add('hidden');
                errorDisplay.classList.remove('hidden');
                // Update error message for clarity based on new structure
                document.querySelector('#errorDisplay p:nth-child(2)').textContent = 'Error: Device data not found.';
                return;
            }

            loadingIndicator.classList.add('hidden');
            questionContainer.classList.remove('hidden');

            document.title = `SecondHandCell - Sell ${device.name}`;
            
            // --- IMAGE LOADING LOGIC ---
            function loadImageWithFallback(imgElement) {
                const baseSrc = device.imageUrl; // Use the image URL retrieved from Firestore
                if (!baseSrc) {
                     imgElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
                     return;
                }
                // Use data-base-src to test extensions, but for single-file systems, direct set is cleaner
                // However, since the function uses new Image() and load/error, we keep it this way
                imgElement.dataset.baseSrc = baseSrc; 
                
                const extensions = ['.webp', '.avif', '.png', '.jpeg', '.jpg'];
                let current = 0;
                function tryLoad() {
                    if (current >= extensions.length) {
                        imgElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
                        return;
                    }
                    const testSrc = baseSrc + extensions[current];
                    const img = new Image();
                    img.onload = () => { imgElement.src = testSrc; };
                    img.onerror = () => { current++; tryLoad(); };
                    img.src = testSrc;
                }
                // Call the loading function only if a base URL is provided by Firestore
                tryLoad();
            }

            // Find the device image element
            const deviceImageElement = document.getElementById('deviceImage');
            if (deviceImageElement && device.imageUrl) {
                loadImageWithFallback(deviceImageElement);
            } else {
                deviceImageElement.src = 'https://placehold.co/200x200/e0e7ff/4338ca?text=No+Image';
            }
            
            document.getElementById('deviceImage').alt = device.name;
            document.getElementById('deviceDisplayName').textContent = device.name;
            document.getElementById('deviceDisplayNameText').textContent = device.name;
            document.getElementById('overviewDevice').textContent = device.name;

            const storageSelect = document.getElementById('storage');
            const fragment = document.createDocumentFragment();
            // Use the fetched device data to populate the storage options
            for (const storage in device.prices) {
                const option = document.createElement('option');
                option.value = storage;
                option.textContent = storage;
                fragment.appendChild(option);
            }
            storageSelect.innerHTML = '<option value="">Select Storage</option>';
            storageSelect.appendChild(fragment);
            
            const hasUrlPrefill = Boolean(deviceInfo.storage || deviceInfo.carrier || deviceInfo.power || deviceInfo.functionality || deviceInfo.quality);

            if (hasUrlPrefill) {
                console.log('Applying URL parameter prefill...', deviceInfo);

                setTimeout(() => {
                    const carrierSection = document.getElementById('carrierSection');
                    const powerOnSection = document.getElementById('powerOnSection');
                    const functionalSection = document.getElementById('functionalSection');
                    const cracksSection = document.getElementById('cracksSection');
                    const cosmeticSection = document.getElementById('cosmeticSection');
                    const getQuoteBtn = document.getElementById('getQuoteBtn');

                    const carrierMapping = {
                        unlocked: 'unlocked',
                        verizon: 'verizon',
                        att: 'att',
                        tmobile: 'tmobile',
                        other: 'other-carrier'
                    };

                    const carrierParam = typeof deviceInfo.carrier === 'string' ? deviceInfo.carrier.toLowerCase() : '';
                    const qualityValue = typeof deviceInfo.quality === 'string' ? deviceInfo.quality.toLowerCase() : '';

                    const storageOptionExists = deviceInfo.storage
                        ? Array.from(storageSelect.options).some(option => option.value === deviceInfo.storage)
                        : false;

                    if (deviceInfo.storage && storageOptionExists) {
                        storageSelect.value = deviceInfo.storage;
                        if (carrierSection) carrierSection.classList.remove('hidden');
                    } else if (carrierSection && (deviceInfo.carrier || deviceInfo.power || deviceInfo.functionality || deviceInfo.quality)) {
                        carrierSection.classList.remove('hidden');
                    }

                    let carrierSelected = false;
                    if (carrierParam) {
                        const normalizedCarrier = carrierMapping[carrierParam] || carrierParam;
                        const carrierRadio = document.querySelector(`input[name="carrier"][value="${carrierParam}"]`) ||
                            document.querySelector(`input[name="carrier"][value="${normalizedCarrier}"]`) ||
                            document.getElementById(normalizedCarrier);

                        if (carrierRadio) {
                            carrierRadio.checked = true;
                            carrierSelected = true;
                        }

                        if (carrierSection) {
                            carrierSection.classList.remove('hidden');
                        }
                    }

                    if (powerOnSection && (carrierSelected || deviceInfo.power || storageOptionExists)) {
                        powerOnSection.classList.remove('hidden');
                    }

                    let powerSelected = '';
                    if (deviceInfo.power) {
                        const powerValue = deviceInfo.power.toLowerCase();
                        const powerRadio = document.querySelector(`input[name="q1_power_on"][value="${powerValue}"]`);
                        if (powerRadio) {
                            powerRadio.checked = true;
                            powerSelected = powerValue;
                        }
                    }

                    if (!powerSelected) {
                        powerSelected = document.querySelector('input[name="q1_power_on"]:checked')?.value || '';
                    }

                    if (powerSelected === 'yes') {
                        if (functionalSection) {
                            functionalSection.classList.remove('hidden');
                        }

                        let functionalSelected = '';
                        if (deviceInfo.functionality) {
                            const functionalValue = deviceInfo.functionality === 'working' ? 'yes' : 'no';
                            const functionalRadio = document.querySelector(`input[name="q2_fully_functional"][value="${functionalValue}"]`);
                            if (functionalRadio) {
                                functionalRadio.checked = true;
                                functionalSelected = functionalValue;
                            }
                        }

                        if (!functionalSelected) {
                            functionalSelected = document.querySelector('input[name="q2_fully_functional"]:checked')?.value || '';
                        }

                        if (functionalSelected === 'yes') {
                            if (cracksSection) {
                                cracksSection.classList.remove('hidden');
                            }

                            if (qualityValue) {
                                const cracksValue = ['damaged', 'broken', 'cracked'].includes(qualityValue) ? 'no' : 'yes'; // "cracked" kept for legacy URLs
                                const cracksRadio = document.querySelector(`input[name="q3_no_cracks"][value="${cracksValue}"]`);
                                if (cracksRadio) {
                                    cracksRadio.checked = true;
                                }

                                if (cracksValue === 'yes') {
                                    if (cosmeticSection) {
                                        cosmeticSection.classList.remove('hidden');
                                    }

                                    const cosmeticMapping = {
                                        flawless: 'flawless',
                                        mint: 'flawless',
                                        new: 'flawless',
                                        pristine: 'flawless',
                                        good: 'good',
                                        great: 'good',
                                        excellent: 'good',
                                        gentlyused: 'good',
                                        scratched: 'good',
                                        fair: 'fair',
                                        average: 'fair',
                                        used: 'fair',
                                        worn: 'fair',
                                        damaged: 'damaged',
                                        cracked: 'damaged' // legacy quality option maps to damaged
                                    };

                                    const cosmeticValue = cosmeticMapping[qualityValue] || 'fair';
                                    const cosmeticRadio = document.querySelector(`input[name="q4_cosmetic_condition"][value="${cosmeticValue}"]`);
                                    if (cosmeticRadio) {
                                        cosmeticRadio.checked = true;
                                    }
                                } else if (cosmeticSection) {
                                    cosmeticSection.classList.add('hidden');
                                }
                            }
                        } else if (functionalSelected === 'no') {
                            if (cracksSection) {
                                cracksSection.classList.add('hidden');
                            }
                            if (cosmeticSection) {
                                cosmeticSection.classList.add('hidden');
                            }
                        }
                    } else if (powerSelected === 'no') {
                        if (functionalSection) {
                            functionalSection.classList.add('hidden');
                        }
                        if (cracksSection) {
                            cracksSection.classList.add('hidden');
                        }
                        if (cosmeticSection) {
                            cosmeticSection.classList.add('hidden');
                        }
                    }

                    const selectedStorage = document.getElementById('storage').value;
                    const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                    const selectedPower = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                    const selectedFunctional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                    const selectedCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                    const selectedCosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                    let hasAllAnswers = false;
                    if (selectedStorage && selectedCarrier && selectedPower) {
                        if (selectedPower === 'no') {
                            hasAllAnswers = true;
                        } else if (selectedFunctional) {
                            if (selectedFunctional === 'no') {
                                hasAllAnswers = true;
                            } else if (selectedCracks) {
                                if (selectedCracks === 'no') {
                                    hasAllAnswers = true;
                                } else if (selectedCosmetic) {
                                    hasAllAnswers = true;
                                }
                            }
                        }
                    }

                    if (hasAllAnswers && getQuoteBtn) {
                        getQuoteBtn.classList.remove('hidden');
                        setTimeout(() => {
                            getQuoteBtn.click();
                        }, 100);
                    }
                }, 100);
            }
            
            // --- REST OF THE CODE ---
            const getQuoteBtn = document.getElementById('getQuoteBtn');
            const quoteMessage = document.getElementById('quoteMessage');
            const nextSteps = document.getElementById('nextSteps');
            const finalQuoteAmountMainDisplay = document.getElementById('mainQuoteDisplay');
            const finalQuoteAmountMainText = document.getElementById('finalQuoteAmountMain');
            const finalQuoteAmountPopup = document.getElementById('finalQuoteAmountPopup');
            const shippingOptions = document.getElementById('shippingOptions');
            const overviewShippingPreference = document.getElementById('overviewShippingPreference');
            const overviewCarrier = document.getElementById('overviewCarrier');
            const overviewQuote = document.getElementById('overviewQuote');
            const overviewAddress = document.getElementById('overviewAddress');
            // NEW: Reference to Phone overview element
            const overviewPhone = document.getElementById('overviewPhone'); 
            const sendPhoneBtn = document.getElementById('sendPhoneBtn');
            const loginModal = document.getElementById('loginModal');
            // Using a more specific selector for the close button to avoid conflicts
            const closeLoginModalBtn = loginModal.querySelector('.close-modal-btn');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const signupTabBtn = document.getElementById('signupTabBtn');
            const guestCheckoutBtn = document.getElementById('guestCheckoutBtn');
            const loginNavBtn = document.getElementById('loginNavBtn');
            const quoteModal = document.getElementById('quoteModal');
            const quoteModalContinueBtn = document.getElementById('quoteModalContinueBtn');
            const authStatusContainer = document.getElementById('authStatusContainer');
            const userMonogram = document.getElementById('userMonogram');
            const authDropdown = document.getElementById('authDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const cosmeticConditionDescription = document.getElementById('cosmeticConditionDescription');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const emailSignupBtn = document.getElementById('emailSignupBtn');
            const signupNameInput = document.getElementById('signupName');
            const signupEmailInput = document.getElementById('signupEmail');
            const signupPasswordInput = document.getElementById('signupPassword');
            // Assuming signupPhone is not in the new modal, this will be null and should be handled.
            const signupPhoneInput = document.getElementById('signupPhone');
            const authMessage = document.getElementById('authMessage');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const switchToLogin = document.getElementById('switchToLogin');
            
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const forgotEmailInput = document.getElementById('forgotEmail');
            const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
            const returnToLoginLink = document.getElementById('returnToLogin');
            
            const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
            const footerPromoEmailInput = document.getElementById('footerPromoEmail');
            const footerSignupMessage = document.getElementById('footerSignupMessage');

            const fullNameInput = document.getElementById('fullName');
            const shippingInfoEmailInput = document.getElementById('email');
            // const phoneInput = document.getElementById('phone'); // Already defined above

            const streetAddressInput = document.getElementById('street-address');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipCodeInput = document.getElementById('zip-code');
            const SHIPPING_INFO_STORAGE_KEY = 'shc-shipping-info';
            const shippingFormFields = document.getElementById('shippingFormFields');
            const savedAddressesWrapper = document.getElementById('savedAddressesWrapper');
            const savedAddressSelect = document.getElementById('savedAddressSelect');
            const savedAddressPreview = document.getElementById('savedAddressPreview');
            const useDifferentAddressBtn = document.getElementById('useDifferentAddressBtn');
            let savedAddresses = [];
            let manualAddressMode = true;
            let manualModeExplicit = false;

            // New modal links
            const aboutUsLink = document.getElementById('aboutUsLink');
            const privacyPolicyLink = document.getElementById('privacyPolicyLink');
            const termsAndConditionsLink = document.getElementById('termsAndConditionsLink');
            
            // New payment modal elements
            const paymentModal = document.getElementById('paymentModal');
            const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
            const venmoFields = document.getElementById('venmoFields');
            const zelleFields = document.getElementById('zelleFields');
            const paypalFields = document.getElementById('paypalFields');
            const submitOrderBtn = document.getElementById('submitOrderBtn');
            const paymentMessage = document.getElementById('paymentMessage');

            let isUserLoggedIn = false;
            let isGuestCheckout = false;
            let currentUserId = null;
            let finalQuote = 0;
            
            // Basic modal controls for the new modals
            const openModal = (modalId) => document.getElementById(modalId)?.classList.add('is-visible');
            const closeModal = (modal) => modal?.classList.remove('is-visible');
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
                modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
            });

            if(aboutUsLink) aboutUsLink.addEventListener('click', (e) => { e.preventDefault(); openModal('aboutUsModal'); });
            if(privacyPolicyLink) privacyPolicyLink.addEventListener('click', (e) => { e.preventDefault(); openModal('privacyPolicyModal'); });
            if(termsAndConditionsLink) termsAndConditionsLink.addEventListener('click', (e) => { e.preventDefault(); openModal('termsAndConditionsModal'); });
            
            // Listener for the Functional Details Link
            if (functionalDetailsLink) {
                functionalDetailsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal('fullyFunctionalModal');
                });
            }


            function getRandomLightColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = Math.floor(Math.random() * 30) + 70;
                const lightness = Math.floor(Math.random() * 20) + 70;
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            onAuthStateChanged(auth, (user) => {
                const isRealUser = user && !user.isAnonymous;
                
                if (isRealUser) {
                    isUserLoggedIn = true;
                    isGuestCheckout = false;
                    currentUserId = user.uid;
                    console.log("User is logged in:", user.uid);
                    loginNavBtn.classList.add('hidden');
                    userMonogram.classList.remove('hidden');

                    const displayName = user.displayName;
                    const email = user.email;
                    let initials = '';

                    if (displayName) {
                        initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    } else if (email) {
                        const username = email.split('@')[0];
                        const nameParts = username.split('.');
                        initials = nameParts.map(part => part.charAt(0)).join('').toUpperCase().substring(0, 2);
                    }

                    userMonogram.textContent = initials;
                    
                    hideLoginModal();

                    if (shippingInfoEmailInput && user.email) {
                        shippingInfoEmailInput.value = user.email;
                    }

                    if (fullNameInput && !fullNameInput.value && displayName) {
                        fullNameInput.value = displayName;
                    }

                    saveShippingInfo();
                    updateOverview();

                    loadUserShippingDetails(user);

                    if (finalQuote > 0 && nextSteps.classList.contains('hidden')) {
                        nextSteps.classList.remove('hidden');
                        updateOverview();
                        nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    isUserLoggedIn = false;
                    isGuestCheckout = false;
                    currentUserId = null;
                    console.log("User is logged out.");
                    loginNavBtn.classList.remove('hidden');
                    userMonogram.classList.add('hidden');
                    userMonogram.textContent = '';
                    authDropdown.classList.add('hidden');

                    if (shippingInfoEmailInput) {
                        shippingInfoEmailInput.value = '';
                    }
                    loadSavedShippingInfo();
                    clearSavedAddressesUI();
                }
            });
            userMonogram.addEventListener('click', (e) => {
                e.stopPropagation();
                authDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!authStatusContainer.contains(e.target)) {
                    authDropdown.classList.add('hidden');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });

            const BACKEND_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

            function showAuthMessage(msg, type) {
                authMessage.textContent = msg;
                authMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    authMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    authMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    authMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                authMessage.classList.remove('hidden');
            }

            function clearAuthMessage() {
                authMessage.classList.add('hidden');
                authMessage.textContent = '';
            }

            function showLoginModal(initialTab = 'signup') {
                openModal('loginModal');
                clearAuthMessage();
                showTab(initialTab);
            }

            function hideLoginModal() {
                closeModal(document.getElementById('loginModal'));
            }

            function showTab(tabName) {
                clearAuthMessage();
                loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                loginTabBtn.classList.add('border-transparent', 'text-slate-500');
                signupTabBtn.classList.add('border-transparent', 'text-slate-500');

                if (tabName === 'login') {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    loginTabBtn.classList.add('border-blue-600', 'text-blue-600');
                    signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                } else if (tabName === 'signup') {
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    signupTabBtn.classList.add('border-blue-600', 'text-blue-600');
                    loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                } else if (tabName === 'forgotPassword') {
                    forgotPasswordForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    signupForm.classList.add('hidden');
                    loginTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                    signupTabBtn.classList.remove('border-blue-600', 'text-blue-600');
                }
            }


            function showQuotePopup() {
                quoteModal.classList.add('is-visible');
            }

            function hideQuotePopup() {
                quoteModal.classList.remove('is-visible');
            }

            if(closeLoginModalBtn) closeLoginModalBtn.addEventListener('click', hideLoginModal);
            
            loginTabBtn.addEventListener('click', () => {
                showTab('login');
            });
            signupTabBtn.addEventListener('click', () => {
                showTab('signup');
            });
            loginNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showLoginModal('login');
            });
            if (guestCheckoutBtn) {
                guestCheckoutBtn.addEventListener('click', () => {
                    isGuestCheckout = true;
                    hideLoginModal();
                    if (finalQuote > 0) {
                        nextSteps.classList.remove('hidden');
                        updateOverview();
                        nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }

            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            returnToLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('forgotPassword');
            });

            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotEmailInput.value;
                if (!email) {
                    showAuthMessage('Please enter your email address.', 'error');
                    return;
                }
                
                try {
                    clearAuthMessage();
                    showAuthMessage('Sending password reset email...', 'info');
                    await sendPasswordResetEmail(auth, email);
                    showAuthMessage('A password reset link has been sent to your email. Check your inbox and spam folder.', 'success');
                    forgotEmailInput.value = '';
                } catch (error) {
                    console.error("Password reset error:", error);
                    showAuthMessage(getAuthErrorMessage('send the password reset email', error), 'error');
                }
            });

            quoteModalContinueBtn.addEventListener('click', () => {
                hideQuotePopup();
                finalQuoteAmountMainDisplay.classList.remove('hidden');
                if (isUserLoggedIn || isGuestCheckout) {
                    nextSteps.classList.remove('hidden');
                    updateOverview();
                    nextSteps.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    showLoginModal();
                }
            });

            const googleProvider = new GoogleAuthProvider();

            googleLoginBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing in with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google login error:", error);
                    showAuthMessage(getAuthErrorMessage('complete Google sign-in', error), 'error');
                }
            });

            googleSignupBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing up with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google signup error:", error);
                    showAuthMessage(getAuthErrorMessage('complete Google sign-up', error), 'error');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                if (!email || !password) {
                    showAuthMessage('Please enter both email and password.', 'error');
                    return;
                }
                try {
                    clearAuthMessage();
                    showAuthMessage('Logging in...', 'info');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Email login error:", error);
                    showAuthMessage(getAuthErrorMessage('log you in', error), 'error');
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = signupNameInput.value;
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;

                if (!name || !email || !password) {
                    showAuthMessage('Please enter your name, email, and password.', 'error');
                    return;
                }
                if (password.length < 6) {
                    showAuthMessage('Password should be at least 6 characters.', 'error');
                    return;
                }

                try {
                    clearAuthMessage();
                    showAuthMessage('Creating account...', 'info');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, {
                        displayName: name
                    });
                    showAuthMessage('Account created successfully! You are now logged in.', 'success');
                } catch (error) {
                    console.error("Email signup error:", error);
                    showAuthMessage(getAuthErrorMessage('create your account', error), 'error');
                }
            });


            function showQuoteMessage(msg, type) {
                quoteMessage.textContent = msg;
                quoteMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    quoteMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    quoteMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    quoteMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                quoteMessage.classList.remove('hidden');
            }

            function clearQuoteMessage() {
                quoteMessage.classList.add('hidden');
                quoteMessage.textContent = '';
            }
            
            function showPaymentMessage(msg, type) {
                paymentMessage.textContent = msg;
                paymentMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    paymentMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    paymentMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    paymentMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                paymentMessage.classList.remove('hidden');
            }
            
            function clearPaymentMessage() {
                paymentMessage.classList.add('hidden');
                paymentMessage.textContent = '';
            }


            function clearHighlights() {
                document.querySelectorAll('.highlight-missing').forEach(el => {
                    el.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.carrier-option label, .shipping-option label, .payment-option label').forEach(label => {
                    label.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.custom-checkbox .checkmark').forEach(checkmark => {
                    checkmark.classList.remove('highlight-missing');
                });
                document.getElementById('state').classList.remove('highlight-missing'); // Clear state input separately
            }

            const cosmeticDescriptions = {
                'flawless': 'Looks new with no signs of use. This is the best condition a used device can be in. There are no scratches, scuffs, or any other cosmetic imperfections visible to the naked eye. The device appears as if it just came out of its original packaging, offering a pristine aesthetic and feel.',
                'good': 'There may be a few light scuffs or scratches that are smaller than the size of a pencil eraser. These minor imperfections are typically on the casing or screen, but do not affect the device\'s functionality or overall aesthetic significantly. They are generally only noticeable upon close inspection and do not detract from the device\'s premium feel.',
                'fair': 'There are noticeable scratches or scuffs on the front and back. These could include multiple visible scratches, minor dents, or paint chips on the frame. While these cosmetic issues are more prominent, they do not impede the device\'s core functions, and the screen remains fully usable despite the marks.',
                'damaged': 'Major cosmetic damage includes cracked glass or back panels, bent frames, chips, dents, or sunbleaching. This category also covers devices with significant wear and tear, deep scratches, or other substantial visual defects that clearly impact the device\'s appearance. These issues are immediately apparent and go beyond normal wear, affecting the overall integrity and look of the device.'
            };

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedCondition = event.target.value;
                    const description = cosmeticDescriptions[selectedCondition];
                    if (description) {
                        cosmeticConditionDescription.textContent = description;
                        cosmeticConditionDescription.classList.remove('hidden');
                    } else {
                        cosmeticConditionDescription.classList.add('hidden');
                        cosmeticConditionDescription.textContent = '';
                    }
                });
            });

            const carrierSection = document.getElementById('carrierSection');
            const powerOnSection = document.getElementById('powerOnSection');
            const functionalSection = document.getElementById('functionalSection');
            const cracksSection = document.getElementById('cracksSection');
            const cosmeticSection = document.getElementById('cosmeticSection');
            
            // Helper function to uncheck all radios in a container
            function uncheckRadiosInContainer(container) {
                container.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
            }

            function hideAndClearQuestions(...sections) {
                sections.forEach(section => {
                    section.classList.add('hidden');
                    uncheckRadiosInContainer(section);
                });
            }

            function showAndClearQuestions(section) {
                section.classList.remove('hidden');
                uncheckRadiosInContainer(section);
            }
            
            function hideAllQuestions() {
                [carrierSection, powerOnSection, functionalSection, cracksSection, cosmeticSection, getQuoteBtn].forEach(el => {
                    el.classList.add('hidden');
                });
                uncheckRadiosInContainer(carrierSection);
                uncheckRadiosInContainer(powerOnSection);
                uncheckRadiosInContainer(functionalSection);
                uncheckRadiosInContainer(cracksSection);
                uncheckRadiosInContainer(cosmeticSection);
                clearQuoteMessage();
                finalQuoteAmountMainDisplay.classList.add('hidden');
                nextSteps.classList.add('hidden');
            }
            
            document.getElementById('storage').addEventListener('change', function() {
                if (this.value) {
                    carrierSection.classList.remove('hidden');
                    // Reset all dependent questions when storage changes
                    hideAndClearQuestions(powerOnSection, functionalSection, cracksSection, cosmeticSection);
                    getQuoteBtn.classList.add('hidden');
                    
                    clearQuoteMessage();
                    this.classList.remove('highlight-missing');
                    saveFormState();
                } else {
                    hideAllQuestions();
                }
            });
            
            document.querySelectorAll('input[name="carrier"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    powerOnSection.classList.remove('hidden');
                    // Reset all dependent questions when carrier changes
                    hideAndClearQuestions(functionalSection, cracksSection, cosmeticSection);
                    getQuoteBtn.classList.add('hidden');

                    clearQuoteMessage();
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q1_power_on"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        functionalSection.classList.remove('hidden');
                        // Reset all dependent questions when power on changes
                        hideAndClearQuestions(cracksSection, cosmeticSection);
                        getQuoteBtn.classList.add('hidden');

                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(functionalSection, cracksSection, cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });
            
            document.querySelectorAll('input[name="q2_fully_functional"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cracksSection.classList.remove('hidden');
                        // Reset all dependent questions when functional changes
                        hideAndClearQuestions(cosmeticSection);
                        getQuoteBtn.classList.add('hidden');

                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(cracksSection, cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });
            
            document.querySelectorAll('input[name="q3_no_cracks"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cosmeticSection.classList.remove('hidden');
                        getQuoteBtn.classList.add('hidden');
                        clearQuoteMessage();
                    } else {
                        hideAndClearQuestions(cosmeticSection);
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    getQuoteBtn.classList.remove('hidden');
                    clearQuoteMessage();
                    saveFormState();
                });
            });
            
            function calculateQuoteAndDisplay() {
                clearQuoteMessage();
                clearHighlights();
                
                const selectedStorage = document.getElementById('storage').value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                const q1PowerOn = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                const q2Functional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                const q3NoCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                const q4Cosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                let hasError = false;

                if (!selectedStorage) {
                    document.getElementById('storage').classList.add('highlight-missing');
                    hasError = true;
                }
                if (!selectedCarrier) {
                    document.getElementById('carrierOptions').classList.add('highlight-missing');
                    hasError = true;
                }
                if (!q1PowerOn) {
                    document.getElementById('powerOnSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && !q2Functional) {
                    document.getElementById('functionalSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && !q3NoCracks) {
                    document.getElementById('cracksSection').classList.add('highlight-missing');
                    hasError = true;
                }
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'yes' && !q4Cosmetic) {
                    document.getElementById('cosmeticSection').classList.add('highlight-missing');
                    hasError = true;
                }

                if (hasError) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                // Determine the correct pricing key based on the selected carrier
                let selectedCarrierPricingKey = selectedCarrier;
                if (['att', 'tmobile', 'verizon', 'other'].includes(selectedCarrier)) {
                    selectedCarrierPricingKey = 'locked';
                }

                // Get the base prices for the selected storage and carrier from the fetched device data.
                const basePrices = device.prices[selectedStorage]?.[selectedCarrierPricingKey];
                
                if (!basePrices) {
                    showQuoteMessage('Pricing data for this combination is not available.', 'error');
                    return;
                }
                
                let finalPrice = 0;
                
                if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'yes') {
                    // Fully functional, no cracks
                    finalPrice = basePrices[q4Cosmetic];
                } else if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'no') {
                    // Fully functional, but has cracks
                    finalPrice = basePrices.damaged;
                } else if (q1PowerOn === 'yes' && q2Functional === 'no') {
                    // Powers on, but not functional
                    finalPrice = basePrices.broken;
                } else if (q1PowerOn === 'no') {
                    // Doesn't power on
                    finalPrice = basePrices.noPower;
                }
                
                finalQuote = finalPrice ? parseFloat(finalPrice.toFixed(2)) : 0;
                
                finalQuoteAmountMainText.textContent = `$${finalQuote.toFixed(2)}`;
                finalQuoteAmountPopup.textContent = `$${finalQuote.toFixed(2)}`;

                showQuotePopup();
            }

            getQuoteBtn.addEventListener('click', calculateQuoteAndDisplay);

            // Logic to handle the new payment modal and order submission
            function validatePaymentFields() {
                const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
                let isComplete = false;
                
                if (selectedPaymentMethod) {
                    if (selectedPaymentMethod === 'venmo') {
                        const username = document.getElementById('venmoUsername').value;
                        const usernameConfirm = document.getElementById('venmoUsernameConfirm').value;
                        isComplete = username && username === usernameConfirm;
                    } else if (selectedPaymentMethod === 'zelle') {
                        const identifier = document.getElementById('zelleIdentifier').value;
                        const identifierConfirm = document.getElementById('zelleIdentifierConfirm').value;
                        isComplete = identifier && identifier === identifierConfirm;
                    } else if (selectedPaymentMethod === 'paypal') {
                        const email = document.getElementById('paypalEmail').value;
                        const emailConfirm = document.getElementById('paypalEmailConfirm').value;
                        isComplete = email && email === emailConfirm;
                    }
                }
                return isComplete;
            }

            function updateSubmitButtonState() {
                if (validatePaymentFields()) {
                    submitOrderBtn.classList.remove('btn-disabled');
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.disabled = false;
                } else {
                    submitOrderBtn.classList.add('btn-disabled');
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.disabled = true;
                }
            }

            paymentOptions.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    venmoFields.classList.add('hidden');
                    zelleFields.classList.add('hidden');
                    paypalFields.classList.add('hidden');
                    
                    const selectedMethod = e.target.value;
                    if (selectedMethod === 'venmo') {
                        venmoFields.classList.remove('hidden');
                    } else if (selectedMethod === 'zelle') {
                        zelleFields.classList.remove('hidden');
                    } else if (selectedMethod === 'paypal') {
                        paypalFields.classList.remove('hidden');
                    }
                    updateSubmitButtonState();
                });
            });
            
            document.querySelectorAll('#paymentModal input').forEach(input => {
                input.addEventListener('input', () => {
                    clearPaymentMessage();
                    updateSubmitButtonState();
                });
            });
            
            // New logic for the "Send Phone In Now" button
            sendPhoneBtn.addEventListener('click', async () => {
                clearQuoteMessage();
                clearHighlights();

                saveShippingInfo();

                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked');
                const termsAccepted = document.getElementById('termsAccepted');
                const fullName = document.getElementById('fullName');
                const email = document.getElementById('email');
                const streetAddress = document.getElementById('street-address');
                const city = document.getElementById('city');
                const state = document.getElementById('state');
                const zipCode = document.getElementById('zip-code');
                
                let firstMissingElement = null;
                
                // --- UPDATED STATE VALIDATION (relies on select.value being non-empty) ---
                if (!state.value) { 
                    state.classList.add('highlight-missing'); 
                    if (!firstMissingElement) firstMissingElement = state; 
                } 
                // --- END UPDATED STATE VALIDATION ---

                if (!selectedShippingPreference) {
                    const shippingOptionsContainer = document.getElementById('shippingOptions');
                    if (shippingOptionsContainer) {
                        shippingOptionsContainer.classList.add('highlight-missing');
                        if (!firstMissingElement) firstMissingElement = shippingOptionsContainer;
                    }
                }
                
                // --- MODIFIED VALIDATION: Check phone length (14 chars = (###) ###-####) ---
                const cleanedPhone = phoneInput.value.replace(/\D/g, '');
                if (cleanedPhone.length !== 10) { 
                    phoneInput.classList.add('highlight-missing'); 
                    if (!firstMissingElement) firstMissingElement = phoneInput; 
                    showQuoteMessage('Please enter a complete 10-digit phone number.', 'error');
                    phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                // --- END MODIFIED VALIDATION ---

                if (!fullName.value) { fullName.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = fullName; }
                if (!email.value) { email.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = email; }
                if (!streetAddress.value) { streetAddress.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = streetAddress; }
                if (!city.value) { city.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = city; }
                if (!zipCode.value) { zipCode.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zipCode; }
                if (!termsAccepted.checked) {
                    document.querySelector('#orderOverview .checkmark').classList.add('highlight-missing');
                    if (!firstMissingElement) firstMissingElement = termsAccepted;
                }
                
                if (firstMissingElement) {
                    showQuoteMessage('Please fill out all required fields to proceed.', 'error');
                    firstMissingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // All fields are valid, open the payment modal
                openModal('paymentModal');
            });


            document.querySelectorAll('input[name="shipping_preference"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.shipping-option label').forEach(label => label.classList.remove('highlight-missing'));
                    updateOverview();
                    saveShippingInfo();
                });
            });

            const shippingInputs = Array.from(document.querySelectorAll('#shippingSection input, #shippingSection select'));
            const requiredShippingInputs = shippingInputs.filter(input => input.hasAttribute('required'));
            requiredShippingInputs.forEach(input => {
                input.dataset.wasRequired = 'true';
            });

            function updateShippingFieldRequirements(enabled) {
                requiredShippingInputs.forEach(input => {
                    if (!input.dataset.wasRequired) return;
                    if (enabled) {
                        input.setAttribute('required', '');
                    } else {
                        input.removeAttribute('required');
                    }
                });
            }

            function saveShippingInfo() {
                if (!fullNameInput || !streetAddressInput) return;
                try {
                    const selectedPreference = document.querySelector('input[name="shipping_preference"]:checked')?.value || '';
                    const payload = {
                        fullName: fullNameInput.value || '',
                        phone: phoneInput?.value || '',
                        email: shippingInfoEmailInput?.value || '',
                        streetAddress: streetAddressInput.value || '',
                        city: cityInput.value || '',
                        state: stateInput.value || '',
                        zipCode: zipCodeInput.value || '',
                        shippingPreference: selectedPreference
                    };
                    localStorage.setItem(SHIPPING_INFO_STORAGE_KEY, JSON.stringify(payload));
                } catch (error) {
                    console.warn('Unable to save shipping info', error);
                }
            }

            function loadSavedShippingInfo(force = false) {
                if (!fullNameInput) return;
                try {
                    const saved = localStorage.getItem(SHIPPING_INFO_STORAGE_KEY);
                    if (!saved) return;
                    const data = JSON.parse(saved);
                    if (data.fullName && (force || !fullNameInput.value)) {
                        fullNameInput.value = data.fullName;
                    }
                    if (phoneInput && data.phone && (force || !phoneInput.value)) {
                        phoneInput.value = data.phone;
                        formatPhoneNumber(phoneInput);
                    }
                    if (shippingInfoEmailInput && data.email && (force || !shippingInfoEmailInput.value)) {
                        shippingInfoEmailInput.value = data.email;
                    }
                    if (streetAddressInput && data.streetAddress && (force || !streetAddressInput.value)) {
                        streetAddressInput.value = data.streetAddress;
                    }
                    if (cityInput && data.city && (force || !cityInput.value)) {
                        cityInput.value = data.city;
                    }
                    if (stateInput && data.state && (force || !stateInput.value)) {
                        stateInput.value = data.state;
                    }
                    if (zipCodeInput && data.zipCode && (force || !zipCodeInput.value)) {
                        zipCodeInput.value = data.zipCode;
                    }
                    if (data.shippingPreference) {
                        const preferenceRadio = document.querySelector(`input[name=\"shipping_preference\"][value=\"${data.shippingPreference}\"]`);
                        if (preferenceRadio) {
                            preferenceRadio.checked = true;
                            preferenceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                    updateOverview();
                } catch (error) {
                    console.warn('Unable to load saved shipping info', error);
                }
            }

            function normalizeShippingInfoForStorage(info = {}) {
                const base = {
                    fullName: '',
                    email: '',
                    phone: '',
                    streetAddress: '',
                    city: '',
                    state: '',
                    zipCode: '',
                    shippingPreference: ''
                };

                if (!info || typeof info !== 'object') {
                    return { ...base };
                }

                const rawPreference = (info.shippingPreference || info.shipping_preference || info.preferredShipping || '')
                    .toString()
                    .trim()
                    .toLowerCase();

                let normalizedPreference = '';
                if (rawPreference === 'ship_kit' || rawPreference === 'shipping kit requested') {
                    normalizedPreference = 'ship_kit';
                } else if (rawPreference === 'email_label' || rawPreference === 'email label requested') {
                    normalizedPreference = 'email_label';
                }

                return {
                    ...base,
                    fullName: (info.fullName || '').toString().trim(),
                    email: (info.email || '').toString().trim(),
                    phone: (info.phone || '').toString().replace(/\D/g, ''),
                    streetAddress: (info.streetAddress || '').toString().trim(),
                    city: (info.city || '').toString().trim(),
                    state: (info.state || '').toString().trim().toUpperCase(),
                    zipCode: (info.zipCode || '').toString().trim(),
                    shippingPreference: normalizedPreference
                };
            }

            function formatPhoneFromDigits(phone) {
                const digits = (phone || '').toString().replace(/\D/g, '');
                if (digits.length !== 10) {
                    return digits;
                }
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }

            function buildAddressDocIdFromInfo(info = {}) {
                const normalized = normalizeShippingInfoForStorage(info);
                const sanitize = (value) => (value || '')
                    .toString()
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');

                const parts = [
                    normalized.streetAddress,
                    normalized.city,
                    normalized.state,
                    normalized.zipCode,
                    normalized.phone
                ].map(sanitize).filter(Boolean);

                let key = parts.join('-');
                if (!key) {
                    const fallback = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36);
                    key = `addr-${fallback}`;
                }
                if (key.length > 120) {
                    key = key.slice(0, 120).replace(/-+$/g, '');
                }
                return key || `addr-${Date.now().toString(36)}`;
            }

            function updateSavedAddressPreview(address) {
                if (!savedAddressPreview) return;
                if (!address) {
                    savedAddressPreview.classList.add('hidden');
                    savedAddressPreview.textContent = '';
                    return;
                }

                const normalized = normalizeShippingInfoForStorage(address);
                const segments = [];

                if (normalized.fullName) segments.push(normalized.fullName);
                if (normalized.streetAddress) segments.push(normalized.streetAddress);

                const cityState = [normalized.city, normalized.state].filter(Boolean).join(', ');
                const locationLine = [cityState, normalized.zipCode].filter(Boolean).join(' ');
                if (locationLine.trim()) segments.push(locationLine.trim());

                if (normalized.phone) segments.push(formatPhoneFromDigits(normalized.phone));
                if (normalized.email) segments.push(normalized.email);

                if (!segments.length) {
                    savedAddressPreview.classList.add('hidden');
                    savedAddressPreview.textContent = '';
                    return;
                }

                savedAddressPreview.textContent = segments.join(' â€¢ ');
                savedAddressPreview.classList.remove('hidden');
            }

            function setManualAddressMode(enabled, options = {}) {
                manualAddressMode = !!enabled;
                if (options.userInitiated === true) {
                    manualModeExplicit = manualAddressMode;
                } else if (!savedAddresses.length) {
                    manualModeExplicit = false;
                }

                if (shippingFormFields) {
                    shippingFormFields.classList.toggle('hidden', !manualAddressMode);
                }

                if (useDifferentAddressBtn) {
                    if (savedAddresses.length) {
                        useDifferentAddressBtn.classList.remove('hidden');
                        useDifferentAddressBtn.textContent = manualAddressMode ? 'Use saved address' : 'Use a different address';
                        useDifferentAddressBtn.setAttribute('aria-pressed', manualAddressMode ? 'true' : 'false');
                    } else {
                        useDifferentAddressBtn.classList.add('hidden');
                    }
                }

                updateShippingFieldRequirements(manualAddressMode);

                if (!manualAddressMode) {
                    const activeId = savedAddressSelect?.value;
                    const activeAddress = savedAddresses.find(address => address.id === activeId) || savedAddresses[0] || null;
                    if (activeAddress) {
                        applyShippingInfoToForm(activeAddress, { force: true });
                        updateSavedAddressPreview(activeAddress);
                    }
                }

                if (manualAddressMode && options.prefill) {
                    applyShippingInfoToForm(options.prefill, { force: true });
                }
            }

            function clearSavedAddressesUI() {
                savedAddresses = [];
                if (savedAddressSelect) {
                    savedAddressSelect.innerHTML = '<option value="" selected>Choose a saved address</option>';
                    savedAddressSelect.disabled = true;
                }
                if (savedAddressesWrapper) {
                    savedAddressesWrapper.classList.add('hidden');
                }
                if (useDifferentAddressBtn) {
                    useDifferentAddressBtn.classList.add('hidden');
                }
                updateSavedAddressPreview(null);
                manualModeExplicit = false;
                setManualAddressMode(true);
            }

            function buildAddressOptionLabel(address) {
                const normalized = normalizeShippingInfoForStorage(address);
                const parts = [];
                if (normalized.fullName) parts.push(normalized.fullName);
                if (normalized.streetAddress) parts.push(normalized.streetAddress);
                const cityState = [normalized.city, normalized.state].filter(Boolean).join(', ');
                const cityLine = [cityState, normalized.zipCode].filter(Boolean).join(' ');
                if (cityLine.trim()) parts.push(cityLine.trim());
                let label = parts.join(' â€¢ ') || 'Saved address';
                if (label.length > 80) {
                    label = `${label.slice(0, 77)}â€¦`;
                }
                return label;
            }

            function populateSavedAddresses(addresses = [], options = {}) {
                if (!savedAddressSelect || !savedAddressesWrapper) return;
                const { selectedId = '' } = options;
                savedAddresses = Array.isArray(addresses) ? addresses.map(address => ({ ...address })) : [];

                savedAddressSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = savedAddresses.length ? 'Choose a saved address' : 'No saved addresses yet';
                placeholder.selected = !selectedId;
                placeholder.disabled = !!savedAddresses.length;
                savedAddressSelect.appendChild(placeholder);

                savedAddresses.forEach(address => {
                    const option = document.createElement('option');
                    const addressId = address.id || buildAddressDocIdFromInfo(address);
                    if (!address.id) {
                        address.id = addressId;
                    }
                    option.value = addressId;
                    option.textContent = buildAddressOptionLabel(address);
                    if (addressId === selectedId) {
                        option.selected = true;
                    }
                    savedAddressSelect.appendChild(option);
                });

                if (savedAddresses.length) {
                    savedAddressesWrapper.classList.remove('hidden');
                    savedAddressSelect.disabled = false;
                    if (useDifferentAddressBtn) {
                        useDifferentAddressBtn.classList.remove('hidden');
                    }
                    setManualAddressMode(manualModeExplicit);
                    if (selectedId) {
                        const selected = savedAddresses.find(address => address.id === selectedId);
                        if (selected) {
                            updateSavedAddressPreview(selected);
                        }
                    } else {
                        updateSavedAddressPreview(null);
                    }
                } else {
                    savedAddressesWrapper.classList.add('hidden');
                    savedAddressSelect.disabled = true;
                    if (useDifferentAddressBtn) {
                        useDifferentAddressBtn.classList.add('hidden');
                    }
                    updateSavedAddressPreview(null);
                    setManualAddressMode(true);
                }
            }

            function applyShippingInfoToForm(info, options = {}) {
                const { force = false } = options || {};
                const normalized = normalizeShippingInfoForStorage(info);

                const setFieldValue = (input, value) => {
                    if (!input) return;
                    if (!force && input.value) return;
                    if (typeof value === 'undefined' || value === null) return;
                    input.value = value;
                };

                setFieldValue(fullNameInput, normalized.fullName);
                setFieldValue(shippingInfoEmailInput, normalized.email);

                if (phoneInput) {
                    if (normalized.phone) {
                        phoneInput.value = normalized.phone;
                        formatPhoneNumber(phoneInput);
                    } else if (force) {
                        phoneInput.value = '';
                    }
                }

                setFieldValue(streetAddressInput, normalized.streetAddress);
                setFieldValue(cityInput, normalized.city);

                if (stateInput) {
                    if ((force || !stateInput.value) && normalized.state) {
                        stateInput.value = normalized.state;
                    } else if (force && !normalized.state) {
                        stateInput.value = '';
                    }
                }

                setFieldValue(zipCodeInput, normalized.zipCode);

                const preferenceSelected = document.querySelector('input[name="shipping_preference"]:checked');
                if (normalized.shippingPreference && (force || !preferenceSelected)) {
                    const preferenceRadio = document.querySelector(`input[name="shipping_preference"][value="${normalized.shippingPreference}"]`);
                    if (preferenceRadio) {
                        preferenceRadio.checked = true;
                        preferenceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }

                updateOverview();
                saveShippingInfo();
            }

            function selectSavedAddress(addressId, options = {}) {
                const { force = true } = options || {};
                if (!savedAddressSelect) return;
                savedAddressSelect.value = addressId || '';
                if (!addressId) {
                    updateSavedAddressPreview(null);
                    return;
                }
                const selected = savedAddresses.find(address => String(address.id) === String(addressId));
                if (selected) {
                    applyShippingInfoToForm(selected, { force });
                    updateSavedAddressPreview(selected);
                    if (!manualModeExplicit) {
                        setManualAddressMode(false);
                    }
                }
            }

            async function fetchSavedAddressesForUser(userId) {
                if (!userId) return [];
                try {
                    const addressesRef = collection(db, `users/${userId}/savedAddresses`);
                    const addressQuery = query(addressesRef, orderBy('updatedAt', 'desc'), limit(5));
                    const snapshot = await getDocs(addressQuery);
                    const results = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data() || {};
                        results.push({ id: docSnap.id, ...normalizeShippingInfoForStorage(data) });
                    });
                    return results;
                } catch (error) {
                    console.warn('Unable to load saved addresses', error);
                    return [];
                }
            }

            async function persistShippingInfoForUser(userId, shippingInfo) {
                if (!userId) return null;
                const normalized = normalizeShippingInfoForStorage(shippingInfo);
                if (!normalized.fullName || !normalized.streetAddress || !normalized.city || !normalized.state || !normalized.zipCode) {
                    return null;
                }

                try {
                    const userDocRef = doc(db, `users/${userId}`);
                    await setDoc(userDocRef, {
                        lastShippingInfo: normalized,
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    const addressDocId = buildAddressDocIdFromInfo(normalized);
                    const addressDocRef = doc(db, `users/${userId}/savedAddresses/${addressDocId}`);
                    const existingSnapshot = await getDoc(addressDocRef);
                    const timestampPayload = existingSnapshot.exists()
                        ? { updatedAt: serverTimestamp() }
                        : { createdAt: serverTimestamp(), updatedAt: serverTimestamp() };

                    await setDoc(addressDocRef, { ...normalized, ...timestampPayload }, { merge: true });

                    return { id: addressDocId, ...normalized };
                } catch (error) {
                    console.warn('Unable to persist shipping info', error);
                    return null;
                }
            }

            async function loadUserShippingDetails(user) {
                if (!user || !user.uid) return;
                clearSavedAddressesUI();

                try {
                    const userId = user.uid;
                    const shippingFieldsEmpty = !fullNameInput?.value && !streetAddressInput?.value && !cityInput?.value && !stateInput?.value && !zipCodeInput?.value && !phoneInput?.value;

                    const [addresses, userDocSnapshot] = await Promise.all([
                        fetchSavedAddressesForUser(userId),
                        (async () => {
                            try {
                                const userDocRef = doc(db, `users/${userId}`);
                                const snapshot = await getDoc(userDocRef);
                                return snapshot.exists() ? snapshot.data() : null;
                            } catch (error) {
                                console.warn('Unable to fetch user profile details', error);
                                return null;
                            }
                        })()
                    ]);

                    populateSavedAddresses(addresses);

                    let lastShippingInfo = null;
                    if (userDocSnapshot && userDocSnapshot.lastShippingInfo) {
                        lastShippingInfo = normalizeShippingInfoForStorage(userDocSnapshot.lastShippingInfo);
                    }

                    if (shippingFieldsEmpty && addresses.length) {
                        selectSavedAddress(addresses[0].id, { force: true });
                    } else if (shippingFieldsEmpty && lastShippingInfo) {
                        applyShippingInfoToForm(lastShippingInfo, { force: true });
                        updateSavedAddressPreview(lastShippingInfo);
                    } else if (lastShippingInfo) {
                        updateSavedAddressPreview(lastShippingInfo);
                    }
                } catch (error) {
                    console.warn('Unable to load saved shipping details', error);
                    clearSavedAddressesUI();
                }
            }

            if (savedAddressSelect) {
                savedAddressSelect.addEventListener('change', () => {
                    const selectedId = savedAddressSelect.value;
                    if (!selectedId) {
                        updateSavedAddressPreview(null);
                        manualModeExplicit = true;
                        setManualAddressMode(true, { userInitiated: true });
                        return;
                    }
                    selectSavedAddress(selectedId, { force: true });
                    if (!manualModeExplicit) {
                        setManualAddressMode(false);
                    }
                });
            }

            if (useDifferentAddressBtn) {
                useDifferentAddressBtn.addEventListener('click', () => {
                    if (!savedAddresses.length) {
                        setManualAddressMode(true, { userInitiated: true });
                        return;
                    }

                    if (manualAddressMode) {
                        const fallback = savedAddressSelect?.value || (savedAddresses[0] && savedAddresses[0].id);
                        if (fallback) {
                            if (savedAddressSelect) {
                                savedAddressSelect.value = fallback;
                            }
                            selectSavedAddress(fallback, { force: true });
                        }
                        setManualAddressMode(false, { userInitiated: true });
                    } else {
                        const selected = savedAddresses.find(address => address.id === savedAddressSelect?.value) || savedAddresses[0] || null;
                        if (savedAddressSelect) {
                            savedAddressSelect.value = '';
                        }
                        updateSavedAddressPreview(null);
                        setManualAddressMode(true, { userInitiated: true, prefill: selected });
                        if (fullNameInput) {
                            fullNameInput.focus();
                        }
                    }
                });
            }

            const handleShippingInput = () => {
                updateOverview();
                saveShippingInfo();
            };

            shippingInputs.forEach(input => {
                input.addEventListener('input', handleShippingInput);
                input.addEventListener('change', handleShippingInput);
            });

            loadSavedShippingInfo();

            function updateOverview() {
                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked')?.value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                
                let displayShippingPreferenceText = 'Not Selected';
                if (selectedShippingPreference === 'ship_kit') {
                    displayShippingPreferenceText = 'Shipping Kit Requested';
                } else if (selectedShippingPreference === 'email_label') {
                    displayShippingPreferenceText = 'Email Label Requested';
                }

                let displayCarrierText = 'Not Selected';
                if (selectedCarrier) {
                    switch(selectedCarrier) {
                        case 'unlocked': displayCarrierText = 'Unlocked'; break;
                        case 'att': displayCarrierText = 'AT&T'; break;
                        case 'tmobile': displayCarrierText = 'T-Mobile'; break;
                        case 'verizon': displayCarrierText = 'Verizon'; break;
                        case 'other': displayCarrierText = 'Other Locked Carrier'; break;
                        default: displayCarrierText = 'Not Selected';
                    }
                }

                const fullName = fullNameInput?.value || '';
                const phone = phoneInput?.value || '';
                const streetAddress = streetAddressInput?.value || '';
                const city = cityInput?.value || '';
                const state = stateInput?.value || '';
                const zipCode = zipCodeInput?.value || '';

                overviewQuote.textContent = `$${finalQuote.toFixed(2)}`;
                overviewShippingPreference.textContent = displayShippingPreferenceText;
                overviewCarrier.textContent = displayCarrierText;
                
                // NEW: Update phone overview display
                overviewPhone.textContent = phone || 'Not Entered';

                const fullAddress = [fullName, streetAddress, city, state, zipCode].filter(Boolean).join(', ');
                overviewAddress.textContent = fullAddress || 'Not Entered';
            }

            submitOrderBtn.addEventListener('click', async () => {
                clearPaymentMessage();
                clearHighlights();

                const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                let firstMissingElement = null;

                if (!selectedPayment) {
                    const paymentOptionsContainer = document.getElementById('paymentOptions');
                    paymentOptionsContainer.classList.add('highlight-missing');
                    firstMissingElement = paymentOptionsContainer;
                } else {
                    if (selectedPayment.value === 'venmo') {
                        const venmoUsername = document.getElementById('venmoUsername');
                        const venmoUsernameConfirm = document.getElementById('venmoUsernameConfirm');
                        if (!venmoUsername.value) { venmoUsername.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = venmoUsername; }
                        if (!venmoUsernameConfirm.value || venmoUsername.value !== venmoUsernameConfirm.value) { venmoUsernameConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = venmoUsernameConfirm; }
                    } else if (selectedPayment.value === 'zelle') {
                        const zelleIdentifier = document.getElementById('zelleIdentifier');
                        const zelleIdentifierConfirm = document.getElementById('zelleIdentifierConfirm');
                        if (!zelleIdentifier.value) { zelleIdentifier.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zelleIdentifier; }
                        if (!zelleIdentifierConfirm.value || zelleIdentifier.value !== zelleIdentifierConfirm.value) { zelleIdentifierConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zelleIdentifierConfirm; }
                    } else if (selectedPayment.value === 'paypal') {
                        const paypalEmail = document.getElementById('paypalEmail');
                        const paypalEmailConfirm = document.getElementById('paypalEmailConfirm');
                        if (!paypalEmail.value) { paypalEmail.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = paypalEmail; }
                        if (!paypalEmailConfirm.value || paypalEmail.value !== paypalEmailConfirm.value) { paypalEmailConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = paypalEmailConfirm; }
                    }
                }
                
                if (firstMissingElement) {
                    showPaymentMessage('Please fill out all required fields to proceed.', 'error');
                    firstMissingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                submitOrderBtn.disabled = true;
                submitOrderBtn.textContent = 'Order Submitting...';
                submitOrderBtn.classList.remove('btn-primary-indigo');
                submitOrderBtn.classList.add('btn-disabled');
                
                const rawShippingPreference = document.querySelector('input[name="shipping_preference"]:checked').value;

                const orderData = {
                    device: device.name,
                    brand: deviceInfo.brand, // FIXED: Use parsed brand from deviceInfo
                    modelSlug: deviceInfo.slug,
                    carrier: document.querySelector('input[name="carrier"]:checked').value,
                    storage: document.getElementById('storage').value,
                    condition_power_on: document.querySelector('input[name="q1_power_on"]:checked').value,
                    condition_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value || 'N/A',
                    condition_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value || 'N/A',
                    condition_cosmetic: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value || 'N/A',
                    estimatedQuote: finalQuote,
                    shippingPreference: rawShippingPreference === 'ship_kit' ? 'Shipping Kit Requested' : 'Email Label Requested',
                    paymentMethod: selectedPayment.value,
                    paymentDetails: {},
                    shippingInfo: {
                        fullName: document.getElementById('fullName').value,
                        email: document.getElementById('email').value,
                        // MODIFIED: Store the cleaned, unformatted 10-digit number in Firebase
                        phone: phoneInput.value.replace(/\D/g, ''),
                        streetAddress: streetAddressInput.value,
                        city: cityInput.value,
                        state: stateInput.value, // Now guaranteed to be a 2-letter code
                        zipCode: zipCodeInput.value,
                        shippingPreference: rawShippingPreference
                    },
                    termsAccepted: document.getElementById('termsAccepted').checked,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                };
                
                // Add payment details to the order data
                if (selectedPayment.value === 'venmo') {
                    orderData.paymentDetails.venmoUsername = document.getElementById('venmoUsername').value;
                } else if (selectedPayment.value === 'zelle') {
                    orderData.paymentDetails.zelleIdentifier = document.getElementById('zelleIdentifier').value;
                } else if (selectedPayment.value === 'paypal') {
                    orderData.paymentDetails.paypalEmail = document.getElementById('paypalEmail').value;
                }
                
                try {
                    showPaymentMessage('Submitting your order...', 'info');
                    const response = await fetch(`${BACKEND_URL}/submit-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to submit order.');
                    }

                    if (isUserLoggedIn && currentUserId) {
                        try {
                            const persistedAddress = await persistShippingInfoForUser(currentUserId, orderData.shippingInfo);
                            if (persistedAddress) {
                                savedAddresses = savedAddresses.filter(address => address.id !== persistedAddress.id);
                                savedAddresses.unshift(persistedAddress);
                                populateSavedAddresses(savedAddresses, { selectedId: persistedAddress.id });
                            }
                        } catch (persistError) {
                            console.warn('Unable to cache shipping details for reuse', persistError);
                        }
                    }

                    // Get order ID from response and estimated price from deviceInfo or orderData
                    const orderId = result.orderId || result.id || Date.now().toString();
                    const totalPrice = deviceInfo.estimatedPrice || orderData.estimatedQuote || finalQuote || '0';

                    try {
                        const summaryPayload = {
                            orderId,
                            name: orderData.shippingInfo.fullName,
                            device: orderData.device,
                            storage: orderData.storage,
                            carrier: orderData.carrier,
                            price: Number(totalPrice) || 0,
                            paymentMethod: orderData.paymentMethod
                        };
                        sessionStorage.setItem('shcOrderSummary', JSON.stringify(summaryPayload));
                    } catch (storageError) {
                        console.warn('Unable to persist order summary to session storage:', storageError);
                    }

                    const queryParams = new URLSearchParams({
                        shipping: orderData.shippingPreference === 'Shipping Kit Requested' ? 'ship_kit' : 'email_label',
                        orderId,
                        price: totalPrice,
                        name: orderData.shippingInfo.fullName,
                        device: orderData.device,
                        storage: orderData.storage,
                        carrier: orderData.carrier,
                        paymentMethod: orderData.paymentMethod || ''
                    });

                    setTimeout(() => {
                        window.location.href = `https://secondhandcell.com/order-submitted.html?${queryParams.toString()}`;
                    }, 2000);
                    
                } catch (e) {
                    console.error("Error submitting order: ", e);
                    showPaymentMessage('There was an error submitting your order. Please try again.', 'error');
                    
                    submitOrderBtn.disabled = false;
                    submitOrderBtn.textContent = 'Submit Order';
                    submitOrderBtn.classList.remove('btn-disabled');
                    submitOrderBtn.classList.add('btn-primary-indigo');
                }
            });

            function saveFormState() {
                const formState = {
                    storage: document.getElementById('storage').value,
                    carrier: document.querySelector('input[name="carrier"]:checked')?.value,
                    q1_power_on: document.querySelector('input[name="q1_power_on"]:checked')?.value,
                    q2_fully_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value,
                    q3_no_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value,
                    q4_cosmetic_condition: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value,
                };
                // We're using localStorage for state persistence during page navigation or refresh.
                // Use the device brand and slug for the key since device info is now reliable
                localStorage.setItem(`${deviceInfo.brand}-${deviceInfo.slug}-FormState`, JSON.stringify(formState));
            }

            function loadFormState() {
                const savedState = localStorage.getItem(`${deviceInfo.brand}-${deviceInfo.slug}-FormState`);
                if (savedState) {
                    const formState = JSON.parse(savedState);
                    
                    const storageSelect = document.getElementById('storage');
                    storageSelect.value = formState.storage || '';
                    if (storageSelect.value) {
                           // unhide sections based on loaded state
                           carrierSection.classList.remove('hidden');
                           if (formState.carrier) {
                               powerOnSection.classList.remove('hidden');
                               if (formState.q1_power_on) {
                                   if (formState.q1_power_on === 'yes') {
                                       functionalSection.classList.remove('hidden');
                                       if (formState.q2_fully_functional === 'yes') {
                                           cracksSection.classList.remove('hidden');
                                           if (formState.q3_no_cracks === 'yes') {
                                               cosmeticSection.classList.remove('hidden');
                                               if (formState.q4_cosmetic_condition) {
                                                   getQuoteBtn.classList.remove('hidden');
                                               }
                                           } else { // cracks present (treated as damaged)
                                               cosmeticSection.classList.add('hidden');
                                               getQuoteBtn.classList.remove('hidden');
                                           }
                                       } else { // not functional
                                           cracksSection.classList.add('hidden');
                                           cosmeticSection.classList.add('hidden');
                                           getQuoteBtn.classList.remove('hidden');
                                       }
                                   } else { // no power
                                       functionalSection.classList.add('hidden');
                                       cracksSection.classList.add('hidden');
                                       cosmeticSection.classList.add('hidden');
                                       getQuoteBtn.classList.remove('hidden');
                                   }
                               }
                           }
                    }

                    // Re-check radio buttons
                    if (formState.carrier) {
                        const carrierRadio = document.querySelector(`input[name="carrier"][value="${formState.carrier}"]`);
                        if (carrierRadio) carrierRadio.checked = true;
                    }
                    if (formState.q1_power_on) {
                        const powerOnRadio = document.querySelector(`input[name="q1_power_on"][value="${formState.q1_power_on}"]`);
                        if (powerOnRadio) powerOnRadio.checked = true;
                    }
                    if (formState.q2_fully_functional) {
                        const functionalRadio = document.querySelector(`input[name="q2_fully_functional"][value="${formState.q2_fully_functional}"]`);
                        if (functionalRadio) functionalRadio.checked = true;
                    }
                    if (formState.q3_no_cracks) {
                        const cracksRadio = document.querySelector(`input[name="q3_no_cracks"][value="${formState.q3_no_cracks}"]`);
                        if (cracksRadio) cracksRadio.checked = true;
                    }
                    if (formState.q4_cosmetic_condition) {
                        const cosmeticRadio = document.querySelector(`input[name="q4_cosmetic_condition"][value="${formState.q4_cosmetic_condition}"]`);
                        if (cosmeticRadio) {
                            cosmeticRadio.checked = true;
                            cosmeticConditionDescription.textContent = cosmeticDescriptions[formState.q4_cosmetic_condition];
                            cosmeticConditionDescription.classList.remove('hidden');
                        }
                    }
                }
            }
            // Add event listener to footer email signup form
            if (footerEmailSignupForm) {
                footerEmailSignupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = footerPromoEmailInput.value;
                    const messageContainer = footerSignupMessage;
                    if (!email) {
                        messageContainer.textContent = 'Please enter a valid email address.';
                        messageContainer.className = 'mt-3 text-sm text-center text-red-500';
                        return;
                    }
                    try {
                        const response = await fetch(`${BACKEND_URL}/subscribe-to-newsletter`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            messageContainer.textContent = 'Thank you for subscribing!';
                            messageContainer.className = 'mt-3 text-sm text-center text-green-500';
                            footerPromoEmailInput.value = '';
                        } else {
                            throw new Error(result.error || 'Failed to subscribe.');
                        }
                    } catch (error) {
                        messageContainer.textContent = `Error: ${error.message}`;
                        messageContainer.className = 'mt-3 text-sm text-center text-red-500';
                    }
                });
            }

            // Only attempt to load form state if device data loaded successfully
            if (device) {
                 loadFormState();
            }
        });
    </script>

  <script defer src="/assets/js/cookie-consent.js"></script>
</body>
</html>
