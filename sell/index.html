<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecondHandCell - Sell Your Device</title>
    <link rel="icon" href="/favicon/favicon.ico">
    
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17534255111');
    </script>

    <style>
        :root {
            --brand-primary: #15803d;
            --brand-secondary: #eab308;
            --brand-gradient: linear-gradient(135deg, #15803d 0%, #eab308 100%);
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-gray: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
            --header-height: 80px; 
            
            /* Updated Loading Bar Colors */
            --progress-track: #bbf7d0; /* Light Green (Unfinished part) */
            --progress-fill: #15803d;  /* Dark Green (Finished part) */
            
            /* Neon Error Color */
            --neon-red: #ff3131;
        }

        .bg-brand-primary { background-color: var(--brand-primary); }
        .text-brand-primary { color: var(--brand-primary); }

        body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Material Progress Bar - Redesigned Positioning */
        @keyframes progress-bar-stripes {
            0% { background-position: 0 0; }
            to { background-position: 2rem 0; }
        }

        .mat-progress-bar {
            position: absolute;
            top: 100%; /* Sits exactly at the bottom edge of the nav bar */
            left: 0;
            width: 100%;
            height: 12px !important; /* Consistent height */
            background-color: var(--progress-track); 
            overflow: hidden;
            z-index: 50;
            display: block;
            margin: 0;
            padding: 0;
            border: none;
        }

        .mat-progress-bar-fill {
            height: 100%;
            width: 10%; /* Managed by JS */
            background-color: var(--progress-fill);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Stripes logic */
        .mat-progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            animation: progress-bar-stripes 1s linear infinite !important;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 2rem 2rem;
        }

        /* Spacing content to move below the header and progress bar */
        .sell-app-wrapper { 
            min-height: 60vh; 
            padding-top: 130px; /* Increased to account for the new bar position */
            padding-bottom: 80px;
        }
        
        .app-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .step-title { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 30px; color: var(--text-main); }
        
        .selection-grid { display: grid; gap: 15px; }
        .select-card {
            background: var(--white); border: 2px solid var(--border); border-radius: 12px;
            padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-card:hover:not(.disabled) { border-color: var(--brand-secondary); transform: translateY(-2px); }
        .select-card.active { border-color: var(--brand-primary); background: #f0fdf4; color: var(--brand-primary); box-shadow: 0 0 0 2px rgba(21, 128, 61, 0.2); outline: 2px solid var(--brand-primary); outline-offset: -2px; }
        
        .select-card.disabled { 
            opacity: 0.6; 
            cursor: help; 
            background: #f9fafb; 
            border-style: dashed; 
            filter: grayscale(0.5);
        }

        .shc-tooltip {
            visibility: hidden;
            background-color: #1e293b;
            color: #ffffff;
            text-align: center;
            border-radius: 8px;
            padding: 10px 14px;
            position: absolute;
            z-index: 50;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            font-size: 12px;
            line-height: 1.4;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .shc-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }

        .select-card.disabled:hover .shc-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .breadcrumbs-group { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 30px; }
        .breadcrumbs { display: flex; gap: 8px; font-size: 13px; justify-content: center; flex-wrap: wrap; }
        .breadcrumbs--labels { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
        .breadcrumbs--labels .crumb {
            background: transparent;
            color: #94a3b8;
            cursor: default;
            padding: 0;
        }
        .crumb { padding: 8px 16px; background: #e5e7eb; border-radius: 20px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .crumb.active { background: var(--brand-primary); color: white; cursor: default; }
        .crumb.filled { background: #dcfce7; color: var(--brand-primary); border: 1px solid var(--brand-primary); }

        .price-val { font-size: 54px; font-weight: 900; margin: 10px 0; color: var(--brand-primary); line-height: 1; }
        .req-box { text-align: left; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

        .form-control { width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        .form-control:focus { border-color: var(--brand-primary); }
        
        /* Neon Red Error Highlights */
        .form-control.error-highlight {
            border-color: var(--neon-red) !important;
            box-shadow: 0 0 12px var(--neon-red) !important;
        }
        .error-label {
            color: var(--neon-red);
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-align: left;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }

        .btn-primary {
            width: 100%; padding: 18px; background: var(--brand-gradient);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.01); }

        /* MODAL ANIMATIONS AND NEATER STYLING */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); 
            display: none; justify-content: center; align-items: center; 
            z-index: 2000; 
            backdrop-filter: blur(6px); /* Blurs background for high-end look */
            animation: fadeIn 0.2s ease-out;
        }
        .modal-card { 
            background: white; padding: 40px; border-radius: 24px; 
            text-align: center; max-width: 440px; width: 90%; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bounce slide up */
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }

        .scroll-target { scroll-margin-top: 150px; }

        .device-preview-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
        }
        .device-preview-card img {
            width: 72px;
            height: 72px;
            object-fit: contain;
        }
        @media (max-width: 640px) {
            .device-preview-card img { width: 56px; height: 56px; }
        }
        
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem; border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; font-weight: 700; cursor: pointer;
            font-size: 0.875rem; line-height: 1;
        }
    </style>
    <!-- Site Chrome logic -->
    <link rel="stylesheet" href="/assets/css/site-chrome.css">
</head>
<body class="bg-slate-50">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<!-- Navbar -->
<header class="site-header site-header--mobile-compact relative">
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav">
            <div id="authStatusContainer" class="site-header__auth-wrapper relative">
                <a href="/login.html" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden" onclick="document.getElementById('authDropdown').classList.toggle('hidden')"></div>
                <div id="authDropdown" class="auth-dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-100">
                    <a href="/my-account.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Account</a>
                    <button id="logoutBtn" type="button" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
                </div>
            </div>
        </nav>
    </div>
    
    <!-- BRANDED PROGRESS BAR - Positioned Top:100% to ensure no overlap -->
    <div class="mat-progress-bar">
        <div id="global-progress-bar" class="mat-progress-bar-fill" style="width: 10%;"></div>
    </div>
</header>

<main class="sell-app-wrapper">
    <!-- Selection Flow Container -->
    <div class="app-container scroll-target" id="selection-flow">
        <div class="breadcrumbs-group">
            <div class="breadcrumbs breadcrumbs--labels" id="crumb-labels"></div>
            <div class="breadcrumbs" id="crumbs"></div>
        </div>
        <div id="sell-cart-summary" class="hidden mb-6">
            <div class="device-preview-card justify-between">
                <div>
                    <div class="text-xs font-bold uppercase tracking-widest text-slate-400">Cart Ready</div>
                    <div class="text-lg font-black text-slate-900" id="sell-cart-count">0 devices</div>
                    <div class="text-sm text-slate-500" id="sell-cart-total">$0 total payout</div>
                </div>
                <button id="continueToCheckoutBtn" class="bg-green-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-green-700 transition">Continue to checkout</button>
            </div>
        </div>
        <div id="selected-device-preview" class="hidden mb-6">
            <div class="device-preview-card">
                <img id="selected-device-thumb" src="/assets/sellcell.webp" alt="Selected device" loading="lazy">
                <div>
                    <div class="text-xs font-bold uppercase tracking-widest text-slate-400">Selected Device</div>
                    <div class="text-lg font-black text-slate-900" id="selected-device-name">--</div>
                </div>
            </div>
        </div>
        <h2 class="step-title" id="step-name">Select Brand</h2>
        <div class="selection-grid" id="grid-content">
            <div class="col-span-full text-center py-10 text-slate-400">Loading selections...</div>
        </div>

        <!-- Inline Condition Help Box (Selection Flow) -->
        <div id="condition-help-box" class="hidden mt-10 p-6 bg-slate-50 border border-slate-200 rounded-3xl text-left max-w-[600px] mx-auto shadow-md">
            <div class="flex items-center gap-4 mb-6 p-4 bg-white border border-green-200 rounded-2xl">
                <div class="h-12 w-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xl">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <div>
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">You've Selected:</div>
                    <div class="font-black text-green-700 text-2xl" id="help-condition-name">--</div>
                </div>
            </div>
            
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Diagnostic Requirements:</div>
            <ul id="help-condition-desc" class="list-disc pl-5 space-y-3 text-slate-600 text-sm leading-relaxed"></ul>
            
            <div class="mt-8 flex justify-center text-xs font-bold uppercase tracking-widest text-slate-400">
                Quote updates automatically with your selection.
            </div>
        </div>
    </div>

    <!-- Final Offer View -->
    <div class="app-container hidden scroll-target" id="offer-view">
        <div class="breadcrumbs-group">
            <div class="breadcrumbs breadcrumbs--labels" id="final-crumb-labels"></div>
            <div class="breadcrumbs" id="final-crumbs"></div>
        </div>
        
        <!-- SIDE-BY-SIDE GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <!-- Left Side: Device & Condition Info (Col Span 2) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-8 rounded-2xl border border-gray-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <img id="final-device-image" src="/assets/sellcell.webp" alt="Selected device" loading="lazy" class="w-24 h-24 object-contain">
                        <div>
                            <h2 id="final-device-name" class="text-3xl font-black text-slate-900 leading-tight">--</h2>
                            <div id="summary-tags" class="text-xs text-green-700 font-bold uppercase tracking-widest mt-2 border-b pb-4"></div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <p class="text-sm font-bold text-slate-500 uppercase mb-4 tracking-wide">Adjust Condition:</p>
                        <div class="selection-grid" id="final-condition-grid"></div>
                    </div>
                </div>

                <div class="req-box bg-white shadow-sm">
                    <div class="font-black text-slate-800 mb-4 pb-2 border-b flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-green-600"></i>
                        <span id="condition-title-display">--</span> Requirements:
                    </div>
                    <ul id="condition-details" class="list-disc pl-5 space-y-3 text-slate-600 text-sm leading-relaxed"></ul>
                </div>
            </div>

            <!-- Right Side: Price & Checkout (Sticky Action Card) -->
            <div class="lg:sticky lg:top-[160px] space-y-4">
                <div id="final-quote-action-card" class="bg-white p-8 rounded-2xl border-2 border-green-600 shadow-xl text-center">
                    <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Your Final Offer:</div>
                    <div class="price-val mb-6" id="final-price">$0</div>

                    <div class="space-y-4">
                        <div class="text-left">
                            <div id="email-error-msg" class="error-label">Error: Valid Email Required</div>
                            <input type="email" id="user-email" class="form-control" placeholder="Enter email to save quote">
                        </div>
                        <button class="btn-primary" id="startCheckoutBtn">GET PAID INSTANTLY</button>
                        
                        <div class="pt-2">
                            <a href="/sell/index.html" id="resetFlowBtn" class="text-green-700 text-sm font-bold hover:underline inline-flex items-center gap-2">
                                <i class="fa-solid fa-arrow-left"></i> Start New Trade-in
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-center gap-3">
                    <i class="fa-solid fa-shield-halved text-indigo-600 text-xl"></i>
                    <p class="text-[11px] text-indigo-900 leading-tight font-medium">Your price is locked for 14 days once you submit your trade-in.</p>
                </div>
            </div>
            
        </div>
    </div>
</main>

<!-- Quantity Modal -->
<div class="modal-overlay" id="qty-modal">
    <div class="modal-card">
        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
            <i class="fa-solid fa-boxes-stacked"></i>
        </div>
        <h3 class="text-2xl font-black text-slate-900 mb-2">Quantity</h3>
        <p class="text-slate-500 mb-8 text-sm leading-relaxed px-4">How many of this exact device are you selling today?</p>
        
        <div class="flex justify-center items-center gap-8 mb-10">
            <button id="qtyMinus" class="w-14 h-14 rounded-2xl border-2 border-slate-200 text-slate-400 text-2xl font-bold hover:border-green-600 hover:text-green-600 transition-all active:scale-95 flex items-center justify-center">
                <i class="fa-solid fa-minus"></i>
            </button>
            <span id="qty-val" class="text-5xl font-black text-slate-900 min-w-[60px]">1</span>
            <button id="qtyPlus" class="w-14 h-14 rounded-2xl border-2 border-slate-200 text-slate-400 text-2xl font-bold hover:border-green-600 hover:text-green-600 transition-all active:scale-95 flex items-center justify-center">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
        
        <div class="space-y-3">
            <button class="btn-primary py-5 shadow-lg shadow-green-100" id="finalSubmitBtn">PROCEED TO SHIPPING</button>
            <button class="w-full py-3 border-2 border-slate-200 rounded-xl text-slate-600 text-sm font-bold hover:bg-slate-50 transition-colors" id="addAnotherDeviceBtn">Add another device</button>
            <button class="w-full py-3 text-slate-400 text-sm font-bold hover:text-slate-600 transition-colors" onclick="document.getElementById('qty-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<footer class="bg-slate-800 text-white mt-20">
    <div class="container mx-auto px-4 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="/" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="/about-us" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
            </div>
            <div class="bg-slate-700 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-2 text-white">Stay Updated </h3>
                <p class="text-slate-300 mb-4 text-sm">Sign up for promos and price increases!</p>
                <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                    <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Sign Up</button>
                </form>
            </div>
        </div>
        <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
            <p class="text-lg font-bold uppercase">IMPORTANT NOTICE</p>
            <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
        </div>
        <div class="mt-8 flex flex-wrap justify-center items-center gap-8">
            <a href="https://www.sellcell.com/" target="_blank" rel="noopener">
                <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" class="h-16 grayscale hover:grayscale-0 transition" alt="SellCell Accredited Buyer">
            </a>
            <img src="/assets/stars-5.svg" class="h-10" alt="Trustpilot 5 Star">
        </div>
        <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
        authDomain: "auth.secondhandcell.com",
        projectId: "buyback-a0f05",
        storageBucket: "buyback-a0f05.appspot.com",
        messagingSenderId: "876430429098",
        appId: "1:876430429098:web:f6dd64b1970d90461979d3",
        measurementId: "G-6WWQN44JHT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const BRAND_DISPLAY = {
        iphone: 'Apple iPhone',
        samsung: 'Samsung Galaxy',
        google: 'Google Pixel'
    };

    const BRAND_OPTIONS = [
        { key: 'iphone', label: 'iPhone' },
        { key: 'samsung', label: 'Samsung' },
        { key: 'google', label: 'Google Pixel' },
    ];

    const LOCK_LABELS = {
        unlocked: 'Unlocked',
        att: 'AT&T',
        verizon: 'Verizon',
        tmobile: 'T-Mobile',
        other: 'Other',
        locked: 'Carrier Locked',
    };

    const CARRIER_SORT_ORDER = ['tmobile', 'att', 'verizon', 'unlocked', 'other', 'locked'];

    const CONDITION_DEFS = [
        { 
            key: 'flawless', 
            name: 'Flawless', 
            desc: [
                'Looks new with no signs of use. This is the best condition a used device can be in.',
                'There are no scratches, scuffs, or any other cosmetic imperfections visible to the naked eye.',
                'The device appears as if it just came out of its original packaging.',
                '100% functional with all original manufacturer parts.',
                'iCloud / Activation Lock / Google Lock must be removed.',
                'Device must not be lost or stolen with a clean IMEI and no unpaid balance.'
            ] 
        },
        { 
            key: 'good', 
            name: 'Good', 
            desc: [
                'There may be a few light scuffs or scratches that are smaller than the size of a pencil eraser.',
                'These minor imperfections do not affect functionality or overall aesthetic.',
                'Generally only noticeable upon close inspection.',
                '100% functional and free of cracks.',
                'iCloud / Activation Lock / Google Lock must be removed.',
                'Device must not be lost or stolen with a clean IMEI and no unpaid balance.'
            ] 
        },
        { 
            key: 'fair', 
            name: 'Fair', 
            desc: [
                'Noticeable scratches or scuffs on the frame, front, or back.',
                'Could include multiple visible scratches, minor dents, or paint chips on the frame.',
                'Cosmetic issues do not impede core functions. The screen remains fully usable despite the marks.',
                '100% functional (no LCD defects or hardware failures).',
                'iCloud / Activation Lock / Google Lock must be removed.',
                'Device must not be lost or stolen with a clean IMEI and no unpaid balance.'
            ] 
        },
        { 
            key: 'broken', 
            name: 'Broken', 
            desc: [
                'Cracked glass (front or back), bent frame, or major visual defects.',
                'Does not power on, not fully functional, or has LCD damage (dead pixels/discoloration).',
                'Contains third-party, non-original, or aftermarket replacement parts.',
                'Includes devices with significant wear and tear that impact appearance.',
                'iCloud / Activation Lock / Google Lock must be removed.',
                'Device must not be lost or stolen with a clean IMEI and no unpaid balance.'
            ] 
        }
    ];

    const CONDITION_LABELS = {
        flawless: 'Flawless',
        good: 'Good',
        fair: 'Fair',
        broken: 'Broken'
    };

    const DEVICE_IMAGE_MAP = {
        'iphone-11': '/assets/i11.webp',
        'iphone-11-pro': '/assets/i11p.webp',
        'iphone-11-pro-max': '/assets/i11pm.webp',
        'iphone-12': '/assets/i12.webp',
        'iphone-12-mini': '/assets/i12m.webp',
        'iphone-12-pro': '/assets/i12p.webp',
        'iphone-12-pro-max': '/assets/i12pm.webp',
        'iphone-13': '/assets/i13.webp',
        'iphone-13-mini': '/assets/i13m.webp',
        'iphone-13-pro': '/assets/i13p.webp',
        'iphone-13-pro-max': '/assets/i13pm.webp',
        'iphone-14': '/assets/i14.webp',
        'iphone-14-plus': '/assets/i14pl.webp',
        'iphone-14-pro': '/assets/i14p.webp',
        'iphone-14-pro-max': '/assets/i14pm.webp',
        'iphone-15': '/assets/i15.webp',
        'iphone-15-plus': '/assets/i15pl.webp',
        'iphone-15-pro': '/assets/i15p.webp',
        'iphone-15-pro-max': '/assets/i15pm.webp',
        'iphone-16': '/assets/i16.webp',
        'iphone-16e': '/assets/i16e.webp',
        'iphone-16-plus': '/assets/i16pl.webp',
        'iphone-16-pro': '/assets/i16p.webp',
        'iphone-16-pro-max': '/assets/i16pm.webp',
        'iphone-se-2nd-gen': '/assets/ise2.webp',
        'iphone-se-3rd-gen': '/assets/ise3.webp',
        'iphone-x': '/assets/ix.webp',
        'iphone-xr': '/assets/ixr.webp',
        'iphone-xs': '/assets/ixs.webp',
        'iphone-xs-max': '/assets/ixsm.webp',
        'pixel-8': '/assets/gp8.webp',
        'samsung-galaxy-tab-s9-ultra': '/assets/tbs9u.webp'
    };

    const FALLBACK_DEVICE_IMAGE = '/assets/sellcell.webp';
    const CART_STORAGE_KEY = 'shc_cart';

    const state = {
        currentStep: 'brand',
        selections: { brand: '', model: '', modelName: '', storage: '', lock: '', condition: '', qty: 1, deviceSlug: '' },
        deviceData: null,
        modelsCache: {},
        isFinalView: false
    };

    const stepOrder = ['brand', 'model', 'storage', 'lock', 'condition'];

    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const loginBtn = document.getElementById('loginNavBtn');
        const monogram = document.getElementById('userMonogram');
        const emailInput = document.getElementById('user-email');

        if (user) {
            loginBtn.classList.add('hidden');
            monogram.classList.remove('hidden');
            
            // INITIALS LOGIC (2 LETTERS)
            let initials = 'U';
            if (user.displayName) {
                const parts = user.displayName.trim().split(/\s+/);
                if (parts.length > 1) {
                    initials = (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                } else {
                    initials = parts[0].slice(0, 2).toUpperCase();
                }
            } else if (user.email) {
                initials = user.email.slice(0, 2).toUpperCase();
            }
            monogram.textContent = initials;

            // Pre-fill email field for account holders but keep editable
            if (emailInput) {
                emailInput.value = user.email || '';
                emailInput.readOnly = false; // ALLOW CHANGING EVEN IF SIGNED IN
                emailInput.classList.remove('error-highlight');
                document.getElementById('email-error-msg').style.display = 'none';
            }
        } else {
            loginBtn.classList.remove('hidden');
            monogram.classList.add('hidden');
            if (emailInput) {
                emailInput.value = '';
                emailInput.readOnly = false;
            }
        }
    });

    const updateProgressBar = () => {
        const globalBar = document.getElementById('global-progress-bar');
        const steps = { 'brand': 10, 'model': 30, 'storage': 50, 'lock': 70, 'condition': 90 };
        const width = state.isFinalView ? '100%' : (steps[state.currentStep] || 10) + '%';
        if (globalBar) globalBar.style.width = width;
    };

    const updateURL = () => {
        const url = new URL(window.location);
        url.searchParams.delete('device');
        Object.entries(state.selections).forEach(([key, val]) => {
            if (key === 'deviceSlug') {
                if (val) url.searchParams.set('device', val);
                else url.searchParams.delete('device');
                return;
            }
            if (val && key !== 'qty' && key !== 'modelName') url.searchParams.set(key, val);
            else if (key !== 'qty' && key !== 'modelName') url.searchParams.delete(key);
        });
        window.history.replaceState({}, '', url);
    };

    const getModels = async (brand) => {
        if (state.modelsCache[brand]) return state.modelsCache[brand];
        const colRef = collection(db, "devices", brand, "models");
        const snap = await getDocs(colRef);
        const models = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.modelsCache[brand] = models;
        return models;
    };

    const parseStorageSize = (s) => {
        const val = parseInt(s);
        if (s.toLowerCase().includes('tb')) return val * 1024;
        return val;
    };

    const normalizeParam = (val) => (val || '').trim().toLowerCase();
    const slugify = (val) => normalizeParam(val).replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const getCart = () => {
        try {
            return JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');
        } catch (e) {
            return [];
        }
    };
    const saveCart = (cart) => {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    };
    const getDeviceImageUrl = (slug) => DEVICE_IMAGE_MAP[slug] || FALLBACK_DEVICE_IMAGE;
    const updateDevicePreview = () => {
        const preview = document.getElementById('selected-device-preview');
        const nameEl = document.getElementById('selected-device-name');
        const imgEl = document.getElementById('selected-device-thumb');
        if (!preview || !nameEl || !imgEl) return;
        if (state.selections.modelName) {
            const slug = state.selections.deviceSlug || slugify(state.selections.modelName);
            imgEl.src = getDeviceImageUrl(slug);
            imgEl.alt = `${state.selections.modelName} preview`;
            nameEl.textContent = state.selections.modelName;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    };
    const updateFinalDeviceImage = () => {
        const imgEl = document.getElementById('final-device-image');
        if (!imgEl) return;
        const slug = state.selections.deviceSlug || slugify(state.selections.modelName);
        imgEl.src = getDeviceImageUrl(slug);
        imgEl.alt = `${state.selections.modelName || 'Selected device'} image`;
    };
    const updateCartSummary = () => {
        const summary = document.getElementById('sell-cart-summary');
        const countEl = document.getElementById('sell-cart-count');
        const totalEl = document.getElementById('sell-cart-total');
        if (!summary || !countEl || !totalEl) return;
        const cart = getCart();
        if (!cart.length) {
            summary.classList.add('hidden');
            return;
        }
        const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        const total = cart.reduce((sum, item) => sum + (item.unitPrice * item.qty), 0);
        countEl.textContent = `${totalQty} device${totalQty === 1 ? '' : 's'} ready`;
        totalEl.textContent = `$${total.toFixed(2)} total payout`;
        summary.classList.remove('hidden');
    };
    const addCurrentDeviceToCart = () => {
        if (!state.deviceData) return;
        const priceMap = state.deviceData.prices?.[state.selections.storage]?.[state.selections.lock] || {};
        const unitPrice = Number(priceMap[state.selections.condition] || 0);
        const cart = getCart();
        const key = [
            state.selections.brand,
            state.selections.model,
            state.selections.storage,
            state.selections.lock,
            state.selections.condition
        ].join('|');
        const existing = cart.find(item => item.key === key);
        if (existing) {
            existing.qty += state.selections.qty;
        } else {
            cart.push({
                key,
                brand: state.selections.brand,
                model: state.selections.model,
                modelName: state.selections.modelName,
                deviceSlug: state.selections.deviceSlug || slugify(state.selections.modelName),
                storage: state.selections.storage,
                lock: state.selections.lock,
                condition: state.selections.condition,
                qty: state.selections.qty,
                unitPrice,
                conditionPrices: priceMap
            });
        }
        saveCart(cart);
        updateCartSummary();
    };
    const scrollToTarget = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        requestAnimationFrame(() => {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    };

    const jumpToStep = (step) => {
        state.isFinalView = false;
        state.currentStep = step;
        const stepIndex = stepOrder.indexOf(step);
        stepOrder.forEach((s, i) => {
            if (i >= stepIndex) {
                state.selections[s] = '';
                if (s === 'model') state.selections.modelName = '';
            }
        });
        if (stepIndex <= stepOrder.indexOf('model')) state.selections.deviceSlug = '';
        updateURL();
        document.getElementById('offer-view').classList.add('hidden');
        document.getElementById('selection-flow').classList.remove('hidden');
        document.getElementById('condition-help-box').classList.add('hidden');
        renderCurrentStep();
    };

    const applyGridCols = (grid, count) => {
        grid.classList.remove('grid-cols-1', 'grid-cols-2', 'grid-cols-3', 'md:grid-cols-4', 'max-w-[280px]', 'max-w-[500px]', 'max-w-[700px]', 'mx-auto');
        if (count === 1) grid.classList.add('grid-cols-1', 'max-w-[280px]', 'mx-auto');
        else if (count === 2) grid.classList.add('grid-cols-2', 'max-w-[500px]', 'mx-auto');
        else if (count === 3) grid.classList.add('grid-cols-3', 'max-w-[700px]', 'mx-auto');
        else grid.classList.add('grid-cols-2', 'md:grid-cols-4');
    };

    const renderCurrentStep = async () => {
        const grid = document.getElementById('grid-content');
        const title = document.getElementById('step-name');
        const helpBox = document.getElementById('condition-help-box');
        grid.innerHTML = '';
        updateCrumbs();
        updateProgressBar();

        if (state.currentStep === 'brand') {
            title.textContent = "Select Brand";
            BRAND_OPTIONS.forEach(b => createCard(grid, b.label, b.key));
            applyGridCols(grid, BRAND_OPTIONS.length);
        } 
        else if (state.currentStep === 'model') {
            title.textContent = `Select Model`;
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400">Fetching models...</div>';
            const models = await getModels(state.selections.brand);
            
            // NEWEST FIRST SORTING LOGIC
            models.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();

                // 1. Separate special models (like SE) to the bottom
                const isSpecialA = nameA.includes('se');
                const isSpecialB = nameB.includes('se');
                if (isSpecialA && !isSpecialB) return 1;
                if (!isSpecialA && isSpecialB) return -1;

                // 2. Extract major version numbers
                const extractNum = (s) => {
                    const match = s.match(/(\d+)/);
                    return match ? parseInt(match[0]) : 0;
                };
                const nA = extractNum(a.name);
                const nB = extractNum(b.name);

                // Sort descending by number (e.g., 16 > 15)
                if (nA !== nB) return nB - nA;

                // 3. Same generation sorting by tier weight
                const getTierWeight = (s) => {
                    if (s.includes('ultra')) return 10;
                    if (s.includes('pro max')) return 8;
                    if (s.includes('pro')) return 6;
                    if (s.includes('plus') || s.includes('+')) return 4;
                    return 2; // standard
                };
                return getTierWeight(nameB) - getTierWeight(nameA);
            });

            grid.innerHTML = '';
            models.forEach(m => createCard(grid, m.name, m.id));
            applyGridCols(grid, models.length);
        }
        else if (state.currentStep === 'storage') {
            title.textContent = "Select Capacity";
            const allStorageKeys = Object.keys(state.deviceData.prices || {});
            const sortedStorage = allStorageKeys.sort((a, b) => parseStorageSize(a) - parseStorageSize(b));
            const storageItems = sortedStorage.map(sKey => {
                const carrierMap = state.deviceData.prices[sKey] || {};
                const isPriceAvailable = Object.values(carrierMap).some(conditionPrices => {
                    return Object.values(conditionPrices).some(p => Number(p) > 0);
                });
                return { label: sKey, value: sKey, disabled: !isPriceAvailable };
            });
            storageItems.forEach(item => createCard(grid, item.label, item.value, item.disabled));
            applyGridCols(grid, storageItems.length);
        }
        else if (state.currentStep === 'lock') {
            title.textContent = "Select Network";
            const currentStorageMap = state.deviceData.prices[state.selections.storage] || {};
            const allLockKeys = Object.keys(currentStorageMap);
            const sortedLocks = allLockKeys.sort((a, b) => {
                const idxA = CARRIER_SORT_ORDER.indexOf(a.toLowerCase());
                const idxB = CARRIER_SORT_ORDER.indexOf(b.toLowerCase());
                return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
            });
            const lockItems = sortedLocks.map(lKey => {
                const conditionPrices = currentStorageMap[lKey] || {};
                const isPriceAvailable = Object.values(conditionPrices).some(p => Number(p) > 0);
                return { label: LOCK_LABELS[lKey] || lKey, value: lKey, disabled: !isPriceAvailable };
            });
            lockItems.forEach(item => createCard(grid, item.label, item.value, item.disabled));
            applyGridCols(grid, lockItems.length);
        }
        else if (state.currentStep === 'condition') {
            title.textContent = "Overall Condition";
            CONDITION_DEFS.forEach(c => createCard(grid, c.name, c.key));
            applyGridCols(grid, CONDITION_DEFS.length);
            if (state.selections.condition) updateConditionHelp();
        }
        updateDevicePreview();
        scrollToTarget('selection-flow');
    };

    const createCard = (container, label, value, isDisabled = false) => {
        const card = document.createElement('div');
        card.className = `select-card ${state.selections[state.currentStep] === value ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
        
        if (isDisabled) {
            card.innerHTML = `
                <i class="fa-solid fa-circle-info text-slate-400 mb-1"></i>
                <span>${label}</span>
                <div class="shc-tooltip">Sorry, we don't have any offers for this variant.</div>
            `;
        } else {
            card.textContent = label;
            card.onclick = () => handleSelection(value, label);
        }
        container.appendChild(card);
    };

    const handleSelection = async (value, label) => {
        const stepIndex = stepOrder.indexOf(state.currentStep);
        stepOrder.forEach((s, i) => { if (i > stepIndex) { state.selections[s] = ''; if (s === 'model') state.selections.modelName = ''; } });
        state.selections[state.currentStep] = value;
        if (state.currentStep === 'brand') {
            state.selections.deviceSlug = '';
        }
        if (state.currentStep === 'model') {
            state.selections.deviceSlug = value;
        }
        updateURL();
        
        if (state.currentStep === 'brand') { state.currentStep = 'model'; } 
        else if (state.currentStep === 'model') {
            state.selections.modelName = label;
            const snap = await getDoc(doc(db, "devices", state.selections.brand, "models", value));
            state.deviceData = snap.data();
            state.currentStep = 'storage';
        }
        else if (state.currentStep === 'storage') { state.currentStep = 'lock'; }
        else if (state.currentStep === 'lock') { state.currentStep = 'condition'; }
        else if (state.currentStep === 'condition') {
            showFinalOffer();
            return;
        }
        renderCurrentStep();
    };

    const updateConditionHelp = () => {
        const cond = CONDITION_DEFS.find(c => c.key === state.selections.condition);
        const helpBox = document.getElementById('condition-help-box');
        document.getElementById('help-condition-name').textContent = cond.name;
        document.getElementById('help-condition-desc').innerHTML = cond.desc.map(d => `<li>${d}</li>`).join('');
        helpBox.classList.remove('hidden');
        helpBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    };

    const updateCrumbs = () => {
        const crumbContainer = state.isFinalView ? document.getElementById('final-crumbs') : document.getElementById('crumbs');
        if (!crumbContainer) return;
        crumbContainer.innerHTML = '';
        const currentIdx = state.isFinalView ? stepOrder.length : stepOrder.indexOf(state.currentStep);
        const placeholderMap = {
            brand: 'Brand',
            model: 'Model',
            storage: 'Storage',
            lock: 'Lock',
            condition: 'Condition'
        };

        stepOrder.forEach((step, i) => {
            const span = document.createElement('span');
            span.className = `crumb ${i === currentIdx ? 'active' : ''} ${i < currentIdx ? 'filled' : ''}`;
            let valueLabel = placeholderMap[step] || step;
            if (i <= currentIdx) {
                if (step === 'brand') valueLabel = BRAND_OPTIONS.find(b => b.key === state.selections.brand)?.label || valueLabel;
                if (step === 'model') valueLabel = state.selections.modelName || valueLabel;
                if (step === 'storage') valueLabel = state.selections.storage || valueLabel;
                if (step === 'lock') valueLabel = LOCK_LABELS[state.selections.lock] || state.selections.lock || valueLabel;
                if (step === 'condition') valueLabel = CONDITION_DEFS.find(c => c.key === state.selections.condition)?.name || valueLabel;
            }
            span.textContent = valueLabel;
            if (i < currentIdx) span.onclick = () => jumpToStep(step);
            crumbContainer.appendChild(span);
        });
    };

    const showFinalOffer = () => {
        state.isFinalView = true;
        updateURL();
        updateProgressBar();
        document.getElementById('selection-flow').classList.add('hidden');
        document.getElementById('offer-view').classList.remove('hidden');
        const fullBrand = BRAND_DISPLAY[state.selections.brand] || '';
        document.getElementById('final-device-name').textContent = `${fullBrand} ${state.selections.modelName} ${state.selections.storage}`;
        document.getElementById('summary-tags').textContent = `Network: ${LOCK_LABELS[state.selections.lock] || state.selections.lock}`;
        updateFinalDeviceImage();
        renderConditionGrid();
        updatePrice();
        updateCrumbs();
        
        // Ensure email pre-fill logic is updated when switching to final view
        if (currentUser && currentUser.email) {
            const emailInput = document.getElementById('user-email');
            if (emailInput) {
                emailInput.value = currentUser.email;
                emailInput.readOnly = false; // KEEP EDITABLE EVEN WHEN SIGNED IN
            }
        }

        scrollToTarget('offer-view');
    };

    const renderConditionGrid = () => {
        const grid = document.getElementById('final-condition-grid');
        grid.innerHTML = '';
        CONDITION_DEFS.forEach(c => {
            const card = document.createElement('div');
            card.className = `select-card ${state.selections.condition === c.key ? 'active' : ''}`;
            card.textContent = c.name;
            card.onclick = () => { state.selections.condition = c.key; updateURL(); renderConditionGrid(); updatePrice(); };
            grid.appendChild(card);
        });
        applyGridCols(grid, CONDITION_DEFS.length);
    };

    const updatePrice = () => {
        const priceMap = state.deviceData.prices[state.selections.storage][state.selections.lock];
        const price = priceMap[state.selections.condition] || 0;
        document.getElementById('final-price').textContent = `$${price}`;
        const cond = CONDITION_DEFS.find(c => c.key === state.selections.condition);
        document.getElementById('condition-title-display').textContent = cond.name;
        document.getElementById('condition-details').innerHTML = (cond.desc || []).map(d => `<li>${d}</li>`).join('');
    };

    // EMAIL VALIDATION HANDLER
    document.getElementById('user-email').oninput = (e) => {
        const val = e.target.value;
        if (val.includes('@') && val.includes('.')) {
            e.target.classList.remove('error-highlight');
            document.getElementById('email-error-msg').style.display = 'none';
        }
    };

    document.getElementById('startCheckoutBtn').onclick = () => {
        const emailInput = document.getElementById('user-email');
        const errorLabel = document.getElementById('email-error-msg');
        const email = emailInput.value;
        
        if (!email.includes('@') || !email.includes('.')) {
            emailInput.classList.add('error-highlight');
            errorLabel.style.display = 'block';
            emailInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        document.getElementById('qty-modal').style.display = 'flex';
    };

    document.getElementById('qtyPlus').onclick = () => { state.selections.qty++; document.getElementById('qty-val').textContent = state.selections.qty; };
    document.getElementById('qtyMinus').onclick = () => { if(state.selections.qty > 1) state.selections.qty--; document.getElementById('qty-val').textContent = state.selections.qty; };
    document.getElementById('finalSubmitBtn').onclick = () => {
        addCurrentDeviceToCart();
        const finalData = { ...state.selections, email: document.getElementById('user-email').value };
        window.location.href = `/sell/checkout.html?${new URLSearchParams(finalData).toString()}`;
    };
    document.getElementById('addAnotherDeviceBtn').onclick = () => {
        addCurrentDeviceToCart();
        document.getElementById('qty-modal').style.display = 'none';
        jumpToStep('brand');
    };
    document.getElementById('resetFlowBtn').onclick = (e) => { e.preventDefault(); window.location.href = '/sell/index.html'; };
    document.getElementById('continueToCheckoutBtn').onclick = () => {
        window.location.href = '/sell/checkout.html';
    };

    const normalizeCarrier = (value) => {
        const carrier = normalizeParam(value).replace(/\s+/g, '');
        if (carrier.includes('t-mobile') || carrier.includes('tmobile')) return 'tmobile';
        if (carrier.includes('att') || carrier.includes('at&t')) return 'att';
        if (carrier.includes('verizon')) return 'verizon';
        if (carrier.includes('unlocked')) return 'unlocked';
        if (carrier.includes('locked')) return 'locked';
        if (carrier.includes('other')) return 'other';
        return carrier;
    };
    const mapQualityToCondition = (quality) => {
        const normalized = normalizeParam(quality);
        if (['flawless', 'excellent', 'like-new', 'likenew', 'mint'].includes(normalized)) return 'flawless';
        if (['good'].includes(normalized)) return 'good';
        if (['fair'].includes(normalized)) return 'fair';
        if (['broken', 'poor', 'damaged'].includes(normalized)) return 'broken';
        return '';
    };
    const findModelBySlug = async (slug, brandOverride = '') => {
        if (!slug) return null;
        const targetSlug = normalizeParam(slug);
        const brands = brandOverride ? [brandOverride] : BRAND_OPTIONS.map(b => b.key);
        for (const brand of brands) {
            const models = await getModels(brand);
            const match = models.find(model => {
                const modelSlug = normalizeParam(model.id);
                const nameSlug = slugify(model.name);
                return modelSlug === targetSlug || nameSlug === targetSlug;
            });
            if (match) return { brand, model: match };
        }
        return null;
    };
    const getMatchingKey = (keys, value) => {
        const normalized = normalizeParam(value);
        if (!normalized) return '';
        return keys.find(k => normalizeParam(k) === normalized) || '';
    };
    const hydrateFromURL = async () => {
        const params = new URLSearchParams(window.location.search);
        const deviceParam = params.get('device') || params.get('model') || '';
        const brandParam = params.get('brand') || '';
        const storageParam = params.get('storage') || '';
        const carrierParam = params.get('carrier') || params.get('lock') || '';
        const conditionParam = params.get('condition') || '';
        const qualityParam = params.get('quality') || '';
        const powerParam = params.get('power') || '';
        const functionalityParam = params.get('functionality') || '';

        const modelMatch = await findModelBySlug(deviceParam, brandParam);
        if (modelMatch) {
            state.selections.brand = modelMatch.brand;
            state.currentStep = 'model';
            state.selections.model = modelMatch.model.id;
            state.selections.modelName = modelMatch.model.name;
            state.selections.deviceSlug = normalizeParam(deviceParam) || modelMatch.model.id;
            const snap = await getDoc(doc(db, "devices", state.selections.brand, "models", state.selections.model));
            state.deviceData = snap.data();
            state.currentStep = 'storage';

            if (storageParam) {
                const storageKey = getMatchingKey(Object.keys(state.deviceData.prices || {}), storageParam);
                if (storageKey) {
                    state.selections.storage = storageKey;
                    state.currentStep = 'lock';
                }
            }

            if (state.selections.storage && carrierParam) {
                const lockKeys = Object.keys(state.deviceData.prices?.[state.selections.storage] || {});
                const lockKey = getMatchingKey(lockKeys, normalizeCarrier(carrierParam));
                if (lockKey) {
                    state.selections.lock = lockKey;
                    state.currentStep = 'condition';
                }
            }

            const derivedCondition = mapQualityToCondition(qualityParam) || normalizeParam(conditionParam);
            const needsBroken = ['no', 'false'].includes(normalizeParam(powerParam)) || ['no', 'false', 'broken', 'not-working'].includes(normalizeParam(functionalityParam));
            const finalCondition = needsBroken ? 'broken' : derivedCondition;
            if (finalCondition && CONDITION_LABELS[finalCondition]) {
                state.selections.condition = finalCondition;
                showFinalOffer();
                return;
            }
        }
        renderCurrentStep();
    };

    hydrateFromURL();
    updateCartSummary();
</script>
</body>
</html>
