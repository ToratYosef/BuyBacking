<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecondHandCell - Sell Your Device</title>
    <link rel="icon" href="/favicon/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <style>
        :root {
            --brand-primary: #15803d;
            --brand-secondary: #eab308;
            --brand-gradient: linear-gradient(135deg, #15803d 0%, #eab308 100%);
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-gray: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; -webkit-font-smoothing: antialiased; }
        .sell-app-wrapper { min-height: 60vh; padding: 40px 0; }
        .app-container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .step-title { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 30px; color: var(--text-main); }
        
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .select-card {
            background: var(--white); border: 2px solid var(--border); border-radius: 12px;
            padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-card:hover { border-color: var(--brand-secondary); transform: translateY(-2px); }
        .select-card.active { border-color: var(--brand-primary); background: #f0fdf4; color: var(--brand-primary); box-shadow: 0 0 0 1px var(--brand-primary); }

        .breadcrumbs { display: flex; gap: 8px; margin-bottom: 30px; font-size: 13px; justify-content: center; flex-wrap: wrap; }
        .crumb { padding: 8px 16px; background: #e5e7eb; border-radius: 20px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .crumb.active { background: var(--brand-primary); color: white; cursor: default; }
        .crumb.filled { background: #dcfce7; color: var(--brand-primary); border: 1px solid var(--brand-primary); }

        .offer-card { background: var(--white); border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .price-val { font-size: 64px; font-weight: 900; margin: 10px 0; color: var(--text-main); }
        .req-box { text-align: left; max-width: 500px; margin: 20px auto; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

        .form-control { width: 100%; max-width: 400px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 16px; outline: none; }
        .btn-primary {
            width: 100%; max-width: 400px; padding: 18px; background: var(--brand-gradient);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
        
        .hidden { display: none !important; }
        @media (max-width: 600px) { .selection-grid { grid-template-columns: 1fr 1fr; } }
    </style>
    <link rel="stylesheet" href="/assets/css/site-chrome.css">
</head>
<body class="bg-slate-50">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<header class="site-header">
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav">
            <div id="authStatusContainer" class="site-header__auth-wrapper">
                <a href="/login.html" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden"></div>
            </div>
        </nav>
    </div>
</header>

<main class="sell-app-wrapper">
    <!-- Selection View -->
    <div class="app-container" id="selection-flow">
        <div class="breadcrumbs" id="crumbs"></div>
        <h2 class="step-title" id="step-name">Select Brand</h2>
        <div class="selection-grid" id="grid-content">
            <div class="col-span-full text-center py-10 text-slate-400">Loading selections...</div>
        </div>
    </div>

    <!-- Final Offer View -->
    <div class="app-container hidden" id="offer-view">
        <div class="breadcrumbs" id="final-crumbs"></div>
        <div class="offer-card">
            <h2 id="final-device-name" class="text-2xl font-bold mb-1">--</h2>
            <div id="summary-tags" class="text-sm text-green-700 font-bold uppercase tracking-wide mb-6"></div>

            <div class="selection-grid mb-8" id="final-condition-grid"></div>

            <div class="text-sm font-semibold text-slate-500 uppercase">Your Instant Offer:</div>
            <div class="price-val" id="final-price">$0</div>

            <div class="req-box">
                <div class="font-extrabold mb-2 text-slate-800">
                    <span id="condition-title-display">--</span> Condition Requirements:
                </div>
                <ul id="condition-details" class="list-disc pl-5 space-y-1 text-slate-600 text-sm"></ul>
            </div>

            <input type="email" id="user-email" class="form-control" placeholder="Enter email to save quote">
            <button class="btn-primary" id="startCheckoutBtn">GET PAID INSTANTLY</button>
            <p class="mt-6">
                <a href="#" id="resetFlowBtn" class="text-green-700 text-sm font-bold hover:underline">← Start New Trade-in</a>
            </p>
        </div>
    </div>
</main>

<div class="modal-overlay" id="qty-modal">
    <div class="modal-card">
        <h3 class="text-xl font-bold mb-2">Quantity</h3>
        <p class="text-slate-500 mb-6">How many of this exact device are you selling?</p>
        <div class="flex justify-center items-center gap-6 mb-8">
            <button id="qtyMinus" class="w-12 h-12 rounded-full border-2 border-green-700 text-green-700 text-2xl font-bold">-</button>
            <span id="qty-val" class="text-4xl font-black">1</span>
            <button id="qtyPlus" class="w-12 h-12 rounded-full border-2 border-green-700 text-green-700 text-2xl font-bold">+</button>
        </div>
        <button class="btn-primary" id="finalSubmitBtn">PROCEED TO SHIPPING</button>
        <button class="mt-4 text-slate-400 text-sm block mx-auto" onclick="document.getElementById('qty-modal').style.display='none'">Cancel</button>
    </div>
</div>

<footer class="bg-slate-800 text-white">
    <div class="container mx-auto px-4 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="/" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
            </div>
            <div class="bg-slate-700 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-2 text-white">Stay Updated </h3>
                <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                    <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Sign Up</button>
                </form>
                <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
            </div>
        </div>
        <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
            <p class="text-lg font-bold">IMPORTANT NOTICE</p>
            <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
        </div>
        <div class="mt-8">
            <div class="flex flex-wrap items-center justify-center gap-6 sm:flex-row sm:justify-center sm:gap-8 lg:justify-start">
                <a href="https://www.sellcell.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                    <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" width="150" height="107" alt="SellCell Accredited Buyer" loading="lazy" class="h-20 w-auto object-contain">
                </a>
                <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                    <img src="https://cdn.trustpilot.net/brand-assets/4.1.0/stars/stars-5.png" alt="Trustpilot 5 star rating" loading="lazy" class="h-12 w-auto object-contain">
                </a>
            </div>
        </div>
        <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
        authDomain: "auth.secondhandcell.com",
        projectId: "buyback-a0f05",
        storageBucket: "buyback-a0f05.appspot.com",
        messagingSenderId: "876430429098",
        appId: "1:876430429098:web:f6dd64b1960d90461979d3",
        measurementId: "G-6WWQN44JHT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const BRAND_OPTIONS = [
        { key: 'iphone', label: 'iPhone' },
        { key: 'samsung', label: 'Samsung' },
        { key: 'ipad', label: 'iPad' },
    ];

    const LOCK_LABELS = {
        unlocked: 'Unlocked',
        att: 'AT&T',
        verizon: 'Verizon',
        tmobile: 'T-Mobile',
        other: 'Other',
        locked: 'Carrier Locked',
    };

    const CONDITION_DEFS = [
        { key: 'flawless', name: 'Flawless', desc: ['Looks brand new.', 'No scratches or dents.', '100% functional.'] },
        { key: 'good', name: 'Good', desc: ['Light signs of use.', 'Minor scratches allowed.', '100% functional.'] },
        { key: 'broken', name: 'Broken', desc: ['Cracked screen or back.', 'Heavy cosmetic damage.', 'Functional defects.'] },
        { key: 'noPower', name: 'No Power', desc: ['Does not turn on.', 'DED or water damaged.', 'Missing parts.'] }
    ];

    const state = {
        currentStep: 'brand',
        selections: { brand: '', modelId: '', modelName: '', storage: '', lock: '', condition: 'good', qty: 1 },
        deviceData: null,
        modelsCache: {},
        isFinalView: false
    };

    const stepOrder = ['brand', 'model', 'storage', 'lock', 'condition'];

    const updateURL = () => {
        const url = new URL(window.location);
        Object.entries(state.selections).forEach(([key, val]) => {
            if (val && key !== 'qty') url.searchParams.set(key, val);
            else url.searchParams.delete(key);
        });
        window.history.replaceState({}, '', url);
    };

    const hydrateFromURL = async () => {
        const params = new URLSearchParams(window.location.search);
        
        if (params.has('brand')) {
            const b = params.get('brand');
            if (BRAND_OPTIONS.some(opt => opt.key === b)) {
                state.selections.brand = b;
                state.currentStep = 'model';
                
                if (params.has('modelId')) {
                    const mId = params.get('modelId');
                    const models = await getModels(b);
                    const match = models.find(m => m.id === mId);
                    if (match) {
                        state.selections.modelId = mId;
                        state.selections.modelName = match.name;
                        state.deviceData = match;
                        state.currentStep = 'storage';
                        
                        if (params.has('storage')) {
                            const s = params.get('storage');
                            if (state.deviceData.prices[s]) {
                                state.selections.storage = s;
                                state.currentStep = 'lock';
                                
                                if (params.has('lock')) {
                                    const l = params.get('lock');
                                    if (state.deviceData.prices[s][l]) {
                                        state.selections.lock = l;
                                        state.currentStep = 'condition';
                                        
                                        if (params.has('condition')) {
                                            state.selections.condition = params.get('condition');
                                            showFinalOffer();
                                            return;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        renderCurrentStep();
    };

    const updateCrumbs = () => {
        const container = state.isFinalView ? document.getElementById('final-crumbs') : document.getElementById('crumbs');
        container.innerHTML = '';
        const currentIdx = state.isFinalView ? stepOrder.length : stepOrder.indexOf(state.currentStep);

        stepOrder.forEach((step, i) => {
            const span = document.createElement('span');
            span.className = `crumb ${i === currentIdx ? 'active' : ''} ${i < currentIdx ? 'filled' : ''}`;
            
            let label = step.charAt(0).toUpperCase() + step.slice(1);
            if (i <= currentIdx) {
                if (step === 'brand') label = BRAND_OPTIONS.find(b => b.key === state.selections.brand)?.label || label;
                if (step === 'model') label = state.selections.modelName || label;
                if (step === 'storage') label = state.selections.storage || label;
                if (step === 'lock') label = LOCK_LABELS[state.selections.lock] || state.selections.lock || label;
                if (step === 'condition') label = CONDITION_DEFS.find(c => c.key === state.selections.condition)?.name || label;
            }
            
            span.textContent = label;
            if (i < currentIdx) span.onclick = () => jumpToStep(step);
            container.appendChild(span);
        });
    };

    const jumpToStep = (step) => {
        state.isFinalView = false;
        state.currentStep = step;
        document.getElementById('offer-view').classList.add('hidden');
        document.getElementById('selection-flow').classList.remove('hidden');
        renderCurrentStep();
    };

    const renderCurrentStep = async () => {
        const grid = document.getElementById('grid-content');
        const title = document.getElementById('step-name');
        grid.innerHTML = '';
        updateCrumbs();

        if (state.currentStep === 'brand') {
            title.textContent = "Select Brand";
            BRAND_OPTIONS.forEach(b => createCard(grid, b.label, b.key));
        } 
        else if (state.currentStep === 'model') {
            title.textContent = `Select Model`;
            grid.innerHTML = '<div class="col-span-full text-center text-slate-400">Fetching models...</div>';
            const models = await getModels(state.selections.brand);
            grid.innerHTML = '';
            models.forEach(m => createCard(grid, m.name, m.id));
        }
        else if (state.currentStep === 'storage') {
            title.textContent = "Select Storage Capacity";
            Object.keys(state.deviceData.prices || {}).forEach(s => createCard(grid, s, s));
        }
        else if (state.currentStep === 'lock') {
            title.textContent = "Select Network/Carrier";
            Object.keys(state.deviceData.prices[state.selections.storage] || {}).forEach(l => createCard(grid, LOCK_LABELS[l] || l, l));
        }
        else if (state.currentStep === 'condition') {
             showFinalOffer();
        }
    };

    const createCard = (container, label, value) => {
        const card = document.createElement('div');
        card.className = `select-card ${state.selections[state.currentStep] === value ? 'active' : ''}`;
        card.textContent = label;
        card.onclick = () => handleSelection(value, label);
        container.appendChild(card);
    };

    const handleSelection = async (value, label) => {
        state.selections[state.currentStep] = value;
        updateURL();
        
        if (state.currentStep === 'brand') state.currentStep = 'model';
        else if (state.currentStep === 'model') {
            state.selections.modelName = label;
            const docRef = doc(db, "devices", state.selections.brand, "models", value);
            const snap = await getDoc(docRef);
            state.deviceData = snap.data();
            state.currentStep = 'storage';
        }
        else if (state.currentStep === 'storage') state.currentStep = 'lock';
        else if (state.currentStep === 'lock') {
            showFinalOffer();
            return;
        }
        renderCurrentStep();
    };

    const getModels = async (brand) => {
        if (state.modelsCache[brand]) return state.modelsCache[brand];
        const colRef = collection(db, "devices", brand, "models");
        const snap = await getDocs(colRef);
        const models = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.modelsCache[brand] = models;
        return models;
    };

    const showFinalOffer = () => {
        state.isFinalView = true;
        document.getElementById('selection-flow').classList.add('hidden');
        document.getElementById('offer-view').classList.remove('hidden');
        document.getElementById('final-device-name').textContent = state.selections.modelName;
        document.getElementById('summary-tags').textContent = `${state.selections.storage} • ${LOCK_LABELS[state.selections.lock] || state.selections.lock}`;
        renderConditionGrid();
        updatePrice();
        updateCrumbs();
    };

    const renderConditionGrid = () => {
        const grid = document.getElementById('final-condition-grid');
        grid.innerHTML = '';
        CONDITION_DEFS.forEach(c => {
            const card = document.createElement('div');
            card.className = `select-card ${state.selections.condition === c.key ? 'active' : ''}`;
            card.textContent = c.name;
            card.onclick = () => {
                state.selections.condition = c.key;
                updateURL();
                renderConditionGrid();
                updatePrice();
            };
            grid.appendChild(card);
        });
    };

    const updatePrice = () => {
        const priceMap = state.deviceData.prices[state.selections.storage][state.selections.lock];
        const price = priceMap[state.selections.condition] || 0;
        document.getElementById('final-price').textContent = `$${price}`;
        const cond = CONDITION_DEFS.find(c => c.key === state.selections.condition);
        document.getElementById('condition-title-display').textContent = cond.name;
        document.getElementById('condition-details').innerHTML = cond.desc.map(d => `<li>${d}</li>`).join('');
    };

    document.getElementById('startCheckoutBtn').onclick = () => {
        const email = document.getElementById('user-email').value;
        if (!email.includes('@')) return alert("Please enter a valid email to continue.");
        document.getElementById('qty-modal').style.display = 'flex';
    };

    document.getElementById('qtyPlus').onclick = () => { state.selections.qty++; document.getElementById('qty-val').textContent = state.selections.qty; };
    document.getElementById('qtyMinus').onclick = () => { if(state.selections.qty > 1) state.selections.qty--; document.getElementById('qty-val').textContent = state.selections.qty; };

    document.getElementById('finalSubmitBtn').onclick = () => {
        const finalData = { ...state.selections, email: document.getElementById('user-email').value };
        window.location.href = `/sell/checkout.html?${new URLSearchParams(finalData).toString()}`;
    };

    document.getElementById('resetFlowBtn').onclick = (e) => { e.preventDefault(); window.location.href = '/sell/index.html'; };

    hydrateFromURL();
</script>
</body>
</html>