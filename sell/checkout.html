<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Tailwind CDN for testing reliability -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - Checkout</title>
    <link rel="icon" href="/favicon/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17534255111');
    </script>

    <!-- SellCell Pixel -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ 'sellcell.start': new Date().getTime(), event: 'sellcell.js' });
            var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true; j.src = 'https://www.sellcell.com/pixel.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', '1356');
    </script>

    <style>
        :root {
            --brand-primary: #15803d;
            --brand-gradient: linear-gradient(135deg, #15803d 0%, #eab308 100%);
            --border: #E5E7EB;
            --neon-red: #ff3131;
        }
        body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; background-color: #f8fafc; -webkit-font-smoothing: antialiased; }
        
        /* Disable Sticky Navbar for Checkout Page */
        .site-header { 
            position: relative !important; 
            top: 0 !important; 
            z-index: 100;
        }

        .checkout-wrapper { max-width: 1100px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 380px; gap: 30px; }
        @media (max-width: 900px) { .checkout-wrapper { grid-template-columns: 1fr; } }
        .section-card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        .input-field { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; transition: 0.2s; }
        .input-field:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 2px rgba(21, 128, 61, 0.1); }
        
        /* Neon Red Error Highlights */
        .input-field.error-highlight {
            border-color: var(--neon-red) !important;
            box-shadow: 0 0 12px var(--neon-red) !important;
        }
        
        /* Specific Error Text Logic */
        .field-error-msg {
            color: var(--neon-red);
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: none; 
            animation: fadeIn 0.2s ease-out;
        }

        /* Checkbox Neon Glow */
        .checkbox-container.error-highlight {
            border: 2px solid var(--neon-red);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 0 12px var(--neon-red) !important;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-3px); } to { opacity: 1; transform: translateY(0); } }

        /* Consistent Selection UI */
        .option-pill { display: none; }
        .option-label { cursor: pointer; border: 2px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .option-pill:checked + .option-label { border-color: var(--brand-primary); background-color: #f0fdf4; box-shadow: 0 4px 12px rgba(21, 128, 61, 0.1); }

        .summary-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border); position: sticky; top: 20px; }
        .btn-submit { width: 100%; padding: 18px; background: var(--brand-gradient); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-submit:hover { opacity: 0.9; transform: scale(1.01); }

        .cart-item-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            background: #f9fafb;
        }
        .cart-qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #0f172a;
            background: #fff;
        }
        .cart-qty-btn:hover { border-color: var(--brand-primary); color: var(--brand-primary); }
        .cart-remove-btn {
            font-size: 12px;
            font-weight: 700;
            color: #dc2626;
        }
        .cart-condition-select {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            color: #334155;
            background: #fff;
        }

        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem; border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; font-weight: 700; cursor: pointer;
            font-size: 0.875rem; line-height: 1;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem; width: 12rem;
            background-color: white; border-radius: 0.375rem; padding: 0.5rem 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50;
        }
    </style>
    <link rel="stylesheet" href="/assets/css/site-chrome.css">
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<!-- Site Header -->
<header class="site-header site-header--mobile-compact">
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav">
            <div id="authStatusContainer" class="site-header__auth-wrapper relative">
                <a href="#" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden"></div>
                <div id="authDropdown" class="auth-dropdown hidden">
                    <a href="/my-account.html" class="auth-dropdown__link">My Account</a>
                    <button id="logoutBtn" type="button" class="auth-dropdown__button">Logout</button>
                </div>
            </div>
        </nav>
    </div>
</header>

<main class="checkout-wrapper">
    <div id="checkout-form">
        <!-- Step 1: Shipping Preference -->
        <div class="section-card">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">1. Shipping Preference</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <input type="radio" id="email_label" name="shipping_preference" value="email_label" class="option-pill" checked>
                    <label for="email_label" class="option-label">
                        <i class="fa-solid fa-envelope text-3xl text-green-600 mb-2"></i>
                        <span class="font-bold">Email Me a Label</span>
                        <span class="text-xs text-slate-500 mt-1">I have my own box (Fastest)</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="ship_kit" name="shipping_preference" value="ship_kit" class="option-pill">
                    <label for="ship_kit" class="option-label">
                        <i class="fa-solid fa-box text-3xl text-indigo-600 mb-2"></i>
                        <span class="font-bold">Ship Me a Box</span>
                        <span class="text-xs text-slate-500 mt-1">+$10 convenience fee</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 2: Shipping Address -->
        <div class="section-card" id="address-section">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">2. Shipping Address</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group md:col-span-2">
                    <label>Full Name</label>
                    <div id="fullName-error" class="field-error-msg">Error: Please complete required field</div>
                    <input type="text" id="fullName" class="input-field" placeholder="Full Name">
                </div>
                <div class="input-group">
                    <label>Phone Number</label>
                    <div id="phone-error" class="field-error-msg">Error: Please complete required field</div>
                    <input type="tel" id="phone" class="input-field" placeholder="(555) 555-5555">
                </div>
                <div class="input-group">
                    <label>Email Address</label>
                    <div id="email-error" class="field-error-msg">Error: Please complete required field</div>
                    <input type="email" id="email" class="input-field">
                </div>
                <div class="input-group md:col-span-2">
                    <label>Street Address</label>
                    <div id="streetAddress-error" class="field-error-msg">Error: Please complete required field</div>
                    <input type="text" id="streetAddress" class="input-field" placeholder="123 Main St">
                </div>
                <div class="input-group">
                    <label>Apartment / Suite / Unit (Optional)</label>
                    <input type="text" id="addressUnit" class="input-field" placeholder="Apt 5B">
                </div>
                <div class="input-group">
                    <label>City</label>
                    <div id="city-error" class="field-error-msg">Error: Please complete required field</div>
                    <input type="text" id="city" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="input-group">
                        <label>State</label>
                        <div id="state-error" class="field-error-msg">Error: Required</div>
                        <select id="state" class="input-field">
                            <option value="">Select State</option>
                            <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Zip Code</label>
                        <div id="zip-error" class="field-error-msg">Error: Required</div>
                        <input type="text" id="zip" class="input-field">
                    </div>
                </div>
                <input type="hidden" id="country" value="US">
            </div>
        </div>

        <!-- Step 3: Payout Method -->
        <div class="section-card">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">3. Payout Method</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                <div>
                    <input type="radio" id="pay_cashapp" name="payment_method" value="cashapp" class="option-pill" checked>
                    <label for="pay_cashapp" class="option-label">
                        <i class="fa-solid fa-dollar-sign text-2xl mb-1 text-green-600"></i>
                        <span class="text-xs font-bold">Cash App</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="pay_zelle" name="payment_method" value="zelle" class="option-pill">
                    <label for="pay_zelle" class="option-label">
                        <i class="fa-solid fa-bolt text-2xl mb-1 text-purple-600"></i>
                        <span class="text-xs font-bold">Zelle</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="pay_paypal" name="payment_method" value="paypal" class="option-pill">
                    <label for="pay_paypal" class="option-label">
                        <i class="fa-brands fa-paypal text-2xl mb-1 text-blue-600"></i>
                        <span class="text-xs font-bold">PayPal</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="pay_check" name="payment_method" value="check" class="option-pill">
                    <label for="pay_check" class="option-label">
                        <i class="fa-solid fa-envelope-open-text text-2xl mb-1 text-slate-500"></i>
                        <span class="text-xs font-bold">Check</span>
                    </label>
                </div>
            </div>
            <div id="payment-details-input">
                <label id="payment-label" class="block text-xs font-bold text-slate-500 uppercase mb-2">Cash App $Cashtag</label>
                <div id="payoutIdentifier-error" class="field-error-msg">Error: Please complete required field</div>
                <input type="text" id="payoutIdentifier" class="input-field" placeholder="$cashtag">
            </div>
        </div>

        <div class="section-card">
            <label id="terms-container" class="checkbox-container flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="terms" class="w-5 h-5 accent-green-700">
                <span class="text-sm text-slate-600 font-bold">I certify this device is not lost/stolen and I accept the terms & conditions.</span>
            </label>
            <div id="terms-error" class="field-error-msg mt-2">Error: You must accept terms to continue</div>
            <button class="btn-submit" id="submitOrderBtn">SUBMIT MY TRADE-IN</button>
        </div>
    </div>

    <!-- Sidebar Summary -->
    <aside>
        <div class="summary-card">
            <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h3 class="text-lg font-bold">Trade-in Summary</h3>
                <a href="/sell/index.html?return=checkout" class="text-sm font-semibold text-green-700 hover:underline">Add another device</a>
            </div>
            <div id="summary-content" class="space-y-4">
                <div id="cart-items" class="space-y-4"></div>
                <div id="cart-empty" class="text-sm text-slate-500 hidden">No devices added yet.</div>
                <div id="kit-fee-row" class="flex justify-between hidden text-red-600">
                    <span class="text-sm">Shipping Kit Fee</span>
                    <span class="text-sm font-bold">-$10.00</span>
                </div>
                <div class="pt-4 mt-4 border-t flex justify-between items-end">
                    <span class="text-slate-800 font-bold">Total Payout</span>
                    <span id="sum-total" class="text-3xl font-black text-green-700">$0</span>
                </div>
            </div>
        </div>
    </aside>
</main>

<footer class="bg-slate-800 text-white mt-20">
    <div class="container mx-auto px-4 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="/" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="/about-us" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
            </div>
            <div class="bg-slate-700 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-2 text-white">Stay Updated </h3>
                <p class="text-slate-300 mb-4 text-sm">Sign up for promos and price increases!</p>
                <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                    <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Sign Up</button>
                </form>
            </div>
        </div>
        <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
            <p class="text-lg font-bold uppercase">IMPORTANT NOTICE</p>
            <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
        </div>
        <div class="mt-8 flex flex-wrap justify-center items-center gap-8">
            <a href="https://www.sellcell.com/" target="_blank" rel="noopener">
                <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" class="h-16 grayscale hover:grayscale-0 transition" alt="SellCell Accredited Buyer">
            </a>
            <img src="/assets/stars-5.svg" class="h-10" alt="Trustpilot 5 Star">
        </div>
        <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
        authDomain: "auth.secondhandcell.com",
        projectId: "buyback-a0f05",
        storageBucket: "buyback-a0f05.appspot.com",
        messagingSenderId: "876430429098",
        appId: "1:876430429098:web:f6dd64b1970d90461979d3",
        measurementId: "G-6WWQN44JHT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "buyback-a0f05";

    const params = new URLSearchParams(window.location.search);
    const CART_STORAGE_KEY = 'shc_cart';
    const CONDITION_LABELS = { flawless: 'Flawless', good: 'Good', fair: 'Fair', broken: 'Broken' };
    const CONDITION_KEYS = Object.keys(CONDITION_LABELS);
    let cartItems = [];

    // AUTH LISTENER - LOAD SAVED ADDRESS & SET MONOGRAM
    onAuthStateChanged(auth, async (user) => {
        const loginBtn = document.getElementById('loginNavBtn');
        const monogram = document.getElementById('userMonogram');
        
        if (user) {
            loginBtn.classList.add('hidden');
            monogram.classList.remove('hidden');
            
            // INITIALS LOGIC (2 LETTERS)
            let initials = 'U';
            if (user.displayName) {
                const parts = user.displayName.trim().split(/\s+/);
                if (parts.length > 1) {
                    initials = (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                } else {
                    initials = parts[0].slice(0, 2).toUpperCase();
                }
            } else if (user.email) {
                initials = user.email.slice(0, 2).toUpperCase();
            }
            monogram.textContent = initials;
            
            const emailField = document.getElementById('email');
            if (emailField) {
                emailField.value = user.email || '';
                emailField.readOnly = false;
            }

            try {
                const addressDoc = await getDoc(doc(db, "artifacts", appId, "users", user.uid, "profile", "address"));
                if (addressDoc.exists()) {
                    const data = addressDoc.data();
                    if (data.fullName) document.getElementById('fullName').value = data.fullName;
                    if (data.phone) document.getElementById('phone').value = data.phone;
                    if (data.streetAddress) document.getElementById('streetAddress').value = data.streetAddress;
                    if (data.addressUnit) document.getElementById('addressUnit').value = data.addressUnit;
                    if (data.city) document.getElementById('city').value = data.city;
                    if (data.state) document.getElementById('state').value = data.state;
                    if (data.zip) document.getElementById('zip').value = data.zip;
                }
            } catch (err) { console.error("Error fetching address:", err); }
        } else {
            loginBtn.classList.remove('hidden');
            monogram.classList.add('hidden');
        }
    });

    const getCart = () => {
        try {
            return JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');
        } catch (e) {
            return [];
        }
    };
    const saveCart = (cart) => {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    };
    const updateSummary = () => {
        const isKit = document.querySelector('input[name="shipping_preference"]:checked').value === 'ship_kit';
        const fee = isKit ? 10 : 0;
        const total = cartItems.reduce((sum, item) => sum + (item.unitPrice * item.qty), 0);
        document.getElementById('kit-fee-row').classList.toggle('hidden', !isKit);
        document.getElementById('sum-total').textContent = `$${Math.max(total - fee, 0).toFixed(2)}`;
    };
    const ensureCartCondition = (item) => {
        const validKey = item.condition && CONDITION_LABELS[item.condition] ? item.condition : null;
        if (validKey) return validKey;
        const priceKeys = Object.keys(item.conditionPrices || {});
        const matchedKey = priceKeys.find((key) => CONDITION_LABELS[key]);
        const fallbackKey = matchedKey || CONDITION_KEYS[0];
        item.condition = fallbackKey;
        if (item.conditionPrices && item.conditionPrices[fallbackKey]) {
            item.unitPrice = Number(item.conditionPrices[fallbackKey]);
        }
        return fallbackKey;
    };

    const renderCart = () => {
        const cartContainer = document.getElementById('cart-items');
        const emptyState = document.getElementById('cart-empty');
        cartContainer.innerHTML = '';
        if (!cartItems.length) {
            emptyState.classList.remove('hidden');
            updateSummary();
            return;
        }
        emptyState.classList.add('hidden');
        cartItems.forEach((item, index) => {
            const conditionKey = ensureCartCondition(item);
            const card = document.createElement('div');
            card.className = 'cart-item-card';
            const total = (item.unitPrice * item.qty).toFixed(2);
            const carrierDisplay = item.lock ? item.lock.charAt(0).toUpperCase() + item.lock.slice(1) : item.lock;
            card.innerHTML = `
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <div class="font-bold text-slate-900">${item.modelName}</div>
                        <div class="text-xs text-slate-500 mt-1">${item.storage} â€¢ ${carrierDisplay}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-slate-900">$${total}</div>
                        <button class="cart-remove-btn mt-1" data-action="remove" data-index="${index}">Remove</button>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-3">
                    <div class="flex items-center gap-2">
                        <button class="cart-qty-btn" data-action="decrease" data-index="${index}">-</button>
                        <span class="text-sm font-bold">${item.qty}</span>
                        <button class="cart-qty-btn" data-action="increase" data-index="${index}">+</button>
                    </div>
                    <select class="cart-condition-select" data-action="condition" data-index="${index}">
                        ${Object.entries(CONDITION_LABELS).map(([key, label]) => `
                            <option value="${key}" ${conditionKey === key ? 'selected' : ''}>${label}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="text-xs text-slate-500 mt-2">Condition: ${CONDITION_LABELS[conditionKey] || conditionKey}</div>
            `;
            cartContainer.appendChild(card);
        });
        updateSummary();
    };
    const applyCartChange = (index, action, value = null) => {
        const item = cartItems[index];
        if (!item) return;
        if (action === 'increase') item.qty += 1;
        if (action === 'decrease') item.qty = Math.max(item.qty - 1, 1);
        if (action === 'remove') cartItems.splice(index, 1);
        if (action === 'condition') {
            const nextCondition = CONDITION_LABELS[value] ? value : ensureCartCondition(item);
            item.condition = nextCondition;
            const newPrice = Number(item.conditionPrices?.[nextCondition] || item.unitPrice);
            item.unitPrice = newPrice;
        }
        saveCart(cartItems);
        renderCart();
    };
    const addItemToCart = (item) => {
        const key = [
            item.brand,
            item.model,
            item.storage,
            item.lock,
            item.condition
        ].join('|');
        const existing = cartItems.find(cartItem => cartItem.key === key);
        if (existing) {
            existing.qty += item.qty;
        } else {
            cartItems.push({ ...item, key });
        }
        saveCart(cartItems);
    };

    const init = async () => {
        cartItems = getCart();

        const b = params.get('brand');
        const m = params.get('model'); 
        const s = params.get('storage');
        const l = params.get('lock');
        const c = params.get('condition');
        const qty = parseInt(params.get('qty') || '1');

        try {
            if (b && m && s && l && c) {
                const docRef = doc(db, "devices", b, "models", m);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    const getVal = (obj, key) => obj[key] || obj[key.toLowerCase()] || obj[key.toUpperCase()];
                    const storageMap = getVal(data.prices, s) || {};
                    const lockMap = getVal(storageMap, l) || {};
                    const unitPrice = lockMap[c] || 0;
                    addItemToCart({
                        brand: b,
                        model: m,
                        modelName: data.name,
                        storage: s,
                        lock: l,
                        condition: c,
                        qty: qty,
                        unitPrice: unitPrice,
                        conditionPrices: lockMap
                    });
                }
            }
        } catch (err) { console.error(err); }

        // AUTO-REMOVE ERROR HIGHLIGHT ON INPUT
        const requiredIds = ['fullName', 'phone', 'email', 'streetAddress', 'city', 'state', 'zip', 'payoutIdentifier'];
        requiredIds.forEach(id => {
            const el = document.getElementById(id);
            const errEl = document.getElementById(`${id}-error`);
            if (el) {
                el.addEventListener('input', () => {
                    el.classList.remove('error-highlight');
                    if (errEl) errEl.style.display = 'none';
                });
                if (el.tagName === 'SELECT') {
                    el.addEventListener('change', () => {
                        el.classList.remove('error-highlight');
                        if (errEl) errEl.style.display = 'none';
                    });
                }
            }
        });

        const termsCheck = document.getElementById('terms');
        termsCheck.addEventListener('change', () => {
            document.getElementById('terms-container').classList.remove('error-highlight');
            document.getElementById('terms-error').style.display = 'none';
        });

        document.getElementById('summary-content').addEventListener('click', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index || '-1');
            const action = target.dataset.action;
            if (!action || Number.isNaN(index)) return;
            applyCartChange(index, action);
        });
        document.getElementById('summary-content').addEventListener('change', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index || '-1');
            if (target.dataset.action === 'condition' && !Number.isNaN(index)) {
                applyCartChange(index, 'condition', target.value);
            }
        });

        renderCart();
    };

    const updatePaymentFields = () => {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const labels = { 
            cashapp: 'Cash App $Cashtag', 
            zelle: 'Zelle Email or Phone', 
            paypal: 'PayPal Email', 
            check: 'Full Name for Check' 
        };
        document.getElementById('payment-label').textContent = labels[selectedMethod];
        document.getElementById('payoutIdentifier').placeholder = selectedMethod === 'cashapp' ? '$cashtag' : '';
    };

    const initAutocomplete = () => {
        const input = document.getElementById('streetAddress');
        if (!input || !window.google || !google.maps?.places) return;
        const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['address'],
            fields: ['address_components']
        });
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            const components = place.address_components || [];
            const findComponent = (type) => components.find(comp => comp.types.includes(type)) || {};
            const streetNumber = findComponent('street_number').long_name || '';
            const route = findComponent('route').long_name || '';
            const city = findComponent('locality').long_name || findComponent('sublocality').long_name || '';
            const state = findComponent('administrative_area_level_1').short_name || '';
            const zip = findComponent('postal_code').long_name || '';
            const country = findComponent('country').short_name || 'US';

            document.getElementById('streetAddress').value = `${streetNumber} ${route}`.trim();
            document.getElementById('city').value = city;
            document.getElementById('state').value = state;
            document.getElementById('zip').value = zip;
            document.getElementById('country').value = country;
        });
    };
    window.initAutocomplete = initAutocomplete;

    document.querySelectorAll('input[name="shipping_preference"]').forEach(r => r.onchange = updateSummary);
    document.querySelectorAll('input[name="payment_method"]').forEach(r => r.onchange = updatePaymentFields);

    document.getElementById('submitOrderBtn').onclick = async () => {
        const requiredIds = ['fullName', 'phone', 'email', 'streetAddress', 'city', 'state', 'zip', 'payoutIdentifier'];
        let hasError = false;
        let firstErrorEl = null;

        requiredIds.forEach(id => {
            document.getElementById(`${id}-error`).style.display = 'none';
            document.getElementById(id).classList.remove('error-highlight');
        });
        document.getElementById('terms-error').style.display = 'none';
        document.getElementById('terms-container').classList.remove('error-highlight');

        requiredIds.forEach(id => {
            const el = document.getElementById(id);
            const errEl = document.getElementById(`${id}-error`);
            if (!el.value) {
                el.classList.add('error-highlight');
                if (errEl) errEl.style.display = 'block';
                hasError = true;
                if (!firstErrorEl) firstErrorEl = el;
            }
        });

        const termsCheck = document.getElementById('terms');
        const termsContainer = document.getElementById('terms-container');
        const termsError = document.getElementById('terms-error');
        if (!termsCheck.checked) {
            termsContainer.classList.add('error-highlight');
            termsError.style.display = 'block';
            hasError = true;
            if (!firstErrorEl) firstErrorEl = termsContainer;
        }

        if (hasError) {
            if (firstErrorEl) {
                firstErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        const btn = document.getElementById('submitOrderBtn');
        const pref = document.querySelector('input[name="shipping_preference"]:checked').value;
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        const finalPayout = parseFloat(document.getElementById('sum-total').textContent.replace('$', ''));

        btn.disabled = true;
        btn.textContent = "Processing...";

        const shippingInfo = {
            fullName: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            streetAddress: document.getElementById('streetAddress').value,
            addressUnit: document.getElementById('addressUnit').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zipCode: document.getElementById('zip').value,
            zip: document.getElementById('zip').value,
            country: document.getElementById('country').value,
            shippingPreference: pref
        };

        if (auth.currentUser) {
            try {
                await setDoc(doc(db, "artifacts", appId, "users", auth.currentUser.uid, "profile", "address"), shippingInfo);
            } catch (e) { console.error("Error saving address:", e); }
        }

        try {
            if (!cartItems.length) {
                alert('Please add at least one device.');
                btn.disabled = false;
                btn.textContent = "SUBMIT MY TRADE-IN";
                return;
            }

            const isKit = pref === 'ship_kit';
            const totalQty = cartItems.reduce((sum, item) => sum + item.qty, 0);
            const firstItem = cartItems[0];
            const itemsPayload = cartItems.map((item) => {
                const itemTotal = item.unitPrice * item.qty;
                const condKey = item.condition;
                return {
                    device: item.modelName,
                    brand: item.brand,
                    modelId: item.model,
                    modelName: item.modelName,
                    storage: item.storage,
                    carrier: item.lock,
                    lock: item.lock,
                    condition: condKey,
                    condition_power_on: condKey === 'noPower' ? 'No' : 'Yes',
                    condition_functional: (condKey === 'broken' || condKey === 'noPower') ? 'No' : 'Yes',
                    condition_cracks: condKey === 'broken' ? 'Yes' : 'No',
                    condition_cosmetic: condKey,
                    qty: item.qty,
                    unitPrice: item.unitPrice,
                    totalPayout: itemTotal,
                    estimatedQuote: itemTotal
                };
            });

            const summaryDevice = cartItems.length > 1
                ? `${firstItem.modelName} + ${cartItems.length - 1} more`
                : firstItem.modelName;

            const orderData = {
                device: summaryDevice,
                brand: firstItem.brand,
                modelId: firstItem.model,
                modelName: firstItem.modelName,
                storage: firstItem.storage,
                carrier: firstItem.lock,
                lock: firstItem.lock,
                condition: firstItem.condition,
                condition_power_on: firstItem.condition === 'noPower' ? 'No' : 'Yes',
                condition_functional: (firstItem.condition === 'broken' || firstItem.condition === 'noPower') ? 'No' : 'Yes',
                condition_cracks: firstItem.condition === 'broken' ? 'Yes' : 'No',
                condition_cosmetic: firstItem.condition,
                qty: totalQty,
                items: itemsPayload,
                totalPayout: finalPayout,
                estimatedQuote: finalPayout,
                shippingPreference: isKit ? 'Shipping Kit Requested' : 'Email Label Requested',
                shippingKitFee: isKit ? 10 : 0,
                shippingInfo: shippingInfo,
                paymentMethod: method,
                paymentIdentifier: document.getElementById('payoutIdentifier').value,
                createdAt: new Date().toISOString()
            };

            const res = await fetch('https://us-central1-buyback-a0f05.cloudfunctions.net/api/submit-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            const result = await res.json();
            if (!res.ok) {
                alert("Submission failed: " + result.error);
                btn.disabled = false;
                btn.textContent = "SUBMIT MY TRADE-IN";
                return;
            }

            const labelUrl = result.autoLabelDownloadUrl || result.labelDownloadUrl || '';
            const trackingNumber = result.autoLabelTrackingNumber || result.trackingNumber || '';

            const successUrl = new URL('/order-submitted.html', window.location.origin);
            successUrl.searchParams.set('id', result.orderId);
            successUrl.searchParams.set('price', finalPayout.toFixed(2));
            successUrl.searchParams.set('device', cartItems.length > 1 ? 'Multiple devices' : cartItems[0].modelName);
            successUrl.searchParams.set('qty', totalQty);
            successUrl.searchParams.set('name', shippingInfo.fullName);
            successUrl.searchParams.set('street', shippingInfo.streetAddress);
            successUrl.searchParams.set('unit', shippingInfo.addressUnit);
            successUrl.searchParams.set('city', shippingInfo.city);
            successUrl.searchParams.set('state', shippingInfo.state);
            successUrl.searchParams.set('zip', shippingInfo.zipCode);
            successUrl.searchParams.set('payMethod', method);
            successUrl.searchParams.set('shipping', pref);
            
            if (labelUrl) successUrl.searchParams.set('labelUrl', labelUrl);
            if (trackingNumber) successUrl.searchParams.set('trackingNumber', trackingNumber);
            
            window.location.href = successUrl.toString();
        } catch (e) { alert("Server error."); } finally { btn.disabled = false; btn.textContent = "SUBMIT MY TRADE-IN"; }
    };

    init();
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvU0S58N4TVxJ5Ag4l7B-r534hng4BxVw&libraries=places&callback=initAutocomplete" defer></script>
<script src="/assets/js/ship48-banner.js" defer></script>
<script type="module" src="/assets/js/global-auth.js" defer></script>
</body>
</html>
