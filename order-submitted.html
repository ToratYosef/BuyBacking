<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Submitted - secondhandcell</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/site-consistent.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/brands.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>
    
    <!-- End Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
        
            gtag('config', 'AW-17534255111');
            gtag('config', 'G-8JYPJDKSP8');
        
            gtag('event', 'conversion', {'send_to': 'AW-17534255111/09vcCOjI85QbEIeA_qhB'});
        </script>
    <style>
        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center text-slate-100">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <main class="flex-grow w-full py-12 flex items-center justify-center px-4">
        <div class="glass-card order-summary-card p-8 md:p-12 max-w-2xl text-center w-full">
            <div class="mb-6">
                <i class="fa-solid fa-circle-check text-7xl text-green-500"></i>
            </div>
            
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-4">Thank You for Your Order! ðŸŽ‰</h1>
            
            <p class="text-lg text-slate-200 mb-3 max-w-xl mx-auto">
                Your order has been successfully submitted. An email with all the details has been sent to your inbox.
            </p>
            <p id="orderIdNotice" class="text-sm font-semibold text-cyan-200 mb-10 hidden">
                <span class="opacity-80">Order ID:</span> <span id="orderIdValue" class="ml-1"></span>
            </p>

            <div class="glass-card bg-white/90 p-6 rounded-2xl border border-slate-200 text-left mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-4">What Happens Next?</h2>
                <ol class="list-decimal list-inside space-y-4 text-slate-700">
                    <li>
                        <strong>Check Your Email:</strong> We've just sent you a confirmation email containing your order summary and the next steps. Please check your spam folder if you don't see it within a few minutes.
                    </li>
                    <li id="shippingInstruction">
                        <strong>Shipping Instructions:</strong>
                        <span class="block mt-2">
                            A prepaid shipping label will arrive in your inbox shortly. Please use your own packaging, carefully wrap your device, and drop it off at any USPS location.
                        </span>
                    </li>
                    <li>
                        <strong>Device Inspection:</strong> Once we receive your device, our certified technicians will inspect it to confirm the condition.
                    </li>
                    <li>
                        <strong>Get Paid:</strong> After the inspection, we'll send your payment via the method you selected. You'll receive a final payment confirmation email when the funds are on their way.
                    </li>
                </ol>
            </div>

            <div id="orderSummaryLoading" class="hidden mt-10 text-slate-200">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i>Pulling in your order summary...
            </div>

            <div id="orderSummaryError" class="hidden mt-10 text-red-300 font-semibold"></div>

            <div id="orderSummary" class="order-summary-card glass-card bg-white text-left mt-10 hidden">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-900">Order Summary</h2>
                        <p id="orderMeta" class="text-sm text-slate-500 mt-1"></p>
                    </div>
                    <span id="orderStatusBadge" class="status-chip bg-slate-200 text-slate-700"></span>
                </div>

                <div class="order-summary-grid mt-6">
                    <div class="order-summary-item">
                        <span>Estimated Quote</span>
                        <strong id="orderQuote">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Device</span>
                        <strong id="orderDevice">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Storage</span>
                        <strong id="orderStorage">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Carrier</span>
                        <strong id="orderCarrier">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Shipping Preference</span>
                        <strong id="orderShippingPreference">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Payment Method</span>
                        <strong id="orderPaymentMethod">â€”</strong>
                    </div>
                </div>

                <div class="order-summary-grid mt-6">
                    <div class="order-summary-item">
                        <span>Customer</span>
                        <strong id="orderCustomer">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Email</span>
                        <strong id="orderEmail">â€”</strong>
                    </div>
                    <div class="order-summary-item">
                        <span>Phone</span>
                        <strong id="orderPhone">â€”</strong>
                    </div>
                    <div class="order-summary-item span-2">
                        <span>Shipping Address</span>
                        <strong id="orderAddress">â€”</strong>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-3">Condition Details</h3>
                    <div class="order-summary-grid">
                        <div class="order-summary-item">
                            <span>Powers On</span>
                            <strong id="conditionPower">â€”</strong>
                        </div>
                        <div class="order-summary-item">
                            <span>Fully Functional</span>
                            <strong id="conditionFunctional">â€”</strong>
                        </div>
                        <div class="order-summary-item">
                            <span>Cracks</span>
                            <strong id="conditionCracks">â€”</strong>
                        </div>
                        <div class="order-summary-item">
                            <span>Cosmetic Condition</span>
                            <strong id="conditionCosmetic">â€”</strong>
                        </div>
                    </div>
                </div>

                <div id="orderNotes" class="mt-6 text-sm text-slate-600 space-y-2"></div>
            </div>

            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <a href="https://secondhandcell.com/index.html" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-full text-indigo-700 bg-indigo-100 hover:bg-indigo-200 transition duration-300">
                    <i class="fa-solid fa-house mr-2"></i> Return to Homepage
                </a>
                <a href="https://secondhandcell.com/my-account.html" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-full text-white bg-indigo-600 hover:bg-indigo-700 transition duration-300">
                    <i class="fa-solid fa-user-circle mr-2"></i> View My Account
                </a>
            </div>
        </div>
    </main>
    
    <script>
        const BACKEND_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';
        const USPS_TRACKING_URL = 'https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=';

        const statusStyles = {
            'order_pending': 'bg-blue-100 text-blue-700',
            'needs_printing': 'bg-amber-100 text-amber-700',
            'kit_sent': 'bg-indigo-100 text-indigo-700',
            'shipping_kit_requested': 'bg-indigo-100 text-indigo-700',
            'kit_in_transit': 'bg-sky-100 text-sky-700',
            'kit_delivered': 'bg-emerald-100 text-emerald-700',
            'label_generated': 'bg-yellow-100 text-yellow-700',
            'received': 'bg-green-100 text-green-700',
            'completed': 'bg-purple-100 text-purple-700'
        };

        const statusLabels = {
            'order_pending': 'Order Pending',
            'needs_printing': 'Needs Printing',
            'kit_sent': 'Kit Sent',
            'shipping_kit_requested': 'Kit Sent',
            'kit_in_transit': 'Kit In Transit',
            'kit_delivered': 'Kit Delivered',
            'label_generated': 'Label Generated',
            'received': 'Device Received',
            'completed': 'Completed'
        };

        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const shippingInstruction = document.getElementById('shippingInstruction');
            const orderSummary = document.getElementById('orderSummary');
            const orderSummaryLoading = document.getElementById('orderSummaryLoading');
            const orderSummaryError = document.getElementById('orderSummaryError');
            const orderIdNotice = document.getElementById('orderIdNotice');
            const orderIdValue = document.getElementById('orderIdValue');

            const urlParams = new URLSearchParams(window.location.search);
            const shippingParam = urlParams.get('shipping');
            const orderIdParam = urlParams.get('orderId');
            const quoteParam = urlParams.get('price');

            updateShippingInstructions(shippingInstruction, shippingParam);

            if (!orderIdParam) {
                orderSummaryError.textContent = 'We couldn\'t find your order information. Please check your confirmation email for your order link.';
                orderSummaryError.classList.remove('hidden');
                return;
            }

            try {
                orderSummaryLoading.classList.remove('hidden');
                const response = await fetch(`${BACKEND_URL}/orders/${encodeURIComponent(orderIdParam)}`);
                if (!response.ok) {
                    throw new Error(`Failed to load order (${response.status})`);
                }

                const order = await response.json();
                orderSummaryLoading.classList.add('hidden');

                if (order && order.id) {
                    renderOrderSummary(order, quoteParam);
                    orderIdValue.textContent = order.id;
                    orderIdNotice.classList.remove('hidden');
                    updateShippingInstructions(shippingInstruction, order.shippingPreference);
                    orderSummary.classList.remove('hidden');
                } else {
                    throw new Error('Order payload missing expected fields.');
                }
            } catch (error) {
                console.error('Error loading order:', error);
                orderSummaryLoading.classList.add('hidden');
                orderSummaryError.textContent = 'We hit a snag loading your order summary. Please refresh this page or contact support@secondhandcell.com with your order ID.';
                orderSummaryError.classList.remove('hidden');
            }
        });

        function updateShippingInstructions(element, preference) {
            if (!element) return;
            const normalized = normalizeShippingPreference(preference);
            if (normalized === 'Shipping Kit Requested') {
                element.innerHTML = `
                    <strong>Shipping Kit Instructions:</strong>
                    <span class="block mt-2">
                        We\'ve shipped a prepaid, insured shipping kit to your address. Use the included materials to securely pack your device and hand it to USPS.
                    </span>
                `;
            } else {
                element.innerHTML = `
                    <strong>Shipping Instructions:</strong>
                    <span class="block mt-2">
                        A prepaid shipping label will arrive in your inbox shortly. Please use your own packaging, carefully wrap your device, and drop it off at any USPS location.
                    </span>
                `;
            }
        }

        function renderOrderSummary(order, quoteParam) {
            const quote = resolveQuote(order, quoteParam);
            const shippingInfo = order.shippingInfo || {};
            const paymentDetails = order.paymentDetails || {};

            assignText('orderQuote', quote ? currencyFormatter.format(quote) : 'â€”');
            assignText('orderDevice', order.device || 'â€”');
            assignText('orderStorage', order.storage || 'â€”');
            assignText('orderCarrier', humanize(order.carrier));
            assignText('orderShippingPreference', humanize(order.shippingPreference));
            assignText('orderPaymentMethod', humanize(order.paymentMethod));
            assignText('orderCustomer', shippingInfo.fullName || 'â€”');
            assignText('orderEmail', shippingInfo.email || 'â€”');
            assignText('orderPhone', formatPhone(shippingInfo.phone));
            assignText('orderAddress', formatAddress(shippingInfo));
            assignText('conditionPower', humanize(order.condition_power_on));
            assignText('conditionFunctional', humanize(order.condition_functional));
            assignText('conditionCracks', humanize(order.condition_cracks));
            assignText('conditionCosmetic', humanize(order.condition_cosmetic));

            const orderMeta = document.getElementById('orderMeta');
            orderMeta.textContent = buildOrderMeta(order);

            const statusBadge = document.getElementById('orderStatusBadge');
            const statusClass = statusStyles[order.status] || 'bg-slate-200 text-slate-700';
            statusBadge.className = `status-chip ${statusClass}`;
            statusBadge.textContent = statusLabels[order.status] || humanize(order.status);

            const notes = [];
            if (shippingInfo.email) {
                notes.push(`We\'ll send updates to <strong>${shippingInfo.email}</strong>.`);
            }
            if (order.paymentMethod === 'venmo' && paymentDetails.venmoUsername) {
                notes.push(`We\'ll send your Venmo payment to <strong>@${paymentDetails.venmoUsername}</strong>.`);
            }
            if (order.paymentMethod === 'paypal' && paymentDetails.paypalEmail) {
                notes.push(`PayPal payouts will arrive at <strong>${paymentDetails.paypalEmail}</strong>.`);
            }
            if (order.trackingNumber) {
                notes.push(`Inbound tracking: <a class="text-indigo-600 hover:underline" target="_blank" rel="noopener" href="${USPS_TRACKING_URL}${order.trackingNumber}">${order.trackingNumber}</a>.`);
            }
            if (order.outboundTrackingNumber) {
                notes.push(`Kit tracking: <a class="text-indigo-600 hover:underline" target="_blank" rel="noopener" href="${USPS_TRACKING_URL}${order.outboundTrackingNumber}">${order.outboundTrackingNumber}</a>.`);
            }
            const shippingChoice = normalizeShippingPreference(order.shippingPreference);
            if (shippingChoice === 'Shipping Kit Requested') {
                notes.push('You chose a <strong>prepaid shipping kit</strong>; we will mail a kit to your address and update you as it travels.');
            } else if (shippingChoice === 'Email Label Requested') {
                notes.push('You opted to <strong>print a prepaid USPS label</strong>; check your inbox for the download link.');
            }

            const orderNotes = document.getElementById('orderNotes');
            if (notes.length > 0) {
                orderNotes.innerHTML = notes.map(note => `<p>${note}</p>`).join('');
                orderNotes.classList.remove('hidden');
            } else {
                orderNotes.classList.add('hidden');
            }
        }

        function assignText(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value ?? 'â€”';
            }
        }

        function resolveQuote(order, quoteParam) {
            if (quoteParam) {
                const parsed = parseFloat(quoteParam);
                if (!Number.isNaN(parsed) && parsed > 0) {
                    return parsed;
                }
            }
            if (typeof order.estimatedQuote === 'number') {
                return order.estimatedQuote;
            }
            return null;
        }

        function humanize(value) {
            if (!value || typeof value !== 'string') return value || 'â€”';
            return value
                .replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function formatPhone(phone) {
            if (!phone) return 'â€”';
            const digits = String(phone).replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }
            return phone;
        }

        function formatAddress(info) {
            if (!info) return 'â€”';
            const parts = [info.streetAddress, [info.city, info.state].filter(Boolean).join(', '), info.zipCode].filter(Boolean);
            return parts.length ? parts.join('\n') : 'â€”';
        }

        function buildOrderMeta(order) {
            const submittedAt = formatDate(order.createdAt);
            const pieces = [];
            if (submittedAt) {
                pieces.push(`Submitted on ${submittedAt}`);
            }
            if (order.estimatedQuote) {
                pieces.push(`Quoted ${currencyFormatter.format(order.estimatedQuote)}`);
            }
            return pieces.join(' â€¢ ');
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.seconds) {
                date = new Date(timestamp.seconds * 1000);
            } else if (timestamp._seconds) {
                date = new Date(timestamp._seconds * 1000);
            } else {
                date = new Date(timestamp);
            }
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function normalizeShippingPreference(preference) {
            if (!preference) return null;
            const raw = String(preference).trim().toLowerCase();
            const kitValues = new Set([
                'shipping kit requested',
                'shipping_kit_requested',
                'ship kit',
                'ship_kit',
                'kit',
                'kit requested',
                'needs_printing',
                'kit_sent',
                'kit_in_transit',
                'kit_delivered'
            ]);
            const labelValues = new Set([
                'email label requested',
                'email_label_requested',
                'email label',
                'label',
                'label requested',
                'mail_in_label',
                'label_generated'
            ]);

            if (kitValues.has(raw)) {
                return 'Shipping Kit Requested';
            }
            if (labelValues.has(raw)) {
                return 'Email Label Requested';
            }

            const humanized = humanize(preference);
            if (humanized === 'Shipping Kit Requested' || humanized === 'Email Label Requested') {
                return humanized;
            }

            return 'Email Label Requested';
        }
    </script>

</body>
</html>
