<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <link rel="stylesheet" href="/assets/css/site-chrome.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SecondHandCell - Sell Your Device</title>
    <link rel="icon" href="/favicon/favicon.ico">
    <style>
        :root {
            --brand-primary: #15803d;
            --brand-secondary: #eab308;
            --brand-gradient: linear-gradient(135deg, #15803d 0%, #eab308 100%);
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-gray: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        /* Component Scoped Styles */
        .sell-app-wrapper { font-family: 'Inter', -apple-system, sans-serif; color: var(--text-main); line-height: 1.5; padding: 40px 0; }
        .hidden { display: none !important; }

        .app-container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .step-title { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 30px; }

        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .select-card {
            background: var(--white); border: 2px solid var(--border); border-radius: 12px;
            padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-card:hover { border-color: var(--brand-secondary); transform: translateY(-2px); }
        .select-card.active { border-color: var(--brand-primary); background: #f0fdf4; color: var(--brand-primary); box-shadow: 0 0 0 1px var(--brand-primary); }

        .breadcrumbs { display: flex; gap: 8px; margin-bottom: 30px; font-size: 13px; justify-content: center; flex-wrap: wrap; }
        .crumb {
            padding: 8px 16px; background: #e5e7eb; border-radius: 20px;
            transition: all 0.2s; position: relative; font-weight: 600; color: var(--text-muted);
            cursor: default;
        }

        .crumb.can-jump { cursor: pointer; }
        .crumb.can-jump:hover::after {
            content: "Take me to this step";
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 2px 8px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; z-index: 10;
        }

        .crumb.active { background: var(--brand-primary); color: white; cursor: default; }
        .crumb.filled { background: #dcfce7; color: var(--brand-primary); border: 1px solid var(--brand-primary); }

        .offer-card { background: var(--white); border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .price-val { font-size: 64px; font-weight: 900; margin: 5px 0; color: var(--text-main); }

        .req-box { text-align: left; max-width: 500px; margin: 20px auto; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

        .form-control { width: 100%; max-width: 400px; padding: 15px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 16px; outline: none; }
        .btn-primary {
            width: 100%; max-width: 400px; padding: 18px; background: var(--brand-gradient);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }

        @media (max-width: 600px) {
            .selection-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <header class="site-header" data-site-header>
        <div class="site-header__inner site-header__inner--centered">
            <div class="logo-container-left">
                <a href="/" class="logo-link" aria-label="SecondHandCell home">
                    <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320" height="320" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <div class="logo-text-container-center">
                <div class="logo-wordmark">
                    <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
                </div>
                <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
            </div>
            <nav class="header-auth-nav" aria-label="Account navigation">
                <div id="authStatusContainer" class="site-header__auth-wrapper">
                    <a href="/login.html" class="site-header__login">Login/Sign Up</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="sell-app-wrapper">
        <div class="app-container" id="selection-flow">
            <div class="breadcrumbs" id="crumbs"></div>

            <h2 class="step-title" id="step-name">Select Brand</h2>
            <div class="selection-grid" id="grid-content"></div>
        </div>

        <div class="app-container hidden" id="offer-view">
            <div class="breadcrumbs" id="final-crumbs"></div>

            <div class="offer-card">
                <h2 id="final-device-name" style="margin-bottom:5px;">--</h2>
                <div id="summary-tags" style="font-size: 12px; color: var(--brand-primary); font-weight: 700; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.5px;">
                </div>

                <div class="selection-grid" id="final-condition-grid" style="margin-bottom: 25px;">
                </div>

                <div style="font-size: 14px; font-weight: 600; color: var(--text-muted);">Instant Payout:</div>
                <div class="price-val" id="final-price">$0</div>

                <div class="req-box">
                    <div style="font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span id="condition-title-display">--</span> Requirements:
                    </div>
                    <ul id="condition-details" style="padding-left: 20px; font-size: 14px; color: var(--text-muted);">
                    </ul>
                </div>

                <input type="email" id="user-email" class="form-control" placeholder="Enter your email address">
                <button class="btn-primary" onclick="handleCheckout()">GET PAID INSTANTLY</button>
                <p style="margin-top: 20px;"><a href="#" onclick="resetFlow()" style="color: var(--brand-primary); font-size: 13px; font-weight: 700; text-decoration: none;">← Start New Trade-in</a></p>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="qty-modal">
        <div class="modal-card">
            <h3>Quantity</h3>
            <p>How many devices are you selling?</p>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin:20px;">
                <button onclick="changeQty(-1)" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--brand-primary); background:none; font-size: 20px; color: var(--brand-primary); cursor:pointer;">-</button>
                <span id="qty-val" style="font-size:32px; font-weight:800;">1</span>
                <button onclick="changeQty(1)" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--brand-primary); background:none; font-size: 20px; color: var(--brand-primary); cursor:pointer;">+</button>
            </div>
            <button class="btn-primary" onclick="finalSubmit()">CONTINUE TO CHECKOUT</button>
        </div>
    </div>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="index.html" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated </h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
                <p class="text-lg font-bold">IMPORTANT NOTICE</p>
                <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
            </div>
            <div class="mt-8">
                <div class="flex flex-wrap items-center justify-center gap-6 sm:flex-row sm:justify-center sm:gap-8 lg:justify-start">
                    <a href="https://www.sellcell.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" width="150" height="107" alt="SellCell Accredited Buyer" loading="lazy" class="h-20 w-auto object-contain">
                    </a>
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://cdn.trustpilot.net/brand-assets/4.1.0/stars/stars-5.png" alt="Trustpilot 5 star rating" loading="lazy" class="h-12 w-auto object-contain">
                    </a>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <script type="module">
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { db } from "/assets/js/firebase-config.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let data = {
            brands: [],
            models: {},
            storage: [],
            locks: [],
            conditions: []
        };

        let selections = { brand: '', model: '', storage: '', lock: '', condition: '', qty: 1 };
        let currentStep = 'brand';
        let isFinalView = false;
        const stepOrder = ['brand', 'model', 'storage', 'lock', 'condition'];

        const buildSortedArray = (values) => Array.from(values).filter(Boolean).sort((a, b) => a.localeCompare(b));

        const loadDeviceData = async () => {
            const devicesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/devices`));
            const brandSet = new Set();
            const modelMap = {};
            const storageSet = new Set();
            const lockSet = new Set();

            devicesSnapshot.forEach((doc) => {
                const device = doc.data() || {};
                const brand = device.brand || device.make || device.manufacturer;
                const model = device.model || device.name;
                const storage = device.storage || device.capacity;
                const lock = device.lock || device.network || device.carrier;

                if (brand) {
                    brandSet.add(brand);
                    if (model) {
                        if (!modelMap[brand]) {
                            modelMap[brand] = new Set();
                        }
                        modelMap[brand].add(model);
                    }
                }
                if (storage) storageSet.add(storage);
                if (lock) lockSet.add(lock);
            });

            data.brands = buildSortedArray(brandSet);
            data.models = Object.entries(modelMap).reduce((acc, [brand, models]) => {
                acc[brand] = buildSortedArray(models);
                return acc;
            }, {});
            data.storage = buildSortedArray(storageSet);
            data.locks = buildSortedArray(lockSet);
        };

        const loadPricingData = async () => {
            const pricingSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/pricing`));
            data.conditions = pricingSnapshot.docs.map((doc) => {
                const pricing = doc.data() || {};
                const desc = Array.isArray(pricing.desc) ? pricing.desc : pricing.description || [];
                return {
                    name: pricing.name || pricing.condition || doc.id,
                    price: pricing.price ?? pricing.amount ?? 0,
                    desc: Array.isArray(desc) ? desc : [desc]
                };
            }).sort((a, b) => a.name.localeCompare(b.name));
        };

        const fetchSellData = async () => {
            await Promise.all([loadDeviceData(), loadPricingData()]);
        };

        function init() {
            const params = new URLSearchParams(window.location.search);
            stepOrder.forEach(step => {
                if (params.has(step)) selections[step] = params.get(step);
            });

            fetchSellData()
                .then(() => renderStep())
                .catch((error) => {
                    console.error('Failed to load sell flow data.', error);
                    renderStep();
                });
        }

        function jumpTo(step) {
            const targetIdx = stepOrder.indexOf(step);
            const currentIdx = isFinalView ? stepOrder.length : stepOrder.indexOf(currentStep);

            if (targetIdx < currentIdx) {
                isFinalView = false;
                document.getElementById('offer-view').classList.add('hidden');
                document.getElementById('selection-flow').classList.remove('hidden');
                currentStep = step;
                renderStep();
                updateURL();
            }
        }

        function renderStep() {
            const grid = document.getElementById('grid-content');
            const title = document.getElementById('step-name');
            grid.innerHTML = '';

            let items = [];
            if (currentStep === 'brand') {
                title.innerText = "Select Brand";
                items = data.brands;
            } else if (currentStep === 'model') {
                title.innerText = `Which ${selections.brand} Model?`;
                items = data.models[selections.brand] || [];
            } else if (currentStep === 'storage') {
                title.innerText = "Select Capacity";
                items = data.storage;
            } else if (currentStep === 'lock') {
                title.innerText = "Select Network";
                items = data.locks;
            } else if (currentStep === 'condition') {
                title.innerText = "Overall Condition";
                items = data.conditions.map(c => c.name);
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'select-card';
                if (selections[currentStep] === item) card.classList.add('active');
                card.innerText = item;
                card.onclick = () => handleSelect(item);
                grid.appendChild(card);
            });

            updateCrumbs();
        }

        function handleSelect(val) {
            selections[currentStep] = val;
            updateURL();

            const currentIdx = stepOrder.indexOf(currentStep);
            if (currentIdx < stepOrder.length - 1) {
                currentStep = stepOrder[currentIdx + 1];
                renderStep();
            } else {
                showOffer();
            }
        }

        function updateCrumbs() {
            const crumbsContainer = isFinalView ? document.getElementById('final-crumbs') : document.getElementById('crumbs');
            crumbsContainer.innerHTML = '';
            const currentIdx = isFinalView ? stepOrder.length : stepOrder.indexOf(currentStep);

            stepOrder.forEach((stepKey, i) => {
                const c = document.createElement('span');
                c.className = 'crumb';
                c.onclick = () => jumpTo(stepKey);

                if (i === currentIdx) {
                    c.classList.add('active');
                    c.innerText = stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                } else if (i < currentIdx) {
                    c.classList.add('filled', 'can-jump');
                    c.innerText = selections[stepKey] || stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                } else {
                    c.innerText = stepKey.charAt(0).toUpperCase() + stepKey.slice(1);
                }
                crumbsContainer.appendChild(c);
            });
        }

        function showOffer() {
            isFinalView = true;
            document.getElementById('selection-flow').classList.add('hidden');
            document.getElementById('offer-view').classList.remove('hidden');

            document.getElementById('final-device-name').innerText = selections.model;
            document.getElementById('summary-tags').innerText = `${selections.storage}  •  ${selections.lock}`;

            if (!selections.condition) selections.condition = data.conditions[0]?.name || 'Flawless';

            renderFinalConditionGrid();
            updatePriceDisplay();
            updateCrumbs();
        }

        function renderFinalConditionGrid() {
            const grid = document.getElementById('final-condition-grid');
            grid.innerHTML = '';
            data.conditions.forEach(c => {
                const card = document.createElement('div');
                card.className = 'select-card';
                if (selections.condition === c.name) card.classList.add('active');
                card.innerHTML = `<div>${c.name}</div>`;

                card.onclick = () => {
                    selections.condition = c.name;
                    renderFinalConditionGrid();
                    updatePriceDisplay();
                };
                grid.appendChild(card);
            });
        }

        function updatePriceDisplay() {
            const cond = data.conditions.find(c => c.name === selections.condition);
            if (!cond) return;

            document.getElementById('final-price').innerText = `$${cond.price}`;
            document.getElementById('condition-title-display').innerText = cond.name;

            const details = document.getElementById('condition-details');
            details.innerHTML = cond.desc.map(d => `<li>${d}</li>`).join('');
        }

        function updateURL() {
            const url = new URL(window.location);
            Object.keys(selections).forEach(key => {
                if (selections[key] && key !== 'qty') url.searchParams.set(key, selections[key]);
            });
            window.history.replaceState({}, '', url);
        }

        function handleCheckout() {
            const email = document.getElementById('user-email').value;
            if (!email.includes('@')) return alert("Enter valid email.");
            document.getElementById('qty-modal').style.display = 'flex';
        }

        function changeQty(v) {
            selections.qty = Math.max(1, selections.qty + v);
            document.getElementById('qty-val').innerText = selections.qty;
        }

        function finalSubmit() {
            console.log("Submit to DB:", selections);
        }

        function resetFlow() {
            window.location.search = '';
        }

        window.addEventListener('load', init);
        window.handleCheckout = handleCheckout;
        window.resetFlow = resetFlow;
        window.changeQty = changeQty;
        window.finalSubmit = finalSubmit;
    </script>
</body>
</html>
