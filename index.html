<!DOCTYPE html>
<html lang="en">
<head>
    <script>
      window.SHC_API_BASE_URL = "https://api.secondhandcell.com/server";
    </script>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - Turn Your Old Phone Into Cash!</title>
    <meta name="description" content="Turn your old phone into cash with SecondHandCell. Get a quick, easy, and transparent quote for your iPhone, Samsung, and more. Shipping kit available and fast payment." />
    
    <meta name="author" content="Saul Setton" />
    <meta name="keywords" content="sell used phone, trade in old phone, get cash for phone, sell iPhone, sell Samsung, secondhand cell, used device buyer, iPhone trade-in, Samsung trade-in" />
    <link rel="canonical" href="/" />
    <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />

    <!-- Tailwind CDN for testing -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Keep the homepage canonical on the root URL to avoid duplicate variants.
        (function enforceCanonicalHome() {
            const canonicalLink = document.querySelector('link[rel="canonical"]');
            if (canonicalLink) {
                canonicalLink.setAttribute('href', '/');
            }
            if (window.location.pathname === '/index.html') {
                window.history.replaceState({}, '', '/');
            }
        })();
    </script>

    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "/#organization",
      "name": "SecondHandCell",
      "url": "/",
      "logo": "/assets/logo.webp",
      "sameAs": [
        "https://www.trustpilot.com/evaluate/secondhandcell.com",
        "https://www.yelp.com/writeareview/biz/KWMxMMypF1yAfwH1rdKgJw"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "/#website",
      "url": "/",
      "name": "SecondHandCell - Turn Your Old Phone Into Cash!",
      "description": "Get an instant, transparent, and hassle-free quote for your used iPhone, Samsung, and more. Shipping kit available and fast payment.",
      "publisher": { "@id": "/#organization" },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "/search/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      },
      "hasPart": [
        {
          "@type": "WebPage",
          "url": "/sell/",
          "name": "Get Instant Quote"
        },
        {
          "@type": "WebPage",
          "url": "/iphone/",
          "name": "Sell Your iPhone"
        },
        {
          "@type": "WebPage",
          "url": "/samsung/",
          "name": "Sell Your Samsung"
        }
      ]
    }
  ]
}
    </script>

    <link rel="icon" href="/favicon/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="image" href="/iphone/assets/i15pm.webp" type="image/webp" imagesrcset="/iphone/assets/i15pm-500.webp 500w, /iphone/assets/i15pm-1000.webp 1000w" imagesizes="(max-width: 640px) 160px, (max-width: 1024px) 200px, 250px">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8JYPJDKSP8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-17534255111');
        gtag('config', 'G-8JYPJDKSP8');
    </script>

    <style>
        /* Base styles */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l100 100' stroke-width='1' stroke='%23ffffff' opacity='0.05'/%3E%3Cpath d='M100 0L0 100' stroke-width='1' stroke='%23ffffff' opacity='0.05'/%3E%3C/svg%3E");
            background-size: 20px 20px;
            color: #1a202c;
        }

        .icon {
            width: 1em; height: 1em; fill: currentColor; display: inline-block; vertical-align: middle;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp { animation: fadeInUp 0.8s ease-out forwards; }
        
        .homepage-card-link:hover .homepage-card-inner,
        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .homepage-card-inner, .feature-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem; border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8;
            font-weight: 700; font-size: 1.125rem; cursor: pointer; user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white; border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem; z-index: 50;
        }

        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; opacity: 0; visibility: hidden; }
        .modal.is-visible { opacity: 1; visibility: visible; }
        .modal-content { transform: translateY(-20px); transition: transform 0.3s ease-out; }
        .modal.is-visible .modal-content { transform: translateY(0); }

        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }

        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }

        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }

        @media (max-width: 640px) {
            .site-header--mobile-compact .site-header__inner {
                flex-direction: row; flex-wrap: nowrap; align-items: center;
                justify-content: space-between; padding: 0.4rem 0.75rem; gap: 0.5rem;
            }
            .site-header--mobile-compact .logo-container-left { flex: 0 0 auto; width: auto; }
            .site-header--mobile-compact .logo-link { height: 2rem; }
            .site-header--mobile-compact .logo-image { max-height: 2rem; }
            .site-header--mobile-compact .logo-text-container-center {
                flex: 1 1 auto; align-items: flex-start; text-align: left; margin-top: 0;
            }
            .site-header--mobile-compact .logo-wordmark { font-size: 1rem; }
            .site-header--mobile-compact .logo-tagline { display: none; }
            .site-header--mobile-compact .header-auth-nav { flex: 0 0 auto; width: auto; margin-top: 0; justify-content: flex-end; }
            .site-header--mobile-compact .site-header__auth-wrapper { width: auto; }
            .site-header--mobile-compact .site-header__login { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
            .site-header--mobile-compact .user-monogram { width: 2rem; height: 2rem; font-size: 0.75rem; }
        }

        /* Testimonial styles */
        .testimonial-section { position: relative; background: #f7faff; }
        .testimonial-glow { position: absolute; width: 320px; height: 320px; border-radius: 50%; filter: blur(120px); opacity: 0.75; z-index: 0; }
        .testimonial-glow--left { top: -120px; left: -80px; background: radial-gradient(circle at center, rgba(79, 70, 229, 0.4), rgba(59, 130, 246, 0.1)); }
        .testimonial-glow--right { bottom: -160px; right: -60px; background: radial-gradient(circle at center, rgba(14, 165, 233, 0.45), rgba(191, 219, 254, 0.05)); }
        .testimonial-card {
            position: relative; z-index: 1; background: rgba(255, 255, 255, 0.97);
            border-radius: 1.5rem; border: 1px solid rgba(191, 219, 254, 0.7);
            box-shadow: 0 35px 65px -40px rgba(37, 99, 235, 0.55); padding: 2.25rem;
            height: 100%; display: flex; flex-direction: column; gap: 1.5rem; transition: all 0.35s ease;
        }
        .testimonial-card:hover { transform: translateY(-6px); box-shadow: 0 45px 70px -36px rgba(30, 64, 175, 0.65); }
        .testimonial-stars { color: #facc15; display: flex; gap: 0.35rem; font-size: 1.1rem; }
        .testimonial-avatar { width: 3.25rem; height: 3.25rem; border-radius: 9999px; object-fit: cover; }

        /* REFINED HERO STYLES */
        .hero-section {
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
            position: relative;
            padding: 4rem 0 5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            min-height: 80vh;
        }

        .hero-section::before {
            content: ''; position: absolute; inset: 0;
            background-image: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                              radial-gradient(circle at 80% 70%, rgba(74, 222, 128, 0.1) 0%, transparent 40%);
            z-index: 1;
        }

        /* Improved phone composition for both Desktop & Mobile */
        .hero-visual-wrapper {
            position: absolute;
            inset: 0;
            z-index: 1; /* Lower than content */
            pointer-events: none;
        }

        .hero-phone {
            position: absolute;
            transition: transform 1s cubic-bezier(0.2, 1, 0.3, 1);
            filter: drop-shadow(0 25px 50px rgba(0,0,0,0.5));
        }

        /* Desktop: Phones on sides */
        @media (min-width: 1024px) {
            #iphone-hero {
                width: 320px; right: 5%; top: 45%; transform: translateY(-50%) rotate(5deg);
            }
            #samsung-hero {
                width: 320px; left: 5%; top: 55%; transform: translateY(-50%) rotate(-5deg);
            }
        }

        /* Mobile: Unified premium composition behind text */
        @media (max-width: 1023px) {
            .hero-section { min-height: 75vh; padding-top: 2rem; padding-bottom: 3rem; }
            .hero-visual-wrapper {
                display: flex; justify-content: center; align-items: center;
                opacity: 0.25; /* Subtle background presence */
            }
            #iphone-hero { width: 220px; position: relative; right: auto; top: auto; transform: translateX(40px) rotate(12deg); }
            #samsung-hero { width: 220px; position: relative; left: auto; top: auto; transform: translateX(-40px) rotate(-12deg); }
        }

        .hero-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8; padding: 0.5rem 1.25rem;
            border-radius: 9999px; font-weight: 600; font-size: 0.875rem;
            letter-spacing: 0.05em; text-transform: uppercase;
            margin-bottom: 2rem;
        }

        .hero-h1 {
            line-height: 1.1;
            font-weight: 850;
            color: white;
            margin-bottom: 1.5rem;
        }

        .hero-p {
            color: #94a3b8;
            max-width: 600px;
            margin: 0 auto 2.5rem;
            line-height: 1.6;
        }

        .hero-content {
            position: relative;
            z-index: 10; /* Ensure text is always on top */
        }

        .hero-stat-box {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1.25rem;
            border-radius: 1rem;
            backdrop-filter: blur(4px);
        }

        .action-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 10px 25px -5px rgba(34, 197, 94, 0.4);
            transition: all 0.3s ease;
        }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(34, 197, 94, 0.5); }

        /* Fancy formatting for mobile/small text */
        .fancy-header-text { font-family: 'Dancing Script', cursive; }
        .card-container { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    </style>
    <link rel="stylesheet" href="/assets/css/site-chrome-09630dd8.css">
</head>
<body class="bg-slate-50">
    <svg xmlns="http://www.w3.org/2000/svg" style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <linearGradient id="icon-star-half-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="50%" stop-color="currentColor" />
                <stop offset="50%" stop-color="transparent" />
            </linearGradient>
        </defs>
        <symbol id="icon-bolt" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M11 3 5 14h5l-1 7 7-12h-5l1-6H11z"></path>
        </symbol>
        <symbol id="icon-star" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 3.25 9.34 8.4l-5.59.81 4.04 3.94-.95 5.55L12 16.9l5.16 2.7-.98-5.45 3.97-3.87-5.56-.82L12 3.25z"></path>
        </symbol>
        <symbol id="icon-star-half" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 3.25 9.34 8.4l-5.59.81 4.04 3.94-.95 5.55L12 16.9V3.25z" fill="url(#icon-star-half-gradient)"></path>
            <path d="M12 3.25 9.34 8.4l-5.59.81 4.04 3.94-.95 5.55L12 16.9l5.16 2.7-.98-5.45 3.97-3.87-5.56-.82L12 3.25z" fill="none" stroke="currentColor" stroke-width="1.1"></path>
        </symbol>
        <symbol id="icon-bullhorn" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M20 4.5 9 9v9.75a1.75 1.75 0 0 1-3.45.55L4.5 16V9.75H3V8.25h1.5V7.5a1.5 1.5 0 0 1 2.18-1.35L20 4.5Z"></path>
            <path d="M17 9.5v6" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round"></path>
        </symbol>
        <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M4 12.75h11.69l-2.72 2.72L14.6 17.5 20 12l-5.4-5.5-1.63 1.98 2.72 2.77H4v1.5Z"></path>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M6.34 5.34 5.28 6.4 10.88 12l-5.6 5.6 1.06 1.06L12 13.12l5.6 5.54 1.06-1.06L13.12 12l5.54-5.6-1.06-1.06L12 10.88 6.34 5.34Z"></path>
        </symbol>
    </svg>

<header class="site-header site-header--mobile-compact" data-site-header>
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link" aria-label="SecondHandCell home">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320" height="320" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav" aria-label="Account navigation">
            <div id="authStatusContainer" class="site-header__auth-wrapper">
                <a href="#" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden"></div>
                <div id="authDropdown" class="auth-dropdown hidden">
                    <a href="/my-account.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Account</a>
                    <a href="/track-order.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Track an Order</a>
                    <button id="logoutBtn" class="btn-red-logout">Logout</button>
                </div>
            </div>
        </nav>
    </div>
</header>

<section class="ship48-banner" data-ship48-banner hidden>
    <div class="ship48-banner__inner">
        <p class="ship48-banner__message" title="Email label orders sent within 48 hours get +$10 with SHIP48 when you send within 48h.">
            <strong>SHIP48</strong> Email label orders sent within 48h earn +$10 with code <span class="ship48-banner__code">SHIP48</span>. Email label only. <span class="ship48-banner__counter" data-ship48-counter></span>
            <span class="ship48-banner__status" data-ship48-status></span>
        </p>
        <div class="ship48-banner__actions">
            <button type="button" class="ship48-banner__apply" data-ship48-apply>Apply SHIP48</button>
            <button type="button" class="ship48-banner__start" data-ship48-start>Start my quote now</button>
        </div>
    </div>
    <button type="button" class="ship48-banner__dismiss" aria-label="Dismiss Ship48 promo" data-ship48-dismiss>&times;</button>
</section>

    <main>
        <!-- HERO SECTION REDESIGNED -->
        <section class="hero-section text-center">
            <div class="hero-visual-wrapper">
                <div id="iphone-hero" class="hero-phone animate-pulse">
                    <img src="/iphone/assets/i15pm.webp" srcset="/iphone/assets/i15pm-500.webp 500w, /iphone/assets/i15pm-1000.webp 1000w" sizes="(max-width: 640px) 160px, (max-width: 1024px) 200px, 250px" width="200" height="250" loading="eager" fetchpriority="high" decoding="async" alt="iPhone 15 Pro Max" class="w-full h-auto">
                </div>
                <div id="samsung-hero" class="hero-phone animate-pulse">
                    <img src="/samsung/assets/s24u.webp" srcset="/samsung/assets/s24u-500.webp 500w, /samsung/assets/s24u-1000.webp 1000w" sizes="(max-width: 640px) 160px, (max-width: 1024px) 200px, 250px" width="216" height="216" loading="eager" fetchpriority="low" decoding="async" alt="Samsung Galaxy S24 Ultra" class="w-full h-auto">
                </div>
            </div>

            <div class="container mx-auto px-6 hero-content">
                <div class="hero-badge mx-auto">
                    <svg class="icon text-green-400" aria-hidden="true"><use href="#icon-bolt"></use></svg>
                    <span>Instant Price Guarantee</span>
                </div>

                <h1 class="hero-h1 text-4xl sm:text-5xl md:text-7xl">
                    <span class="block text-slate-300 font-medium text-2xl sm:text-3xl md:text-4xl mb-2">Sell Your Used Device</span>
                    <span class="block">Get <span class="text-green-400">Paid Cash</span> Today</span>
                </h1>
                
                <p class="hero-p text-base md:text-xl">
                    The fastest way to trade in your iPhone or Samsung. High payouts, free shipping, and payments sent within 24 hours of inspection.
                </p>

                <div class="mb-12">
                    <a href="sell/" id="heroOfferBtn" class="action-button text-white px-10 py-5 rounded-full font-bold text-lg md:text-xl inline-flex items-center gap-3">
                        Get My Instant Quote
                        <svg class="icon" aria-hidden="true"><use href="#icon-arrow-right"></use></svg>
                    </a>
                    <p class="mt-4 text-xs md:text-sm text-slate-500 uppercase tracking-widest">30-Day Price Lock Included</p>
                </div>

                <!-- Stats Layout Updated for Mobile -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 max-w-4xl mx-auto mt-16 text-white">
                    <div class="hero-stat-box">
                        <p class="text-2xl md:text-4xl font-black">100K+</p>
                        <p class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider mt-1">Devices Bought</p>
                    </div>
                    <div class="hero-stat-box">
                        <p class="text-2xl md:text-4xl font-black">98%</p>
                        <p class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider mt-1">Happy Sellers</p>
                    </div>
                    <div class="hero-stat-box">
                        <p class="text-2xl md:text-4xl font-black">$400+</p>
                        <p class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider mt-1">Avg. Payout</p>
                    </div>
                    <div class="hero-stat-box">
                        <p class="text-2xl md:text-4xl font-black">24H</p>
                        <p class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider mt-1">Fast Payment</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="features" class="bg-slate-50 container mx-auto px-4 py-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Why Sell With Us?</h2>
                <p class="mt-3 text-lg text-slate-600">Our process is simple, safe, and gets you the most for your device.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üì¶</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-shipping-btn">Shipping Kit Available</h3><p class="text-slate-600">We send you a prepaid box. Just pack your device and drop it in the mail.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üí∏</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-payment-btn">Fast Payment</h3><p class="text-slate-600">Get paid quickly via Venmo, Zelle, or PayPal as soon as we inspect your device.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üõ°Ô∏è</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-data-btn">Data Protection</h3><p class="text-slate-600">We professionally wipe all personal data from every device we receive.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üîí</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-payout-btn">Highest Payouts</h3><p class="text-slate-600">Our price-lock guarantee ensures you get the quote you were offered.</p></div>
            </div>
        </section>

        <section id="customer-reviews" class="testimonial-section py-20 overflow-hidden">
            <div class="testimonial-glow testimonial-glow--left" aria-hidden="true"></div>
            <div class="testimonial-glow testimonial-glow--right" aria-hidden="true"></div>
            <div class="container mx-auto px-4 relative z-[1]">
                <div class="text-center max-w-3xl mx-auto">
                    <span class="inline-flex items-center justify-center px-4 py-2 rounded-full text-sm md:text-base font-semibold uppercase tracking-[0.2em] text-white bg-slate-900/90 shadow-sm ring-1 ring-slate-700">500+ 3‚Äì5 Star Reviews</span>
                    <h2 class="mt-4 text-3xl md:text-4xl font-bold text-slate-900">What Our Customers Say</h2>
                    <div class="mt-5 flex flex-col items-center gap-3">
                        <div class="testimonial-stars text-2xl" aria-hidden="true">
                            <svg class="icon" aria-hidden="true"><use href="#icon-star"></use></svg>
                            <svg class="icon" aria-hidden="true"><use href="#icon-star"></use></svg>
                            <svg class="icon" aria-hidden="true"><use href="#icon-star"></use></svg>
                            <svg class="icon" aria-hidden="true"><use href="#icon-star"></use></svg>
                            <svg class="icon" aria-hidden="true"><use href="#icon-star-half"></use></svg>
                        </div>
                        <p class="testimonial-rating-label text-slate-600">4.8 out of 5 based on 2,341 reviews</p>
                    </div>
                </div>
                <div class="mt-12 relative">
                    <div id="customerReviewsTrack" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        <article class="testimonial-card">
                            <div>
                                <div class="testimonial-stars" aria-hidden="true"><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg></div>
                                <p class="mt-3 text-slate-600 leading-relaxed">‚ÄúSecondHandCell handled my iPhone trade-in in days. The shipping kit arrived quickly, inspection was honest, and the payout hit my account the same afternoon.‚Äù</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <img src="/assets/faces/3.webp" loading="lazy" decoding="async" width="160" height="160" alt="Michael" class="testimonial-avatar">
                                <div><p class="font-bold">Michael Rodriguez</p><p class="text-xs text-slate-500">iPhone 15 Pro Max Seller</p></div>
                            </div>
                        </article>
                        <article class="testimonial-card">
                            <div>
                                <div class="testimonial-stars" aria-hidden="true"><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star-half"></use></svg></div>
                                <p class="mt-3 text-slate-600 leading-relaxed">‚ÄúThe $10 shipping kit deduction was worth it‚Äîeverything I needed was in the box. Their portal kept me updated until the payout cleared the next morning.‚Äù</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <img src="/assets/faces/5.webp" loading="lazy" decoding="async" width="160" height="160" alt="Sarah" class="testimonial-avatar">
                                <div><p class="font-bold">Sarah Johnson</p><p class="text-xs text-slate-500">Galaxy S23 Ultra Seller</p></div>
                            </div>
                        </article>
                        <article class="testimonial-card">
                            <div>
                                <div class="testimonial-stars" aria-hidden="true"><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg><svg class="icon"><use href="#icon-star"></use></svg></div>
                                <p class="mt-3 text-slate-600 leading-relaxed">‚ÄúAs a teacher with zero free time, I loved how transparent the process was. I chose an email label, shipped the same day, and had my Zelle transfer within 24 hours.‚Äù</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <img src="/assets/faces/7.webp" loading="lazy" decoding="async" width="160" height="160" alt="Emily" class="testimonial-avatar">
                                <div><p class="font-bold">Emily Thompson</p><p class="text-xs text-slate-500">Teacher ‚Ä¢ Chicago, IL</p></div>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        </section>

        <section id="popular" class="bg-white py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Popular Devices We Buy</h2>
                    <p class="mt-3 text-lg text-slate-600">From the latest models to older favorites, we buy them all.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                    <a href="sell/?device=iphone-15-pro-max" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="i15pm_pop_img" src="" data-base-src="/iphone/assets/i15pm" loading="lazy" decoding="async" alt="iPhone 15 Pro Max" class="mx-auto mb-4 h-40 object-contain" width="200" height="250"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 15 Pro Max</h3><p class="text-green-600 font-bold mb-4" data-device-price data-brand="iphone" data-slug="15-pro-max">Up to ‚Äî</p><span id="popularOfferBtn-i15pm" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=samsung-galaxy-s24-ultra" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="s24u_pop_img" src="" data-base-src="/samsung/assets/s24u" loading="lazy" decoding="async" alt="Samsung Galaxy S24 Ultra" class="mx-auto mb-4 h-40 object-contain" width="216" height="216"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S24 Ultra</h3><p class="text-green-600 font-bold mb-4" data-device-price data-brand="samsung" data-slug="galaxy-s24-ultra">Up to ‚Äî</p><span id="popularOfferBtn-s24u" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=iphone-16" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="i13_pop_img" src="" data-base-src="/iphone/assets/i16" loading="lazy" decoding="async" alt="iPhone 16" class="mx-auto mb-4 h-40 object-contain" width="200" height="246"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 16</h3><p class="text-green-600 font-bold mb-4" data-device-price data-brand="iphone" data-slug="16">Up to ‚Äî</p><span id="popularOfferBtn-i13" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=samsung-galaxy-s22" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="s22_pop_img" src="" data-base-src="/samsung/assets/s22" loading="lazy" decoding="async" alt="Samsung Galaxy S22" class="mx-auto mb-4 h-40 object-contain" width="216" height="216"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S22</h3><p class="text-green-600 font-bold mb-4" data-device-price data-brand="samsung" data-slug="galaxy-s22">Up to ‚Äî</p><span id="popularOfferBtn-s22" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-sm">Get Offer</span></div></a>
                </div>
            </div>
        </section>

        <section id="external-reviews" class="bg-slate-100 py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Trusted By Thousands</h2>
                    <p class="mt-3 text-lg text-slate-600">See our latest reviews and ratings on external, independent platforms.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 max-w-4xl mx-auto">
                    <a href="https://search.google.com/local/reviews?placeid=YOUR_GOOGLE_PLACE_ID" target="_blank" class="review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all border-t-4 border-blue-600">
                            <img src="/assets/Googlelogo.svg" alt="Google" class="h-10 mb-3">
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Google Reviews</h3>
                            <span class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold">See Reviews</span>
                        </div>
                    </a>
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" class="review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all border-t-4 border-green-600">
                            <svg class="icon text-4xl text-green-500 mb-3"><use href="#icon-star"></use></svg>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Trustpilot</h3>
                            <span class="mt-4 bg-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold">View Rating</span>
                        </div>
                    </a>
                    <a href="https://www.yelp.com/writeareview/biz/KWMxMMypF1yAfwH1rdKgJw" target="_blank" class="review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all border-t-4 border-red-600">
                            <svg class="icon text-4xl text-red-500 mb-3"><use href="#icon-bullhorn"></use></svg>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Yelp Reviews</h3>
                            <span class="mt-4 bg-red-600 text-white px-4 py-2 rounded-full text-sm font-semibold">Read Reviews</span>
                        </div>
                    </a>
                </div>
            </div>
        </section>

        <section id="cta" class="bg-indigo-600 py-16 text-center">
            <div class="container mx-auto px-4">
                <h2 class="text-4xl md:text-5xl font-extrabold text-white mb-4">Ready to Turn Your Device Into Cash?</h2>
                <p class="text-lg text-indigo-100 mb-8 max-w-2xl mx-auto">Get your instant quote now‚Äîit only takes 60 seconds.</p>
                <a href="sell/" class="bg-white text-indigo-700 px-12 py-4 rounded-full font-bold text-xl shadow-2xl action-button hover:bg-indigo-50 inline-block">
                    Sell Device Now!
                    <svg class="icon ml-2" aria-hidden="true"><use href="#icon-arrow-right"></use></svg>
                </a>
            </div>
        </section>
    </main>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links </h3><ul class="space-y-2"><li><a href="index.html" class="text-slate-400 hover:text-white">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white">About Us</a></li><li><a href="/privacy.html" class="text-slate-400 hover:text-white">Privacy Policy</a></li><li><a href="/terms.html" class="text-slate-400 hover:text-white">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">Stay Updated </h3>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Sign Up</button>
                    </form>
                </div>
            </div>
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
                <p class="text-lg font-bold">IMPORTANT NOTICE</p>
                <p class="mt-2 text-sm">We do not purchase blacklisted or lost/stolen devices.</p>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <div id="loginModal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Login</h2>
                <button class="text-slate-400 hover:text-slate-600 transition close-modal-btn"><svg class="icon text-2xl"><use href="#icon-close"></use></svg></button>
            </div>
            <form id="loginForm" class="space-y-4">
                <button type="button" class="btn-google-style">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5 mr-3">
                    Login with Google
                </button>
                <input type="email" placeholder="Email Address" class="w-full border p-3 rounded-lg">
                <input type="password" placeholder="Password" class="w-full border p-3 rounded-lg">
                <button type="submit" class="btn-dark-slate">Login</button>
            </form>
        </div>
    </div>

    <script type="module">
import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, setDoc, getDocs, runTransaction, setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
import { browserLocalPersistence, createUserWithEmailAndPassword, getAuth, GoogleAuthProvider, onAuthStateChanged, sendPasswordResetEmail, setPersistence, signInWithEmailAndPassword, signInWithPopup, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

// Firebase configuration (from assets/js/firebase-config.js)
const firebaseConfig = {
  apiKey: 'AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k',
  authDomain: 'auth.secondhandcell.com',
  projectId: 'buyback-a0f05',
  storageBucket: 'buyback-a0f05.appspot.com',
  messagingSenderId: '876430429098',
  appId: '1:876430429098:web:f6dd64b1960d90461979d3',
  measurementId: 'G-6WWQN44JHT',
};
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getFirestore(app);
const firebaseApp = app;
const getFirebaseApp = () => firebaseApp;
if (typeof window !== 'undefined') { window.firebaseConfig = firebaseConfig; window.firebaseApp = firebaseApp; }

// API client (from public/js/apiClient.js)
const auth = getAuth(firebaseApp);

const defaultApiBase = "/api";

let apiBase =
  (typeof window !== "undefined" &&
    (window.SHC_API_BASE_URL || window.API_BASE_URL || window.API_BASE)) ||
  defaultApiBase;

const RAILWAY_API_ORIGIN = "https://shc33.up.railway.app";

function normalizeApiBase(base) {
  if (typeof base !== "string") {
    return base;
  }

  const trimmed = base.trim().replace(/\/$/, "");
  if (trimmed === RAILWAY_API_ORIGIN) {
    return `${trimmed}/server`;
  }

  return trimmed;
}

apiBase = normalizeApiBase(apiBase);

function setApiBase(nextBase) {
  if (nextBase) {
    apiBase = normalizeApiBase(nextBase);
  }
}

function resolveUrl(path) {
  const cleanedBase = apiBase.replace(/\/$/, "");
  const cleanedPath = path.startsWith("/") ? path : `/${path}`;
  return new URL(`${cleanedBase}${cleanedPath}`, window.location.origin).toString();
}

async function getIdToken({ forceRefresh = false } = {}) {
  const user = auth.currentUser;
  if (!user) {
    return null;
  }
  return user.getIdToken(forceRefresh);
}

async function requestWithAuth(method, path, data, options = {}, { forceRefresh = false } = {}) {
  const { authRequired = false, headers = {}, ...fetchOptions } = options;
  const token = await getIdToken({ forceRefresh });

  if (authRequired && !token) {
    throw new Error("Authentication required. Please sign in and try again.");
  }

  const requestHeaders = {
    "Content-Type": "application/json",
    ...headers,
  };

  if (token) {
    requestHeaders.Authorization = `Bearer ${token}`;
  }

  return fetch(resolveUrl(path), {
    method,
    headers: requestHeaders,
    body: data ? JSON.stringify(data) : undefined,
    ...fetchOptions,
  });
}

async function apiRequest(method, path, data, options = {}) {
  let response = await requestWithAuth(method, path, data, options, { forceRefresh: false });

  if (response.status === 401) {
    response = await requestWithAuth(method, path, data, options, { forceRefresh: true });
  }

  const contentType = response.headers.get("content-type") || "";
  const payload = contentType.includes("application/json")
    ? await response.json()
    : await response.text();

  if (!response.ok) {
    const message = payload?.error || payload?.message || response.statusText;
    const error = new Error(message || "API request failed.");
    error.status = response.status;
    error.payload = payload;
    throw error;
  }

  return payload;
}

async function apiRaw(path, options = {}) {
  const { authRequired = false, headers = {}, body, method = "GET", ...fetchOptions } = options;
  const makeRequest = async (forceRefresh = false) => {
    const token = await getIdToken({ forceRefresh });

    if (authRequired && !token) {
      throw new Error("Authentication required. Please sign in and try again.");
    }

    const requestHeaders = { ...headers };
    if (token) {
      requestHeaders.Authorization = `Bearer ${token}`;
    }

    return fetch(resolveUrl(path), {
      method,
      headers: requestHeaders,
      body,
      ...fetchOptions,
    });
  };

  let response = await makeRequest(false);
  if (response.status === 401) {
    response = await makeRequest(true);
  }
  return response;
}

function apiGet(path, options) {
  return apiRequest("GET", path, undefined, options);
}

function apiPost(path, data, options) {
  return apiRequest("POST", path, data, options);
}

function apiPut(path, data, options) {
  return apiRequest("PUT", path, data, options);
}

function apiDelete(path, data, options) {
  return apiRequest("DELETE", path, data, options);
}

function apiFetch(path, options = {}) {
  return apiRequest(options.method || "GET", path, options.body, options);
}

// Popular pricing (from assets/js/popular-pricing.js)
const db = getFirestore(firebaseApp);

const formatPrice = (value) => value ? `Up to $${Math.round(value).toLocaleString()}` : 'Pricing coming soon';

const findHighestPrice = (prices = {}) => {
    let max = 0;
    Object.values(prices).forEach((storageOption = {}) => {
        Object.values(storageOption || {}).forEach((carrierPrices = {}) => {
            Object.values(carrierPrices || {}).forEach((price) => {
                if (typeof price === 'number') {
                    max = Math.max(max, price);
                }
            });
        });
    });
    return max || null;
};

const applyPopularPricing = async () => {
    const priceEls = document.querySelectorAll('[data-device-price]');
    if (!priceEls.length) return;

    await Promise.all(Array.from(priceEls).map(async (el) => {
        const brand = el.getAttribute('data-brand');
        const slug = el.getAttribute('data-slug');
        if (!brand || !slug) return;

        try {
            const snap = await getDoc(doc(db, `devices/${brand}/models`, slug));
            if (!snap.exists()) {
                console.warn(`No pricing found for ${brand}/${slug}`);
                el.textContent = formatPrice(null);
                return;
            }

            const highest = findHighestPrice(snap.data().prices || {});
            el.textContent = formatPrice(highest);
        } catch (error) {
            console.error(`Failed to load pricing for ${brand}/${slug}:`, error);
            el.textContent = formatPrice(null);
        }
    }));
};

document.addEventListener('DOMContentLoaded', applyPopularPricing);

// Home page logic (from assets/js/pages/index-b8699033.js)
setLogLevel('error');

// --- Firebase Click Tracker Function ---
const trackButtonClick = async (buttonName) => {
    const cleanedButtonName = buttonName.replace(/\s/g, '_').replace(/'/g, '');
    const buttonDocRef = doc(db, "button_clicks", cleanedButtonName);
    const userId = auth.currentUser?.uid || getOrCreateGuestId();

    try {
        await runTransaction(db, async (transaction) => {
            const buttonDoc = await transaction.get(buttonDocRef);
            if (!buttonDoc.exists()) {
                transaction.set(buttonDocRef, {
                    count: 1,
                    buttonName: buttonName,
                    history: [{ timestamp: serverTimestamp(), userId: userId }],
                    lastClicked: serverTimestamp()
                });
            } else {
                const data = buttonDoc.data();
                const updatedHistory = [...data.history, { timestamp: serverTimestamp(), userId: userId }];
                transaction.update(buttonDocRef, {
                    count: (data.count || 0) + 1,
                    history: updatedHistory,
                    lastClicked: serverTimestamp()
                });
            }
        });
        console.log(`Click on '${buttonName}' successfully tracked and updated.`);
    } catch (error) {
        console.error("Transaction failed: ", error);
    }
};

const getOrCreateGuestId = () => {
    let id = localStorage.getItem('guestChatId');
    if (!id) {
        id = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        localStorage.setItem('guestChatId', id);
    }
    return id;
};

document.addEventListener('DOMContentLoaded', function() {
    // Image loading with fallback
    function loadImageWithFallback(imgElement) {
        const baseSrc = imgElement.dataset.baseSrc;
        if (!baseSrc) return;
        const extensions = ['.webp', '.svg', '.avif', '.png', '.webp', '.webp'];
        let current = 0;
        function tryLoad() {
            if (current >= extensions.length) {
                if (imgElement.id.includes('_cat_img')) {
                    imgElement.src = `https://placehold.co/150x150/e0e7ff/4338ca?text=Category`;
                } else {
                    imgElement.src = `https://placehold.co/200x200/f0f4ff/6366f1?text=No+Image`;
                }
                imgElement.alt = "Image not available";
                return;
            }
            const testSrc = baseSrc + extensions[current];
            const img = new Image();
            img.onload = () => { imgElement.src = testSrc; };
            img.onerror = () => { current++; tryLoad(); };
            img.src = testSrc;
        }
        tryLoad();
    }
    document.querySelectorAll('img[data-base-src]').forEach(loadImageWithFallback);

    // Modals
    const modals = document.querySelectorAll('.modal');
    const openModal = (modalId) => document.getElementById(modalId)?.classList.add('is-visible');
    const closeModal = (modal) => modal.classList.remove('is-visible');

    // Auth-aware header controls
    const auth = getAuth(app);
    const loginNavBtn = document.getElementById('loginNavBtn');
    const userMonogram = document.getElementById('userMonogram');
    const authDropdown = document.getElementById('authDropdown');

    onAuthStateChanged(auth, (user) => {
        const isLoggedIn = !!user && !user.isAnonymous;
        if (loginNavBtn) {
            loginNavBtn.classList.toggle('hidden', isLoggedIn);
        }
        if (userMonogram) {
            const initialsSource = (user?.displayName || user?.email || '').trim();
            const initials = initialsSource
                ? initialsSource.split(' ').map((part) => part[0]).join('').substring(0, 2).toUpperCase()
                : '';
            if (isLoggedIn && initials) {
                userMonogram.textContent = initials;
            }
            userMonogram.classList.toggle('hidden', !isLoggedIn);
        }
        if (authDropdown) {
            authDropdown.classList.toggle('hidden', !isLoggedIn);
            if (!isLoggedIn) {
                authDropdown.classList.remove('is-visible');
            }
        }
    });

    const aboutUsLink = document.getElementById('aboutUsLink');
    if (aboutUsLink) {
        aboutUsLink.addEventListener('click', (e) => {
            e.preventDefault();
            openModal('aboutUsModal');
        });
    }

    modals.forEach(modal => {
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
        const closeBtn = modal.querySelector('.close-modal-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => closeModal(modal));
        }
    });

    // Click tracking for buttons
    const heroOfferBtn = document.getElementById('heroOfferBtn');
    if (heroOfferBtn) {
        heroOfferBtn.addEventListener('click', () => trackButtonClick('Hero_Get_Instant_Offer'));
    }

    const finalOfferBtn = document.getElementById('final OfferBtn');
    if (finalOfferBtn) {
        finalOfferBtn.addEventListener('click', () => trackButtonClick('Final_Sell_Device_Now'));
    }

    document.querySelectorAll('.feature-card h3').forEach(card => {
        card.addEventListener('click', () => {
            trackButtonClick(`Feature_Card_${card.textContent.trim()}`);
        });
    });

    document.querySelectorAll('.homepage-card-link').forEach(link => {
        link.addEventListener('click', (e) => {
            const deviceName = e.currentTarget.querySelector('h3').textContent;
            trackButtonClick(`Popular_Device_Get_Offer_${deviceName}`);
        });
    });

    document.querySelectorAll('.review-link-card').forEach(link => {
        link.addEventListener('click', () => {
            const platformName = link.querySelector('h3').textContent;
            trackButtonClick(`External_Review_Click_${platformName.replace(/\s/g, '_')}`);
        });
    });

    // Footer email signup
    const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
    const footerSignupMessage = document.getElementById('footerSignupMessage');
    if (footerEmailSignupForm && footerSignupMessage) {
        footerEmailSignupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('footerPromoEmail').value;
            footerSignupMessage.textContent = 'Submitting...';
            footerSignupMessage.className = 'mt-3 text-sm text-center text-blue-300';

            try {
                await addDoc(collection(db, "signed_up_emails"), {
                    email: email,
                    timestamp: new Date()
                });
                footerSignupMessage.textContent = 'Success! Thanks for signing up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-green-300';
                footerEmailSignupForm.reset();
                trackButtonClick('Footer_Email_Signup');
            } catch (error) {
                console.error("Error adding document: ", error);
                footerSignupMessage.textContent = 'Error: Could not sign up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-red-300';
            }
        });
    }

    // ===== CHAT WIDGET =====
    const chatWindow = document.getElementById('chat-window');
    if (!chatWindow) {
        console.debug('Chat widget disabled on this page.');
        // Scroll animations
        setupScrollAnimations();
        return;
    }

    const chatOpenBtn = document.getElementById('chat-open-btn');
    const chatCloseBtn = document.getElementById('chat-close-btn');
    const chatMinimizeBtn = document.getElementById('chat-minimize-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatInputContainer = document.getElementById('chat-input-container');
    const guestPromptContainer = document.getElementById('guest-prompt-container');
    const guestLoginBtn = document.getElementById('guest-login-btn');
    const unreadCounter = document.getElementById('unread-counter');
    const typingIndicatorContainer = document.getElementById('typing-indicator-container');
    const surveyContainer = document.getElementById('chat-survey-container');
    const surveyForm = document.getElementById('chat-survey-form');
    const starRatingContainer = document.getElementById('star-rating');
    const friendlinessRating = document.getElementById('friendliness-rating');
    const friendlinessValue = document.getElementById('friendliness-value');
    const endChatConfirmModal = document.getElementById('end-chat-confirm-modal');
    const endChatYesBtn = document.getElementById('end-chat-yes');
    const endChatNoBtn = document.getElementById('end-chat-no');
    const orderSelectionContainer = document.getElementById('order-selection-container');
    const orderList = document.getElementById('order-list');
    const closeOrderSelectionBtn = document.getElementById('close-order-selection-btn');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const globalTooltip = document.getElementById('globalTooltip');
    const orderSelectionPrompt = document.getElementById('order-selection-prompt');

    const CHAT_STORAGE_KEY = 'chatSessionState';

    const storeChatSession = (chatId) => {
        const user = auth.currentUser;
        if (!user || user.isAnonymous || !chatId) return;
        localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify({ chatId, uid: user.uid }));
    };

    const getStoredChatSession = () => {
        const raw = localStorage.getItem(CHAT_STORAGE_KEY);
        if (!raw) return null;
        try {
            const parsed = JSON.parse(raw);
            const user = auth.currentUser;
            if (!user || user.isAnonymous || parsed.uid !== user.uid) return null;
            return parsed;
        } catch (error) {
            console.error('Failed to parse stored chat session', error);
            return null;
        }
    };

    const clearStoredChatSession = () => {
        localStorage.removeItem(CHAT_STORAGE_KEY);
    };

    let currentChatId = null;
    let unsubscribeFromMessages = null;
    let unsubscribeFromChatSession = null;
    let isChatMinimized = true;
    let unreadCount = 0;
    let userTypingTimeout = null;
    let initialWelcomeRendered = {};
    let isFirstMessageSent = false;

    const notificationSound = new Audio('https://cdn.freesound.org/previews/253/253887_3900531-lq.mp3');
    notificationSound.volume = 0.5;

    const ensureUserAuthenticatedForChat = () => {
        const user = auth.currentUser;
        const isAuthenticated = !!user && !user.isAnonymous;
        if (!isAuthenticated) {
            guestPromptContainer.classList.remove('hidden');
            chatInputContainer.classList.add('hidden');
            surveyContainer.classList.add('hidden');
            orderSelectionContainer.classList.add('hidden');
        } else {
            guestPromptContainer.classList.add('hidden');
            chatInputContainer.classList.remove('hidden');
        }
        return isAuthenticated;
    };

    const getOrCreateChatSession = async () => {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return null;

        const storedSession = getStoredChatSession();
        if (storedSession?.chatId) {
            return storedSession.chatId;
        }

        const chatSessionData = {
            createdAt: serverTimestamp(),
            ownerUid: user.uid,
            guestId: null,
            status: 'active',
            agentName: null,
            isAgentTyping: false,
            agentAskingForOrderId: false
        };
        const docRef = await addDoc(collection(db, "chats"), chatSessionData);
        const chatId = docRef.id;
        storeChatSession(chatId);
        return chatId;
    };

    const renderMessage = (msg) => {
        const messageDiv = document.createElement('div');
        const user = auth.currentUser;
        const isMyMessage = !!user && !user.isAnonymous && msg.sender === user.uid;

        let classes = 'p-3 rounded-lg max-w-[85%] mb-2 break-words';
        if (msg.type === 'system') {
            classes = 'text-center text-sm text-slate-500 my-2';
            messageDiv.innerHTML = `<span class="bg-white px-2 py-1 rounded-full">${msg.text}</span>`;
        } else {
            classes += isMyMessage ? ' bg-gray-200 text-slate-800 self-end' : ' bg-blue-100 text-blue-800 self-start';
            messageDiv.textContent = msg.text;
        }

        messageDiv.className = classes;
        if (msg.type === 'system' && msg.text.includes('has joined the chat.')) {
            messageDiv.id = `agent-joined-${currentChatId}`;
        }
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const listenForChatSessionChanges = (chatId) => {
        if (unsubscribeFromChatSession) unsubscribeFromChatSession();
        unsubscribeFromChatSession = onSnapshot(doc(db, "chats", chatId), async (docSnap) => {
            const data = docSnap.data();
            if (!data) return;

            const agentJoinedFlag = localStorage.getItem(`agentJoined_${chatId}`);
            if (data.agentName && data.agentHasJoined && !agentJoinedFlag) {
                const joinMsgText = `<i class="fa-solid fa-headset mr-2"></i>${data.agentName} has joined the chat.`;
                await addDoc(collection(db, `chats/${chatId}/messages`), {
                    text: joinMsgText,
                    timestamp: serverTimestamp(),
                    sender: 'system',
                    type: 'system'
                });
                localStorage.setItem(`agentJoined_${chatId}`, 'true');
            }

            typingIndicatorContainer.style.display = data.isAgentTyping ? 'block' : 'none';
            if (data.isAgentTyping) chatMessages.scrollTop = chatMessages.scrollHeight;
            if (data.status === 'ended_by_agent') {
                chatInputContainer.classList.add('hidden');
                guestPromptContainer.classList.add('hidden');
                surveyContainer.classList.remove('hidden');
                orderSelectionContainer.classList.add('hidden');
                clearStoredChatSession();
                localStorage.removeItem(`agentJoined_${chatId}`);
            }
            if (data.agentAskingForOrderId) {
                displayOrderSelectionUI();
            } else {
                orderSelectionContainer.classList.add('hidden');
            }
        });
    };

    const listenForMessages = (chatId) => {
        if (unsubscribeFromMessages) unsubscribeFromMessages();
        currentChatId = chatId;
        const messagesRef = collection(db, `chats/${chatId}/messages`);
        const q = query(messagesRef, orderBy("timestamp"));
        unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
            chatMessages.innerHTML = '';
            if (!initialWelcomeRendered[chatId] && snapshot.empty) {
                const user = auth.currentUser;
                const userName = user?.displayName?.split(' ')[0] || 'there';
                renderMessage({ type: 'system', text: `Hi ${userName}, how can we help you today?` });
                initialWelcomeRendered[chatId] = true;
            }

            snapshot.forEach(doc => {
                const msgData = doc.data();
                renderMessage(msgData);
                const user = auth.currentUser;
                const isMyMessage = !!user && !user.isAnonymous && msgData.sender === user.uid;
                if (!isMyMessage && isChatMinimized) {
                    unreadCount++;
                    unreadCounter.textContent = unreadCount;
                    unreadCounter.classList.add('visible');
                    notificationSound.play().catch(e => console.log("Audio play failed:", e));
                }
            });
        });
    };

    const resetChatUI = () => {
        endChatConfirmModal.classList.add('hidden');
        endChatConfirmModal.classList.remove('flex');
        surveyContainer.classList.add('hidden');
        guestPromptContainer.classList.add('hidden');
        chatInputContainer.classList.remove('hidden');
        orderSelectionContainer.classList.add('hidden');
        typingIndicatorContainer.style.display = 'none';
        chatMessages.innerHTML = '';
        initialWelcomeRendered = {};
    };

    const openChat = async () => {
        resetChatUI();
        chatWindow.classList.add('is-visible');
        isChatMinimized = false;
        unreadCount = 0;
        unreadCounter.classList.remove('visible');

        if (!ensureUserAuthenticatedForChat()) {
            currentChatId = null;
            return;
        }

        // Get stored session first before creating new one
        const storedSession = getStoredChatSession();
        if (storedSession?.chatId) {
            currentChatId = storedSession.chatId;
        } else if (!currentChatId) {
            currentChatId = await getOrCreateChatSession();
            isFirstMessageSent = false;
        }

        if (currentChatId) {
            listenForMessages(currentChatId);
            listenForChatSessionChanges(currentChatId);
        }
    };

    chatOpenBtn.addEventListener('click', openChat);

    const minimizeChat = () => {
        chatWindow.classList.remove('is-visible');
        isChatMinimized = true;
    };
    chatMinimizeBtn.addEventListener('click', minimizeChat);

    chatCloseBtn.addEventListener('click', () => {
        endChatConfirmModal.classList.add('flex');
        endChatConfirmModal.classList.remove('hidden');
    });

    endChatNoBtn.addEventListener('click', () => {
        endChatConfirmModal.classList.add('hidden');
        endChatConfirmModal.classList.remove('flex');
    });

    endChatYesBtn.addEventListener('click', async () => {
        if (currentChatId) {
            await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                text: "Chat ended by user.",
                timestamp: serverTimestamp(),
                sender: 'system',
                type: 'system'
            });
            await updateDoc(doc(db, "chats", currentChatId), { status: 'ended_by_user' });
        }
        clearStoredChatSession();
        if (currentChatId) {
            localStorage.removeItem(`agentJoined_${currentChatId}`);
        }
        currentChatId = null;
        chatMessages.innerHTML = '';
        endChatConfirmModal.classList.add('hidden');
        endChatConfirmModal.classList.remove('flex');
        minimizeChat();
    });

    const sendMessage = async (text) => {
        if (text.trim() === '') return;

        if (!ensureUserAuthenticatedForChat()) return;

        if (!currentChatId) {
            currentChatId = await getOrCreateChatSession();
            isFirstMessageSent = false;
            if (!currentChatId) return;
        }

        const user = auth.currentUser;
        if (!user || user.isAnonymous) return;

        if (!isFirstMessageSent) {
            isFirstMessageSent = true;
            try {
                const userEmail = user.email || 'Member';
                const userName = user.displayName || userEmail;
                const firstMessage = text;

                await apiPost('/email-support', {
                    chatId: currentChatId,
                    userName: userName,
                    userEmail: userEmail,
                    firstMessage: firstMessage
                }, { authRequired: false });
                console.log('Support email sent for new chat session.');
            } catch (error) {
                console.error("Error sending support email:", error);
            }
        }

        const messageData = { text, timestamp: serverTimestamp(), sender: user.uid };
        await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
        chatInput.value = '';
        await updateDoc(doc(db, "chats", currentChatId), {
            userTypingText: '',
            lastMessage: `User: ${text}`,
            lastMessageTimestamp: serverTimestamp()
        });
    };

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage(chatInput.value);
        }
    });

    sendMessageBtn.addEventListener('click', () => {
        sendMessage(chatInput.value);
    });

    chatInput.addEventListener('keyup', () => {
        clearTimeout(userTypingTimeout);
        userTypingTimeout = setTimeout(async () => {
            const user = auth.currentUser;
            if (currentChatId && user && !user.isAnonymous) {
                await updateDoc(doc(db, "chats", currentChatId), { userTypingText: chatInput.value });
            }
        }, 300);
    });

    if (guestLoginBtn) {
        guestLoginBtn.addEventListener('click', () => {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.classList.add('is-visible');
            }
        });
    }

    friendlinessRating.addEventListener('input', (e) => { friendlinessValue.textContent = e.target.value; });

    starRatingContainer.addEventListener('mouseover', e => {
        if (e.target.tagName === 'I') {
            const rating = e.target.dataset.value;
            Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= rating));
        }
    });

    starRatingContainer.addEventListener('mouseout', () => {
        const currentRating = starRatingContainer.dataset.rating;
        Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= currentRating));
    });

    starRatingContainer.addEventListener('click', e => {
        if (e.target.tagName === 'I') {
            starRatingContainer.dataset.rating = e.target.dataset.value;
        }
    });

    surveyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const surveyData = {
            overallRating: parseInt(starRatingContainer.dataset.rating, 10),
            friendliness: friendlinessRating.value,
            resolved: document.querySelector('input[name="issue-resolved"]:checked')?.value || null,
            comments: document.getElementById('survey-comments').value
        };
        await setDoc(doc(db, `chats/${currentChatId}/survey/feedback`), { ...surveyData, submittedAt: serverTimestamp() });
        try {
            const response = await apiPost('/submit-chat-feedback', { chatId: currentChatId, surveyData: surveyData }, { authRequired: false });
            console.log('Feedback email sent successfully:', response);
        } catch (error) {
            console.error("Error sending feedback email:", error);
        }
        surveyContainer.innerHTML = '<p class="text-center font-semibold text-green-600">Thank you for your feedback!</p>';
    });

    const fetchUserOrders = async () => {
        return new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                unsubscribe();
                if (!user || user.isAnonymous) {
                    console.log("fetchUserOrders: User not logged in, returning requiresLogin: true");
                    resolve({ requiresLogin: true });
                    return;
                }
                const userId = user.uid;
                console.log("fetchUserOrders: Current user ID:", userId);
                const ordersRef = collection(db, `users/${userId}/orders`);
                const q = query(ordersRef, orderBy("timestamp", "desc"));
                try {
                    await createDummyOrder(userId);
                    const snapshot = await getDocs(q);
                    console.log("fetchUserOrders: Orders snapshot size:", snapshot.size);
                    if (snapshot.empty) {
                        console.log("fetchUserOrders: No orders found for this user in Firestore path:", `users/${userId}/orders`);
                    }
                    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("fetchUserOrders: Fetched orders:", orders);
                    resolve(orders);
                } catch (error) {
                    console.error("fetchUserOrders: Error fetching user orders:", error);
                    resolve({ error: error.message });
                }
            });
        });
    };

    const createDummyOrder = async (userId) => {
        const ordersRef = collection(db, `users/${userId}/orders`);
        const existingOrders = await getDocs(ordersRef);
        if (existingOrders.empty) {
            console.log("Creating initial dummy orders for user:", userId);
            let lastOrderNum = parseInt(localStorage.getItem('lastOrderNum') || '0', 10);
            const generateSequentialOrderId = () => {
                lastOrderNum++;
                localStorage.setItem('lastOrderNum', lastOrderNum);
                return `SHC-${String(lastOrderNum).padStart(5, '0')}`;
            };
            await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                deviceName: 'iPhone 15 Pro Max',
                storage: '256GB',
                price: 700,
                reoffer: null,
                imageUrl: 'https://secondhandcell.com/assets/iphone/assets/i15pm.webp',
                timestamp: serverTimestamp()
            });
            await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                deviceName: 'Samsung Galaxy S24 Ultra',
                storage: '512GB',
                price: 600,
                reoffer: 550,
                imageUrl: 'https://secondhandcell.com/assets/samsung/assets/s24u.webp',
                timestamp: serverTimestamp()
            });
            await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                deviceName: 'iPad Pro (M2)',
                storage: '128GB',
                price: 550,
                reoffer: null,
                imageUrl: 'https://secondhandcell.com/assets/ipm2.webp',
                timestamp: serverTimestamp()
            });
        } else {
            console.log("Example orders already exist for user:", userId);
        }
    };

    const parseCurrencyValue = (value) => {
        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : null;
    };

    const getDisplayPrice = (order) => {
        if (!order || typeof order !== 'object') {
            return 0;
        }
        const candidates = [
            order.reoffer,
            order.reOffer?.newPrice,
            order.reOffer,
            order.price,
            order.estimatedQuote,
        ];

        for (const candidate of candidates) {
            const numeric = parseCurrencyValue(candidate);
            if (numeric !== null) {
                return numeric;
            }
        }

        return 0;
    };

    const renderOrderSelection = (orders) => {
        orderList.innerHTML = '';
        if (orders.requiresLogin) {
            orderList.innerHTML = '<p class="text-center text-slate-500">Please <a href="#" id="orderLoginPromptLink" class="text-blue-600 font-semibold hover:underline">log in</a> to view and select your orders.</p>';
            const loginLink = document.getElementById('orderLoginPromptLink');
            if (loginLink) {
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) {
                        loginModal.classList.add('is-visible');
                    }
                    orderSelectionContainer.classList.add('hidden');
                });
            }
            if (orderSelectionPrompt) {
                orderSelectionPrompt.textContent = 'Login to access your orders:';
            }
            return;
        }

        if (orders.length === 0) {
            orderList.innerHTML = '<p class="text-center text-slate-500">No recent orders found.</p>';
            if (orderSelectionPrompt) {
                orderSelectionPrompt.textContent = 'Please select your order:';
            }
            return;
        }
        if (orderSelectionPrompt) {
            orderSelectionPrompt.textContent = 'Please select your order:';
        }
        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.dataset.orderId = order.orderId;
            const reofferAmount = parseCurrencyValue(order.reoffer ?? order.reOffer?.newPrice);
            const displayPriceValue = getDisplayPrice(order);
            const formattedPrice = displayPriceValue.toFixed(2);
            orderCard.innerHTML = `
                <img src="${order.imageUrl || 'https://placehold.co/48x48/e0e7ff/4338ca?text= '}" alt="${order.deviceName}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/e0e7ff/4338ca?text= '}">
                <div class="order-card-details">
                    <strong>ID: ${order.orderId} - ${order.deviceName}</strong>
                    <span>${order.storage} | $${formattedPrice}</span>
                    ${reofferAmount !== null ? `<span class="reoffer">Reoffer: $${reofferAmount.toFixed(2)}</span>` : ''}
                </div>
            `;
            orderCard.addEventListener('click', () => handleOrderSelection(order));
            orderList.appendChild(orderCard);
        });
    };

    const displayOrderSelectionUI = async () => {
        guestPromptContainer.classList.add('hidden');
        orderSelectionContainer.classList.remove('hidden');
        orderList.innerHTML = '<p class="text-center text-blue-500">Loading your orders...</p>';
        const orders = await fetchUserOrders();
        renderOrderSelection(orders);
    };

    const handleOrderSelection = async (order) => {
        const reofferAmount = parseCurrencyValue(order.reoffer ?? order.reOffer?.newPrice);
        const displayPriceValue = getDisplayPrice(order);
        const formattedPrice = displayPriceValue.toFixed(2);
        const messageText = `Selected Order: ID: ${order.orderId}, Device: ${order.deviceName}, Storage: ${order.storage}, Price: $${formattedPrice}${reofferAmount !== null ? `, Reoffer: $${reofferAmount.toFixed(2)}` : ''}`;
        await sendMessage(messageText);
        orderSelectionContainer.classList.add('hidden');
        if (currentChatId) {
            await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
        }
    };

    closeOrderSelectionBtn.addEventListener('click', async () => {
        orderSelectionContainer.classList.add('hidden');
        if (currentChatId) {
            await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
        }
    });

    const chatOrderBtn = document.getElementById('chat-order-btn');
    if (chatOrderBtn) {
        chatOrderBtn.addEventListener('click', async () => {
            if (currentChatId) {
                await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: true });
            } else {
                displayOrderSelectionUI();
            }
        });
    }

    const chatHeaderButtons = document.querySelectorAll('.chat-header-button');
    chatHeaderButtons.forEach(button => {
        let tooltipTimeout;

        button.addEventListener('mouseover', (e) => {
            clearTimeout(tooltipTimeout);
            const tooltipText = button.dataset.tooltipText;
            if (tooltipText) {
                globalTooltip.textContent = tooltipText;
                globalTooltip.style.visibility = 'visible';
                globalTooltip.style.opacity = '1';

                const rect = button.getBoundingClientRect();
                globalTooltip.style.top = `${rect.bottom + 8}px`;
                globalTooltip.style.left = `${rect.left + rect.width / 2}px`;
                globalTooltip.style.transform = `translateX(-50%)`;
            }
        });

        button.addEventListener('mouseout', () => {
            tooltipTimeout = setTimeout(() => {
                globalTooltip.style.visibility = 'hidden';
                globalTooltip.style.opacity = '0';
            }, 100);
        });

        button.addEventListener('mouseenter', () => {
            clearTimeout(tooltipTimeout);
        });
    });

    // Scroll animations
    setupScrollAnimations();

    // Customer Reviews Rotation
    const customerReviewsTrack = document.getElementById('customerReviewsTrack');
    if (customerReviewsTrack) {
        const testimonialData = [
            {
                name: 'Michael Rodriguez',
                role: 'iPhone 15 Pro Max Seller',
                rating: 5,
                review: 'SecondHandCell handled my iPhone trade-in in days. The shipping kit arrived quickly, inspection was honest, and the payout hit my account the same afternoon.',
                avatar: '/assets/faces/3.webp'
            },
            {
                name: 'Sarah Johnson',
                role: 'Galaxy S23 Ultra Seller',
                rating: 4.5,
                review: 'The $10 shipping kit deduction was worth it‚Äîeverything I needed was in the box. Their portal kept me updated until the payout cleared the next morning.',
                avatar: '/assets/faces/5.webp'
            },
            {
                name: 'David Martinez',
                role: 'Software Engineer ‚Ä¢ Seattle, WA',
                rating: 5,
                review: 'I compared half a dozen services and this one actually paid what they quoted. The dashboard makes tracking each step effortless.',
                avatar: '/assets/faces/6.webp'
            },
            {
                name: 'Emily Thompson',
                role: 'Teacher ‚Ä¢ Chicago, IL',
                rating: 4.5,
                review: 'As a teacher with zero free time, I loved how transparent the process was. I chose an email label, shipped the same day, and had my Zelle transfer within 24 hours.',
                avatar: '/assets/faces/7.webp'
            },
            {
                name: 'Jessica Rivera',
                role: 'Nurse ‚Ä¢ Tampa, FL',
                rating: 5,
                review: 'Customer support answered my questions in minutes and the payout matched what I was promised. It felt like working with a friend instead of a company.',
                avatar: '/assets/faces/8.webp'
            },
            {
                name: 'Amanda Chen',
                role: 'Entrepreneur ‚Ä¢ Austin, TX',
                rating: 4.8,
                review: 'I recycle phones from my business upgrades. Every order with SecondHandCell has been smooth, and they always explain any adjustments before finalizing the quote.',
                avatar: '/assets/faces/9.webp'
            },
            {
                name: 'James Wilson',
                role: 'IT Consultant ‚Ä¢ Denver, CO',
                rating: 5,
                review: 'Best phone buyback experience I\'ve had. Fast payment, transparent pricing, and excellent customer service. Highly recommend!',
                avatar: '/assets/faces/10.webp'
            }
        ];

        const createStarMarkup = (rating) => {
            const stars = [];
            for (let i = 1; i <= 5; i += 1) {
                if (rating >= i) {
                    stars.push('<i class="fa-solid fa-star"></i>');
                } else if (rating >= i - 0.5) {
                    stars.push('<i class="fa-solid fa-star-half-stroke"></i>');
                } else {
                    stars.push('<i class="fa-regular fa-star"></i>');
                }
            }
            return stars.join('');
        };

        const renderReviewCard = (testimonial) => `
            <article class="testimonial-card testimonial-card-enter">
                <div>
                    <div class="testimonial-stars" aria-hidden="true">
                        ${createStarMarkup(testimonial.rating)}
                    </div>
                    <p class="mt-3 text-slate-600 leading-relaxed">"${testimonial.review}"</p>
                </div>
                <div class="testimonial-profile">
                    <img src="${testimonial.avatar}" alt="Portrait of ${testimonial.name}" class="testimonial-avatar">
                    <div>
                        <p class="testimonial-name">${testimonial.name}</p>
                        <p class="testimonial-role">${testimonial.role}</p>
                    </div>
                </div>
            </article>
        `;

        let carouselIndex = 0;
        const testimonialsPerSlide = 3;

        const renderTestimonials = () => {
            const cards = [];
            for (let offset = 0; offset < testimonialsPerSlide; offset += 1) {
                const data = testimonialData[(carouselIndex + offset) % testimonialData.length];
                cards.push(renderReviewCard(data));
            }
            customerReviewsTrack.innerHTML = cards.join('');
        };

        const advanceCarousel = () => {
            carouselIndex = (carouselIndex + testimonialsPerSlide) % testimonialData.length;
            renderTestimonials();
        };

        renderTestimonials();

        const intervalDelay = 5000;
        let carouselTimer = window.setInterval(advanceCarousel, intervalDelay);

        const pauseCarousel = () => {
            if (carouselTimer) {
                window.clearInterval(carouselTimer);
                carouselTimer = null;
            }
        };

        const startCarousel = () => {
            if (!carouselTimer) {
                carouselTimer = window.setInterval(advanceCarousel, intervalDelay);
            }
        };

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                pauseCarousel();
            } else {
                startCarousel();
            }
        });
    }
});

function setupScrollAnimations() {
    const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
    };
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-fadeInUp');
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll('.animate-on-scroll').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        observer.observe(el);
    });
}

// Ship48 banner (from assets/js/ship48-banner-3eddba8c.js)
(() => {
  const PROMO_CODE = 'SHIP48';
  const PROMO_DISMISS_KEY = 'shcShip48BannerDismissed';
  
  const safeStorage = {
    get(key) { try { return window.localStorage ? window.localStorage.getItem(key) : null; } catch (e) { return null; } },
    set(key, val) { try { if(window.localStorage) window.localStorage.setItem(key, val); } catch (e) {} }
  };

  // 1. Handle Mobile Navigation Toggle
  function initNavToggle() {
    const toggle = document.querySelector('[data-site-nav-toggle]');
    const nav = document.getElementById('siteNav');
    if (!toggle || !nav) return;

    toggle.addEventListener('click', () => {
      const isOpen = nav.classList.toggle('is-open');
      toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });

    document.addEventListener('click', (event) => {
      if (!nav.contains(event.target) && !toggle.contains(event.target) && nav.classList.contains('is-open')) {
        nav.classList.remove('is-open');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
  }

  // 2. Handle Banner Rendering & Logic
  function initBanner() {
    // Ensure we have the container in HTML. 
    // You can look for class .ship48-banner OR attribute data-ship48-banner
    const banner = document.querySelector('.ship48-banner') || document.querySelector('[data-ship48-banner]');
    
    if (!banner) return;
    if (safeStorage.get(PROMO_DISMISS_KEY) === '1') {
      banner.style.display = 'none';
      return;
    }

    // Clear old content and ensure visibility
    banner.innerHTML = '';
    banner.classList.remove('hidden');
    banner.removeAttribute('hidden');

    // Build the HTML structure
    const inner = document.createElement('div');
    inner.className = 'ship48-banner__inner';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'ship48-banner__content';
    contentDiv.innerHTML = `
      <span class="ship48-text">Ship within 48 hours for a <strong>+$10 Bonus</strong></span>
      <div class="ship48-code-pill">
        ${PROMO_CODE}
        <button class="ship48-btn-copy" id="ship48CopyBtn">Copy</button>
      </div>
    `;

    const startLink = document.createElement('a');
    startLink.href = 'sell/';
    startLink.className = 'ship48-btn-start';
    startLink.textContent = 'Sell Your Device ‚Üí';

    const dismissBtn = document.createElement('button');
    dismissBtn.className = 'ship48-dismiss';
    dismissBtn.innerHTML = '&times;';
    dismissBtn.ariaLabel = 'Close banner';

    // Assemble
    inner.appendChild(contentDiv);
    inner.appendChild(startLink);
    banner.appendChild(inner);
    banner.appendChild(dismissBtn);

    // Add Events
    const copyBtn = contentDiv.querySelector('#ship48CopyBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        navigator.clipboard.writeText(PROMO_CODE).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(() => copyBtn.textContent = originalText, 2000);
        }).catch(err => console.error('Copy failed', err));
      });
    }

    dismissBtn.addEventListener('click', () => {
      safeStorage.set(PROMO_DISMISS_KEY, '1');
      banner.remove();
    });
  }

  // Initialize everything on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initNavToggle();
      initBanner();
    });
  } else {
    initNavToggle();
    initBanner();
  }
})();

// Global auth (from assets/js/global-auth-b97583c2.js)
browserLocalPersistence,
  createUserWithEmailAndPassword,
  getAuth,
  GoogleAuthProvider,
  onAuthStateChanged,
  sendPasswordResetEmail,
  setPersistence,
  signInWithEmailAndPassword,
  signInWithPopup,
  signOut,
  updateProfile,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const INIT_FLAG = "__shcAuthInitialized";
if (!window[INIT_FLAG]) {
  window[INIT_FLAG] = true;

  const auth = getAuth(getFirebaseApp());
  setPersistence(auth, browserLocalPersistence).catch(() => {});

  const ensureStyle = () => {
    const styleId = "shc-auth-styles";
    if (document.getElementById(styleId)) return;
    const style = document.createElement("style");
    style.id = styleId;
    style.textContent = `
    .shc-auth-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 2000; overflow-y: auto; }
    .shc-auth-modal.is-visible { display: flex; }
    .shc-auth-card { width: min(520px, 100%); background: #fff; border-radius: 20px; box-shadow: 0 30px 80px -40px rgba(15,23,42,0.6); padding: 28px; position: relative; }
    .shc-auth-close { position: absolute; top: 12px; right: 12px; background: transparent; border: none; color: #94a3b8; font-size: 22px; cursor: pointer; }
    .shc-auth-tabs { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; margin: 16px 0 12px; }
    .shc-auth-tab { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 700; color: #475569; cursor: pointer; }
    .shc-auth-tab.is-active { border-color: #5b21b6; color: #111827; box-shadow: 0 5px 18px -12px rgba(91,33,182,0.6); }
    .shc-auth-field { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #cbd5e1; margin-bottom: 12px; font-size: 15px; }
    .shc-auth-primary { width: 100%; padding: 13px 16px; border-radius: 14px; border: none; background: linear-gradient(120deg,#5b21b6,#2563eb); color: #fff; font-weight: 800; cursor: pointer; box-shadow: 0 20px 40px -28px rgba(37,99,235,0.9); }
    .shc-auth-google { width: 100%; padding: 12px 16px; border-radius: 14px; border: 1px solid #e2e8f0; background: #fff; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; color: #0f172a; cursor: pointer; }
    .shc-auth-or { display: flex; align-items: center; gap: 10px; margin: 14px 0; color: #94a3b8; font-size: 14px; }
    .shc-auth-or::before, .shc-auth-or::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
    .shc-auth-meta { text-align: center; font-size: 14px; color: #475569; margin-top: 10px; }
    .shc-auth-link { color: #2563eb; font-weight: 700; text-decoration: none; }
    .shc-auth-link:hover { text-decoration: underline; }
    .shc-auth-message { display: none; margin-top: 8px; padding: 10px 12px; border-radius: 12px; font-weight: 600; font-size: 14px; }
    .shc-auth-message.is-visible { display: block; }
    .shc-auth-message.is-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecdd3; }
    .shc-auth-message.is-success { background: #ecfdf3; color: #15803d; border: 1px solid #bbf7d0; }
    .shc-auth-google img { width: 18px; height: 18px; }
    .shc-auth-header { text-align: center; }
    .shc-auth-title { font-size: 24px; font-weight: 800; color: #0f172a; margin: 0; }
    .shc-auth-subtitle { margin: 6px 0 0; color: #475569; font-weight: 500; }
    .shc-auth-form { display: none; }
    .shc-auth-form.is-visible { display: block; }
    .shc-monogram { cursor: pointer !important; user-select: none; -webkit-user-select: none; pointer-events: auto !important; }
    .shc-auth-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 30px 80px -48px rgba(15,23,42,0.55); padding: 10px; min-width: 180px; display: none; z-index: 10000; }
    .shc-auth-dropdown.is-visible { display: block; }
    .shc-auth-dropdown a, .shc-auth-dropdown button { width: 100%; display: block; text-align: left; padding: 10px 12px; border-radius: 10px; color: #0f172a; font-weight: 600; border: none; background: transparent; cursor: pointer; }
    .shc-auth-dropdown a:hover, .shc-auth-dropdown button:hover { background: #f1f5f9; }
  `;
    document.head.appendChild(style);
  };

  const createModal = () => {
    if (document.getElementById("loginModal")) return document.getElementById("loginModal");

    ensureStyle();
    const overlay = document.createElement("div");
    overlay.id = "loginModal";
    overlay.className = "shc-auth-modal";
    overlay.style.display = "none";
  overlay.innerHTML = `
    <div class="shc-auth-card" role="dialog" aria-modal="true" aria-labelledby="shc-auth-title">
      <button class="shc-auth-close" type="button" aria-label="Close authentication modal">&times;</button>
      <div class="shc-auth-header">
        <p class="shc-auth-title" id="shc-auth-title">Your SecondHandCell Account</p>
        <p class="shc-auth-subtitle">Sign in or create an account to keep your quote in sync.</p>
      </div>
      <div class="shc-auth-tabs" role="tablist">
        <button class="shc-auth-tab is-active" id="loginTabBtn" type="button" data-tab="login">Login</button>
        <button class="shc-auth-tab" id="signupTabBtn" type="button" data-tab="signup">Sign Up</button>
      </div>
      <div id="authMessage" class="shc-auth-message" role="alert"></div>
      <form id="loginForm" class="shc-auth-form is-visible" novalidate>
        <button type="button" id="googleLoginBtn" class="shc-auth-google"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon"/>Login with Google</button>
        <div class="shc-auth-or"><span>or</span></div>
        <input type="email" id="loginEmail" class="shc-auth-field" placeholder="Email address" autocomplete="email" required />
        <input type="password" id="loginPassword" class="shc-auth-field" placeholder="Password" autocomplete="current-password" required />
        <button type="submit" class="shc-auth-primary">Login</button>
        <p class="shc-auth-meta">Forgot your password? <a href="#" id="forgotPasswordLink" class="shc-auth-link">Reset it</a></p>
      </form>
      <form id="signupForm" class="shc-auth-form" novalidate>
        <button type="button" id="googleSignupBtn" class="shc-auth-google"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon"/>Sign up with Google</button>
        <div class="shc-auth-or"><span>or</span></div>
        <input type="text" id="signupName" class="shc-auth-field" placeholder="Full name" autocomplete="name" required />
        <input type="email" id="signupEmail" class="shc-auth-field" placeholder="Email address" autocomplete="email" required />
        <input type="password" id="signupPassword" class="shc-auth-field" placeholder="Password (min 6 characters)" autocomplete="new-password" required />
        <button type="submit" class="shc-auth-primary">Create Account</button>
        <p class="shc-auth-meta">Already have an account? <a href="#" id="switchToLogin" class="shc-auth-link">Login</a></p>
      </form>
    </div>
  `;
  document.body.appendChild(overlay);
    return overlay;
  };

  const getInitial = (user) => {
    if (!user) return "";
    if (user.displayName && user.displayName.trim()) return user.displayName.trim().charAt(0).toUpperCase();
    if (user.email && user.email.trim()) return user.email.trim().charAt(0).toUpperCase();
    return "U";
  };

  const toggleModal = (modal, isVisible) => {
    if (!modal) return;
    modal.style.display = isVisible ? "flex" : "none";
    modal.classList.toggle("is-visible", isVisible);
  };

  const showMessage = (messageEl, message, isError = false) => {
    if (!messageEl) return;
    messageEl.textContent = message;
    messageEl.classList.add("is-visible");
    messageEl.classList.toggle("is-error", isError);
    messageEl.classList.toggle("is-success", !isError);
  };

  const clearMessage = (messageEl) => {
    if (!messageEl) return;
    messageEl.textContent = "";
    messageEl.classList.remove("is-visible", "is-error", "is-success");
  };

  const setActiveTab = (tab) => {
    const loginTabBtn = document.getElementById("loginTabBtn");
    const signupTabBtn = document.getElementById("signupTabBtn");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    if (!loginTabBtn || !signupTabBtn || !loginForm || !signupForm) return;

    const isLogin = tab === "login";
    loginTabBtn.classList.toggle("is-active", isLogin);
    signupTabBtn.classList.toggle("is-active", !isLogin);
    loginForm.classList.toggle("is-visible", isLogin);
    signupForm.classList.toggle("is-visible", !isLogin);
  };

  const bindAuthUi = () => {
    const modal = createModal();
    toggleModal(modal, false);
    const loginNavBtn = document.getElementById("loginNavBtn");
    const userMonogram = document.getElementById("userMonogram");
    const authDropdown = document.getElementById("authDropdown");
    const logoutBtn = document.getElementById("logoutBtn");
    const authMessage = document.getElementById("authMessage");
    const closeBtn = modal.querySelector(".shc-auth-close");
    const signupSwitch = document.getElementById("switchToLogin");
    const forgotPassword = document.getElementById("forgotPasswordLink");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const googleSignupBtn = document.getElementById("googleSignupBtn");

    const provider = new GoogleAuthProvider();

    const updateUiForUser = (user) => {
      if (loginNavBtn) {
        loginNavBtn.textContent = user ? "My Account" : "Login/Sign Up";
        loginNavBtn.classList.toggle("hidden", !!user);
      }
      if (userMonogram) {
        userMonogram.textContent = getInitial(user);
        userMonogram.classList.toggle("hidden", !user);
      }
      if (authDropdown) {
        authDropdown.classList.add("shc-auth-dropdown");
        authDropdown.classList.remove("is-visible"); // Always ensure dropdown is closed
        authDropdown.classList.remove("hidden"); // Remove the hidden class that has !important
        if (user) {
          // Don't add any visibility classes - dropdown should only show when clicked
        } else {
          // Keep it hidden via CSS when no user
          authDropdown.style.display = 'none';
        }
      }
      if (!user && modal) toggleModal(modal, false);
      if (user) {
        localStorage.setItem("shcAuthUser", JSON.stringify({ uid: user.uid, email: user.email, name: user.displayName || "" }));
      } else {
        localStorage.removeItem("shcAuthUser");
      }
    };

    onAuthStateChanged(auth, (user) => updateUiForUser(user));

    const attachDropdown = () => {
      if (!userMonogram || !authDropdown) return;
      userMonogram.classList.add("shc-monogram");
      
      // Ensure dropdown starts hidden
      authDropdown.classList.remove("is-visible");
      
      // Use both click and mousedown for better reliability
      const toggleDropdown = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isCurrentlyVisible = authDropdown.classList.contains("is-visible");
        authDropdown.classList.toggle("is-visible", !isCurrentlyVisible);
      };
      
      userMonogram.addEventListener("click", toggleDropdown, true);
      userMonogram.addEventListener("mousedown", (e) => {
        e.preventDefault();
      }, true);
      
      document.addEventListener("click", (e) => {
        if (!authDropdown.contains(e.target) && !userMonogram.contains(e.target)) {
          authDropdown.classList.remove("is-visible");
        }
      });
    };
    attachDropdown();

    const openLogin = () => {
      clearMessage(authMessage);
      setActiveTab("login");
      toggleModal(modal, true);
    };

    const openSignup = () => {
      clearMessage(authMessage);
      setActiveTab("signup");
      toggleModal(modal, true);
    };

    if (loginNavBtn) {
      loginNavBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openLogin();
      });
    }

    closeBtn?.addEventListener("click", () => toggleModal(modal, false));
    modal.addEventListener("click", (e) => {
      if (e.target === modal) toggleModal(modal, false);
    });

    document.getElementById("loginTabBtn")?.addEventListener("click", () => openLogin());
    document.getElementById("signupTabBtn")?.addEventListener("click", () => openSignup());
    signupSwitch?.addEventListener("click", (e) => {
      e.preventDefault();
      openLogin();
    });

    const handleAuthError = (error) => {
      const friendly = error?.message || "Something went wrong. Please try again.";
      showMessage(authMessage, friendly, true);
    };

    loginForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage(authMessage);
      const email = document.getElementById("loginEmail")?.value?.trim();
      const password = document.getElementById("loginPassword")?.value;
      if (!email || !password) {
        showMessage(authMessage, "Please enter your email and password.", true);
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage(authMessage, "Welcome back!", false);
        setTimeout(() => toggleModal(modal, false), 600);
      } catch (error) {
        handleAuthError(error);
      }
    });

    signupForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage(authMessage);
      const name = document.getElementById("signupName")?.value?.trim();
      const email = document.getElementById("signupEmail")?.value?.trim();
      const password = document.getElementById("signupPassword")?.value;
      if (!name || !email || !password) {
        showMessage(authMessage, "Please complete all fields to sign up.", true);
        return;
      }
      try {
        const credentials = await createUserWithEmailAndPassword(auth, email, password);
        if (credentials.user && name) {
          await updateProfile(credentials.user, { displayName: name });
        }
        showMessage(authMessage, "Account created! Redirecting...", false);
        setTimeout(() => toggleModal(modal, false), 700);
      } catch (error) {
        handleAuthError(error);
      }
    });

    forgotPassword?.addEventListener("click", async (e) => {
      e.preventDefault();
      clearMessage(authMessage);
      const email = document.getElementById("loginEmail")?.value?.trim();
      if (!email) {
        showMessage(authMessage, "Enter your email above to reset your password.", true);
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage(authMessage, "Password reset sent. Check your inbox.", false);
      } catch (error) {
        handleAuthError(error);
      }
    });

    const handleGoogle = async () => {
      clearMessage(authMessage);
      try {
        await signInWithPopup(auth, provider);
        showMessage(authMessage, "Signed in with Google!", false);
        setTimeout(() => toggleModal(modal, false), 600);
      } catch (error) {
        handleAuthError(error);
      }
    };

    googleLoginBtn?.addEventListener("click", handleGoogle);
    googleSignupBtn?.addEventListener("click", handleGoogle);

    logoutBtn?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        toggleModal(modal, false);
        if (authDropdown) authDropdown.classList.remove("is-visible");
      } catch (error) {
        handleAuthError(error);
      }
    });

    // Close dropdown when clicking any link/button inside it
    authDropdown?.addEventListener("click", (e) => {
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
        authDropdown.classList.remove("is-visible");
      }
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindAuthUi);
  } else {
    bindAuthUi();
  }

} // End of INIT_FLAG check
</script>
    
    
    
</body>
</html>
