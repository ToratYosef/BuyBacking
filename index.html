<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - Turn Your Old Phone into Cash!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated font: Poppins for a more modern feel -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Added fancy font: Dancing Script -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Poppins', sans-serif; /* Applied new font */
            background-color: #f8fafc; /* Tailwind slate-50 */
            color: #1e293b; /* Tailwind slate-800 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .homepage-card-link:hover .homepage-card-inner,
        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Tailwind shadow-2xl */
        }
        .homepage-card-inner, .feature-card {
            transition: all 0.3s ease-in-out;
        }
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; /* blue-100, blue-700 */
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }
        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }
        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }

        /* --- Chat Widget Styles --- */
        #chat-widget-container { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            z-index: 1000; 
        }
        #chat-open-btn {
            background-color: #2563eb; color: white;
            width: 4rem; height: 4rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            cursor: pointer; transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
        }
        #chat-open-btn:hover { transform: scale(1.1); }
        #unread-counter {
            position: absolute; top: -4px; right: -4px;
            background-color: #ef4444; color: white;
            border-radius: 9999px; font-size: 0.75rem; font-weight: bold;
            width: 1.5rem; height: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            transform: scale(0); transition: transform 0.2s ease-out;
        }
        #unread-counter.visible { transform: scale(1); }
        #chat-window {
            position: absolute;
            bottom: 0; /* Covers the chat icon now */
            right: 0; 
            width: 24rem;
            height: 32rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
        #chat-window.is-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        #chat-window.is-visible + #chat-open-btn {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        
        #chat-messages { 
            flex-grow: 1; /* Allows it to take up remaining vertical space */
            overflow-y: auto; /* Enables scrolling for messages */
            padding: 1rem;
            background-color: #f8fafc; /* Tailwind slate-50 */
            display: flex; /* Ensure messages stack correctly */
            flex-direction: column;
        } 

        /* Global Tooltip for chat header buttons */
        #globalTooltip {
            visibility: hidden;
            background-color: #334155; /* slate-700 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: fixed; /* Position fixed to appear over everything */
            z-index: 99999; /* High z-index */
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 0.75rem; /* text-xs */
            pointer-events: none; /* Allows clicks to pass through */
        }

        .typing-indicator { display: flex; align-items: center; padding: 8px 12px; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: #9ca3af; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .star-rating i { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating:hover i, .star-rating i.selected { color: #f59e0b; }
        .star-rating i:hover ~ i { color: #d1d5db; }
        
        .prose {
            max-width: 65ch;
            color: #334155; /* slate-700 */
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }

        /* --- New Floating Banner Styles --- */
        .floating-banner {
            position: sticky;
            top: 7rem; /* Adjusted for taller header */
            z-index: 30;
            animation: slideIn 0.8s ease-out;
            border-bottom-left-radius: 0.75rem; /* rounded-xl for bottom corners */
            border-bottom-right-radius: 0.75rem;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .floating-banner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* For positioning the close button */
            padding: 1rem 4rem 1rem 1rem; /* Adjust padding to make space for the close button */
        }
        .floating-banner-close {
            position: absolute;
            right: 1rem; /* Position close to the right edge */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .floating-banner-close:hover {
            color: #fca5a5; /* red-300 */
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* Style for zoomed Pixel logo */
        #google_cat_img_container {
            width: 6rem; /* fixed width, matches h-24 */
            height: 6rem; /* fixed height */
            overflow: hidden; /* ensures the scaled image doesn't overflow the container */
            display: flex; /* for centering the image */
            align-items: center;
            justify-content: center;
            margin: auto; /* to center the container itself */
            margin-bottom: 1rem; /* spacing below the image */
        }
        #google_cat_img {
            transform: scale(1.2); /* Zoom in effect */
            object-fit: contain; /* ensures image fits while maintaining aspect ratio */
            width: 100%; /* Fill the container, then scale */
            height: 100%;
        }

        /* Fancy font for header text */
        .fancy-header-text {
            font-family: 'Dancing Script', cursive;
        }

        /* Order selection specific styles */
        .order-card {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: #f1f5f9; /* slate-100 */
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .order-card:hover {
            background-color: #e2e8f0; /* slate-200 */
        }
        .order-card img {
            width: 3rem;
            height: 3rem;
            object-fit: contain;
            margin-right: 0.75rem;
            border-radius: 0.25rem;
        }
        .order-card-details {
            flex-grow: 1;
            font-size: 0.875rem; /* text-sm */
        }
        .order-card-details strong {
            display: block;
            font-weight: 600;
            color: #1e293b; /* slate-800 */
        }
        .order-card-details span {
            color: #475569; /* slate-600 */
        }
        .order-card-details .reoffer {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }

        /* --- Mobile Styles --- */
        @media (max-width: 767px) {
            /* Adjust header for small screens */
            header .container {
                flex-direction: row; /* Changed to row for horizontal layout */
                justify-content: space-between; /* Space out logo and login */
                align-items: center;
                padding-top: 0.5rem; 
                padding-bottom: 0.5rem; 
            }

            header .container > .flex-1:first-child { /* Logo container */
                width: auto; /* Allow logo to size itself */
                flex-grow: 0; /* Don't let it grow */
            }

            header .container > .flex-1:last-child { /* Login/Sign Up container */
                width: auto; /* Allow login button to size itself */
                flex-grow: 0; /* Don't let it grow */
                justify-content: flex-end; /* Align to the right */
            }

            header .flex-col { /* Hide the main logo text and tagline on small screens */
                display: none; 
            }

            header .h-12 { /* Logo height on mobile */
                height: 3rem; /* Smaller logo on mobile */
            }
            header .md\:h-20 { /* Override md:h-20 for mobile */
                height: 3rem;
            }

            header nav {
                margin-top: 0; /* Remove top margin */
                justify-content: flex-end; /* Align to the right */
            }
            
            /* Adjust floating banner for mobile */
            .floating-banner {
                top: 4rem; /* Adjusted top position for smaller mobile header */
            }
            .floating-banner-content {
                padding-right: 3rem; /* Even less padding for close button on mobile */
            }

            /* Adjust hero section for mobile */
            .hero-section {
                padding-top: 6rem;
                padding-bottom: 6rem;
            }

            .hero-section h1 {
                font-size: 2.5rem;
            }

            .hero-section p {
                font-size: 1rem;
            }

            .hero-section a {
                font-size: 1rem;
                padding: 0.75rem 2rem;
            }

            /* General section adjustments for mobile */
            main section {
                padding-top: 2rem;
                padding-bottom: 2rem;
            }

            main section h2 {
                font-size: 2rem;
            }

            main section p {
                font-size: 1rem;
            }
            
            /* Feature, Categories, Popular, Testimonials sections */
            .grid {
                grid-template-columns: 1fr; /* Stack grid items vertically on small screens */
            }

            /* Adjust spacing in specific sections */
            #features .feature-card,
            #popular .homepage-card-inner,
            #categories .homepage-card-inner,
            #testimonials > div > div {
                margin-bottom: 1.5rem;
            }
            
            /* Footer adjustments */
            footer .grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            footer .lg\:col-span-2 {
                grid-template-columns: 1fr;
            }
            
            footer .bg-slate-700 {
                margin-top: 1.5rem;
            }
            
            footer form {
                flex-direction: column;
            }

            footer button {
                width: 100%;
            }

            /* Modal adjustments for smaller screens */
            .modal-content {
                padding: 1.5rem;
            }

            .modal-content h2 {
                font-size: 1.5rem;
            }
            
            /* --- FIXED: Chat window for mobile --- */
            /* #chat-widget-container retains its default fixed bottom-right positioning */
            /* The full-screen behavior is now applied directly to #chat-window when it's visible */
            #chat-window.is-visible {
                position: fixed; /* Make it fixed to viewport */
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 0; /* No rounded corners when full screen */
                box-shadow: none; /* No shadow when full screen */
                transform: translateY(0); /* Ensure it's not translated */
                opacity: 1; /* Make it fully visible */
                pointer-events: auto; /* Make it interactive */
                background-color: white; /* Ensure it has a background */
                z-index: 1000; /* Ensure it's above other page content */
            }

            /* This rule correctly hides the open button when the chat is visible */
            #chat-window.is-visible + #chat-open-btn {
                opacity: 0;
                transform: scale(0.8);
                pointer-events: none;
            }

            /* Adjust chat open button for mobile */
            #chat-open-btn {
                bottom: 1rem;
                right: 1rem;
            }

            /* Adjust login/signup button for mobile */
            #loginNavBtn {
                font-size: 0.75rem; /* text-xs */
                padding: 0.375rem 0.625rem; /* px-2.5 py-1.5 */
                white-space: nowrap; /* Prevent text from wrapping */
            }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- HEADER -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center md:py-5">
            <div class="flex-1">
                <a href="#" class="h-12 inline-block md:h-20">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png" alt="SecondHandCell Logo" class="h-full w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <div class="hidden md:flex flex-col items-center flex-1">
                <div class="text-2xl font-extrabold text-slate-800 fancy-header-text">SecondHandCell</div>
                <p class="text-sm text-slate-500 -mt-1 fancy-header-text">Turn Your Old Phone into Cash!</p>
            </div>
            <nav class="flex items-center space-x-4 flex-1 justify-end">
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden">
                        <a href="my-account.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <!-- HERO SECTION -->
        <section class="relative py-24 md:py-32 text-center overflow-hidden" style="background-image: url('https://raw.githubusercontent.com/ToratYosef/BuyBacking/main/assets/bg.png'); background-size: cover; background-position: center;">
            <div class="absolute inset-0 bg-slate-100/90" aria-hidden="true"></div>
            <div class="container mx-auto px-4 relative">
                <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 mb-4 leading-tight">Turn Your Old Phone into Cash.</h1>
                <p class="max-w-2xl mx-auto text-lg md:text-xl text-slate-600 mb-8">
                    Quick, easy, and transparent buyback for iPhone, Samsung, and more. Get a free quote in seconds!
                </p>
                <a href="sell-device.html" class="bg-blue-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:bg-blue-700 transition-transform duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 inline-block">
                    Get Your Instant Offer
                </a>
            </div>
        </section>

        <!-- FLOATING BANNER SECTION -->
        <section id="floatingBanner" class="floating-banner bg-red-600 text-white shadow-xl">
            <div class="container mx-auto px-4 py-4 text-center floating-banner-content">
                <p class="font-bold md:text-lg">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> IMPORTANT: We do not purchase blacklisted or lost/stolen devices. <a href="#" id="termsAndConditionsLink" class="underline hover:text-red-200">See terms for details.</a>
                </p>
                <button id="closeBannerBtn" class="floating-banner-close" aria-label="Close banner">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </section>
        
        <!-- CATEGORIES SECTION (Now "Sell by Category") -->
        <section class="bg-slate-100 py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Sell by Category</h2>
                    <p class="mt-3 text-lg text-slate-600">Find the device you want to sell.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    <a href="iphone/models/" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="iphone_cat_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/apple" alt="iPhone Category" class="mx-auto mb-4 h-24 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone</h3><span class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium mt-auto w-full transition-colors duration-300">Sell Now</span></div></a>
                    <a href="samsung/index.html" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="samsung_cat_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/samsung" alt="Samsung Category" class="mx-auto mb-4 h-24 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung</h3><span class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium mt-auto w-full transition-colors duration-300">Sell Now</span></div></a>
                    <a href="tablet/models/" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="ipad_cat_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/ipad.svg" alt="iPad Category" class="mx-auto mb-4 h-24 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPad</h3><span class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium mt-auto w-full transition-colors duration-300">Sell Now</span></div></a>
                    <a href="google/models/" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full">
                        <div id="google_cat_img_container">
                            <img id="google_cat_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/googlepixel.webp" alt="Google Phones Category">
                        </div>
                        <h3 class="text-xl font-semibold mb-2 text-slate-800">Google Phones</h3>
                        <span class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium mt-auto w-full transition-colors duration-300">Sell Now</span>
                    </div></a>
                </div>
            </div>
        </section>

        <!-- FEATURE SECTION (Moved to new position) -->
        <section id="features" class="container mx-auto px-4 py-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Why Sell With Us?</h2>
                <p class="mt-3 text-lg text-slate-600">Our process is simple, safe, and gets you the most for your device.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="feature-card bg-white p-6 rounded-xl shadow-lg text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl">📦</div><h3 class="text-xl font-semibold mb-2 text-slate-800">Free Shipping Kit</h3><p class="text-slate-600">We send you a prepaid box. Just pack your device and drop it in the mail.</p></div>
                <div class="feature-card bg-white p-6 rounded-xl shadow-lg text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl">💸</div><h3 class="text-xl font-semibold mb-2 text-slate-800">Fast Payment</h3><p class="text-slate-600">Get paid quickly via Venmo, Zelle, or PayPal as soon as we inspect your device, with funds available in as fast as 24 hours.</p></div>
                <div class="feature-card bg-white p-6 rounded-xl shadow-lg text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl">🔒</div><h3 class="text-xl font-semibold mb-2 text-slate-800">Data Protection</h3><p class="text-slate-600">We professionally wipe all personal data from every device we receive.</p></div>
                <div class="feature-card bg-white p-6 rounded-xl shadow-lg text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl">❤️</div><h3 class="text-xl font-semibold mb-2 text-slate-800">Highest Payouts</h3><p class="text-slate-600">Our price-lock guarantee ensures you get the quote you were offered.</p></div>
            </div>
        </section>

        <!-- POPULAR PHONES SECTION -->
        <section id="popular" class="py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Popular Devices We Buy</h2>
                    <p class="mt-3 text-lg text-slate-600">From the latest models to older favorites, we buy them all.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="i15pm_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i15pm" alt="iPhone 15 Pro Max" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 15 Pro Max</h3><p class="text-blue-600 font-bold mb-4">Up to $700</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="i14p_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i14p" alt="iPhone 14 Pro" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 14 Pro</h3><p class="text-blue-600 font-bold mb-4">Up to $450</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="i13_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i13" alt="iPhone 13" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 13</h3><p class="text-blue-600 font-bold mb-4">Up to $400</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="s24u_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s24u" alt="Samsung Galaxy S24 Ultra" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S24 Ultra</h3><p class="text-blue-600 font-bold mb-4">Up to $600</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="s22_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s22" alt="Samsung Galaxy S22" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S22</h3><p class="text-blue-600 font-bold mb-4">Up to $250</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="gp8_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/gp8" alt="Google Pixel 8" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Google Pixel 8</h3><p class="text-blue-600 font-bold mb-4">Up to $400</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="ipm2_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/ipm2" alt="iPad Pro (M2)" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPad Pro (M2)</h3><p class="text-blue-600 font-bold mb-4">Up to $550</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                    <a href="#" class="homepage-card-link group"><div class="homepage-card-inner bg-white p-6 rounded-xl shadow-lg text-center flex flex-col h-full"><img id="tbs9u_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/tbs9u" alt="Samsung Galaxy Tab S9 Ultra" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy Tab S9 Ultra</h3><p class="text-blue-600 font-bold mb-4">Up to $400</p><span class="bg-slate-200 text-slate-800 px-6 py-2 rounded-full font-medium mt-auto w-full group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">Get Offer</span></div></a>
                </div>
            </div>
        </section>

        <!-- TESTIMONIALS SECTION -->
        <section id="testimonials" class="bg-slate-100 py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12"><h2 class="text-3xl md:text-4xl font-bold text-slate-800">What Our Customers Are Saying</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex items-center mb-4"><div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-700 text-lg">JS</div><div class="ml-4"><p class="font-semibold text-slate-800">Jessica S.</p><p class="text-sm text-slate-500">Sold an iPhone 13</p></div></div><p class="text-slate-600">"Extremely fast and easy process! The shipping kit arrived in two days and I got paid the day after they received my phone. Got way more than I expected!"</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex items-center mb-4"><div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-700 text-lg">MB</div><div class="ml-4"><p class="font-semibold text-slate-800">Michael B.</p><p class="text-sm text-slate-500">Sold a Galaxy S22</p></div></div><p class="text-slate-600">"Customer service was excellent. I had a question about my order and they responded within an hour. The whole process was transparent and simple."</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex items-center mb-4"><div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-700 text-lg">AR</div><div class="ml-4"><p class="font-semibold text-slate-800">Anna R.</p><p class="text-sm text-slate-500">Sold a Pixel 7</p></div></div><p class="text-slate-600">"The best experience selling a device online. The price they quoted was the price I got. Highly recommend SecondHandCell!"</p></div>
                </div>
            </div>
        </section>

        <!-- SELL DEVICE NOW SECTION (Moved to new position) -->
        <section class="bg-white py-16 md:py-24">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-6">Ready to Sell?</h2>
                <p class="max-w-xl mx-auto text-lg text-slate-600 mb-8">
                    Start the process now and get cash for your device in as little as 24 hours.
                </p>
                <a href="sell-device.html" class="bg-blue-600 text-white px-10 py-5 rounded-full font-bold text-xl shadow-2xl hover:bg-blue-700 transition-transform duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 inline-block">
                    Sell Device Now! <i class="fa-solid fa-arrow-right-long ml-2"></i>
                </a>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links</h3><ul class="space-y-2"><li><a href="#" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="#" id="privacyPolicyLink" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="#" id="termsAndConditionsLinkFooter" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p><p class="text-slate-400">Phone: (123) 456-7890</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <!-- MODALS -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content"><button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Your SecondHandCell Account</h2><div class="flex border-b border-slate-200 mb-6"><button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Login</button><button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Sign Up</button></div><form id="loginForm" class="space-y-4"><p class="text-slate-600 text-center">Log in to continue with your order.</p><button type="button" id="googleLoginBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Login with Google</button><div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div><div><label for="loginEmail" class="sr-only">Email Address</label><input type="email" id="loginEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="loginPassword" class="sr-only">Password</label><input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password"></div><button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button><p class="text-center text-sm text-slate-600">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-blue-600 font-semibold hover:underline">Reset it here</a></p></form><form id="signupForm" class="space-y-4 hidden"><p class="text-slate-600 text-center">Create an account to complete your order.</p><button type="button" id="googleSignupBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Sign Up with Google</button><div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div><div><label for="signupName" class="sr-only">Full Name</label><input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="signupEmail" class="sr-only">Email Address</label><input type="email" id="signupEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="signupPassword" class="sr-only">Password</label><input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password"></div><button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button><p class="text-center text-sm text-slate-600">Already have an account? <a href="#" id="switchToLogin" class="text-blue-600 font-semibold hover:underline">Log in here</a></p></form><form id="forgotPasswordForm" class="space-y-4 hidden"><p class="text-slate-600 text-center">Enter your email to receive a password reset link.</p><div><label for="forgotEmail" class="sr-only">Email Address</label><input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button><p class="text-center text-sm text-slate-600">Remember your password? <a href="#" id="returnToLogin" class="text-blue-600 font-semibold hover:underline">Return to Login</a></p></form><div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div></div></div>
    <!-- About Us Modal -->
    <div id="aboutUsModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative modal-content"><button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><h2 class="text-2xl font-bold text-slate-800 mb-4">About Us</h2><p class="text-slate-600">Welcome to SecondHandCell, where we believe in giving old tech a new life. Our mission is to make selling your used devices as simple, safe, and rewarding as possible. We offer competitive prices, a hassle-free process, and a commitment to sustainability.</p></div></div>
    <!-- Privacy Policy Modal -->
    <div id="privacyPolicyModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl p-8 relative modal-content"><button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><div class="prose max-h-[80vh] overflow-y-auto pr-4"><h2 class="text-2xl font-bold text-slate-800 mb-4">Privacy Policy</h2><p><strong>Last Updated: August 27, 2025</strong></p><p>SecondHandCell ("we," "us," or "our") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website.</p><h3>Information We Collect</h3><p>We may collect personal information from you such as your name, email address, postal address, phone number, and payment information (e.g., Venmo, Zelle, or PayPal details). We also collect information about the device you are selling, including its model, serial number, and condition.</p><h3>How We Use Your Information</h3><p>We use the information we collect to: process your transactions; send you shipping kits and communicate about your order status; process payments; respond to customer service requests; send you marketing and promotional communications, with your consent.</p><h3>Data Security and Wiping</h3><p>We implement a variety of security measures to maintain the safety of your personal information. All devices sold to us undergo a certified, multi-pass data-wiping process to ensure your personal information is professionally and permanently erased.</p><h3>Disclosure of Your Information</h3><p>We do not sell, trade, or otherwise transfer to outside parties your Personally Identifiable Information except to trusted third parties who assist us in operating our website, conducting our business, or servicing you (such as shipping carriers), so long as those parties agree to keep this information confidential.</p><h3>Your Consent</h3><p>By using our site, you consent to our website's privacy policy.</p></div></div></div>
    <!-- Terms & Conditions Modal -->
    <div id="termsAndConditionsModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl p-8 relative modal-content"><button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><div class="prose max-h-[80vh] overflow-y-auto pr-4"><h2 class="text-2xl font-bold text-slate-800 mb-4">Terms & Conditions</h2><p><strong>Last Updated: August 27, 2025</strong></p><p>Please read these Terms and Conditions ("Terms") carefully before using the SecondHandCell website ("Service") operated by us.</p><h3>1. User Obligations</h3><p>By using the Service, you represent and warrant that:</p><ul><li>You are the legal owner of the device you are selling.</li><li>The device is not reported as lost or stolen, and its IMEI is not blacklisted.</li><li>The device has no outstanding balance and is not subject to any financing or lease agreement.</li><li>All information you provide about the device is accurate and truthful.</li></ul><h3>2. The Offer Process</h3><ul><li>The initial quote provided on our website is an estimate based on the information you provide.</li><li>Upon receiving your device, we will conduct a thorough inspection. If the device's condition differs from what was described, we will issue a revised offer via email.</li><li><strong>You have seven (7) days to accept or decline the revised offer. If you do not respond within this 7-day period, the revised offer will be automatically accepted on your behalf, and we will proceed with payment.</strong></li><li>Once an offer (initial or revised) is accepted, it is locked in and final. There is no option for a re-offer or to have the device returned.</li></ul><h3>3. Shipping and Risk of Loss</h3><p>We provide a prepaid shipping label and materials. SecondHandCell is not responsible for any damage or loss that occurs before the device is received and scanned by our designated shipping carrier.</p><h3>4. Limitation of Liability</h3><p>In no event shall SecondHandCell, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
            
            <hr class="my-6 border-t border-slate-300">

            <h3>5. Policy on Lost/Stolen Devices & Legal Compliance (New York State & NYC)</h3>
            <p>SecondHandCell is committed to operating in full compliance with all applicable laws and regulations regarding the purchase and sale of secondhand goods, particularly those concerning lost or stolen property. This section outlines our strict policy and the legal framework governing such transactions in New York State and New York City.</p>

            <h4>Laws That May Apply (NY State + NYC)</h4>
            <ul>
                <li><strong>New York Penal Law § 155.05(2)(b) – Larceny by acquiring lost property:</strong> If someone acquires lost property and does not take reasonable measures to return it, it counts as larceny.</li>
                <li><strong>New York Penal Law § 165.40 – Criminal possession of stolen property in the 5th degree:</strong> Knowingly possessing stolen property (or should reasonably know it’s stolen) is a misdemeanor.</li>
                <li><strong>New York Penal Law § 165.45–165.54 – Criminal possession of stolen property (4th–1st degree):</strong> Felonies based on the value of the stolen property. Smartphones can easily push this into felony territory if valuable.</li>
                <li><strong>New York City Administrative Code § 20-272 et seq. (Secondhand Dealer Law):</strong> Dealers in secondhand goods must:
                    <ul>
                        <li>Keep records of all items received (including seller ID).</li>
                        <li>Provide daily reports to the NYPD of transactions (often through electronic reporting).</li>
                        <li>If police suspect an item is lost/stolen, you must hold and exhibit it to them.</li>
                    </ul>
                </li>
                <li><strong>New York City Administrative Code § 20-273:</strong> It is unlawful to conceal, withhold, or refuse inspection of such goods.</li>
                <li><strong>General Business Law (NY) GBL § 89-g and following – Regulation of pawnbrokers and secondhand dealers:</strong> Requires keeping detailed records and prohibits resale of items flagged as stolen/lost until cleared.</li>
                <li><strong>Federal Considerations (18 U.S.C. § 2315 – Possession or sale of stolen property):</strong> If stolen goods (like phones) cross state lines or involve interstate commerce, federal law applies.</li>
            </ul>

            <h4>Process to Handle Lost/Stolen Phones in Your Buyback</h4>
            <p>Here’s our step-by-step written policy to handle devices suspected of being lost or stolen:</p>
            <h5>Intake & Verification</h5>
            <ul>
                <li>Every device received must be checked against:
                    <ul>
                        <li>IMEI/serial number databases (e.g., GSMA, carrier blacklists).</li>
                        <li>Customer’s government-issued ID at time of transaction.</li>
                    </ul>
                </li>
                <li>Record the transaction in compliance with NYC Secondhand Dealer laws.</li>
            </ul>
            <h5>If a Device is Flagged as Lost or Stolen</h5>
            <ul>
                <li>Immediately set the device aside and do not refurbish, resell, or dispose of it.</li>
                <li>Clearly label it as “On Hold – Suspected Lost/Stolen.”</li>
            </ul>
            <h5>Customer Communication</h5>
            <ul>
                <li>If the customer requests the item back:
                    <ul>
                        <li>Explain: “Under New York law, we cannot return or release devices suspected to be lost or stolen. These items must be reported and may only be released by law enforcement.”</li>
                    </ul>
                </li>
            </ul>
            <h5>Law Enforcement Notification</h5>
            <ul>
                <li>Report the device to the NYPD Property Clerk’s Office (or local precinct if outside NYC).</li>
                <li>Provide transaction records, customer ID, and the device itself if requested.</li>
            </ul>
            <h5>Outcome</h5>
            <ul>
                <li>If police confirm the device is stolen:
                    <ul>
                        <li>It will be seized and returned to the rightful owner or carrier.</li>
                    </ul>
                </li>
                <li>If cleared:
                    <ul>
                        <li>You may proceed with processing the device as normal.</li>
                    </ul>
                </li>
            </ul>
            <h5>Recordkeeping</h5>
            <ul>
                <li>Keep all paperwork of the transaction, report, and police correspondence for at least 5 years (per NYC dealer rules).</li>
            </ul>
            </div></div></div>

    <!-- CHAT WIDGET -->
    <div id="chat-widget-container">
        <div id="chat-window">
            <!-- Chat Header -->
            <div class="bg-blue-700 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Customer Support</h3>
                <div class="flex items-center space-x-2"> <!-- Grouping buttons -->
                    <button id="chat-order-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="View My Orders">
                        <i class="fa-solid fa-box-open text-xl"></i>
                    </button>
                    <button id="chat-minimize-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="Minimize Chat">
                        <i class="fa-solid fa-minus text-xl"></i>
                    </button>
                    <button id="chat-close-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="End Chat">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Area (scrolling) -->
            <div id="chat-messages" class="bg-slate-50"></div>

            <!-- Order Selection UI -->
            <div id="order-selection-container" class="p-4 border-t border-slate-200 bg-white hidden">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm text-slate-600 font-semibold" id="order-selection-prompt">Please select your order:</p>
                    <button id="close-order-selection-btn" class="chat-header-button text-slate-400 hover:text-slate-600 transition-colors duration-200" data-tooltip-text="Close Order Selection">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div id="order-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Orders or login prompt will be rendered here -->
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator-container" class="p-2 hidden">
                <div class="p-3 rounded-lg max-w-[85%] mb-2 break-words chat-bubble-agent">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            </div>

            <!-- Input Area -->
            <div id="chat-input-container" class="p-4 border-t border-slate-200 flex items-center">
                <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mr-2">
                <button id="send-message-btn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm" data-tooltip-text="Send Message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <!-- Guest Prompt -->
            <div id="guest-prompt-container" class="p-4 border-t border-slate-200 hidden">
                <p class="text-center text-sm text-slate-600 mb-3">To provide the best support, please log in or continue as a guest.</p>
                <div class="space-y-2">
                    <button id="guest-login-btn" class="btn-dark-slate">Login / Sign Up</button>
                    <button id="guest-continue-btn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Ask a General Question</button>
                </div>
            </div>

            <!-- Survey -->
            <div id="chat-survey-container" class="p-4 border-t border-slate-200 hidden overflow-y-auto">
                <p class="text-center font-semibold mb-2">The agent has ended the chat.</p>
                <p class="text-center text-sm text-slate-600 mb-4">Please rate your experience.</p>
                <form id="chat-survey-form">
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Overall Rating:</label>
                        <div id="star-rating" class="star-rating text-3xl flex justify-center" data-rating="0">
                            <i class="fa-solid fa-star" data-value="1"></i><i class="fa-solid fa-star" data-value="2"></i><i class="fa-solid fa-star" data-value="3"></i><i class="fa-solid fa-star" data-value="4"></i><i class="fa-solid fa-star" data-value="5"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="friendliness-rating" class="font-semibold text-slate-700 block mb-2">Agent Friendliness: <span id="friendliness-value" class="font-bold text-blue-600">5</span>/10</label>
                        <input type="range" id="friendliness-rating" min="1" max="10" value="5" class="w-full">
                    </div>
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Was your issue resolved?</label>
                        <div class="flex justify-center gap-4">
                            <label><input type="radio" name="issue-resolved" value="yes" class="mr-1"> Yes</label>
                            <label><input type="radio" name="issue-resolved" value="no" class="mr-1"> No</label>
                        </div>
                    </div>
                    <div class="mb-4">
                            <label for="survey-comments" class="font-semibold text-slate-700 block mb-2">Additional Comments (optional):</label>
                            <textarea id="survey-comments" rows="2" class="w-full border border-slate-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="btn-dark-slate">Submit Feedback</button>
                </form>
            </div>

            <!-- End Chat Confirmation - Moved back inside chat-window -->
            <div id="end-chat-confirm-modal" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center p-4 z-10">
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
                    <p class="text-lg font-semibold text-slate-800 mb-4">End this chat session?</p>
                    <div class="flex gap-4 justify-center">
                        <button id="end-chat-yes" class="px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition">Yes, End Chat</button>
                        <button id="end-chat-no" class="px-6 py-2 font-semibold text-slate-800 bg-slate-200 rounded-lg hover:bg-slate-300 transition">No</button>
                    </div>
                </div>
            </div>
        </div>
        <button id="chat-open-btn">
            <i class="fa-solid fa-comments text-3xl"></i>
            <span id="unread-counter">0</span>
        </button>
    </div>

    <!-- Global Tooltip Container - positioned at the end of body -->
    <div id="globalTooltip" class="tooltip-text"></div>

    <!-- FIREBASE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from global variable
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sign in only with custom token if provided, otherwise no automatic sign-in
        const authenticateFirebase = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    // If custom token fails, do not fall back to anonymous sign-in.
                    // User will need to explicitly log in via the UI.
                }
            } else {
                // No custom token provided, no automatic sign-in.
                // User will need to explicitly log in via the UI.
                console.log("No custom token provided. User must sign in via UI.");
            }
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // Authenticate Firebase on page load
            await authenticateFirebase();

            // --- DYNAMIC IMAGE LOADING LOGIC ---
            function loadImageWithFallback(imgElement) {
                const baseSrc = imgElement.dataset.baseSrc;
                if (!baseSrc) return;
                const extensions = ['.webp', '.avif', '.png', '.jpeg', '.jpg', '.svg']; // Added .svg
                let current = 0;
                function tryLoad() {
                    if (current >= extensions.length) {
                        if (imgElement.id.includes('_cat_img')) { imgElement.src = `https://placehold.co/150x150/e0e7ff/4338ca?text=Category`; } 
                        else { imgElement.src = `https://placehold.co/200x200/f0f4ff/6366f1?text=No+Image`; }
                        imgElement.alt = "Image not available";
                        return;
                    }
                    const testSrc = baseSrc + extensions[current];
                    const img = new Image();
                    img.onload = () => { imgElement.src = testSrc; };
                    img.onerror = () => { current++; tryLoad(); };
                    img.src = testSrc;
                }
                tryLoad();
            }
            document.querySelectorAll('img[data-base-src]').forEach(loadImageWithFallback);

            // --- MODAL LOGIC ---
            const modals = document.querySelectorAll('.modal');
            const openModal = (modalId) => document.getElementById(modalId)?.classList.add('is-visible');
            const closeModal = (modal) => modal.classList.remove('is-visible');

            // Event listener for the Terms & Conditions link in the floating banner and footer
            document.getElementById('termsAndConditionsLink').addEventListener('click', (e) => { 
                e.preventDefault(); 
                openModal('termsAndConditionsModal'); 
            });
            document.getElementById('termsAndConditionsLinkFooter').addEventListener('click', (e) => { 
                e.preventDefault(); 
                openModal('termsAndConditionsModal'); 
            });

            document.getElementById('loginNavBtn').addEventListener('click', (e) => { e.preventDefault(); openModal('loginModal'); });
            document.getElementById('aboutUsLink').addEventListener('click', (e) => { e.preventDefault(); openModal('aboutUsModal'); });
            document.getElementById('privacyPolicyLink').addEventListener('click', (e) => { e.preventDefault(); openModal('privacyPolicyModal'); });

            modals.forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
                modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
            });

            // --- EMAIL SIGNUP FORM LOGIC ---
            const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
            const footerSignupMessage = document.getElementById('footerSignupMessage');
            footerEmailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('footerPromoEmail').value;
                footerSignupMessage.textContent = 'Submitting...';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-blue-300';
                
                try {
                    await addDoc(collection(db, "signed_up_emails"), {
                        email: email,
                        timestamp: new Date()
                    });
                    footerSignupMessage.textContent = 'Success! Thanks for signing up.';
                    footerSignupMessage.className = 'mt-3 text-sm text-center text-green-300';
                    footerEmailSignupForm.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    footerSignupMessage.textContent = 'Error: Could not sign up.';
                    footerSignupMessage.className = 'mt-3 text-sm text-center text-red-300';
                }
            });

            // --- AUTH LOGIC ---
            const authStatusContainer = document.getElementById('authStatusContainer');
            const userMonogram = document.getElementById('userMonogram');
            const authDropdown = document.getElementById('authDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const signupTabBtn = document.getElementById('signupTabBtn');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const authMessage = document.getElementById('authMessage');

            const showTab = (tabName) => {
                authMessage.classList.add('hidden');
                [loginForm, signupForm, forgotPasswordForm].forEach(form => form.classList.add('hidden'));
                [loginTabBtn, signupTabBtn].forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-slate-500');
                });
                if (tabName === 'login') { loginForm.classList.remove('hidden'); loginTabBtn.classList.add('border-blue-600', 'text-blue-600'); } 
                else if (tabName === 'signup') { signupForm.classList.remove('hidden'); signupTabBtn.classList.add('border-blue-600', 'text-blue-600'); } 
                else if (tabName === 'forgotPassword') { forgotPasswordForm.classList.remove('hidden'); }
            };

            const showAuthMessage = (msg, type) => {
                authMessage.textContent = msg;
                authMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center w-full';
                if (type === 'error') authMessage.classList.add('bg-red-100', 'text-red-700');
                else if (type === 'success') authMessage.classList.add('bg-green-100', 'text-green-700');
                else authMessage.classList.add('bg-blue-100', 'text-blue-700');
                authMessage.classList.remove('hidden');
            };

            loginTabBtn.addEventListener('click', () => showTab('login'));
            signupTabBtn.addEventListener('click', () => showTab('signup'));
            document.getElementById('switchToLogin').addEventListener('click', (e) => { e.preventDefault(); showTab('login'); });
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); showTab('forgotPassword'); });
            document.getElementById('returnToLogin').addEventListener('click', (e) => { e.preventDefault(); showTab('login'); });

            const googleProvider = new GoogleAuthProvider();
            const signInWithGoogle = async () => {
                try {
                    showAuthMessage('Redirecting to Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) { showAuthMessage(`Google sign-in failed: ${error.message}`, 'error'); }
            };
            document.getElementById('googleLoginBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('googleSignupBtn').addEventListener('click', signInWithGoogle);

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    showAuthMessage('Logging in...', 'info');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) { showAuthMessage(`Login failed: ${error.message}`, 'error'); }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                if (password.length < 6) { showAuthMessage('Password must be at least 6 characters.', 'error'); return; }
                try {
                    showAuthMessage('Creating account...', 'info');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                } catch (error) { showAuthMessage(`Sign up failed: ${error.message}`, 'error'); }
            });
            
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value;
                try {
                    showAuthMessage('Sending reset email...', 'info');
                    await sendPasswordResetEmail(auth, email);
                    showAuthMessage('Password reset email sent! Check your inbox.', 'success');
                } catch (error) { showAuthMessage(`Failed to send email: ${error.message}`, 'error'); }
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('loginNavBtn').classList.add('hidden');
                    userMonogram.classList.remove('hidden');
                    const displayName = user.displayName;
                    const email = user.email;
                    let initials = displayName ? displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : (email ? email.charAt(0).toUpperCase() : '');
                    userMonogram.textContent = initials;
                    closeModal(document.getElementById('loginModal'));
                } else {
                    document.getElementById('loginNavBtn').classList.remove('hidden');
                    userMonogram.classList.add('hidden');
                    authDropdown.classList.add('hidden');
                }
            });

            userMonogram.addEventListener('click', (e) => { e.stopPropagation(); authDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!authStatusContainer.contains(e.target)) { authDropdown.classList.add('hidden'); } });
            logoutBtn.addEventListener('click', () => signOut(auth));


            // --- ADVANCED LIVE CHAT LOGIC ---
            const chatWindow = document.getElementById('chat-window');
            const chatOpenBtn = document.getElementById('chat-open-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatMinimizeBtn = document.getElementById('chat-minimize-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatInputContainer = document.getElementById('chat-input-container');
            const guestPromptContainer = document.getElementById('guest-prompt-container');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            const guestContinueBtn = document.getElementById('guest-continue-btn');
            const unreadCounter = document.getElementById('unread-counter');
            const typingIndicatorContainer = document.getElementById('typing-indicator-container');
            const surveyContainer = document.getElementById('chat-survey-container');
            const surveyForm = document.getElementById('chat-survey-form');
            const starRatingContainer = document.getElementById('star-rating');
            const friendlinessRating = document.getElementById('friendliness-rating');
            const friendlinessValue = document.getElementById('friendliness-value');
            const endChatConfirmModal = document.getElementById('end-chat-confirm-modal');
            const endChatYesBtn = document.getElementById('end-chat-yes');
            const endChatNoBtn = document.getElementById('end-chat-no');
            const orderSelectionContainer = document.getElementById('order-selection-container');
            const orderList = document.getElementById('order-list');
            const closeOrderSelectionBtn = document.getElementById('close-order-selection-btn');
            const orderSelectionPrompt = document.getElementById('order-selection-prompt');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const floatingBanner = document.getElementById('floatingBanner'); // Get the banner element
            const closeBannerBtn = document.getElementById('closeBannerBtn'); // Get the close banner button
            const globalTooltip = document.getElementById('globalTooltip'); // Get the global tooltip element

            let currentChatId = null;
            let unsubscribeFromMessages = null;
            let unsubscribeFromChatSession = null;
            let isChatMinimized = true;
            let unreadCount = 0;
            let hasUserTypedFirstMessage = false;
            let userTypingTimeout = null;
            // Flag to track if the initial welcome message has been rendered for the current chat session
            let initialWelcomeRendered = {}; 

            const notificationSound = new Audio('https://cdn.freesound.org/previews/253/253887_3900531-lq.mp3');
            notificationSound.volume = 0.5;

            const getOrCreateGuestId = () => {
                // Since anonymous sign-in is disabled, guest IDs are no longer relevant for chat sessions.
                // This function can remain, but its usage in creating chat sessions will be updated.
                let id = localStorage.getItem('guestChatId');
                if (!id) {
                    id = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    localStorage.setItem('guestChatId', id);
                }
                return id;
            };

            const getOrCreateChatSession = async () => {
                let chatId = localStorage.getItem('chatSessionId');
                const user = auth.currentUser;

                // If no authenticated user, and no existing chat ID, then force login prompt
                if (!user && !chatId) {
                    console.log("No authenticated user and no existing chat session. Prompting for login.");
                    return null; // Indicate that a chat session cannot be created without login
                }

                // If there's an existing chat ID, try to use it
                if (chatId) {
                    // Check if the existing chat ID belongs to the current authenticated user
                    // or if it's a guest chat and there's no authenticated user.
                    const chatDoc = await getDoc(doc(db, "chats", chatId));
                    if (chatDoc.exists()) {
                        const chatData = chatDoc.data();
                        if (user && chatData.ownerUid === user.uid) {
                            return chatId; // Valid chat for authenticated user
                        } else if (!user && chatData.guestId === localStorage.getItem('guestChatId')) {
                            return chatId; // Valid guest chat for non-authenticated user
                        } else {
                            // Existing chat ID doesn't match current user/guest, clear it.
                            localStorage.removeItem('chatSessionId');
                            localStorage.removeItem(`agentJoined_${chatId}`);
                            chatId = null;
                        }
                    } else {
                        // Chat ID in local storage doesn't exist in Firestore, clear it.
                        localStorage.removeItem('chatSessionId');
                        localStorage.removeItem(`agentJoined_${chatId}`);
                        chatId = null;
                    }
                }
                
                // If no valid existing chat ID, create a new one
                if (!chatId) {
                    const chatSessionData = {
                        createdAt: serverTimestamp(),
                        ownerUid: user ? user.uid : null,
                        guestId: user ? null : getOrCreateGuestId(), // Still use guestId for unauthenticated users if they continue as guest
                        status: 'active',
                        agentName: null,
                        isAgentTyping: false,
                        userTypingText: '',
                        agentAskingForOrderId: false
                    };
                    const docRef = await addDoc(collection(db, "chats"), chatSessionData);
                    chatId = docRef.id;
                    localStorage.setItem('chatSessionId', chatId);
                }
                return chatId;
            };

            // Modified renderMessage to always append to chatMessages, no more fixed system messages container
            const renderMessage = (msg) => {
                const messageDiv = document.createElement('div');
                const user = auth.currentUser;
                const currentGuestId = localStorage.getItem('guestChatId');
                const isMyMessage = (user && msg.sender === user.uid) || (!user && msg.sender === currentGuestId);
                
                let classes = 'p-3 rounded-lg max-w-[85%] mb-2 break-words';
                if (msg.type === 'system') {
                    classes = 'text-center text-sm text-slate-500 my-2';
                    messageDiv.innerHTML = `<span class="bg-white px-2 py-1 rounded-full">${msg.text}</span>`;
                } else {
                    classes += isMyMessage ? ' bg-gray-200 text-slate-800 self-end' : ' bg-blue-100 text-blue-800 self-start';
                    messageDiv.textContent = msg.text;
                }

                messageDiv.className = classes;
                // Add a unique ID for agent joined messages to prevent duplicates
                if (msg.type === 'system' && msg.text.includes('has joined the chat.')) {
                    messageDiv.id = `agent-joined-${currentChatId}`; 
                }
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const listenForChatSessionChanges = (chatId) => {
                if (unsubscribeFromChatSession) unsubscribeFromChatSession();
                unsubscribeFromChatSession = onSnapshot(doc(db, "chats", chatId), async (docSnap) => {
                    const data = docSnap.data();
                    if (!data) return;

                    // Agent joined message logic
                    const agentJoinedFlag = localStorage.getItem(`agentJoined_${chatId}`);
                    if (data.agentName && data.agentHasJoined && !agentJoinedFlag) {
                        const joinMsgText = `<i class="fa-solid fa-headset mr-2"></i>${data.agentName} has joined the chat.`;
                        // Add this message to Firestore so it's persisted and appears in chat history
                        await addDoc(collection(db, `chats/${chatId}/messages`), {
                            text: joinMsgText,
                            timestamp: serverTimestamp(),
                            sender: 'system',
                            type: 'system'
                        });
                        localStorage.setItem(`agentJoined_${chatId}`, 'true'); // Set flag in localStorage
                    }
                    
                    typingIndicatorContainer.style.display = data.isAgentTyping ? 'block' : 'none';
                    if (data.isAgentTyping) chatMessages.scrollTop = chatMessages.scrollHeight;
                    if (data.status === 'ended_by_agent') {
                        chatInputContainer.classList.add('hidden');
                        guestPromptContainer.classList.add('hidden');
                        surveyContainer.classList.remove('hidden');
                        orderSelectionContainer.classList.add('hidden'); // Hide order selection
                        localStorage.removeItem('chatSessionId');
                        localStorage.removeItem(`agentJoined_${chatId}`); // Clear flag on chat end
                    }
                    // --- NEW: Detect agent asking for order ID ---
                    if (data.agentAskingForOrderId) {
                        displayOrderSelectionUI();
                    } else {
                        orderSelectionContainer.classList.add('hidden');
                    }
                    // --- END NEW ---
                });
            };

            const listenForMessages = (chatId) => {
                if (unsubscribeFromMessages) unsubscribeFromMessages();
                currentChatId = chatId;
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const q = query(messagesRef, orderBy("timestamp"));
                unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = ''; // Clear existing messages
                    if (!initialWelcomeRendered[chatId] && snapshot.empty) {
                        // Render initial welcome if no messages exist yet
                        const user = auth.currentUser;
                        const userName = user?.displayName?.split(' ')[0] || 'there';
                        renderMessage({ type: 'system', text: `Hi ${userName}, how can we help you today?` });
                        initialWelcomeRendered[chatId] = true; // Mark as rendered
                    }

                    snapshot.forEach(doc => {
                        const msgData = doc.data();
                        renderMessage(msgData); // All messages now render to the scrollable area
                        const user = auth.currentUser;
                        const currentGuestId = localStorage.getItem('guestChatId');
                        const isMyMessage = (user && msgData.sender === user.uid) || (!user && msgData.sender === currentGuestId);
                        if (!isMyMessage && isChatMinimized) {
                            unreadCount++;
                            unreadCounter.textContent = unreadCount;
                            unreadCounter.classList.add('visible');
                            notificationSound.play().catch(e => console.log("Audio play failed:", e));
                        }
                    });
                });
            };

            const resetChatUI = () => {
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex'); // Ensure display:flex is removed
                surveyContainer.classList.add('hidden');
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden'); // Ensure input is visible
                orderSelectionContainer.classList.add('hidden'); // Hide order selection
                typingIndicatorContainer.style.display = 'none';
                chatMessages.innerHTML = ''; // Clear all messages
                initialWelcomeRendered = {}; // Reset the welcome message flag for all chats
            };

            const openChat = async () => {
                resetChatUI(); // Reset UI before opening
                chatWindow.classList.add('is-visible');
                isChatMinimized = false;
                unreadCount = 0;
                unreadCounter.classList.remove('visible');

                const user = auth.currentUser;
                if (!user) {
                    // If no user is logged in, show the guest prompt immediately
                    chatInputContainer.classList.add('hidden');
                    guestPromptContainer.classList.remove('hidden');
                    return;
                }

                const chatId = await getOrCreateChatSession();
                if (chatId) {
                    listenForMessages(chatId);
                    listenForChatSessionChanges(chatId);
                    // The initial welcome message is now handled by listenForMessages if chat is empty
                }
            };
            chatOpenBtn.addEventListener('click', openChat);

            const minimizeChat = () => {
                chatWindow.classList.remove('is-visible');
                isChatMinimized = true;
            };
            chatMinimizeBtn.addEventListener('click', minimizeChat);

            chatCloseBtn.addEventListener('click', () => {
                endChatConfirmModal.classList.remove('hidden');
                endChatConfirmModal.classList.add('flex'); // Add flex to display it
            });

            endChatNoBtn.addEventListener('click', () => {
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex');
            });

            endChatYesBtn.addEventListener('click', async () => {
                if (currentChatId) {
                    await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                        text: "Chat ended by user.",
                        timestamp: serverTimestamp(),
                        sender: 'system',
                        type: 'system'
                    });
                    await updateDoc(doc(db, "chats", currentChatId), { status: 'ended_by_user' });
                }
                localStorage.removeItem('chatSessionId');
                localStorage.removeItem(`agentJoined_${currentChatId}`); // Clear flag on user end
                currentChatId = null;
                hasUserTypedFirstMessage = false;
                chatMessages.innerHTML = '';
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex');
                minimizeChat();
            });

            const sendMessage = async (text) => {
                if (text.trim() === '' || !currentChatId) return;
                const user = auth.currentUser;

                // If not authenticated, force guest prompt (should already be shown by openChat)
                if (!user) {
                    chatInputContainer.classList.add('hidden');
                    guestPromptContainer.classList.remove('hidden');
                    return;
                }

                const currentGuestId = getOrCreateGuestId(); // This will still generate a guest ID, but it won't be used for `sender` if `user` exists
                const messageData = { text, timestamp: serverTimestamp(), sender: user ? user.uid : currentGuestId };
                await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
                chatInput.value = '';
                await updateDoc(doc(db, "chats", currentChatId), { 
                    userTypingText: '', 
                    lastMessage: `User: ${text}`,
                    lastMessageTimestamp: serverTimestamp() 
                });
            };

            // Send message on Enter key press
            chatInput.addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    sendMessage(chatInput.value); 
                } 
            });
            // Send message on button click
            sendMessageBtn.addEventListener('click', () => {
                sendMessage(chatInput.value);
            });

            chatInput.addEventListener('keyup', () => {
                clearTimeout(userTypingTimeout);
                userTypingTimeout = setTimeout(async () => {
                    if (currentChatId) {
                        await updateDoc(doc(db, "chats", currentChatId), { userTypingText: chatInput.value });
                    }
                }, 300); // Shortened delay for faster preview
            });

            guestLoginBtn.addEventListener('click', () => {
                openModal('loginModal');
                // After clicking login, hide the guest prompt and show the input container
                // The onAuthStateChanged listener will handle closing the modal and updating UI
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden');
            });

            // Removed guestContinueBtn functionality as anonymous sign-in is disabled.
            // If the user is not logged in, they must log in to use the chat.
            guestContinueBtn.addEventListener('click', () => {
                // This button should now redirect to login or be removed/hidden.
                // For now, it will simply open the login modal to reinforce real sign-in.
                openModal('loginModal');
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden');
            });
            // Update the text and hide the guest continue button since anonymous sign-in is off
            document.getElementById('guest-prompt-container').innerHTML = `
                <p class="text-center text-sm text-slate-600 mb-3">Please log in to start a chat session.</p>
                <div class="space-y-2">
                    <button id="guest-login-btn" class="btn-dark-slate">Login / Sign Up</button>
                </div>
            `;
            // Re-attach event listener for the new guest-login-btn
            document.getElementById('guest-login-btn').addEventListener('click', () => {
                openModal('loginModal');
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden');
            });


            friendlinessRating.addEventListener('input', (e) => { friendlinessValue.textContent = e.target.value; });
            starRatingContainer.addEventListener('mouseover', e => {
                if (e.target.tagName === 'I') {
                    const rating = e.target.dataset.value;
                    Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= rating));
                }
            });
            starRatingContainer.addEventListener('mouseout', () => {
                const currentRating = starRatingContainer.dataset.rating;
                Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= currentRating));
            });
            starRatingContainer.addEventListener('click', e => {
                if (e.target.tagName === 'I') {
                    starRatingContainer.dataset.rating = e.target.dataset.value;
                }
            });

            surveyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const surveyData = {
                    overallRating: parseInt(starRatingContainer.dataset.rating, 10),
                    friendliness: friendlinessRating.value,
                    resolved: document.querySelector('input[name="issue-resolved"]:checked')?.value || null,
                    comments: document.getElementById('survey-comments').value
                };
                await setDoc(doc(db, `chats/${currentChatId}/survey/feedback`), { ...surveyData, submittedAt: serverTimestamp() });
                try {
                    const cloudFunctionUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api/submit-chat-feedback';
                    const response = await fetch(cloudFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chatId: currentChatId, surveyData: surveyData })
                    });
                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    console.log('Feedback email sent successfully:', await response.json());
                } catch (error) { console.error("Error sending feedback email:", error); }
                surveyContainer.innerHTML = '<p class="text-center font-semibold text-green-600">Thank you for your feedback!</p>';
            });

            // --- Order Selection Logic ---
            const fetchUserOrders = async () => {
                const user = auth.currentUser;
                if (!user || !user.uid) {
                    console.warn("No authenticated user found for fetching orders.");
                    return { requiresLogin: true }; // Indicate that login is required
                }
                const userId = user.uid;
                // Corrected Firestore path
                const ordersRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
                const q = query(ordersRef, orderBy("timestamp", "desc"));
                try {
                    const snapshot = await getDocs(q);
                    // Mock data for testing if no orders are found
                    if (snapshot.empty) {
                        console.log("No actual orders found, returning mock data.");
                        return [
                            { id: 'mockOrder1', orderId: 'ORD001', deviceName: 'iPhone 13 Pro', storage: '128GB', price: 500, imageUrl: 'https://placehold.co/48x48/e0e7ff/4338ca?text=i13P', reoffer: 450 },
                            { id: 'mockOrder2', orderId: 'ORD002', deviceName: 'Samsung Galaxy S22', storage: '256GB', price: 300, imageUrl: 'https://placehold.co/48x48/e0e7ff/4338ca?text=S22' },
                            { id: 'mockOrder3', orderId: 'ORD003', deviceName: 'iPad Air 4', storage: '64GB', price: 350, imageUrl: 'https://placehold.co/48x48/e0e7ff/4338ca?text=iPad' }
                        ];
                    }
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Error fetching user orders:", error);
                    return { error: true, message: error.message };
                }
            };

            const renderOrderSelection = (orders) => {
                orderList.innerHTML = ''; // Clear previous orders
                if (orders.requiresLogin) {
                    orderList.innerHTML = '<p class="text-center text-slate-500">Please <a href="#" id="orderLoginPromptLink" class="text-blue-600 font-semibold hover:underline">log in</a> to view and select your orders.</p>';
                    document.getElementById('orderLoginPromptLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        openModal('loginModal');
                        orderSelectionContainer.classList.add('hidden'); // Hide order selection after clicking login
                    });
                    orderSelectionPrompt.textContent = 'Login to access your orders:';
                    return;
                }
                
                if (orders.error) {
                    orderList.innerHTML = `<p class="text-center text-red-500">Error loading orders: ${orders.message}</p>`;
                    orderSelectionPrompt.textContent = 'Error loading orders:';
                    return;
                }

                if (orders.length === 0) {
                    orderList.innerHTML = '<p class="text-center text-slate-500">No recent orders found.</p>';
                    orderSelectionPrompt.textContent = 'Please select your order:';
                    return;
                }
                orderSelectionPrompt.textContent = 'Please select your order:'; // Reset prompt text
                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'order-card';
                    orderCard.dataset.orderId = order.orderId;
                    orderCard.innerHTML = `
                        <img src="${order.imageUrl || 'https://placehold.co/48x48/e0e7ff/4338ca?text=📱'}" alt="${order.deviceName}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/e0e7ff/4338ca?text=📱';">
                        <div class="order-card-details">
                            <strong>ID: ${order.orderId} - ${order.deviceName}</strong>
                            <span>${order.storage} | $${order.price}</span>
                            ${order.reoffer ? `<span class="reoffer">Reoffer: $${order.reoffer}</span>` : ''}
                        </div>
                    `;
                    orderCard.addEventListener('click', () => handleOrderSelection(order));
                    orderList.appendChild(orderCard);
                });
            };

            const displayOrderSelectionUI = async () => {
                const user = auth.currentUser;
                if (!user) {
                    // If not logged in, prompt for login instead of showing empty orders
                    chatInputContainer.classList.add('hidden');
                    guestPromptContainer.classList.remove('hidden');
                    return;
                }

                guestPromptContainer.classList.add('hidden');
                orderSelectionContainer.classList.remove('hidden');
                orderList.innerHTML = '<p class="text-center text-blue-500">Loading your orders...</p>';
                const orders = await fetchUserOrders();
                renderOrderSelection(orders);
            };

            const handleOrderSelection = async (order) => {
                const messageText = `Selected Order: ID: ${order.orderId}, Device: ${order.deviceName}, Storage: ${order.storage}, Price: $${order.price}${order.reoffer ? `, Reoffer: $${order.reoffer}` : ''}`;
                await sendMessage(messageText);
                orderSelectionContainer.classList.add('hidden');
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
                }
            };

            closeOrderSelectionBtn.addEventListener('click', async () => {
                orderSelectionContainer.classList.add('hidden');
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
                }
            });

            // "Orders" button in chat header
            const chatOrderBtn = document.getElementById('chat-order-btn');
            chatOrderBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    // If not logged in, prompt for login
                    chatInputContainer.classList.add('hidden');
                    guestPromptContainer.classList.remove('hidden');
                    return;
                }

                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: true });
                } else {
                    // If no chat session, still display order selection for authenticated users
                    displayOrderSelectionUI();
                }
            });

            // --- Floating Banner Close Logic ---
            closeBannerBtn.addEventListener('click', () => {
                floatingBanner.style.display = 'none'; // Hide the banner
            });

            // --- Global Tooltip Logic ---
            const chatHeaderButtons = document.querySelectorAll('.chat-header-button');

            chatHeaderButtons.forEach(button => {
                let tooltipTimeout;

                button.addEventListener('mouseover', (e) => {
                    clearTimeout(tooltipTimeout);
                    const tooltipText = button.dataset.tooltipText; // Get text from data-tooltip-text
                    if (tooltipText) {
                        globalTooltip.textContent = tooltipText;
                        globalTooltip.style.visibility = 'visible';
                        globalTooltip.style.opacity = '1';

                        const rect = button.getBoundingClientRect();
                        // Position below the button, centered
                        globalTooltip.style.top = `${rect.bottom + 8}px`; // 8px padding from button
                        globalTooltip.style.left = `${rect.left + rect.width / 2}px`;
                        // Adjust left again after element is visible to truly center
                        globalTooltip.style.transform = `translateX(-50%)`;
                    }
                });

                button.addEventListener('mouseout', () => {
                    tooltipTimeout = setTimeout(() => {
                        globalTooltip.style.visibility = 'hidden';
                        globalTooltip.style.opacity = '0';
                    }, 100); // Small delay before hiding
                });

                // Clear timeout if mouse re-enters quickly
                button.addEventListener('mouseenter', () => {
                    clearTimeout(tooltipTimeout);
                });
            });
        });
    </script>
</body>
</html>
