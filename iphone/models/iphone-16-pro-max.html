<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SwiftBuyBack - Sell iPhone 16 Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Font Awesome Brands for PayPal -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/brands.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Google Maps Places API script with async loading -->
    <!-- You MUST replace YOUR_API_KEY with your actual API key from Google Cloud.
         Ensure you have enabled the Maps JavaScript API and the Places API. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqQLYjYP3Xe8ysVtcbA-65dusM0yvpm5s&loading=async&libraries=places&callback=initAutocomplete"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            doc,
            getDoc,
            updateDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateProfile = updateProfile;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.firebaseDb = db;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for hidden radio buttons and clickable images */
        .carrier-option input[type="radio"],
        .payment-option input[type="radio"],
        .shipping-option input[type="radio"] {
            display: none;
        }
        .carrier-option label,
        .payment-option label,
        .shipping-option label {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .carrier-option input[type="radio"]:checked + label,
        .payment-option input[type="radio"]:checked + label,
        .shipping-option input[type="radio"]:checked + label {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
            transform: scale(1.02);
            background-color: #e0e7ff;
        }
        .carrier-option label:hover,
        .payment-option label:hover,
        .shipping-option label:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .modal.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        #quoteModal {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s ease-out;
            opacity: 0;
            transform: scale(0.9);
            visibility: hidden;
        }
        #quoteModal.is-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        .custom-checkbox input[type="checkbox"] {
            display: none;
        }
        .custom-checkbox .checkmark {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #94a3b8;
            border-radius: 0.25rem;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0.5rem;
            height: 1rem;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: translate(-50%, -60%) rotate(45deg);
        }
        .btn-primary-blue {
            background-color: #2563eb;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-blue:hover {
            background-color: #1d4ed8;
            transform: scale(1.05);
        }
        .btn-primary-blue:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.5);
        }
        .btn-secondary-green {
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-secondary-green:hover {
            background-color: #16a34a;
            transform: scale(1.05);
        }
        .btn-secondary-green:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.5);
        }
        .btn-google-style {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            background-color: white;
            color: #475569;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover {
            background-color: #f8fafc;
        }
        .btn-dark-slate {
            width: 100%;
            background-color: #1e293b;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-dark-slate:hover {
            background-color: #0f172a;
        }
        .btn-red-logout {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #dc2626;
            background-color: transparent;
            border: none;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .btn-red-logout:hover {
            background-color: #fef2f2;
        }
        .btn-primary-indigo {
            background-color: #4f46e5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary-indigo:hover {
            background-color: #4338ca;
            transform: scale(1.05);
        }
        .btn-primary-indigo:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #94a3b8 !important;
            box-shadow: none;
            transform: none;
        }
        /* Mobile-first adjustments for layout and typography */
        @media (max-width: 1023px) {
            .main-content-layout {
                flex-direction: column-reverse;
            }
            .quote-display-mobile-first {
                order: -1;
                margin-bottom: 2rem;
            }
            .main-content-layout > div:nth-child(1) {
                margin-top: 2rem;
            }
            .text-4xl {
                font-size: 2.25rem;
            }
            .text-3xl {
                font-size: 1.875rem;
            }
            .text-lg {
                font-size: 1rem;
            }
            .question-group {
                padding: 0.75rem;
            }
            .carrier-option label,
            .payment-option label,
            .shipping-option label {
                padding: 0.75rem;
            }
            .h-10.w-10 {
                height: 2rem;
                width: 2rem;
            }
            .text-4xl {
                font-size: 2rem;
            }
            .text-3xl {
                font-size: 1.75rem;
            }
            .btn-primary-blue,
            .btn-secondary-green,
            .btn-primary-indigo {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .modal-content .text-5xl {
                font-size: 3rem;
            }
        }
        /* Desktop-specific layout rules */
        @media (min-width: 1024px) {
            .lg\:text-left .question-group .flex {
                justify-content: flex-start;
            }
            .quote-display-mobile-first {
                order: unset;
            }
        }
        .highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .carrier-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .payment-option input[type="radio"]:not(:checked) + label.highlight-missing,
        .shipping-option input[type="radio"]:not(:checked) + label.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .custom-checkbox input[type="checkbox"]:not(:checked) + .checkmark.highlight-missing {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }
        .user-monogram {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: #e0e7ff;
            color: #4338ca;
            font-weight: 700;
            font-size: 1.125rem;
            cursor: pointer;
            user-select: none;
        }
        .auth-dropdown {
            position: absolute;
            right: 0;
            margin-top: 0.5rem;
            width: 12rem;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            z-index: 20;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="https://secondhandcell.com/index.html" class="text-2xl font-bold text-indigo-700 rounded-md p-2">SwiftBuyBack</a>
            <nav class="space-x-4 flex items-center">
                <a href="https://secondhandcell.com/sell-device.html" class="text-slate-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Sell Your Device</a>
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="text-slate-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden">
                        <a href="https://secondhandcell.com/my-account.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-3xl shadow-xl flex flex-col lg:flex-row items-center justify-center gap-12 main-content-layout">
            <div class="w-full lg:w-2/5 text-center quote-display-mobile-first">
                <div class="relative w-full max-w-sm mx-auto mb-6 rounded-3xl shadow-lg overflow-hidden transform transition-transform duration-500 hover:scale-105">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/main/iphone/assets/i16pm.webp" alt="iPhone 16 Pro Max" class="w-full h-full object-cover">
                </div>
                <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg hidden" id="mainQuoteDisplay">
                    <h2 class="text-3xl font-extrabold mb-2">Your Instant Quote</h2>
                    <p class="text-5xl font-extrabold" id="finalQuoteAmountMain">$0</p>
                    <p class="text-sm mt-2 opacity-80">Final offer subject to certified inspection.</p>
                </div>
            </div>

            <div class="w-full lg:w-3/5 text-center lg:text-left">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-4 sm:text-3xl">Sell Your iPhone 16 Pro Max</h1>
                <p class="text-lg text-slate-600 mb-8 max-w-xl mx-auto lg:mx-0 sm:text-base">
                    Ready to sell your iPhone 16 Pro Max? Get an instant, competitive quote for your device today.
                    We offer a quick, transparent, and hassle-free process with free shipping and certified inspection.
                </p>
                
                <!-- Main Question Container -->
                <div class="space-y-6">

                    <!-- Q1: Storage -->
                    <div class="mb-8" id="storageSection">
                        <label class="block text-xl font-bold text-slate-800 mb-4 sm:text-lg">1. Select Storage Amount</label>
                        <div class="flex justify-center lg:justify-start">
                            <select id="storage" class="mt-1 block w-full md:w-1/2 px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select Storage</option>
                                <option value="128GB">128GB</option>
                                <option value="256GB">256GB</option>
                                <option value="512GB">512GB</option>
                                <option value="1TB">1TB</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Q2: Carrier -->
                    <div class="mb-8 hidden" id="carrierSection">
                        <label class="block text-xl font-bold text-slate-800 mb-4 sm:text-lg">2. Select Your Carrier</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="carrierOptions">
                            <div class="carrier-option">
                                <input type="radio" id="att" name="carrier" value="ATT">
                                <label for="att" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-signal text-3xl text-indigo-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">AT&T</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="tmobile" name="carrier" value="TMobile">
                                <label for="tmobile" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-mobile-screen-button text-3xl text-pink-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">T-Mobile</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="verizon" name="carrier" value="Verizon">
                                <label for="verizon" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-wifi text-3xl text-red-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Verizon</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="unlocked" name="carrier" value="Unlocked">
                                <label for="unlocked" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-lock-open text-3xl text-teal-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Unlocked</span>
                                </label>
                            </div>
                            <div class="carrier-option">
                                <input type="radio" id="other-carrier" name="carrier" value="Other">
                                <label for="other-carrier" class="bg-slate-50 p-4 rounded-xl text-center hover:bg-slate-200 transition duration-200 sm:p-3">
                                    <i class="fa-solid fa-globe text-3xl text-yellow-600 mb-2 sm:text-2xl"></i>
                                    <span class="block text-slate-700 font-medium sm:text-sm">Other</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Q3: Power On -->
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="powerOnSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">3. Does the device power on?</p>
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q1Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q1_power_on" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q1_power_on" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Q4: Functional Condition -->
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="functionalSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left flex items-center justify-center lg:justify-start sm:text-base">
                            4. Is the screen fully functional and free of defects?
                        </p>
                        <div id="functionalDetails" class="mt-2 p-3 bg-blue-50 rounded-md text-sm text-blue-800 text-left sm:text-xs">
                            <p class="font-semibold mb-2">For "Fully Functional", all of these must work correctly:</p>
                            <ul class="list-disc list-inside ml-4 space-y-1">
                                <li>Screen works and fully lights up (no dead pixels, discoloration, <strong>image burn or black dot/LCD dead pixels</strong>)</li>
                                <li>All exterior buttons (power, volume, mute)</li>
                                <li>Front/back camera and flashes</li>
                                <li>Speakers and microphones</li>
                                <li>Headphone jack and charging port</li>
                                <li>Cellular, Wi-Fi, Bluetooth and GPS</li>
                                <li>Touchscreen and voice commands</li>
                                <li>Facial recognition and fingerprint sensor</li>
                                <li>The battery health is sufficient, and the device can hold a charge</li>
                            </ul>
                        </div>
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q2Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q2_fully_functional" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q2_fully_functional" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Q5: Cracks -->
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="cracksSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">5. Are the front and back free of cracks?</p>
                        <div class="flex space-x-6 justify-center lg:justify-start" id="q3Options">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q3_no_cracks" value="yes" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="q3_no_cracks" value="no" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">No</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Q6: Cosmetic Condition -->
                    <div class="p-6 rounded-lg bg-slate-50 border border-slate-200 shadow-sm question-group hidden sm:p-4" id="cosmeticSection">
                        <p class="text-lg font-semibold text-slate-700 mb-3 text-center lg:text-left sm:text-base">6. What’s the overall cosmetic condition?</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="q4Options">
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="flawless" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Flawless</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="good" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Good</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="fair" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Fair</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-300 rounded-md hover:bg-indigo-50 transition-colors duration-200 cursor-pointer sm:p-2">
                                <input type="radio" name="q4_cosmetic_condition" value="damaged" class="form-radio text-indigo-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 sm:text-sm">Damaged</span>
                            </label>
                        </div>
                        <div id="cosmeticConditionDescription" class="mt-4 p-3 bg-slate-100 rounded-md text-sm text-slate-700 text-left hidden sm:text-xs">
                        </div>
                    </div>
                </div>

                <div id="cta-section" class="flex flex-col items-center">
                    <button id="getQuoteBtn" class="btn-primary-blue w-full max-w-sm hidden">
                        Get My Instant Quote!
                    </button>
                    <div id="quoteMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full max-w-sm"></div>
                </div>

                <div id="nextSteps" class="mt-12 hidden flex flex-col items-center gap-8">
                    <div id="paymentAndShipping" class="hidden w-full">
                        <hr class="my-10 border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">4. How would you like to get paid?</h2>

                        <div class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4" id="paymentOptions">
                            <div class="payment-option">
                                <input type="radio" id="venmo" name="payment_method" value="venmo">
                                <label for="venmo" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 512 512" class="h-10 w-10 mb-2 mx-auto sm:h-8 sm:w-8" aria-label="Venmo" role="img">
                                        <rect width="512" height="512" rx="15%" fill="#3396cd"/>
                                        <path d="m381.4 105.3c11 18.1 15.9 36.7 15.9 60.3 0 75.1-64.1 172.7-116.2 241.2h-118.8l-47.6-285 104.1-9.9 25.3 202.8c23.5-38.4 52.6-98.7 52.6-139.7 0-22.5-3.9-37.8-9.9-50.4z" fill="#fff"/>
                                    </svg>
                                    <span class="font-semibold block sm:text-sm">Venmo</span>
                                </label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" id="zelle" name="payment_method" value="zelle">
                                <label for="zelle" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 48 48" class="h-10 w-10 mb-2 mx-auto sm:h-8 sm:w-8">
                                        <path fill="#a0f" d="M35,42H13c-3.866,0-7-3.134-7-7V13c0-3.866,3.134-7,7-7h22c3.866,0,7,3.134,7,7v22 C42,38.866,38.866,42,35,42z"></path><path fill="#fff" d="M17.5,18.5h14c0.552,0,1-0.448,1-1V15c0-0.552-0.448-1-1-1h-14c-0.552,0-1,0.448-1,1v2.5    C16.5,18.052,16.948,18.5,17.5,18.5z"></path><path fill="#fff" d="M17,34.5h14.5c0.552,0,1-0.448,1-1V31c0-0.552-0.448-1-1-1H17c-0.552,0-1,0.448-1,1v2.5    C16,34.052,16.448,34.5,17,34.5z"></path><path fill="#fff" d="M22.25,11v6c0,0.276,0.5,0.5,0.5,0.5h3.5c0.276,0,0.5-0.224,0.5-0.5v-6c0-0.276-0.224-0.5-0.5-0.5    h-3.5C22.474,10.5,22.25,10.724,22.25,11z"></path><path fill="#fff" d="M22.25,32v6c0,0.276,0.224,0.5,0.5,0.5h3.5c0.276,0,0.5-0.224,0.5-0.5v-6c0-0.276-0.224-0.5-0.5-0.5    h-3.5C22.474,31.5,22.25,31.724,22.25,32z"></path><path fill="#fff" d="M16.578,30.938H22l10.294-12.839c0.178-0.222,0.019-0.552-0.266-0.552H26.5L16.275,30.298    C16.065,30.553,16.247,30.938,16.578,30.938z"></path>
                                    </svg>
                                    <span class="font-semibold block sm:text-sm">Zelle</span>
                                </label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" id="paypal" name="payment_method" value="paypal">
                                <label for="paypal" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <i class="fa-brands fa-paypal text-4xl text-blue-600 mb-2 sm:text-2xl"></i>
                                    <span class="font-semibold block sm:text-sm">PayPal</span>
                                </label>
                            </div>
                        </div>

                        <div id="venmoFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                            <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">Venmo Details</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="venmoUsername" class="block text-sm font-medium text-slate-700">Venmo Username</label>
                                    <input type="text" id="venmoUsername" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="venmoUsernameConfirm" class="block text-sm font-medium text-slate-700">Verify Venmo Username</label>
                                    <input type="text" id="venmoUsernameConfirm" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>

                        <div id="zelleFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                            <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">Zelle Details</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="zelleIdentifier" class="block text-sm font-medium text-slate-700">Zelle Email or Phone Number</label>
                                    <input type="text" id="zelleIdentifier" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>

                        <div id="paypalFields" class="mb-8 p-6 bg-slate-50 rounded-lg shadow-sm hidden sm:p-4">
                            <h3 class="text-lg font-semibold text-slate-700 mb-3 sm:text-base">PayPal Details</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="paypalEmail" class="block text-sm font-medium text-slate-700">PayPal Email Address</label>
                                    <input type="email" id="paypalEmail" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-10 border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">5. How would you like to ship your device?</h2>
                        <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4" id="shippingOptions">
                            <div class="shipping-option">
                                <input type="radio" id="ship_kit" name="shipping_preference" value="ship_kit">
                                <label for="ship_kit" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <i class="fa-solid fa-box text-4xl text-indigo-600 mb-2 sm:text-2xl"></i>
                                    <span class="font-semibold block sm:text-sm">Ship Me a Box (Shipping Kit)</span>
                                    <p class="text-xs text-slate-500 mt-1">Receive a grey bag with a prepaid label and another grey bag inside to send your device to us.</p>
                                </label>
                            </div>
                            <div class="shipping-option">
                                <input type="radio" id="email_label" name="shipping_preference" value="email_label">
                                <label for="email_label" class="p-4 bg-slate-50 rounded-xl text-center hover:bg-slate-200 transition-colors duration-200 sm:p-3">
                                    <i class="fa-solid fa-envelope text-4xl text-green-600 mb-2 sm:text-2xl"></i>
                                    <span class="font-semibold block sm:text-sm">Email Me a Label (I have a box)</span>
                                    <p class="text-xs text-slate-500 mt-1">Receive a prepaid shipping label via email to print and use with your own packaging.</p>
                                </label>
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold text-slate-800 mb-6 sm:text-xl">6. Shipping Information</h2>
                        <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" id="fullName" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" id="email" autocomplete="email" placeholder="Email Address" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="street-address" class="block text-sm font-medium text-slate-700">Street Address</label>
                                <!-- The ID for this input has been changed to 'street-address' for Google Maps API -->
                                <div id="autocomplete-container">
                                    <input type="text" id="street-address" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium text-slate-700">City</label>
                                <input type="text" id="city" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-slate-700">State</label>
                                <input type="text" id="state" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                            <div>
                                <label for="zip-code" class="block text-sm font-medium text-slate-700">ZIP Code</label>
                                <input type="text" id="zip-code" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm">
                            </div>
                        </div>

                        <div id="orderOverview" class="mt-8 p-6 bg-indigo-50 rounded-xl shadow-inner sm:p-4">
                            <h3 class="text-2xl font-bold text-indigo-800 mb-4 sm:text-xl">Order Overview</h3>
                            <div class="space-y-2 text-lg text-slate-700 sm:text-base">
                                <p><span class="font-semibold">Device:</span> <span id="overviewDevice">iPhone 16 Pro Max</span></p>
                                <p><span class="font-semibold">Estimated Payout:</span> <span id="overviewQuote" class="text-indigo-600 font-bold">$0</span></p>
                                <p><span class="font-semibold">Payment Method:</span> <span id="overviewPayment">Not Selected</span></p>
                                <p><span class="font-semibold">Shipping Preference:</span> <span id="overviewShippingPreference">Not Selected</span></p>
                                <p><span class="font-semibold">Shipping Address:</span> <span id="overviewAddress">Not Entered</span></p>
                            </div>

                            <div class="mt-6 p-4 rounded-lg bg-white shadow-sm sm:p-3">
                                <label class="custom-checkbox flex items-start cursor-pointer">
                                    <input type="checkbox" id="termsAccepted">
                                    <span class="checkmark mt-1"></span>
                                    <span class="ml-4 text-sm text-slate-700 sm:text-xs">I accept the terms and conditions and certify that this device is not lost or stolen.</span>
                                </label>
                            </div>

                            <button id="sendPhoneBtn" class="btn-primary-indigo w-full mt-6">
                                Send Phone In Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="quoteModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content text-center">
            <div class="bg-red-100 text-red-800 p-3 rounded-lg mb-4 text-sm font-medium">
                Important: Devices cannot be lost, reported stolen, have an outstanding balance, or a blacklisted IMEI.
            </div>
            <h2 class="text-3xl font-extrabold text-indigo-800 mb-4 sm:text-2xl">Your Instant Quote!</h2>
            <p class="text-5xl font-extrabold text-indigo-600 mb-4 sm:text-4xl" id="finalQuoteAmountPopup">$0</p>
            <p class="text-md text-slate-600 mb-6 sm:text-sm">This is an estimate. Final offer subject to certified inspection.</p>
            <button id="quoteModalContinueBtn" class="btn-secondary-green w-full max-w-xs mx-auto">
                Continue
            </button>
        </div>
    </div>


    <div id="loginModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center sm:text-xl">Your SwiftBuyBack Account</h2>

            <div class="flex border-b border-slate-200 mb-6">
                <button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-indigo-600 hover:border-indigo-600 transition-colors duration-200 sm:text-base">Login</button>
                <button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-indigo-600 hover:border-indigo-600 transition-colors duration-200 sm:text-base">Sign Up</button>
            </div>

            <form id="loginForm" class="space-y-4">
                <p class="text-slate-600 text-center sm:text-sm">Log in to continue with your order.</p>
                <button type="button" id="googleLoginBtn" class="btn-google-style">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                    Login with Google
                </button>
                <div class="text-center text-slate-500 relative">
                    <span class="bg-white px-2 z-10 relative sm:text-sm">or</span>
                    <hr class="absolute inset-0 top-1/2 border-slate-200 -z-10">
                </div>
                <div>
                    <label for="loginEmail" class="sr-only">Email Address</label>
                    <input type="email" id="loginEmail" autocomplete="email" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm">
                </div>
                <div>
                    <label for="loginPassword" class="sr-only">Password</label>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm" autocomplete="current-password">
                </div>
                <button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button>
                <p class="text-center text-sm text-slate-600 sm:text-xs">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-indigo-600 font-semibold hover:underline">Reset it here</a></p>
            </form>

            <form id="signupForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center sm:text-sm">Create an account to complete your order.</p>
                <button type="button" id="googleSignupBtn" class="btn-google-style">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                    Sign Up with Google
                </button>
                <div class="text-center text-slate-500 relative">
                    <span class="bg-white px-2 z-10 relative sm:text-sm">or</span>
                    <hr class="absolute inset-0 top-1/2 border-slate-200 -z-10">
                </div>
                <div>
                    <label for="signupName" class="sr-only">Full Name</label>
                    <input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm">
                </div>
                <div>
                    <label for="signupEmail" class="sr-only">Email Address</label>
                    <input type="email" id="signupEmail" autocomplete="email" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm">
                </div>
                <div>
                    <label for="signupPassword" class="sr-only">Password</label>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm" autocomplete="new-password">
                </div>
                <div>
                    <label for="signupPhone" class="sr-only">Phone Number (Optional)</label>
                    <input type="tel" id="signupPhone" placeholder="Phone Number (Optional)" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm">
                </div>
                <button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button>
                <p class="text-center text-sm text-slate-600 sm:text-xs">Already have an account? <a href="#" id="switchToLogin" class="text-indigo-600 font-semibold hover:underline">Log in here</a></p>
            </form>

            <form id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center sm:text-sm">Enter your email address to receive a password reset link.</p>
                <div>
                    <label for="forgotEmail" class="sr-only">Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:p-2 sm:text-sm">
                </div>
                <button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button>
                <p class="text-center text-sm text-slate-600 sm:text-xs">Remember your password? <a href="#" id="returnToLogin" class="text-indigo-600 font-semibold hover:underline">Return to Login</a></p>
            </form>
            <div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full sm:text-xs"></div>
        </div>
    </div>

    <footer class="bg-slate-800 text-white py-12 mt-8 w-full">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div>
                <h3 class="text-xl font-bold mb-4 sm:text-lg">SwiftBuyBack</h3>
                <p class="text-slate-400 sm:text-sm">Your trusted partner for selling used smartphones. Quick quotes, fair prices, and hassle-free service.</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4 sm:text-lg">Quick Links</h3>
                <ul class="space-y-2">
                    <li><a href="https://secondhandcell.com/index.html" class="text-slate-400 hover:text-white transition duration-300 sm:text-sm">Home</a></li>
                    <li><a href="https://secondhandcell.com/sell-device.html" class="text-slate-400 hover:text-white transition duration-300 sm:text-sm">Sell Your Phone</a></li>
                    <li><a href="https://secondhandcell.com/my-account.html" class="text-slate-400 hover:text-white transition duration-300 sm:text-sm">My Account</a></li>
                    <li><a href="https://secondhandcell.com/about-us.html" class="text-slate-400 hover:text-white transition duration-300 sm:text-sm">About Us</a></li>
                    <li><a href="https://secondhandcell.com/contact.html" class="text-slate-400 hover:text-white transition duration-300 sm:text-sm">Contact</a></li>
                </ul>
            </div>
            <div class="md:col-span-2 lg:col-span-1">
                <h3 class="text-xl font-bold mb-4 sm:text-lg">Contact Us</h3>
                <p class="text-slate-400 sm:text-sm">Email: info@swiftbuyback.com</p>
                <p class="text-slate-400 sm:text-sm">Phone: (123) 456-7890</p>
                <p class="text-slate-400 mt-4 sm:text-sm">&copy; 2025 SwiftBuyBack. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Callback function for Google Maps API. It's called after the API script loads.
        function initAutocomplete() {
            // New way to use Place Autocomplete
            const container = document.getElementById('autocomplete-container');
            const placeAutocomplete = new google.maps.places.PlaceAutocompleteElement();
            placeAutocomplete.placeholder = "Enter your address";
            placeAutocomplete.input.className = "mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2 sm:text-sm";
            placeAutocomplete.input.id = "street-address";
            container.appendChild(placeAutocomplete);

            // Add an event listener to populate the other fields when a place is selected
            placeAutocomplete.addEventListener('placechange', () => {
                const place = placeAutocomplete.getPlace();
                if (!place || !place.addressComponents) return;

                const streetAddressInput = document.getElementById('street-address');
                const cityInput = document.getElementById('city');
                const stateInput = document.getElementById('state');
                const zipCodeInput = document.getElementById('zip-code');

                let streetNumber = '';
                let streetName = '';
                let city = '';
                let state = '';
                let zipCode = '';

                for (const component of place.addressComponents) {
                    const componentType = component.types[0];
                    switch (componentType) {
                        case 'street_number':
                            streetNumber = component.longText;
                            break;
                        case 'route':
                            streetName = component.longText;
                            break;
                        case 'locality':
                            city = component.longText;
                            break;
                        case 'administrative_area_level_1':
                            state = component.shortText;
                            break;
                        case 'postal_code':
                            zipCode = component.longText;
                            break;
                    }
                }
                
                streetAddressInput.value = `${streetNumber} ${streetName}`.trim();
                cityInput.value = city;
                stateInput.value = state;
                zipCodeInput.value = zipCode;

                // Manually trigger an input event to update the order overview
                const event = new Event('input', { bubbles: true });
                streetAddressInput.dispatchEvent(event);
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            const auth = window.firebaseAuth;
            const GoogleAuthProvider = window.GoogleAuthProvider;
            const signInWithPopup = window.signInWithPopup;
            const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
            const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
            const signOut = window.signOut;
            const onAuthStateChanged = window.onAuthStateChanged;
            const updateProfile = window.updateProfile;
            const sendPasswordResetEmail = window.sendPasswordResetEmail;
            const db = window.firebaseDb;
            const serverTimestamp = window.firebaseServerTimestamp;

            const getQuoteBtn = document.getElementById('getQuoteBtn');
            const quoteMessage = document.getElementById('quoteMessage');
            const nextSteps = document.getElementById('nextSteps');
            const finalQuoteAmountMain = document.getElementById('mainQuoteDisplay');
            const finalQuoteAmountMainText = document.getElementById('finalQuoteAmountMain');
            const finalQuoteAmountPopup = document.getElementById('finalQuoteAmountPopup');
            const paymentAndShipping = document.getElementById('paymentAndShipping');
            const venmoFields = document.getElementById('venmoFields');
            const zelleFields = document.getElementById('zelleFields');
            const paypalFields = document.getElementById('paypalFields');
            const shippingOptions = document.getElementById('shippingOptions');
            const overviewShippingPreference = document.getElementById('overviewShippingPreference');
            const orderOverview = document.getElementById('orderOverview');
            const overviewQuote = document.getElementById('overviewQuote');
            const overviewPayment = document.getElementById('overviewPayment');
            const overviewAddress = document.getElementById('overviewAddress');
            const sendPhoneBtn = document.getElementById('sendPhoneBtn');
            const loginModal = document.getElementById('loginModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const signupTabBtn = document.getElementById('signupTabBtn');
            const loginNavBtn = document.getElementById('loginNavBtn');
            const quoteModal = document.getElementById('quoteModal');
            const quoteModalContinueBtn = document.getElementById('quoteModalContinueBtn');
            const authStatusContainer = document.getElementById('authStatusContainer');
            const userMonogram = document.getElementById('userMonogram');
            const authDropdown = document.getElementById('authDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const functionalDetails = document.getElementById('functionalDetails');
            const cosmeticConditionDescription = document.getElementById('cosmeticConditionDescription');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const emailSignupBtn = document.getElementById('emailSignupBtn');
            const signupNameInput = document.getElementById('signupName');
            const signupEmailInput = document.getElementById('signupEmail');
            const signupPasswordInput = document.getElementById('signupPassword');
            const signupPhoneInput = document.getElementById('signupPhone');
            const authMessage = document.getElementById('authMessage');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const switchToLogin = document.getElementById('switchToLogin');
            
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const forgotEmailInput = document.getElementById('forgotEmail');
            const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
            const returnToLoginLink = document.getElementById('returnToLogin');

            const shippingInfoEmailInput = document.getElementById('email');

            const streetAddressInput = document.getElementById('street-address');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipCodeInput = document.getElementById('zip-code');
            
            let isUserLoggedIn = false;
            let currentUserId = null;
            let finalQuote = 0;

            function getRandomLightColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = Math.floor(Math.random() * 30) + 70;
                const lightness = Math.floor(Math.random() * 20) + 70;
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isUserLoggedIn = true;
                    currentUserId = user.uid;
                    console.log("User is logged in:", user.uid);
                    loginNavBtn.classList.add('hidden');
                    userMonogram.classList.remove('hidden');

                    const displayName = user.displayName;
                    const email = user.email;
                    let initials = '';

                    if (displayName) {
                        initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    } else if (email) {
                        const username = email.split('@')[0];
                        const nameParts = username.split('.');
                        initials = nameParts.map(part => part.charAt(0)).join('').toUpperCase().substring(0, 2);
                    }

                    userMonogram.textContent = initials;
                    userMonogram.style.backgroundColor = getRandomLightColor();

                    hideLoginModal();

                    if (shippingInfoEmailInput && user.email) {
                        shippingInfoEmailInput.value = user.email;
                    }

                    if (finalQuote > 0 && nextSteps.classList.contains('hidden')) {
                        nextSteps.classList.remove('hidden');
                        paymentAndShipping.classList.remove('hidden');
                        updateOverview();
                    }
                } else {
                    isUserLoggedIn = false;
                    currentUserId = null;
                    console.log("User is logged out.");
                    loginNavBtn.classList.remove('hidden');
                    loginNavBtn.textContent = 'Login/Sign Up';
                    userMonogram.classList.add('hidden');
                    userMonogram.textContent = '';
                    authDropdown.classList.add('hidden');

                    if (shippingInfoEmailInput) {
                        shippingInfoEmailInput.value = '';
                    }
                }
            });
            userMonogram.addEventListener('click', (e) => {
                e.stopPropagation();
                authDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!authStatusContainer.contains(e.target)) {
                    authDropdown.classList.add('hidden');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });

            const BACKEND_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

            function showAuthMessage(msg, type) {
                authMessage.textContent = msg;
                authMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    authMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    authMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    authMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                authMessage.classList.remove('hidden');
            }

            function clearAuthMessage() {
                authMessage.classList.add('hidden');
                authMessage.textContent = '';
            }

            function showLoginModal() {
                loginModal.classList.add('is-visible');
                clearAuthMessage();
                showTab('login');
            }

            function hideLoginModal() {
                loginModal.classList.remove('is-visible');
            }

            function showTab(tabName) {
                clearAuthMessage();
                loginTabBtn.classList.remove('border-indigo-600', 'text-indigo-600');
                signupTabBtn.classList.remove('border-indigo-600', 'text-indigo-600');
                loginTabBtn.classList.add('border-transparent', 'text-slate-500');
                signupTabBtn.classList.add('border-transparent', 'text-slate-500');
                loginTabBtn.classList.remove('hidden');
                signupTabBtn.classList.remove('hidden');

                if (tabName === 'login') {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    loginTabBtn.classList.add('border-indigo-600', 'text-indigo-600');
                } else if (tabName === 'signup') {
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    forgotPasswordForm.classList.add('hidden');
                    signupTabBtn.classList.add('border-indigo-600', 'text-indigo-600');
                } else if (tabName === 'forgotPassword') {
                    forgotPasswordForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    signupForm.classList.add('hidden');
                    loginTabBtn.classList.add('hidden');
                    signupTabBtn.classList.add('hidden');
                }
            }

            function showQuotePopup() {
                quoteModal.classList.add('is-visible');
            }

            function hideQuotePopup() {
                quoteModal.classList.remove('is-visible');
            }

            closeModalBtn.addEventListener('click', hideLoginModal);
            loginModal.addEventListener('click', (e) => {
                if (e.target.id === 'loginModal') {
                    hideLoginModal();
                }
            });
            loginTabBtn.addEventListener('click', () => {
                showTab('login');
            });
            signupTabBtn.addEventListener('click', () => {
                showTab('signup');
            });
            loginNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showLoginModal();
            });
            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            returnToLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('login');
            });
            
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('forgotPassword');
            });

            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotEmailInput.value;
                if (!email) {
                    showAuthMessage('Please enter your email address.', 'error');
                    return;
                }
                
                try {
                    clearAuthMessage();
                    showAuthMessage('Sending password reset email...', 'info');
                    await sendPasswordResetEmail(auth, email);
                    showAuthMessage('A password reset link has been sent to your email. Check your inbox and spam folder.', 'success');
                    forgotEmailInput.value = '';
                } catch (error) {
                    console.error("Password reset error:", error);
                    showAuthMessage(`Password reset failed: ${error.message}`, 'error');
                }
            });

            quoteModalContinueBtn.addEventListener('click', () => {
                hideQuotePopup();
                finalQuoteAmountMain.classList.remove('hidden');
                if (isUserLoggedIn) {
                    nextSteps.classList.remove('hidden');
                    paymentAndShipping.classList.remove('hidden');
                    updateOverview();
                } else {
                    showLoginModal();
                }
            });

            const googleProvider = new GoogleAuthProvider();

            googleLoginBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing in with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google login error:", error);
                    showAuthMessage(`Google login failed: ${error.message}`, 'error');
                }
            });

            googleSignupBtn.addEventListener('click', async () => {
                try {
                    clearAuthMessage();
                    showAuthMessage('Signing up with Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Google signup error:", error);
                    showAuthMessage(`Google signup failed: ${error.message}`, 'error');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                if (!email || !password) {
                    showAuthMessage('Please enter both email and password.', 'error');
                    return;
                }
                try {
                    clearAuthMessage();
                    showAuthMessage('Logging in...', 'info');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Email login error:", error);
                    showAuthMessage(`Login failed: ${error.message}`, 'error');
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = signupNameInput.value;
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;
                const phone = signupPhoneInput.value;

                if (!name || !email || !password) {
                    showAuthMessage('Please enter your name, email, and password.', 'error');
                    return;
                }
                if (password.length < 6) {
                    showAuthMessage('Password should be at least 6 characters.', 'error');
                    return;
                }

                try {
                    clearAuthMessage();
                    showAuthMessage('Creating account...', 'info');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, {
                        displayName: name
                    });
                    showAuthMessage('Account created successfully! You are now logged in.', 'success');
                } catch (error) {
                    console.error("Email signup error:", error);
                    showAuthMessage(`Sign up failed: ${error.message}`, 'error');
                }
            });


            function showQuoteMessage(msg, type) {
                quoteMessage.textContent = msg;
                quoteMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                if (type === 'error') {
                    quoteMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    quoteMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'info') {
                    quoteMessage.classList.add('bg-blue-100', 'text-blue-700');
                }
                quoteMessage.classList.remove('hidden');
            }

            function clearQuoteMessage() {
                quoteMessage.classList.add('hidden');
                quoteMessage.textContent = '';
            }

            function clearHighlights() {
                document.querySelectorAll('.highlight-missing').forEach(el => {
                    el.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.carrier-option label, .payment-option label, .shipping-option label').forEach(label => {
                    label.classList.remove('highlight-missing');
                });
                document.querySelectorAll('.custom-checkbox .checkmark').forEach(checkmark => {
                    checkmark.classList.remove('highlight-missing');
                });
            }

            const cosmeticDescriptions = {
                'flawless': 'Looks new with no signs of use. This is the best condition a used device can be in. There are no scratches, scuffs, or any other cosmetic imperfections visible to the naked eye. The device appears as if it just came out of its original packaging, offering a pristine aesthetic and feel.',
                'good': 'There may be a few light scuffs or scratches that are smaller than the size of a pencil eraser. These minor imperfections are typically on the casing or screen, but do not affect the device\'s functionality or overall aesthetic significantly. They are generally only noticeable upon close inspection and do not detract from the device\'s premium feel.',
                'fair': 'There are noticeable scratches or scuffs on the front and back. These could include multiple visible scratches, minor dents, or paint chips on the frame. While these cosmetic issues are more prominent, they do not impede the device\'s core functions, and the screen remains fully usable despite the marks.',
                'damaged': 'Major cosmetic damage includes being bent, chipped, dented, or sunbleached. This category also covers devices with significant wear and tear, deep scratches, or other substantial visual defects that clearly impact the device\'s appearance. These issues are immediately apparent and go beyond normal wear, affecting the overall integrity and look of the device.'
            };

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedCondition = event.target.value;
                    const description = cosmeticDescriptions[selectedCondition];
                    if (description) {
                        cosmeticConditionDescription.textContent = description;
                        cosmeticConditionDescription.classList.remove('hidden');
                    } else {
                        cosmeticConditionDescription.classList.add('hidden');
                        cosmeticConditionDescription.textContent = '';
                    }
                });
            });

            const carrierSection = document.getElementById('carrierSection');
            const powerOnSection = document.getElementById('powerOnSection');
            const functionalSection = document.getElementById('functionalSection');
            const cracksSection = document.getElementById('cracksSection');
            const cosmeticSection = document.getElementById('cosmeticSection');
            
            function hideAllQuestions() {
                [carrierSection, powerOnSection, functionalSection, cracksSection, cosmeticSection, getQuoteBtn].forEach(el => {
                    el.classList.add('hidden');
                });
                clearQuoteMessage();
                finalQuoteAmountMain.classList.add('hidden');
                nextSteps.classList.add('hidden');
            }
            
            hideAllQuestions();

            document.getElementById('storage').addEventListener('change', function() {
                if (this.value) {
                    carrierSection.classList.remove('hidden');
                    [powerOnSection, functionalSection, cracksSection, cosmeticSection, getQuoteBtn].forEach(el => el.classList.add('hidden'));
                    clearQuoteMessage();
                    this.classList.remove('highlight-missing');
                    saveFormState();
                } else {
                    hideAllQuestions();
                }
            });
            
            document.querySelectorAll('input[name="carrier"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    powerOnSection.classList.remove('hidden');
                    [functionalSection, cracksSection, cosmeticSection, getQuoteBtn].forEach(el => el.classList.add('hidden'));
                    clearQuoteMessage();
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q1_power_on"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        functionalSection.classList.remove('hidden');
                        cracksSection.classList.add('hidden');
                        cosmeticSection.classList.add('hidden');
                        getQuoteBtn.classList.add('hidden');
                        clearQuoteMessage();
                    } else {
                        functionalSection.classList.add('hidden');
                        cracksSection.classList.add('hidden');
                        cosmeticSection.classList.add('hidden');
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q2_fully_functional"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cracksSection.classList.remove('hidden');
                        cosmeticSection.classList.add('hidden');
                        getQuoteBtn.classList.add('hidden');
                        clearQuoteMessage();
                    } else {
                        cracksSection.classList.add('hidden');
                        cosmeticSection.classList.add('hidden');
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });
            
            document.querySelectorAll('input[name="q3_no_cracks"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'yes') {
                        cosmeticSection.classList.remove('hidden');
                        getQuoteBtn.classList.add('hidden');
                        clearQuoteMessage();
                    } else {
                        cosmeticSection.classList.add('hidden');
                        getQuoteBtn.classList.remove('hidden');
                    }
                    saveFormState();
                });
            });

            document.querySelectorAll('input[name="q4_cosmetic_condition"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    getQuoteBtn.classList.remove('hidden');
                    clearQuoteMessage();
                    saveFormState();
                });
            });
            
            function calculateQuoteAndDisplay() {
                clearQuoteMessage();
                
                const selectedStorage = document.getElementById('storage').value;
                const selectedCarrier = document.querySelector('input[name="carrier"]:checked')?.value;
                const q1PowerOn = document.querySelector('input[name="q1_power_on"]:checked')?.value;
                const q2Functional = document.querySelector('input[name="q2_fully_functional"]:checked')?.value;
                const q3NoCracks = document.querySelector('input[name="q3_no_cracks"]:checked')?.value;
                const q4Cosmetic = document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value;

                if (!selectedStorage || !selectedCarrier || !q1PowerOn) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                if (q1PowerOn === 'yes' && !q2Functional) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                if (q1PowerOn === 'yes' && q2Functional === 'yes' && !q3NoCracks) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                if (q1PowerOn === 'yes' && q2Functional === 'yes' && q3NoCracks === 'yes' && !q4Cosmetic) {
                    showQuoteMessage('Please answer all visible questions to get a quote.', 'error');
                    return;
                }

                let currentQuote = 0;
                switch (selectedStorage) {
                    case '128GB': currentQuote = 400; break;
                    case '256GB': currentQuote = 500; break;
                    case '512GB': currentQuote = 600; break;
                    case '1TB': currentQuote = 800; break;
                    default: showQuoteMessage('Invalid storage selected.', 'error'); return;
                }

                if (selectedCarrier !== 'Unlocked') { currentQuote -= 25; }
                
                if (q1PowerOn === 'no') { 
                    currentQuote *= 0.50; 
                } else {
                    if (q2Functional === 'no') { 
                        currentQuote *= 0.75; 
                    } else {
                        if (q3NoCracks === 'no') { 
                            currentQuote -= 50; 
                        } else if (q3NoCracks === 'yes') {
                            switch (q4Cosmetic) {
                                case 'damaged': currentQuote -= 45; break;
                                case 'fair': currentQuote -= 25; break;
                                case 'good': currentQuote -= 15; break;
                            }
                        }
                    }
                }

                finalQuote = Math.max(0, currentQuote);
                finalQuoteAmountMainText.textContent = `$${finalQuote.toFixed(2)}`;
                finalQuoteAmountPopup.textContent = `$${finalQuote.toFixed(2)}`;

                showQuotePopup();
            }

            getQuoteBtn.addEventListener('click', calculateQuoteAndDisplay);


            document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    venmoFields.classList.add('hidden');
                    zelleFields.classList.add('hidden');
                    paypalFields.classList.add('hidden');

                    document.querySelectorAll('.payment-option label').forEach(label => label.classList.remove('highlight-missing'));

                    const selectedMethod = e.target.value;
                    if (selectedMethod === 'venmo') {
                        venmoFields.classList.remove('hidden');
                    } else if (selectedMethod === 'zelle') {
                        zelleFields.classList.remove('hidden');
                    } else if (selectedMethod === 'paypal') {
                        paypalFields.classList.remove('hidden');
                    }
                    updateOverview();
                });
            });

            document.querySelectorAll('input[name="shipping_preference"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.shipping-option label').forEach(label => label.classList.remove('highlight-missing'));
                    updateOverview();
                });
            });

            const shippingInputs = document.querySelectorAll('#paymentAndShipping input');
            shippingInputs.forEach(input => {
                input.addEventListener('input', updateOverview);
            });

            function updateOverview() {
                const selectedPayment = document.querySelector('input[name="payment_method"]:checked')?.value || 'Not Selected';
                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked')?.value;
                
                let displayShippingPreferenceText = 'Not Selected';
                if (selectedShippingPreference === 'ship_kit') {
                    displayShippingPreferenceText = 'Shipping Kit Requested';
                } else if (selectedShippingPreference === 'email_label') {
                    displayShippingPreferenceText = 'Email Label Requested';
                }

                const fullName = document.getElementById('fullName').value;
                const streetAddress = streetAddressInput.value;
                const city = cityInput.value;
                const state = stateInput.value;
                const zipCode = zipCodeInput.value;

                overviewQuote.textContent = `$${finalQuote.toFixed(2)}`;
                overviewPayment.textContent = selectedPayment.charAt(0).toUpperCase() + selectedPayment.slice(1);
                overviewShippingPreference.textContent = displayShippingPreferenceText;

                const fullAddress = [fullName, streetAddress, city, state, zipCode].filter(Boolean).join(', ');
                overviewAddress.textContent = fullAddress || 'Not Entered';
            }

            sendPhoneBtn.addEventListener('click', async () => {
                clearQuoteMessage();
                clearHighlights();

                const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                const selectedShippingPreference = document.querySelector('input[name="shipping_preference"]:checked');
                const termsAccepted = document.getElementById('termsAccepted');
                const fullName = document.getElementById('fullName');
                const email = document.getElementById('email');

                let firstMissingElement = null;

                if (!selectedPayment) {
                    const paymentOptionsContainer = document.getElementById('paymentOptions');
                    if (paymentOptionsContainer) {
                        paymentOptionsContainer.classList.add('highlight-missing');
                        if (!firstMissingElement) firstMissingElement = paymentOptionsContainer;
                    }
                } else {
                    if (selectedPayment.value === 'venmo') {
                        const venmoUsername = document.getElementById('venmoUsername');
                        const venmoUsernameConfirm = document.getElementById('venmoUsernameConfirm');
                        if (!venmoUsername.value) { venmoUsername.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = venmoUsername; }
                        if (!venmoUsernameConfirm.value || venmoUsername.value !== venmoUsernameConfirm.value) { venmoUsernameConfirm.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = venmoUsernameConfirm; }
                    } else if (selectedPayment.value === 'zelle') {
                        const zelleIdentifier = document.getElementById('zelleIdentifier');
                        if (!zelleIdentifier.value) { zelleIdentifier.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zelleIdentifier; }
                    } else if (selectedPayment.value === 'paypal') {
                        const paypalEmail = document.getElementById('paypalEmail');
                        if (!paypalEmail.value) { paypalEmail.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = paypalEmail; }
                    }
                }

                if (!selectedShippingPreference) {
                    const shippingOptionsContainer = document.getElementById('shippingOptions');
                    if (shippingOptionsContainer) {
                        shippingOptionsContainer.classList.add('highlight-missing');
                        if (!firstMissingElement) firstMissingElement = shippingOptionsContainer;
                    }
                }

                if (!fullName.value) { fullName.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = fullName; }
                if (!email.value) { email.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = email; }
                if (!streetAddressInput.value) { streetAddressInput.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = streetAddressInput; }
                if (!cityInput.value) { cityInput.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = cityInput; }
                if (!stateInput.value) { stateInput.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = stateInput; }
                if (!zipCodeInput.value) { zipCodeInput.classList.add('highlight-missing'); if (!firstMissingElement) firstMissingElement = zipCodeInput; }
                if (!termsAccepted.checked) {
                    document.querySelector('#orderOverview .checkmark').classList.add('highlight-missing');
                    if (!firstMissingElement) firstMissingElement = termsAccepted;
                }

                if (firstMissingElement) {
                    showQuoteMessage('Please fill out all required fields to proceed.', 'error');
                    firstMissingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                sendPhoneBtn.disabled = true;
                sendPhoneBtn.textContent = 'Order Submitting...';
                sendPhoneBtn.classList.remove('btn-primary-indigo');
                sendPhoneBtn.classList.add('btn-disabled');

                const orderData = {
                    device: "iPhone 16 Pro Max",
                    carrier: document.querySelector('input[name="carrier"]:checked').value,
                    storage: document.getElementById('storage').value,
                    condition_power_on: document.querySelector('input[name="q1_power_on"]:checked').value,
                    condition_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value || 'N/A',
                    condition_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value || 'N/A',
                    condition_cosmetic: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value || 'N/A',
                    estimatedQuote: finalQuote,
                    paymentMethod: selectedPayment.value,
                    shippingPreference: selectedShippingPreference.value === 'ship_kit' ? 'Shipping Kit Requested' : 'Email Label Requested',
                    paymentDetails: {},
                    shippingInfo: {
                        fullName: fullName.value,
                        email: email.value,
                        streetAddress: streetAddressInput.value,
                        city: cityInput.value,
                        state: stateInput.value,
                        zipCode: zipCodeInput.value
                    },
                    termsAccepted: termsAccepted.checked,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                };

                if (selectedPayment.value === 'venmo') {
                    orderData.paymentDetails.venmoUsername = document.getElementById('venmoUsername').value;
                } else if (selectedPayment.value === 'zelle') {
                    orderData.paymentDetails.zelleIdentifier = document.getElementById('zelleIdentifier').value;
                } else if (selectedPayment.value === 'paypal') {
                    orderData.paymentDetails.paypalEmail = document.getElementById('paypalEmail').value;
                }

                try {
                    showQuoteMessage('Submitting your order...', 'info');
                    const response = await fetch(`${BACKEND_URL}/submit-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to submit order.');
                    }
                    
                    setTimeout(() => {
                        window.location.href = `https://secondhandcell.com/order-submitted.html?shipping=${selectedShippingPreference.value}`;
                    }, 2000);
                    
                } catch (e) {
                    console.error("Error submitting order: ", e);
                    showQuoteMessage('There was an error submitting your order. Please try again.', 'error');
                    
                    sendPhoneBtn.disabled = false;
                    sendPhoneBtn.textContent = 'Send Phone In Now';
                    sendPhoneBtn.classList.remove('btn-disabled');
                    sendPhoneBtn.classList.add('btn-primary-indigo');
                }
            });

            function saveFormState() {
                const formState = {
                    storage: document.getElementById('storage').value,
                    carrier: document.querySelector('input[name="carrier"]:checked')?.value,
                    q1_power_on: document.querySelector('input[name="q1_power_on"]:checked')?.value,
                    q2_fully_functional: document.querySelector('input[name="q2_fully_functional"]:checked')?.value,
                    q3_no_cracks: document.querySelector('input[name="q3_no_cracks"]:checked')?.value,
                    q4_cosmetic_condition: document.querySelector('input[name="q4_cosmetic_condition"]:checked')?.value,
                };
                localStorage.setItem('iphone16ProMaxFormState', JSON.stringify(formState));
            }

            function loadFormState() {
                const savedState = localStorage.getItem('iphone16ProMaxFormState');
                if (savedState) {
                    const formState = JSON.parse(savedState);

                    document.getElementById('storage').value = formState.storage || '';
                    if (formState.storage) {
                        carrierSection.classList.remove('hidden');
                    }

                    if (formState.carrier) {
                        const carrierRadio = document.querySelector(`input[name="carrier"][value="${formState.carrier}"]`);
                        if (carrierRadio) {
                            carrierRadio.checked = true;
                            powerOnSection.classList.remove('hidden');
                        }
                    }

                    if (formState.q1_power_on) {
                        const powerOnRadio = document.querySelector(`input[name="q1_power_on"][value="${formState.q1_power_on}"]`);
                        if (powerOnRadio) {
                            powerOnRadio.checked = true;
                            if (formState.q1_power_on === 'yes') {
                                functionalSection.classList.remove('hidden');
                            } else {
                                getQuoteBtn.classList.remove('hidden');
                            }
                        }
                    }

                    if (formState.q2_fully_functional) {
                        const functionalRadio = document.querySelector(`input[name="q2_fully_functional"][value="${formState.q2_fully_functional}"]`);
                        if (functionalRadio) {
                            functionalRadio.checked = true;
                            if (formState.q2_fully_functional === 'yes') {
                                cracksSection.classList.remove('hidden');
                            } else {
                                getQuoteBtn.classList.remove('hidden');
                            }
                        }
                    }

                    if (formState.q3_no_cracks) {
                        const cracksRadio = document.querySelector(`input[name="q3_no_cracks"][value="${formState.q3_no_cracks}"]`);
                        if (cracksRadio) {
                            cracksRadio.checked = true;
                            if (formState.q3_no_cracks === 'yes') {
                                cosmeticSection.classList.remove('hidden');
                            } else {
                                getQuoteBtn.classList.remove('hidden');
                            }
                        }
                    }

                    if (formState.q4_cosmetic_condition) {
                        const cosmeticRadio = document.querySelector(`input[name="q4_cosmetic_condition"][value="${formState.q4_cosmetic_condition}"]`);
                        if (cosmeticRadio) {
                            cosmeticRadio.checked = true;
                            cosmeticConditionDescription.textContent = cosmeticDescriptions[formState.q4_cosmetic_condition];
                            cosmeticConditionDescription.classList.remove('hidden');
                            getQuoteBtn.classList.remove('hidden');
                        }
                    }
                }
            }

            loadFormState();
        });
    </script>
</body>
</html>
