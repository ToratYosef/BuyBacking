<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Chat Dashboard - SecondHandCell</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #eef2f5; } /* Lighter track */
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .chat-bubble-user { background-color: #f1f5f9; color: #1e293b; } /* Lighter gray for user */
        .chat-bubble-admin { background-color: #3b82f6; color: #ffffff; } /* Solid blue for admin */
        .chat-bubble-system { background-color: #fef08a; color: #a16207; } /* Yellow for system */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .tab-btn.active { border-color: #2563eb; color: #2563eb; font-weight: 600; }
        .notification-item { padding: 12px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background-color 0.2s; }
        .notification-item:hover { background-color: #f8fafc; }
        .notification-item.unread { background-color: #eff6ff; font-weight: 500; }
        .notification-item p:first-child { font-weight: 600; } /* Bold title */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-xl">
            <div class="text-center">
                <h2 class="text-4xl font-extrabold text-slate-900">Admin Login</h2>
                <p class="mt-2 text-sm text-slate-500">Access the SecondHandCell Dashboard</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="sr-only">Email</label>
                    <input type="email" id="login-email" required class="w-full px-5 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Email Address">
                </div>
                <div>
                    <label for="login-password" class="sr-only">Password</label>
                    <input type="password" id="login-password" required class="w-full px-5 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Password">
                </div>
                <button type="submit" class="w-full px-4 py-3 font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 transition-colors shadow-lg transform hover:scale-[1.01]">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>Login
                </button>
                <p id="login-error" class="text-sm text-center text-red-500 h-4"></p>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-screen" class="hidden h-screen w-screen flex-col md:flex-row overflow-hidden">
        <!-- Left Sidebar: Chat Queue -->
        <aside class="w-full md:w-[400px] bg-white border-r border-slate-200 flex flex-col h-full shadow-lg">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900">Live Chats</h2>
                <div class="flex items-center gap-4">
                    <!-- Notification Bell -->
                    <div class="relative">
                        <button id="notification-bell" class="text-slate-500 hover:text-blue-600 relative transition-colors">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="absolute top-full right-0 mt-3 w-80 bg-white rounded-xl shadow-2xl border border-slate-200 hidden z-20 overflow-hidden">
                            <div class="p-4 font-bold text-slate-800 border-b border-slate-200">Notifications</div>
                            <div id="notification-list" class="max-h-72 overflow-y-auto custom-scrollbar">
                                <div class="p-4 text-sm text-slate-500">No new notifications.</div>
                            </div>
                            <div class="p-3 border-t text-center bg-slate-50">
                                <button id="mark-all-read-btn" class="text-sm font-semibold text-blue-600 hover:underline disabled:text-slate-400" disabled>Mark all as read</button>
                            </div>
                        </div>
                    </div>
                    <button id="logout-btn" class="px-3 py-1 text-sm text-slate-600 hover:text-red-500 font-semibold flex items-center gap-2 transition-colors">Logout <i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
            <!-- TABS -->
            <div class="p-3 border-b border-slate-200 bg-slate-100">
                <div class="grid grid-cols-3 gap-2">
                    <button class="tab-btn p-3 text-center text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent transition-all active" data-tab="open">Open</button>
                    <button class="tab-btn p-3 text-center text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent" data-tab="my">My Chats</button>
                    <button class="tab-btn p-3 text-center text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent" data-tab="closed">Closed</button>
                </div>
            </div>
            <!-- CHAT LISTS -->
            <div class="flex-1 relative">
                <div id="open-chats-list" class="absolute inset-0 overflow-y-auto custom-scrollbar"></div>
                <div id="my-chats-list" class="absolute inset-0 overflow-y-auto custom-scrollbar hidden"></div>
                <div id="closed-chats-list" class="absolute inset-0 overflow-y-auto custom-scrollbar hidden"></div>
            </div>
            <!-- MULTI-SELECT ACTIONS -->
            <div id="multi-select-actions" class="p-4 border-t border-slate-200 bg-slate-100 hidden">
                <div class="grid grid-cols-2 gap-3">
                    <button id="assign-selected-btn" class="px-4 py-3 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition-colors">Assign to Me</button>
                    <button id="delete-selected-btn" class="px-4 py-3 text-sm font-bold text-white bg-red-500 rounded-lg hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed transition-colors">Delete Selected</button>
                </div>
            </div>
        </aside>

        <!-- Right Section: Active Chat View -->
        <main id="chat-view" class="flex-1 flex-col bg-slate-50 hidden md:flex h-full">
            <div id="no-chat-selected" class="flex flex-col items-center justify-center h-full text-slate-400">
                <i class="fa-solid fa-comment-dots text-8xl mb-6"></i>
                <p class="text-2xl font-bold">Select a chat to begin</p>
                <p class="mt-2 text-md">New chats will appear in the queue.</p>
            </div>

            <div id="active-chat-container" class="hidden h-full flex-col">
                <div class="p-5 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                         <button id="back-to-list-btn" class="text-slate-600 hover:text-blue-600 md:hidden"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                         <div>
                            <h3 id="active-chat-user" class="font-bold text-slate-900 text-lg"></h3>
                            <p id="active-chat-id" class="text-xs text-slate-500"></p>
                         </div>
                    </div>
                    <div class="flex items-center gap-3 sm:gap-4">
                        <div class="relative">
                            <button id="transfer-chat-btn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-right-left"></i> <span class="hidden sm:inline">Transfer</span>
                            </button>
                            <div id="transfer-dropdown" class="absolute bottom-full right-0 mb-2 w-64 bg-white rounded-xl shadow-2xl border hidden z-10 overflow-hidden"></div>
                        </div>
                        <button id="view-orders-btn" class="px-4 py-2 text-sm font-semibold text-white bg-slate-600 rounded-full hover:bg-slate-700 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-box-open"></i> <span class="hidden sm:inline">View Orders</span>
                        </button>
                        <button id="end-chat-btn" class="px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-full hover:bg-red-600 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-flag-checkered"></i> <span class="hidden sm:inline">End Chat</span>
                        </button>
                    </div>
                </div>

                <div id="active-chat-messages" class="flex-1 p-6 overflow-y-auto custom-scrollbar flex flex-col gap-4"></div>
                
                <div id="user-typing-indicator" class="px-6 pb-2 text-sm text-slate-500 italic hidden">User is typing: <span id="user-typing-text" class="font-semibold not-italic text-slate-700"></span></div>

                <div id="survey-results-container" class="p-4 bg-yellow-50 border-t-2 border-yellow-200 hidden mx-6 mb-4 rounded-xl"></div>

                <div class="p-6 bg-white border-t border-slate-200 shadow-inner">
                    <div id="suggested-replies" class="flex flex-wrap gap-2 mb-4"></div>
                    <form id="reply-form" class="flex flex-col gap-3">
                        <textarea id="reply-input" rows="3" class="w-full p-4 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition resize-none" placeholder="Type your reply..."></textarea>
                        <button type="submit" class="w-full px-4 py-3 font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 transition-colors shadow-md">
                            <i class="fa-solid fa-paper-plane mr-2"></i>Send Reply
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 invisible modal">
        <div id="order-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95 modal-content overflow-hidden">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800">Order Details</h3>
                <button id="close-order-modal" class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div id="order-details-container" class="p-6 overflow-y-auto custom-scrollbar flex-1"></div>
        </div>
    </div>
    
    <!-- Transfer Notification -->
    <div id="transfer-notification" class="fixed top-6 right-6 bg-white rounded-lg shadow-xl p-4 w-80 border-l-4 border-blue-500 hidden transform translate-x-full transition-transform duration-300 z-[1001]">
        <p class="font-semibold text-slate-800">Incoming Chat Transfer</p>
        <p class="text-sm text-slate-600 mt-1">From <strong id="transfer-from-admin"></strong> for chat with <strong id="transfer-chat-user"></strong>.</p>
        <div class="mt-4 flex gap-2">
            <button id="accept-transfer-btn" class="flex-1 px-3 py-1.5 text-sm font-semibold text-white bg-green-500 rounded-md hover:bg-green-600 transition-colors">Accept</button>
            <button id="decline-transfer-btn" class="flex-1 px-3 py-1.5 text-sm font-semibold text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors">Decline</button>
        </div>
    </div>
    
    <!-- In-App Notification Toast for FCM -->
    <div id="in-app-notification" class="fixed top-24 right-6 bg-white rounded-lg shadow-xl p-4 w-80 border-l-4 border-green-500 hidden transform translate-x-full transition-transform duration-300 z-[1001]">
        <h4 id="in-app-notification-title" class="font-semibold text-slate-800"></h4>
        <p id="in-app-notification-body" class="text-sm text-slate-600 mt-1"></p>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[1002] opacity-0 invisible modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 transform scale-95 modal-content text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-slate-800">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-sm text-slate-600 mt-2">This action cannot be undone.</p>
            <div class="mt-8 flex justify-center gap-3">
                <button id="confirm-modal-cancel" class="px-5 py-2 text-sm font-semibold text-slate-700 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                <button id="confirm-modal-confirm" class="px-5 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, doc, updateDoc, addDoc, serverTimestamp, deleteDoc, getDocs, getDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, serverTimestamp as dbServerTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

        // IMPORTANT: REPLACE THIS WITH YOUR OWN FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.appspot.com",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const messaging = getMessaging(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const chatListAside = dashboardScreen.querySelector('aside');
        const mainChatView = document.getElementById('chat-view');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const noChatSelected = document.getElementById('no-chat-selected');
        const activeChatContainer = document.getElementById('active-chat-container');
        const activeChatUser = document.getElementById('active-chat-user');
        const activeChatId = document.getElementById('active-chat-id');
        const activeChatMessages = document.getElementById('active-chat-messages');
        const replyForm = document.getElementById('reply-form');
        const replyInput = document.getElementById('reply-input');
        const endChatBtn = document.getElementById('end-chat-btn');
        const userTypingIndicator = document.getElementById('user-typing-indicator');
        const userTypingText = document.getElementById('user-typing-text');
        const surveyResultsContainer = document.getElementById('survey-results-container');
        const suggestedRepliesContainer = document.getElementById('suggested-replies');
        const viewOrdersBtn = document.getElementById('view-orders-btn');
        const orderModal = document.getElementById('order-modal');
        const orderModalContent = document.getElementById('order-modal-content');
        const closeOrderModalBtn = document.getElementById('close-order-modal');
        const orderDetailsContainer = document.getElementById('order-details-container');
        const transferChatBtn = document.getElementById('transfer-chat-btn');
        const transferDropdown = document.getElementById('transfer-dropdown');
        const transferNotification = document.getElementById('transfer-notification');
        const multiSelectActions = document.getElementById('multi-select-actions');
        const assignSelectedBtn = document.getElementById('assign-selected-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const notificationBell = document.getElementById('notification-bell');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationList = document.getElementById('notification-list');
        const markAllReadBtn = document.getElementById('mark-all-read-btn');
        const inAppNotification = document.getElementById('in-app-notification');

        // --- State Variables ---
        let currentAdmin = null;
        let activeChatIdState = null;
        let unsubscribeFromChats = () => {};
        let unsubscribeFromActiveChat = () => {};
        let unsubscribeFromActiveMessages = () => {};
        let unsubscribeFromSurvey = () => {};
        let unsubscribeFromTransfers = () => {};
        let unsubscribeFromNotifications = () => {};
        let adminTypingTimeout = null;
        let onlineAdmins = {};
        let unreadNotifications = [];
        let activeUserId = null; // New state variable to hold the userId for the active chat

        const suggestedReplies = [
            "Hello! How can I help you today?",
            "I can certainly help you with that.",
            "Could you please provide your order number?",
            "Is there anything else I can assist you with?",
            "Thank you for contacting support. Have a great day!"
        ];

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentAdmin = user;
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                dashboardScreen.classList.add('flex');
                
                managePresence(user);
                loadChatQueue();
                listenForTransfers(user.uid);
                populateSuggestedReplies();
                setupNotifications(user);
                listenForInAppNotifications(user.uid);

                const urlParams = new URLSearchParams(window.location.search);
                const chatIdFromUrl = urlParams.get('chatId');
                if (chatIdFromUrl) {
                    openChat(chatIdFromUrl, 'unknown_user_id');
                    history.replaceState({}, document.title, window.location.pathname);
                }

            } else {
                currentAdmin = null;
                loginScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                dashboardScreen.classList.remove('flex');
                unsubscribeFromChats();
                unsubscribeFromTransfers();
                unsubscribeFromNotifications();
            }
        });

        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = "Invalid credentials. Please try again.";
            }
        });

        logoutBtn.addEventListener('click', () => {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + currentAdmin.uid);
            set(userStatusDatabaseRef, { state: 'offline', last_changed: dbServerTimestamp(), name: currentAdmin.displayName });
            signOut(auth);
        });

        // --- Mobile View Logic ---
        backToListBtn.addEventListener('click', () => {
            chatListAside.classList.add('hidden');
            mainChatView.classList.add('hidden');
            activeChatIdState = null;
            document.querySelectorAll('[id^="chat-item-"]').forEach(el => el.classList.remove('bg-blue-50'));
        });

        // --- Presence Management ---
        function managePresence(user) {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + user.uid);
            const isOfflineForDatabase = { state: 'offline', last_changed: dbServerTimestamp(), name: user.displayName };
            const isOnlineForDatabase = { state: 'online', last_changed: dbServerTimestamp(), name: user.displayName };

            onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                if (snapshot.val() === false) return;
                onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                    set(userStatusDatabaseRef, isOnlineForDatabase);
                });
            });

            onValue(ref(rtdb, '/status'), (snapshot) => {
                onlineAdmins = snapshot.val() || {};
            });
        }
        
        // --- Main Chat Logic ---
        function getStatusFlag(chatData) {
            if (chatData.status === 'ended_by_agent' || chatData.status === 'ended_by_user') {
                return `<span class="px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-200 rounded-full">Closed</span>`;
            }
            if (chatData.assignedAdminName) {
                return `<span class="px-3 py-1 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full">${chatData.assignedAdminName}</span>`;
            }
            return `<span class="px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full">Open</span>`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            if (isToday) {
                return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function loadChatQueue() {
            const q = query(collection(db, "chats"), orderBy("createdAt", "desc"));
            unsubscribeFromChats = onSnapshot(q, (snapshot) => {
                const openList = document.getElementById('open-chats-list');
                const myList = document.getElementById('my-chats-list');
                const closedList = document.getElementById('closed-chats-list');
                openList.innerHTML = '';
                myList.innerHTML = '';
                closedList.innerHTML = '';

                snapshot.forEach(doc => {
                    const chatData = doc.data();
                    const chatId = doc.id;
                    
                    const lastMessageText = chatData.userTypingText ? `<em class="text-blue-500">Typing: ${chatData.userTypingText}</em>` : (chatData.lastMessage || 'New chat session started...');
                    const isClosed = chatData.status === 'ended_by_agent' || chatData.status === 'ended_by_user';
                    const hasUnread = chatData.lastMessageSeenByAdmin === false && chatData.lastMessageSender !== currentAdmin?.uid;

                    const newItem = document.createElement('div');
                    newItem.id = `chat-item-${chatId}`;
                    newItem.className = `p-4 border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors ${activeChatIdState === chatId ? 'bg-blue-50' : ''} ${hasUnread ? 'font-semibold' : ''}`;
                    newItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            ${!isClosed ? `<input type="checkbox" data-chat-id="${chatId}" class="chat-checkbox mt-1 mr-3">` : '<div class="w-7"></div>'}
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-slate-700 truncate">${chatData.ownerUid || chatData.guestId}</p>
                                    <p class="text-xs text-slate-400 flex-shrink-0 ml-2">${formatTimestamp(chatData.lastMessageTimestamp || chatData.createdAt)}</p>
                                </div>
                                <p class="text-sm text-slate-500 truncate mt-1">${lastMessageText}</p>
                            </div>
                            <div class="flex flex-col items-end ml-2">
                                ${getStatusFlag(chatData)}
                            </div>
                        </div>
                    `;

                    if (isClosed) {
                        closedList.appendChild(newItem);
                    } else if (chatData.assignedAdminUid === currentAdmin.uid) {
                        myList.appendChild(newItem);
                    } else if (!chatData.assignedAdminUid) {
                        openList.appendChild(newItem);
                    }
                    
                    newItem.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            openChat(chatId, chatData.ownerUid, isClosed);
                        }
                    });
                });
                
                document.querySelectorAll('.chat-checkbox').forEach(cb => cb.addEventListener('change', updateMultiSelectActions));
            });
        }

        async function openChat(chatId, userId, isReadOnly = false) {
            if (activeChatIdState === chatId) return;
            
            if (window.innerWidth < 768) {
                chatListAside.classList.add('hidden');
                mainChatView.classList.remove('hidden');
                mainChatView.classList.add('flex');
            }

            unsubscribeFromActiveChat();
            unsubscribeFromActiveMessages();
            unsubscribeFromSurvey();

            activeChatIdState = chatId;
            activeUserId = userId; // Store the userId
            noChatSelected.classList.add('hidden');
            activeChatContainer.classList.remove('hidden');
            activeChatContainer.classList.add('flex');
            activeChatMessages.innerHTML = '';
            surveyResultsContainer.classList.add('hidden');
            
            document.querySelectorAll('[id^="chat-item-"]').forEach(el => el.classList.remove('bg-blue-50', 'font-semibold'));
            document.getElementById(`chat-item-${chatId}`)?.classList.add('bg-blue-50');
            
            const agentName = currentAdmin.displayName || currentAdmin.email.split('@')[0];
            const chatRef = doc(db, "chats", chatId);

            const chatSnap = await getDoc(chatRef);
            if (chatSnap.exists() && !chatSnap.data().assignedAdminUid && !isReadOnly) {
                 await updateDoc(chatRef, { 
                    assignedAdminUid: currentAdmin.uid,
                    assignedAdminName: agentName,
                    agentName: agentName, 
                    status: 'active',
                    agentHasJoined: true
                });
            }

            unsubscribeFromActiveChat = onSnapshot(chatRef, (docSnap) => {
                const data = docSnap.data();
                if (!data) return;
                activeChatUser.textContent = data.ownerUid || data.guestId;
                activeChatId.textContent = `ID: ${chatId}`;
                userTypingIndicator.classList.toggle('hidden', !data.userTypingText);
                userTypingText.textContent = data.userTypingText;
            });

            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp"));
            unsubscribeFromActiveMessages = onSnapshot(q, (snapshot) => {
                activeChatMessages.innerHTML = '';
                snapshot.forEach(doc => renderMessage(doc.data()));
                activeChatMessages.scrollTop = activeChatMessages.scrollHeight;
                
                // Mark chat as seen when opened
                updateDoc(chatRef, { lastMessageSeenByAdmin: true });
            });
            
             const surveyRef = doc(db, `chats/${chatId}/survey/feedback`);
            unsubscribeFromSurvey = onSnapshot(surveyRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    surveyResultsContainer.innerHTML = `
                        <h4 class="font-bold text-lg mb-2 text-center">Customer Survey Feedback</h4>
                        <div class="text-sm space-y-2">
                            <p><strong>Rating:</strong> ${'⭐'.repeat(data.rating)}</p>
                            <p><strong>Feedback:</strong> ${data.feedback || 'No feedback provided.'}</p>
                        </div>
                    `;
                    surveyResultsContainer.classList.remove('hidden');
                }
            });
        }
        
        function renderMessage(msg) {
            const isAdminMessage = msg.sender === currentAdmin.uid;
            const isSystemMessage = msg.type === 'system';
            
            let bubbleClass = isSystemMessage ? 'chat-bubble-system text-center text-sm italic' : (isAdminMessage ? 'chat-bubble-admin' : 'chat-bubble-user');
            let alignment = isSystemMessage ? 'self-center' : (isAdminMessage ? 'self-end' : 'self-start');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-xl max-w-[85%] break-words ${bubbleClass} ${alignment}`;
            
            if (!isSystemMessage) {
                const senderPrefix = isAdminMessage ? 'You' : 'User';
                const senderColor = isAdminMessage ? 'text-white' : 'text-slate-800'; // Adjusted color for contrast
                messageDiv.innerHTML = `<p class="text-xs font-bold mb-1 ${senderColor}">${senderPrefix}</p>`;
            }
            
            messageDiv.innerHTML += `<p>${msg.text}</p>`;
            activeChatMessages.appendChild(messageDiv);

            // Auto-detect order number and display a clickable pill
            if (!isSystemMessage && !isAdminMessage) {
                const orderRegex = /(\d{2}-\d{3})|(\d{26})/;
                const match = msg.text.match(orderRegex);
                if (match) {
                    const identifier = match[0];
                    showDetectedOrder(identifier);
                }
            }
        }
        
        async function showDetectedOrder(identifier) {
            const order = await findOrderByIdentifier(identifier);
            if (order) {
                const orderPill = document.createElement('div');
                orderPill.className = 'p-3 mt-2 rounded-xl bg-indigo-100 text-indigo-800 self-start cursor-pointer hover:bg-indigo-200 transition-colors shadow-sm';
                orderPill.innerHTML = `
                    <p class="font-bold text-sm">Order Detected: #${order.id}</p>
                    <p class="text-xs">${order.device} - Status: ${order.status}</p>
                `;
                orderPill.onclick = () => showOrderDetails(order);
                activeChatMessages.appendChild(orderPill);
                activeChatMessages.scrollTop = activeChatMessages.scrollHeight;
            }
        }

        // --- Event Listeners & Helpers ---
        replyForm.addEventListener('submit', (e) => { e.preventDefault(); sendReply(); });
        async function sendReply(textOverride = null) {
            const text = textOverride || replyInput.value.trim();
            if (text === '' || !activeChatIdState) return;
            
            const agentName = currentAdmin.displayName || currentAdmin.email.split('@')[0];
            const chatRef = doc(db, "chats", activeChatIdState);
            const messagesRef = collection(db, `chats/${activeChatIdState}/messages`);

            await addDoc(messagesRef, { text, sender: currentAdmin.uid, timestamp: serverTimestamp() });
            
            if (!textOverride) replyInput.value = '';
            
            clearTimeout(adminTypingTimeout);
            await updateDoc(chatRef, { 
                isAgentTyping: false, 
                lastMessage: `${agentName}: ${text}`,
                lastMessageTimestamp: serverTimestamp(),
                lastMessageSeenByAdmin: true,
                lastMessageSender: currentAdmin.uid
            });
        }
        replyInput.addEventListener('keyup', () => {
            if (!activeChatIdState) return;
            const chatRef = doc(db, "chats", activeChatIdState);
            updateDoc(chatRef, { isAgentTyping: true });
            clearTimeout(adminTypingTimeout);
            adminTypingTimeout = setTimeout(() => {
                updateDoc(chatRef, { isAgentTyping: false });
            }, 2000);
        });
        endChatBtn.addEventListener('click', async () => {
            if (!activeChatIdState) return;
            showConfirmModal(
                'End Chat Session?',
                'This will close the chat and it will no longer appear in the "Open" queue.',
                async () => {
                    const chatRef = doc(db, "chats", activeChatIdState);
                    await updateDoc(chatRef, { status: 'ended_by_agent' });
                    activeChatContainer.classList.add('hidden');
                    noChatSelected.classList.remove('hidden');
                    activeChatIdState = null;
                }
            );
        });
        function populateSuggestedReplies() {
            suggestedRepliesContainer.innerHTML = '';
            suggestedReplies.forEach(text => {
                const button = document.createElement('button');
                button.className = 'px-4 py-2 text-sm font-semibold text-blue-700 bg-blue-100 rounded-full hover:bg-blue-200 transition-colors';
                button.textContent = text;
                button.onclick = () => {
                    replyInput.value = text;
                    replyInput.focus();
                };
                suggestedRepliesContainer.appendChild(button);
            });
        }

        // --- Order Modal Logic ---
        async function findOrderByIdentifier(identifier) {
            const baseUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';
            const url = `${baseUrl}/orders/find?identifier=${identifier}`; // Adjusted endpoint for clarity
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                console.error("Failed to fetch order:", error);
                return null;
            }
        }

        async function fetchAllUserOrders(userId) {
            const baseUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';
            const url = `${baseUrl}/orders/by-user/${userId}`;
            try {
                const response = await fetch(url);
                if (!response.ok) return [];
                return await response.json();
            } catch (error) {
                console.error("Failed to fetch user's orders:", error);
                return [];
            }
        }
        
        // This global function is needed because it's called from inline HTML (onclick)
        window.showOrderDetails = function(order) {
            orderDetailsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-100 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-800 text-lg mb-3">Order Info</h4>
                        <p class="text-sm"><strong>ID:</strong> <span class="font-mono">${order.id}</span></p>
                        <p class="text-sm mt-1"><strong>Status:</strong> <span class="font-semibold text-blue-600">${order.status}</span></p>
                        <p class="text-sm mt-1"><strong>Device:</strong> ${order.device} ${order.storage}</p>
                        <p class="text-sm mt-1"><strong>Quote:</strong> $${order.estimatedQuote?.toFixed(2) || 'N/A'}</p>
                    </div>
                    <div class="bg-slate-100 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-800 text-lg mb-3">Customer Info</h4>
                        <p class="text-sm"><strong>Name:</strong> ${order.shippingInfo.fullName}</p>
                        <p class="text-sm mt-1"><strong>Email:</strong> ${order.shippingInfo.email}</p>
                        <p class="text-sm mt-1"><strong>Address:</strong> ${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state} ${order.shippingInfo.zipCode}</p>
                    </div>
                    <div class="md:col-span-2 bg-slate-100 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-800 text-lg mb-3">Shipping</h4>
                        <p class="text-sm"><strong>Preference:</strong> ${order.shippingPreference}</p>
                        <p class="text-sm mt-1"><strong>Tracking #:</strong> ${order.trackingNumber || 'N/A'}</p>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="send-order-to-user" class="px-6 py-3 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                        <i class="fa-solid fa-share-from-square mr-2"></i>Send Order Details to User
                    </button>
                </div>
            `;
            orderModal.classList.remove('invisible', 'opacity-0');
            orderModalContent.classList.remove('scale-95');

            document.getElementById('send-order-to-user').onclick = () => {
                const confirmationText = `Hello! Based on your query, here are the details for order #${order.id}:
Device: ${order.device}
Quote: $${order.estimatedQuote?.toFixed(2) || 'N/A'}
Current Status: ${order.status}`;
                sendReply(confirmationText);
                closeOrderModal();
            };
        }
        
        viewOrdersBtn.addEventListener('click', async () => {
            if (!activeUserId) {
                // Modified from alert to a custom modal
                showConfirmModal("Guest User", "This user is a guest and has no associated orders.", () => {});
                return;
            }
            orderDetailsContainer.innerHTML = '<div class="text-center p-8 text-slate-500"><i class="fa-solid fa-spinner fa-spin text-4xl"></i><p class="mt-4">Loading orders...</p></div>';
            orderModal.classList.remove('invisible', 'opacity-0');
            orderModalContent.classList.remove('scale-95');

            const orders = await fetchAllUserOrders(activeUserId);
            if (orders.length === 0) {
                orderDetailsContainer.innerHTML = `<div class="text-center p-8 text-slate-500">
                    <i class="fa-solid fa-box-open text-4xl mb-4"></i>
                    <p class="text-lg font-semibold">No orders found for this user.</p>
                </div>`;
                return;
            }

            let ordersHtml = `<h4 class="text-xl font-bold mb-6">All Orders for User</h4>`;
            orders.forEach(order => {
                ordersHtml += `
                    <div class="bg-slate-100 p-5 rounded-xl mb-4 border border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors" onclick="window.showOrderDetails(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(order))}')))">
                        <div class="flex justify-between items-center">
                            <p class="font-bold">Order ID: <span class="font-mono">${order.id}</span></p>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700">${order.status}</span>
                        </div>
                        <p class="text-sm mt-2">Device: ${order.device}</p>
                        <p class="text-sm">Quote: $${order.estimatedQuote?.toFixed(2) || 'N/A'}</p>
                    </div>
                `;
            });
            orderDetailsContainer.innerHTML = ordersHtml;
        });

        function closeOrderModal() {
            orderModal.classList.add('invisible', 'opacity-0');
            orderModalContent.classList.add('scale-95');
        }
        closeOrderModalBtn.addEventListener('click', closeOrderModal);

        // --- Tab, Multi-Select, and Confirmation Modal Logic ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('open-chats-list').classList.toggle('hidden', tab !== 'open');
                document.getElementById('my-chats-list').classList.toggle('hidden', tab !== 'my');
                document.getElementById('closed-chats-list').classList.toggle('hidden', tab !== 'closed');
                
                multiSelectActions.classList.toggle('hidden', tab !== 'open');
                updateMultiSelectActions();
            });
        });
        function getSelectedChatIds() {
            const selected = [];
            document.querySelectorAll('#open-chats-list .chat-checkbox:checked').forEach(cb => {
                selected.push(cb.dataset.chatId);
            });
            return selected;
        }
        function updateMultiSelectActions() {
            const selectedIds = getSelectedChatIds();
            const hasSelection = selectedIds.length > 0;
            multiSelectActions.classList.toggle('hidden', !hasSelection);
            assignSelectedBtn.disabled = !hasSelection;
            deleteSelectedBtn.disabled = !hasSelection;
        }
        assignSelectedBtn.addEventListener('click', async () => {
            const chatIds = getSelectedChatIds();
            if (chatIds.length === 0) return;

            const agentName = currentAdmin.displayName || currentAdmin.email.split('@')[0];
            const batch = writeBatch(db);
            chatIds.forEach(chatId => {
                const chatRef = doc(db, "chats", chatId);
                batch.update(chatRef, {
                    assignedAdminUid: currentAdmin.uid,
                    assignedAdminName: agentName,
                    agentName: agentName,
                    status: 'active',
                    agentHasJoined: true
                });
            });
            await batch.commit();
        });
        deleteSelectedBtn.addEventListener('click', () => {
            const chatIds = getSelectedChatIds();
            if (chatIds.length === 0) return;
            
            showConfirmModal(
                `Delete ${chatIds.length} chats?`,
                "This will permanently delete the selected chat conversations.",
                async () => {
                    const batch = writeBatch(db);
                    for (const chatId of chatIds) {
                        const messagesRef = collection(db, `chats/${chatId}/messages`);
                        const messagesSnapshot = await getDocs(messagesRef);
                        messagesSnapshot.forEach(msgDoc => batch.delete(msgDoc.ref));
                        batch.delete(doc(db, "chats", chatId));
                    }
                    await batch.commit();
                    console.log(`${chatIds.length} chats deleted.`);
                }
            );
        });
        function showConfirmModal(title, text, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            confirmModal.classList.remove('invisible', 'opacity-0');
            confirmModal.querySelector('.modal-content').classList.remove('scale-95');

            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');

            const confirmHandler = () => {
                onConfirm();
                hideConfirmModal();
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            const cancelHandler = () => {
                hideConfirmModal();
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }
        function hideConfirmModal() {
            confirmModal.classList.add('invisible', 'opacity-0');
            confirmModal.querySelector('.modal-content').classList.add('scale-95');
        }
        
        // --- Transfer Logic ---
        transferChatBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            populateTransferDropdown();
            transferDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', () => transferDropdown.classList.add('hidden'));
        function populateTransferDropdown() {
            transferDropdown.innerHTML = '';
            const availableAdmins = Object.entries(onlineAdmins)
                .filter(([uid, data]) => data.state === 'online' && uid !== currentAdmin.uid);

            if (availableAdmins.length === 0) {
                transferDropdown.innerHTML = `<div class="p-4 text-sm text-slate-500">No other admins are online.</div>`;
                return;
            }

            availableAdmins.forEach(([uid, data]) => {
                const adminItem = document.createElement('button');
                adminItem.className = 'w-full p-4 text-left hover:bg-slate-100 transition-colors flex items-center justify-between';
                adminItem.innerHTML = `
                    <span>${data.name}</span>
                    <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
                `;
                adminItem.onclick = () => initiateTransfer(uid, data.name);
                transferDropdown.appendChild(adminItem);
            });
        }
        async function initiateTransfer(toAdminUid, toAdminName) {
            if (!activeChatIdState) return;
            const chatRef = doc(db, "chats", activeChatIdState);
            const userDisplayName = activeChatUser.textContent;
            await updateDoc(chatRef, {
                transferRequest: {
                    fromUid: currentAdmin.uid,
                    fromName: currentAdmin.displayName || currentAdmin.email.split('@')[0],
                    toUid: toAdminUid,
                    toName: toAdminName,
                    status: 'pending',
                    chatId: activeChatIdState,
                    userDisplayName: userDisplayName
                }
            });
            transferDropdown.classList.add('hidden');
            sendReply(`I am transferring you to ${toAdminName}, one moment please.`);
            // Optionally, clear the active chat for the transferring admin
            activeChatContainer.classList.add('hidden');
            noChatSelected.classList.remove('hidden');
            activeChatIdState = null;
        }
        
        function listenForTransfers(adminUid) {
            const q = query(collection(db, "chats"), where("transferRequest.toUid", "==", adminUid), where("transferRequest.status", "==", "pending"));
            unsubscribeFromTransfers = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    transferNotification.classList.add('translate-x-full');
                    transferNotification.classList.add('hidden');
                    return;
                }
                const change = snapshot.docChanges()[0];
                if (change.type === 'added' || change.type === 'modified') {
                    const chatData = change.doc.data();
                    const chatId = change.doc.id;
                    document.getElementById('transfer-from-admin').textContent = chatData.transferRequest.fromName;
                    document.getElementById('transfer-chat-user').textContent = chatData.transferRequest.userDisplayName || chatData.ownerUid || chatData.guestId;
                    transferNotification.classList.remove('hidden');
                    transferNotification.classList.remove('translate-x-full');

                    document.getElementById('accept-transfer-btn').onclick = async () => {
                        const chatRef = doc(db, "chats", chatId);
                        await updateDoc(chatRef, {
                            assignedAdminUid: currentAdmin.uid,
                            assignedAdminName: currentAdmin.displayName || currentAdmin.email.split('@')[0],
                            agentName: currentAdmin.displayName || currentAdmin.email.split('@')[0],
                            'transferRequest.status': 'accepted',
                            status: 'active' // Ensure chat status is active upon acceptance
                        });
                        openChat(chatId, chatData.ownerUid);
                        transferNotification.classList.add('translate-x-full');
                    };

                    document.getElementById('decline-transfer-btn').onclick = async () => {
                        const chatRef = doc(db, "chats", chatId);
                        await updateDoc(chatRef, { 'transferRequest.status': 'declined' });
                        // Optionally, notify the original sender that the transfer was declined
                        // Or simply remove the notification
                        transferNotification.classList.add('translate-x-full');
                    };
                }
            });
        }


        // --- NOTIFICATION LOGIC ---
        const VAPID_KEY = 'BDZVvbv6VgxZsBCPYUQyAwUbnSRwYB8F20IzCDh5SpkhTnw4PywqjoWq1dHDsv_xywTBeq7_LL142dheHTWR8uU'; // Use your actual VAPID key
        
        async function setupNotifications(user) {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const fcmToken = await getToken(messaging, { vapidKey: VAPID_KEY });
                    if (fcmToken) {
                        const tokenRef = doc(db, `admins/${user.uid}/fcmTokens`, fcmToken);
                        await setDoc(tokenRef, { timestamp: serverTimestamp() });
                    }
                }
            } catch (error) {
                console.error('An error occurred while setting up notifications:', error);
            }
        }
        
        onMessage(messaging, (payload) => {
            const notification = inAppNotification;
            document.getElementById('in-app-notification-title').textContent = payload.notification.title;
            document.getElementById('in-app-notification-body').textContent = payload.notification.body;

            notification.classList.remove('hidden', 'translate-x-full');
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
            }, 5000);

            if (payload.data && payload.data.chatId) {
                notification.onclick = () => {
                    openChat(payload.data.chatId, payload.data.userId);
                    notification.classList.add('translate-x-full');
                };
            }
        });

        async function fetchAndDisplayNotifications() {
            if (!currentAdmin) return;
            // Notifications are stored per admin under a subcollection 'notifications'
            // Each notification is a document in that subcollection
            const notificationsCollectionRef = collection(db, `admins/${currentAdmin.uid}/notifications`);
            const q = query(notificationsCollectionRef, where('isRead', '==', false), orderBy('createdAt', 'desc'));
            
            unsubscribeFromNotifications = onSnapshot(q, (snapshot) => {
                unreadNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateNotificationUI();
            });
        }

        async function updateNotificationUI() {
            notificationList.innerHTML = '';
            if (unreadNotifications.length === 0) {
                notificationList.innerHTML = `<div class="p-4 text-sm text-slate-500 text-center">No new notifications.</div>`;
                notificationBadge.classList.add('hidden');
                markAllReadBtn.disabled = true;
            } else {
                notificationBadge.textContent = unreadNotifications.length;
                notificationBadge.classList.remove('hidden');
                markAllReadBtn.disabled = false;

                unreadNotifications.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item text-sm text-slate-700 unread`;
                    notificationItem.innerHTML = `
                        <p>${notification.message}</p>
                        <p class="text-xs text-slate-500 mt-1">${notification.createdAt.toDate().toLocaleString()}</p>
                    `;
                    notificationItem.addEventListener('click', () => handleNotificationClick(notification));
                    notificationList.appendChild(notificationItem);
                });
            }
        }

        async function handleNotificationClick(notification) {
            // Mark as read in Firestore
            const notificationDocRef = doc(db, `admins/${currentAdmin.uid}/notifications`, notification.id);
            await updateDoc(notificationDocRef, { isRead: true });
            
            // Remove from local unread list and update UI
            unreadNotifications = unreadNotifications.filter(n => n.id !== notification.id);
            updateNotificationUI();

            if (notification.relatedDocType === 'chat' && notification.relatedDocId) {
                openChat(notification.relatedDocId, notification.relatedUserId || 'unknown_user_id'); // Pass userId if available
                notificationDropdown.classList.add('hidden');
            }
        }

        notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.toggle('hidden');
            if (!notificationDropdown.classList.contains('hidden')) {
                // No need to call fetchAndDisplayNotifications() here as onSnapshot will handle real-time updates
            }
        });

        document.addEventListener('click', (e) => {
            if (!notificationDropdown.contains(e.target) && !notificationBell.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });

        markAllReadBtn.addEventListener('click', async () => {
            const batch = writeBatch(db);
            unreadNotifications.forEach(notification => {
                const notificationDocRef = doc(db, `admins/${currentAdmin.uid}/notifications`, notification.id);
                batch.update(notificationDocRef, { isRead: true });
            });
            await batch.commit();
            unreadNotifications = [];
            updateNotificationUI();
        });

        // This function sets up the real-time listener for notifications
        function listenForInAppNotifications(adminUid) {
            // Listen for notifications specifically for this admin
            const notificationsCollectionRef = collection(db, `admins/${adminUid}/notifications`);
            const q = query(
                notificationsCollectionRef,
                where('isRead', '==', false),
                orderBy('createdAt', 'desc')
            );
            
            // This onSnapshot will keep unreadNotifications state updated in real-time
            unsubscribeFromNotifications = onSnapshot(q, (snapshot) => {
                unreadNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateNotificationUI(); // Update UI whenever unread notifications change
            });
        }
        
    </script>
</body>
</html>
