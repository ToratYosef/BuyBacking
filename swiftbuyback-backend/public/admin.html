<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftBuyBack Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">SwiftBuyBack Admin</h1>
            <button id="refreshOrdersBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md transition duration-300">
                Refresh Orders
            </button>
        </div>
    </header>

    <main class="container mx-auto p-6">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Manage Orders</h2>

        <div id="ordersContainer" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Pending Shipments</h3>
            <div id="ordersList" class="space-y-4">
                <p class="text-gray-500" id="loadingMessage">Loading orders...</p>
                </div>
            <p id="errorMessage" class="text-red-600 mt-4 hidden">Error loading orders.</p>
        </div>

        <div id="orderDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Order Details: <span id="modalOrderId"></span></h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                <div class="space-y-4 text-gray-700">
                    <p><strong>Estimated Quote:</strong> <span id="modalEstimatedQuote"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Device Details:</h4>
                    <p><strong>Model:</strong> <span id="modalDeviceModel"></span></p>
                    <p><strong>Carrier:</strong> <span id="modalDeviceCarrier"></span></p>
                    <p><strong>Storage:</strong> <span id="modalDeviceStorage"></span></p>
                    <p><strong>Condition:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Power On: <span id="modalConditionPowerOn"></span></li>
                        <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                        <li>No Cracks: <span id="modalConditionCracks"></span></li>
                        <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                    </ul>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Payment Details:</h4>
                    <p><strong>Method:</strong> <span id="modalPaymentMethod"></span></p>
                    <p><strong>Account:</strong> <span id="modalPaymentValue"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Shipping Details:</h4>
                    <p><strong>Name:</strong> <span id="modalShippingName"></span></p>
                    <p><strong>Address:</strong> <span id="modalShippingAddress"></span></p>
                    <p><strong>Email:</strong> <span id="modalShippingEmail"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Current Status: <span id="modalOrderStatus" class="font-bold"></span></h4>
                    <p id="modalLabelUrl" class="hidden"><strong>USPS Label:</strong> <a href="#" target="_blank" class="text-indigo-600 hover:underline">View Label</a></p>

                    <div class="mt-6 space-y-3">
                        <button id="generateLabelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Generate USPS Label
                        </button>
                        <button id="markReceivedBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Mark as Received
                        </button>
                        <button id="markCompletedBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Mark as Completed
                        </button>
                        <p id="modalMessage" class="mt-4 p-3 rounded-md text-sm text-center hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Adjust this URL if your backend is deployed elsewhere (e.g., Codespaces URL)
        const BACKEND_URL = 'https://cautious-pancake-69p475gq54q4f5qp4-3000.app.github.dev';

        document.addEventListener('DOMContentLoaded', () => {
            const ordersList = document.getElementById('ordersList');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            const orderDetailModal = document.getElementById('orderDetailModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const generateLabelBtn = document.getElementById('generateLabelBtn');
            const markReceivedBtn = document.getElementById('markReceivedBtn');
            const markCompletedBtn = document.getElementById('markCompletedBtn');
            const modalMessage = document.getElementById('modalMessage');

            let currentOrderId = null;

            function showModalMessage(msg, type) {
                modalMessage.textContent = msg;
                modalMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (type === 'error') {
                    modalMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    modalMessage.classList.add('bg-green-100', 'text-green-700');
                }
                modalMessage.classList.remove('hidden');
            }

            async function fetchOrders() {
                ordersList.innerHTML = '';
                loadingMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                modalMessage.classList.add('hidden');

                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const orders = await response.json();

                    loadingMessage.classList.add('hidden');

                    if (orders.length === 0) {
                        ordersList.innerHTML = '<p class="text-gray-600">No pending shipments found.</p>';
                    } else {
                        orders.forEach(order => {
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'bg-gray-50 p-4 rounded-md shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                            orderDiv.innerHTML = `
                                <div>
                                    <p class="font-bold text-lg">Order ID: ${order.id}</p>
                                    <p class="text-sm text-gray-600">Device: ${order.device} (${order.storage})</p>
                                    <p class="text-sm text-gray-600">Status: <span class="font-medium">${order.status}</span></p>
                                </div>
                                <button class="view-details-btn bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md text-sm transition duration-300" data-order-id="${order.id}">View Details</button>
                            `;
                            ordersList.appendChild(orderDiv);
                        });

                        document.querySelectorAll('.view-details-btn').forEach(button => {
                            button.addEventListener('click', async (event) => {
                                const orderId = event.target.dataset.orderId;
                                const response = await fetch(`${BACKEND_URL}/api/orders/${orderId}`);
                                const orderData = await response.json();
                                openOrderDetailModal(orderId, orderData);
                            });
                        });
                    }
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error: ${error.message}. Is the backend running at ${BACKEND_URL}?`;
                    errorMessage.classList.remove('hidden');
                }
            }

            async function openOrderDetailModal(orderId, orderData) {
                currentOrderId = orderId;
                document.getElementById('modalOrderId').textContent = orderId;
                document.getElementById('modalEstimatedQuote').textContent = `$${orderData.estimatedQuote.toFixed(2)}`;

                document.getElementById('modalDeviceModel').textContent = orderData.device;
                document.getElementById('modalDeviceCarrier').textContent = orderData.carrier;
                document.getElementById('modalDeviceStorage').textContent = orderData.storage;
                document.getElementById('modalConditionPowerOn').textContent = orderData.condition_power_on;
                document.getElementById('modalConditionFunctional').textContent = orderData.condition_functional;
                document.getElementById('modalConditionCracks').textContent = orderData.condition_cracks;
                document.getElementById('modalConditionCosmetic').textContent = orderData.condition_cosmetic;

                document.getElementById('modalPaymentMethod').textContent = orderData.paymentMethod;
                document.getElementById('modalPaymentValue').textContent = orderData.paymentDetails.venmoUsername || 'N/A';

                document.getElementById('modalShippingName').textContent = orderData.shippingInfo.fullName;
                document.getElementById('modalShippingAddress').textContent = `${orderData.shippingInfo.streetAddress}, ${orderData.shippingInfo.city}, ${orderData.shippingInfo.state} ${orderData.shippingInfo.zipCode}`;
                document.getElementById('modalShippingEmail').textContent = orderData.shippingInfo.email;

                document.getElementById('modalOrderStatus').textContent = orderData.status;

                const modalLabelUrl = document.getElementById('modalLabelUrl');
                const labelLink = modalLabelUrl.querySelector('a');
                if (orderData.uspsLabelUrl) {
                    labelLink.href = orderData.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                } else {
                    modalLabelUrl.classList.add('hidden');
                }
                
                // Update buttons based on the order's status
                generateLabelBtn.classList.add('hidden');
                markReceivedBtn.classList.add('hidden');
                markCompletedBtn.classList.add('hidden');
                
                if (orderData.status === 'pending_shipment') {
                    generateLabelBtn.classList.remove('hidden');
                } else if (orderData.status === 'label_generated') {
                    markReceivedBtn.classList.remove('hidden');
                } else if (orderData.status === 'received') {
                    markCompletedBtn.classList.remove('hidden');
                }

                modalMessage.classList.add('hidden');
                orderDetailModal.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => {
                orderDetailModal.classList.add('hidden');
                currentOrderId = null;
                fetchOrders();
            });

            generateLabelBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Generating label...', 'success');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/generate-label/${currentOrderId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to generate label');
                    }
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'label_generated';
                    const modalLabelUrl = document.getElementById('modalLabelUrl');
                    modalLabelUrl.querySelector('a').href = result.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                    generateLabelBtn.classList.add('hidden');
                    markReceivedBtn.classList.remove('hidden');
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Label generation error:', error);
                }
            });

            markReceivedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as received...', 'success');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'received' })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to mark as received');
                    }
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'received';
                    markReceivedBtn.classList.add('hidden');
                    markCompletedBtn.classList.remove('hidden');
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Mark received error:', error);
                }
            });
            
            markCompletedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as completed...', 'success');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to mark as completed');
                    }
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'completed';
                    markCompletedBtn.classList.add('hidden');
                    markReceivedBtn.classList.add('hidden');
                    generateLabelBtn.classList.add('hidden');
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Mark completed error:', error);
                }
            });

            fetchOrders();
            refreshOrdersBtn.addEventListener('click', fetchOrders);
        });
    </script>
</body>
</html>