<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SwiftBuyBack Admin</title>
<link href="./dist/output.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; }
    .nav-item.active {
        @apply bg-gray-700 text-white;
    }
</style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex">

    <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col items-center">
        <h1 class="text-3xl font-bold mb-8">Swift Admin</h1>
        <div class="mb-6 w-full">
            <input type="text" id="searchInput" placeholder="Search orders..." class="w-full p-2 rounded-md bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <nav class="w-full">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="nav-item active flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 01-8 8v-8H2z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="pending_shipment">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 4a1 1 0 011-1h2.5a1 1 0 01.8.4L7 4.75V11a1 1 0 001 1h5.5a1 1 0 00.8-.4L16 10.25V13a1 1 0 01-1 1H5a1 1 0 01-1-1V5a1 1 0 00-1-1H2z" />
                        </svg>
                        Awaiting Shipment
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="label_generated">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5.787-8.103L7.337 12.33l6.506-6.485a.5.5 0 00-.708-.708l-6.505 6.505a.5.5 0 01-.707 0l-1.92-1.92a.5.5 0 00-.707.707l1.92 1.92a.5.5 0 00.707 0z" clip-rule="evenodd" />
                        </svg>
                        Shipped
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="received">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z" />
                        </svg>
                        Received
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="completed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm2 1a1 1 0 100-2 1 1 0 000 2zm4-1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                        Completed
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800" id="mainTitle">Dashboard</h2>
            <button id="refreshOrdersBtn" class="bg-gray-800 hover:bg-gray-700 text-white py-2 px-4 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V2zm5 2a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
                </svg>
                Refresh Orders
            </button>
        </header>

        <div id="contentContainer" class="bg-white p-6 rounded-lg shadow-md">
            <div id="dashboardContent" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-blue-100 p-6 rounded-lg text-center">
                        <h3 class="text-3xl font-bold text-blue-800" id="totalOrdersCount">0</h3>
                        <p class="text-sm text-blue-600 font-semibold">Total Orders</p>
                    </div>
                    <div class="bg-yellow-100 p-6 rounded-lg text-center">
                        <h3 class="text-3xl font-bold text-yellow-800" id="awaitingShipmentCount">0</h3>
                        <p class="text-sm text-yellow-600 font-semibold">Awaiting Shipment</p>
                    </div>
                    <div class="bg-green-100 p-6 rounded-lg text-center">
                        <h3 class="text-3xl font-bold text-green-800" id="shippedCount">0</h3>
                        <p class="text-sm text-green-600 font-semibold">Shipped</p>
                    </div>
                    <div class="bg-purple-100 p-6 rounded-lg text-center">
                        <h3 class="text-3xl font-bold text-purple-800" id="completedCount">0</h3>
                        <p class="text-sm text-purple-600 font-semibold">Completed</p>
                    </div>
                </div>
            </div>

            <div id="ordersListContent" class="hidden">
                <div id="ordersList" class="space-y-4">
                    <p class="text-gray-500" id="loadingMessage">Loading orders...</p>
                </div>
                <p id="errorMessage" class="text-red-600 mt-4 hidden">Error loading orders.</p>
            </div>
        </div>
    </main>

    <div id="orderDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Order Details: <span id="modalOrderId"></span></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <div class="space-y-4 text-gray-700">
                <p><strong>Estimated Quote:</strong> <span id="modalEstimatedQuote"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Device Details:</h4>
                <p><strong>Model:</strong> <span id="modalDeviceModel"></span></p>
                <p><strong>Carrier:</strong> <span id="modalDeviceCarrier"></span></p>
                <p><strong>Storage:</strong> <span id="modalDeviceStorage"></span></p>
                <p><strong>Condition:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Power On: <span id="modalConditionPowerOn"></span></li>
                    <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                    <li>No Cracks: <span id="modalConditionCracks"></span></li>
                    <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                </ul>
                <h4 class="text-lg font-semibold mt-4 mb-2">Payment Details:</h4>
                <p><strong>Method:</strong> <span id="modalPaymentMethod"></span></p>
                <p><strong>Account:</strong> <span id="modalPaymentValue"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Shipping Details:</h4>
                <p><strong>Name:</strong> <span id="modalShippingName"></span></p>
                <p><strong>Address:</strong> <span id="modalShippingAddress"></span></p>
                <p><strong>Email:</strong> <span id="modalShippingEmail"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Current Status: <span id="modalOrderStatus" class="font-bold"></span></h4>
                <p id="modalLabelUrl" class="hidden"><strong>USPS Label:</strong> <a href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a></p>
                <div class="mt-6 space-y-3">
                    <button id="generateLabelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                        Generate USPS Label
                    </button>
                    <button id="markReceivedBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                        Mark as Received
                    </button>
                    <button id="markCompletedBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                        Mark as Completed
                    </button>
                    <p id="modalMessage" class="mt-4 p-3 rounded-md text-sm text-center hidden"></p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = 'https://cautious-pancake-69p475gq54q4f5qp4-3000.app.github.dev'; // your codespace URL

        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const searchInput = document.getElementById('searchInput');
            const ordersList = document.getElementById('ordersList');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            const orderDetailModal = document.getElementById('orderDetailModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const generateLabelBtn = document.getElementById('generateLabelBtn');
            const markReceivedBtn = document.getElementById('markReceivedBtn');
            const markCompletedBtn = document.getElementById('markCompletedBtn');
            const modalMessage = document.getElementById('modalMessage');
            const modalLabelUrl = document.getElementById('modalLabelUrl');
            const mainTitle = document.getElementById('mainTitle');
            const dashboardContent = document.getElementById('dashboardContent');
            const ordersListContent = document.getElementById('ordersListContent');
            const dashboardCounts = {
                totalOrders: 0,
                awaitingShipment: 0,
                shipped: 0,
                completed: 0
            };

            let allOrders = [];
            let currentOrderId = null;
            let currentStatusFilter = 'dashboard';

            function showModalMessage(msg, type) {
                modalMessage.textContent = msg;
                modalMessage.className = 'mt-4 p-3 rounded-md text-sm text-center';
                if (type === 'error') modalMessage.classList.add('bg-red-100', 'text-red-700');
                if (type === 'success') modalMessage.classList.add('bg-green-100', 'text-green-700');
                modalMessage.classList.remove('hidden');
            }

            function updateDashboardCounts() {
                dashboardCounts.totalOrders = allOrders.length;
                dashboardCounts.awaitingShipment = allOrders.filter(o => o.status === 'pending_shipment').length;
                dashboardCounts.shipped = allOrders.filter(o => o.status === 'label_generated').length;
                dashboardCounts.completed = allOrders.filter(o => o.status === 'completed').length;
            
                document.getElementById('totalOrdersCount').textContent = dashboardCounts.totalOrders;
                document.getElementById('awaitingShipmentCount').textContent = dashboardCounts.awaitingShipment;
                document.getElementById('shippedCount').textContent = dashboardCounts.shipped;
                document.getElementById('completedCount').textContent = dashboardCounts.completed;
            }
            
            function renderOrders(ordersToRender) {
                ordersList.innerHTML = '';
                if (ordersToRender.length === 0) {
                    ordersList.innerHTML = '<p class="text-gray-600">No orders found.</p>';
                } else {
                    ordersToRender.forEach(order => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-50 p-4 rounded-md shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-lg">Order ID: ${order.id}</p>
                                <p class="text-sm text-gray-600">Device: ${order.device} (${order.storage})</p>
                                <p class="text-sm text-gray-600">Status: <span class="font-medium">${order.status}</span></p>
                            </div>
                            <button class="view-details-btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm transition duration-300" data-order-id="${order.id}">View Details</button>
                        `;
                        ordersList.appendChild(div);
                    });
            
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', async e => {
                            const id = e.target.dataset.orderId;
                            const resp = await fetch(`${BACKEND_URL}/api/orders/${id}`);
                            const data = await resp.json();
                            openOrderDetailModal(id, data);
                        });
                    });
                }
            }

            async function fetchAllOrders() {
                loadingMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                modalMessage.classList.add('hidden');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allOrders = await response.json();
                    updateDashboardCounts();
                    filterAndRenderOrders();
                } catch (err) {
                    console.error('Error fetching orders:', err);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error: ${err.message}`;
                    errorMessage.classList.remove('hidden');
                }
            }

            function filterAndRenderOrders() {
                loadingMessage.classList.add('hidden');
                ordersList.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                let filteredOrders = allOrders.filter(order => {
                    const matchesStatus = currentStatusFilter === 'dashboard' || order.status === currentStatusFilter;
                    const matchesSearch = Object.values(order).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                    return matchesStatus && matchesSearch;
                });

                if (currentStatusFilter === 'dashboard') {
                    dashboardContent.classList.remove('hidden');
                    ordersListContent.classList.add('hidden');
                } else {
                    dashboardContent.classList.add('hidden');
                    ordersListContent.classList.remove('hidden');
                    renderOrders(filteredOrders);
                }
            }

            function openOrderDetailModal(id, order) {
                currentOrderId = id;
                document.getElementById('modalOrderId').textContent = id;
                document.getElementById('modalEstimatedQuote').textContent = `$${order.estimatedQuote?.toFixed(2) || '0.00'}`;
                document.getElementById('modalDeviceModel').textContent = order.device || '';
                document.getElementById('modalDeviceCarrier').textContent = order.carrier || '';
                document.getElementById('modalDeviceStorage').textContent = order.storage || '';
                document.getElementById('modalConditionPowerOn').textContent = order.condition_power_on || '';
                document.getElementById('modalConditionFunctional').textContent = order.condition_functional || '';
                document.getElementById('modalConditionCracks').textContent = order.condition_cracks || '';
                document.getElementById('modalConditionCosmetic').textContent = order.condition_cosmetic || '';
                document.getElementById('modalPaymentMethod').textContent = order.paymentMethod || '';
                document.getElementById('modalPaymentValue').textContent = order.paymentDetails?.venmoUsername || 'N/A';
                document.getElementById('modalShippingName').textContent = order.shippingInfo?.fullName || '';
                document.getElementById('modalShippingAddress').textContent = order.shippingInfo
                    ? `${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state} ${order.shippingInfo.zipCode}`
                    : '';
                document.getElementById('modalShippingEmail').textContent = order.shippingInfo?.email || '';
                document.getElementById('modalOrderStatus').textContent = order.status || '';
            
                const labelLink = modalLabelUrl.querySelector('a');
                if (order.uspsLabelUrl) {
                    labelLink.href = order.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                } else modalLabelUrl.classList.add('hidden');
            
                generateLabelBtn.classList.add('hidden');
                markReceivedBtn.classList.add('hidden');
                markCompletedBtn.classList.add('hidden');
            
                if (order.status === 'pending_shipment') generateLabelBtn.classList.remove('hidden');
                else if (order.status === 'label_generated') markReceivedBtn.classList.remove('hidden');
                else if (order.status === 'received') markCompletedBtn.classList.remove('hidden');
            
                orderDetailModal.classList.remove('hidden');
            }
            
            navItems.forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentStatusFilter = item.dataset.status;
                    mainTitle.textContent = item.textContent.trim();
                    filterAndRenderOrders();
                });
            });

            closeModalBtn.addEventListener('click', () => {
                orderDetailModal.classList.add('hidden');
                currentOrderId = null;
                fetchAllOrders();
            });
            
            refreshOrdersBtn.addEventListener('click', () => {
                fetchAllOrders();
            });

            searchInput.addEventListener('input', () => {
                filterAndRenderOrders();
            });

            generateLabelBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Generating label...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/api/generate-label/${currentOrderId}`, { method: 'POST' });
                    const result = await resp.json();
                    if (!resp.ok) throw new Error(result.error || 'Failed to generate label');
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'label_generated';
                    modalLabelUrl.querySelector('a').href = result.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                    generateLabelBtn.classList.add('hidden');
                    markReceivedBtn.classList.remove('hidden');
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            markReceivedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as received...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({status:'received'})
                    });
                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed');
                    showModalMessage(res.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'received';
                    markReceivedBtn.classList.add('hidden');
                    markCompletedBtn.classList.remove('hidden');
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            markCompletedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as completed...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({status:'completed'})
                    });
                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed');
                    showModalMessage(res.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'completed';
                    markCompletedBtn.classList.add('hidden');
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            fetchAllOrders();
        });
    </script>
</body>
</html>