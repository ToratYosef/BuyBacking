<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SwiftBuyBack Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; }
    .modal-font { font-family: 'Montserrat', sans-serif; }
    .nav-item.active {
        @apply bg-gray-700 text-white;
    }
    .sub-nav-item {
        @apply pl-8; /* Indent sub-items */
    }
</style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex">

    <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col items-center">
        <h1 class="text-3xl font-bold mb-8">Swift Admin</h1>
        <div class="mb-6 w-full">
            <input type="text" id="searchInput" placeholder="Search orders..." class="w-full p-2 rounded-md bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <nav class="w-full">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="nav-item active flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 01-8 8v-8H2z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="pending_shipment">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 4a1 1 0 011-1h2.5a1 1 0 01.8.4L7 4.75V11a1 1 0 001 1h5.5a1 1 0 00.8-.4L16 10.25V13a1 1 0 01-1 1H5a1 1 0 01-1-1V5a1 1 0 00-1-1H2z" />
                        </svg>
                        Awaiting Shipment
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="label_generated">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5.787-8.103L7.337 12.33l6.506-6.485a.5.5 0 00-.708-.708l-6.505 6.505a.5.5 0 01-.707 0l-1.92-1.92a.5.5 0 00-.707.707l1.92 1.92a.5.5 0 00.707 0z" clip-rule="evenodd" />
                        </svg>
                        Shipped
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="received">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z" />
                        </svg>
                        Received
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="reoffered_parent">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z" />
                        </svg>
                        Re-offered
                    </a>
                    <ul class="sub-menu ml-4 hidden">
                        <li>
                            <a href="#" class="nav-item sub-nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="re-offered">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                Pending
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-item sub-nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="offer_accepted">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                Accepted
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-item sub-nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="return_requested">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                Declined
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200" data-status="completed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm2 1a1 1 0 100-2 1 1 0 000 2zm4-1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                        Completed
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800" id="mainTitle">Dashboard</h2>
            <button id="refreshOrdersBtn" class="bg-gray-800 hover:bg-gray-700 text-white py-2 px-4 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V2zm5 2a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
                </svg>
                Refresh Orders
            </button>
        </header>

        <div id="contentContainer" class="bg-white p-6 rounded-lg shadow-md">
            <div id="dashboardContent" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-blue-100 p-6 rounded-lg text-center cursor-pointer" data-status="total">
                        <h3 class="text-3xl font-bold text-blue-800" id="totalOrdersCount">0</h3>
                        <p class="text-sm text-blue-600 font-semibold">Total Orders</p>
                    </div>
                    <div class="bg-yellow-100 p-6 rounded-lg text-center cursor-pointer" data-status="pending_shipment">
                        <h3 class="text-3xl font-bold text-yellow-800" id="awaitingShipmentCount">0</h3>
                        <p class="text-sm text-yellow-600 font-semibold">Awaiting Shipment</p>
                    </div>
                    <div class="bg-green-100 p-6 rounded-lg text-center cursor-pointer" data-status="label_generated">
                        <h3 class="text-3xl font-bold text-green-800" id="shippedCount">0</h3>
                        <p class="text-sm text-green-600 font-semibold">Shipped</p>
                    </div>
                    <div class="bg-purple-100 p-6 rounded-lg text-center cursor-pointer" data-status="completed">
                        <h3 class="text-3xl font-bold text-purple-800" id="completedCount">0</h3>
                        <p class="text-sm text-purple-600 font-semibold">Completed</p>
                    </div>
                </div>
            </div>

            <div id="ordersListContent" class="hidden">
                <div id="ordersList" class="space-y-4">
                    <p class="text-gray-500" id="loadingMessage">Loading orders...</p>
                </div>
                <p id="errorMessage" class="text-red-600 mt-4 hidden">Error loading orders.</p>
            </div>
        </div>
    </main>

    <div id="orderDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-font relative" id="modalContent">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Order Details: <span id="modalOrderId"></span></h3>
            </div>
            <div class="space-y-4 text-gray-700">
                <p><strong>Estimated Quote:</strong> <span id="modalEstimatedQuote"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Device Details:</h4>
                <p><strong>Model:</strong> <span id="modalDeviceModel"></span></p>
                <p><strong>Carrier:</strong> <span id="modalDeviceCarrier"></span></p>
                <p><strong>Storage:</strong> <span id="modalDeviceStorage"></span></p>
                <p><strong>Condition:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Power On: <span id="modalConditionPowerOn"></span></li>
                    <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                    <li>No Cracks: <span id="modalConditionCracks"></span></li>
                    <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                </ul>
                <h4 class="text-lg font-semibold mt-4 mb-2">Payment Details:</h4>
                <p><strong>Method:</strong> <span id="modalPaymentMethod"></span></p>
                <p><strong>Account:</strong> <span id="modalPaymentValue"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Shipping Details:</h4>
                <p><strong>Name:</strong> <span id="modalShippingName"></span></p>
                <p><strong>Address:</strong> <span id="modalShippingAddress"></span></p>
                <p><strong>Email:</strong> <span id="modalShippingEmail"></span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Current Status: <span id="modalOrderStatus" class="font-bold"></span></h4>
                <p id="modalLabelUrl" class="hidden"><strong>USPS Label:</strong> <a href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a></p>
                <p id="modalReturnLabelUrl" class="hidden"><strong>Return Label:</strong> <a href="#" target="_blank" class="text-blue-600 hover:underline">View Return Label</a></p>
                
                <div class="mt-6 space-y-3">
                    <button id="completeOrderBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Complete Order
                    </button>
                    <button id="openReofferFormBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Send New Offer
                    </button>
                    <button id="openContactBuyerFormBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Contact Buyer
                    </button>
                    <button id="generateLabelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Generate USPS Label
                    </button>
                    <button id="markReceivedBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Mark as Received
                    </button>
                    <button id="sendPhoneBackBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Send Phone Back
                    </button>
                    <button id="payNowBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 hidden">
                        Pay Now
                    </button>
                    <p id="modalMessage" class="mt-4 p-3 rounded-md text-sm text-center hidden"></p>
                </div>

                <div id="reofferFormSection" class="mt-6 space-y-3 p-4 border rounded-lg bg-gray-50 hidden">
                    <h4 class="text-lg font-semibold mb-2">Create New Offer</h4>
                    <p class="text-sm text-gray-500">Adjust the offer based on device condition.</p>
                    <div>
                        <label for="reofferPrice" class="block text-sm font-medium text-gray-700">New Offer Price ($)</label>
                        <input type="number" id="reofferPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 250.00">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for New Offer:</label>
                        <div class="space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="reasonCracked" class="form-checkbox h-5 w-5 text-blue-600" value="Cracked Screen" data-reason-type="checkbox">
                                <span class="ml-2 text-gray-700">Cracked Screen</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="reasonDeepScratches" class="form-checkbox h-5 w-5 text-blue-600" value="Deep Scratches" data-reason-type="checkbox">
                                <span class="ml-2 text-gray-700">Deep Scratches</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="reasonFunctionalityIssues" class="form-checkbox h-5 w-5 text-blue-600" value="Functionality Issues" data-reason-type="checkbox">
                                <span class="ml-2 text-gray-700">Functionality Issues</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="reasonMissingAccessories" class="form-checkbox h-5 w-5 text-blue-600" value="Missing Accessories" data-reason-type="checkbox">
                                <span class="ml-2 text-gray-700">Missing Accessories</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="reofferAdditionalComment" class="block text-sm font-medium text-gray-700 mt-4">Additional Comments</label>
                        <textarea id="reofferAdditionalComment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Device has deep scratches on the screen not mentioned in the quote."></textarea>
                    </div>
                    <button id="submitNewReofferBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                        Submit New Offer to Buyer
                    </button>
                </div>

                <div id="contactBuyerFormSection" class="mt-6 space-y-3 p-4 border rounded-lg bg-gray-50 hidden">
                    <h4 class="text-lg font-semibold mb-2">Send Custom Email to Buyer</h4>
                    <div>
                        <label for="emailSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                        <input type="text" id="emailSubject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Your Order Update">
                    </div>
                    <div>
                        <label for="emailBody" class="block text-sm font-medium text-gray-700 mt-4">Email Message</label>
                        <textarea id="emailBody" rows="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Write your message here..."></textarea>
                    </div>
                    <button id="sendCustomEmailBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                        Send Email
                    </button>
                </div>

                <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md modal-font relative">
                        <button id="closePaymentModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Process Payment</h3>
                        <div class="space-y-4 text-gray-700">
                            <p><strong>Order ID:</strong> <span id="paymentModalOrderId"></span></p>
                            <p><strong>Amount to Pay:</strong> <span id="paymentModalAmount" class="font-bold text-green-700 text-xl"></span></p>
                            <p><strong>Payment Method:</strong> <span id="paymentModalMethod"></span></p>
                            <p><strong>Recipient Account:</strong> <span id="paymentModalRecipient"></span></p>
                            <button id="initiatePaymentBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300 mt-6">
                                Initiate Payment
                            </button>
                            <p id="paymentModalMessage" class="mt-4 p-3 rounded-md text-sm text-center hidden"></p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </aside>

    <script>
        const BACKEND_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const searchInput = document.getElementById('searchInput');
            const ordersList = document.getElementById('ordersList');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            const orderDetailModal = document.getElementById('orderDetailModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const generateLabelBtn = document.getElementById('generateLabelBtn');
            const markReceivedBtn = document.getElementById('markReceivedBtn');
            const modalMessage = document.getElementById('modalMessage');
            const modalLabelUrl = document.getElementById('modalLabelUrl');
            const modalReturnLabelUrl = document.getElementById('modalReturnLabelUrl'); // New element
            const mainTitle = document.getElementById('mainTitle');
            const dashboardContent = document.getElementById('dashboardContent');
            const ordersListContent = document.getElementById('ordersListContent');
            
            // New/updated elements
            const completeOrderBtn = document.getElementById('completeOrderBtn');
            const openReofferFormBtn = document.getElementById('openReofferFormBtn');
            const openContactBuyerFormBtn = document.getElementById('openContactBuyerFormBtn');
            const reofferFormSection = document.getElementById('reofferFormSection');
            const contactBuyerFormSection = document.getElementById('contactBuyerFormSection');
            const submitNewReofferBtn = document.getElementById('submitNewReofferBtn');
            const reofferPriceInput = document.getElementById('reofferPrice');
            const reofferReasonCheckboxes = document.querySelectorAll('#reofferFormSection input[type="checkbox"]');
            const reofferAdditionalComment = document.getElementById('reofferAdditionalComment');
            const emailSubjectInput = document.getElementById('emailSubject');
            const emailBodyInput = document.getElementById('emailBody');
            const sendCustomEmailBtn = document.getElementById('sendCustomEmailBtn');
            const sendPhoneBackBtn = document.getElementById('sendPhoneBackBtn'); // New button
            const payNowBtn = document.getElementById('payNowBtn'); // New button

            // Payment Modal elements
            const paymentModal = document.getElementById('paymentModal');
            const closePaymentModalBtn = document.getElementById('closePaymentModalBtn');
            const paymentModalOrderId = document.getElementById('paymentModalOrderId');
            const paymentModalAmount = document.getElementById('paymentModalAmount');
            const paymentModalMethod = document.getElementById('modalPaymentMethod');
            const paymentModalRecipient = document.getElementById('paymentModalRecipient');
            const initiatePaymentBtn = document.getElementById('initiatePaymentBtn');
            const paymentModalMessage = document.getElementById('paymentModalMessage');

            // Dashboard cards for click events
            const dashboardCards = document.querySelectorAll('#dashboardContent > div > div');

            const dashboardCounts = {
                totalOrders: 0,
                awaitingShipment: 0,
                shipped: 0,
                completed: 0,
                reofferedPending: 0,
                reofferedAccepted: 0,
                reofferedDeclined: 0
            };

            let allOrders = [];
            let currentOrderId = null;
            let currentOrderDetails = null; // Store full order details for modal actions
            let currentStatusFilter = 'dashboard';

            function showModalMessage(msg, type) {
                modalMessage.textContent = msg;
                modalMessage.className = 'mt-4 p-3 rounded-md text-sm text-center';
                if (type === 'error') modalMessage.classList.add('bg-red-100', 'text-red-700');
                if (type === 'success') modalMessage.classList.add('bg-green-100', 'text-green-700');
                modalMessage.classList.remove('hidden');
            }

            function updateDashboardCounts() {
                dashboardCounts.totalOrders = allOrders.length;
                dashboardCounts.awaitingShipment = allOrders.filter(o => o.status === 'pending_shipment').length;
                dashboardCounts.shipped = allOrders.filter(o => o.status === 'label_generated').length;
                dashboardCounts.completed = allOrders.filter(o => o.status === 'completed').length;
                dashboardCounts.reofferedPending = allOrders.filter(o => o.status === 're-offered').length;
                dashboardCounts.reofferedAccepted = allOrders.filter(o => o.status === 'offer_accepted').length;
                dashboardCounts.reofferedDeclined = allOrders.filter(o => o.status === 'return_requested').length;
            
                document.getElementById('totalOrdersCount').textContent = dashboardCounts.totalOrders;
                document.getElementById('awaitingShipmentCount').textContent = dashboardCounts.awaitingShipment;
                document.getElementById('shippedCount').textContent = dashboardCounts.shipped;
                document.getElementById('completedCount').textContent = dashboardCounts.completed;
            }
            
            function renderOrders(ordersToRender) {
                ordersList.innerHTML = '';
                if (ordersToRender.length === 0) {
                    ordersList.innerHTML = '<p class="text-gray-600">No orders found.</p>';
                } else {
                    ordersToRender.forEach(order => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-50 p-4 rounded-md shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-lg">Order ID: ${order.id}</p>
                                <p class="text-sm text-gray-600">Device: ${order.device} (${order.storage})</p>
                                <p class="text-sm text-gray-600">Status: <span class="font-medium">${order.status}</span></p>
                            </div>
                            <button class="view-details-btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm transition duration-300" data-order-id="${order.id}">View Details</button>
                        `;
                        ordersList.appendChild(div);
                    });
            
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', async e => {
                            const id = e.target.dataset.orderId;
                            const resp = await fetch(`${BACKEND_URL}/orders/${id}`);
                            const data = await resp.json();
                            openOrderDetailModal(id, data);
                        });
                    });
                }
            }

            async function fetchAllOrders() {
                loadingMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                modalMessage.classList.add('hidden');
                try {
                    const response = await fetch(`${BACKEND_URL}/orders`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allOrders = await response.json();
                    updateDashboardCounts();
                    filterAndRenderOrders();
                } catch (err) {
                    console.error('Error fetching orders:', err);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error: ${err.message}`;
                    errorMessage.classList.remove('hidden');
                }
            }

            function filterAndRenderOrders() {
                loadingMessage.classList.add('hidden');
                ordersList.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                let filteredOrders = allOrders.filter(order => {
                    const matchesStatus = (currentStatusFilter === 'dashboard' || currentStatusFilter === 'total') ||
                                          (currentStatusFilter === 'reoffered_parent' && (order.status === 're-offered' || order.status === 'offer_accepted' || order.status === 'return_requested' || order.status === 'return_label_generated')) ||
                                          (currentStatusFilter === order.status);
                    
                    const matchesSearch = Object.values(order).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                    return matchesStatus && matchesSearch;
                });

                if (currentStatusFilter === 'dashboard') {
                    dashboardContent.classList.remove('hidden');
                    ordersListContent.classList.add('hidden');
                } else {
                    dashboardContent.classList.add('hidden');
                    ordersListContent.classList.remove('hidden');
                    renderOrders(filteredOrders);
                }
            }

            function openOrderDetailModal(id, order) {
                currentOrderId = id;
                currentOrderDetails = order; // Store full order details
                document.getElementById('modalOrderId').textContent = id;
                document.getElementById('modalEstimatedQuote').textContent = `$${order.estimatedQuote?.toFixed(2) || '0.00'}`;
                document.getElementById('modalDeviceModel').textContent = order.device || '';
                document.getElementById('modalDeviceCarrier').textContent = order.carrier || '';
                document.getElementById('modalDeviceStorage').textContent = order.storage || '';
                document.getElementById('modalConditionPowerOn').textContent = order.condition_power_on || '';
                document.getElementById('modalConditionFunctional').textContent = order.condition_functional || '';
                document.getElementById('modalConditionCracks').textContent = order.condition_cracks || '';
                document.getElementById('modalConditionCosmetic').textContent = order.condition_cosmetic || '';
                document.getElementById('modalPaymentMethod').textContent = order.paymentMethod || '';
                document.getElementById('modalPaymentValue').textContent = order.paymentDetails?.venmoUsername || order.paymentDetails?.paypalEmail || 'N/A';
                document.getElementById('modalShippingName').textContent = order.shippingInfo?.fullName || '';
                document.getElementById('modalShippingAddress').textContent = order.shippingInfo
                    ? `${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state} ${order.shippingInfo.zipCode}`
                    : '';
                document.getElementById('modalShippingEmail').textContent = order.shippingInfo?.email || '';
                document.getElementById('modalOrderStatus').textContent = order.status || '';
            
                const labelLink = modalLabelUrl.querySelector('a');
                if (order.uspsLabelUrl) {
                    labelLink.href = order.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                } else modalLabelUrl.classList.add('hidden');

                const returnLabelLink = modalReturnLabelUrl.querySelector('a');
                if (order.returnLabelUrl) { // Check for new returnLabelUrl
                    returnLabelLink.href = order.returnLabelUrl;
                    modalReturnLabelUrl.classList.remove('hidden');
                } else modalReturnLabelUrl.classList.add('hidden');
            
                // Hide all action buttons and sections initially
                generateLabelBtn.classList.add('hidden');
                markReceivedBtn.classList.add('hidden');
                completeOrderBtn.classList.add('hidden');
                openReofferFormBtn.classList.add('hidden');
                openContactBuyerFormBtn.classList.add('hidden');
                reofferFormSection.classList.add('hidden');
                contactBuyerFormSection.classList.add('hidden');
                sendPhoneBackBtn.classList.add('hidden'); // Hide new button
                payNowBtn.classList.add('hidden'); // Hide new button


                // Show actions based on status
                if (order.status === 'pending_shipment') {
                    generateLabelBtn.classList.remove('hidden');
                } else if (order.status === 'label_generated') {
                    markReceivedBtn.classList.remove('hidden');
                } else if (order.status === 'received') {
                    completeOrderBtn.classList.remove('hidden');
                    openReofferFormBtn.classList.remove('hidden');
                    openContactBuyerFormBtn.classList.remove('hidden');
                } else if (order.status === 're-offered') { // Pending re-offer
                    completeOrderBtn.classList.remove('hidden');
                    openReofferFormBtn.classList.remove('hidden');
                    openContactBuyerFormBtn.classList.remove('hidden');
                    // Display re-offer details
                    reofferFormSection.classList.remove('hidden');
                    reofferFormSection.innerHTML = `
                        <h4 class="text-lg font-semibold mt-4 mb-2">Current Re-offer</h4>
                        <p><strong>New Price:</strong> $${order.reofferDetails.newPrice.toFixed(2)}</p>
                        <p><strong>Reason:</strong> ${order.reofferDetails.reason}</p>
                        <p class="text-sm text-gray-500 mt-2">Status: <span class="font-bold">${order.status}</span></p>
                        <p class="text-sm text-gray-500 mt-2">Awaiting buyer response.</p>
                    `;
                } else if (order.status === 'offer_accepted') { // Re-offer Accepted
                    completeOrderBtn.classList.remove('hidden');
                    openContactBuyerFormBtn.classList.remove('hidden');
                    payNowBtn.classList.remove('hidden'); // Show Pay Now button
                    // Display re-offer details
                    reofferFormSection.classList.remove('hidden');
                    reofferFormSection.innerHTML = `
                        <h4 class="text-lg font-semibold mt-4 mb-2">Accepted Offer Details</h4>
                        <p><strong>New Price:</strong> $${order.reofferDetails.newPrice.toFixed(2)}</p>
                        <p><strong>Reason:</strong> ${order.reofferDetails.reason}</p>
                        <p class="text-sm text-gray-500 mt-2">Status: <span class="font-bold">${order.status}</span></p>
                    `;
                } else if (order.status === 'return_requested') { // Re-offer Declined
                    completeOrderBtn.classList.remove('hidden');
                    openContactBuyerFormBtn.classList.remove('hidden');
                    sendPhoneBackBtn.classList.remove('hidden'); // Show Send Phone Back button
                    // Display re-offer details
                    reofferFormSection.classList.remove('hidden');
                    reofferFormSection.innerHTML = `
                        <h4 class="text-lg font-semibold mt-4 mb-2">Declined Offer Details</h4>
                        <p><strong>New Price:</strong> $${order.reofferDetails.newPrice.toFixed(2)}</p>
                        <p><strong>Reason:</strong> ${order.reofferDetails.reason}</p>
                        <p class="text-sm text-gray-500 mt-2">Status: <span class="font-bold">${order.status}</span></p>
                    `;
                } else if (order.status === 'completed') { // Completed order
                    payNowBtn.classList.remove('hidden'); // Show Pay Now button
                    openContactBuyerFormBtn.classList.remove('hidden');
                }
            
                orderDetailModal.classList.remove('hidden');
            }
            
            navItems.forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();

                    const isSubItem = item.classList.contains('sub-nav-item');
                    const parentItem = item.closest('ul').previousElementSibling;

                    // Deactivate all nav items and hide all sub-menus initially
                    navItems.forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.sub-menu').forEach(sub => sub.classList.add('hidden'));

                    // Set active class for the clicked item and its parent
                    item.classList.add('active');
                    if (isSubItem && parentItem) {
                        parentItem.classList.add('active');
                        item.closest('.sub-menu').classList.remove('hidden');
                    }

                    currentStatusFilter = item.dataset.status;
                    mainTitle.textContent = item.textContent.trim();

                    // If a main nav item is clicked, check for sub-menu
                    if (item.dataset.status === 'reoffered_parent') {
                        const subMenu = item.nextElementSibling;
                        if (subMenu) {
                            subMenu.classList.toggle('hidden');
                        }
                        // Do not filter when just opening the parent menu
                        ordersListContent.classList.add('hidden');
                        dashboardContent.classList.remove('hidden');
                        return;
                    }

                    // Otherwise, filter and render orders
                    filterAndRenderOrders();
                });
            });

            // Handle dashboard card clicks
            dashboardCards.forEach(card => {
                card.addEventListener('click', e => {
                    const status = card.dataset.status;
                    const navItem = document.querySelector(`.nav-item[data-status="${status}"]`);
                    if (navItem) {
                        // Simulate a click on the corresponding nav item to reuse logic
                        navItem.click();
                    }
                });
            });

            closeModalBtn.addEventListener('click', () => {
                orderDetailModal.classList.add('hidden');
                currentOrderId = null;
                currentOrderDetails = null;
                fetchAllOrders();
            });

            // Close modal when clicking outside the modal content
            orderDetailModal.addEventListener('click', (e) => {
                if (e.target.id === 'orderDetailModal') {
                    closeModalBtn.click();
                }
            });
            
            refreshOrdersBtn.addEventListener('click', () => {
                fetchAllOrders();
            });

            searchInput.addEventListener('input', () => {
                filterAndRenderOrders();
            });

            generateLabelBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Generating label...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/generate-label/${currentOrderId}`, { method: 'POST' });
                    const result = await resp.json();
                    if (!resp.ok) throw new Error(result.error || 'Failed to generate label');
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'label_generated';
                    modalLabelUrl.querySelector('a').href = result.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                    generateLabelBtn.classList.add('hidden');
                    markReceivedBtn.classList.remove('hidden');
                    fetchAllOrders(); // Refresh orders to update status in list
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            markReceivedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as received...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({status:'received'})
                    });
                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed');
                    showModalMessage(res.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'received';
                    markReceivedBtn.classList.add('hidden');
                    // Show new buttons for 'received' status
                    completeOrderBtn.classList.remove('hidden');
                    openReofferFormBtn.classList.remove('hidden');
                    openContactBuyerFormBtn.classList.remove('hidden');
                    fetchAllOrders(); // Refresh orders to update status in list
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            // Handle "Complete Order" button click
            completeOrderBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as completed...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({status:'completed'})
                    });
                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed');
                    showModalMessage(res.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'completed';
                    completeOrderBtn.classList.add('hidden');
                    openReofferFormBtn.classList.add('hidden');
                    openContactBuyerFormBtn.classList.add('hidden');
                    reofferFormSection.classList.add('hidden');
                    contactBuyerFormSection.classList.add('hidden');
                    payNowBtn.classList.remove('hidden'); // Show Pay Now button for completed
                    fetchAllOrders(); // Refresh orders to update status in list
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            // Toggle Re-offer form visibility
            openReofferFormBtn.addEventListener('click', () => {
                reofferFormSection.classList.toggle('hidden');
                contactBuyerFormSection.classList.add('hidden'); // Hide other form
                // Clear previous inputs
                reofferPriceInput.value = '';
                reofferReasonCheckboxes.forEach(checkbox => checkbox.checked = false);
                reofferAdditionalComment.value = '';
            });

            // Toggle Contact Buyer form visibility
            openContactBuyerFormBtn.addEventListener('click', () => {
                contactBuyerFormSection.classList.toggle('hidden');
                reofferFormSection.classList.add('hidden'); // Hide other form
                // Clear previous inputs
                emailSubjectInput.value = '';
                emailBodyInput.value = '';
            });

            // Submit New Re-offer button click
            submitNewReofferBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                const newPrice = reofferPriceInput.value;
                
                const selectedReasons = Array.from(reofferReasonCheckboxes)
                                             .filter(checkbox => checkbox.checked)
                                             .map(checkbox => checkbox.value);
                const additionalComment = reofferAdditionalComment.value.trim();
                
                let reason = selectedReasons.join(', ');
                if (additionalComment) {
                    reason += (reason ? '; ' : '') + additionalComment;
                }

                if (!newPrice || !reason) {
                    showModalMessage('Please enter a new price and at least one reason.', 'error');
                    return;
                }

                showModalMessage('Submitting new re-offer...', 'success');

                try {
                    const resp = await fetch(`${BACKEND_URL}/orders/${currentOrderId}/reoffer`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            newPrice: parseFloat(newPrice),
                            reason: reason
                        })
                    });

                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed to submit re-offer');

                    showModalMessage(res.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 're-offered';

                    // Update the reoffer section to show the submitted details
                    reofferFormSection.innerHTML = `
                        <h4 class="text-lg font-semibold mt-4 mb-2">Current Re-offer</h4>
                        <p><strong>New Price:</strong> $${parseFloat(newPrice).toFixed(2)}</p>
                        <p><strong>Reason:</strong> ${reason}</p>
                        <p class="text-sm text-gray-500 mt-2">Awaiting buyer response.</p>
                    `;
                    // Hide the other action buttons as re-offer is now pending
                    openReofferFormBtn.classList.add('hidden');
                    openContactBuyerFormBtn.classList.add('hidden');
                    completeOrderBtn.classList.remove('hidden'); // Still allow completion
                    fetchAllOrders(); // Refresh orders to update status in list
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            // Send Custom Email button click
            sendCustomEmailBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                const subject = emailSubjectInput.value.trim();
                const body = emailBodyInput.value.trim();

                if (!subject || !body) {
                    showModalMessage('Please enter both a subject and a message body for the email.', 'error');
                    return;
                }

                showModalMessage('Sending custom email...', 'success');

                try {
                    const resp = await fetch(`${BACKEND_URL}/orders/${currentOrderId}/send-custom-email`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ subject, body })
                    });

                    const res = await resp.json();
                    if (!resp.ok) throw new Error(res.error || 'Failed to send custom email');

                    showModalMessage(res.message, 'success');
                    // Optionally clear the form or hide it after sending
                    emailSubjectInput.value = '';
                    emailBodyInput.value = '';
                    contactBuyerFormSection.classList.add('hidden');
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            // NEW: Send Phone Back button click (for Declined offers)
            sendPhoneBackBtn.addEventListener('click', async () => {
                if (!currentOrderId || !currentOrderDetails) return;
                showModalMessage('Generating return label...', 'success');
                try {
                    const resp = await fetch(`${BACKEND_URL}/api/generate-return-label/${currentOrderId}`, { method: 'POST' });
                    const result = await resp.json();
                    if (!resp.ok) throw new Error(result.error || 'Failed to generate return label');
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'return_label_generated'; // Update status
                    modalReturnLabelUrl.querySelector('a').href = result.returnLabelUrl;
                    modalReturnLabelUrl.classList.remove('hidden');
                    sendPhoneBackBtn.classList.add('hidden'); // Hide button after generating
                    fetchAllOrders(); // Refresh orders to update status in list
                } catch (err) {
                    showModalMessage(`Error: ${err.message}`, 'error');
                }
            });

            // NEW: Pay Now button click (for Accepted and Completed orders)
            payNowBtn.addEventListener('click', () => {
                if (!currentOrderId || !currentOrderDetails) return;

                paymentModalOrderId.textContent = currentOrderId;
                paymentModalAmount.textContent = `$${currentOrderDetails.reofferDetails?.newPrice?.toFixed(2) || currentOrderDetails.estimatedQuote?.toFixed(2) || '0.00'}`;
                paymentModalMethod.textContent = currentOrderDetails.paymentMethod || 'N/A';
                paymentModalRecipient.textContent = currentOrderDetails.paymentDetails?.venmoUsername || currentOrderDetails.paymentDetails?.paypalEmail || 'N/A';
                
                paymentModalMessage.classList.add('hidden'); // Clear previous messages
                paymentModal.classList.remove('hidden'); // Show the payment modal
            });

            // Close Payment Modal
            closePaymentModalBtn.addEventListener('click', () => {
                paymentModal.classList.add('hidden');
            });

            // Initiate Payment button inside modal
            initiatePaymentBtn.addEventListener('click', () => {
                if (!currentOrderDetails) return;

                const amount = currentOrderDetails.reofferDetails?.newPrice || currentOrderDetails.estimatedQuote;
                const paymentMethod = currentOrderDetails.paymentMethod;
                const recipient = currentOrderDetails.paymentDetails?.venmoUsername || currentOrderDetails.paymentDetails?.paypalEmail;
                const orderNote = `Payment for SwiftBuyBack Order #${currentOrderId}`;

                let paymentLink = '';

                if (paymentMethod === 'Venmo' && recipient && amount) {
                    paymentLink = `venmo://pay?recipients=${recipient.replace('@', '')}&amount=${amount.toFixed(2)}&note=${encodeURIComponent(orderNote)}`;
                } else if (paymentMethod === 'PayPal' && recipient && amount) {
                    // PayPal.me link for direct payment (requires recipient to have a PayPal.me link)
                    // Or a more complex PayPal API integration for actual payment initiation.
                    // For simplicity, we'll use a generic link or instruct admin.
                    paymentLink = `https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=${recipient}&amount=${amount.toFixed(2)}&item_name=${encodeURIComponent(orderNote)}`;
                    paymentModalMessage.textContent = "Note: PayPal payment might require manual entry if recipient doesn't have PayPal.me or direct API is not set up.";
                    paymentModalMessage.classList.remove('hidden');
                } else {
                    paymentModalMessage.textContent = 'Unable to generate direct payment link. Please process manually.';
                    paymentModalMessage.classList.remove('hidden');
                    return;
                }

                if (paymentLink) {
                    window.open(paymentLink, '_blank'); // Open payment app/page
                    paymentModalMessage.textContent = 'Payment link opened. Please complete the transaction.';
                    paymentModalMessage.classList.remove('hidden');
                }
            });


            fetchAllOrders();
        });
    </script>
</body>
</html>