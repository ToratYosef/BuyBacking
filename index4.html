<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - Turn Your Old Phone Into Cash!</title>
    <meta name="description" content="Turn your old phone into cash with SecondHandCell. Get a quick, easy, and transparent quote for your iPhone, Samsung, and more. Free shipping and fast payment." />
    
    <!-- NEW: SEO Meta Tags -->
    <meta name="author" content="Saul Setton" />
    <meta name="keywords" content="sell used phone, trade in old phone, get cash for phone, sell iPhone, sell Samsung, secondhand cell, used device buyer, iPhone trade-in, Samsung trade-in" />
    <link rel="canonical" href="https://secondhandcell.com/" />
    <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />

    <!-- NEW: Schema.org JSON-LD Markup for Organization, WebSite (with Sitelinks Search Box), and Breadcrumbs -->
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "https://secondhandcell.com/#organization",
      "name": "SecondHandCell",
      "url": "https://secondhandcell.com/",
      "logo": "https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png",
      "sameAs": [
        "https://www.trustpilot.com/evaluate/secondhandcell.com",
        "https://www.yelp.com/writeareview/biz/KWMxMMypF1yAfwH1rdKgJw"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "https://secondhandcell.com/#website",
      "url": "https://secondhandcell.com/",
      "name": "SecondHandCell - Turn Your Old Phone Into Cash!",
      "description": "Get an instant, transparent, and hassle-free quote for your used iPhone, Samsung, and more. Free shipping and fast payment.",
      "publisher": { "@id": "https://secondhandcell.com/#organization" },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://secondhandcell.com/search/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      },
      "hasPart": [
        {
          "@type": "WebPage",
          "url": "https://secondhandcell.com/sell-device/",
          "name": "Get Instant Quote"
        },
        {
          "@type": "WebPage",
          "url": "https://secondhandcell.com/iphone/",
          "name": "Sell Your iPhone"
        },
        {
          "@type": "WebPage",
          "url": "https://secondhandcell.com/samsung/",
          "name": "Sell Your Samsung"
        }
      ]
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "SecondHandCell",
          "item": "https://secondhandcell.com/"
        }
      ]
    }
  ]
}
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-W3BM2JC8');</script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17534255111"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-17534255111');
        gtag('config', 'G-8JYPJDKSP8');
    </script>

    <!-- Trustpilot Widget Script (already included by user) -->
    <script type="text/javascript" src="//widget.trustpilot.com/bootstrap/v5/tp.widget.bootstrap.min.js" async></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700&family=Inter:wght@400;500;600&display=swap');

        /* Modern Minimalist Design */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #F5F6F8;
            color: #1F2937;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }
        
        /* Subtle glass effect - used sparingly */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(31, 41, 55, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(31, 41, 55, 0.08);
        }
        
        /* NEW: Fade-in animation for sections on scroll */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp { animation: fadeInUp 0.8s ease-out forwards; }
        
        .homepage-card-link:hover .homepage-card-inner,
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.15);
            border-color: #6366F1;
        }

        .homepage-card-inner, .feature-card {
            background: white;
            border: 1px solid rgba(31, 41, 55, 0.08);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
        }
        
        .card-container {
            background: white;
            border: 1px solid rgba(31, 41, 55, 0.08);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border-radius: 12px;
            padding: 2rem;
        }
        
        .accent-gradient {
            background: linear-gradient(135deg, #6366F1 0%, #22D3EE 100%);
        }
        
        .accent-gradient-warm {
            background: linear-gradient(135deg, #EC4899 0%, #F97316 100%);
        }

        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8;
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }

        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; visibility: hidden;
        }

        .modal.is-visible {
            opacity: 1; visibility: visible;
        }

        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }

        .modal.is-visible .modal-content {
            transform: translateY(0);
        }

        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .btn-google-style:hover { background-color: #f8fafc; }

        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }

        .btn-dark-slate:hover { background-color: #0f172a; }

        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }

        .btn-red-logout:hover { background-color: #fef2f2; }

        #chat-widget-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        #chat-open-btn {
            background-color: #2563eb; color: white;
            width: 4rem; height: 4rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            cursor: pointer; transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
        }

        #chat-open-btn:hover { transform: scale(1.1); }

        #unread-counter {
            position: absolute; top: -4px; right: -4px;
            background-color: #ef4444; color: white;
            border-radius: 9999px; font-size: 0.75rem; font-weight: bold;
            width: 1.5rem; height: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            transform: scale(0); transition: transform 0.2s ease-out;
        }

        #unread-counter.visible { transform: scale(1); }

        #chat-window {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24rem;
            height: 32rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        #chat-window.is-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #chat-window.is-visible + #chat-open-btn {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
        }

        #globalTooltip {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: fixed;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 0.75rem;
            pointer-events: none;
        }

        .typing-indicator { display: flex; align-items: center; padding: 8px 12px; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: #9ca3af; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .star-rating i { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating:hover i, .star-rating i.selected { color: #f59e0b; }
        .star-rating i:hover ~ i { color: #d1d5db; }
        
        .prose { max-width: 65ch; color: #334155; }
        .prose h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
        .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose p, .prose ul { margin-bottom: 1em; }
        .prose ul { list-style-position: inside; padding-left: 1em; }
        .prose li { margin-bottom: 0.5em; }

        .floating-banner {
            position: sticky;
            top: 7rem;
            z-index: 30;
            animation: slideIn 0.8s ease-out;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            width: 100%;
            box-sizing: border-box;
        }

        .floating-banner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 1rem 4rem 1rem 1rem;
        }

        .floating-banner-close {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .floating-banner-close:hover { color: #fca5a5; }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #google_cat_img_container {
            width: 6rem;
            height: 6rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
            margin-bottom: 1rem;
        }
        #google_cat_img {
            transform: scale(1.2);
            object-fit: contain;
            width: 100%;
            height: 100%;
        }


        .order-card {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: #f1f5f9;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .order-card:hover { background-color: #e2e8f0; }

        .order-card-details { flex-grow: 1; font-size: 0.875rem; }
        .order-card-details strong { display: block; font-weight: 600; color: #1e293b; }
        .order-card-details span { color: #475569; }
        .order-card-details .reoffer { color: #ef4444; font-weight: 600; }

        /* HERO SECTION - Clean Modern */
        .hero-section {
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            position: relative;
            padding-top: 8rem;
            padding-bottom: 8rem;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(34, 211, 238, 0.15) 100%);
            border-radius: 0 0 0 100%;
            z-index: 1;
        }
        .hero-content {
            position: relative;
            z-index: 2;
        }
        
        .hero-section h1 {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.1;
            color: white;
        }
        
        .hero-section p {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* NEW Base class for ghosted phones on desktop */
        .hero-phone-ghost {
            position: absolute;
            top: 50%;
            height: auto;
            opacity: 0.2;
            filter: grayscale(100%) brightness(150%);
            z-index: 1;
            transition: all 0.5s ease-in-out;
            /* Adjust size for responsiveness based on 500px width/250px height ratio of iPhone */
            max-width: 500px; 
        }
        
        /* iPhone 15 Pro Max (200x250 ratio, using 500px width for max size) */
        #iphone-ghost {
            width: 500px;
            /* iPhone width is 200 units, height is 250 units. Ratio 200/250 = 0.8. If max-width=500, then max-height = 500/0.8 = 625px. We set width to 500px to maintain size. */
            right: 0; 
            transform: translateY(-50%) translateX(20%);
        }

        /* Samsung S24 Ultra (216x216 ratio, adjusting relative to iPhone size)
           iPhone width (200) is 0.926 * Samsung width (216). 
           We want the Samsung image to scale relative to the 500px wide iPhone image. 
           New Samsung width should be roughly (500 / 0.8) * 0.926 * (216/216 ratio correction) ~ 578px at full height, but let's maintain a similar large, ghostly visual presence by using the same base width. 
           Since the ratio is 216/216=1, the effective relative size should be slightly larger than the iPhone.
           Let's use a 550px width for the Samsung to slightly increase its visual presence and maintain proportion. 
        */
        #samsung-ghost {
            width: 550px; /* Slightly wider than the iPhone image for presence */
            left: 0;
            transform: translateY(-50%) translateX(-20%);
            /* IMPORTANT: Removed scaleX(-1) to un-mirror the image. */
        }
        
        .action-button {
            background: linear-gradient(135deg, #6366F1 0%, #22D3EE 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        

        /* NEW: Style for the review link cards */
        .review-link-card:hover .card-container {
            transform: scale(1.02);
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 767px) {
            /* Hiding the large ghosted phones on mobile */
            .hero-phone-ghost {
                display: none;
            }
            .hero-section {
                padding-top: 4rem;
                padding-bottom: 4rem;
            }
            .hero-section h1 {
                font-size: 2.25rem;
            }
            .hero-section p {
                font-size: 1rem;
            }
            .hero-section a {
                padding: 0.75rem 2rem;
            }
            #chat-window {
                position: fixed;
                width: 100vw;
                height: 100vh;
                top: 0;
                left: 0;
                border-radius: 0;
                box-shadow: none;
                transform: none;
            }
        }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W3BM2JC8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <header class="glass-nav sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex items-center md:py-5 justify-between">
            <div class="flex-1 flex justify-start items-center logo-container-left">
                <a href="#" class="h-12 md:h-20 w-auto">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png" alt="SecondHandCell Logo" class="h-full w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <div class="flex-none flex-col items-center hidden md:flex logo-text-container-center">
                <div class="text-xl md:text-2xl font-extrabold whitespace-nowrap">
                    <span class="text-black">Second</span><span class="text-green-500">HandCell</span>
                </div>
                <p class="text-[0.6rem] md:text-sm -mt-1 whitespace-nowrap text-green-500">Turn Your Old<span class="text-black"> Phone Into Cash!</span></p>
            </div>
            <nav class="flex-1 flex justify-end items-center space-x-4">
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="accent-gradient text-white px-2.5 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold hover:opacity-90 transition-all duration-300 shadow-sm text-xs md:text-base">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden rounded-lg shadow-xl">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout rounded-b-lg">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <main>
        <section class="hero-section text-center">
            <!-- iPhone Ghosted Container (Right Side - Desktop Only) -->
            <div id="iphone-ghost" class="hero-phone-ghost animate-pulse">
                <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i15pm.webp" alt="iPhone 15 Pro Max" class="w-full h-auto">
            </div>
            <!-- Samsung Ghosted Container (Left Side - Desktop Only) -->
            <div id="samsung-ghost" class="hero-phone-ghost animate-pulse">
                <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s24u.webp" alt="Samsung Galaxy S24 Ultra" class="w-full h-auto">
            </div>

            <div class="container mx-auto px-4 hero-content">
                <!-- Mobile-only Image (Centered) -->
                <div class="block md:hidden mb-8">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i15pm.webp" alt="iPhone 15 Pro Max" class="mx-auto w-32 h-auto animate-pulse">
                </div>
                
                <h1 class="text-5xl md:text-7xl font-extrabold text-white mb-4 leading-tight">
                    Turn Yesterday‚Äôs Phone Into Today‚Äôs Cash.
                </h1>
                <p class="max-w-3xl mx-auto text-lg md:text-xl text-gray-200 mb-8">
                    Get an instant, transparent, and hassle-free quote for your used iPhone, Samsung, and more.
                </p>
                <button id="heroOfferBtn" class="action-button text-white px-10 py-4 rounded-xl font-semibold text-lg inline-block">
                    Get My Instant Offer
                </button>
                <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-8 mt-12 text-center text-white">
                    <div>
                        <p class="text-4xl font-extrabold">100K+</p>
                        <p class="text-sm uppercase tracking-wide">Devices Bought</p>
                    </div>
                    <div>
                        <p class="text-4xl font-extrabold">98%</p>
                        <p class="text-sm uppercase tracking-wide">Customer Satisfaction</p>
                    </div>
                    <div>
                        <p class="text-4xl font-extrabold">$400+</p>
                        <p class="text-sm uppercase tracking-wide">Avg. Payout</p>
                    </div>
                    <div>
                        <p class="text-4xl font-extrabold">24H</p>
                        <p class="text-sm uppercase tracking-wide">Fast Payment</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW: Background changed to a light slate, added animation class -->
        <section id="features" class="bg-slate-50 container mx-auto px-4 py-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Why Sell With Us?</h2>
                <p class="mt-3 text-lg text-slate-600">Our process is simple, safe, and gets you the most for your device.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üì¶</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-shipping-btn">Free Shipping Kit</h3><p class="text-slate-600">We send you a prepaid box. Just pack your device and drop it in the mail.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üí∏</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-payment-btn">Fast Payment</h3><p class="text-slate-600">Get paid quickly via Venmo, Zelle, or PayPal as soon as we inspect your device.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üõ°Ô∏è</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-data-btn">Data Protection</h3><p class="text-slate-600">We professionally wipe all personal data from every device we receive.</p></div>
                <div class="animate-on-scroll feature-card card-container text-center"><div class="mx-auto mb-4 w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-3xl text-blue-600">üîí</div><h3 class="text-xl font-semibold mb-2 text-slate-800" id="feature-payout-btn">Highest Payouts</h3><p class="text-slate-600">Our price-lock guarantee ensures you get the quote you were offered.</p></div>
            </div>
        </section>

        <!-- NEW: Background changed to white, added animation class -->
        <section id="popular" class="bg-white py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Popular Devices We Buy</h2>
                    <p class="mt-3 text-lg text-slate-600">From the latest models to older favorites, we buy them all.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                    <a href="sell/?device=iphone-15-pro-max" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="i15pm_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i15pm" alt="iPhone 15 Pro Max" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 15 Pro Max</h3><p class="accent-gradient-warm bg-clip-text text-transparent font-bold mb-4">Up to $700</p><span id="popularOfferBtn-i15pm" class="bg-gray-100 text-gray-800 px-6 py-2 rounded-lg font-medium mt-auto w-full group-hover:bg-gradient-to-r group-hover:from-indigo-500 group-hover:to-cyan-400 group-hover:text-white transition-all duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=samsung-galaxy-s24-ultra" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="s24u_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s24u" alt="Samsung Galaxy S24 Ultra" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S24 Ultra</h3><p class="accent-gradient-warm bg-clip-text text-transparent font-bold mb-4">Up to $600</p><span id="popularOfferBtn-s24u" class="bg-gray-100 text-gray-800 px-6 py-2 rounded-lg font-medium mt-auto w-full group-hover:bg-gradient-to-r group-hover:from-indigo-500 group-hover:to-cyan-400 group-hover:text-white transition-all duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=iphone-16" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="i13_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i16" alt="iPhone 16" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">iPhone 16</h3><p class="accent-gradient-warm bg-clip-text text-transparent font-bold mb-4">Up to $532</p><span id="popularOfferBtn-i13" class="bg-gray-100 text-gray-800 px-6 py-2 rounded-lg font-medium mt-auto w-full group-hover:bg-gradient-to-r group-hover:from-indigo-500 group-hover:to-cyan-400 group-hover:text-white transition-all duration-300 text-sm">Get Offer</span></div></a>
                    <a href="sell/?device=samsung-galaxy-s22" class="animate-on-scroll homepage-card-link group"><div class="homepage-card-inner card-container text-center flex flex-col h-full"><img id="s22_pop_img" src="" data-base-src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s22" alt="Samsung Galaxy S22" class="mx-auto mb-4 h-40 object-contain"><h3 class="text-xl font-semibold mb-2 text-slate-800">Samsung Galaxy S22</h3><p class="accent-gradient-warm bg-clip-text text-transparent font-bold mb-4">Up to $250</p><span id="popularOfferBtn-s22" class="bg-gray-100 text-gray-800 px-6 py-2 rounded-lg font-medium mt-auto w-full group-hover:bg-gradient-to-r group-hover:from-indigo-500 group-hover:to-cyan-400 group-hover:text-white transition-all duration-300 text-sm">Get Offer</span></div></a>
                </div>
            </div>
        </section>

        <!-- REVIEW PLATFORM SECTION (Replaces old hardcoded testimonials) -->
        <section id="external-reviews" class="bg-slate-100 py-20">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800">Trusted By Thousands</h2>
                    <p class="mt-3 text-lg text-slate-600">See our latest reviews and ratings on external, independent platforms.</p>
                </div>

                <!-- 1. Review Platform Links (Adjusted to 3 columns: Google, Trustpilot, Yelp) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 max-w-4xl mx-auto">
                    
                    <!-- Google Reviews Card - NOW BLUE -->
                    <a href="https://search.google.com/local/reviews?placeid=YOUR_GOOGLE_PLACE_ID" target="_blank" id="google-review-link" class="animate-on-scroll review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all group-hover:shadow-xl border-t-4 border-blue-600">
                            <div class="w-16 h-16 mb-3 flex items-center justify-center">
                                <!-- Google G Logo placeholder (Using a common SVG link for visual appeal) -->
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg" alt="Google Logo" class="h-10 w-auto">
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Google Reviews</h3>
                            <p class="text-sm text-slate-500">Read our public customer reviews.</p>
                            <span class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold group-hover:bg-blue-700 transition">See Reviews</span>
                        </div>
                    </a>

                    <!-- Trustpilot Card -->
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" id="trustpilot-review-link" class="animate-on-scroll review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all group-hover:shadow-xl border-t-4 border-emerald-500">
                            <div class="w-16 h-16 mb-3 flex items-center justify-center text-4xl text-emerald-600">
                                <i class="fa-solid fa-star-half-stroke"></i> <!-- Font Awesome Placeholder -->
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Trustpilot</h3>
                            <p class="text-sm text-slate-500">Check our verified customer feedback.</p>
                            <span class="mt-4 bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-semibold group-hover:bg-emerald-600 transition">View Profile</span>
                        </div>
                    </a>

                    <!-- Yelp Card -->
                    <a href="https://www.yelp.com/writeareview/biz/KWMxMMypF1yAfwH1rdKgJw" target="_blank" id="yelp-review-link" class="animate-on-scroll review-link-card group">
                        <div class="card-container text-center flex flex-col items-center justify-center p-6 h-full transition-all group-hover:shadow-xl border-t-4 border-red-500">
                            <div class="w-16 h-16 mb-3 flex items-center justify-center text-4xl text-red-600">
                                <i class="fa-brands fa-yelp"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">Yelp</h3>
                            <p class="text-sm text-slate-500">Write a Review on Yelp.</p>
                            <span class="mt-4 bg-red-500 text-white px-4 py-2 rounded-full text-sm font-semibold group-hover:bg-red-600 transition">Go to Yelp</span>
                        </div>
                    </a>
                    
                </div>
            </div>
            <!-- Removed the optional Trustpilot Embed section content below the links -->
        </section>

        <section class="bg-white py-16 md:py-24">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-6">Ready to Sell?</h2>
                <p class="max-w-xl mx-auto text-lg text-slate-600 mb-8">
                    Start the process now and get cash for your device in as little as 24 hours.
                </p>
                <a href="sell-device.html" id="finalOfferBtn" class="animate-on-scroll bg-indigo-600 text-white px-10 py-5 rounded-full font-bold text-xl shadow-2xl hover:bg-indigo-700 transition-transform duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 inline-block">
                    Sell Device Now! <i class="fa-solid fa-arrow-right-long ml-2"></i>
                </a>
            </div>
        </section>
    </main>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links</h3><ul class="space-y-2"><li><a href="#" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" id="footerSignupBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mt-8 text-center border-2 border-red-600">
                <p class="text-lg font-bold">IMPORTANT NOTICE</p>
                <p class="mt-2 text-sm md:text-base">We do not purchase blacklisted or lost/stolen devices. All devices are verified through a legal compliance check.</p>
            </div>
                        <!-- Trust & accreditation badges -->
            <div class="mt-8">
                <div class="flex flex-wrap items-center justify-center gap-6 sm:flex-row sm:justify-center sm:gap-8 lg:justify-start">
                    <a href="https://www.sellcell.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://c9ac71a8282e1fecd95e-f07dbcddcacf0d4c572ea7178ee6902d.ssl.cf2.rackcdn.com/assets/images/share/sellcell-accredited-buyer.png" width="150" height="107" alt="SellCell Accredited Buyer" loading="lazy" class="h-20 w-auto object-contain">
                    </a>
                    <a href="https://www.trustpilot.com/evaluate/secondhandcell.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center">
                        <img src="https://cdn.trustpilot.net/brand-assets/4.1.0/stars/stars-5.png" alt="Trustpilot 5 star rating" loading="lazy" class="h-12 w-auto object-contain">
                    </a>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <div id="loginModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative modal-content"><button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Your SecondHandCell Account</h2><div class="flex border-b border-slate-200 mb-6"><button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Login</button><button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Sign Up</button></div><form id="loginForm" class="space-y-4"><p class="text-slate-600 text-center">Log in to continue with your order.</p><button type="button" id="googleLoginBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Login with Google</button><div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div><div><label for="loginEmail" class="sr-only">Email Address</label><input type="email" id="loginEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="loginPassword" class="sr-only">Password</label><input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password"></div><button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button><p class="text-center text-sm text-slate-600">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-blue-600 font-semibold hover:underline">Reset it here</a></p></form><form id="signupForm" class="space-y-4 hidden"><p class="text-slate-600 text-center">Create an account to complete your order.</p><button type="button" id="googleSignupBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Sign Up with Google</button><div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div><div><label for="signupName" class="sr-only">Full Name</label><input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="signupEmail" class="sr-only">Email Address</label><input type="email" id="signupEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email"></div><div><label for="signupPassword" class="sr-only">Password</label><input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password"></div><button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button><p class="text-center text-sm text-slate-600">Already have an account? <a href="#" id="switchToLogin" class="text-blue-600 font-semibold hover:underline">Log in here</a></p></form><form id="forgotPasswordForm" class="space-y-4 hidden"><p class="text-slate-600 text-center">Enter your email to receive a password reset link.</p><div><label for="forgotEmail" class="sr-only">Email Address</label><input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button><p class="text-center text-sm text-slate-600">Remember your password? <a href="#" id="returnToLogin" class="text-blue-600 font-semibold hover:underline">Return to Login</a></p></form><div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div></div></div>
    <div id="aboutUsModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);"><div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative modal-content"><button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button><h2 class="text-2xl font-bold text-slate-800 mb-4">About Us</h2><p class="text-slate-600">Welcome to SecondHandCell, where we believe in giving old tech a new life. Our mission is to make selling your used devices as simple, safe, and rewarding as possible. We offer competitive prices, a hassle-free process, and a commitment to sustainability.</p></div></div>

    <div id="chat-widget-container">
        <div id="chat-window">
            <div class="bg-blue-700 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Customer Support</h3>
                <div class="flex items-center space-x-2">  <button id="chat-order-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="View My Orders">
                        <i class="fa-solid fa-box-open text-xl"></i>
                    </button>
                    <button id="chat-minimize-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="Minimize Chat">
                        <i class="fa-solid fa-minus text-xl"></i>
                    </button>
                    <button id="chat-close-btn" class="chat-header-button text-white hover:text-blue-200" data-tooltip-text="End Chat">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
            </div>

            <div id="chat-messages" class="bg-slate-50"></div>

            <div id="order-selection-container" class="p-4 border-t border-slate-200 bg-white hidden">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm text-slate-600 font-semibold" id="order-selection-prompt">Please select your order:</p>
                    <button id="close-order-selection-btn" class="chat-header-button text-slate-400 hover:text-slate-600 transition-colors duration-200" data-tooltip-text="Close Order Selection">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div id="order-list" class="space-y-2 max-h-48 overflow-y-auto">
                </div>
            </div>

            <div id="typing-indicator-container" class="p-2 hidden">
                <div class="p-3 rounded-lg max-w-[85%] mb-2 break-words chat-bubble-agent">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            </div>

            <div id="chat-input-container" class="p-4 border-t border-slate-200 flex items-center">
                <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mr-2">
                <button id="send-message-btn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm" data-tooltip-text="Send Message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <div id="guest-prompt-container" class="p-4 border-t border-slate-200 hidden">
                <p class="text-center text-sm text-slate-600 mb-3">To provide the best support, please log in or continue as a guest.</p>
                <div class="space-y-2">
                    <button id="guest-login-btn" class="btn-dark-slate">Login / Sign Up</button>
                    <button id="guest-continue-btn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Ask a General Question</button>
                </div>
            </div>

            <div id="chat-survey-container" class="p-4 border-t border-slate-200 hidden overflow-y-auto">
                <p class="text-center font-semibold mb-2">The agent has ended the chat.</p>
                <p class="text-center text-sm text-slate-600 mb-4">Please rate your experience.</p>
                <form id="chat-survey-form">
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Overall Rating:</label>
                        <div id="star-rating" class="star-rating text-3xl flex justify-center" data-rating="0">
                            <i class="fa-solid fa-star" data-value="1"></i><i class="fa-solid fa-star" data-value="2"></i><i class="fa-solid fa-star" data-value="3"></i><i class="fa-solid fa-star" data-value="4"></i><i class="fa-solid fa-star" data-value="5"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="friendliness-rating" class="font-semibold text-slate-700 block mb-2">Agent Friendliness: <span id="friendliness-value" class="font-bold text-blue-600">5</span>/10</label>
                        <input type="range" id="friendliness-rating" min="1" max="10" value="5" class="w-full">
                    </div>
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Was your issue resolved?</label>
                        <div class="flex justify-center gap-4">
                            <label><input type="radio" name="issue-resolved" value="yes" class="mr-1"> Yes</label>
                            <label><input type="radio" name="issue-resolved" value="no" class="mr-1"> No</label>
                        </div>
                    </div>
                    <div class="mb-4">
                            <label for="survey-comments" class="font-semibold text-slate-700 block mb-2">Additional Comments (optional):</label>
                            <textarea id="survey-comments" rows="2" class="w-full border border-slate-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="btn-dark-slate">Submit Feedback</button>
                </form>
            </div>

            <div id="end-chat-confirm-modal" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center p-4 z-10">
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
                    <p class="text-lg font-semibold text-slate-800 mb-4">End this chat session?</p>
                    <div class="flex gap-4 justify-center">
                        <button id="end-chat-yes" class="px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition">Yes, End Chat</button>
                        <button id="end-chat-no" class="px-6 py-2 font-semibold text-slate-800 bg-slate-200 rounded-lg hover:bg-slate-300 transition">No</button>
                    </div>
                </div>
            </div>
        </div>
        <button id="chat-open-btn">
            <i class="fa-solid fa-comments text-3xl"></i>
            <span id="unread-counter">0</span>
        </button>
    </div>

    <!-- Pricing Modal -->
    <div id="pricingModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative modal-content">
            <button class="close-modal-btn absolute top-4 right-4 z-10 text-slate-400 hover:text-slate-600 transition-colors duration-200">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <div class="p-6 md:p-8">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Get Your Instant Quote</h2>
                <p class="text-gray-600 mb-6">Answer a few quick questions to see what your device is worth</p>

                <!-- Brand Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Brand</label>
                    <div class="relative">
                        <img id="brand-icon" src="" alt="" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 hidden pointer-events-none">
                        <select id="modal-brand-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-900 focus:outline-none focus:border-indigo-500 bg-white" style="padding-left: 2.5rem;">
                            <option value="">Choose a brand...</option>
                            <option value="iphone" data-icon="https://cdn-icons-png.flaticon.com/512/0/747.png">Apple iPhone</option>
                            <option value="samsung" data-icon="https://www.samsung.com/etc.clientlibs/samsung/clientlibs/consumer/global/clientlib-common/resources/images/Favicon.png">Samsung</option>
                        </select>
                    </div>
                </div>

                <!-- Device Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Device</label>
                    <select id="modal-device-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-900 focus:outline-none focus:border-indigo-500 bg-white" disabled>
                        <option value="">Choose a device...</option>
                    </select>
                </div>

                <!-- Storage & Carrier -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Storage</label>
                        <select id="modal-storage-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-900 focus:outline-none focus:border-indigo-500 bg-white" disabled>
                            <option value="">Select storage...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Carrier</label>
                        <select id="modal-carrier-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-900 focus:outline-none focus:border-indigo-500 bg-white">
                            <option value="unlocked">Unlocked</option>
                            <option value="verizon">Verizon</option>
                            <option value="att">AT&T</option>
                            <option value="tmobile">T-Mobile</option>
                            <option value="other">Other/Locked</option>
                        </select>
                    </div>
                </div>

                <!-- Condition: Power -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Does it turn on?</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" data-condition="power" data-value="yes" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-power-off text-3xl text-green-500 mb-2"></i>
                            <span class="font-medium text-gray-900">Yes</span>
                        </button>
                        <button type="button" data-condition="power" data-value="no" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-power-off text-3xl text-red-500 mb-2"></i>
                            <span class="font-medium text-gray-900">No</span>
                        </button>
                    </div>
                </div>

                <!-- Condition: Functionality -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Device Functionality 
                        <i id="functionalDetailsIcon" class="fas fa-info-circle text-indigo-500 cursor-pointer ml-1 hover:text-indigo-700 transition-colors" title="Click for details"></i>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" data-condition="functionality" data-value="working" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
                            <span class="font-medium text-gray-900">Working</span>
                        </button>
                        <button type="button" data-condition="functionality" data-value="not-working" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-times-circle text-3xl text-red-500 mb-2"></i>
                            <span class="font-medium text-gray-900">Not Working</span>
                        </button>
                    </div>
                </div>

                <!-- Condition: Quality -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Device Quality</label>
                    <div class="grid grid-cols-3 gap-4">
                        <button type="button" data-condition="quality" data-value="flawless" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-star text-3xl text-green-500 mb-2"></i>
                            <span class="font-medium text-gray-900 text-sm">Flawless</span>
                        </button>
                        <button type="button" data-condition="quality" data-value="scratched" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-2"></i>
                            <span class="font-medium text-gray-900 text-sm">Scratched</span>
                        </button>
                        <button type="button" data-condition="quality" data-value="damaged" class="condition-btn border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center justify-center transition-all hover:border-indigo-500 hover:bg-indigo-50">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-2"></i>
                            <span class="font-medium text-gray-900 text-sm">Damaged/Cracked</span>
                        </button>
                    </div>
                </div>

                <!-- Price Estimate -->
                <div id="modal-price-estimate" class="hidden bg-gradient-to-r from-indigo-500 to-cyan-500 rounded-xl p-6 text-white mb-6">
                    <div class="text-center">
                        <p class="text-sm font-medium mb-2">Your Device is Worth</p>
                        <p class="text-5xl font-bold mb-4">$<span id="modal-estimated-price">0</span></p>
                        <button id="modal-continue-btn" class="bg-white text-indigo-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                            Continue to Sell
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fully Functional Definition Modal -->
    <div id="fullyFunctionalModal" class="modal fixed inset-0 z-[1001] flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-xl p-6 relative modal-content">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">What does "Fully Functional" mean?</h2>
            <div class="modal-content-body">
                <div class="max-w-none text-left">
                    <p class="font-semibold text-lg text-indigo-700 mb-3">For a device to qualify as "Fully Functional", all of the following criteria must be met and pass our certified inspection:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2 text-slate-700">
                        <li><strong>Screen & Display:</strong> The screen must work and fully light up (no dead pixels, discoloration, persistent image burn, or black dots/LCD damage).</li>
                        <li><strong>Original Parts:</strong> The device must contain all original manufacturer parts. Devices with third-party, non-original, or aftermarket replacement parts will be considered "Not Functional" or "Damaged."</li>
                        <li><strong>Key Features:</strong> All exterior buttons (power, volume, mute), front/back camera and flashes, speakers, and microphones must function correctly.</li>
                        <li><strong>Connectivity & Ports:</strong> Headphone jack, charging port, Cellular, Wi-Fi, Bluetooth, and GPS must all work.</li>
                        <li><strong>Biometrics & Touch:</strong> The touchscreen, voice commands, facial recognition (Face ID), and fingerprint sensor (Touch ID) must be fully operational.</li>
                        <li><strong>Battery Health:</strong> The battery must hold a sufficient charge for normal operation.</li>
                    </ul>
                    <p class="mt-4 text-sm text-red-600 font-medium">If your device fails any of these checks, please select "Not Working" to the functionality question for an accurate revised offer.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="globalTooltip" class="tooltip-text"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, setDoc, getDocs, runTransaction, increment, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // setLogLevel('debug');
        
        // --- START: USER'S EXPLICIT FIREBASE CONFIG ---
        // Removed global variables based on user request.
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            databaseURL: "https://buyback-a0f05-default-rtdb.firebaseio.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        // --- END: USER'S EXPLICIT FIREBASE CONFIG ---

        // Initialize Firebase with the provided config
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // This function would typically rely on the global initialAuthToken for immediate sign-in.
        // Since we removed it, we'll ensure unauthenticated users are treated as guests/anonymous.
        const getOrCreateGuestId = () => {
            let id = localStorage.getItem('guestChatId');
            if (!id) {
                id = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                localStorage.setItem('guestChatId', id);
            }
            return id;
        };


        // --- Firebase Click Tracker Function ---
        const trackButtonClick = async (buttonName) => {
            const cleanedButtonName = buttonName.replace(/\s/g, '_').replace(/'/g, '');
            const buttonDocRef = doc(db, "button_clicks", cleanedButtonName);
            // Updated to ensure userId is retrieved safely after auth state change.
            const userId = auth.currentUser?.uid || getOrCreateGuestId(); 
            const now = new Date().toISOString();

            try {
                await runTransaction(db, async (transaction) => {
                    const buttonDoc = await transaction.get(buttonDocRef);
                    if (!buttonDoc.exists()) {
                        transaction.set(buttonDocRef, {
                            count: 1,
                            buttonName: buttonName,
                            history: [{ timestamp: now, userId: userId }],
                            lastClicked: now
                        });
                    } else {
                        const data = buttonDoc.data();
                        const updatedHistory = [...(data.history || []), { timestamp: now, userId: userId }];
                        transaction.update(buttonDocRef, {
                            count: increment(1),
                            history: updatedHistory,
                            lastClicked: now
                        });
                    }
                });
                console.log(`Click on '${buttonName}' successfully tracked and updated.`);
            } catch (error) {
                console.error("Transaction failed: ", error);
            }
        };
        // ----------------------------------------

        document.addEventListener('DOMContentLoaded', function() {
            // Initial sign-in with custom token or anonymously
            onAuthStateChanged(auth, async (user) => {
                // Since initialAuthToken is removed, we only check for existing user and sign in anonymously if none exists.
                if (!user) {
                    try { await signInAnonymously(auth); } catch (e) { console.error("Anonymous sign-in failed:", e); }
                }
            });

            function loadImageWithFallback(imgElement) {
                const baseSrc = imgElement.dataset.baseSrc;
                if (!baseSrc) return;
                const extensions = ['.webp','.svg', '.avif', '.png', '.jpeg', '.jpg', '.svg'];
                let current = 0;
                function tryLoad() {
                    if (current >= extensions.length) {
                        if (imgElement.id.includes('_cat_img')) { imgElement.src = `https://placehold.co/150x150/e0e7ff/4338ca?text=Category`; }
                        else { imgElement.src = `https://placehold.co/200x200/f0f4ff/6366f1?text=No+Image`; }
                        imgElement.alt = "Image not available";
                        return;
                    }
                    const testSrc = baseSrc + extensions[current];
                    const img = new Image();
                    img.onload = () => { imgElement.src = testSrc; };
                    img.onerror = () => { current++; tryLoad(); };
                    img.src = testSrc;
                }
                tryLoad();
            }
            document.querySelectorAll('img[data-base-src]').forEach(loadImageWithFallback);

            const modals = document.querySelectorAll('.modal');
            const openModal = (modalId) => document.getElementById(modalId)?.classList.add('is-visible');
            const closeModal = (modal) => modal.classList.remove('is-visible');

            document.getElementById('loginNavBtn').addEventListener('click', (e) => { e.preventDefault(); openModal('loginModal'); });
            document.getElementById('aboutUsLink').addEventListener('click', (e) => { e.preventDefault(); openModal('aboutUsModal'); });
            document.getElementById('functionalDetailsIcon')?.addEventListener('click', (e) => { e.preventDefault(); openModal('fullyFunctionalModal'); });

            modals.forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
                modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
            });

            document.getElementById('heroOfferBtn').addEventListener('click', () => {
                trackButtonClick('Hero_Get_Instant_Offer');
                openModal('pricingModal');
            });
            document.getElementById('finalOfferBtn')?.addEventListener('click', () => trackButtonClick('Final_Sell_Device_Now'));

            document.querySelectorAll('.feature-card h3').forEach(card => {
                card.addEventListener('click', () => {
                    trackButtonClick(`Feature_Card_${card.textContent.trim()}`);
                });
            });
            
            document.querySelectorAll('.homepage-card-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    const deviceName = e.currentTarget.querySelector('h3').textContent;
                    trackButtonClick(`Popular_Device_Get_Offer_${deviceName}`);
                });
            });
            
            // NEW: Click handlers for external review links
            document.querySelectorAll('.review-link-card').forEach(link => {
                link.addEventListener('click', () => {
                    const platformName = link.querySelector('h3').textContent;
                    trackButtonClick(`External_Review_Click_${platformName.replace(/\s/g, '_')}`);
                });
            });

            const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
            const footerSignupMessage = document.getElementById('footerSignupMessage');
            footerEmailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('footerPromoEmail').value;
                footerSignupMessage.textContent = 'Submitting...';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-blue-300';
                
                try {
                    await addDoc(collection(db, "signed_up_emails"), {
                        email: email,
                        timestamp: new Date()
                    });
                    footerSignupMessage.textContent = 'Success! Thanks for signing up.';
                    footerSignupMessage.className = 'mt-3 text-sm text-center text-green-300';
                    footerEmailSignupForm.reset();
                    trackButtonClick('Footer_Email_Signup');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    footerSignupMessage.textContent = 'Error: Could not sign up.';
                    footerSignupMessage.className = 'mt-3 text-sm text-center text-red-300';
                }
            });

            const authStatusContainer = document.getElementById('authStatusContainer');
            const userMonogram = document.getElementById('userMonogram');
            const authDropdown = document.getElementById('authDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const signupTabBtn = document.getElementById('signupTabBtn');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const authMessage = document.getElementById('authMessage');

            const showTab = (tabName) => {
                authMessage.classList.add('hidden');
                [loginForm, signupForm, forgotPasswordForm].forEach(form => form.classList.add('hidden'));
                [loginTabBtn, signupTabBtn].forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-slate-500');
                });
                if (tabName === 'login') { loginForm.classList.remove('hidden'); loginTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
                else if (tabName === 'signup') { signupForm.classList.remove('hidden'); signupTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
                else if (tabName === 'forgotPassword') { forgotPasswordForm.classList.remove('hidden'); }
            };

            const showAuthMessage = (msg, type) => {
                authMessage.textContent = msg;
                authMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center w-full';
                if (type === 'error') authMessage.classList.add('bg-red-100', 'text-red-700');
                else if (type === 'success') authMessage.classList.add('bg-green-100', 'text-green-700');
                else authMessage.classList.add('bg-blue-100', 'text-blue-700');
                authMessage.classList.remove('hidden');
            };

            loginTabBtn.addEventListener('click', () => showTab('login'));
            signupTabBtn.addEventListener('click', () => showTab('signup'));
            document.getElementById('switchToLogin').addEventListener('click', (e) => { e.preventDefault(); showTab('login'); });
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); showTab('forgotPassword'); });
            document.getElementById('returnToLogin').addEventListener('click', (e) => { e.preventDefault(); showTab('login'); });

            const googleProvider = new GoogleAuthProvider();
            const signInWithGoogle = async () => {
                try {
                    showAuthMessage('Redirecting to Google...', 'info');
                    await signInWithPopup(auth, googleProvider);
                } catch (error) { showAuthMessage(`Google sign-in failed: ${error.message}`, 'error'); }
            };
            document.getElementById('googleLoginBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('googleSignupBtn').addEventListener('click', signInWithGoogle);

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    showAuthMessage('Logging in...', 'info');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) { showAuthMessage(`Login failed: ${error.message}`, 'error'); }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value.trim().toLowerCase();
                const password = document.getElementById('signupPassword').value;
                if (password.length < 6) { showAuthMessage('Password must be at least 6 characters.', 'error'); return; }
                try {
                    showAuthMessage('Creating account...', 'info');
                    
                    const emailQuery = query(collection(db, "signed_up_emails"), where("email", "==", email));
                    const emailSnapshot = await getDocs(emailQuery);
                    
                    if (!emailSnapshot.empty) {
                        showAuthMessage('User is already signed up', 'error');
                        return;
                    }
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    
                    await addDoc(collection(db, "signed_up_emails"), {
                        email: email,
                        timestamp: serverTimestamp(),
                        userId: userCredential.user.uid
                    });
                } catch (error) { showAuthMessage(`Sign up failed: ${error.message}`, 'error'); }
            });
            
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value;
                try {
                    showAuthMessage('Sending reset email...', 'info');
                    await sendPasswordResetEmail(auth, email);
                    showAuthMessage('Password reset email sent! Check your inbox.', 'success');
                } catch (error) { showAuthMessage(`Failed to send email: ${error.message}`, 'error'); }
            });

            let currentActiveUserId = null;
            const headerContainer = document.querySelector('header .container');
            const logoTextContainer = document.querySelector('.logo-text-container-center');

            const updateMobileHeaderLayout = (isLoggedIn) => {
                if (window.innerWidth <= 767) {
                    if (isLoggedIn) {
                        headerContainer.classList.remove('justify-center');
                        headerContainer.classList.add('justify-between');
                        logoTextContainer.classList.remove('hidden');
                        logoTextContainer.classList.add('flex');
                    } else {
                        headerContainer.classList.remove('justify-between');
                        headerContainer.classList.add('justify-center');
                        logoTextContainer.classList.remove('hidden');
                        logoTextContainer.classList.add('flex');
                    }
                } else {
                    headerContainer.classList.remove('justify-between', 'justify-center');
                    headerContainer.classList.add('flex', 'justify-between');
                    logoTextContainer.classList.remove('hidden');
                    logoTextContainer.classList.add('flex');
                }
            };

            onAuthStateChanged(auth, (user) => {
                const isRealUser = user && !user.isAnonymous;
                
                if (isRealUser) {
                    document.getElementById('loginNavBtn').classList.add('hidden');
                    userMonogram.classList.remove('hidden');
                    const displayName = user.displayName;
                    const email = user.email;
                    let initials = displayName ? displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : (email ? email.charAt(0).toUpperCase() : '');
                    userMonogram.textContent = initials;
                    closeModal(document.getElementById('loginModal'));
                    currentActiveUserId = user.uid;
                    console.log("Auth state changed: User logged in, UID:", currentActiveUserId);
                } else {
                    document.getElementById('loginNavBtn').classList.remove('hidden');
                    userMonogram.classList.add('hidden');
                    authDropdown.classList.add('hidden');
                    currentActiveUserId = getOrCreateGuestId();
                    console.log("Auth state changed: User logged out/guest, ID:", currentActiveUserId);
                }
                updateMobileHeaderLayout(isRealUser);
            });

            window.addEventListener('resize', () => {
                const isRealUser = auth.currentUser && !auth.currentUser.isAnonymous;
                updateMobileHeaderLayout(isRealUser);
            });

            userMonogram.addEventListener('click', (e) => { e.stopPropagation(); authDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!authStatusContainer.contains(e.target)) { authDropdown.classList.add('hidden'); } });
            logoutBtn.addEventListener('click', () => signOut(auth));


            const chatWindow = document.getElementById('chat-window');
            const chatOpenBtn = document.getElementById('chat-open-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatMinimizeBtn = document.getElementById('chat-minimize-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatInputContainer = document.getElementById('chat-input-container');
            const guestPromptContainer = document.getElementById('guest-prompt-container');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            const guestContinueBtn = document.getElementById('guest-continue-btn');
            const unreadCounter = document.getElementById('unread-counter');
            const typingIndicatorContainer = document.getElementById('typing-indicator-container');
            const surveyContainer = document.getElementById('chat-survey-container');
            const surveyForm = document.getElementById('chat-survey-form');
            const starRatingContainer = document.getElementById('star-rating');
            const friendlinessRating = document.getElementById('friendliness-rating');
            const friendlinessValue = document.getElementById('friendliness-value');
            const endChatConfirmModal = document.getElementById('end-chat-confirm-modal');
            const endChatYesBtn = document.getElementById('end-chat-yes');
            const endChatNoBtn = document.getElementById('end-chat-no');
            const orderSelectionContainer = document.getElementById('order-selection-container');
            const orderList = document.getElementById('order-list');
            const closeOrderSelectionBtn = document.getElementById('close-order-selection-btn');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const globalTooltip = document.getElementById('globalTooltip');

            let currentChatId = localStorage.getItem('chatSessionId');
            let unsubscribeFromMessages = null;
            let unsubscribeFromChatSession = null;
            let isChatMinimized = true;
            let unreadCount = 0;
            let hasUserTypedFirstMessage = false;
            let userTypingTimeout = null;
            let initialWelcomeRendered = {};
            let isFirstMessageSent = false;

            const notificationSound = new Audio('https://cdn.freesound.org/previews/253/253887_3900531-lq.mp3');
            notificationSound.volume = 0.5;

            // This function relies on local storage now that global vars are removed.
            const getOrCreateGuestId = () => {
                let id = localStorage.getItem('guestChatId');
                if (!id) {
                    id = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    localStorage.setItem('guestChatId', id);
                }
                return id;
            };

            const getOrCreateChatSession = async () => {
                const user = auth.currentUser;
                const currentGuestId = getOrCreateGuestId();
                const chatSessionData = {
                    createdAt: serverTimestamp(),
                    ownerUid: user?.uid || null,
                    guestId: user ? null : currentGuestId,
                    status: 'active',
                    agentName: null,
                    isAgentTyping: false,
                    agentAskingForOrderId: false
                };
                const docRef = await addDoc(collection(db, "chats"), chatSessionData);
                const chatId = docRef.id;
                localStorage.setItem('chatSessionId', chatId);
                return chatId;
            };

            const renderMessage = (msg) => {
                const messageDiv = document.createElement('div');
                const user = auth.currentUser;
                const currentGuestId = localStorage.getItem('guestChatId');
                const isMyMessage = (user && msg.sender === user.uid) || (!user && msg.sender === currentGuestId);
                
                let classes = 'p-3 rounded-lg max-w-[85%] mb-2 break-words';
                if (msg.type === 'system') {
                    classes = 'text-center text-sm text-slate-500 my-2';
                    messageDiv.innerHTML = `<span class="bg-white px-2 py-1 rounded-full">${msg.text}</span>`;
                } else {
                    classes += isMyMessage ? ' bg-gray-200 text-slate-800 self-end' : ' bg-blue-100 text-blue-800 self-start';
                    messageDiv.textContent = msg.text;
                }

                messageDiv.className = classes;
                if (msg.type === 'system' && msg.text.includes('has joined the chat.')) {
                    messageDiv.id = `agent-joined-${currentChatId}`;
                }
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const listenForChatSessionChanges = (chatId) => {
                if (unsubscribeFromChatSession) unsubscribeFromChatSession();
                unsubscribeFromChatSession = onSnapshot(doc(db, "chats", chatId), async (docSnap) => {
                    const data = docSnap.data();
                    if (!data) return;

                    const agentJoinedFlag = localStorage.getItem(`agentJoined_${chatId}`);
                    if (data.agentName && data.agentHasJoined && !agentJoinedFlag) {
                        const joinMsgText = `<i class="fa-solid fa-headset mr-2"></i>${data.agentName} has joined the chat.`;
                        await addDoc(collection(db, `chats/${chatId}/messages`), {
                            text: joinMsgText,
                            timestamp: serverTimestamp(),
                            sender: 'system',
                            type: 'system'
                        });
                        localStorage.setItem(`agentJoined_${chatId}`, 'true');
                    }
                    
                    typingIndicatorContainer.style.display = data.isAgentTyping ? 'block' : 'none';
                    if (data.isAgentTyping) chatMessages.scrollTop = chatMessages.scrollHeight;
                    if (data.status === 'ended_by_agent') {
                        chatInputContainer.classList.add('hidden');
                        guestPromptContainer.classList.add('hidden');
                        surveyContainer.classList.remove('hidden');
                        orderSelectionContainer.classList.add('hidden');
                        localStorage.removeItem('chatSessionId');
                        localStorage.removeItem(`agentJoined_${chatId}`);
                    }
                    if (data.agentAskingForOrderId) {
                        displayOrderSelectionUI();
                    } else {
                        orderSelectionContainer.classList.add('hidden');
                    }
                });
            };

            const listenForMessages = (chatId) => {
                if (unsubscribeFromMessages) unsubscribeFromMessages();
                currentChatId = chatId;
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const q = query(messagesRef, orderBy("timestamp"));
                unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = '';
                    if (!initialWelcomeRendered[chatId] && snapshot.empty) {
                        const user = auth.currentUser;
                        const userName = user?.displayName?.split(' ')[0] || 'there';
                        renderMessage({ type: 'system', text: `Hi ${userName}, how can we help you today?` });
                        initialWelcomeRendered[chatId] = true;
                    }

                    snapshot.forEach(doc => {
                        const msgData = doc.data();
                        renderMessage(msgData);
                        const user = auth.currentUser;
                        const currentGuestId = localStorage.getItem('guestChatId');
                        const isMyMessage = (user && msgData.sender === user.uid) || (!user && msgData.sender === currentGuestId);
                        if (!isMyMessage && isChatMinimized) {
                            unreadCount++;
                            unreadCounter.textContent = unreadCount;
                            unreadCounter.classList.add('visible');
                            notificationSound.play().catch(e => console.log("Audio play failed:", e));
                        }
                    });
                });
            };

            const resetChatUI = () => {
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex');
                surveyContainer.classList.add('hidden');
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden');
                orderSelectionContainer.classList.add('hidden');
                typingIndicatorContainer.style.display = 'none';
                chatMessages.innerHTML = '';
                initialWelcomeRendered = {};
            };

            const openChat = async () => {
                if (!currentChatId) {
                    currentChatId = await getOrCreateChatSession();
                    isFirstMessageSent = false;
                }
                resetChatUI();
                chatWindow.classList.add('is-visible');
                isChatMinimized = false;
                unreadCount = 0;
                unreadCounter.classList.remove('visible');
                if (currentChatId) {
                    listenForMessages(currentChatId);
                    listenForChatSessionChanges(currentChatId);
                }
            };
            chatOpenBtn.addEventListener('click', openChat);

            const minimizeChat = () => {
                chatWindow.classList.remove('is-visible');
                isChatMinimized = true;
            };
            chatMinimizeBtn.addEventListener('click', minimizeChat);

            chatCloseBtn.addEventListener('click', () => {
                endChatConfirmModal.classList.add('flex');
                endChatConfirmModal.classList.remove('hidden');
            });

            endChatNoBtn.addEventListener('click', () => {
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex');
            });

            endChatYesBtn.addEventListener('click', async () => {
                if (currentChatId) {
                    await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                        text: "Chat ended by user.",
                        timestamp: serverTimestamp(),
                        sender: 'system',
                        type: 'system'
                    });
                    await updateDoc(doc(db, "chats", currentChatId), { status: 'ended_by_user' });
                }
                localStorage.removeItem('chatSessionId');
                localStorage.removeItem(`agentJoined_${currentChatId}`);
                currentChatId = null;
                hasUserTypedFirstMessage = false;
                chatMessages.innerHTML = '';
                endChatConfirmModal.classList.add('hidden');
                endChatConfirmModal.classList.remove('flex');
                minimizeChat();
            });

            const sendMessage = async (text) => {
                if (text.trim() === '' || !currentChatId) return;

                if (!isFirstMessageSent) {
                    isFirstMessageSent = true;
                    try {
                        const cloudFunctionUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api/email-support';
                        const user = auth.currentUser;
                        const userEmail = user?.email || 'Guest';
                        const userName = user?.displayName || userEmail;
                        const firstMessage = text;

                        await fetch(cloudFunctionUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chatId: currentChatId,
                                userName: userName,
                                userEmail: userEmail,
                                firstMessage: firstMessage
                            })
                        });
                        console.log('Support email sent for new chat session.');
                    } catch (error) {
                        console.error("Error sending support email:", error);
                    }
                }

                const user = auth.currentUser;
                const currentGuestId = getOrCreateGuestId();
                const messageData = { text, timestamp: serverTimestamp(), sender: user ? user.uid : currentGuestId };
                await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
                chatInput.value = '';
                await updateDoc(doc(db, "chats", currentChatId), {
                    userTypingText: '',
                    lastMessage: `User: ${text}`,
                    lastMessageTimestamp: serverTimestamp()
                });
            };

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage(chatInput.value);
                }
            });
            sendMessageBtn.addEventListener('click', () => {
                sendMessage(chatInput.value);
            });

            chatInput.addEventListener('keyup', () => {
                clearTimeout(userTypingTimeout);
                userTypingTimeout = setTimeout(async () => {
                    if (currentChatId) {
                        await updateDoc(doc(db, "chats", currentChatId), { userTypingText: chatInput.value });
                    }
                }, 300);
            });

            guestLoginBtn.addEventListener('click', () => openModal('loginModal'));
            guestContinueBtn.addEventListener('click', () => {
                guestPromptContainer.classList.add('hidden');
                chatInputContainer.classList.remove('hidden');
                chatInput.focus();
            });

            friendlinessRating.addEventListener('input', (e) => { friendlinessValue.textContent = e.target.value; });
            starRatingContainer.addEventListener('mouseover', e => {
                if (e.target.tagName === 'I') {
                    const rating = e.target.dataset.value;
                    Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= rating));
                }
            });
            starRatingContainer.addEventListener('mouseout', () => {
                const currentRating = starRatingContainer.dataset.rating;
                Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= currentRating));
            });
            starRatingContainer.addEventListener('click', e => {
                if (e.target.tagName === 'I') {
                    starRatingContainer.dataset.rating = e.target.dataset.value;
                }
            });

            surveyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const surveyData = {
                    overallRating: parseInt(starRatingContainer.dataset.rating, 10),
                    friendliness: friendlinessRating.value,
                    resolved: document.querySelector('input[name="issue-resolved"]:checked')?.value || null,
                    comments: document.getElementById('survey-comments').value
                };
                await setDoc(doc(db, `chats/${currentChatId}/survey/feedback`), { ...surveyData, submittedAt: serverTimestamp() });
                try {
                    const cloudFunctionUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api/submit-chat-feedback';
                    const response = await fetch(cloudFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chatId: currentChatId, surveyData: surveyData })
                    });
                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    console.log('Feedback email sent successfully:', await response.json());
                } catch (error) { console.error("Error sending feedback email:", error); }
                surveyContainer.innerHTML = '<p class="text-center font-semibold text-green-600">Thank you for your feedback!</p>';
            });

            const fetchUserOrders = async () => {
                return new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe();
                        if (!user) {
                            console.log("fetchUserOrders: User not logged in, returning requiresLogin: true");
                            resolve({ requiresLogin: true });
                            return;
                        }
                        const userId = user.uid;
                        console.log("fetchUserOrders: Current user ID:", userId);
                        const ordersRef = collection(db, `users/${userId}/orders`);
                        const q = query(ordersRef, orderBy("timestamp", "desc"));
                        try {
                            await createDummyOrder(userId);
                            const snapshot = await getDocs(q);
                            console.log("fetchUserOrders: Orders snapshot size:", snapshot.size);
                            if (snapshot.empty) {
                                console.log("fetchUserOrders: No orders found for this user in Firestore path:", `users/${userId}/orders`);
                            }
                            const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log("fetchUserOrders: Fetched orders:", orders);
                            resolve(orders);
                        } catch (error) {
                            console.error("fetchUserOrders: Error fetching user orders:", error);
                            resolve({ error: error.message });
                        }
                    });
                });
            };

            const createDummyOrder = async (userId) => {
                const ordersRef = collection(db, `users/${userId}/orders`);
                const existingOrders = await getDocs(ordersRef);
                if (existingOrders.empty) {
                    console.log("Creating initial dummy orders for user:", userId);
                    let lastOrderNum = parseInt(localStorage.getItem('lastOrderNum') || '0', 10);
                    const generateSequentialOrderId = () => {
                        lastOrderNum++;
                        localStorage.setItem('lastOrderNum', lastOrderNum);
                        return `SHC-${String(lastOrderNum).padStart(5, '0')}`;
                    };
                    await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                        orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                        deviceName: 'iPhone 15 Pro Max',
                        storage: '256GB',
                        price: 700,
                        reoffer: null,
                        imageUrl: 'https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/iphone/assets/i15pm.webp',
                        timestamp: serverTimestamp()
                    });
                    await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                        orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                        deviceName: 'Samsung Galaxy S24 Ultra',
                        storage: '512GB',
                        price: 600,
                        reoffer: 550,
                        imageUrl: 'https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/samsung/assets/s24u.webp',
                        timestamp: serverTimestamp()
                    });
                    await setDoc(doc(db, `users/${userId}/orders`, generateSequentialOrderId()), {
                        orderId: `SHC-${String(lastOrderNum).padStart(5, '0')}`,
                        deviceName: 'iPad Pro (M2)',
                        storage: '128GB',
                        price: 550,
                        reoffer: null,
                        imageUrl: 'https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/ipm2.webp',
                        timestamp: serverTimestamp()
                    });
                } else {
                    console.log("Example orders already exist for user:", userId);
                }
            };

            const parseCurrencyValue = (value) => {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? numeric : null;
            };

            const getDisplayPrice = (order) => {
                if (!order || typeof order !== 'object') {
                    return 0;
                }
                const candidates = [
                    order.reoffer,
                    order.reOffer?.newPrice,
                    order.reOffer,
                    order.price,
                    order.estimatedQuote,
                ];

                for (const candidate of candidates) {
                    const numeric = parseCurrencyValue(candidate);
                    if (numeric !== null) {
                        return numeric;
                    }
                }

                return 0;
            };

            const renderOrderSelection = (orders) => {
                orderList.innerHTML = '';
                if (orders.requiresLogin) {
                    orderList.innerHTML = '<p class="text-center text-slate-500">Please <a href="#" id="orderLoginPromptLink" class="text-blue-600 font-semibold hover:underline">log in</a> to view and select your orders.</p>';
                    document.getElementById('orderLoginPromptLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        openModal('loginModal');
                        orderSelectionContainer.classList.add('hidden');
                    });
                    orderSelectionPrompt.textContent = 'Login to access your orders:';
                    return;
                }
                
                if (orders.length === 0) {
                    orderList.innerHTML = '<p class="text-center text-slate-500">No recent orders found.</p>';
                    orderSelectionPrompt.textContent = 'Please select your order:';
                    return;
                }
                orderSelectionPrompt.textContent = 'Please select your order:';
                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'order-card';
                    orderCard.dataset.orderId = order.orderId;
                    const reofferAmount = parseCurrencyValue(order.reoffer ?? order.reOffer?.newPrice);
                    const displayPriceValue = getDisplayPrice(order);
                    const formattedPrice = displayPriceValue.toFixed(2);
                    orderCard.innerHTML = `
                        <img src="${order.imageUrl || 'https://placehold.co/48x48/e0e7ff/4338ca?text=üì±'}" alt="${order.deviceName}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/e0e7ff/4338ca?text=üì±';">
                        <div class="order-card-details">
                            <strong>ID: ${order.orderId} - ${order.deviceName}</strong>
                            <span>${order.storage} | $${formattedPrice}</span>
                            ${reofferAmount !== null ? `<span class="reoffer">Reoffer: $${reofferAmount.toFixed(2)}</span>` : ''}
                        </div>
                    `;
                    orderCard.addEventListener('click', () => handleOrderSelection(order));
                    orderList.appendChild(orderCard);
                });
            };

            const displayOrderSelectionUI = async () => {
                guestPromptContainer.classList.add('hidden');
                orderSelectionContainer.classList.remove('hidden');
                orderList.innerHTML = '<p class="text-center text-blue-500">Loading your orders...</p>';
                const orders = await fetchUserOrders();
                renderOrderSelection(orders);
            };

            const handleOrderSelection = async (order) => {
                const reofferAmount = parseCurrencyValue(order.reoffer ?? order.reOffer?.newPrice);
                const displayPriceValue = getDisplayPrice(order);
                const formattedPrice = displayPriceValue.toFixed(2);
                const messageText = `Selected Order: ID: ${order.orderId}, Device: ${order.deviceName}, Storage: ${order.storage}, Price: $${formattedPrice}${reofferAmount !== null ? `, Reoffer: $${reofferAmount.toFixed(2)}` : ''}`;
                await sendMessage(messageText);
                orderSelectionContainer.classList.add('hidden');
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
                }
            };

            closeOrderSelectionBtn.addEventListener('click', async () => {
                orderSelectionContainer.classList.add('hidden');
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: false });
                }
            });

            const chatOrderBtn = document.getElementById('chat-order-btn');
            chatOrderBtn.addEventListener('click', async () => {
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { agentAskingForOrderId: true });
                } else {
                    displayOrderSelectionUI();
                }
            });

            const chatHeaderButtons = document.querySelectorAll('.chat-header-button');

            chatHeaderButtons.forEach(button => {
                let tooltipTimeout;

                button.addEventListener('mouseover', (e) => {
                    clearTimeout(tooltipTimeout);
                    const tooltipText = button.dataset.tooltipText;
                    if (tooltipText) {
                        globalTooltip.textContent = tooltipText;
                        globalTooltip.style.visibility = 'visible';
                        globalTooltip.style.opacity = '1';

                        const rect = button.getBoundingClientRect();
                        globalTooltip.style.top = `${rect.bottom + 8}px`;
                        globalTooltip.style.left = `${rect.left + rect.width / 2}px`;
                        globalTooltip.style.transform = `translateX(-50%)`;
                    }
                });

                button.addEventListener('mouseout', () => {
                    tooltipTimeout = setTimeout(() => {
                        globalTooltip.style.visibility = 'hidden';
                        globalTooltip.style.opacity = '0';
                    }, 100);
                });

                button.addEventListener('mouseenter', () => {
                    clearTimeout(tooltipTimeout);
                });
            });

            // NEW: Intersection Observer for scroll-triggered animations
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fadeInUp');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.animate-on-scroll').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                observer.observe(el);
            });

            // --- PRICING MODAL FUNCTIONALITY ---
            const pricingModal = {
                brand: '',
                device: '',
                deviceSlug: '',
                storage: '',
                carrier: 'unlocked',
                conditions: {
                    power: null,
                    functionality: null,
                    quality: null
                },
                deviceData: null,

                init() {
                    const brandSelect = document.getElementById('modal-brand-select');
                    const deviceSelect = document.getElementById('modal-device-select');
                    const storageSelect = document.getElementById('modal-storage-select');
                    const carrierSelect = document.getElementById('modal-carrier-select');
                    const conditionBtns = document.querySelectorAll('.condition-btn');
                    const continueBtn = document.getElementById('modal-continue-btn');

                    brandSelect.addEventListener('change', (e) => {
                        this.brand = e.target.value;
                        
                        // Update brand icon
                        const brandIcon = document.getElementById('brand-icon');
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        const iconUrl = selectedOption.dataset.icon;
                        
                        if (iconUrl) {
                            brandIcon.src = iconUrl;
                            brandIcon.classList.remove('hidden');
                        } else {
                            brandIcon.classList.add('hidden');
                        }
                        
                        this.loadDevices();
                    });

                    deviceSelect.addEventListener('change', (e) => {
                        this.device = e.target.value;
                        this.loadStorage();
                    });

                    storageSelect.addEventListener('change', (e) => {
                        this.storage = e.target.value;
                        this.checkComplete();
                    });

                    carrierSelect.addEventListener('change', (e) => {
                        this.carrier = e.target.value;
                        this.checkComplete();
                    });

                    conditionBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const condition = btn.dataset.condition;
                            const value = btn.dataset.value;
                            
                            document.querySelectorAll(`[data-condition="${condition}"]`).forEach(b => {
                                b.classList.remove('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');
                            });
                            
                            btn.classList.add('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');
                            this.conditions[condition] = value;
                            this.checkComplete();
                        });
                    });

                    continueBtn.addEventListener('click', () => {
                        const params = new URLSearchParams({
                            // NEW: Combine brand and slug into a single 'device' parameter
                            device: `${this.brand}-${this.device}`, 
                            storage: this.storage,
                            carrier: this.carrier,
                            power: this.conditions.power,
                            functionality: this.conditions.functionality,
                            quality: this.conditions.quality,
                            price: document.getElementById('modal-estimated-price').textContent
                        });
                        // Use the 'sell/' path consistent with other links in the page body.
                        window.location.href = `sell/?${params.toString()}`;
                    });
                },

                async loadDevices() {
                    const deviceSelect = document.getElementById('modal-device-select');
                    const storageSelect = document.getElementById('modal-storage-select');
                    
                    deviceSelect.innerHTML = '<option value="">Loading devices...</option>';
                    storageSelect.innerHTML = '<option value="">Select storage...</option>';
                    deviceSelect.disabled = true;
                    storageSelect.disabled = true;
                    
                    if (!this.brand) return;
                    
                    try {
                        const devicesCol = collection(db, `devices/${this.brand}/models`);
                        const devicesSnapshot = await getDocs(devicesCol);
                        
                        deviceSelect.innerHTML = '<option value="">Choose a device...</option>';
                        deviceSelect.disabled = false;
                        
                        devicesSnapshot.forEach((doc) => {
                            const data = doc.data();
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = data.name || doc.id;
                            option.dataset.deviceData = JSON.stringify(data);
                            deviceSelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error loading devices:', error);
                        deviceSelect.innerHTML = '<option value="">Error loading devices</option>';
                    }
                    
                    this.device = '';
                    this.storage = '';
                    this.deviceData = null;
                    this.checkComplete();
                },

                loadStorage() {
                    const deviceSelect = document.getElementById('modal-device-select');
                    const storageSelect = document.getElementById('modal-storage-select');
                    const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
                    
                    storageSelect.innerHTML = '<option value="">Select storage...</option>';
                    
                    if (this.device && selectedOption && selectedOption.dataset.deviceData) {
                        this.deviceData = JSON.parse(selectedOption.dataset.deviceData);
                        this.deviceSlug = this.device;
                        
                        if (this.deviceData.prices) {
                            storageSelect.disabled = false;
                            const storageOptions = Object.keys(this.deviceData.prices);
                            storageOptions.forEach(storage => {
                                const option = document.createElement('option');
                                option.value = storage;
                                option.textContent = storage;
                                storageSelect.appendChild(option);
                            });
                        }
                    }
                    
                    this.storage = '';
                    this.checkComplete();
                },

                checkComplete() {
                    if (this.brand && this.device && this.storage && 
                        this.conditions.power && this.conditions.functionality && this.conditions.quality) {
                        this.calculatePrice();
                    }
                },

                calculatePrice() {
                    if (!this.deviceData || !this.deviceData.prices) return;

                    const carrierKey = this.carrier === 'unlocked' ? 'unlocked' : 'locked';
                    const storageKey = this.storage;
                    
                    let conditionKey;
                    if (this.conditions.power === 'no') {
                        conditionKey = 'noPower';
                    } else if (this.conditions.functionality === 'not-working') {
                        conditionKey = 'broken';
                    } else if (this.conditions.quality === 'flawless') {
                        conditionKey = 'flawless';
                    } else if (this.conditions.quality === 'scratched') {
                        conditionKey = 'good';
                    } else if (this.conditions.quality === 'damaged') {
                        conditionKey = 'damaged';
                    }

                    const price = this.deviceData.prices?.[storageKey]?.[carrierKey]?.[conditionKey];
                    if (price) {
                        document.getElementById('modal-estimated-price').textContent = price;
                        document.getElementById('modal-price-estimate').classList.remove('hidden');
                    }
                }
            };

            pricingModal.init();
        });
    </script>
</body>
</html>
