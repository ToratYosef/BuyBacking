<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftBuyBack - My Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-button.active {
            border-color: #4f46e5; /* Indigo-600 */
            color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
        }
        .initials-monogram {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ffffff;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        /* Status badge styling */
        .status-badge {
            @apply inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none rounded-full;
        }
        /* Specific status colors */
        .status-completed { @apply bg-green-200 text-green-800; }
        .status-re-offered-accepted { @apply bg-teal-200 text-teal-800; }
        .status-re-offered-auto-accepted { @apply bg-teal-200 text-teal-800; }
        .status-re-offered-pending { @apply bg-orange-200 text-orange-800; }
        .status-re-offered-declined { @apply bg-red-200 text-red-800; }
        .status-order_pending { @apply bg-blue-200 text-blue-800; }
        .status-shipping_kit_requested { @apply bg-indigo-200 text-indigo-800; }
        .status-label_generated { @apply bg-yellow-200 text-yellow-800; }
        .status-received { @apply bg-gray-200 text-gray-800; }
        .status-return-label-generated { @apply bg-gray-400 text-gray-800; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="https://secondhandcell.com/index.html" class="text-2xl font-bold text-indigo-700 rounded-md p-2">SwiftBuyBack</a>
            <nav class="space-x-4 flex items-center">
                <a href="https://secondhandcell.com/sell-device.html" class="text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Sell Your Device</a>
                <div id="authStatusContainer" class="flex items-center space-x-4">
                    <a id="login-link" href="https://secondhandcell.com/login.html" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Login</a>
                    <a id="account-link" href="https://secondhandcell.com/my-account.html" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">My Account</a>
                    <div id="userMonogram" class="initials-monogram hidden"></div>
                    <button id="logout-button" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">My Account</h1>

            <div id="message" class="mb-6 p-3 rounded-md text-sm text-center hidden"></div>

            <div class="flex border-b border-gray-200 mb-8">
                <button id="accountInfoTab" class="tab-button active flex-1 py-3 px-4 text-center text-lg font-medium text-gray-700 rounded-t-lg border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-600 transition duration-300">
                    Account Information
                </button>
                <button id="orderHistoryTab" class="tab-button flex-1 py-3 px-4 text-center text-lg font-medium text-gray-700 rounded-t-lg border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-600 transition duration-300">
                    Order History
                </button>
            </div>

            <div id="accountInfoSection" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name:</label>
                        <p id="userName" class="mt-1 text-lg text-gray-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email Address:</label>
                        <p id="userEmail" class="mt-1 text-lg text-gray-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-gray-700">Phone Number:</label>
                        <input type="tel" id="userPhone" name="userPhone"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="e.g., +15551234567">
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="saveInfoBtn" class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Changes
                    </button>
                </div>
            </div>

            <div id="orderHistorySection" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Past Orders</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Device</th>
                                <th class="py-3 px-6 text-left">Quote</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-gray-700 text-sm font-light">
                            <tr><td colspan="6" class="text-center text-gray-500 py-4">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noOrdersMessage" class="text-gray-600 mt-4 text-center hidden">No orders found.</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-12 mt-8 w-full">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div>
                <h3 class="text-xl font-bold mb-4">SwiftBuyBack</h3>
                <p class="text-gray-400">Your trusted partner for selling used smartphones. Quick quotes, fair prices, and hassle-free service.</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                <ul class="space-y-2">
                    <li><a href="https://secondhandcell.com/index.html" class="text-gray-400 hover:text-white transition duration-300">Home</a></li>
                    <li><a href="https://secondhandcell.com/sell-device.html" class="text-gray-400 hover:text-white transition duration-300">Sell Your Phone</a></li>
                    <li><a href="https://secondhandcell.com/my-account.html" class="text-gray-400 hover:text-white transition duration-300">My Account</a></li>
                    <li><a href="https://secondhandcell.com/about-us.html" class="text-gray-400 hover:text-white transition duration-300">About Us</a></li>
                    <li><a href="https://secondhandcell.com/contact.html" class="text-gray-400 hover:text-white transition duration-300">Contact</a></li>
                </ul>
            </div>
            <div class="md:col-span-2 lg:col-span-1">
                <h3 class="text-xl font-bold mb-4">Contact Us</h3>
                <p class="text-gray-400">Email: info@swiftbuyback.com</p>
                <p class="text-gray-400">Phone: (123) 456-7890</p>
                <p class="text-gray-400 mt-4">&copy; 2025 SwiftBuyBack. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="closeModal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Order Details <span id="modalOrderId" class="text-indigo-600"></span></h3>
            <div class="space-y-3 text-gray-700">
                <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
                <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                <p><strong>Item:</strong> <span id="modalItem"></span></p>
                <p><strong>Storage:</strong> <span id="modalStorage"></span></p>
                <p><strong>Carrier:</strong> <span id="modalCarrier"></span></p>
                <p><strong>Estimated Payout:</strong> $<span id="modalPrice"></span></p>
                <p><strong>Payment Method:</strong> <span id="modalPaymentMethod"></span></p>
                <p id="modalVenmoUsernameRow" class="hidden"><strong>Venmo Username:</strong> <span id="modalVenmoUsername"></span></p>
                <p><strong>Shipping Address:</strong> <span id="modalShippingAddress"></span></p>
                <p><strong>Conditions:</strong>
                    <ul class="list-disc list-inside ml-4 text-sm">
                        <li>Powers On: <span id="modalConditionPowerOn"></span></li>
                        <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                        <li>No Cracks: <span id="modalConditionCracks"></span></li>
                        <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                    </ul>
                </p>
                <p><strong>Current Status:</strong> <span id="modalStatus" class="font-semibold px-2 py-1 rounded-full text-xs"></span></p>

                <!-- Re-offer details -->
                <div id="reOfferDetails" class="hidden bg-yellow-50 p-4 rounded-md border border-yellow-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-yellow-800">Revised Offer Details</h4>
                    <p><strong>New Offer Price:</strong> $<span id="reOfferNewPrice" class="font-bold text-yellow-700"></span></p>
                    <p><strong>Reasons:</strong> <span id="reOfferReasons"></span></p>
                    <p id="reOfferCommentsRow" class="hidden"><strong>Comments:</strong> <span id="reOfferComments"></span></p>
                    <p id="reOfferAutoAcceptDateRow" class="text-sm text-gray-600">This offer will be automatically accepted on: <span id="reOfferAutoAcceptDate"></span></p>
                </div>
                
                <!-- Shipping Label / Tracking Info -->
                <div id="labelInfoSection" class="hidden bg-blue-50 p-4 rounded-md border border-blue-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-blue-800">Shipping Information</h4>
                    <p id="outboundLabelRow" class="hidden"><strong>Outbound Kit Tracking:</strong> <a id="outboundTrackingLink" href="#" target="_blank" class="text-blue-600 hover:underline"></a></p>
                    <p id="inboundLabelRow" class="hidden"><strong>Inbound Device Label:</strong> <a id="inboundLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="inboundTrackingNumber"></span>)</p>
                    <p id="uspsLabelRow" class="hidden"><strong>Shipping Label:</strong> <a id="uspsLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="uspsTrackingNumber"></span>)</p>
                    <p id="returnLabelRow" class="hidden"><strong>Return Label:</strong> <a id="returnLabelLink" href="#" target="_blank" class="text-red-600 hover:underline">View Label</a> (<span id="returnTrackingNumber"></span>)</p>
                </div>

                <p id="modalLoadingMessage" class="text-center text-indigo-500 hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Processing request...</p>
            </div>

            <div id="modalActionButtons" class="mt-6 flex flex-col sm:flex-row gap-3">
                <!-- Action buttons will be rendered here dynamically -->
            </div>
            <div id="modalMessage" class="mt-4 p-3 text-sm rounded-md hidden"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Backend URL for Cloud Functions
        const BACKEND_BASE_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

        // Get elements
        const loginLink = document.getElementById('login-link');
        const accountLink = document.getElementById('account-link');
        const logoutButton = document.getElementById('logout-button');
        const userMonogram = document.getElementById('userMonogram');
        const accountInfoTab = document.getElementById('accountInfoTab');
        const orderHistoryTab = document.getElementById('orderHistoryTab');
        const accountInfoSection = document.getElementById('accountInfoSection');
        const orderHistorySection = document.getElementById('orderHistorySection');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoneInput = document.getElementById('userPhone');
        const saveInfoBtn = document.getElementById('saveInfoBtn');
        const messageDiv = document.getElementById('message');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        // Modal elements
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalOrderId = document.getElementById('modalOrderId');
        const modalCustomerName = document.getElementById('modalCustomerName');
        const modalCustomerEmail = document.getElementById('modalCustomerEmail');
        const modalItem = document.getElementById('modalItem');
        const modalStorage = document.getElementById('modalStorage');
        const modalCarrier = document.getElementById('modalCarrier');
        const modalPrice = document.getElementById('modalPrice');
        const modalPaymentMethod = document.getElementById('modalPaymentMethod');
        const modalVenmoUsernameRow = document.getElementById('modalVenmoUsernameRow');
        const modalVenmoUsername = document.getElementById('modalVenmoUsername');
        const modalShippingAddress = document.getElementById('modalShippingAddress');
        const modalConditionPowerOn = document.getElementById('modalConditionPowerOn');
        const modalConditionFunctional = document.getElementById('modalConditionFunctional');
        const modalConditionCracks = document.getElementById('modalConditionCracks');
        const modalConditionCosmetic = document.getElementById('modalConditionCosmetic');
        const modalStatus = document.getElementById('modalStatus');
        const reOfferDetails = document.getElementById('reOfferDetails');
        const reOfferNewPrice = document.getElementById('reOfferNewPrice');
        const reOfferReasons = document.getElementById('reOfferReasons');
        const reOfferCommentsRow = document.getElementById('reOfferCommentsRow');
        const reOfferComments = document.getElementById('reOfferComments');
        const reOfferAutoAcceptDateRow = document.getElementById('reOfferAutoAcceptDateRow');
        const reOfferAutoAcceptDate = document.getElementById('reOfferAutoAcceptDate');
        const labelInfoSection = document.getElementById('labelInfoSection');
        const outboundLabelRow = document.getElementById('outboundLabelRow');
        const outboundTrackingLink = document.getElementById('outboundTrackingLink');
        const inboundLabelRow = document.getElementById('inboundLabelRow');
        const inboundLabelLink = document.getElementById('inboundLabelLink');
        const inboundTrackingNumber = document.getElementById('inboundTrackingNumber');
        const uspsLabelRow = document.getElementById('uspsLabelRow');
        const uspsLabelLink = document.getElementById('uspsLabelLink');
        const uspsTrackingNumber = document.getElementById('uspsTrackingNumber');
        const returnLabelRow = document.getElementById('returnLabelRow');
        const returnLabelLink = document.getElementById('returnLabelLink');
        const returnTrackingNumber = document.getElementById('returnTrackingNumber');

        const modalLoadingMessage = document.getElementById('modalLoadingMessage');
        const modalActionButtons = document.getElementById('modalActionButtons');
        const modalMessage = document.getElementById('modalMessage');

        let currentUserId = null;

        // --- Helper Functions ---
        
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `mb-6 p-3 rounded-md text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-700' : type === 'error' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
            messageDiv.classList.remove('hidden');
        }
        
        function clearMessage() {
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
        }
        
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'completed': return 'status-completed';
                case 're-offered-accepted': return 'status-re-offered-accepted';
                case 're-offered-auto-accepted': return 'status-re-offered-auto-accepted';
                case 're-offered-pending': return 'status-re-offered-pending';
                case 're-offered-declined': return 'status-re-offered-declined';
                case 'order_pending': return 'status-order_pending';
                case 'shipping_kit_requested': return 'status-shipping_kit-requested';
                case 'label_generated': return 'status-label_generated';
                case 'received': return 'status-received';
                case 'return-label-generated': return 'status-return-label-generated';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        function formatStatus(status) {
            if (status === 'order_pending') {
                return 'Order Pending';
            }
            if (status === 'shipping_kit_requested') {
                return 'Shipping Kit Requested';
            }
            if (status === 'label_generated') {
                return 'Shipping Kit on the Way'; // Custom text for this status
            }
            return status.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            // Firestore Timestamps have a toDate() method
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000); // Handle Firestore Timestamp format
            return date.toLocaleDateString();
        }

        function formatCondition(condition) {
            return condition.charAt(0).toUpperCase() + condition.slice(1);
        }

        // --- Tab and UI Logic ---

        function showTab(tabToShow) {
            accountInfoSection.classList.add('hidden');
            orderHistorySection.classList.add('hidden');
            accountInfoTab.classList.remove('active');
            orderHistoryTab.classList.remove('active');

            if (tabToShow === 'accountInfo') {
                accountInfoSection.classList.remove('hidden');
                accountInfoTab.classList.add('active');
            } else if (tabToShow === 'orderHistory') {
                orderHistorySection.classList.remove('hidden');
                orderHistoryTab.classList.add('active');
                if (currentUserId) {
                    loadOrders(currentUserId);
                }
            }
            clearMessage();
        }

        accountInfoTab.addEventListener('click', () => showTab('accountInfo'));
        orderHistoryTab.addEventListener('click', () => showTab('orderHistory'));
        
        // --- Firebase Functions ---
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Failed to log out. Please try again.', 'error');
            }
        }
        
        function loadOrders(userId) {
            if (!userId) {
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
                return;
            }
            
            // Query the 'orders' collection for documents where 'userId' matches the current user's ID
            const ordersCollectionRef = collection(db, 'orders');
            const userOrdersQuery = query(ordersCollectionRef, where('userId', '==', userId));
            
            // Listen for real-time updates to the user's orders
            onSnapshot(userOrdersQuery, (snapshot) => {
                ordersTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        
                        let displayQuote = order.estimatedQuote || 0;
                        if (order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted') {
                            displayQuote = order.reOffer?.newPrice || displayQuote;
                        }

                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
                        row.dataset.orderId = doc.id; // Add data attribute for click handler

                        row.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">${doc.id}</td>
                                <td class="py-3 px-6 text-left">${formatDate(order.createdAt)}</td>
                                <td class="py-3 px-6 text-left">${order.device || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">$${displayQuote.toFixed(2)}</td>
                                <td class="py-3 px-6 text-center">
                                    <span class="status-badge ${getStatusBadgeClass(order.status)}">${formatStatus(order.status)}</span>
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <button data-order-id="${doc.id}" class="view-details-btn text-indigo-600 hover:text-indigo-800 font-medium text-xs px-2 py-1 rounded-md bg-indigo-100 hover:bg-indigo-200 transition duration-200">View Details</button>
                                </td>
                            `;
                        ordersTableBody.appendChild(row);
                    });
                     // Add event listeners after all rows are added
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent row click from firing
                            openOrderDetailsModal(event.target.dataset.orderId);
                        });
                    });
                    document.querySelectorAll('#ordersTableBody tr').forEach(row => {
                        row.addEventListener('click', (event) => {
                            if (!event.target.closest('.view-details-btn')) { // Only open if not clicking the specific button
                                openOrderDetailsModal(row.dataset.orderId);
                            }
                        });
                    });

                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                showMessage('Failed to load orders. Please try again.', 'error');
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
            });
        }
        
        async function saveAccountInfo(userId, newName, phoneNumber) {
            if (!userId) {
                showMessage('User not authenticated. Please log in.', 'error');
                return;
            }
            saveInfoBtn.disabled = true;
            saveInfoBtn.textContent = 'Saving...';
            clearMessage();
        
            try {
                // Update Firebase Auth display name
                if (auth.currentUser && newName !== auth.currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    userName.textContent = newName; // Update UI immediately
                }

                // Update Firestore for phone number (and potentially other fields)
                // We're storing user-specific data in a 'users' collection,
                // with the document ID being the user's UID.
                const userDocRef = doc(db, `users/${userId}`);
                await setDoc(userDocRef, { phoneNumber: phoneNumber }, { merge: true });

                showMessage('Account information saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving account info:", error);
                showMessage('Failed to save account information. Please try again.', 'error');
            } finally {
                saveInfoBtn.disabled = false;
                saveInfoBtn.textContent = 'Save Changes';
            }
        }

        // --- Modal Functions ---

        async function openOrderDetailsModal(orderId) {
            // Reset modal state
            modalActionButtons.innerHTML = '';
            modalLoadingMessage.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';
            modalVenmoUsernameRow.classList.add('hidden');
            reOfferDetails.classList.add('hidden');
            labelInfoSection.classList.add('hidden');
            outboundLabelRow.classList.add('hidden');
            inboundLabelRow.classList.add('hidden');
            uspsLabelRow.classList.add('hidden');
            returnLabelRow.classList.add('hidden');

            orderDetailsModal.classList.remove('hidden');
            modalLoadingMessage.classList.remove('hidden');

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/orders/${orderId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch order details: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const order = await response.json();

                // Populate general order details
                modalOrderId.textContent = order.id;
                modalCustomerName.textContent = order.shippingInfo?.fullName || 'N/A';
                modalCustomerEmail.textContent = order.shippingInfo?.email || 'N/A';
                modalItem.textContent = order.device || 'N/A';
                modalStorage.textContent = order.storage || 'N/A';
                modalCarrier.textContent = order.carrier || 'N/A';
                modalPrice.textContent = order.estimatedQuote ? order.estimatedQuote.toFixed(2) : '0.00';
                modalPaymentMethod.textContent = order.paymentMethod ? formatCondition(order.paymentMethod) : 'N/A';
                if (order.paymentMethod === 'venmo' && order.paymentDetails?.venmoUsername) {
                    modalVenmoUsername.textContent = order.paymentDetails.venmoUsername;
                    modalVenmoUsernameRow.classList.remove('hidden');
                }
                modalShippingAddress.textContent = order.shippingInfo ? `${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state}, ${order.shippingInfo.zipCode}` : 'N/A';
                modalConditionPowerOn.textContent = order.condition_power_on ? formatCondition(order.condition_power_on) : 'N/A';
                modalConditionFunctional.textContent = order.condition_functional ? formatCondition(order.condition_functional) : 'N/A';
                modalConditionCracks.textContent = order.condition_cracks ? formatCondition(order.condition_cracks) : 'N/A';
                modalConditionCosmetic.textContent = order.condition_cosmetic ? formatCondition(order.condition_cosmetic) : 'N/A';
                
                modalStatus.textContent = formatStatus(order.status);
                modalStatus.className = `status-badge ${getStatusBadgeClass(order.status)}`;

                // Populate re-offer details if available
                if (order.reOffer && (order.status === 're-offered-pending' || order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted' || order.status === 're-offered-declined')) {
                    reOfferDetails.classList.remove('hidden');
                    reOfferNewPrice.textContent = order.reOffer.newPrice ? order.reOffer.newPrice.toFixed(2) : 'N/A';
                    reOfferReasons.textContent = order.reOffer.reasons?.join(', ') || 'N/A';
                    if (order.reOffer.comments) {
                        reOfferComments.textContent = order.reOffer.comments;
                        reOfferCommentsRow.classList.remove('hidden');
                    } else {
                        reOfferCommentsRow.classList.add('hidden');
                    }
                    if (order.reOffer.autoAcceptDate) {
                        reOfferAutoAcceptDate.textContent = formatDate(order.reOffer.autoAcceptDate);
                        reOfferAutoAcceptDateRow.classList.remove('hidden');
                    } else {
                        reOfferAutoAcceptDateRow.classList.add('hidden');
                    }
                }

                // Populate shipping label/tracking info
                if (order.shippingPreference === 'Shipping Kit Requested') {
                    labelInfoSection.classList.remove('hidden');
                    if (order.outboundTrackingNumber) {
                        outboundTrackingLink.href = `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`;
                        outboundTrackingLink.textContent = order.outboundTrackingNumber;
                        outboundLabelRow.classList.remove('hidden');
                    }
                    if (order.inboundLabelUrl) {
                        inboundLabelLink.href = order.inboundLabelUrl;
                        inboundTrackingNumber.textContent = order.inboundTrackingNumber || 'N/A';
                        inboundLabelRow.classList.remove('hidden');
                    }
                } else if (order.shippingPreference === 'Email Label Requested' && order.uspsLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    uspsLabelLink.href = order.uspsLabelUrl;
                    uspsTrackingNumber.textContent = order.trackingNumber || 'N/A';
                    uspsLabelRow.classList.remove('hidden');
                }

                // Populate return label info if exists
                if (order.returnLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    returnLabelLink.href = order.returnLabelUrl;
                    returnTrackingNumber.textContent = order.returnTrackingNumber || 'N/A';
                    returnLabelRow.classList.remove('hidden');
                }

                renderModalActionButtons(order);

            } catch (error) {
                console.error('Error fetching order details:', error);
                displayModalMessage(`Error fetching order details: ${error.message}. Please try again.`, 'error');
            } finally {
                modalLoadingMessage.classList.add('hidden');
            }
        }

        function closeOrderDetailsModal() {
            orderDetailsModal.classList.add('hidden');
        }

        function renderModalActionButtons(order) {
            modalActionButtons.innerHTML = '';
            const createButton = (text, onClick, className = 'bg-indigo-600 hover:bg-indigo-700') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `${className} text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow`;
                button.onclick = onClick;
                return button;
            };

            if (order.status === 're-offered-pending') {
                modalActionButtons.appendChild(createButton('Accept New Offer', () => handleModalAction(order.id, 'acceptOffer'), 'bg-green-600 hover:bg-green-700'));
                modalActionButtons.appendChild(createButton('Return My Phone', () => handleModalAction(order.id, 'returnPhone'), 'bg-red-600 hover:bg-red-700'));
            } else if (order.status === 'label_generated' && order.uspsLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Shipping Label', () => window.open(order.uspsLabelUrl, '_blank')));
            } else if (order.status === 'shipping_kit_requested' && order.outboundTrackingNumber) {
                 modalActionButtons.appendChild(createButton('Track Shipping Kit', () => window.open(`https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`, '_blank')));
            } else if (order.status === 're-offered-declined' && order.returnLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Return Label', () => window.open(order.returnLabelUrl, '_blank'), 'bg-red-600 hover:bg-red-700'));
            }
        }

        async function handleModalAction(orderId, actionType) {
            modalLoadingMessage.classList.remove('hidden');
            modalActionButtons.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';

            try {
                let url;
                let method = 'POST';
                let body = { orderId: orderId };

                switch(actionType) {
                    case 'acceptOffer':
                        url = `${BACKEND_BASE_URL}/accept-offer-action`;
                        break;
                    case 'returnPhone':
                        url = `${BACKEND_BASE_URL}/return-phone-action`;
                        break;
                    default:
                        throw new Error('Unknown action.');
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Failed to perform action: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const result = await response.json();
                
                displayModalMessage(result.message, 'success');
                // Re-open modal to refresh details with new status
                openOrderDetailsModal(orderId);

            } catch (error) {
                console.error("Action error:", error);
                displayModalMessage(`Error: ${error.message}`, 'error');
            } finally {
                modalLoadingMessage.classList.add('hidden');
                modalActionButtons.classList.remove('hidden');
            }
        }

        function displayModalMessage(message, type) {
            modalMessage.textContent = message;
            modalMessage.className = `mt-4 p-3 text-sm rounded-md`;
            if (type === 'success') {
                modalMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                modalMessage.classList.add('bg-red-100', 'text-red-700');
            }
            modalMessage.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', closeOrderDetailsModal);
        orderDetailsModal.addEventListener('click', (event) => {
            if (event.target === orderDetailsModal) {
                closeOrderDetailsModal();
            }
        });
        
        // --- Event Listeners ---
        
        logoutButton.addEventListener('click', handleLogout);
        
        saveInfoBtn.addEventListener('click', () => {
            if (currentUserId) {
                // Get the current displayed name from the UI, as it might have been updated by Firebase Auth
                const newName = userName.textContent; 
                saveAccountInfo(currentUserId, newName, userPhoneInput.value);
            } else {
                showMessage('Please log in to save your information.', 'error');
            }
        });
        
        // --- Main Auth State Listener ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                // Update header UI for logged-in state
                loginLink.classList.add('hidden');
                accountLink.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                userMonogram.classList.remove('hidden');
                
                // Get and set user initials for monogram
                const name = user.displayName || user.email;
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                userMonogram.textContent = initials;
                userMonogram.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 70%)`;

                // Update account details
                userName.textContent = user.displayName || 'N/A';
                userEmail.textContent = user.email || 'N/A';

                // Fetch phone number from Firestore and populate input field
                const userDocRef = doc(db, `users/${currentUserId}`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().phoneNumber) {
                        userPhoneInput.value = docSnap.data().phoneNumber;
                    } else {
                        userPhoneInput.value = '';
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showMessage('Could not load phone number.', 'error');
                }
                
                // Show account info by default
                showTab('accountInfo');
                
            } else {
                // User is signed out, redirect to a non-authenticated page
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
