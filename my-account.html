<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - My Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SLRRJRXHHE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SLRRJRXHHE');
    </script>


    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc; /* Tailwind slate-50 */
            color: #1e293b; /* Tailwind slate-800 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }
        @media (max-width: 767px) {
            body {
                font-size: 14px; /* Smaller base font size on mobile */
            }
        }
        .tab-button.active {
            border-color: #2563eb; /* Blue-600 */
            color: #2563eb; /* Blue-600 */
            background-color: #eff6ff; /* Blue-50 */
        }
        /* Styles from the provided new page for consistency */
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; /* blue-100, blue-700 */
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; 
            visibility: hidden;
            pointer-events: none; /* Crucial: Prevent clicks when hidden */
            display: none; /* Start hidden, will be changed to flex by JS */

            position: fixed;
            inset: 0;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 1rem; /* Responsive padding */
            align-items: center;
            justify-content: center;
        }
        .modal.is-visible {
            opacity: 1; 
            visibility: visible;
            pointer-events: auto; /* Crucial: Allow clicks when visible */
            display: flex; /* Only display flex when visible */
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            width: 100%;
            max-width: 32rem; /* max-w-md for login, max-w-2xl/3xl for others */
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem; /* p-6 */
        }
        /* Specific modal content sizes */
        #loginModal .modal-content { max-width: 28rem; } /* max-w-md */
        #aboutUsModal .modal-content { max-width: 32rem; } /* max-w-2xl */
        #privacyPolicyModal .modal-content, #termsAndConditionsModal .modal-content { max-width: 48rem; padding: 2rem; } /* max-w-3xl, p-8 */
        #orderDetailsModal .modal-content { max-width: 32rem; } /* max-w-lg */


        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }

        /* Status badge styling */
        .status-badge {
            @apply inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none rounded-full;
        }
        /* Specific status colors */
        .status-completed { @apply bg-green-200 text-green-800; }
        .status-re-offered-accepted { @apply bg-teal-200 text-teal-800; }
        .status-re-offered-auto-accepted { @apply bg-teal-200 text-teal-800; }
        .status-re-offered-pending { @apply bg-orange-200 text-orange-800; }
        .status-re-offered-declined { @apply bg-red-200 text-red-800; }
        .status-order_pending { @apply bg-blue-200 text-blue-800; }
        .status-shipping_kit_requested { @apply bg-indigo-200 text-indigo-800; }
        .status-label_generated { @apply bg-yellow-200 text-yellow-800; }
        .status-received { @apply bg-gray-200 text-gray-800; }
        .status-return-label-generated { @apply bg-gray-400 text-gray-800; }

        /* --- Chat Widget Styles --- */
        #chat-widget-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        #chat-open-btn {
            background-color: #2563eb; color: white;
            width: 4rem; height: 4rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            cursor: pointer; transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
        }
        #chat-open-btn:hover { transform: scale(1.1); }
        #unread-counter {
            position: absolute; top: -4px; right: -4px;
            background-color: #ef4444; color: white;
            border-radius: 9999px; font-size: 0.75rem; font-weight: bold;
            width: 1.5rem; height: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            transform: scale(0); transition: transform 0.2s ease-out;
        }
        #unread-counter.visible { transform: scale(1); }
        #chat-window {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24rem;
            height: 32rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
        #chat-window.is-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        #chat-window.is-visible + #chat-open-btn {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        #chat-messages { display: flex; flex-direction: column; }
        .chat-bubble-user { background-color: rgba(229, 231, 235, 0.7); } /* light grey transparent */
        .chat-bubble-agent { background-color: rgba(219, 234, 254, 0.7); } /* light blue transparent */
        .typing-indicator { display: flex; align-items: center; padding: 8px 12px; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: #9ca3af; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .star-rating i { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating:hover i, .star-rating i.selected { color: #f59e0b; }
        .star-rating i:hover ~ i { color: #d1d5db; }

        .prose {
            max-width: 65ch;
            color: #334155; /* slate-700 */
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }
        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }

        /* Mobile Styles */
        @media (max-width: 767px) {
            header .container {
                flex-direction: column;
                text-align: center;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            header .flex-1:first-child,
            header .flex-1:last-child {
                width: 100%;
                justify-content: center;
            }
            header .hidden.md\:flex { /* Target the hidden tagline on mobile */
                display: none !important;
            }
            header .h-20 {
                height: 4rem;
            }
            header nav {
                margin-top: 0.5rem;
                justify-content: center;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            footer .grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            footer .lg\:col-span-2 {
                grid-template-columns: 1fr;
            }
            footer .bg-slate-700 {
                margin-top: 1.5rem;
            }
            footer form {
                flex-direction: column;
            }
            footer button {
                width: 100%;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
            /* Chat window for mobile */
            #chat-widget-container {
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
            #chat-window {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
            #chat-open-btn {
                bottom: 1rem;
                right: 1rem;
                width: 3.5rem; /* Slightly smaller button */
                height: 3.5rem;
                font-size: 1.5rem; /* Smaller icon */
            }
            #chat-open-btn i {
                font-size: 1.5rem; /* Adjust icon size */
            }
            #unread-counter {
                width: 1.2rem;
                height: 1.2rem;
                font-size: 0.65rem;
            }
            /* Modal content adjustments for full screen on mobile */
            .modal-content {
                max-width: 100%;
                max-height: 100%;
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 1rem;
            }
            .modal-content .prose {
                max-height: calc(100vh - 100px); /* Adjust based on header/footer in modal */
                padding-right: 0.5rem;
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-5 flex justify-between items-center">
            <div class="flex-1">
                <a href="index.html" class="h-20 inline-block">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png" alt="SecondHandCell Logo" class="h-full w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <div class="hidden md:flex flex-col items-center flex-1">
                <div class="text-2xl font-extrabold text-slate-800">SecondHandCell</div>
                <p class="text-sm text-slate-500 -mt-1">Turn Your Old Phone into Cash!</p>
            </div>
            <nav class="flex items-center space-x-4 flex-1 justify-end">
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden">
                        <a href="my-account.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-center text-slate-800 mb-8">My Account</h1>

            <div id="message" class="mb-6 p-3 rounded-md text-sm text-center hidden"></div>

            <div class="flex border-b border-slate-200 mb-8">
                <button id="accountInfoTab" class="tab-button active flex-1 py-3 px-4 text-center text-lg font-medium text-slate-700 rounded-t-lg border-b-2 border-transparent hover:border-blue-400 hover:text-blue-600 transition duration-300">
                    Account Information
                </button>
                <button id="orderHistoryTab" class="tab-button flex-1 py-3 px-4 text-center text-lg font-medium text-slate-700 rounded-t-lg border-b-2 border-transparent hover:border-blue-400 hover:text-blue-600 transition duration-300">
                    Order History
                </button>
            </div>

            <div id="accountInfoSection" class="tab-content">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6">Your Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Full Name:</label>
                        <p id="userName" class="mt-1 text-lg text-slate-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Email Address:</label>
                        <p id="userEmail" class="mt-1 text-lg text-slate-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-slate-700">Phone Number:</label>
                        <input type="tel" id="userPhone" name="userPhone"
                               class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="e.g., +15551234567">
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="saveInfoBtn" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>

            <div id="orderHistorySection" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6">Your Past Orders</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-slate-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-slate-100 text-slate-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Device</th>
                                <th class="py-3 px-6 text-left">Quote</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-slate-700 text-sm font-light">
                            <tr><td colspan="6" class="text-center text-slate-500 py-4">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noOrdersMessage" class="text-slate-600 mt-4 text-center hidden">No orders found.</p>
            </div>
        </div>
    </main>

    <!-- FOOTER - Replaced with new footer from provided page -->
    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links</h3><ul class="space-y-2"><li><a href="index.html" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="#" id="privacyPolicyLink" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="#" id="termsAndConditionsLink" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p><p class="text-slate-400">Phone: (123) 456-7890</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <!-- MODALS -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Your SecondHandCell Account</h2>
            <div class="flex border-b border-slate-200 mb-6">
                <button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Login</button>
                <button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Sign Up</button>
            </div>
            <form id="loginForm" class="space-y-4">
                <p class="text-slate-600 text-center">Log in to continue with your order.</p>
                <button type="button" id="googleLoginBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Login with Google</button>
                <div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div>
                <div><label for="loginEmail" class="sr-only">Email Address</label><input type="email" id="loginEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="loginPassword" class="sr-only">Password</label><input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password"></div>
                <button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button>
                <p class="text-center text-sm text-slate-600">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-blue-600 font-semibold hover:underline">Reset it here</a></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Create an account to complete your order.</p>
                <button type="button" id="googleSignupBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Sign Up with Google</button>
                <div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div>
                <div><label for="signupName" class="sr-only">Full Name</label><input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="signupEmail" class="sr-only">Email Address</label><input type="email" id="signupEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="signupPassword" class="sr-only">Password</label><input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password"></div>
                <button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button>
                <p class="text-center text-sm text-slate-600">Already have an account? <a href="#" id="switchToLogin" class="text-blue-600 font-semibold hover:underline">Log in here</a></p>
            </form>
            <form id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Enter your email to receive a password reset link.</p>
                <div><label for="forgotEmail" class="sr-only">Email Address</label><input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button>
                <p class="text-center text-sm text-slate-600">Remember your password? <a href="#" id="returnToLogin" class="text-blue-600 font-semibold hover:underline">Return to Login</a></p>
            </form>
            <div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div>
        </div>
    </div>
    <!-- About Us Modal -->
    <div id="aboutUsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">About Us</h2>
            <p class="text-slate-600">Welcome to SecondHandCell, where we believe in giving old tech a new life. Our mission is to make selling your used devices as simple, safe, and rewarding as possible. We offer competitive prices, a hassle-free process, and a commitment to sustainability.</p>
        </div>
    </div>
    <!-- Privacy Policy Modal -->
    <div id="privacyPolicyModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="prose max-h-[80vh] overflow-y-auto pr-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Privacy Policy</h2>
                <p><strong>Last Updated: August 27, 2025</strong></p>
                <p>SecondHandCell ("we," "us," or "our") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website.</p>
                <h3>Information We Collect</h3>
                <p>We may collect personal information from you such as your name, email address, postal address, phone number, and payment information (e.g., Venmo, Zelle, or PayPal details). We also collect information about the device you are selling, including its model, serial number, and condition.</p>
                <h3>How We Use Your Information</h3>
                <p>We use the information we collect to: process your transactions; send you shipping kits and communicate about your order status; process payments; respond to customer service requests; send you marketing and promotional communications, with your consent.</p>
                <h3>Data Security and Wiping</h3>
                <p>We implement a variety of security measures to maintain the safety of your personal information. All devices sold to us undergo a certified, multi-pass data-wiping process to ensure your personal information is professionally and permanently erased.</p>
                <h3>Disclosure of Your Information</h3>
                <p>We do not sell, trade, or otherwise transfer to outside parties your Personally Identifiable Information except to trusted third parties who assist us in operating our website, conducting our business, or servicing you (such as shipping carriers), so long as those parties agree to keep this information confidential.</p>
                <h3>Your Consent</h3>
                <p>By using our site, you consent to our website's privacy policy.</p>
            </div>
        </div>
    </div>
    <!-- Terms & Conditions Modal -->
    <div id="termsAndConditionsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="prose max-h-[80vh] overflow-y-auto pr-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Terms & Conditions</h2>
                <p><strong>Last Updated: August 27, 2025</strong></p>
                <p>Please read these Terms and Conditions ("Terms") carefully before using the SecondHandCell website ("Service") operated by us.</p>
                <h3>1. User Obligations</h3>
                <p>By using the Service, you represent and warrant that:</p>
                <ul>
                    <li>You are the legal owner of the device you are selling.</li>
                    <li>The device is not reported as lost or stolen, and its IMEI is not blacklisted.</li>
                    <li>The device has no outstanding balance and is not subject to any financing or lease agreement.</li>
                    <li>All information you provide about the device is accurate and truthful.</li>
                </ul>
                <h3>2. The Offer Process</h3>
                <ul>
                    <li>The initial quote provided on our website is an estimate based on the information you provide.</li>
                    <li>Upon receiving your device, we will conduct a thorough inspection. If the device's condition differs from what was described, we will issue a revised offer via email.</li>
                    <li><strong>You have seven (7) days to accept or decline the revised offer. If you do not respond within this 7-day period, the revised offer will be automatically accepted on your behalf, and we will proceed with payment.</strong></li>
                    <li>Once an offer (initial or revised) is accepted, it is locked in and final. There is no option for a re-offer or to have the device returned.</li>
                </ul>
                <h3>3. Shipping and Risk of Loss</h3>
                <p>We provide a prepaid shipping label and materials. SecondHandCell is not responsible for any damage or loss that occurs before the device is received and scanned by our designated shipping carrier.</p>
                <h3>4. Limitation of Liability</h3>
                <p>In no event shall SecondHandCell, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <button id="closeModal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl transition-colors duration-200">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Order Details <span id="modalOrderId" class="text-blue-600"></span></h3>
            <div class="space-y-3 text-slate-700">
                <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
                <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                <p><strong>Item:</strong> <span id="modalItem"></span></p>
                <p><strong>Storage:</strong> <span id="modalStorage"></span></p>
                <p><strong>Carrier:</strong> <span id="modalCarrier"></span></p>
                <p><strong>Estimated Payout:</strong> $<span id="modalPrice"></span></p>
                <p><strong>Payment Method:</strong> <span id="modalPaymentMethod"></span></p>
                <p id="modalVenmoUsernameRow" class="hidden"><strong>Venmo Username:</strong> <span id="modalVenmoUsername"></span></p>
                <p><strong>Shipping Address:</strong> <span id="modalShippingAddress"></span></p>
                <p><strong>Conditions:</strong>
                    <ul class="list-disc list-inside ml-4 text-sm">
                        <li>Powers On: <span id="modalConditionPowerOn"></span></li>
                        <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                        <li>No Cracks: <span id="modalConditionCracks"></span></li>
                        <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                    </ul>
                </p>
                <p><strong>Current Status:</strong> <span id="modalStatus" class="font-semibold px-2 py-1 rounded-full text-xs"></span></p>

                <!-- Re-offer details -->
                <div id="reOfferDetails" class="hidden bg-yellow-50 p-4 rounded-md border border-yellow-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-yellow-800">Revised Offer Details</h4>
                    <p><strong>New Offer Price:</strong> $<span id="reOfferNewPrice" class="font-bold text-yellow-700"></span></p>
                    <p><strong>Reasons:</strong> <span id="reOfferReasons"></span></p>
                    <p id="reOfferCommentsRow" class="hidden"><strong>Comments:</strong> <span id="reOfferComments"></span></p>
                    <p id="reOfferAutoAcceptDateRow" class="text-sm text-slate-600">This offer will be automatically accepted on: <span id="reOfferAutoAcceptDate"></span></p>
                </div>
                
                <!-- Shipping Label / Tracking Info -->
                <div id="labelInfoSection" class="hidden bg-blue-50 p-4 rounded-md border border-blue-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-blue-800">Shipping Information</h4>
                    <p id="outboundLabelRow" class="hidden"><strong>Outbound Kit Tracking:</strong> <a id="outboundTrackingLink" href="#" target="_blank" class="text-blue-600 hover:underline"></a></p>
                    <p id="inboundLabelRow" class="hidden"><strong>Inbound Device Label:</strong> <a id="inboundLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="inboundTrackingNumber"></span>)</p>
                    <p id="uspsLabelRow" class="hidden"><strong>Shipping Label:</strong> <a id="uspsLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="uspsTrackingNumber"></span>)</p>
                    <p id="returnLabelRow" class="hidden"><strong>Return Label:</strong> <a id="returnLabelLink" href="#" target="_blank" class="text-red-600 hover:underline">View Label</a> (<span id="returnTrackingNumber"></span>)</p>
                </div>

                <p id="modalLoadingMessage" class="text-center text-blue-500 hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Processing request...</p>
            </div>

            <div id="modalActionButtons" class="mt-6 flex flex-col sm:flex-row gap-3">
                <!-- Action buttons will be rendered here dynamically -->
            </div>
            <div id="modalMessage" class="mt-4 p-3 text-sm rounded-md hidden"></div>
        </div>
    </div>


    <!-- CHAT WIDGET -->
    <div id="chat-widget-container">
        <div id="chat-window">
            <!-- Chat Header -->
            <div class="bg-blue-700 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Customer Support</h3>
                <div>
                    <button id="chat-minimize-btn" class="text-white hover:text-blue-200 mr-2"><i class="fa-solid fa-minus text-xl"></i></button>
                    <button id="chat-close-btn" class="text-white hover:text-blue-200"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50"></div>
            <!-- Typing Indicator -->
            <div id="typing-indicator-container" class="p-2 hidden">
                <div class="p-3 rounded-lg max-w-[85%] mb-2 break-words chat-bubble-agent">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            </div>
            <!-- Input Area -->
            <div id="chat-input-container" class="p-4 border-t border-slate-200">
                <input type="text" id="chat-input" placeholder="Type your message..." class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <!-- Guest Prompt -->
            <div id="guest-prompt-container" class="p-4 border-t border-slate-200 hidden">
                <p class="text-center text-sm text-slate-600 mb-3">To provide the best support, please log in or continue as a guest.</p>
                <div class="space-y-2">
                    <button id="guest-login-btn" class="btn-dark-slate">Login / Sign Up</button>
                    <button id="guest-continue-btn" class="w-full bg-slate-200 text-slate-800 p-3 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Ask a General Question</button>
                </div>
            </div>
            <!-- Survey -->
            <div id="chat-survey-container" class="p-4 border-t border-slate-200 hidden overflow-y-auto">
                <p class="text-center font-semibold mb-2">The agent has ended the chat.</p>
                <p class="text-center text-sm text-slate-600 mb-4">Please rate your experience.</p>
                <form id="chat-survey-form">
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Overall Rating:</label>
                        <div id="star-rating" class="star-rating text-3xl flex justify-center" data-rating="0">
                            <i class="fa-solid fa-star" data-value="1"></i><i class="fa-solid fa-star" data-value="2"></i><i class="fa-solid fa-star" data-value="3"></i><i class="fa-solid fa-star" data-value="4"></i><i class="fa-solid fa-star" data-value="5"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="friendliness-rating" class="font-semibold text-slate-700 block mb-2">Agent Friendliness: <span id="friendliness-value" class="font-bold text-blue-600">5</span>/10</label>
                        <input type="range" id="friendliness-rating" min="1" max="10" value="5" class="w-full">
                    </div>
                    <div class="mb-4">
                        <label class="font-semibold text-slate-700 block mb-2">Was your issue resolved?</label>
                        <div class="flex justify-center gap-4">
                            <label><input type="radio" name="issue-resolved" value="yes" class="mr-1"> Yes</label>
                            <label><input type="radio" name="issue-resolved" value="no" class="mr-1"> No</label>
                        </div>
                    </div>
                    <div class="mb-4">
                            <label for="survey-comments" class="font-semibold text-slate-700 block mb-2">Additional Comments (optional):</label>
                            <textarea id="survey-comments" rows="2" class="w-full border border-slate-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="btn-dark-slate">Submit Feedback</button>
                </form>
            </div>
            <!-- End Chat Confirmation -->
            <div id="end-chat-confirm-modal" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center p-4 z-10">
                <p class="text-lg font-semibold text-slate-800 mb-4 text-center">End this chat session?</p>
                <div class="flex gap-4">
                    <button id="end-chat-yes" class="px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition">Yes, End Chat</button>
                    <button id="end-chat-no" class="px-6 py-2 font-semibold text-slate-800 bg-slate-200 rounded-lg hover:bg-slate-300 transition">No</button>
                </div>
            </div>
        </div>
        <button id="chat-open-btn">
            <i class="fa-solid fa-comments text-3xl"></i>
            <span id="unread-counter">0</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updateProfile, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, where, addDoc, serverTimestamp, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "secondhandcell.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Backend URL for Cloud Functions
        const BACKEND_BASE_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

        // Get elements
        const loginNavBtn = document.getElementById('loginNavBtn'); // Login/Sign Up button in header
        const userMonogram = document.getElementById('userMonogram');
        const authDropdown = document.getElementById('authDropdown');
        const logoutButton = document.getElementById('logoutBtn');

        const accountInfoTab = document.getElementById('accountInfoTab');
        const orderHistoryTab = document.getElementById('orderHistoryTab');
        const accountInfoSection = document.getElementById('accountInfoSection');
        const orderHistorySection = document.getElementById('orderHistorySection');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoneInput = document.getElementById('userPhone');
        const saveInfoBtn = document.getElementById('saveInfoBtn');
        const messageDiv = document.getElementById('message');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        // Modals and their buttons
        const modals = document.querySelectorAll('.modal'); // All modals
        const loginModal = document.getElementById('loginModal');
        const aboutUsModal = document.getElementById('aboutUsModal');
        const privacyPolicyModal = document.getElementById('privacyPolicyModal');
        const termsAndConditionsModal = document.getElementById('termsAndConditionsModal');

        // Modal elements for Order Details
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalOrderId = document.getElementById('modalOrderId');
        const modalCustomerName = document.getElementById('modalCustomerName');
        const modalCustomerEmail = document.getElementById('modalCustomerEmail');
        const modalItem = document.getElementById('modalItem');
        const modalStorage = document.getElementById('modalStorage');
        const modalCarrier = document.getElementById('modalCarrier');
        const modalPrice = document.getElementById('modalPrice');
        const modalPaymentMethod = document.getElementById('modalPaymentMethod');
        const modalVenmoUsernameRow = document.getElementById('modalVenmoUsernameRow');
        const modalVenmoUsername = document.getElementById('modalVenmoUsername');
        const modalShippingAddress = document.getElementById('modalShippingAddress');
        const modalConditionPowerOn = document.getElementById('modalConditionPowerOn');
        const modalConditionFunctional = document.getElementById('modalConditionFunctional');
        const modalConditionCracks = document.getElementById('modalConditionCracks');
        const modalConditionCosmetic = document.getElementById('modalConditionCosmetic');
        const modalStatus = document.getElementById('modalStatus');
        const reOfferDetails = document.getElementById('reOfferDetails');
        const reOfferNewPrice = document.getElementById('reOfferNewPrice');
        const reOfferReasons = document.getElementById('reOfferReasons');
        const reOfferCommentsRow = document.getElementById('reOfferCommentsRow');
        const reOfferComments = document.getElementById('reOfferComments');
        const reOfferAutoAcceptDateRow = document.getElementById('reOfferAutoAcceptDateRow');
        const reOfferAutoAcceptDate = document.getElementById('reOfferAutoAcceptDate');
        const labelInfoSection = document.getElementById('labelInfoSection');
        const outboundLabelRow = document.getElementById('outboundLabelRow');
        const outboundTrackingLink = document.getElementById('outboundTrackingLink');
        const inboundLabelRow = document.getElementById('inboundLabelRow');
        const inboundLabelLink = document.getElementById('inboundLabelLink');
        const inboundTrackingNumber = document.getElementById('inboundTrackingNumber');
        const uspsLabelRow = document.getElementById('uspsLabelRow');
        const uspsLabelLink = document.getElementById('uspsLabelLink');
        const uspsTrackingNumber = document.getElementById('uspsTrackingNumber');
        const returnLabelRow = document.getElementById('returnLabelRow');
        const returnLabelLink = document.getElementById('returnLabelLink');
        const returnTrackingNumber = document.getElementById('returnTrackingNumber');

        const modalLoadingMessage = document.getElementById('modalLoadingMessage');
        const modalActionButtons = document.getElementById('modalActionButtons');
        const modalMessage = document.getElementById('modalMessage');

        // Footer elements for signup form
        const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
        const footerSignupMessage = document.getElementById('footerSignupMessage');

        // Login/Signup Modal specific elements
        const loginTabBtn = document.getElementById('loginTabBtn');
        const signupTabBtn = document.getElementById('signupTabBtn');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const authMessage = document.getElementById('authMessage');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleSignupBtn = document.getElementById('googleSignupBtn');
        const emailLoginBtn = document.getElementById('emailLoginBtn');
        const emailSignupBtn = document.getElementById('emailSignupBtn');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const returnToLoginLink = document.getElementById('returnToLogin');
        const switchToLoginLink = document.getElementById('switchToLogin');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');

        let currentUserId = null;

        // --- Helper Functions ---
        
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `mb-6 p-3 rounded-md text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-700' : type === 'error' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
            messageDiv.classList.remove('hidden');
        }
        
        function clearMessage() {
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
        }
        
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'completed': return 'status-completed';
                case 're-offered-accepted': return 'status-re-offered-accepted';
                case 're-offered-auto-accepted': return 'status-re-offered-auto-accepted';
                case 're-offered-pending': return 'status-re-offered-pending';
                case 're-offered-declined': return 'status-re-offered-declined';
                case 'order_pending': return 'status-order_pending';
                case 'shipping_kit_requested': return 'status-shipping_kit_requested';
                case 'label_generated': return 'status-label_generated';
                case 'received': return 'status-received';
                case 'return-label-generated': return 'status-return-label-generated';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        function formatStatus(status) {
            if (status === 'order_pending') {
                return 'Order Pending';
            }
            if (status === 'shipping_kit_requested') {
                return 'Shipping Kit Requested';
            }
            if (status === 'label_generated') {
                return 'Shipping Kit on the Way'; // Custom text for this status
            }
            return status.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            // Firestore Timestamps have a toDate() method
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000); // Handle Firestore Timestamp format
            return date.toLocaleDateString();
        }

        function formatCondition(condition) {
            return condition.charAt(0).toUpperCase() + condition.slice(1);
        }

        // --- Tab and UI Logic ---

        function showTab(tabToShow) {
            accountInfoSection.classList.add('hidden');
            orderHistorySection.classList.add('hidden');
            accountInfoTab.classList.remove('active');
            orderHistoryTab.classList.remove('active');

            if (tabToShow === 'accountInfo') {
                accountInfoSection.classList.remove('hidden');
                accountInfoTab.classList.add('active');
            } else if (tabToShow === 'orderHistory') {
                orderHistorySection.classList.remove('hidden');
                orderHistoryTab.classList.add('active');
                if (currentUserId) {
                    loadOrders(currentUserId);
                }
            }
            clearMessage();
        }

        accountInfoTab.addEventListener('click', () => showTab('accountInfo'));
        orderHistoryTab.addEventListener('click', () => showTab('orderHistory'));
        
        // --- Firebase Functions ---
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Failed to log out. Please try again.', 'error');
            }
        }
        
        function loadOrders(userId) {
            if (!userId) {
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
                return;
            }
            
            // Query the 'orders' collection for documents where 'userId' matches the current user's ID
            const ordersCollectionRef = collection(db, 'orders');
            const userOrdersQuery = query(ordersCollectionRef, where('userId', '==', userId));
            
            // Listen for real-time updates to the user's orders
            onSnapshot(userOrdersQuery, (snapshot) => {
                ordersTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        
                        let displayQuote = order.estimatedQuote || 0;
                        if (order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted') {
                            displayQuote = order.reOffer?.newPrice || displayQuote;
                        }

                        const row = document.createElement('tr');
                        row.className = 'border-b border-slate-200 hover:bg-slate-50 cursor-pointer'; // Updated border and hover colors
                        row.dataset.orderId = doc.id; // Add data attribute for click handler

                        row.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">${doc.id}</td>
                                <td class="py-3 px-6 text-left">${formatDate(order.createdAt)}</td>
                                <td class="py-3 px-6 text-left">${order.device || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">$${displayQuote.toFixed(2)}</td>
                                <td class="py-3 px-6 text-center">
                                    <span class="status-badge ${getStatusBadgeClass(order.status)}">${formatStatus(order.status)}</span>
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <button data-order-id="${doc.id}" class="view-details-btn text-blue-600 hover:text-blue-800 font-medium text-xs px-2 py-1 rounded-md bg-blue-100 hover:bg-blue-200 transition duration-200">View Details</button>
                                </td>
                            `;
                        ordersTableBody.appendChild(row);
                    });
                     // Add event listeners after all rows are added
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent row click from firing
                            openOrderDetailsModal(event.target.dataset.orderId);
                        });
                    });
                    document.querySelectorAll('#ordersTableBody tr').forEach(row => {
                        row.addEventListener('click', (event) => {
                            if (!event.target.closest('.view-details-btn')) { // Only open if not clicking the specific button
                                openOrderDetailsModal(row.dataset.orderId);
                            }
                        });
                    });

                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                showMessage('Failed to load orders. Please try again.', 'error');
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
            });
        }
        
        async function saveAccountInfo(userId, newName, phoneNumber) {
            if (!userId) {
                showMessage('User not authenticated. Please log in.', 'error');
                return;
            }
            saveInfoBtn.disabled = true;
            saveInfoBtn.textContent = 'Saving...';
            clearMessage();
        
            try {
                // Update Firebase Auth display name
                if (auth.currentUser && newName !== auth.currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    userName.textContent = newName; // Update UI immediately
                }

                // Update Firestore for phone number (and potentially other fields)
                // We're storing user-specific data in a 'users' collection,
                // with the document ID being the user's UID.
                const userDocRef = doc(db, `users/${userId}`);
                await setDoc(userDocRef, { phoneNumber: phoneNumber }, { merge: true });

                showMessage('Account information saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving account info:", error);
                showMessage('Failed to save account information. Please try again.', 'error');
            } finally {
                saveInfoBtn.disabled = false;
                saveInfoBtn.textContent = 'Save Changes';
            }
        }

        // --- General Modal Functions ---
        const openModal = (modalElement) => {
            console.log('Opening modal:', modalElement.id); // Debugging
            modalElement.classList.add('is-visible');
        };
        const closeModal = (modalElement) => {
            console.log('Attempting to close modal:', modalElement.id); // Debugging
            modalElement.classList.remove('is-visible');
        };

        document.querySelectorAll('.close-modal-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                console.log('Close button clicked.'); // Debugging
                const modal = e.target.closest('.modal');
                if (modal) {
                    closeModal(modal);
                } else {
                    console.error('Close button clicked, but no parent modal found.');
                }
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                console.log('Modal background clicked for:', modal.id); // Debugging
                // Check if the click occurred directly on the modal overlay, not on its content
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // --- Specific Modal Triggers ---
        loginNavBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(loginModal); });
        document.getElementById('aboutUsLink').addEventListener('click', (e) => { e.preventDefault(); openModal(aboutUsModal); });
        document.getElementById('privacyPolicyLink').addEventListener('click', (e) => { e.preventDefault(); openModal(privacyPolicyModal); });
        document.getElementById('termsAndConditionsLink').addEventListener('click', (e) => { e.preventDefault(); openModal(termsAndConditionsModal); });

        // --- Order Details Modal Functions ---

        async function openOrderDetailsModal(orderId) {
            // Reset modal state
            modalActionButtons.innerHTML = '';
            modalLoadingMessage.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';
            modalVenmoUsernameRow.classList.add('hidden');
            reOfferDetails.classList.add('hidden');
            labelInfoSection.classList.add('hidden');
            outboundLabelRow.classList.add('hidden');
            inboundLabelRow.classList.add('hidden');
            uspsLabelRow.classList.add('hidden');
            returnLabelRow.classList.add('hidden');

            openModal(orderDetailsModal); // Use the general openModal function
            modalLoadingMessage.classList.remove('hidden');

            try {
                console.log(`Attempting to fetch order details for ID: ${orderId} from URL: ${BACKEND_BASE_URL}/orders/${orderId}`); // Added logging
                const response = await fetch(`${BACKEND_BASE_URL}/orders/${orderId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Backend responded with status ${response.status}: ${errorText}`); // More detailed error logging
                    throw new Error(`Failed to fetch order details: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const order = await response.json();

                // Populate general order details
                modalOrderId.textContent = order.id;
                modalCustomerName.textContent = order.shippingInfo?.fullName || 'N/A';
                modalCustomerEmail.textContent = order.shippingInfo?.email || 'N/A';
                modalItem.textContent = order.device || 'N/A';
                modalStorage.textContent = order.storage || 'N/A';
                modalCarrier.textContent = order.carrier || 'N/A';
                modalPrice.textContent = order.estimatedQuote ? order.estimatedQuote.toFixed(2) : '0.00';
                modalPaymentMethod.textContent = order.paymentMethod ? formatCondition(order.paymentMethod) : 'N/A';
                if (order.paymentMethod === 'venmo' && order.paymentDetails?.venmoUsername) {
                    modalVenmoUsername.textContent = order.paymentDetails.venmoUsername;
                    modalVenmoUsernameRow.classList.remove('hidden');
                }
                modalShippingAddress.textContent = order.shippingInfo ? `${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state}, ${order.shippingInfo.zipCode}` : 'N/A';
                modalConditionPowerOn.textContent = order.condition_power_on ? formatCondition(order.condition_power_on) : 'N/A';
                modalConditionFunctional.textContent = order.condition_functional ? formatCondition(order.condition_functional) : 'N/A';
                modalConditionCracks.textContent = order.condition_cracks ? formatCondition(order.condition_cracks) : 'N/A';
                modalConditionCosmetic.textContent = order.condition_cosmetic ? formatCondition(order.condition_cosmetic) : 'N/A';
                
                modalStatus.textContent = formatStatus(order.status);
                modalStatus.className = `status-badge ${getStatusBadgeClass(order.status)}`;

                // Populate re-offer details if available
                if (order.reOffer && (order.status === 're-offered-pending' || order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted' || order.status === 're-offered-declined')) {
                    reOfferDetails.classList.remove('hidden');
                    reOfferNewPrice.textContent = order.reOffer.newPrice ? order.reOffer.newPrice.toFixed(2) : 'N/A';
                    reOfferReasons.textContent = order.reOffer.reasons?.join(', ') || 'N/A';
                    if (order.reOffer.comments) {
                        reOfferComments.textContent = order.reOffer.comments;
                        reOfferCommentsRow.classList.remove('hidden');
                    } else {
                        reOfferCommentsRow.classList.add('hidden');
                    }
                    if (order.reOffer.autoAcceptDate) {
                        reOfferAutoAcceptDate.textContent = formatDate(order.reOffer.autoAcceptDate);
                        reOfferAutoAcceptDateRow.classList.remove('hidden');
                    } else {
                        reOfferAutoAcceptDateRow.classList.add('hidden');
                    }
                }

                // Populate shipping label/tracking info
                if (order.shippingPreference === 'Shipping Kit Requested') {
                    labelInfoSection.classList.remove('hidden');
                    if (order.outboundTrackingNumber) {
                        outboundTrackingLink.href = `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`;
                        outboundTrackingLink.textContent = order.outboundTrackingNumber;
                        outboundLabelRow.classList.remove('hidden');
                    }
                    if (order.inboundLabelUrl) {
                        inboundLabelLink.href = order.inboundLabelUrl;
                        inboundTrackingNumber.textContent = order.inboundTrackingNumber || 'N/A';
                        inboundLabelRow.classList.remove('hidden');
                    }
                } else if (order.shippingPreference === 'Email Label Requested' && order.uspsLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    uspsLabelLink.href = order.uspsLabelUrl;
                    uspsTrackingNumber.textContent = order.trackingNumber || 'N/A';
                    uspsLabelRow.classList.remove('hidden');
                }

                // Populate return label info if exists
                if (order.returnLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    returnLabelLink.href = order.returnLabelUrl;
                    returnTrackingNumber.textContent = order.returnTrackingNumber || 'N/A';
                    returnLabelRow.classList.remove('hidden');
                }

                renderModalActionButtons(order);

            } catch (error) {
                console.error('Caught error fetching order details:', error); // More detailed error logging
                displayModalMessage(`Error fetching order details: ${error.message}. Please check your network and try again.`, 'error'); // More user-friendly message
            } finally {
                modalLoadingMessage.classList.add('hidden');
            }
        }

        function renderModalActionButtons(order) {
            modalActionButtons.innerHTML = '';
            const createButton = (text, onClick, className = 'bg-blue-600 hover:bg-blue-700') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `${className} text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow`;
                button.onclick = onClick;
                return button;
            };

            if (order.status === 're-offered-pending') {
                modalActionButtons.appendChild(createButton('Accept New Offer', () => handleModalAction(order.id, 'acceptOffer'), 'bg-green-600 hover:bg-green-700'));
                modalActionButtons.appendChild(createButton('Return My Phone', () => handleModalAction(order.id, 'returnPhone'), 'bg-red-600 hover:bg-red-700'));
            } else if (order.status === 'label_generated' && order.uspsLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Shipping Label', () => window.open(order.uspsLabelUrl, '_blank')));
            } else if (order.status === 'shipping_kit_requested' && order.outboundTrackingNumber) {
                 modalActionButtons.appendChild(createButton('Track Shipping Kit', () => window.open(`https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`, '_blank')));
            } else if (order.status === 're-offered-declined' && order.returnLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Return Label', () => window.open(order.returnLabelUrl, '_blank'), 'bg-red-600 hover:bg-red-700'));
            }
        }

        async function handleModalAction(orderId, actionType) {
            modalLoadingMessage.classList.remove('hidden');
            modalActionButtons.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';

            try {
                let url;
                let method = 'POST';
                let body = { orderId: orderId };

                switch(actionType) {
                    case 'acceptOffer':
                        url = `${BACKEND_BASE_URL}/accept-offer-action`;
                        break;
                    case 'returnPhone':
                        url = `${BACKEND_BASE_URL}/return-phone-action`;
                        break;
                    default:
                        throw new Error('Unknown action.');
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Failed to perform action: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const result = await response.json();
                
                displayModalMessage(result.message, 'success');
                // Re-open modal to refresh details with new status
                openOrderDetailsModal(orderId);

            } catch (error) {
                console.error("Action error:", error);
                displayModalMessage(`Error: ${error.message}`, 'error');
            } finally {
                modalLoadingMessage.classList.add('hidden');
                modalActionButtons.classList.remove('hidden');
            }
        }

        function displayModalMessage(message, type) {
            modalMessage.textContent = message;
            modalMessage.className = `mt-4 p-3 text-sm rounded-md`;
            if (type === 'success') {
                modalMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                modalMessage.classList.add('bg-red-100', 'text-red-700');
            }
            modalMessage.classList.remove('hidden');
        }

        // --- Event Listeners for Auth Modals ---
        loginTabBtn.addEventListener('click', () => showAuthTab('login'));
        signupTabBtn.addEventListener('click', () => showAuthTab('signup'));
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('forgotPassword'); });
        returnToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('login'); });
        switchToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('login'); });

        const googleProvider = new GoogleAuthProvider();
        const signInWithGoogle = async () => {
            try {
                authMessage.classList.add('hidden');
                await signInWithPopup(auth, googleProvider);
            } catch (error) { showAuthMessage(`Google sign-in failed: ${error.message}`, 'error'); }
        };
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        googleSignupBtn.addEventListener('click', signInWithGoogle);

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                showAuthMessage('Logging in...', 'info');
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showAuthMessage(`Login failed: ${error.message}`, 'error'); }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (password.length < 6) { showAuthMessage('Password must be at least 6 characters.', 'error'); return; }
            try {
                showAuthMessage('Creating account...', 'info');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
            } catch (error) { showAuthMessage(`Sign up failed: ${error.message}`, 'error'); }
        });
        
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            try {
                showAuthMessage('Sending reset email...', 'info');
                await sendPasswordResetEmail(auth, email);
                showAuthMessage('Password reset email sent! Check your inbox.', 'success');
            } catch (error) { showAuthMessage(`Failed to send email: ${error.message}`, 'error'); }
        });

        const showAuthTab = (tabName) => {
            authMessage.classList.add('hidden');
            [loginForm, signupForm, forgotPasswordForm].forEach(form => form.classList.add('hidden'));
            [loginTabBtn, signupTabBtn].forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-slate-500');
            });
            if (tabName === 'login') { loginForm.classList.remove('hidden'); loginTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
            else if (tabName === 'signup') { signupForm.classList.remove('hidden'); signupTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
            else if (tabName === 'forgotPassword') { forgotPasswordForm.classList.remove('hidden'); }
        };

        const showAuthMessage = (msg, type) => {
            authMessage.textContent = msg;
            authMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center w-full';
            if (type === 'error') authMessage.classList.add('bg-red-100', 'text-red-700');
            else if (type === 'success') authMessage.classList.add('bg-green-100', 'text-green-700');
            else authMessage.classList.add('bg-blue-100', 'text-blue-700');
            authMessage.classList.remove('hidden');
        };

        // --- Event Listeners ---
        
        // Handle dropdown for user monogram
        userMonogram.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent document click from closing it immediately
            authDropdown.classList.toggle('hidden');
        });

        // Close dropdown if clicking outside
        document.addEventListener('click', (e) => {
            const authStatusContainer = document.getElementById('authStatusContainer');
            if (authStatusContainer && !authStatusContainer.contains(e.target)) {
                authDropdown.classList.add('hidden');
            }
        });

        logoutButton.addEventListener('click', handleLogout);
        
        saveInfoBtn.addEventListener('click', () => {
            if (currentUserId) {
                const newName = userName.textContent; 
                saveAccountInfo(currentUserId, newName, userPhoneInput.value);
            } else {
                showMessage('Please log in to save your information.', 'error');
            }
        });

        // Footer email signup form submission
        footerEmailSignupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('footerPromoEmail').value;
            footerSignupMessage.textContent = 'Submitting...';
            footerSignupMessage.className = 'mt-3 text-sm text-center text-blue-300';
            
            try {
                await addDoc(collection(db, "signed_up_emails"), {
                    email: email,
                    timestamp: new Date()
                });
                footerSignupMessage.textContent = 'Success! Thanks for signing up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-green-300';
                footerEmailSignupForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                footerSignupMessage.textContent = 'Error: Could not sign up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-red-300';
            }
        });
        
        // --- Main Auth State Listener ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                // Update header UI for logged-in state
                loginNavBtn.classList.add('hidden'); // Hide the login/signup button
                userMonogram.classList.remove('hidden'); // Show user monogram
                
                // Get and set user initials for monogram
                const name = user.displayName || user.email;
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                userMonogram.textContent = initials;
                userMonogram.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 70%)`;

                // Update account details
                userName.textContent = user.displayName || 'N/A';
                userEmail.textContent = user.email || 'N/A';

                // Fetch phone number from Firestore and populate input field
                const userDocRef = doc(db, `users/${currentUserId}`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().phoneNumber) {
                        userPhoneInput.value = docSnap.data().phoneNumber;
                    } else {
                        userPhoneInput.value = '';
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showMessage('Could not load phone number.', 'error');
                }
                
                // Show account info by default
                showTab('accountInfo');
                closeModal(loginModal); // Close login modal if open after successful auth
                
            } else {
                // User is signed out, redirect to a non-authenticated page
                // Using window.location.replace to prevent going back to my-account.html
                window.location.replace(window.location.origin + '/index.html'); 
            }
        });

        // --- ADVANCED LIVE CHAT LOGIC ---
        const chatWindow = document.getElementById('chat-window');
        const chatOpenBtn = document.getElementById('chat-open-btn');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatMinimizeBtn = document.getElementById('chat-minimize-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatInputContainer = document.getElementById('chat-input-container');
        const guestPromptContainer = document.getElementById('guest-prompt-container');
        const guestLoginBtn = document.getElementById('guest-login-btn');
        const guestContinueBtn = document.getElementById('guest-continue-btn');
        const unreadCounter = document.getElementById('unread-counter');
        const typingIndicatorContainer = document.getElementById('typing-indicator-container');
        const surveyContainer = document.getElementById('chat-survey-container');
        const surveyForm = document.getElementById('chat-survey-form');
        const starRatingContainer = document.getElementById('star-rating');
        const friendlinessRating = document.getElementById('friendliness-rating');
        const friendlinessValue = document.getElementById('friendliness-value');
        const endChatConfirmModal = document.getElementById('end-chat-confirm-modal');
        const endChatYesBtn = document.getElementById('end-chat-yes');
        const endChatNoBtn = document.getElementById('end-chat-no');

        let currentChatId = null;
        let unsubscribeFromMessages = null;
        let unsubscribeFromChatSession = null;
        let isChatMinimized = true;
        let unreadCount = 0;
        let hasUserTypedFirstMessage = false;
        let userTypingTimeout = null;

        const notificationSound = new Audio('https://cdn.freesound.org/previews/253/253887_3900531-lq.mp3');
        notificationSound.volume = 0.5;

        const getOrCreateGuestId = () => {
            let id = localStorage.getItem('guestChatId');
            if (!id) {
                id = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                localStorage.setItem('guestChatId', id);
            }
            return id;
        };

        const getOrCreateChatSession = async () => {
            let chatId = localStorage.getItem('chatSessionId');
            if (chatId) return chatId;
            
            const user = auth.currentUser;
            const currentGuestId = getOrCreateGuestId();
            const chatSessionData = {
                createdAt: serverTimestamp(),
                ownerUid: user ? user.uid : null,
                guestId: user ? null : currentGuestId,
                status: 'active',
                agentName: null,
                isAgentTyping: false,
                userTypingText: ''
            };
            const docRef = await addDoc(collection(db, "chats"), chatSessionData);
            chatId = docRef.id;
            localStorage.setItem('chatSessionId', chatId);
            return chatId;
        };

        const renderChatMessage = (msg) => {
            const messageDiv = document.createElement('div');
            const user = auth.currentUser;
            const currentGuestId = localStorage.getItem('guestChatId');
            const isMyMessage = (user && msg.sender === user.uid) || (!user && msg.sender === currentGuestId);
            
            let classes = 'p-3 rounded-lg max-w-[85%] mb-2 break-words';
            if (msg.type === 'system') {
                classes = 'text-center text-sm text-slate-500 my-2';
                messageDiv.innerHTML = `<span class="bg-white px-2 py-1 rounded-full">${msg.text}</span>`;
            } else {
                classes += isMyMessage ? ' bg-gray-200 text-slate-800 self-end' : ' bg-blue-100 text-blue-800 self-start';
                messageDiv.textContent = msg.text;
            }
            messageDiv.className = classes;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        
        const listenForChatSessionChanges = (chatId) => {
            if (unsubscribeFromChatSession) unsubscribeFromChatSession();
            unsubscribeFromChatSession = onSnapshot(doc(db, "chats", chatId), (docSnap) => {
                const data = docSnap.data();
                if (!data) return;
                if (data.agentName && data.agentHasJoined && !document.getElementById(`agent-joined-${data.agentName}`)) {
                    const joinMsg = { type: 'system', text: `<i class="fa-solid fa-headset mr-2"></i>${data.agentName} has joined the chat.` };
                    const joinDiv = document.createElement('div');
                    joinDiv.id = `agent-joined-${data.agentName}`;
                    joinDiv.className = 'text-center text-sm text-slate-500 my-2';
                    joinDiv.innerHTML = `<span class="bg-white px-2 py-1 rounded-full">${joinMsg.text}</span>`;
                    chatMessages.appendChild(joinDiv);
                }
                typingIndicatorContainer.style.display = data.isAgentTyping ? 'block' : 'none';
                if (data.isAgentTyping) chatMessages.scrollTop = chatMessages.scrollHeight;
                if (data.status === 'ended_by_agent') {
                    chatInputContainer.classList.add('hidden');
                    guestPromptContainer.classList.add('hidden');
                    surveyContainer.classList.remove('hidden');
                    localStorage.removeItem('chatSessionId');
                }
            });
        };

        const listenForMessages = (chatId) => {
            if (unsubscribeFromMessages) unsubscribeFromMessages();
            currentChatId = chatId;
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp"));
            unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = ''; // Clear messages to prevent duplication
                if (snapshot.empty && !hasUserTypedFirstMessage) {
                    const user = auth.currentUser;
                    const userName = user?.displayName?.split(' ')[0] || 'there';
                    chatMessages.innerHTML = `<div class="p-3 rounded-lg max-w-[85%] mb-2 break-words bg-blue-100 text-blue-800 self-start">Hi ${userName}, how can we help you today?</div>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const msgData = doc.data();
                    renderChatMessage(msgData);
                    const user = auth.currentUser;
                    const currentGuestId = localStorage.getItem('guestChatId');
                    const isMyMessage = (user && msgData.sender === user.uid) || (!user && msgData.sender === currentGuestId);
                    if (!isMyMessage && isChatMinimized) {
                        unreadCount++;
                        unreadCounter.textContent = unreadCount;
                        unreadCounter.classList.add('visible');
                        notificationSound.play().catch(e => console.log("Audio play failed:", e));
                    }
                });
            });
        };

        const resetChatUI = () => {
            endChatConfirmModal.classList.add('hidden');
            endChatConfirmModal.classList.remove('flex');
            surveyContainer.classList.add('hidden');
            guestPromptContainer.classList.add('hidden');
            chatInputContainer.classList.remove('hidden');
            typingIndicatorContainer.style.display = 'none';
        };

        const openChat = async () => {
            console.log('Chat open button clicked.'); // Debugging
            resetChatUI();
            chatWindow.classList.add('is-visible');
            isChatMinimized = false;
            unreadCount = 0;
            unreadCounter.classList.remove('visible');
            const chatId = await getOrCreateChatSession();
            if (chatId) {
                listenForMessages(chatId);
                listenForChatSessionChanges(chatId);
            }
        };
        chatOpenBtn.addEventListener('click', openChat);

        const minimizeChat = () => {
            console.log('Chat minimize button clicked.'); // Debugging
            chatWindow.classList.remove('is-visible');
            isChatMinimized = true;
        };
        chatMinimizeBtn.addEventListener('click', minimizeChat);

        chatCloseBtn.addEventListener('click', () => {
            console.log('Chat close button clicked.'); // Debugging
            endChatConfirmModal.classList.remove('hidden');
            endChatConfirmModal.classList.add('flex');
        });

        endChatNoBtn.addEventListener('click', () => {
            console.log('Chat end (No) button clicked.'); // Debugging
            endChatConfirmModal.classList.add('hidden');
            endChatConfirmModal.classList.remove('flex');
        });

        endChatYesBtn.addEventListener('click', async () => {
            console.log('Chat end (Yes) button clicked.'); // Debugging
            if (currentChatId) {
                await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                    text: "Chat ended by user.",
                    timestamp: serverTimestamp(),
                    sender: 'system',
                    type: 'system'
                });
                await updateDoc(doc(db, "chats", currentChatId), { status: 'ended_by_user' });
            }
            localStorage.removeItem('chatSessionId');
            currentChatId = null;
            hasUserTypedFirstMessage = false;
            chatMessages.innerHTML = '';
            endChatConfirmModal.classList.add('hidden');
            endChatConfirmModal.classList.remove('flex');
            minimizeChat();
        });

        const sendMessage = async (text) => {
            if (text.trim() === '' || !currentChatId) return;
            const user = auth.currentUser;
            if (!user && !hasUserTypedFirstMessage) {
                hasUserTypedFirstMessage = true;
                chatInputContainer.classList.add('hidden');
                guestPromptContainer.classList.remove('hidden');
                return;
            }
            const currentGuestId = getOrCreateGuestId();
            const messageData = { text, timestamp: serverTimestamp(), sender: user ? user.uid : currentGuestId };
            await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
            chatInput.value = '';
            await updateDoc(doc(db, "chats", currentChatId), {
                userTypingText: '',
                lastMessage: `User: ${text}`,
                lastMessageTimestamp: serverTimestamp()
            });
        };

        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(chatInput.value); } });
        chatInput.addEventListener('keyup', () => {
            clearTimeout(userTypingTimeout);
            userTypingTimeout = setTimeout(async () => {
                if (currentChatId) {
                    await updateDoc(doc(db, "chats", currentChatId), { userTypingText: chatInput.value });
                }
            }, 300);
        });

        guestLoginBtn.addEventListener('click', () => {
            openModal(loginModal); // Open the login modal
            minimizeChat(); // Minimize chat window when opening login modal
        });
        guestContinueBtn.addEventListener('click', () => {
            guestPromptContainer.classList.add('hidden');
            chatInputContainer.classList.remove('hidden');
            renderChatMessage({ type: 'system', text: 'An agent will be with you shortly. Please provide any relevant details like order numbers.' });
            chatInput.focus();
        });

        friendlinessRating.addEventListener('input', (e) => { friendlinessValue.textContent = e.target.value; });
        starRatingContainer.addEventListener('mouseover', e => {
            if (e.target.tagName === 'I') {
                const rating = e.target.dataset.value;
                Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= rating));
            }
        });
        starRatingContainer.addEventListener('mouseout', () => {
            const currentRating = starRatingContainer.dataset.rating;
            Array.from(starRatingContainer.children).forEach(star => star.classList.toggle('selected', star.dataset.value <= currentRating));
        });
        starRatingContainer.addEventListener('click', e => {
            if (e.target.tagName === 'I') {
                starRatingContainer.dataset.rating = e.target.dataset.value;
            }
        });

        surveyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const surveyData = {
                overallRating: parseInt(starRatingContainer.dataset.rating, 10),
                friendliness: friendlinessRating.value,
                resolved: document.querySelector('input[name="issue-resolved"]:checked')?.value || null,
                comments: document.getElementById('survey-comments').value
            };
            await setDoc(doc(db, `chats/${currentChatId}/survey/feedback`), { ...surveyData, submittedAt: serverTimestamp() });
            try {
                const cloudFunctionUrl = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api/submit-chat-feedback';
                const response = await fetch(cloudFunctionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatId: currentChatId, surveyData: surveyData })
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                console.log('Feedback email sent successfully:', await response.json());
            } catch (error) { console.error("Error sending feedback email:", error); }
            surveyContainer.innerHTML = '<p class="text-center font-semibold text-green-600">Thank you for your feedback!</p>';
        });
    </script>
</body>
</html>
