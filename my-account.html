<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondHandCell - My Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SLRRJRXHHE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SLRRJRXHHE');
    </script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc; /* Tailwind slate-50 */
            color: #1e293b; /* Tailwind slate-800 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }
        @media (max-width: 767px) {
            body {
                font-size: 14px; /* Smaller base font size on mobile */
            }
        }
        .tab-button.active {
            border-color: #2563eb; /* Blue-600 */
            color: #2563eb; /* Blue-600 */
            background-color: #eff6ff; /* Blue-50 */
        }
        .user-monogram {
            display: flex; align-items: center; justify-content: center;
            width: 2.5rem; height: 2.5rem;
            border-radius: 9999px;
            background-color: #dbeafe; color: #1d4ed8; /* blue-100, blue-700 */
            font-weight: 700; font-size: 1.125rem;
            cursor: pointer; user-select: none;
        }
        .auth-dropdown {
            position: absolute; right: 0; margin-top: 0.5rem;
            width: 12rem; background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 0.25rem; padding-bottom: 0.25rem;
            z-index: 50;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0; 
            visibility: hidden;
            pointer-events: none;
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 1rem;
            align-items: center;
            justify-content: center;
        }
        .modal.is-visible {
            opacity: 1; 
            visibility: visible;
            pointer-events: auto;
            display: flex;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 32rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        .btn-red-logout {
            display: block; width: 100%; text-align: left;
            padding: 0.5rem 1rem; font-size: 0.875rem; color: #dc2626;
            background-color: transparent; border: none;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        .btn-red-logout:hover { background-color: #fef2f2; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 700;
            line-height: 1;
            border-radius: 9999px; /* rounded-full */
        }
        .status-completed { background-color: #dcfce7; color: #166534; } /* green-100, green-800 */
        .status-re-offered-accepted { background-color: #ccfbf1; color: #0f766e; } /* teal-100, teal-800 */
        .status-re-offered-auto-accepted { background-color: #ccfbf1; color: #0f766e; } /* teal-100, teal-800 */
        .status-re-offered-pending { background-color: #ffedd5; color: #9a3412; } /* orange-100, orange-800 */
        .status-re-offered-declined { background-color: #fee2e2; color: #991b1b; } /* red-100, red-800 */
        .status-order_pending { background-color: #dbeafe; color: #1e40af; } /* blue-100, blue-800 */
        .status-shipping_kit_requested { background-color: #e0e7ff; color: #3730a3; } /* indigo-100, indigo-800 */
        .status-label_generated { background-color: #fef9c3; color: #854d0e; } /* yellow-100, yellow-800 */
        .status-received { background-color: #e5e7eb; color: #374151; } /* gray-200, gray-800 */
        .status-return-label-generated { background-color: #e5e7eb; color: #374151; } /* gray-200, gray-800 */
        .prose {
            max-width: 65ch;
            color: #334155; /* slate-700 */
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        .btn-google-style {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: white; color: #475569;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .btn-google-style:hover { background-color: #f8fafc; }
        .btn-dark-slate {
            width: 100%; background-color: #1e293b; color: white;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn-dark-slate:hover { background-color: #0f172a; }

        /* Mobile Styles */
        @media (max-width: 767px) {
            header .container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            header .container > .flex-1:first-child {
                width: auto;
                flex-grow: 0;
            }
            header .container > .flex-1:last-child {
                width: auto;
                flex-grow: 0;
                justify-content: flex-end;
            }
            header .flex-col {
                display: none;
            }
            header .h-12 {
                height: 3rem;
            }
            header .md\:h-20 {
                height: 3rem;
            }
            header nav {
                margin-top: 0;
                justify-content: flex-end;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            footer .grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            footer .lg\:col-span-2 {
                grid-template-columns: 1fr;
            }
            footer .bg-slate-700 {
                margin-top: 1.5rem;
            }
            footer form {
                flex-direction: column;
            }
            footer button {
                width: 100%;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
            #loginNavBtn {
                font-size: 0.75rem;
                padding: 0.375rem 0.625rem;
                white-space: nowrap;
            }
            /* New table-specific mobile styles to prevent horizontal scroll */
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #e2e8f0;
                margin-bottom: 1rem;
                border-radius: 0.5rem;
                padding: 1rem;
            }
            td {
                border: none;
                position: relative;
                padding: 0.25rem 0;
                text-align: left;
                word-wrap: break-word; /* Ensure long words wrap */
            }
            td:before {
                content: attr(data-label);
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.625rem;
                color: #475569;
                display: block;
                margin-bottom: 0.25rem;
            }
            #ordersTableBody td:last-child {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                padding-top: 1rem;
            }
            #ordersTableBody td:last-child button {
                width: auto;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center md:py-5">
            <div class="flex-1">
                <a href="index.html" class="h-12 inline-block md:h-20">
                    <img src="https://raw.githubusercontent.com/ToratYosef/BuyBacking/refs/heads/main/assets/logo.png" alt="SecondHandCell Logo" class="h-full w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
                </a>
            </div>
            <div class="hidden md:flex flex-col items-center flex-1">
                <div class="text-2xl font-extrabold text-slate-800 fancy-header-text">SecondHandCell</div>
                <p class="text-sm text-slate-500 -mt-1 fancy-header-text">Turn Your Old Phone into Cash!</p>
            </div>
            <nav class="flex items-center space-x-4 flex-1 justify-end">
                <div id="authStatusContainer" class="relative inline-block">
                    <a href="#" id="loginNavBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Login/Sign Up</a>
                    <div id="userMonogram" class="user-monogram hidden"></div>
                    <div id="authDropdown" class="auth-dropdown hidden">
                        <a href="https://secondhandcell.com/my-account.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Account</a>
                        <button id="logoutBtn" class="btn-red-logout">Logout</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-center text-slate-800 mb-8">My Account</h1>
            <div id="message" class="mb-6 p-3 rounded-md text-sm text-center hidden"></div>
            <div class="flex border-b border-slate-200 mb-8 overflow-x-auto">
                <button id="accountInfoTab" class="tab-button active flex-1 py-3 px-4 text-center text-lg font-medium text-slate-700 rounded-t-lg border-b-2 border-transparent hover:border-blue-400 hover:text-blue-600 transition duration-300 whitespace-nowrap">
                    Account Information
                </button>
                <button id="orderHistoryTab" class="tab-button flex-1 py-3 px-4 text-center text-lg font-medium text-slate-700 rounded-t-lg border-b-2 border-transparent hover:border-blue-400 hover:text-blue-600 transition duration-300 whitespace-nowrap">
                    Order History
                </button>
            </div>

            <div id="accountInfoSection" class="tab-content">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6">Your Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Full Name:</label>
                        <p id="userName" class="mt-1 text-lg text-slate-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Email Address:</label>
                        <p id="userEmail" class="mt-1 text-lg text-slate-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-slate-700">Phone Number:</label>
                        <input type="tel" id="userPhone" name="userPhone"
                               class="mt-1 block w-full px-4 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="e.g., +15551234567">
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="saveInfoBtn" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>

            <div id="orderHistorySection" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6">Your Past Orders</h2>
                <div>
                    <table class="min-w-full bg-white border border-slate-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-slate-100 text-slate-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Device</th>
                                <th class="py-3 px-6 text-left">Quote</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-slate-700 text-sm font-light">
                            <tr><td colspan="6" class="text-center text-slate-500 py-4">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="noOrdersMessage" class="text-slate-600 mt-4 text-center hidden">No orders found.</p>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links</h3><ul class="space-y-2"><li><a href="index.html" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="#" id="privacyPolicyLink" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="#" id="termsAndConditionsLink" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p><p class="text-slate-400">Phone: (123) 456-7890</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <div id="footerSignupMessage" class="mt-3 text-sm text-center"></div>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm"><p>&copy; 2025 SecondHandCell. All rights reserved.</p></div>
        </div>
    </footer>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Your SecondHandCell Account</h2>
            <div class="flex border-b border-slate-200 mb-6">
                <button id="loginTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Login</button>
                <button id="signupTabBtn" class="flex-1 py-3 text-center text-lg font-medium border-b-2 border-transparent text-slate-500 hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">Sign Up</button>
            </div>
            <form id="loginForm" class="space-y-4">
                <p class="text-slate-600 text-center">Log in to continue with your order.</p>
                <button type="button" id="googleLoginBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Login with Google</button>
                <div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div>
                <div><label for="loginEmail" class="sr-only">Email Address</label><input type="email" id="loginEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="loginPassword" class="sr-only">Password</label><input type="password" id="loginPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password"></div>
                <button type="submit" id="emailLoginBtn" class="btn-dark-slate">Login</button>
                <p class="text-center text-sm text-slate-600">Forgot your password? <a href="#" id="forgotPasswordLink" class="text-blue-600 font-semibold hover:underline">Reset it here</a></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Create an account to complete your order.</p>
                <button type="button" id="googleSignupBtn" class="btn-google-style"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5 mr-3">Sign Up with Google</button>
                <div class="text-center text-slate-500 relative my-4"><span class="bg-white px-2 z-10 relative">or</span><hr class="absolute inset-0 top-1/2 border-t border-slate-200"></div>
                <div><label for="signupName" class="sr-only">Full Name</label><input type="text" id="signupName" placeholder="Full Name" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="signupEmail" class="sr-only">Email Address</label><input type="email" id="signupEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="signupPassword" class="sr-only">Password</label><input type="password" id="signupPassword" placeholder="Password" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password"></div>
                <button type="submit" id="emailSignupBtn" class="btn-dark-slate">Sign Up</button>
                <p class="text-center text-sm text-slate-600">Already have an account? <a href="#" id="switchToLogin" class="text-blue-600 font-semibold hover:underline">Log in here</a></p>
            </form>
            <form id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-slate-600 text-center">Enter your email to receive a password reset link.</p>
                <div><label for="forgotEmail" class="sr-only">Email Address</label><input type="email" id="forgotEmail" placeholder="Email Address" class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <button type="submit" id="sendResetEmailBtn" class="btn-dark-slate">Send Reset Email</button>
                <p class="text-center text-sm text-slate-600">Remember your password? <a href="#" id="returnToLogin" class="text-blue-600 font-semibold hover:underline">Return to Login</a></p>
            </form>
            <div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div>
        </div>
    </div>
    <div id="aboutUsModal" class="modal">
        <div class="modal-content max-w-2xl">
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">About Us</h2>
            <p class="text-slate-600">Welcome to SecondHandCell, where we believe in giving old tech a new life. Our mission is to make selling your used devices as simple, safe, and rewarding as possible. We offer competitive prices, a hassle-free process, and a commitment to sustainability.</p>
        </div>
    </div>
    <div id="privacyPolicyModal" class="modal">
        <div class="modal-content max-w-3xl p-8">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="prose max-h-[80vh] overflow-y-auto pr-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Privacy Policy</h2>
                <p><strong>Last Updated: August 27, 2025</strong></p>
                <p>SecondHandCell ("we," "us," or "our") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website.</p>
                <h3>Information We Collect</h3>
                <p>We may collect personal information from you such as your name, email address, postal address, phone number, and payment information (e.g., Venmo, Zelle, or PayPal details). We also collect information about the device you are selling, including its model, serial number, and condition.</p>
                <h3>How We Use Your Information</h3>
                <p>We use the information we collect to: process your transactions; send you shipping kits and communicate about your order status; process payments; respond to customer service requests; send you marketing and promotional communications, with your consent.</p>
                <h3>Data Security and Wiping</h3>
                <p>We implement a variety of security measures to maintain the safety of your personal information. All devices sold to us undergo a certified, multi-pass data-wiping process to ensure your personal information is professionally and permanently erased.</p>
                <h3>Disclosure of Your Information</h3>
                <p>We do not sell, trade, or otherwise transfer to outside parties your Personally Identifiable Information except to trusted third parties who assist us in operating our website, conducting our business, or servicing you (such as shipping carriers), so long as those parties agree to keep this information confidential.</p>
                <h3>Your Consent</h3>
                <p>By using our site, you consent to our website's privacy policy.</p>
            </div>
        </div>
    </div>
    <div id="termsAndConditionsModal" class="modal">
        <div class="modal-content max-w-3xl p-8">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors duration-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="prose max-h-[80vh] overflow-y-auto pr-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Terms & Conditions</h2>
                <p><strong>Last Updated: August 27, 2025</strong></p>
                <p>Please read these Terms and Conditions ("Terms") carefully before using the SecondHandCell website ("Service") operated by us.</p>
                <h3>1. User Obligations</h3>
                <p>By using the Service, you represent and warrant that:</p>
                <ul>
                    <li>You are the legal owner of the device you are selling.</li>
                    <li>The device is not reported as lost or stolen, and its IMEI is not blacklisted.</li>
                    <li>The device has no outstanding balance and is not subject to any financing or lease agreement.</li>
                    <li>All information you provide about the device is accurate and truthful.</li>
                </ul>
                <h3>2. The Offer Process</h3>
                <ul>
                    <li>The initial quote provided on our website is an estimate based on the information you provide.</li>
                    <li>Upon receiving your device, we will conduct a thorough inspection. If the device's condition differs from what was described, we will issue a revised offer via email.</li>
                    <li><strong>You have seven (7) days to accept or decline the revised offer. If you do not respond within this 7-day period, the revised offer will be automatically accepted on your behalf, and we will proceed with payment.</strong></li>
                    <li>Once an offer (initial or revised) is accepted, it is locked in and final. There is no option for a re-offer or to have the device returned.</li>
                </ul>
                <h3>3. Shipping and Risk of Loss</h3>
                <p>We provide a prepaid shipping label and materials. SecondHandCell is not responsible for any damage or loss that occurs before the device is received and scanned by our designated shipping carrier.</p>
                <h3>4. Limitation of Liability</h3>
                <p>In no event shall SecondHandCell, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your access to or use of or inability to access or use the Service.</p>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal">
        <div class="modal-content max-w-lg">
            <button id="closeModal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl transition-colors duration-200">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Order Details <span id="modalOrderId" class="text-blue-600"></span></h3>
            <div class="space-y-3 text-slate-700">
                <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
                <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                <p><strong>Item:</strong> <span id="modalItem"></span></p>
                <p><strong>Storage:</strong> <span id="modalStorage"></span></p>
                <p><strong>Carrier:</strong> <span id="modalCarrier"></span></p>
                <p><strong>Estimated Payout:</strong> $<span id="modalPrice"></span></p>
                <p><strong>Payment Method:</strong> <span id="modalPaymentMethod"></span></p>
                <p id="modalVenmoUsernameRow" class="hidden"><strong>Venmo Username:</strong> <span id="modalVenmoUsername"></span></p>
                <p><strong>Shipping Address:</strong> <span id="modalShippingAddress"></span></p>
                <p><strong>Conditions:</strong>
                    <ul class="list-disc list-inside ml-4 text-sm">
                        <li>Powers On: <span id="modalConditionPowerOn"></span></li>
                        <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                        <li>No Cracks: <span id="modalConditionCracks"></span></li>
                        <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                    </ul>
                </p>
                <p><strong>Current Status:</strong> <span id="modalStatus" class="font-semibold px-2 py-1 rounded-full text-xs"></span></p>

                <div id="reOfferDetails" class="hidden bg-yellow-50 p-4 rounded-md border border-yellow-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-yellow-800">Revised Offer Details</h4>
                    <p><strong>New Offer Price:</strong> $<span id="reOfferNewPrice" class="font-bold text-yellow-700"></span></p>
                    <p><strong>Reasons:</strong> <span id="reOfferReasons"></span></p>
                    <p id="reOfferCommentsRow" class="hidden"><strong>Comments:</strong> <span id="reOfferComments"></span></p>
                    <p id="reOfferAutoAcceptDateRow" class="text-sm text-slate-600">This offer will be automatically accepted on: <span id="reOfferAutoAcceptDate"></span></p>
                </div>
                
                <div id="labelInfoSection" class="hidden bg-blue-50 p-4 rounded-md border border-blue-200 mt-4 space-y-2">
                    <h4 class="text-lg font-semibold text-blue-800">Shipping Information</h4>
                    <p id="outboundLabelRow" class="hidden"><strong>Outbound Kit Tracking:</strong> <a id="outboundTrackingLink" href="#" target="_blank" class="text-blue-600 hover:underline"></a></p>
                    <p id="inboundLabelRow" class="hidden"><strong>Inbound Device Label:</strong> <a id="inboundLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="inboundTrackingNumber"></span>)</p>
                    <p id="uspsLabelRow" class="hidden"><strong>Shipping Label:</strong> <a id="uspsLabelLink" href="#" target="_blank" class="text-blue-600 hover:underline">View Label</a> (<span id="uspsTrackingNumber"></span>)</p>
                    <p id="returnLabelRow" class="hidden"><strong>Return Label:</strong> <a id="returnLabelLink" href="#" target="_blank" class="text-red-600 hover:underline">View Label</a> (<span id="returnTrackingNumber"></span>)</p>
                </div>

                <p id="modalLoadingMessage" class="text-center text-blue-500 hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Processing request...</p>
            </div>

            <div id="modalActionButtons" class="mt-6 flex flex-col sm:flex-row gap-3">
            </div>
            <div id="modalMessage" class="mt-4 p-3 text-sm rounded-md hidden"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updateProfile, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, where, addDoc, serverTimestamp, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "auth.secondhandcell.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Backend URL for Cloud Functions
        const BACKEND_BASE_URL = 'https://us-central1-buyback-a0f05.cloudfunctions.net/api';

        // Get elements
        const loginNavBtn = document.getElementById('loginNavBtn');
        const userMonogram = document.getElementById('userMonogram');
        const authDropdown = document.getElementById('authDropdown');
        const logoutButton = document.getElementById('logoutBtn');

        const accountInfoTab = document.getElementById('accountInfoTab');
        const orderHistoryTab = document.getElementById('orderHistoryTab');
        const accountInfoSection = document.getElementById('accountInfoSection');
        const orderHistorySection = document.getElementById('orderHistorySection');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoneInput = document.getElementById('userPhone');
        const saveInfoBtn = document.getElementById('saveInfoBtn');
        const messageDiv = document.getElementById('message');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        // Modals and their buttons
        const modals = document.querySelectorAll('.modal');
        const loginModal = document.getElementById('loginModal');
        const aboutUsModal = document.getElementById('aboutUsModal');
        const privacyPolicyModal = document.getElementById('privacyPolicyModal');
        const termsAndConditionsModal = document.getElementById('termsAndConditionsModal');

        // Modal elements for Order Details
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalOrderId = document.getElementById('modalOrderId');
        const modalCustomerName = document.getElementById('modalCustomerName');
        const modalCustomerEmail = document.getElementById('modalCustomerEmail');
        const modalItem = document.getElementById('modalItem');
        const modalStorage = document.getElementById('modalStorage');
        const modalCarrier = document.getElementById('modalCarrier');
        const modalPrice = document.getElementById('modalPrice');
        const modalPaymentMethod = document.getElementById('modalPaymentMethod');
        const modalVenmoUsernameRow = document.getElementById('modalVenmoUsernameRow');
        const modalVenmoUsername = document.getElementById('modalVenmoUsername');
        const modalShippingAddress = document.getElementById('modalShippingAddress');
        const modalConditionPowerOn = document.getElementById('modalConditionPowerOn');
        const modalConditionFunctional = document.getElementById('modalConditionFunctional');
        const modalConditionCracks = document.getElementById('modalConditionCracks');
        const modalConditionCosmetic = document.getElementById('modalConditionCosmetic');
        const modalStatus = document.getElementById('modalStatus');
        const reOfferDetails = document.getElementById('reOfferDetails');
        const reOfferNewPrice = document.getElementById('reOfferNewPrice');
        const reOfferReasons = document.getElementById('reOfferReasons');
        const reOfferCommentsRow = document.getElementById('reOfferCommentsRow');
        const reOfferComments = document.getElementById('reOfferComments');
        const reOfferAutoAcceptDateRow = document.getElementById('reOfferAutoAcceptDateRow');
        const reOfferAutoAcceptDate = document.getElementById('reOfferAutoAcceptDate');
        const labelInfoSection = document.getElementById('labelInfoSection');
        const outboundLabelRow = document.getElementById('outboundLabelRow');
        const outboundTrackingLink = document.getElementById('outboundTrackingLink');
        const inboundLabelRow = document.getElementById('inboundLabelRow');
        const inboundLabelLink = document.getElementById('inboundLabelLink');
        const inboundTrackingNumber = document.getElementById('inboundTrackingNumber');
        const uspsLabelRow = document.getElementById('uspsLabelRow');
        const uspsLabelLink = document.getElementById('uspsLabelLink');
        const uspsTrackingNumber = document.getElementById('uspsTrackingNumber');
        const returnLabelRow = document.getElementById('returnLabelRow');
        const returnLabelLink = document.getElementById('returnLabelLink');
        const returnTrackingNumber = document.getElementById('returnTrackingNumber');
        const modalLoadingMessage = document.getElementById('modalLoadingMessage');
        const modalActionButtons = document.getElementById('modalActionButtons');
        const modalMessage = document.getElementById('modalMessage');

        // Footer elements for signup form
        const footerEmailSignupForm = document.getElementById('footerEmailSignupForm');
        const footerSignupMessage = document.getElementById('footerSignupMessage');

        // Login/Signup Modal specific elements
        const loginTabBtn = document.getElementById('loginTabBtn');
        const signupTabBtn = document.getElementById('signupTabBtn');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const authMessage = document.getElementById('authMessage');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleSignupBtn = document.getElementById('googleSignupBtn');
        const emailLoginBtn = document.getElementById('emailLoginBtn');
        const emailSignupBtn = document.getElementById('emailSignupBtn');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const returnToLoginLink = document.getElementById('returnToLogin');
        const switchToLoginLink = document.getElementById('switchToLogin');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');

        let currentUserId = null;

        // --- Helper Functions ---
        
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `mb-6 p-3 rounded-md text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-700' : type === 'error' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
            messageDiv.classList.remove('hidden');
        }
        
        function clearMessage() {
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
        }
        
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'completed': return 'status-completed';
                case 're-offered-accepted': return 'status-re-offered-accepted';
                case 're-offered-auto-accepted': return 'status-re-offered-auto-accepted';
                case 're-offered-pending': return 'status-re-offered-pending';
                case 're-offered-declined': return 'status-re-offered-declined';
                case 'order_pending': return 'status-order_pending';
                case 'shipping_kit_requested': return 'status-shipping_kit_requested';
                case 'label_generated': return 'status-label_generated';
                case 'received': return 'status-received';
                case 'return-label-generated': return 'status-return-label-generated';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        function formatStatus(status) {
            if (status === 'order_pending') {
                return 'Order Pending';
            }
            if (status === 'shipping_kit_requested') {
                return 'Shipping Kit Requested';
            }
            if (status === 'label_generated') {
                return 'Shipping Kit on the Way';
            }
            return status.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString();
        }

        function formatCondition(condition) {
            return condition.charAt(0).toUpperCase() + condition.slice(1);
        }

        // --- Tab and UI Logic ---

        function showTab(tabToShow) {
            accountInfoSection.classList.add('hidden');
            orderHistorySection.classList.add('hidden');
            accountInfoTab.classList.remove('active');
            orderHistoryTab.classList.remove('active');

            if (tabToShow === 'accountInfo') {
                accountInfoSection.classList.remove('hidden');
                accountInfoTab.classList.add('active');
            } else if (tabToShow === 'orderHistory') {
                orderHistorySection.classList.remove('hidden');
                orderHistoryTab.classList.add('active');
                if (currentUserId) {
                    loadOrders(currentUserId);
                }
            }
            clearMessage();
        }

        accountInfoTab.addEventListener('click', () => showTab('accountInfo'));
        orderHistoryTab.addEventListener('click', () => showTab('orderHistory'));
        
        // --- Firebase Functions ---
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Failed to log out. Please try again.', 'error');
            }
        }
        
        function loadOrders(userId) {
            if (!userId) {
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
                return;
            }
            
            const ordersCollectionRef = collection(db, 'orders');
            const userOrdersQuery = query(ordersCollectionRef, where('userId', '==', userId));
            
            onSnapshot(userOrdersQuery, (snapshot) => {
                ordersTableBody.innerHTML = '';
                if (snapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        
                        let displayQuote = order.estimatedQuote || 0;
                        if (order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted') {
                            displayQuote = order.reOffer?.newPrice || displayQuote;
                        }

                        const row = document.createElement('tr');
                        row.className = 'border-b border-slate-200 hover:bg-slate-50 cursor-pointer';
                        row.dataset.orderId = doc.id;

                        row.innerHTML = `
                                <td class="py-3 px-6 text-left" data-label="Order ID">${doc.id}</td>
                                <td class="py-3 px-6 text-left" data-label="Date">${formatDate(order.createdAt)}</td>
                                <td class="py-3 px-6 text-left" data-label="Device">${order.device || 'N/A'}</td>
                                <td class="py-3 px-6 text-left" data-label="Quote">$${displayQuote.toFixed(2)}</td>
                                <td class="py-3 px-6 text-center" data-label="Status">
                                    <span class="status-badge ${getStatusBadgeClass(order.status)}">${formatStatus(order.status)}</span>
                                </td>
                                <td class="py-3 px-6 text-center" data-label="Actions">
                                    <button data-order-id="${doc.id}" class="view-details-btn text-blue-600 hover:text-blue-800 font-medium text-xs px-2 py-1 rounded-md bg-blue-100 hover:bg-blue-200 transition duration-200">View Details</button>
                                </td>
                            `;
                        ordersTableBody.appendChild(row);
                    });
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation();
                            openOrderDetailsModal(event.target.dataset.orderId);
                        });
                    });
                    document.querySelectorAll('#ordersTableBody tr').forEach(row => {
                        row.addEventListener('click', (event) => {
                            if (!event.target.closest('.view-details-btn')) {
                                openOrderDetailsModal(row.dataset.orderId);
                            }
                        });
                    });
                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                showMessage('Failed to load orders. Please try again.', 'error');
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
            });
        }
        
        async function saveAccountInfo(userId, newName, phoneNumber) {
            if (!userId) {
                showMessage('User not authenticated. Please log in.', 'error');
                return;
            }
            saveInfoBtn.disabled = true;
            saveInfoBtn.textContent = 'Saving...';
            clearMessage();
        
            try {
                if (auth.currentUser && newName !== auth.currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    userName.textContent = newName;
                }

                const userDocRef = doc(db, `users/${userId}`);
                await setDoc(userDocRef, { phoneNumber: phoneNumber }, { merge: true });

                showMessage('Account information saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving account info:", error);
                showMessage('Failed to save account information. Please try again.', 'error');
            } finally {
                saveInfoBtn.disabled = false;
                saveInfoBtn.textContent = 'Save Changes';
            }
        }

        // --- General Modal Functions ---
        const openModal = (modalElement) => {
            modalElement.classList.add('is-visible');
        };
        const closeModal = (modalElement) => {
            modalElement.classList.remove('is-visible');
        };

        document.querySelectorAll('.close-modal-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) {
                    closeModal(modal);
                }
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // --- Specific Modal Triggers ---
        loginNavBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(loginModal); });
        document.getElementById('aboutUsLink').addEventListener('click', (e) => { e.preventDefault(); openModal(aboutUsModal); });
        document.getElementById('privacyPolicyLink').addEventListener('click', (e) => { e.preventDefault(); openModal(privacyPolicyModal); });
        document.getElementById('termsAndConditionsLink').addEventListener('click', (e) => { e.preventDefault(); openModal(termsAndConditionsModal); });

        // --- Order Details Modal Functions ---

        async function openOrderDetailsModal(orderId) {
            modalActionButtons.innerHTML = '';
            modalLoadingMessage.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';
            modalVenmoUsernameRow.classList.add('hidden');
            reOfferDetails.classList.add('hidden');
            labelInfoSection.classList.add('hidden');
            outboundLabelRow.classList.add('hidden');
            inboundLabelRow.classList.add('hidden');
            uspsLabelRow.classList.add('hidden');
            returnLabelRow.classList.add('hidden');

            openModal(orderDetailsModal);
            modalLoadingMessage.classList.remove('hidden');

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/orders/${orderId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch order details: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const order = await response.json();

                modalOrderId.textContent = order.id;
                modalCustomerName.textContent = order.shippingInfo?.fullName || 'N/A';
                modalCustomerEmail.textContent = order.shippingInfo?.email || 'N/A';
                modalItem.textContent = order.device || 'N/A';
                modalStorage.textContent = order.storage || 'N/A';
                modalCarrier.textContent = order.carrier || 'N/A';
                modalPrice.textContent = order.estimatedQuote ? order.estimatedQuote.toFixed(2) : '0.00';
                modalPaymentMethod.textContent = order.paymentMethod ? formatCondition(order.paymentMethod) : 'N/A';
                if (order.paymentMethod === 'venmo' && order.paymentDetails?.venmoUsername) {
                    modalVenmoUsername.textContent = order.paymentDetails.venmoUsername;
                    modalVenmoUsernameRow.classList.remove('hidden');
                }
                modalShippingAddress.textContent = order.shippingInfo ? `${order.shippingInfo.streetAddress}, ${order.shippingInfo.city}, ${order.shippingInfo.state}, ${order.shippingInfo.zipCode}` : 'N/A';
                modalConditionPowerOn.textContent = order.condition_power_on ? formatCondition(order.condition_power_on) : 'N/A';
                modalConditionFunctional.textContent = order.condition_functional ? formatCondition(order.condition_functional) : 'N/A';
                modalConditionCracks.textContent = order.condition_cracks ? formatCondition(order.condition_cracks) : 'N/A';
                modalConditionCosmetic.textContent = order.condition_cosmetic ? formatCondition(order.condition_cosmetic) : 'N/A';
                
                modalStatus.textContent = formatStatus(order.status);
                modalStatus.className = `status-badge ${getStatusBadgeClass(order.status)}`;

                if (order.reOffer && (order.status === 're-offered-pending' || order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted' || order.status === 're-offered-declined')) {
                    reOfferDetails.classList.remove('hidden');
                    reOfferNewPrice.textContent = order.reOffer.newPrice ? order.reOffer.newPrice.toFixed(2) : 'N/A';
                    reOfferReasons.textContent = order.reOffer.reasons?.join(', ') || 'N/A';
                    if (order.reOffer.comments) {
                        reOfferComments.textContent = order.reOffer.comments;
                        reOfferCommentsRow.classList.remove('hidden');
                    } else {
                        reOfferCommentsRow.classList.add('hidden');
                    }
                    if (order.reOffer.autoAcceptDate) {
                        reOfferAutoAcceptDate.textContent = formatDate(order.reOffer.autoAcceptDate);
                        reOfferAutoAcceptDateRow.classList.remove('hidden');
                    } else {
                        reOfferAutoAcceptDateRow.classList.add('hidden');
                    }
                }

                if (order.shippingPreference === 'Shipping Kit Requested') {
                    labelInfoSection.classList.remove('hidden');
                    if (order.outboundTrackingNumber) {
                        outboundTrackingLink.href = `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`;
                        outboundTrackingLink.textContent = order.outboundTrackingNumber;
                        outboundLabelRow.classList.remove('hidden');
                    }
                    if (order.inboundLabelUrl) {
                        inboundLabelLink.href = order.inboundLabelUrl;
                        inboundTrackingNumber.textContent = order.inboundTrackingNumber || 'N/A';
                        inboundLabelRow.classList.remove('hidden');
                    }
                } else if (order.shippingPreference === 'Email Label Requested' && order.uspsLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    uspsLabelLink.href = order.uspsLabelUrl;
                    uspsTrackingNumber.textContent = order.trackingNumber || 'N/A';
                    uspsLabelRow.classList.remove('hidden');
                }

                if (order.returnLabelUrl) {
                    labelInfoSection.classList.remove('hidden');
                    returnLabelLink.href = order.returnLabelUrl;
                    returnTrackingNumber.textContent = order.returnTrackingNumber || 'N/A';
                    returnLabelRow.classList.remove('hidden');
                }

                renderModalActionButtons(order);

            } catch (error) {
                console.error("Action error:", error);
                displayModalMessage(`Error: ${error.message}`, 'error');
            } finally {
                modalLoadingMessage.classList.add('hidden');
            }
        }

        function renderModalActionButtons(order) {
            modalActionButtons.innerHTML = '';
            const createButton = (text, onClick, className = 'bg-blue-600 hover:bg-blue-700') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `${className} text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow`;
                button.onclick = onClick;
                return button;
            };

            if (order.status === 're-offered-pending') {
                modalActionButtons.appendChild(createButton('Accept New Offer', () => handleModalAction(order.id, 'acceptOffer'), 'bg-green-600 hover:bg-green-700'));
                modalActionButtons.appendChild(createButton('Return My Phone', () => handleModalAction(order.id, 'returnPhone'), 'bg-red-600 hover:bg-red-700'));
            } else if (order.status === 'label_generated' && order.uspsLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Shipping Label', () => window.open(order.uspsLabelUrl, '_blank')));
            } else if (order.status === 'shipping_kit_requested' && order.outboundTrackingNumber) {
                 modalActionButtons.appendChild(createButton('Track Shipping Kit', () => window.open(`https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.outboundTrackingNumber}`, '_blank')));
            } else if (order.status === 're-offered-declined' && order.returnLabelUrl) {
                 modalActionButtons.appendChild(createButton('Print Return Label', () => window.open(order.returnLabelUrl, '_blank'), 'bg-red-600 hover:bg-red-700'));
            }
        }

        async function handleModalAction(orderId, actionType) {
            modalLoadingMessage.classList.remove('hidden');
            modalActionButtons.classList.add('hidden');
            modalMessage.classList.add('hidden');
            modalMessage.textContent = '';

            try {
                let url;
                let method = 'POST';
                let body = { orderId: orderId };

                switch(actionType) {
                    case 'acceptOffer':
                        url = `${BACKEND_BASE_URL}/accept-offer-action`;
                        break;
                    case 'returnPhone':
                        url = `${BACKEND_BASE_URL}/return-phone-action`;
                        break;
                    default:
                        throw new Error('Unknown action.');
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Failed to perform action: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                const result = await response.json();
                
                displayModalMessage(result.message, 'success');
                openOrderDetailsModal(orderId);

            } catch (error) {
                console.error("Action error:", error);
                displayModalMessage(`Error: ${error.message}`, 'error');
            } finally {
                modalLoadingMessage.classList.add('hidden');
            }
        }

        function displayModalMessage(message, type) {
            modalMessage.textContent = message;
            modalMessage.className = `mt-4 p-3 text-sm rounded-md`;
            if (type === 'success') {
                modalMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                modalMessage.classList.add('bg-red-100', 'text-red-700');
            }
            modalMessage.classList.remove('hidden');
        }

        // --- Event Listeners for Auth Modals ---
        loginTabBtn.addEventListener('click', () => showAuthTab('login'));
        signupTabBtn.addEventListener('click', () => showAuthTab('signup'));
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('forgotPassword'); });
        returnToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('login'); });
        switchToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthTab('login'); });

        const googleProvider = new GoogleAuthProvider();
        const signInWithGoogle = async () => {
            try {
                authMessage.classList.add('hidden');
                await signInWithPopup(auth, googleProvider);
            } catch (error) { showAuthMessage(`Google sign-in failed: ${error.message}`, 'error'); }
        };
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        googleSignupBtn.addEventListener('click', signInWithGoogle);

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                showAuthMessage('Logging in...', 'info');
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showAuthMessage(`Login failed: ${error.message}`, 'error'); }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (password.length < 6) { showAuthMessage('Password must be at least 6 characters.', 'error'); return; }
            try {
                showAuthMessage('Creating account...', 'info');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
            } catch (error) { showAuthMessage(`Sign up failed: ${error.message}`, 'error'); }
        });
        
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            try {
                showAuthMessage('Sending reset email...', 'info');
                await sendPasswordResetEmail(auth, email);
                showAuthMessage('Password reset email sent! Check your inbox.', 'success');
            } catch (error) { showAuthMessage(`Failed to send email: ${error.message}`, 'error'); }
        });

        const showAuthTab = (tabName) => {
            authMessage.classList.add('hidden');
            [loginForm, signupForm, forgotPasswordForm].forEach(form => form.classList.add('hidden'));
            [loginTabBtn, signupTabBtn].forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-slate-500');
            });
            if (tabName === 'login') { loginForm.classList.remove('hidden'); loginTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
            else if (tabName === 'signup') { signupForm.classList.remove('hidden'); signupTabBtn.classList.add('border-blue-600', 'text-blue-600'); }
            else if (tabName === 'forgotPassword') { forgotPasswordForm.classList.remove('hidden'); }
        };

        const showAuthMessage = (msg, type) => {
            authMessage.textContent = msg;
            authMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center w-full';
            if (type === 'error') authMessage.classList.add('bg-red-100', 'text-red-700');
            else if (type === 'success') authMessage.classList.add('bg-green-100', 'text-green-700');
            else authMessage.classList.add('bg-blue-100', 'text-blue-700');
            authMessage.classList.remove('hidden');
        };

        // --- Event Listeners ---
        
        userMonogram.addEventListener('click', (e) => {
            e.stopPropagation();
            authDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            const authStatusContainer = document.getElementById('authStatusContainer');
            if (authStatusContainer && !authStatusContainer.contains(e.target)) {
                authDropdown.classList.add('hidden');
            }
        });

        logoutButton.addEventListener('click', handleLogout);
        
        saveInfoBtn.addEventListener('click', () => {
            if (currentUserId) {
                const newName = userName.textContent; 
                saveAccountInfo(currentUserId, newName, userPhoneInput.value);
            } else {
                showMessage('Please log in to save your information.', 'error');
            }
        });

        footerEmailSignupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('footerPromoEmail').value;
            footerSignupMessage.textContent = 'Submitting...';
            footerSignupMessage.className = 'mt-3 text-sm text-center text-blue-300';
            
            try {
                await addDoc(collection(db, "signed_up_emails"), {
                    email: email,
                    timestamp: new Date()
                });
                footerSignupMessage.textContent = 'Success! Thanks for signing up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-green-300';
                footerEmailSignupForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                footerSignupMessage.textContent = 'Error: Could not sign up.';
                footerSignupMessage.className = 'mt-3 text-sm text-center text-red-300';
            }
        });
        
        // --- Main Auth State Listener ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                loginNavBtn.classList.add('hidden');
                userMonogram.classList.remove('hidden');
                
                const name = user.displayName || user.email;
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                userMonogram.textContent = initials;
                
                // The monogram color is now handled by CSS.

                userName.textContent = user.displayName || 'N/A';
                userEmail.textContent = user.email || 'N/A';

                const userDocRef = doc(db, `users/${currentUserId}`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().phoneNumber) {
                        userPhoneInput.value = docSnap.data().phoneNumber;
                    } else {
                        userPhoneInput.value = '';
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showMessage('Could not load phone number.', 'error');
                }
                
                showTab('accountInfo');
                closeModal(loginModal);
                
            } else {
                window.location.replace(window.location.origin + '/index.html'); 
            }
        });
    </script>
</body>
</html>