<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftBuyBack - My Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-button.active {
            border-color: #4f46e5; /* Indigo-600 */
            color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
        }
        .initials-monogram {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ffffff;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="https://secondhandcell.com/index.html" class="text-2xl font-bold text-indigo-700 rounded-md p-2">SwiftBuyBack</a>
            <nav class="space-x-4 flex items-center">
                <a href="https://secondhandcell.com/sell-device.html" class="text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Sell Your Device</a>
                <div id="authStatusContainer" class="flex items-center space-x-4">
                    <a id="login-link" href="https://secondhandcell.com/login.html" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Login</a>
                    <a id="account-link" href="https://secondhandcell.com/my-account.html" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">My Account</a>
                    <div id="userMonogram" class="initials-monogram hidden"></div>
                    <button id="logout-button" class="hidden text-gray-600 hover:text-indigo-700 font-medium rounded-md px-3 py-2 transition duration-300">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">My Account</h1>

            <div id="message" class="mb-6 p-3 rounded-md text-sm text-center hidden"></div>

            <div class="flex border-b border-gray-200 mb-8">
                <button id="accountInfoTab" class="tab-button active flex-1 py-3 px-4 text-center text-lg font-medium text-gray-700 rounded-t-lg border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-600 transition duration-300">
                    Account Information
                </button>
                <button id="orderHistoryTab" class="tab-button flex-1 py-3 px-4 text-center text-lg font-medium text-gray-700 rounded-t-lg border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-600 transition duration-300">
                    Order History
                </button>
            </div>

            <div id="accountInfoSection" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name:</label>
                        <p id="userName" class="mt-1 text-lg text-gray-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email Address:</label>
                        <p id="userEmail" class="mt-1 text-lg text-gray-900 font-semibold">Loading...</p>
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-gray-700">Phone Number:</label>
                        <input type="tel" id="userPhone" name="userPhone"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="e.g., +15551234567">
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="saveInfoBtn" class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Changes
                    </button>
                </div>
            </div>

            <div id="orderHistorySection" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Past Orders</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Device</th>
                                <th class="py-3 px-6 text-left">Quote</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Actions</th> <!-- New Actions column -->
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-gray-700 text-sm font-light">
                            <tr><td colspan="6" class="text-center text-gray-500 py-4">Loading orders...</td></tr> <!-- Updated colspan -->
                        </tbody>
                    </table>
                </div>
                <p id="noOrdersMessage" class="text-gray-600 mt-4 text-center hidden">No orders found.</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-12 mt-8 w-full">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div>
                <h3 class="text-xl font-bold mb-4">SwiftBuyBack</h3>
                <p class="text-gray-400">Your trusted partner for selling used smartphones. Quick quotes, fair prices, and hassle-free service.</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                <ul class="space-y-2">
                    <li><a href="https://secondhandcell.com/index.html" class="text-gray-400 hover:text-white transition duration-300">Home</a></li>
                    <li><a href="https://secondhandcell.com/sell-device.html" class="text-gray-400 hover:text-white transition duration-300">Sell Your Phone</a></li>
                    <li><a href="https://secondhandcell.com/my-account.html" class="text-gray-400 hover:text-white transition duration-300">My Account</a></li>
                    <li><a href="https://secondhandcell.com/about-us.html" class="text-gray-400 hover:text-white transition duration-300">About Us</a></li>
                    <li><a href="https://secondhandcell.com/contact.html" class="text-gray-400 hover:text-white transition duration-300">Contact</a></li>
                </ul>
            </div>
            <div class="md:col-span-2 lg:col-span-1">
                <h3 class="text-xl font-bold mb-4">Contact Us</h3>
                <p class="text-gray-400">Email: info@swiftbuyback.com</p>
                <p class="text-gray-400">Phone: (123) 456-7890</p>
                <p class="text-gray-400 mt-4">&copy; 2025 SwiftBuyBack. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get elements
        const loginLink = document.getElementById('login-link');
        const accountLink = document.getElementById('account-link');
        const logoutButton = document.getElementById('logout-button');
        const userMonogram = document.getElementById('userMonogram');
        const accountInfoTab = document.getElementById('accountInfoTab');
        const orderHistoryTab = document.getElementById('orderHistoryTab');
        const accountInfoSection = document.getElementById('accountInfoSection');
        const orderHistorySection = document.getElementById('orderHistorySection');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoneInput = document.getElementById('userPhone');
        const saveInfoBtn = document.getElementById('saveInfoBtn');
        const messageDiv = document.getElementById('message');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        let currentUserId = null;

        // --- Helper Functions ---
        
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `mb-6 p-3 rounded-md text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-700' : type === 'error' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`;
            messageDiv.classList.remove('hidden');
        }
        
        function clearMessage() {
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
        }
        
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'completed': return 'bg-green-200 text-green-800';
                case 're-offered-accepted': return 'bg-teal-200 text-teal-800';
                case 're-offered-auto-accepted': return 'bg-teal-200 text-teal-800';
                case 're-offered-pending': return 'bg-orange-200 text-orange-800';
                case 're-offered-declined': return 'bg-red-200 text-red-800';
                case 'pending_shipment': return 'bg-blue-200 text-blue-800';
                case 'label_generated': return 'bg-yellow-200 text-yellow-800';
                case 'received': return 'bg-gray-200 text-gray-800';
                case 'return-label-generated': return 'bg-gray-400 text-gray-800';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        function formatStatus(status) {
            return status.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            // Firestore Timestamps have a toDate() method
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString();
        }

        // --- Tab and UI Logic ---

        function showTab(tabToShow) {
            accountInfoSection.classList.add('hidden');
            orderHistorySection.classList.add('hidden');
            accountInfoTab.classList.remove('active');
            orderHistoryTab.classList.remove('active');

            if (tabToShow === 'accountInfo') {
                accountInfoSection.classList.remove('hidden');
                accountInfoTab.classList.add('active');
            } else if (tabToShow === 'orderHistory') {
                orderHistorySection.classList.remove('hidden');
                orderHistoryTab.classList.add('active');
                if (currentUserId) {
                    loadOrders(currentUserId);
                }
            }
            clearMessage();
        }

        accountInfoTab.addEventListener('click', () => showTab('accountInfo'));
        orderHistoryTab.addEventListener('click', () => showTab('orderHistory'));
        
        // --- Firebase Functions ---
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Failed to log out. Please try again.', 'error');
            }
        }
        
        function loadOrders(userId) {
            if (!userId) {
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
                return;
            }
            
            // Query the 'orders' collection for documents where 'userId' matches the current user's ID
            const ordersCollectionRef = collection(db, 'orders');
            const userOrdersQuery = query(ordersCollectionRef, where('userId', '==', userId));
            
            // Listen for real-time updates to the user's orders
            onSnapshot(userOrdersQuery, (snapshot) => {
                ordersTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.empty) {
                    noOrdersMessage.classList.remove('hidden');
                } else {
                    noOrdersMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        
                        let displayQuote = order.estimatedQuote || 0;
                        if (order.status === 're-offered-accepted' || order.status === 're-offered-auto-accepted') {
                            displayQuote = order.reOffer?.newPrice || displayQuote;
                        }

                        let actionsHtml = '';
                        if (order.status === 'label_generated' && order.uspsLabelUrl) {
                            actionsHtml = `<a href="${order.uspsLabelUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium text-xs px-2 py-1 rounded-md bg-indigo-100 hover:bg-indigo-200 transition duration-200">Print Label</a>`;
                        } else if (order.status === 're-offered-pending' && order.id) {
                            // Assuming reoffer-action.html exists and handles orderId parameter
                            actionsHtml = `<a href="reoffer-action.html?orderId=${doc.id}" class="text-orange-600 hover:text-orange-800 font-medium text-xs px-2 py-1 rounded-md bg-orange-100 hover:bg-orange-200 transition duration-200">Review Re-Offer</a>`;
                        }

                        const row = `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${doc.id}</td>
                                <td class="py-3 px-6 text-left">${formatDate(order.createdAt)}</td>
                                <td class="py-3 px-6 text-left">${order.device || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">$${displayQuote.toFixed(2)}</td>
                                <td class="py-3 px-6 text-center">
                                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none rounded-full ${getStatusBadgeClass(order.status)}">${formatStatus(order.status)}</span>
                                </td>
                                <td class="py-3 px-6 text-center">${actionsHtml}</td>
                            </tr>
                        `;
                        ordersTableBody.innerHTML += row;
                    });
                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                showMessage('Failed to load orders. Please try again.', 'error');
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.remove('hidden');
            });
        }
        
        async function saveAccountInfo(userId, newName, phoneNumber) {
            if (!userId) {
                showMessage('User not authenticated. Please log in.', 'error');
                return;
            }
            saveInfoBtn.disabled = true;
            saveInfoBtn.textContent = 'Saving...';
            clearMessage();
        
            try {
                // Update Firebase Auth display name
                if (auth.currentUser && newName !== auth.currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    userName.textContent = newName; // Update UI immediately
                }

                // Update Firestore for phone number (and potentially other fields)
                // We're storing user-specific data in a 'users' collection,
                // with the document ID being the user's UID.
                const userDocRef = doc(db, `users/${userId}`);
                await setDoc(userDocRef, { phoneNumber: phoneNumber }, { merge: true });

                showMessage('Account information saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving account info:", error);
                showMessage('Failed to save account information. Please try again.', 'error');
            } finally {
                saveInfoBtn.disabled = false;
                saveInfoBtn.textContent = 'Save Changes';
            }
        }

        // --- Event Listeners ---
        
        logoutButton.addEventListener('click', handleLogout);
        
        saveInfoBtn.addEventListener('click', () => {
            if (currentUserId) {
                // Get the current displayed name from the UI, as it might have been updated by Firebase Auth
                const newName = userName.textContent; 
                saveAccountInfo(currentUserId, newName, userPhoneInput.value);
            } else {
                showMessage('Please log in to save your information.', 'error');
            }
        });
        
        // --- Main Auth State Listener ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                // Update header UI for logged-in state
                loginLink.classList.add('hidden');
                accountLink.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                userMonogram.classList.remove('hidden');
                
                // Get and set user initials for monogram
                const name = user.displayName || user.email;
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                userMonogram.textContent = initials;
                userMonogram.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 70%)`;

                // Update account details
                userName.textContent = user.displayName || 'N/A';
                userEmail.textContent = user.email || 'N/A';

                // Fetch phone number from Firestore and populate input field
                const userDocRef = doc(db, `users/${currentUserId}`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().phoneNumber) {
                        userPhoneInput.value = docSnap.data().phoneNumber;
                    } else {
                        userPhoneInput.value = '';
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showMessage('Could not load phone number.', 'error');
                }
                
                // Show account info by default
                showTab('accountInfo');
                
            } else {
                // User is signed out, redirect to a non-authenticated page
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
