<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wholesale Cart | SecondHandCell</title>
    <link rel="icon" href="/favicon/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />
    <style>
        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f1f5f9;
            color: #0f172a;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        main {
            opacity: 0;
            transition: opacity 0.5s;
        }
        main.ready {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    <div id="toast" class="pointer-events-none fixed inset-x-0 top-6 z-50 flex justify-center px-4">
        <div id="toastContent" class="hidden w-full max-w-xl rounded-3xl border px-4 py-3 text-sm shadow-lg"></div>
    </div>

    <!-- This is a simplified header for the Cart page - Auth/Cart logic handled in script -->
    <header class="sticky top-0 z-40 border-b border-slate-200 bg-white/90 backdrop-blur">
        <nav class="mx-auto flex max-w-7xl items-center justify-between gap-6 px-6 py-5">
            <a href="/buy/" class="flex items-center gap-3 text-slate-900">
                <img src="https://placehold.co/100x100/10b981/ffffff?text=SC" alt="SecondHandCell" class="h-12 w-12 rounded-full border border-slate-200 bg-white p-2" />
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-600">SecondHandCell</p>
                    <h1 class="text-2xl font-semibold tracking-tight">Wholesale cart</h1>
                </div>
            </a>
            <div class="hidden items-center gap-6 text-sm font-medium text-slate-600 md:flex">
                <a href="/buy/" class="transition hover:text-emerald-600">Home</a>
                <a href="/buy/buy-device.html" class="transition hover:text-emerald-600">Devices</a>
                <a href="/buy/cart.html" class="text-slate-900">Cart</a>
                <a href="/buy/my-account.html" class="transition hover:text-emerald-600">My account</a>
            </div>
            <div class="flex items-center gap-3">
                <button
                    id="accountButton"
                    class="relative flex h-11 w-11 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-500 shadow-sm transition hover:border-emerald-300 hover:text-emerald-600"
                    aria-haspopup="true"
                    aria-expanded="false"
                >
                    <span id="accountInitial" class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-200 text-sm font-semibold text-slate-500">SC</span>
                </button>
                <div class="relative">
                    <button
                        id="cartButton"
                        class="relative flex items-center gap-2 rounded-full bg-emerald-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-200/60 transition hover:bg-emerald-400"
                        aria-haspopup="true"
                    >
                        <i class="fa-solid fa-cart-shopping"></i>
                        Cart
                        <span
                            id="cartBadge"
                            class="absolute -right-2 -top-2 hidden h-6 w-6 items-center justify-center rounded-full bg-slate-900 text-xs font-bold text-white"
                        >
                            0
                        </span>
                    </button>
                    <!-- Cart Preview Dropdown -->
                    <div id="cartPreview" class="absolute right-0 top-14 hidden w-80 rounded-3xl border border-slate-200 bg-white p-5 shadow-xl">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold text-slate-900">Cart preview</p>
                            <button class="text-xs font-medium uppercase tracking-[0.3em] text-slate-400 hover:text-emerald-600" data-close-cart-preview>
                                Close
                            </button>
                        </div>
                        <div id="cartPreviewEmpty" class="mt-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-4 text-center text-xs text-slate-500">
                            Add quantities from the catalog to populate your cart.
                        </div>
                        <div id="cartPreviewList" class="mt-4 space-y-3"></div>
                        <div class="mt-5 flex items-center justify-between">
                            <a
                                id="openCartLink"
                                href="/buy/cart.html"
                                class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white shadow-sm transition hover:bg-emerald-400"
                            >
                                Open cart
                            </a>
                            <a href="/buy/buy-device.html" class="text-xs font-medium text-emerald-600 underline">Add more stock</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Account Dropdown (Simplified for this page) -->
        <div id="accountDropdown" class="absolute right-6 top-20 hidden w-72 rounded-3xl border border-slate-200 bg-white p-5 text-sm shadow-2xl">
            <div class="flex items-center gap-3">
                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500 text-base font-semibold text-white">
                    <span id="accountInitialClone">SC</span>
                </div>
                <div>
                    <p data-account-name class="font-semibold text-slate-900">Buyer</p>
                    <p data-account-email class="text-xs text-slate-500"></p>
                </div>
            </div>
            <div class="mt-5 text-sm text-slate-600">
                    <p class="text-xs text-slate-400">User ID: <span id="currentUserId" class="font-mono text-slate-700"></span></p>
                <button
                    data-sign-out
                    class="mt-4 flex items-center justify-center rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500 transition hover:border-rose-300 hover:text-rose-500"
                >
                    Sign out (Reload)
                </button>
            </div>
        </div>
    </header>

    <main id="mainContent" class="mx-auto flex max-w-7xl flex-col gap-10 px-6 py-16">
        <section class="space-y-4">
            <h2 class="text-3xl font-semibold text-slate-900">Review your cart</h2>
            <p class="max-w-3xl text-sm text-slate-600">
                Enter the quantity you want to keep for each line item and add a per-unit offer. Once submitted, our admin team will review, counter if needed, and push approved deals to checkout.
            </p>
            <p id="authRequiredNotice" class="hidden rounded-3xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                You need to be signed in to submit offers. Use the account icon above to log in or create an account.
            </p>
        </section>

        <section id="emptyState" class="hidden rounded-3xl border border-dashed border-slate-300 bg-white/60 p-10 text-center text-sm text-slate-500">
            Your cart is empty. Browse the <a href="/buy/buy-device.html" class="font-semibold text-emerald-600 underline">device catalog</a> to start a wholesale quote.
        </section>

        <section id="cartSection" class="hidden space-y-8">
            <div class="overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-left text-sm">
                        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
                            <tr>
                                <th class="px-5 py-4">Device</th>
                                <th class="px-5 py-4">Storage &amp; grade</th>
                                <th class="px-5 py-4">Available</th>
                                <th class="px-5 py-4">Quantity</th>
                                <th class="px-5 py-4">Our ask</th>
                                <th class="px-5 py-4">Your offer</th>
                                <th class="px-5 py-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cartTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid gap-6 lg:grid-cols-[1.4fr_0.6fr]">
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-slate-600">Offer notes (optional)
                        <textarea id="offerNotes" rows="4" class="mt-2 w-full rounded-3xl border border-slate-300 px-4 py-3 text-sm text-slate-900 focus:border-emerald-400 focus:outline-none" placeholder="Include freight instructions, testing requirements, or serialized needs."></textarea>
                    </label>
                </div>
                <div class="rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600 shadow-sm">
                    <h3 class="text-base font-semibold text-slate-900">Summary</h3>
                    <dl class="mt-4 space-y-3 text-sm">
                        <div class="flex items-center justify-between">
                            <dt>Total units</dt>
                            <dd id="summaryUnits" class="font-semibold text-slate-900">0</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt>Offer total</dt>
                            <dd id="summaryOffer" class="font-semibold text-slate-900">$0.00</dd>
                        </div>
                    </dl>
                    <p class="mt-4 text-xs text-slate-500">Counters and approvals will show in your <a href="/buy/my-account.html" class="text-emerald-600 underline">account dashboard</a>.</p>
                    <div class="mt-6 flex flex-col gap-3">
                        <button id="submitOffer" class="rounded-full bg-emerald-500 px-5 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white shadow-lg shadow-emerald-200/60 transition hover:bg-emerald-400">
                            Submit offer
                        </button>
                        <button id="clearCart" class="rounded-full border border-slate-300 px-5 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-slate-600 transition hover:border-rose-300 hover:text-rose-500">
                            Clear cart
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="border-t border-slate-200 bg-white/90">
        <div class="mx-auto flex max-w-7xl flex-col gap-4 px-6 py-6 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between">
            <p>Offers save under <code>wholesale/{userId}/offers</code> per authenticated buyer.</p>
            <div class="flex items-center gap-3">
                <a href="mailto:wholesale@secondhandcell.com" class="font-medium text-emerald-600">Contact</a>
                <span>&bull;</span>
                <a href="/terms.html" class="hover:text-emerald-600">Terms</a>
                <span>&bull;</span>
                <a href="/privacy.html" class="hover:text-emerald-600">Privacy</a>
            </div>
        </div>
    </footer>

    <!-- Auth Modal is included but hidden, only functional if linked from index.html -->
    <div id="authBackdrop" class="fixed inset-0 z-50 hidden bg-slate-900/60"></div>
    <div id="authModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4 py-10">
        <div class="mx-auto w-full max-w-lg rounded-3xl border border-slate-200 bg-white p-8 shadow-2xl">
             <p class="text-sm text-slate-500">Auth modal functionality is primarily located on the index page.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, collection, addDoc, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration and Constants ---
        // NOTE: These are duplicated here for a self-contained page
        const firebaseConfig = {
            apiKey: "AIzaSyAmUGWbpbJIWLrBMJpZb8iMpFt-uc24J0k",
            authDomain: "buyback-a0f05.firebaseapp.com",
            projectId: "buyback-a0f05",
            storageBucket: "buyback-a0f05.firebasestorage.app",
            messagingSenderId: "876430429098",
            appId: "1:876430429098:web:f6dd64b1960d90461979d3",
            measurementId: "G-6WWQN44JHT"
        };
        
        // This is necessary for `doc(db, ...)` construction
        const currentAppId = firebaseConfig.projectId;	
        
        let db, auth;
        let userId = null;
        let cart = []; // Global state for cart items

        // --- DOM Elements ---
        const mainContent = document.getElementById("mainContent");
        const cartBadge = document.getElementById("cartBadge");
        const cartPreviewList = document.getElementById("cartPreviewList");
        const cartPreviewEmpty = document.getElementById("cartPreviewEmpty");
        const toastContent = document.getElementById("toastContent");
        
        const cartTableBody = document.getElementById("cartTableBody");
        const emptyState = document.getElementById("emptyState");
        const cartSection = document.getElementById("cartSection");
        const summaryUnits = document.getElementById("summaryUnits");
        const summaryOffer = document.getElementById("summaryOffer");
        const submitOfferButton = document.getElementById("submitOffer");
        const clearCartButton = document.getElementById("clearCart");
        const notesField = document.getElementById("offerNotes");
        const authRequiredNotice = document.getElementById("authRequiredNotice");

        // --- Firebase Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- Utility Functions ---

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 2, // Cart page shows cents
                maximumFractionDigits: 2
            }).format(amount);
        };

        function showToast(message, tone = "emerald") {
            if (!toastContent) return;
            clearTimeout(window.toastTimeout);
            toastContent.textContent = message;
            toastContent.className = `w-full max-w-xl rounded-3xl border px-4 py-3 text-sm shadow-lg ${
                tone === "rose"
                    ? "border-rose-200 bg-rose-50 text-rose-600"
                    : tone === "amber"
                    ? "border-amber-200 bg-amber-50 text-amber-700"
                    : "border-emerald-200 bg-emerald-50 text-emerald-700"
            }`;
            toastContent.classList.remove("hidden");
            window.toastTimeout = setTimeout(() => {
                toastContent.classList.add("hidden");
            }, 2800);
        }
        
        function getInitial(email) {
            if (!email || email === 'Anonymous') return 'SC';
            return email.charAt(0).toUpperCase();
        }

        function updateAccountUI(user) {
            const initial = getInitial(user.email);
            document.getElementById("accountInitial").textContent = initial;
            document.getElementById("accountInitialClone").textContent = initial;
            document.querySelector('[data-account-name]').textContent = user.displayName || 'Wholesale Buyer';
            document.querySelector('[data-account-email]').textContent = user.email || 'Anonymous Session';
            document.getElementById("currentUserId").textContent = user.uid.substring(0, 8) + '...';
            
            // Set initial color based on auth state
            const initialEl = document.getElementById("accountInitial");
            if (user.isAnonymous) {
                initialEl.classList.add('bg-slate-200', 'text-slate-500');
                initialEl.classList.remove('bg-emerald-500', 'text-white');
            } else {
                initialEl.classList.add('bg-emerald-500', 'text-white');
                initialEl.classList.remove('bg-slate-200', 'text-slate-500');
            }
        }
        
        // --- Firestore References ---

        function getCartDocRef() {
            if (!db || !userId) return null;
            // The path requested by the user: wholesaleusers/{userId}/cart/current
            return doc(db, `wholesaleusers/${userId}/cart/current`);
        }
        
        function getOffersCollectionRef() {
            if (!db || !userId) return null;
            // The updated path requested by the user: wholesale/{userId}/offers
            return collection(db, 'wholesale', userId, 'offers');
        }

        function getInventoryDocRef() {
            if (!db) return null;
            return doc(db, `wholesale/inventory`); 
        }

        // --- Data Management (Firestore) ---

        async function saveCart(currentCart) {
            const ref = getCartDocRef();
            if (!ref) {
                console.error("Firestore not ready for cart save (No userId).");
                showToast("Database not ready for cart save.", "rose");
                return;
            }
            try {
                // Save the full array of items
                await setDoc(ref, { items: currentCart || [] });
                // Note: The onSnapshot listener handles UI update and local cart state
            } catch (error) {
                console.error("Error saving cart:", error);
                showToast("Failed to save cart to database.", "rose");
            }
        }

        function clearCart() {
            saveCart([]);
            showToast("Cleared your cart.", "amber");
        }

        const generateOfferId = () => Math.random().toString(36).substring(2, 9).toUpperCase(); // Still useful for record ID simulation

        async function updateStockInFirestore(updates) {
            const inventoryRef = getInventoryDocRef();
            if (!inventoryRef) return console.error("Inventory reference not ready.");

            try {
                // Use a transaction to safely update the nested stock quantity
                await runTransaction(db, async (transaction) => {
                    const inventoryDoc = await transaction.get(inventoryRef);
                    if (!inventoryDoc.exists()) {
                        throw new Error("Inventory document does not exist!");
                    }
                    
                    const inventoryData = inventoryDoc.data();
                    let updated = false;

                    updates.forEach(update => {
                        const { deviceId, storageVariant, grade, quantity } = update;
                        const deviceIndex = inventoryData.items.findIndex(d => d.id === deviceId);
                        
                        if (deviceIndex !== -1) {
                            const storageIndex = inventoryData.items[deviceIndex].storages.findIndex(s => s.variant === storageVariant);
                            if (storageIndex !== -1) {
                                const currentStock = inventoryData.items[deviceIndex].storages[storageIndex].stock[grade];
                                if (currentStock >= quantity) {
                                    inventoryData.items[deviceIndex].storages[storageIndex].stock[grade] = currentStock - quantity;
                                    updated = true;
                                } else {
                                    throw new Error(`Insufficient stock for ${deviceId} ${storageVariant} Grade ${grade}. Transaction aborted.`); 
                                }
                            }
                        }
                    });

                    if (updated) {
                        // Write the entire modified inventory array back
                        transaction.set(inventoryRef, { items: inventoryData.items });
                    }
                });
            } catch (error) {
                console.error("Stock Update Transaction failed: ", error);
                throw new Error(`Stock reservation failed: ${error.message}`);
            }
        }


        // --- UI Rendering ---

        // Variables to restore focus after re-render (Focus Fix)
        let focusedLineId = null;
        let focusedField = null;
        let focusedSelectionStart = 0;

        // ** NEW: Function to update the header cart preview (was missing/incomplete) **
        function updateCartPreviewUI() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // 1. Update Badge
            cartBadge.textContent = totalItems.toString();
            cartBadge.classList.toggle("hidden", totalItems === 0);
            cartBadge.classList.toggle("flex", totalItems > 0);
            
            // 2. Update Preview List
            cartPreviewList.innerHTML = '';
            if (cart.length === 0) {
                cartPreviewEmpty.classList.remove('hidden');
            } else {
                cartPreviewEmpty.classList.add('hidden');
                cart.slice(0, 3).forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between border-b border-slate-100 pb-2 last:border-b-0';
                    itemElement.innerHTML = `
                        <div>
                            <p class="text-sm font-medium text-slate-900">${item.brand} ${item.model}</p>
                            <p class="text-xs text-slate-500">${item.storageVariant} Â· Grade ${item.grade}</p>
                        </div>
                        <p class="text-sm font-semibold text-slate-700">x${item.quantity}</p>
                    `;
                    cartPreviewList.appendChild(itemElement);
                });
                if (cart.length > 3) {
                    const moreElement = document.createElement('p');
                    moreElement.className = 'text-center text-xs font-medium text-slate-400 pt-2';
                    moreElement.textContent = `...and ${cart.length - 3} more line items`;
                    cartPreviewList.appendChild(moreElement);
                }
            }
        }
        // ** END NEW FUNCTION **

        function updateCartUI() {
            // Call the new preview function to update the header
            updateCartPreviewUI();

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Save focus state before render (Focus Fix)
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.dataset.quantityInput || activeElement.dataset.offerInput)) {
                focusedLineId = activeElement.dataset.quantityInput || activeElement.dataset.offerInput;
                focusedField = activeElement.dataset.quantityInput ? 'quantity' : 'offer';
                focusedSelectionStart = activeElement.selectionStart;
            } else {
                focusedLineId = null;
            }

            // This is the cart page logic (full table view)
            const hasItems = cart.length > 0;
            emptyState.classList.toggle("hidden", hasItems);
            cartSection.classList.toggle("hidden", !hasItems);

            if (!hasItems) {
                summaryUnits.textContent = "0";
                summaryOffer.textContent = "$0.00";
                submitOfferButton.disabled = true;
                cartTableBody.innerHTML = "";
                return;
            }

            cartTableBody.innerHTML = "";

            cart.forEach((line) => {
                // Ensure offerPrice is defined, defaulting to askingPrice if missing
                if (typeof line.offerPrice === "undefined") {
                    line.offerPrice = line.askingPrice;
                }
                const row = document.createElement("tr");
                row.dataset.lineId = line.lineId;
                
                // Ensure number inputs reflect the capped values and current state
                const quantity = Number(line.quantity) || 0;
                const offerPrice = Number(line.offerPrice) || 0;
                
                row.innerHTML = `
                    <td class="px-5 py-4">
                        <p class="font-semibold text-slate-900">${line.brand} ${line.model}</p>
                        <p class="text-xs uppercase tracking-[0.3em] text-slate-400 mt-1">${line.deviceId}</p>
                    </td>
                    <td class="px-5 py-4 text-sm text-slate-600">
                        <p class="font-medium text-slate-900">${line.storageVariant}</p>
                        <p class="text-xs uppercase tracking-[0.3em] text-slate-400 mt-1">Grade ${line.grade}</p>
                    </td>
                    <td class="px-5 py-4 text-sm text-slate-600">${line.available}</td>
                    <td class="px-5 py-4">
                        <input type="number" min="1" max="${line.available}" value="${quantity}" data-quantity-input="${line.lineId}" class="w-20 rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-900 focus:border-emerald-400 focus:outline-none" />
                    </td>
                    <td class="px-5 py-4 text-sm text-slate-600">${formatCurrency(line.askingPrice)}</td>
                    <td class="px-5 py-4">
                        <!-- FIX: Changed type from "number" to "text" and added pattern for decimal currency input -->
                        <input 
                            type="text" 
                            min="0" 
                            step="0.01" 
                            value="${offerPrice}" 
                            data-offer-input="${line.lineId}" 
                            class="w-28 rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-900 focus:border-emerald-400 focus:outline-none" 
                            pattern="[0-9]*[.]?[0-9]*" 
                            inputmode="decimal"
                        />
                    </td>
                    <td class="px-5 py-4">
                        <button data-remove-line="${line.lineId}" class="text-sm font-semibold text-rose-500 transition hover:text-rose-600">Remove</button>
                    </td>
                `;
                cartTableBody.appendChild(row);
            });

            updateSummary();
            
            // Restore focus state after render (Focus Fix)
            if (focusedLineId) {
                let selector = focusedField === 'quantity' 
                    ? `input[data-quantity-input="${focusedLineId}"]` 
                    : `input[data-offer-input="${focusedLineId}"]`;
                const inputToFocus = document.querySelector(selector);
                
                if (inputToFocus) {
                    inputToFocus.focus();
                    inputToFocus.setSelectionRange(focusedSelectionStart, focusedSelectionStart);
                }
                // Reset tracker
                focusedLineId = null;
            }
        }

        function updateSummary() {
            const units = cart.reduce((sum, line) => sum + (Number(line.quantity) || 0), 0);
            const totalOffer = cart.reduce((sum, line) => {
                const price = Number(line.offerPrice || 0);
                return sum + price * (Number(line.quantity) || 0);
            }, 0);
            summaryUnits.textContent = units;
            summaryOffer.textContent = formatCurrency(totalOffer);
            submitOfferButton.disabled = units === 0;
        }

        // --- Event Handlers for Cart Table ---

        cartTableBody.addEventListener("input", (event) => {
            let itemUpdated = false;
            
            // Handle Quantity Input (type="number")
            const quantityInput = event.target.closest("input[data-quantity-input]");
            if (quantityInput) {
                const lineId = quantityInput.dataset.quantityInput;
                const lineIndex = cart.findIndex((item) => item.lineId === lineId);
                if (lineIndex === -1) return;
                
                let nextQuantity = Number(quantityInput.value) || 0;
                
                // Enforce min and max limits
                const max = Number(quantityInput.max);
                if (nextQuantity < 1) nextQuantity = 1;
                if (nextQuantity > max) {
                    nextQuantity = max;
                    showToast(`Quantity capped at available stock: ${max}`, "amber");
                }
                
                // Update local state and UI
                cart[lineIndex].quantity = nextQuantity;
                quantityInput.value = nextQuantity;
                itemUpdated = true;
            }

            // Handle Offer Price Input (type="text" for better cursor behavior)
            const offerInput = event.target.closest("input[data-offer-input]");
            if (offerInput) {
                const lineId = offerInput.dataset.offerInput;
                const lineIndex = cart.findIndex((item) => item.lineId === lineId);
                if (lineIndex === -1) return;
                
                // Use regex to sanitize input to ensure only numbers and a decimal point
                let sanitizedValue = offerInput.value.replace(/[^0-9.]/g, '');
                
                // Ensure only one decimal point
                const parts = sanitizedValue.split('.');
                if (parts.length > 2) {
                    sanitizedValue = parts[0] + '.' + parts.slice(1).join('');
                }

                // Update the input field with the sanitized value
                offerInput.value = sanitizedValue;

                const value = Number(sanitizedValue);
                cart[lineIndex].offerPrice = Number.isNaN(value) ? 0 : value;
                itemUpdated = true;
            }
            
            if(itemUpdated) {
                saveCart(cart); // Save updated state to Firestore
                updateSummary();
            }
        });

        cartTableBody.addEventListener("click", (event) => {
            const removeButton = event.target.closest("button[data-remove-line]");
            if (removeButton) {
                event.preventDefault();
                const lineId = removeButton.dataset.removeLine;
                // Update local state and save
                const newCart = cart.filter((line) => line.lineId !== lineId);
                cart = newCart; // Update global state immediately
                saveCart(newCart);
                showToast("Removed line from cart.", "amber");
            }
        });

        clearCartButton.addEventListener("click", clearCart);

        submitOfferButton.addEventListener("click", async () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                showToast("Please sign in or register to submit a formal offer.", "rose");
                return;
            }

            if (!cart.length) {
                showToast("Your cart is empty.", "rose");
                return;
            }

            const missingPrice = cart.some((line) => typeof line.offerPrice === "undefined" || Number.isNaN(Number(line.offerPrice)) || Number(line.offerPrice) <= 0);
            if (missingPrice) {
                showToast("Enter a valid offer price for each line.", "rose");
                return;
            }
            
            const offersRef = getOffersCollectionRef();
            if (!offersRef) {
                showToast("Database error: Cannot reference offers collection. User ID is missing.", "rose");
                return;
            }

            const offerId = generateOfferId();
            const now = new Date().toISOString();
            
            const offerItems = cart.map((line) => ({
                lineId: line.lineId,
                brand: line.brand,
                model: line.model,
                storageVariant: line.storageVariant, // Now includes color/GB
                grade: line.grade,
                quantity: line.quantity,
                askingPrice: line.askingPrice,
                offerPrice: Number(line.offerPrice || 0)
            }));

            // Prepare stock updates
            const stockUpdates = offerItems.map(item => ({
                deviceId: item.deviceId,
                storageVariant: item.storageVariant,
                grade: item.grade,
                quantity: item.quantity
            }));
            
            // --- STOCK DECREMENTATION ON SUBMIT ---
            try {
                // 1. Attempt to reduce stock using a Firestore Transaction
                // This correctly happens HERE, not on add to cart.
                await updateStockInFirestore(stockUpdates);
                
                // 2. If stock reduction is successful, submit the offer record
                const offerRecord = {
                    id: offerId,
                    status: "pending",
                    createdAt: now,
                    updatedAt: now,
                    note: notesField.value.trim(),
                    buyer: {
                        uid: auth.currentUser.uid,
                        name: auth.currentUser.displayName || "Authenticated Buyer",
                        email: auth.currentUser.email || ""
                    },
                    items: offerItems,
                    history: [
                        {
                            status: "pending",
                            at: now
                        }
                    ]
                };

                await addDoc(offersRef, offerRecord);
                
                // 3. Clear cart and confirm success
                clearCart(); // Clears cart in Firestore
                notesField.value = "";
                showToast("Offer submitted successfully and stock reserved. Track progress in My Account.");
                
            } catch (error) {
                console.error("Submission failed:", error);
                // If the error is a stock reservation error, show the user the specific message
                const displayMessage = error.message.includes("Stock reservation failed:") 
                    ? error.message 
                    : "Failed to submit offer due to a database error. Please refresh and try again.";
                showToast(displayMessage, "rose");
            }
        });

        // Global Event Listeners (Cart & Account Dropdowns)
        document.getElementById('cartButton').addEventListener('click', () => {
            document.getElementById('cartPreview').classList.toggle('hidden');
        });
        document.querySelectorAll('[data-close-cart-preview]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('cartPreview').classList.add('hidden');
            });
        });
        document.getElementById('accountButton').addEventListener('click', () => {
            document.getElementById('accountDropdown').classList.toggle('hidden');
        });
        document.querySelector('[data-sign-out]').addEventListener('click', () => {
            // Simple reload to clear session state for demo
            window.location.reload();	
        });

        // --- Firebase Auth & Listener Setup ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                // Ensure a user (anonymous or otherwise) always exists for Firestore paths
                try {
                    const anonUser = await signInAnonymously(auth);
                    userId = anonUser.user.uid;
                } catch (e) {
                    console.error("Failed to sign in anonymously:", e);
                    return;
                }
            }
            
            updateAccountUI(auth.currentUser);
            
            // Show content once user ID is ready
            mainContent.classList.add('ready');

            // Set up Firestore listener
            const cartRef = getCartDocRef();
            if (cartRef) {
                onSnapshot(cartRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().items) {
                        cart = docSnap.data().items || [];
                    } else {
                        cart = [];
                    }
                    updateCartUI(); // Re-render the cart table and summary
                }, (error) => {
                    console.error("Cart listener failed:", error);
                    showToast("Failed to load cart data from database.", "rose");
                });
            } else {
                showToast("User ID not available to load cart.", "rose");
            }
            
            // Update auth notice visibility
            const isAuth = user && !user.isAnonymous;
            authRequiredNotice.classList.toggle("hidden", isAuth);
        });
    </script>
</body>
</html>
