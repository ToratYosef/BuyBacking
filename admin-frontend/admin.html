<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftBuyBack Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">SwiftBuyBack Admin</h1>
            <button id="refreshOrdersBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md transition duration-300">
                Refresh Orders
            </button>
        </div>
    </header>

    <main class="container mx-auto p-6">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Manage Orders</h2>

        <div id="ordersContainer" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Pending Shipments</h3>
            <div id="ordersList" class="space-y-4">
                <p class="text-gray-500" id="loadingMessage">Loading orders...</p>
                <!-- Orders will be loaded here by JavaScript -->
            </div>
            <p id="errorMessage" class="text-red-600 mt-4 hidden">Error loading orders.</p>
        </div>

        <!-- Order Detail Modal (initially hidden) -->
        <div id="orderDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Order Details: <span id="modalOrderId"></span></h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                <div class="space-y-4 text-gray-700">
                    <p><strong>User ID:</strong> <span id="modalUserId"></span></p>
                    <p><strong>Timestamp:</strong> <span id="modalTimestamp"></span></p>
                    <p><strong>Estimated Quote:</strong> <span id="modalEstimatedQuote"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Device Details:</h4>
                    <p><strong>Model:</strong> <span id="modalDeviceModel"></span></p>
                    <p><strong>Carrier:</strong> <span id="modalDeviceCarrier"></span></p>
                    <p><strong>Storage:</strong> <span id="modalDeviceStorage"></span></p>
                    <p><strong>Condition:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Power On: <span id="modalConditionPowerOn"></span></li>
                        <li>Fully Functional: <span id="modalConditionFunctional"></span></li>
                        <li>No Cracks: <span id="modalConditionCracks"></span></li>
                        <li>Cosmetic: <span id="modalConditionCosmetic"></span></li>
                    </ul>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Payment Details:</h4>
                    <p><strong>Method:</strong> <span id="modalPaymentMethod"></span></p>
                    <p><strong>Account:</strong> <span id="modalPaymentValue"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Shipping Details:</h4>
                    <p><strong>Name:</strong> <span id="modalShippingName"></span></p>
                    <p><strong>Address:</strong> <span id="modalShippingAddress"></span></p>
                    <p><strong>Contact:</strong> <span id="modalShippingContact"></span></p>
                    <p><strong>Email:</strong> <span id="modalShippingEmail"></span></p>

                    <h4 class="text-lg font-semibold mt-4 mb-2">Current Status: <span id="modalOrderStatus" class="font-bold"></span></h4>
                    <p id="modalLabelUrl" class="hidden"><strong>USPS Label:</strong> <a href="#" target="_blank" class="text-indigo-600 hover:underline">View Label</a></p>

                    <div class="mt-6 space-y-3">
                        <button id="generateLabelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Generate USPS Label
                        </button>
                        <button id="markShippedBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Mark as Shipped
                        </button>
                        <button id="markCompletedBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-md font-semibold transition duration-300">
                            Mark as Completed
                        </button>
                        <p id="modalMessage" class="mt-4 p-3 rounded-md text-sm text-center hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Adjust this URL if your backend is deployed elsewhere (e.g., Codespaces URL)
        const BACKEND_URL = 'http://localhost:3000'; // Make sure this matches your Node.js server port

        document.addEventListener('DOMContentLoaded', () => {
            const ordersList = document.getElementById('ordersList');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            const orderDetailModal = document.getElementById('orderDetailModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const generateLabelBtn = document.getElementById('generateLabelBtn');
            const markShippedBtn = document.getElementById('markShippedBtn');
            const markCompletedBtn = document.getElementById('markCompletedBtn');
            const modalMessage = document.getElementById('modalMessage');

            let currentOrderId = null; // Store the ID of the order currently in the modal

            // Helper function to show messages in the modal
            function showModalMessage(msg, type) {
                modalMessage.textContent = msg;
                modalMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (type === 'error') {
                    modalMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    modalMessage.classList.add('bg-green-100', 'text-green-700');
                }
                modalMessage.classList.remove('hidden');
            }

            // Function to fetch and display orders
            async function fetchOrders() {
                ordersList.innerHTML = ''; // Clear previous orders
                loadingMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                modalMessage.classList.add('hidden'); // Clear modal messages when fetching

                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const orders = await response.json();

                    loadingMessage.classList.add('hidden');

                    if (orders.length === 0) {
                        ordersList.innerHTML = '<p class="text-gray-600">No pending shipments found.</p>';
                    } else {
                        orders.forEach(order => {
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'bg-gray-50 p-4 rounded-md shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                            orderDiv.innerHTML = `
                                <div>
                                    <p class="font-bold text-lg">Order ID: ${order.id}</p>
                                    <p class="text-sm text-gray-600">Device: ${order.deviceDetails.model} (${order.deviceDetails.storage})</p>
                                    <p class="text-sm text-gray-600">Status: <span class="font-medium">${order.status}</span></p>
                                </div>
                                <button class="view-details-btn bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md text-sm transition duration-300" data-order-id="${order.id}">View Details</button>
                            `;
                            ordersList.appendChild(orderDiv);
                        });

                        // Add event listeners to "View Details" buttons
                        document.querySelectorAll('.view-details-btn').forEach(button => {
                            button.addEventListener('click', (event) => {
                                const orderId = event.target.dataset.orderId;
                                openOrderDetailModal(orderId, orders.find(o => o.id === orderId));
                            });
                        });
                    }
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error: ${error.message}. Is the backend running at ${BACKEND_URL}?`;
                    errorMessage.classList.remove('hidden');
                }
            }

            // Function to open the order detail modal
            function openOrderDetailModal(orderId, orderData) {
                currentOrderId = orderId;
                document.getElementById('modalOrderId').textContent = orderId;
                document.getElementById('modalUserId').textContent = orderData.userId;
                document.getElementById('modalTimestamp').textContent = new Date(orderData.timestamp._seconds * 1000).toLocaleString();
                document.getElementById('modalEstimatedQuote').textContent = `$${orderData.deviceDetails.estimatedQuote.toFixed(2)}`;

                document.getElementById('modalDeviceModel').textContent = orderData.deviceDetails.model;
                document.getElementById('modalDeviceCarrier').textContent = orderData.deviceDetails.carrier;
                document.getElementById('modalDeviceStorage').textContent = orderData.deviceDetails.storage;
                document.getElementById('modalConditionPowerOn').textContent = orderData.deviceDetails.conditionQuestions.powerOn;
                document.getElementById('modalConditionFunctional').textContent = orderData.deviceDetails.conditionQuestions.fullyFunctional;
                document.getElementById('modalConditionCracks').textContent = orderData.deviceDetails.conditionQuestions.noCracks;
                document.getElementById('modalConditionCosmetic').textContent = orderData.deviceDetails.conditionQuestions.cosmeticCondition;

                document.getElementById('modalPaymentMethod').textContent = orderData.paymentDetails.method;
                document.getElementById('modalPaymentValue').textContent = orderData.paymentDetails.value;

                document.getElementById('modalShippingName').textContent = orderData.shippingDetails.fullName;
                document.getElementById('modalShippingAddress').textContent = `${orderData.shippingDetails.address}, ${orderData.shippingDetails.city}, ${orderData.shippingDetails.state} ${orderData.shippingDetails.zip}, ${orderData.shippingDetails.country}`;
                document.getElementById('modalShippingContact').textContent = orderData.shippingDetails.phone;
                document.getElementById('modalShippingEmail').textContent = orderData.shippingDetails.contactEmail;

                document.getElementById('modalOrderStatus').textContent = orderData.status;

                // Show/hide label URL based on status
                const modalLabelUrl = document.getElementById('modalLabelUrl');
                const labelLink = modalLabelUrl.querySelector('a');
                if (orderData.uspsLabelUrl) {
                    labelLink.href = orderData.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                } else {
                    modalLabelUrl.classList.add('hidden');
                }

                // Adjust button visibility based on order status
                generateLabelBtn.classList.remove('hidden');
                markShippedBtn.classList.remove('hidden');
                markCompletedBtn.classList.remove('hidden');

                if (orderData.status === 'label_generated' || orderData.status === 'shipping_kit_sent') {
                    generateLabelBtn.classList.add('hidden');
                }
                if (orderData.status === 'completed') {
                    generateLabelBtn.classList.add('hidden');
                    markShippedBtn.classList.add('hidden');
                }
                if (orderData.status === 'pending_shipment' && orderData.boxSent === true) {
                    // If box sent but label not generated yet, still hide generate label.
                    // This implies the box request handled the label too or you need another status.
                    // For this example, if boxSent is true, assume label is part of it.
                    generateLabelBtn.classList.add('hidden');
                }


                modalMessage.classList.add('hidden'); // Clear any previous modal messages
                orderDetailModal.classList.remove('hidden');
            }

            // Close modal event
            closeModalBtn.addEventListener('click', () => {
                orderDetailModal.classList.add('hidden');
                currentOrderId = null; // Clear current order ID
                fetchOrders(); // Refresh orders list when modal closes
            });

            // Generate Label Button
            generateLabelBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Generating label...', 'success'); // Optimistic update
                try {
                    const response = await fetch(`${BACKEND_URL}/api/generate-label/${currentOrderId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // body: JSON.stringify({ /* You might send dimensions/weight here */ })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to generate label');
                    }
                    showModalMessage(result.message, 'success');
                    // Update modal view immediately with new status and label URL
                    document.getElementById('modalOrderStatus').textContent = 'label_generated';
                    const modalLabelUrl = document.getElementById('modalLabelUrl');
                    modalLabelUrl.querySelector('a').href = result.uspsLabelUrl;
                    modalLabelUrl.classList.remove('hidden');
                    generateLabelBtn.classList.add('hidden'); // Hide after generation
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Label generation error:', error);
                }
            });

            // Mark as Shipped Button
            markShippedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as shipped...', 'success');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'shipped' })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to mark as shipped');
                    }
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'shipped';
                    markShippedBtn.classList.add('hidden'); // Hide after action
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Mark shipped error:', error);
                }
            });

            // Mark as Completed Button
            markCompletedBtn.addEventListener('click', async () => {
                if (!currentOrderId) return;
                showModalMessage('Marking as completed...', 'success');
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/${currentOrderId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to mark as completed');
                    }
                    showModalMessage(result.message, 'success');
                    document.getElementById('modalOrderStatus').textContent = 'completed';
                    markCompletedBtn.classList.add('hidden'); // Hide after action
                    generateLabelBtn.classList.add('hidden');
                    markShippedBtn.classList.add('hidden');
                } catch (error) {
                    showModalMessage(`Error: ${error.message}`, 'error');
                    console.error('Mark completed error:', error);
                }
            });


            // Initial fetch when the page loads
            fetchOrders();
            refreshOrdersBtn.addEventListener('click', fetchOrders);
        });
    </script>
</body>
</html>
