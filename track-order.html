<!DOCTYPE html>
<html lang="en">
<head>
    <script>
      window.SHC_API_BASE_URL = "https://api.secondhandcell.com/server";
    </script>
<script src="https://cdn.tailwindcss.com"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track My Order | SecondHandCell</title>
  <style>
    :root {
      --blue-600: #2563eb;
      --blue-700: #1d4ed8;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-700: #334155;
      --slate-900: #0f172a;
      --green-600: #16a34a;
      --amber-500: #f59e0b;
      --red-600: #dc2626;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 40%);
      color: var(--slate-900);
    }

    main {
      flex: 1 0 auto;
    }

    .page-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 20px 72px;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .page-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0ea5e9;
      font-weight: 700;
      width: fit-content;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 13px;
    }

    .page-title {
      font-size: clamp(28px, 4vw, 38px);
      margin: 0;
      letter-spacing: -0.02em;
      color: #0f172a;
    }

    .page-subtitle {
      margin: 0;
      max-width: 700px;
      color: var(--slate-700);
      line-height: 1.7;
    }

    header h1 {
      font-size: 32px;
      margin: 0 0 8px;
      letter-spacing: -0.02em;
    }

    header p {
      margin: 0;
      color: var(--slate-700);
      line-height: 1.6;
    }

    .card {
      background: #fff;
      border: 1px solid var(--slate-200);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.08);
      padding: 28px;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px 20px;
      align-items: end;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--slate-700);
    }

    input[type="text"],
    input[type="email"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--slate-200);
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-color: var(--blue-600);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
    }

    button[type="submit"] {
      padding: 14px 18px;
      border: none;
      border-radius: 12px;
      background: var(--blue-600);
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2);
    }

    button[type="submit"]:hover { background: var(--blue-700); }
    button[type="submit"]:active { transform: translateY(1px); }
    button[disabled] { opacity: 0.65; cursor: not-allowed; box-shadow: none; }

    .helper-text {
      grid-column: 1 / -1;
      margin: 4px 0 0;
      color: var(--slate-700);
    }

    .status-card {
      margin-top: 24px;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--slate-200);
      background: #f8fafc;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .status-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: #e0e7ff;
      color: var(--blue-700);
      font-weight: 700;
      font-size: 14px;
    }

    .status-message { margin: 10px 0 0; color: var(--slate-700); line-height: 1.6; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 18px;
    }

    .muted-label { color: var(--slate-700); margin: 0 0 6px; font-size: 14px; }
    .value-text { margin: 0; font-weight: 700; font-size: 17px; }

    .reoffer-panel {
      margin-top: 18px;
      border: 1px solid #fdba74;
      background: #fff7ed;
      border-radius: 14px;
      padding: 16px;
    }

    .reoffer-title { margin: 0; font-size: 16px; font-weight: 800; color: #9a3412; }
    .reoffer-copy { margin: 6px 0 0; color: #7c2d12; line-height: 1.55; }
    .reoffer-price { margin: 10px 0 0; font-size: 26px; font-weight: 900; color: #7c2d12; }
    .reoffer-meta { margin-top: 10px; color: #7c2d12; font-size: 14px; }
    .reoffer-meta ul { margin: 6px 0 0; padding-left: 18px; }
    .reoffer-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    .action-btn {
      border: 0;
      border-radius: 10px;
      padding: 11px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .action-btn.accept { background: #16a34a; color: #fff; }
    .action-btn.accept:hover { background: #15803d; }
    .action-btn.decline { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .action-btn.decline:hover { background: #fecaca; }
    .reoffer-note { margin: 10px 0 0; color: var(--slate-700); font-size: 13px; }


    .progress-list { list-style: none; padding: 0; margin: 20px 0 0; }
    .progress-item {
      position: relative;
      display: flex;
      gap: 12px;
      padding: 14px 12px 14px 4px;
      border-radius: 12px;
      align-items: flex-start;
    }
    .progress-item + .progress-item { margin-top: 6px; }

    .progress-item::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 18px;
      width: 2px;
      height: calc(100% - 18px);
      background: var(--slate-200);
    }

    .progress-item:last-child::before { display: none; }

    .dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-top: 2px;
      border: 2px solid var(--slate-200);
      background: #fff;
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    }

    .progress-item.complete { background: #ecfdf3; }
    .progress-item.complete .dot { background: var(--green-600); border-color: var(--green-600); }
    .progress-item.complete::before { background: rgba(22, 163, 74, 0.5); }
    .progress-item.current { background: #fff7ed; border: 1px solid #fed7aa; }
    .progress-item.current .dot { background: var(--amber-500); border-color: var(--amber-500); box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.18); }
    .progress-item .content { flex: 1; }
    .progress-item h4 { margin: 0 0 6px; font-size: 16px; color: #0f172a; }
    .progress-item p { margin: 0; color: var(--slate-700); line-height: 1.5; }

    .hidden { display: none; }
    .error { color: var(--red-600); }
    .inline-error { margin-top: 10px; }

    @media (max-width: 640px) {
      header h1 { font-size: 26px; }
      form { grid-template-columns: 1fr; }
      button[type="submit"] { width: 100%; }
    }
  </style>

    <link rel="stylesheet" href="/assets/css/site-chrome.css">
</head>
<body class="bg-slate-50">
  <!-- Site Header -->
  <header class="site-header" data-site-header>
    <div class="site-header__inner site-header__inner--centered">
        <div class="logo-container-left">
            <a href="/" class="logo-link" aria-label="SecondHandCell home">
                <img src="/assets/logo.webp" alt="SecondHandCell Logo" class="logo-image" width="320" height="320" onerror="this.onerror=null;this.src='https://placehold.co/200x64/ffffff/1e293b?text=SecondHandCell';">
            </a>
        </div>
        <div class="logo-text-container-center">
            <div class="logo-wordmark">
                <span class="logo-wordmark__primary">Second</span><span class="logo-wordmark__accent">HandCell</span>
            </div>
            <p class="logo-tagline">Turn Your Old <span>Phone Into Cash!</span></p>
        </div>
        <nav class="header-auth-nav" aria-label="Account navigation">
            <div id="authStatusContainer" class="site-header__auth-wrapper">
                <a href="#" id="loginNavBtn" class="site-header__login">Login/Sign Up</a>
                <div id="userMonogram" class="user-monogram hidden"></div>
                <div id="authDropdown" class="auth-dropdown hidden">
                    <a href="/my-account.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Account</a>
                    <a href="/track-order.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Track an Order</a>
                    <button id="logoutBtn" class="btn-red-logout">Logout</button>
                </div>
            </div>
        </nav>
    </div>
</header>
<section class="ship48-banner" data-ship48-banner hidden>
    <div class="ship48-banner__inner">
        <p class="ship48-banner__message" title="Email label orders sent within 48 hours get +$10 with SHIP48 when you send within 48h.">
            <strong>SHIP48</strong> Email label orders sent within 48h earn +$10 with code <span class="ship48-banner__code">SHIP48</span>. Email label only. <span class="ship48-banner__counter" data-ship48-counter></span>
            <span class="ship48-banner__status" data-ship48-status></span>
        </p>
        <div class="ship48-banner__actions">
            <button type="button" class="ship48-banner__apply" data-ship48-apply>Apply SHIP48</button>
            <button type="button" class="ship48-banner__start" data-ship48-start>Start my quote now</button>
        </div>
    </div>
    <button type="button" class="ship48-banner__dismiss" aria-label="Dismiss Ship48 promo" data-ship48-dismiss>&times;</button>
</section>
  <main class="page-shell">
    <div class="page-header">
      <span class="page-eyebrow">Track order</span>
      <h1 class="page-title">Check the status of your trade-in</h1>
      <p class="page-subtitle">Enter the order ID and email used at checkout so we can securely pull your latest status updates.</p>
    </div>
    <section class="card" aria-labelledby="track-order-form-title">
      <h2 id="track-order-form-title" class="hidden">Order lookup</h2>
      <form id="orderLookupForm">
        <div>
          <label for="orderId">Order ID</label>
          <input id="orderId" name="orderId" type="text" placeholder="e.g. SHC-01234" autocomplete="off" required>
        </div>
        <div>
          <label for="customerEmail">Email address</label>
          <input id="customerEmail" name="customerEmail" type="email" placeholder="Email used on the order" autocomplete="email" required>
        </div>
        <div>
          <button id="submitButton" type="submit">Check status</button>
        </div>
      </form>
      <p id="formError" class="inline-error error hidden" role="alert"></p>

      <div id="statusCard" class="status-card hidden" aria-live="polite">
        <div class="status-header">
          <span id="statusPill" class="status-pill">Status</span>
          <div>
            <strong id="statusTitle">Order status</strong>
            <p id="statusMessage" class="status-message"></p>
          </div>
        </div>

        <div class="grid">
          <div>
            <p class="muted-label">Order</p>
            <p id="orderSummary" class="value-text">—</p>
          </div>
          <div>
            <p class="muted-label">Name on file</p>
            <p id="customerNameValue" class="value-text">—</p>
          </div>
          <div>
            <p class="muted-label">Estimated payout</p>
            <p id="payoutValue" class="value-text">—</p>
          </div>
          <div>
            <p class="muted-label">Last updated</p>
            <p id="updatedValue" class="value-text">—</p>
          </div>
        </div>

        <ol id="progressList" class="progress-list" aria-label="Order progress"></ol>

        <div id="reofferPanel" class="reoffer-panel hidden">
          <p class="reoffer-title">Updated Offer Available</p>
          <p id="reofferMessage" class="reoffer-copy"></p>
          <p id="reofferPrice" class="reoffer-price">—</p>
          <div id="reofferMeta" class="reoffer-meta hidden">
            <strong>Reasoning from inspection:</strong>
            <ul id="reofferReasonsList"></ul>
          </div>
          <div id="reofferActions" class="reoffer-actions hidden">
            <button id="acceptReofferBtn" type="button" class="action-btn accept">Accept offer</button>
            <button id="declineReofferBtn" type="button" class="action-btn decline">Decline and return my device</button>
          </div>
          <p id="reofferNote" class="reoffer-note"></p>
        </div>

      </div>
    </section>
  </main>

    <footer class="bg-slate-800 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div><h3 class="text-xl font-bold mb-4">SecondHandCell</h3><p class="text-slate-400">Your trusted partner for selling used tech. Quick quotes, fair prices, and hassle-free service.</p></div>
                    <div><h3 class="text-xl font-bold mb-4">Quick Links</h3><ul class="space-y-2"><li><a href="#" class="text-slate-400 hover:text-white transition duration-300">Home</a></li><li><a href="#" id="aboutUsLink" class="text-slate-400 hover:text-white transition duration-300">About Us</a></li><li><a href="privacy.html" class="text-slate-400 hover:text-white transition duration-300">Privacy Policy</a></li><li><a href="terms.html" class="text-slate-400 hover:text-white transition duration-300">Terms & Conditions</a></li></ul></div>
                    <div><h3 class="text-xl font-bold mb-4">Contact Us</h3><p class="text-slate-400">Email: support@secondhandcell.com</p></div>
                </div>
                <div class="bg-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2 text-white">Stay Updated</h3>
                    <p class="text-slate-300 mb-4">Sign up for promos, price increases, and more!</p>
                    <form id="footerEmailSignupForm" class="flex flex-col sm:flex-row gap-2">
                        <label for="footerPromoEmail" class="sr-only">Email Address</label>
                        <input type="email" id="footerPromoEmail" placeholder="Enter your email" autocomplete="email" class="w-full flex-grow border border-slate-400 bg-slate-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" id="footerSignupBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-sm">Sign Up</button>
                    </form>
                    <p id="footerSignupMessage" class="mt-3 text-sm text-center text-slate-400 hidden"></p>
                </div>
            </div>
            <div class="mt-12 border-t border-slate-700 pt-8 text-center">
                <p class="text-slate-400 text-sm">&copy; 2024 SecondHandCell. All rights reserved.</p>
            </div>
        </div>
    </footer>

  <script type="module">
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getFirebaseApp } from '/assets/js/firebase-app.js';
    import { apiPost } from '/public/js/apiClient.js';

    const db = getFirestore(getFirebaseApp());

    const statusDescriptions = {
      order_pending: 'We have your order and are preparing your shipping kit details.',
      shipping_kit_requested: 'We are preparing your shipping kit.',
      kit_needs_printing: 'Your kit is in the print queue and will be packed shortly.',
      needs_printing: 'Your kit is in the print queue and will be packed shortly.',
      label_generated: 'Your return label is ready—check your email for download links.',
      emailed: 'Your return label is ready—check your email for download links.',
      kit_sent: 'Your shipping kit is on the way to you.',
      kit_delivered: 'Your kit has been delivered. Pack up your device and drop it off.',
      kit_on_the_way_to_us: 'We see your package in transit back to us.',
      kit_in_transit: 'We see your package in transit back to us.',
      phone_on_the_way: 'We see your package in transit back to us.',
      received: 'We received your device and are inspecting it.',
      device_received: 'We received your device and are inspecting it.',
      imei_checked: 'We received your device and are inspecting it.',
      processing: 'Our technicians are testing your device.',
      inspected: 'Our technicians are testing your device.',
      're-offered-pending': 'We sent a revised offer and are waiting for your response.',
      re_offered_pending: 'We sent a revised offer and are waiting for your response.',
      're-offered-accepted': 'You accepted the new offer—we are finalizing your payout.',
      re_offered_accepted: 'You accepted the new offer—we are finalizing your payout.',
      're-offered-declined': 'You declined the new offer. Let us know if you want to continue.',
      re_offered_declined: 'You declined the new offer. Let us know if you want to continue.',
      requote_accepted: 'You accepted the updated quote—we are finalizing your payout.',
      completed: 'Your order is complete and payment is being processed.',
      're-offered-auto-accepted': 'The revised offer was auto-accepted and payout is being finalized.',
      re_offered_auto_accepted: 'The revised offer was auto-accepted and payout is being finalized.',
      return_label_generated: 'A return label has been generated for your device return.',
      return_label_sent: 'A return label has been sent to your email.',
      return_in_transit: 'Your return shipment is currently in transit.',
      cancelled: 'This order was cancelled. Reach out if you want to reopen it.',
    };

    const stageOrder = [
      { key: 'order_pending', label: 'Order received', copy: 'We have your order and are preparing your kit.' },
      { key: 'shipping_kit_requested', label: 'Preparing your kit', copy: 'We are packaging your shipping kit or label.' },
      { key: 'kit_sent', label: 'Kit or label sent', copy: 'Check your email or mailbox for instructions.' },
      { key: 'kit_on_the_way_to_us', label: 'In transit to us', copy: 'We are tracking your package back to our facility.' },
      { key: 'received', label: 'Device received', copy: 'Our team is inspecting your device.' },
      { key: 'processing', label: 'Inspection in progress', copy: 'We are validating the condition you reported.' },
      { key: 'completed', label: 'Payout sent', copy: 'We are wrapping up payment for this order.' },
    ];

    const stageMap = {
      order_pending: 'order_pending',
      shipping_kit_requested: 'shipping_kit_requested',
      kit_needs_printing: 'shipping_kit_requested',
      needs_printing: 'shipping_kit_requested',
      label_generated: 'kit_sent',
      emailed: 'kit_sent',
      kit_sent: 'kit_sent',
      kit_delivered: 'kit_sent',
      kit_on_the_way_to_us: 'kit_on_the_way_to_us',
      kit_in_transit: 'kit_on_the_way_to_us',
      phone_on_the_way: 'kit_on_the_way_to_us',
      received: 'received',
      device_received: 'received',
      imei_checked: 'received',
      processing: 'processing',
      inspected: 'processing',
      're-offered-pending': 'processing',
      re_offered_pending: 'processing',
      're-offered-declined': 'processing',
      re_offered_declined: 'processing',
      're-offered-accepted': 'completed',
      re_offered_accepted: 'completed',
      requote_accepted: 'completed',
      're-offered-auto-accepted': 'completed',
      re_offered_auto_accepted: 'completed',
      return_label_generated: 'processing',
      return_label_sent: 'processing',
      return_in_transit: 'processing',
      completed: 'completed',
      cancelled: 'completed',
    };

    const orderIdInput = document.getElementById('orderId');
    const customerEmailInput = document.getElementById('customerEmail');
    const form = document.getElementById('orderLookupForm');
    const submitButton = document.getElementById('submitButton');
    const formError = document.getElementById('formError');
    const statusCard = document.getElementById('statusCard');
    const statusPill = document.getElementById('statusPill');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const orderSummary = document.getElementById('orderSummary');
    const customerNameValue = document.getElementById('customerNameValue');
    const payoutValue = document.getElementById('payoutValue');
    const updatedValue = document.getElementById('updatedValue');
    const progressList = document.getElementById('progressList');
    const reofferPanel = document.getElementById('reofferPanel');
    const reofferMessage = document.getElementById('reofferMessage');
    const reofferPrice = document.getElementById('reofferPrice');
    const reofferMeta = document.getElementById('reofferMeta');
    const reofferReasonsList = document.getElementById('reofferReasonsList');
    const reofferActions = document.getElementById('reofferActions');
    const acceptReofferBtn = document.getElementById('acceptReofferBtn');
    const declineReofferBtn = document.getElementById('declineReofferBtn');
    const reofferNote = document.getElementById('reofferNote');

    let currentOrder = null;

    function normalize(value) {
      return (value || '').trim().toLowerCase();
    }

    function friendlyStatus(status) {
      if (!status) return 'Unknown';
      if (statusDescriptions[status]) {
        return statusDescriptions[status].split('—')[0] || statusDescriptions[status];
      }
      return status
        .replace(/_/g, ' ')
        .replace(/\b\w/g, (m) => m.toUpperCase());
    }

    function statusDetail(status) {
      return statusDescriptions[status] || 'We are working on your order. Reach out if you need an update.';
    }

    function formatCurrency(value) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return '—';
      return numeric.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    function toMillis(value) {
      if (!value) return null;
      if (typeof value === 'number') return value;
      if (typeof value.toMillis === 'function') return value.toMillis();
      if (typeof value === 'object') {
        const seconds = value._seconds ?? value.seconds ?? null;
        if (typeof seconds === 'number') {
          const nanos = value._nanoseconds ?? value.nanoseconds ?? 0;
          return seconds * 1000 + Math.floor(nanos / 1e6);
        }
      }
      return null;
    }

    function resolveUpdatedAt(order = {}) {
      const candidates = [order.updatedAt, order.updated_at, order.statusUpdatedAt, order.status_updated_at, order.createdAt, order.created_at];
      for (const candidate of candidates) {
        const millis = toMillis(candidate);
        if (millis) return new Date(millis);
      }
      return null;
    }

    function renderProgress(statusKey) {
      const normalized = normalize(statusKey);
      const stageKey = stageMap[normalized] || 'order_pending';
      const currentIndex = stageOrder.findIndex((stage) => stage.key === stageKey);
      progressList.innerHTML = '';
      stageOrder.forEach((stage, index) => {
        const li = document.createElement('li');
        li.className = 'progress-item';
        if (index < currentIndex) li.classList.add('complete');
        if (index === currentIndex) li.classList.add('current');

        const dot = document.createElement('span');
        dot.className = 'dot';

        const content = document.createElement('div');
        content.className = 'content';

        const title = document.createElement('h4');
        title.textContent = stage.label;

        const copy = document.createElement('p');
        copy.textContent = stage.copy;

        content.appendChild(title);
        content.appendChild(copy);
        li.appendChild(dot);
        li.appendChild(content);
        progressList.appendChild(li);
      });
    }

    function resolveOrderEmail(order = {}) {
      return normalize(
        order?.shippingInfo?.email ||
          order?.email ||
          order?.contactEmail ||
          order?.customerEmail ||
          order?.userEmail
      );
    }

    async function fetchOrder(orderId, email) {
      const orderRef = doc(db, 'orders', orderId);
      const snapshot = await getDoc(orderRef);

      if (!snapshot.exists()) {
        throw new Error('Unable to find that order.');
      }

      const order = { id: snapshot.id, ...snapshot.data() };
      const orderEmail = resolveOrderEmail(order);
      const enteredEmail = normalize(email);

      if (!orderEmail) {
        throw new Error('This order does not have an email on file. Please contact support.');
      }

      if (enteredEmail && orderEmail !== enteredEmail) {
        throw new Error('The email you entered does not match the email on the order.');
      }

      return order;
    }


    function getReofferPayload(order = {}) {
      const offer = order?.reOffer || order?.reoffer || null;
      if (!offer || typeof offer !== 'object') return null;
      const rawPrice = offer.newPrice ?? offer.price ?? null;
      const price = Number(rawPrice);
      const reasons = Array.isArray(offer.reasons) ? offer.reasons.filter(Boolean) : [];
      return {
        price: Number.isFinite(price) ? price : null,
        reasons,
      };
    }

    function resetReofferPanel() {
      reofferPanel.classList.add('hidden');
      reofferMeta.classList.add('hidden');
      reofferActions.classList.add('hidden');
      reofferReasonsList.innerHTML = '';
      reofferMessage.textContent = '';
      reofferPrice.textContent = '—';
      reofferNote.textContent = '';
      acceptReofferBtn.disabled = false;
      declineReofferBtn.disabled = false;
      acceptReofferBtn.textContent = 'Accept offer';
      declineReofferBtn.textContent = 'Decline and return my device';
    }

    function renderReofferPanel(order) {
      resetReofferPanel();
      const statusKey = normalize(order?.status);
      const reoffer = getReofferPayload(order);
      const hasReofferContext = statusKey.includes('re-offered') || statusKey.includes('reoffer') || !!reoffer;
      if (!hasReofferContext) return;

      reofferPanel.classList.remove('hidden');
      if (statusKey === 're-offered-pending' || statusKey === 're_offered_pending') {
        reofferMessage.textContent = 'Please review your updated payout from our QC inspection.';
        reofferPrice.textContent = reoffer?.price != null ? formatCurrency(reoffer.price) : 'Updated price available';
        if (reoffer?.reasons?.length) {
          reofferMeta.classList.remove('hidden');
          reoffer.reasons.forEach((reason) => {
            const li = document.createElement('li');
            li.textContent = reason;
            reofferReasonsList.appendChild(li);
          });
        }
        reofferActions.classList.remove('hidden');
        reofferNote.textContent = 'Once you choose, this action is final.';
        return;
      }

      if (statusKey === 're-offered-accepted' || statusKey === 're_offered_accepted' || statusKey === 're-offered-auto-accepted' || statusKey === 're_offered_auto_accepted' || statusKey === 'requote_accepted') {
        reofferMessage.textContent = 'Your updated offer has been accepted.';
        reofferPrice.textContent = reoffer?.price != null ? formatCurrency(reoffer.price) : 'Accepted';
        reofferNote.textContent = 'We are finalizing your payout now.';
        return;
      }

      if (statusKey === 're-offered-declined' || statusKey === 're_offered_declined') {
        reofferMessage.textContent = 'You declined the updated offer.';
        reofferPrice.textContent = reoffer?.price != null ? formatCurrency(reoffer.price) : 'Declined';
        reofferNote.textContent = 'We are preparing the return process for your device.';
      }
    }

    async function submitReofferDecision(action) {
      if (!currentOrder?.id) return;
      const isAccept = action === 'accept';
      const button = isAccept ? acceptReofferBtn : declineReofferBtn;
      const originalText = button.textContent;
      try {
        acceptReofferBtn.disabled = true;
        declineReofferBtn.disabled = true;
        button.textContent = isAccept ? 'Accepting…' : 'Declining…';
        await apiPost(isAccept ? '/accept-offer-action' : '/return-phone-action', { orderId: currentOrder.id });
        const refreshed = await fetchOrder(currentOrder.id, customerEmailInput.value.trim());
        currentOrder = refreshed;
        displayOrder(refreshed);
      } catch (error) {
        formError.textContent = error?.message || 'Unable to update your re-offer decision right now.';
        formError.classList.remove('hidden');
      } finally {
        button.textContent = originalText;
        acceptReofferBtn.disabled = false;
        declineReofferBtn.disabled = false;
      }
    }

    function displayOrder(order) {
      currentOrder = order;
      const statusKey = normalize(order.status) || 'order_pending';
      statusPill.textContent = friendlyStatus(statusKey);
      statusTitle.textContent = `Status: ${friendlyStatus(statusKey)}`;
      statusMessage.textContent = statusDetail(statusKey);

      const deviceText = order.device || order.deviceName || 'Device order';
      orderSummary.textContent = `${order.id || order.orderId || 'Order'} • ${deviceText}`;

      customerNameValue.textContent = order?.shippingInfo?.fullName || order?.shippingInfo?.name || '—';
      payoutValue.textContent = formatCurrency(order.totalPayout ?? order.estimatedQuote ?? order.originalQuote);

      const updated = resolveUpdatedAt(order);
      updatedValue.textContent = updated ? updated.toLocaleString() : '—';

      renderProgress(statusKey);
      renderReofferPanel(order);
      statusCard.classList.remove('hidden');
    }

    function setLoading(isLoading) {
      submitButton.disabled = isLoading;
      submitButton.textContent = isLoading ? 'Checking…' : 'Check status';
    }

    function showError(message) {
      formError.textContent = message;
      formError.classList.remove('hidden');
      statusCard.classList.add('hidden');
      resetReofferPanel();
    }

    acceptReofferBtn.addEventListener('click', () => submitReofferDecision('accept'));
    declineReofferBtn.addEventListener('click', () => submitReofferDecision('decline'));

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      formError.classList.add('hidden');

      const orderId = orderIdInput.value.trim();
      const email = customerEmailInput.value.trim();

      if (!orderId || !email) {
        showError('Please enter both your order ID and the email used on the order.');
        return;
      }

      try {
        setLoading(true);
        const order = await fetchOrder(orderId, email);
        displayOrder(order);
      } catch (error) {
        showError(error.message || 'Unable to find your order. Please double-check the details.');
      } finally {
        setLoading(false);
      }
    });

    function applyPrefillFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const idFromUrl = params.get('orderId') || params.get('id');
      const emailFromUrl = params.get('email');

      if (idFromUrl) {
        orderIdInput.value = idFromUrl;
      }
      if (emailFromUrl) {
        customerEmailInput.value = emailFromUrl;
      }

      if (idFromUrl && emailFromUrl) {
        form.dispatchEvent(new Event('submit'));
      }
    }

    applyPrefillFromUrl();
  </script>
  <script type="module" src="/assets/js/global-auth.js" defer></script>
  <script src="/assets/js/ship48-banner.js" defer></script>
</body>
</html>
